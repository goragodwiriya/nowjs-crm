!function(){"use strict";var e;const t={config:{urlParams:!0,pageSizes:[10,25,50,100],showCaption:!0,showCheckbox:!1,showFooter:!1,footerAggregates:{},searchColumns:[],persistColumnWidths:!0,rowSortable:!1,allowRowModification:!1,confirmDelete:!0,dynamicColumns:!1,source:"",method:"GET",actions:{},actionUrl:"",actionButton:"Process",rowActions:{},params:{search:"",pageSize:0,page:1}},state:{initialized:!1,tables:new Map},async init(e={}){if(this.state.initialized)return this;this.config={...this.config,...e},this.setupDynamicTableObserver(),document.querySelectorAll("table[data-table]").forEach(e=>{this.initTable(e)});try{EventManager.on("locale:changed",e=>{this.state.tables.forEach((e,t)=>{this.retranslateFilter(e),this.renderTable(t)})})}catch(t){}return this.state.initialized=!0,this},getUrlParams(e){var t;const a=this.state.tables.get(e);if(!(void 0!==(null==(t=null==a?void 0:a.config)?void 0:t.urlParams)?a.config.urlParams:this.config.urlParams))return{};let n="";if(window.location.href.includes("#")){const e=window.location.hash,t=e.indexOf("?");-1!==t&&(n=e.substring(t+1))}else n=window.location.search.substring(1);const r=new URLSearchParams(n),o={};for(const[l,s]of r.entries())o[l]="page"===l||"pageSize"===l?parseInt(s)||("page"===l?1:10):s;return o},updateUrlParams(e,t={}){var a;const n=this.state.tables.get(e);if(!(void 0!==(null==(a=null==n?void 0:n.config)?void 0:a.urlParams)?n.config.urlParams:this.config.urlParams))return;let r="";const o=window.location.href.includes("#");if(o){const e=window.location.hash,t=e.indexOf("?");-1!==t&&(r=e.substring(t+1))}else r=window.location.search.substring(1);const l=new URLSearchParams(r),s=["total","totalPages","totalRecords","loading","error"],i=[];if(n.columns&&n.columns.size>0)for(const[m]of n.columns)i.push(m);let c;["page","pageSize","search","sort",...i].forEach(e=>{for(;l.has(e);)l.delete(e)}),Object.entries(t).forEach(([e,t])=>{null!=t&&""!==t&&(s.includes(e)||(Array.isArray(t)?t.forEach(t=>{null!=t&&""!==t&&l.append(e,t)}):l.set(e,t)))});const d=l.toString();if(o){const e=window.location.hash.split("?")[0]||"#/";c=`${window.location.pathname}${e}${d?"?"+d:""}`}else c=`${window.location.pathname}${d?"?"+d:""}${window.location.hash}`;try{window.history.replaceState({},"",c)}catch(u){console.warn("Failed to update URL parameters:",u)}},syncStateToUrl(e){const t=this.state.tables.get(e);if(!t)return;if(!(void 0!==t.config.urlParams?t.config.urlParams:this.config.urlParams))return;const a=["total","totalPages","totalRecords","loading","error"],n={};if(Object.entries(t.config.params).forEach(([e,t])=>{a.includes(e)||(n[e]=t)}),t.sortState&&Object.keys(t.sortState).length>0){const e=Object.entries(t.sortState).map(([e,t])=>`${e} ${t}`);e.length>0&&(n.sort=e.join(","))}Object.keys(n).forEach(e=>{const t=n[e];""!==t&&null!=t||delete n[e],"page"===e&&1===t&&delete n[e]}),this.updateUrlParams(e,n)},loadStateFromUrl(e){const t=this.getUrlParams(e),a=this.state.tables.get(e);if(!a||0===Object.keys(t).length)return!1;if(Object.keys(t).forEach(e=>{["sort","order"].includes(e)||(a.config.params[e]=t[e])}),t.sort){a.sortState={};t.sort.split(",").map(e=>e.trim()).forEach(e=>{const t=e.split(/\s+/);if(t.length>=2){const e=t[0],n=t[1].toLowerCase();["asc","desc"].includes(n)&&(a.sortState[e]=n)}else 1===t.length&&(a.sortState[t[0]]="asc")})}return!0},restoreFilterUIFromState(e){const t=this.state.tables.get(e);t&&t.filterElements&&Object.entries(t.config.params).forEach(([e,a])=>{const n=t.filterElements.get(e);if(n&&n.element&&null!=a&&""!==a)try{const e=n.element;if(t.externalFilterForm)this.setFormElementValue(e,a);else if("checkbox"===e.type?e.checked=!!a:e.value=a,"SELECT"===e.tagName){const t=Array.from(e.options);t.some(e=>e.value===String(a))&&(e.value=a)}}catch(r){console.warn("Failed to restore filter UI value:",{key:e,value:a,error:r})}})},initTable(e,t={}){if(!e)return this.handleError("Table element is required",null,"init");const a=e.dataset.table;if(!a)return this.handleError("Table ID is required",null,"init");if(this.state.tables.has(a))this.handleError("Table already exists",null,"init");else try{const r={...this.config,...t,...this.extractDataAttributes(e,this.config),params:{...this.config.params,...this.extractDataAttributes(e,this.config.params)}};"true"===e.dataset.editableRows&&(r.allowRowModification=!0,void 0===e.dataset.showCaption&&(r.showCaption=!1));const o=document.querySelector(`[data-table-filter="${a}"]`);this.state.tables.set(a,{id:a,element:e,config:r,data:[],sortState:{},filterWrapper:null,actionWrapper:null,paginationWrapper:null,filterElements:new Map,filterData:new Map,columns:new Map,filterOptions:new Map,elementInstances:new Map,initializing:!0,externalFilterForm:o||null}),r.source&&this.bindToState(a,r.source),this.setupTableStructure(a),this.setupAccessibility(e,a,r),this.setupEventListeners(a);const l=this.state.tables.get(a);e.dataset.defaultSort&&l&&this.applyDefaultSort(l,e.dataset.defaultSort);this.loadStateFromUrl(a)&&this.restoreFilterUIFromState(a);try{const e=this.state.tables.get(a);if(!r.source||!r.source.startsWith("state.")){const t=this.loadTableData(a);t&&"function"==typeof t.then?t.finally(()=>{const e=this.state.tables.get(a);e&&(e.initializing=!1,this.renderTable(a))}):e&&(e.initializing=!1,this.renderTable(a))}else e&&(e.initializing=!1)}catch(n){console.warn(`TableManager: failed to load initial data for table ${a}:`,n);const e=this.state.tables.get(a);e&&(e.initializing=!1,this.renderTable(a))}return a}catch(r){return this.handleError("Failed to initialize table",r,"init")}},applyDefaultSort(e,t){if(!e||!t)return;t.split(",").map(e=>e.trim()).forEach(t=>{const a=t.split(/\s+/);if(a.length>=2){const t=a[0],n=a[1].toLowerCase();if(["asc","desc"].includes(n)){e.sortState[t]=n;const a=e.element.querySelector(`th[data-sort="${t}"]`);a&&(a.classList.remove("sort_asc","sort_desc"),a.classList.add("asc"===n?"sort_asc":"sort_desc"),a.setAttribute("aria-sort","asc"===n?"ascending":"descending"))}}else if(1===a.length&&a[0]){e.sortState[a[0]]="asc";const t=e.element.querySelector(`th[data-sort="${a[0]}"]`);t&&(t.classList.remove("sort_asc","sort_desc"),t.classList.add("sort_asc"),t.setAttribute("aria-sort","ascending"))}}),Object.keys(e.sortState).length>1&&Object.keys(e.sortState).forEach((t,a)=>{const n=e.element.querySelector(`th[data-sort="${t}"]`);if(n){let e=n.querySelector(".sort-order");e||(e=document.createElement("span"),e.className="sort-order",n.appendChild(e)),e.textContent=a+1,e.setAttribute("aria-label",`Sort priority ${a+1}`)}})},extractDataAttributes(e,t){const a={};return Object.keys(e.dataset).forEach(n=>{const r=t[n];if(void 0!==r)try{Array.isArray(r)?a[n]=e.dataset[n].split(",").map(e=>e.trim()):a[n]="object"==typeof r&&null!==r?JSON.parse(e.dataset[n]):"boolean"==typeof r?"true"===e.dataset[n]:"number"==typeof r?parseInt(e.dataset[n]):e.dataset[n]}catch(o){console.warn(`Unable to parse value for ${n}:`,o)}}),{...t,...a}},setupCheckboxes(e,t){e.config.showCheckbox&&["thead","tfoot"].forEach(a=>{const n=e.element.querySelector(`${a} tr:first-child`);if(n){let r=`select-all-${t}-${a}`,o=n.querySelector(".select-all");if(o){o.id&&(r=o.id);const e=o.closest("label");e&&(e.htmlFor=r),o.closest("th, td").classList.add("check-column")}else{const t=document.createElement("label");t.htmlFor=r,o=document.createElement("input"),o.type="checkbox";const l=document.createElement("thead"===a?"th":"td"),s=e.element.querySelectorAll(`${a} tr:first-child`).length;s>1&&l.setAttribute("rowspan",s),l.className="check-column",t.appendChild(o),l.appendChild(t),n.insertBefore(l,n.firstChild)}o.className="select-all",o.id=r,o.setAttribute("aria-label",Now.translate("Select all"));const l=o._selectAllHandler;l&&o.removeEventListener("change",l);const newHandler=a=>{this.handleSelectAll(e,t,a.target.checked)};o._selectAllHandler=newHandler,o.addEventListener("change",newHandler)}})},handleSelectAll(e,t,a){if(!(null==e?void 0:e.element))return;e.element.querySelectorAll("tbody .select-row").forEach(e=>{e.checked=a});e.element.querySelectorAll(".select-all").forEach(e=>{e.checked=a}),this.handleRowSelection(e,t)},handleRowSelection(e,t){const a=e.element.querySelectorAll("tbody .select-row"),n=e.element.querySelectorAll("tbody .select-row:checked"),r=a.length>0&&a.length===n.length,o=n.length>0&&n.length<a.length;e.element.querySelectorAll(".select-all").forEach(e=>{e.checked=r,e.indeterminate=o}),e.selectedRows=Array.from(n).map(e=>e.value),e.config.onSelectionChange&&e.config.onSelectionChange(e.selectedRows),EventManager.emit("table:selectionChange",{tableId:t,selectedRows:e.selectedRows})},clearSelection(e,t,a={}){var n,r;if(!(null==e?void 0:e.element)||!e.config.showCheckbox)return;const{emit:o=!0}=a;e.element.querySelectorAll("tbody .select-row").forEach(e=>{var t;e.checked=!1,null==(t=e.closest("tr"))||t.classList.remove("selected-row")});e.element.querySelectorAll(".select-all").forEach(e=>{e.checked=!1,e.indeterminate=!1});const l=Array.isArray(e.selectedRows)&&e.selectedRows.length>0;e.selectedRows=[],(null==(r=null==(n=e.actionElements)?void 0:n.submit)?void 0:r.element)&&(e.actionElements.submit.element.disabled=!0),"function"==typeof this.updateSelectedCount&&this.updateSelectedCount(e.element,0),o&&l&&("function"==typeof e.config.onSelectionChange&&e.config.onSelectionChange([]),EventManager.emit("table:selectionChange",{tableId:t,selectedRows:[]}))},setupTableStructure(e){var t;const a=this.state.tables.get(e);if(!a)return;const{element:n,config:r}=a,o=n.querySelector("thead");let l=n.querySelector("tfoot");if(r.showFooter&&!l&&(l=document.createElement("tfoot"),n.appendChild(l),o)){const e=document.createElement("tr"),a=(null==(t=o.querySelector("tr"))?void 0:t.querySelectorAll("th").length)||0;for(let t=0;t<a;t++){const t=document.createElement("td");e.appendChild(t)}l.appendChild(e)}if(o){o.querySelectorAll("th[data-sort]").forEach(e=>{e.classList.add("sortable"),e.setAttribute("role","columnheader"),e.setAttribute("tabindex","0")}),r.allowRowModification&&(o.querySelectorAll("tr").forEach(e=>{if(e.querySelector("th.icons"))return;const t=document.createElement("th");t.className="icons",e.appendChild(t)}),l&&l.querySelectorAll("tr").forEach(e=>{if(e.querySelector("td.icons"))return;const t=document.createElement("td");t.className="icons",e.appendChild(t)}));if(n.dataset.rowActions||n.dataset.rowActionsJson){const e=n.dataset.rowActionsLabel||"Actions";o.querySelectorAll("tr").forEach(t=>{if(t.querySelector("th.row-actions"))return;const a=document.createElement("th");a.className="row-actions",a.textContent=e,a.dataset.i18n=e,t.appendChild(a)}),l&&l.querySelectorAll("tr").forEach(e=>{if(e.querySelector("td.row-actions"))return;const t=document.createElement("td");t.className="row-actions",e.appendChild(t)})}}a.externalFilterForm?a.filterWrapper=a.externalFilterForm:(a.filterWrapper=document.createElement("div"),a.filterWrapper.className="table_nav",n.parentNode.insertBefore(a.filterWrapper,n)),a.actionWrapper=document.createElement("div"),a.actionWrapper.className="table_nav",n.parentNode.appendChild(a.actionWrapper),a.paginationWrapper=document.createElement("div"),a.paginationWrapper.className="splitpage",n.parentNode.appendChild(a.paginationWrapper),this.setupFilter(a,e),a.externalFilterForm&&this.setupExternalFilter(a,e),this.setupFooter(a),this.setupCheckboxes(a,e),this.setupActions(a,e),(null==r?void 0:r.pageSize)>0&&this.setupPagination(a,e)},setupEventListeners(e){const t=this.state.tables.get(e);if(!t)return;const{element:a,config:n}=t,r={sort:new Map,filter:new Map,keyboard:null};t.eventHandlers||(t.eventHandlers={}),n.touchEnabled&&this.setupTouchEvents(t);try{const a=t.element.querySelector("tbody");if(a){const delegatedClick=t=>this._handleDelegatedClick(t,e),delegatedChange=t=>this._handleDelegatedChange(t,e);a.addEventListener("click",delegatedClick),a.addEventListener("change",delegatedChange),t.eventHandlers.delegation={click:delegatedClick,change:delegatedChange}}if(t.filterWrapper){const fwChange=a=>{const n=a.target;if(!n)return;if((n.id||"").startsWith(`pageSize_${e}`)||"pageSize"===n.dataset.field){const a=parseInt(n.value);return void this.handleFilterChange(t,e,"pageSize",a,n)}const r=n.dataset.name||n.dataset.field||n.name;if(r){const a="checkbox"===n.type?n.checked:n.value;this.handleFilterChange(t,e,r,a,n)}};t.filterWrapper.addEventListener("change",fwChange),t.eventHandlers.filterWrapperChange=fwChange}}catch(o){console.warn("Delegation setup failed",o)}if(this.setupColumnResizing(e),t.actionWrapper&&t.actionElements&&t.actionElements.submit&&t.actionElements.select){const a=t.actionElements.submit.element,n=t.actionElements.select.element;if(a){const onActionButtonClick=async a=>{var r;if(a.preventDefault(),!n.value||""===n.value)return void NotificationManager.warning("Please select an action");if(0===((null==(r=this.getSelectedRowIds(t))?void 0:r.length)||0))return void NotificationManager.warning("Please select at least one row");const o=Now.translate("You want to {action} the selected items ?",{action:n.options[n.selectedIndex].textContent});await DialogManager.confirm(o)&&this._performActionWrapperSubmission(e)};a.addEventListener("click",onActionButtonClick),t.eventHandlers.actionButton=onActionButtonClick}}a.querySelectorAll("thead th[data-sort]").forEach(a=>{const sortHandler=n=>{var r;n.preventDefault(),n.stopPropagation(),n.shiftKey&&(null==(r=window.getSelection())||r.removeAllRanges()),this.handleSort(t,e,a,n)},keyHandler=n=>{"Enter"!==n.key&&" "!==n.key||(n.preventDefault(),this.handleSort(t,e,a,n))};a.addEventListener("click",sortHandler),a.addEventListener("keydown",keyHandler),r.sort.set(a,{sort:sortHandler,key:keyHandler}),a.setAttribute("role","columnheader"),a.setAttribute("tabindex","0"),a.setAttribute("aria-sort","none")}),t.eventHandlers=r},cleanupFilterEvents(e){e.filterElements&&(e.filterElements.forEach((e,t)=>{t&&ElementManager.destroy(t)}),e.filterElements.clear())},handleSort(e,t,a,n=null){if(!(e&&t&&a instanceof HTMLElement))throw new Error("Invalid parameters");const{config:r}=e,o=a.dataset.sort,l=e.sortState[o]||"none",s="asc"===l?"desc":"desc"===l?"none":"asc",i=r.multiSort||n&&n.shiftKey;if(i||Object.keys(e.sortState).forEach(t=>{if(t!==o){delete e.sortState[t];const a=e.element.querySelector(`th[data-sort="${t}"]`);a&&(a.classList.remove("sort_asc","sort_desc"),a.setAttribute("aria-sort","none"))}}),"none"===s){delete e.sortState[o],a.classList.remove("sort_asc","sort_desc"),a.setAttribute("aria-sort","none");const t=a.querySelector(".sort-order");t&&t.remove()}else if(e.sortState[o]=s,a.classList.remove("sort_asc","sort_desc"),a.classList.add("asc"===s?"sort_asc":"sort_desc"),a.setAttribute("aria-sort","asc"===s?"ascending":"descending"),i&&Object.keys(e.sortState).length>1){const t=Object.keys(e.sortState).indexOf(o)+1;let n=a.querySelector(".sort-order");n||(n=document.createElement("span"),n.className="sort-order",a.appendChild(n)),n.textContent=t,n.setAttribute("aria-label",`Sort priority ${t}`)}else{const e=a.querySelector(".sort-order");e&&e.remove()}this.syncStateToUrl(t),this.clearSelection(e,t);const c=e.element.dataset.source||e.config.source||"";if(c&&(c.startsWith("api/")||c.startsWith("http")))return e.config.params.page=1,void this.loadFromApi(e,t,c).catch(e=>{console.error("Sort load error",e),this.renderTable(t)});this.renderTable(t)},handleFieldChange(e,t,a,n,r,o,l={send:!0}){var s,i,c;try{if(!1!==l.send&&r&&"object"==typeof r)try{r[a]=n}catch(d){}const u=(null==(i=null==(s=null==e?void 0:e.element)?void 0:s.dataset)?void 0:i.actionUrl)||(null==(c=null==e?void 0:e.config)?void 0:c.actionUrl);if(!u||!1===l.send)return void EventManager.emit("table:fieldChange",{tableId:t,field:a,value:n,rowData:r,element:o});const m={action:"update",field:a,ids:[null==r?void 0:r.id],value:n},h=o&&o.classList?o:(null==e?void 0:e.element)||null;h&&h.classList&&h.classList.add("loading"),this.sendAction(u,m,t,h).then(e=>{e?o&&o.classList&&(o.classList.add("update-success"),setTimeout(()=>{o&&o.classList&&o.classList.remove("update-success")},1e3)):this.renderTable(t)}).catch(e=>{console.error("Field update error:",e),this.renderTable(t)}).finally(()=>{h&&h.classList&&h.classList.remove("loading"),o&&o.wrapper&&o.wrapper.classList&&o.wrapper.classList.remove("loading")})}catch(u){this.handleError("Error updating field",u,"handleFieldChange"),o&&(o.classList.remove("loading"),o.wrapper&&o.wrapper.classList.remove("loading"))}},setupFilter(e,t){var a;if(!(null==e?void 0:e.filterWrapper))return;const n=!!e.externalFilterForm;n?(e.filterElements=e.filterElements||new Map,e.filterData=e.filterData||new Map):(e.filterWrapper.innerHTML="",e.filterElements=new Map,e.filterData=new Map);const{config:r}=e,o=Now.getManager("element");if(!o&&!n)return;const l=Utils.function.debounce((e,t,a,n,r)=>{this.handleFilterChange(e,t,a,n,r)},300);if(!n&&r.params.pageSize>0&&Array.isArray(r.pageSizes)&&r.pageSizes.length>0){const a={};r.pageSizes.forEach(e=>{a[e]=`${e} {LNG_entries}`});const n=o.create("select",{id:`pageSize_${t}`,options:a,value:r.params.pageSize,label:"Show",wrapper:"div",onChange:(a,n)=>{l(e,t,"pageSize",parseInt(n),a)}});(null==n?void 0:n.element)&&(e.filterWrapper.appendChild(n.wrapper),e.filterElements.set("pageSize",n),e.filterData.set("pageSize",n))}if(e.columns=this.getColumnDefinitions(e),e.columns.forEach((a,s)=>{if(!a.filter)return;if(""!==a.value&&(r.params[s]=a.value),a.options&&(e.filterOptions||(e.filterOptions=new Map),e.filterOptions.set(s,a.options)),n)return;let i={id:`filter_${s}_${t}`,name:s,label:a.label||s,placeholder:a.placeholder,value:r.params[s]||a.value||"",options:(()=>{const e=a.options||{};if(a.showAll){const t=void 0!==a.allValue?a.allValue:"",n=a.allLabel||"All";return Array.isArray(e)?[{value:t,text:n},...e]:e&&"object"==typeof e?Object.assign({[t]:n},e):e}return e})(),datalist:a.datalist||null,autocomplete:a.autocomplete||null,wrapper:"div",wrapperClass:"filter-control",onChange:(a,n)=>{l(e,t,s,n,a)}};const c=o.create(a.type,i);(null==c?void 0:c.element)&&(e.filterWrapper.appendChild(c.wrapper),e.filterElements.set(s,c),e.filterData.set(s,c))}),!n&&(null==(a=r.searchColumns)?void 0:a.length)>0){const a=o.create("search",{id:`search_${t}`,itemClass:"search",value:r.params.search||"",placeholder:`${Now.translate("Search in")}: ${r.searchColumns.join(", ")}`,minLength:2,onChange:(a,n)=>{l(e,t,"search",n,a)}});(null==a?void 0:a.element)&&(e.filterWrapper.appendChild(a.wrapper||a.element),e.filterElements.set("search",a),e.filterData.set("search",a))}if(e.pendingDerivedFilters&&Object.keys(e.pendingDerivedFilters).length){try{this.setFilters(t,e.pendingDerivedFilters)}catch(s){console.warn("Failed to apply pending derived filters:",s)}e.pendingDerivedFilters=null}},setupExternalFilter(e,t){if(!(null==e?void 0:e.externalFilterForm))return;const a=e.externalFilterForm,{config:n}=e;e.filterElements=new Map,e.filterData=new Map,e._externalFilterCleanup||(e._externalFilterCleanup=[]);const submitHandler=a=>{a.preventDefault(),a.stopPropagation(),this.handleExternalFilterSubmit(e,t)};a.addEventListener("submit",submitHandler),e._externalFilterCleanup.push(()=>a.removeEventListener("submit",submitHandler));a.querySelectorAll("input, select, textarea").forEach(t=>{const a=t.name||t.id;if(a&&(e.filterElements.set(a,{element:t}),void 0===n.params[a])){const e=this.getFormElementValue(t);""!==e&&null!=e&&(n.params[a]=e)}}),Object.entries(n.params||{}).forEach(([t,a])=>{const n=e.filterElements.get(t);(null==n?void 0:n.element)&&null!=a&&""!==a&&this.setFormElementValue(n.element,a)});const r=this.getUrlParams(t);r&&Object.keys(r).length>0&&Object.entries(r).forEach(([t,a])=>{const r=e.filterElements.get(t);(null==r?void 0:r.element)&&(this.setFormElementValue(r.element,a),n.params[t]=a)})},handleExternalFilterSubmit(e,t){const a=e.externalFilterForm;if(!a)return;const n=new FormData(a),r={};for(const[o,l]of n.entries())""!==l&&null!=l&&(r[o]=l);a.querySelectorAll("input, select, textarea").forEach(e=>{const t=e.name||e.id;t&&("checkbox"!==e.type&&"radio"!==e.type||n.has(t)||(r[t]=""))}),Object.assign(e.config.params,r),e.config.params.page=1,this.clearSelection(e,t),this.syncStateToUrl(t),this.loadTableData(t)},getFormElementValue(e){if(!e)return"";switch(e.type){case"checkbox":return e.checked?e.value||"1":"";case"radio":return e.checked?e.value:"";case"select-multiple":return Array.from(e.selectedOptions).map(e=>e.value);default:return e.value||""}},setFormElementValue(e,t){var a;if(e){try{const n="undefined"!=typeof ElementManager&&"function"==typeof ElementManager.getInstanceByElement?ElementManager:"undefined"!=typeof Now&&Now.getManager?Now.getManager("element"):null,r=null==(a=null==n?void 0:n.getInstanceByElement)?void 0:a.call(n,e);if(r&&"function"==typeof r.setValue)return void r.setValue(t)}catch(n){}switch(e.type){case"checkbox":e.checked="1"===t||"true"===t||!0===t||t===e.value;break;case"radio":e.checked=e.value===t;break;case"select-multiple":const a=Array.isArray(t)?t:[t];Array.from(e.options).forEach(e=>{e.selected=a.includes(e.value)});break;default:e.value=t}}},populateExternalFilterOptions(e,t){if(!e.externalFilterForm||!t)return;const a=e.externalFilterForm;Object.entries(t).forEach(([e,t])=>{const n=a.querySelector(`select[name="${e}"]`);if(!n)return;const r=n.value,o=n.options[0];if(o&&(""===o.value||o.textContent.toLowerCase().includes("all")||o.textContent.toLowerCase().includes("ทั้งหมด")))for(;n.options.length>1;)n.remove(1);else n.innerHTML="";Array.isArray(t)?t.forEach(e=>{const t=document.createElement("option");t.value=void 0!==e.value?e.value:e.key||e.id||"",t.textContent=e.text||e.label||e.name||t.value,n.appendChild(t)}):"object"==typeof t&&Object.entries(t).forEach(([e,t])=>{const a=document.createElement("option");a.value=e,a.textContent=t,n.appendChild(a)}),r&&(n.value=r)})},handleFilterChange(e,t,a,n,r){e.config.params.page=1,e.config.params[a]=n,this.clearSelection(e,t),this.syncStateToUrl(t);const o=e.element.dataset.source||e.config.source||"";o&&(o.startsWith("api/")||o.startsWith("http"))?this.loadFromApi(e,t,o).catch(e=>console.error("Filter load error",e)):this.renderTable(t)},setupAccessibility(e,t,a){if(e)try{e.setAttribute("role","grid"),e.setAttribute("aria-label",(null==a?void 0:a.label)||e.dataset.label||"Data Table");const n=e.querySelector("thead");n&&(n.setAttribute("role","rowgroup"),n.querySelectorAll("th[data-sort]").forEach(e=>{e.setAttribute("role","columnheader"),e.setAttribute("tabindex","0"),e.setAttribute("aria-sort","none"),e.setAttribute("aria-label",`${e.textContent.trim()}, sortable column`)}),n.querySelectorAll("th:not([data-sort])").forEach(e=>{e.setAttribute("role","columnheader")}));const r=e.querySelector("tbody");r&&(r.setAttribute("role","rowgroup"),r.querySelectorAll("tr").forEach((e,t)=>{e.setAttribute("role","row"),e.setAttribute("tabindex","0"),e.setAttribute("aria-rowindex",t+1),e.querySelectorAll("td").forEach((e,t)=>{e.setAttribute("role","gridcell"),e.setAttribute("aria-colindex",t+1)})})),this.setupKeyboardNavigation(e,t);const o=document.createElement("div");o.setAttribute("role","status"),o.setAttribute("aria-live","polite"),o.className="sr-only",e.parentNode.insertBefore(o,e.nextSibling),e.dataset.announcer=o.id=`table-announcer-${Date.now()}`}catch(n){this.handleError("Error setting up table accessibility",n,"setupAccessibility")}},setupSortableRows(e){const t=this.state.tables.get(e);if(!(null==t?void 0:t.element))return;const a=t.element.querySelector("tbody");if(a){if("undefined"!=typeof Sortable)return t.sortable=new Sortable(a,{draggable:"tr",handle:".drag-handle",animation:150,onStart:()=>{a.classList.add("sorting")},onEnd:async n=>{a.classList.remove("sorting");const r=Array.from(a.children).map((e,t)=>({id:e.dataset.id,position:t})),o=[];r.forEach(e=>{const a=t.data.find(t=>t.id===e.id);a&&o.push(a)}),t.data=o;const l=t.element.dataset.sortUrl,s=l||t.element.dataset.actionUrl||t.config.actionUrl;if(s)try{let t=!1;if(l){const e=await http.post(l,{order:r});t=e&&!1!==e.success}else{const a=document.createElement("button");a.className="loading",t=await this.sendAction(s,{action:"reorder",order:r},e,a)}if(!t)throw new Error("Failed to process request");NotificationManager.success("Saved successfully")}catch(i){console.error("Sort error:",i),NotificationManager.error("Failed to process request"),this.renderTable(e)}}}),t.sortable;console.warn("Sortable library is required for drag-and-drop rows")}},enableRowSort(e){var t;const a=this.state.tables.get(e);if(!(null==a?void 0:a.element))return;const n=a.element.querySelector("thead tr");if(n&&!n.querySelector("th.drag-handle")){const e=document.createElement("th");e.className="drag-handle",e.innerHTML="⋮⋮",e.style.width="2rem",e.style.textAlign="center";const a=(null==(t=n.querySelector(".check-column"))?void 0:t.nextSibling)||n.firstChild;n.insertBefore(e,a)}a.element.querySelectorAll("tbody tr").forEach(e=>{var t;if(!e.querySelector(".drag-handle")){const a=document.createElement("td");a.className="drag-handle",a.innerHTML="⋮⋮",a.style.cursor="move",a.style.width="2rem",a.style.textAlign="center";const n=(null==(t=e.querySelector(".check-column"))?void 0:t.nextSibling)||e.firstChild;e.insertBefore(a,n)}}),a.sortable||this.setupSortableRows(e)},disableRowSort(e){const t=this.state.tables.get(e);if(!(null==t?void 0:t.element))return;t.element.querySelectorAll(".drag-handle").forEach(e=>{e.remove()});const a=t.element.querySelector("th.drag-handle");a&&a.remove(),t.sortable&&(t.sortable.destroy(),t.sortable=null)},async loadTableData(e){const t=this.state.tables.get(e);if(null==t?void 0:t.element){this.clearSelection(t,e);try{const a=t.element.dataset.source;if(!a)return void this.loadFromHtml(t);this.showLoading(t),a.startsWith("api/")||a.startsWith("http")?await this.loadFromApi(t,e,a):a.endsWith(".json")?await this.loadFromJson(e,a):this.loadFromState(e,a)}catch(a){this.handleError("Error loading table data",a,"loadData")}}},isServerSideTable(e){var t,a,n;if(!e)return!1;const r=(null==(a=null==(t=null==e?void 0:e.element)?void 0:t.dataset)?void 0:a.source)||(null==(n=null==e?void 0:e.config)?void 0:n.source)||"";return!(!r||!r.startsWith("api/")&&!r.startsWith("http"))},createEmptyRow(e){e._newRowCounter||(e._newRowCounter=0),e._newRowCounter++;const t={id:`new_${e._newRowCounter}`};return(null==e?void 0:e.columns)instanceof Map&&e.columns.forEach((e,a)=>{t[a]=""}),t},captureRowValues(e,t,a,n=0){if(!(null==e?void 0:e.element))return a;let r=null;if((null==a?void 0:a.id)&&(r=e.element.querySelector(`tbody tr[data-id="${a.id}"]`)),r||(r=e.element.querySelectorAll("tbody tr")[n]||null),!r)return a;const o={...a};return e.columns.forEach((e,t)=>{const a=r.querySelector(`td[data-field="${t}"]`);if(!a)return;let n=null;a.dataset.elementId&&(n=document.getElementById(a.dataset.elementId)),n||(n=a.querySelector('input, select, textarea, [contenteditable="true"]')),o[t]=n?this.getFormElementValue(n):a.textContent}),o},async loadFromApi(e,t,a){const n={...this.getFilterParams(e),...this.getSortParams(e),...this.getPaginationParams(e)};await this.fetchAndSet(t,a,{method:e.config.method||"GET",headers:{Accept:"application/json"},params:n})},async loadFromJson(e,t){await this.fetchAndSet(e,t,{method:"GET",headers:{Accept:"application/json"}})},async fetchAndSet(e,t,a={}){var n,r,o,l,s;try{const{method:i="GET",headers:c={},params:d,body:u,data:m,credentials:h,...p}=a,f=i.toUpperCase(),g=void 0!==u?u:m,b=h||((null==(o=null==(r=null==(n=window.ApiService)?void 0:n.config)?void 0:r.security)?void 0:o.sendCredentials)?"include":"same-origin"),w=ApiService.config.cache;let y;w.enabled=!1;const v={...p,headers:c,credentials:b,cache:w},E=f.toLowerCase();if("GET"===f)y=await ApiService.get(t,d||{},v);else{if("function"!=typeof ApiService[E])throw new Error(`Unsupported request method: ${f}`);y=await ApiService[E](t,g,{...v,params:d})}if(403===(null==y?void 0:y.status))return console.warn("TableManager: Access forbidden (403) for table data"),(null==(l=window.RouterManager)?void 0:l.navigate)?void window.RouterManager.navigate("/403"):(null==(s=window.LocationManager)?void 0:s.redirect)?void window.LocationManager.redirect("/403"):void(window.location.href="/403");if(401===(null==y?void 0:y.status)){console.warn("TableManager: Unauthorized (401) for table data");const e=new Error(y.statusText||"Unauthorized");return e.status=401,e.response=y,void(await AuthErrorHandler.handleError(e,{currentPath:window.location.pathname}))}if(!1===(null==y?void 0:y.success))throw new Error((null==y?void 0:y.message)||(null==y?void 0:y.statusText)||`Request failed (${(null==y?void 0:y.status)||"unknown"})`);let S;S=(null==y?void 0:y.data)?y.data.columns||y.data.meta||y.data.filters?y.data:y.data.data?y.data.data:y.data:y;const A=this.state.tables.get(e);A&&S&&S.meta&&"object"==typeof S.meta&&(A.serverSide=!0),this.setData(e,S)}catch(i){this.handleError("Fetch error",i,"fetchAndSet")}},loadFromHtml(e,t){let a=null,n=null,r=t;if(!e)return;if(e.element)a=e,n=e.element,r=r||a.id||n&&n.dataset&&n.dataset.table;else{if(!(e instanceof Element))return;n=e,r=r||n.dataset&&n.dataset.table,a=this.state.tables.get(r)||{element:n,id:r}}if(!n)return;if(a){if(a.data&&a.data.length>0)return;if(a.loading)return}const o=[...n.querySelectorAll("th")].map(e=>({field:e.dataset.field||e.textContent.trim().toLowerCase(),sort:e.dataset.sort,formatter:e.dataset.formatter})),l=[...n.querySelectorAll("tbody tr")].map(e=>{const t={};return[...e.cells].forEach((e,a)=>{const n=o[a]||{field:`col_${a}`};t[n.field]={text:e.textContent.trim(),html:e.innerHTML}}),t}),s=l.map(e=>{const t={};return Object.entries(e).forEach(([e,a])=>{t[e]=null==a?a:"object"==typeof a?void 0!==a.text?a.text:void 0!==a.html?a.html:JSON.stringify(a):a}),t});try{a&&(a.originalData=l)}catch(i){}if(r)this.setData(r,s);else{for(const[e,t]of this.state.tables.entries())if(t.element===n)return void this.setData(e,s);console.warn("TableManager: unable to determine tableId for HTML data load")}},loadFromState(e,t){const a=Now.getManager?Now.getManager("state"):null;if(!a||"function"!=typeof a.get)throw new Error("Now.js state manager not available");const n=a.get(t);if(n)this.setData(e,n);else{if("function"==typeof a.subscribe){const handler=n=>{if(n)try{this.setData(e,n)}catch(r){console.error("Error applying state update to table:",r)}finally{"function"==typeof a.unsubscribe?a.unsubscribe(t,handler):"function"==typeof a.off&&a.off(t,handler)}};try{a.subscribe(t,handler)}catch(r){console.warn(`Unable to subscribe to state key ${t}:`,r)}return}console.warn(`State key ${t} not found and state manager has no subscribe; table ${e} will remain empty until data is set`)}},setData(e,t){var a;if(!e)throw new Error("Invalid parameters");let n=null;if(Array.isArray(t))n={data:t,meta:t&&t.meta?{...t.meta}:{total:t.length},filters:t&&t.filters?t.filters:{},options:t&&t.options?t.options:{},columns:t&&t.columns?t.columns:void 0};else{if(!t||!Array.isArray(t.data))throw new Error("Invalid data payload: expected canonical schema {data:[], meta:{page: 1, pageSize: 20, total: 0}, filters:{}, options:{}}");n={data:t.data,meta:t.meta?{...t.meta}:{total:t.data.length},filters:t.filters||{},options:t.options||{},columns:t.columns||void 0}}const r=this.state.tables.get(e);if(r)try{let t=null;if(r.config.dynamicColumns&&(n.columns&&Array.isArray(n.columns)?t=n.columns:n.data&&n.data.columns&&Array.isArray(n.data.columns)&&(t=n.data.columns)),t){const n=r.element.querySelector("thead");if(!n||0===n.querySelectorAll("th[data-field]").length){const o=this.createDynamicHeaders(r,t);n&&n.remove();const l=r.element.querySelector("tbody");if(r.element.insertBefore(o,l),window.Now&&window.Now.translate&&o.querySelectorAll("[data-i18n]").forEach(e=>{const t=e.textContent.trim();t&&(e.textContent=window.Now.translate(t))}),r.columns=this.getColumnDefinitions(r),o.querySelectorAll("th[data-sort]").forEach(t=>{t.classList.add("sortable"),t.setAttribute("role","columnheader"),t.setAttribute("tabindex","0"),t.setAttribute("aria-sort","none");const sortHandler=a=>{var n;a.preventDefault(),a.stopPropagation(),a.shiftKey&&(null==(n=window.getSelection())||n.removeAllRanges()),this.handleSort(r,e,t,a)},keyHandler=a=>{"Enter"!==a.key&&" "!==a.key||(a.preventDefault(),this.handleSort(r,e,t,a))};t.addEventListener("click",sortHandler),t.addEventListener("keydown",keyHandler),r.eventHandlers||(r.eventHandlers={sort:new Map}),r.eventHandlers.sort||(r.eventHandlers.sort=new Map),r.eventHandlers.sort.set(t,{sort:sortHandler,key:keyHandler})}),r.config.showFooter){let e=r.element.querySelector("tfoot");if(!e){e=document.createElement("tfoot");const t=document.createElement("tr"),n=(null==(a=o.querySelector("tr"))?void 0:a.querySelectorAll("th").length)||0;for(let e=0;e<n;e++){const e=document.createElement("td");t.appendChild(e)}e.appendChild(t),r.element.appendChild(e)}}if(this.setupCheckboxes(r,e),this.setupFilter(r,e),this.setupColumnResizing(e),this.setupAccessibility(r.element,e,r.config),!r.config.searchColumns||0===r.config.searchColumns.length){const e=t.filter(e=>!0===e.searchable).map(e=>e.field);e.length>0&&(r.config.searchColumns=e.join(","))}}}n.options&&Object.keys(n.options).length&&(r.dataOptions||(r.dataOptions={}),Object.assign(r.dataOptions,n.options),r.externalFilterForm&&this.populateExternalFilterOptions(r,n.options)),n.filters&&Object.keys(n.filters).length&&(this.setFilters(e,n.filters),r.externalFilterForm&&this.populateExternalFilterOptions(r,n.filters),r.dataOptions||(r.dataOptions={}),Object.entries(n.filters).forEach(([e,t])=>{if(Array.isArray(t)&&t.length>0){const a={};t.forEach(e=>{if(e&&"object"==typeof e){const t=void 0!==e.value?e.value:void 0!==e.key?e.key:e,n=e.label||e.text||String(e);a[t]=n}else a[e]=String(e)}),r.dataOptions[e]=a}}));const l=parseInt(n.meta.page||r.config.params.page),s=parseInt(n.meta.pageSize||r.config.params.pageSize),i=parseInt(n.meta.total||0),c=parseInt(n.meta.totalPages||Math.max(1,Math.ceil(i/s))),d=l>c?c:l;r.config.params={...r.config.params,...n.meta,page:d,pageSize:s,total:i,totalPages:c};let u=n.data||[];if(!Array.isArray(u)&&u.data&&Array.isArray(u.data)&&(u=u.data),!Array.isArray(u))throw new Error("Invalid data format: expected array");r.data=u;try{const t=this.deriveFiltersFromData(r);t&&Object.keys(t).length&&(r.filterElements&&("number"==typeof r.filterElements.size?r.filterElements.size>0:Object.keys(r.filterElements).length>0)?this.setFilters(e,t):r.pendingDerivedFilters=t)}catch(o){console.warn("Failed to derive filter options from data:",o)}if(n.meta.sort&&0===Object.keys(r.sortState).length){const e=n.meta.sort;e.split(",").map(e=>e.trim()).forEach(e=>{const t=e.split(/\s+/);if(t.length>=2){const e=t[0],a=t[1].toLowerCase();["asc","desc"].includes(a)&&(r.sortState[e]=a)}else 1===t.length&&t[0]&&(r.sortState[t[0]]="asc")})}!0===n.resetSort&&(r.sortState={}),r.initializing||this.renderTable(e)}catch(l){this.handleError("Setting table data",l,"setData"),r.data=[],r.initializing||this.renderTable(e)}},setFilters(e,t){const a=this.state.tables.get(e);if(a)try{a.filterOptions=t,Object.entries(t).forEach(([e,t])=>{var n;const r=a.filterData.get(e),o=a.columns.get(e);if(r&&r.element){const i=[];if(o&&o.showAll&&i.push({value:o.allValue||"",text:o.allLabel||"All"}),t instanceof Map)for(const[e,a]of t.entries())i.push({value:e,text:a});else Array.isArray(t)?t.forEach(e=>{if(e&&"object"==typeof e){const t=void 0!==e.value?e.value:void 0!==e.key?e.key:e,a=e.text||e.label||String(e);i.push({value:t,text:a})}else i.push({value:e,text:String(e)})}):"object"==typeof t&&null!==t&&Object.entries(t).forEach(([e,t])=>{i.push({value:e,text:t})});let c=null;try{if(ElementManager&&"function"==typeof ElementManager.getInstanceByElement&&(c=ElementManager.getInstanceByElement(r.element)||null),!c&&(null==(n=r.element)?void 0:n.id)&&"function"==typeof ElementManager.getInstance&&(c=ElementManager.getInstance(r.element.id)||null,c&&c.element&&c.element!==r.element&&!c.element.isConnected)){try{ElementManager.destroy(r.element.id)}catch(l){}c=null}}catch(l){c=null}if((null==c?void 0:c.updateOptions)&&"function"==typeof c.updateOptions){c.updateOptions(i);let t=null;void 0!==a.config.params[e]&&null!==a.config.params[e]&&""!==a.config.params[e]?t=a.config.params[e]:void 0!==r.element.value&&(t=r.element.value),null!==t&&(c.setValue&&"function"==typeof c.setValue?c.setValue(t):r.element&&(r.element.value=t))}else try{const t=r.element,n=t&&"SELECT"===t.tagName?t:t&&t.querySelector?t.querySelector("select"):null;if(n){n.innerHTML="",i.forEach(e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.text,n.appendChild(t)});let t=null;if(void 0!==a.config.params[e]&&null!==a.config.params[e]&&""!==a.config.params[e]?t=a.config.params[e]:void 0!==r.element.value&&(t=r.element.value),null!==t){Array.from(n.options).some(e=>e.value===String(t))&&(n.value=t)}}else t&&t.updateOptions&&"function"==typeof t.updateOptions?t.updateOptions(i):console.warn("No method found to update filter element options for",e)}catch(s){console.warn("Failed DOM fallback for updating filter options",s)}}}),this.restoreFilterUIFromState(e)}catch(n){console.error("Error setting filters:",n)}},deriveFiltersFromData(e){if(!e||!Array.isArray(e.data))return{};const t={};return e.columns.forEach((a,n)=>{if(!a.filter)return;if(a.options&&Object.keys(a.options).length||e.filterOptions&&e.filterOptions[n])return;const r=new Map;e.data.forEach(e=>{const t=e[n];if(null==t)return;const a="object"==typeof t?void 0!==t.value?t.value:void 0!==t.text?t.text:JSON.stringify(t):t;r.has(a)||r.set(a,String(a))}),r.size>0&&(t[n]=Array.from(r.entries()).map(([e,t])=>({value:e,text:t})))}),t},renderTable(e){const t=this.state.tables.get(e);if(!t)return;const{element:a,config:n}=t,r=a.querySelector("tbody");if(r)try{r.innerHTML="";const o=a.dataset.source||n.source||"",l=o&&(o.startsWith("api/")||o.startsWith("http")),s=t.serverSide||void 0!==n.params.total&&n.params.total!==(t.data||[]).length,i=l||s;!n.allowRowModification||Array.isArray(t.data)&&0!==t.data.length||(t.data=[this.createEmptyRow(t)]);const c=t.data||[];let d=c,u=c,m=1,h=c.length;if(i)u=c,h=n.params.total||c.length,m=n.params.totalPages||Math.ceil(h/(n.params.pageSize||c.length||1));else{d=this.filterData(t,c),d=this.sortData(t,d);const e=this.paginateData(t,d);u=e.pageData,m=e.totalPages,h=e.totalRecords}if(0===u.length){const e=document.createElement("tr"),t=document.createElement("td");t.colSpan=a.querySelectorAll("thead th").length,t.className="empty-table",t.textContent=Now.translate("No data available"),e.appendChild(t),r.appendChild(e)}else u.forEach((a,n)=>{const o=this.renderRow(t,e,a,n);r.appendChild(o)});n.allowRowModification&&!1!==n.rowSortable?this.enableRowSort(e):this.disableRowSort(e),this.restoreSortUI(t),this.setupFooter(t),n.params.pageSize>0&&this.updatePagination(t,e,h,m),EventManager.emit("table:render",{tableId:e,data:u,totalRecords:i?h:c.length,filteredRecords:i?h:d.length,isServerSide:i})}catch(o){this.handleError("Rendering table",o,"render")}},restoreSortUI(e){if(e&&e.element&&(e.element.querySelectorAll("th[data-sort]").forEach(e=>{e.classList.remove("sort_asc","sort_desc"),e.setAttribute("aria-sort","none");const t=e.querySelector(".sort-order");t&&t.remove()}),e.sortState&&Object.keys(e.sortState).length>0)){const t=Object.keys(e.sortState).length>1;Object.entries(e.sortState).forEach(([a,n],r)=>{const o=e.element.querySelector(`th[data-sort="${a}"]`);if(o&&(o.classList.add("asc"===n?"sort_asc":"sort_desc"),o.setAttribute("aria-sort","asc"===n?"ascending":"descending"),t)){let e=o.querySelector(".sort-order");e||(e=document.createElement("span"),e.className="sort-order",o.appendChild(e)),e.textContent=r+1,e.setAttribute("aria-label",`Sort priority ${r+1}`)}})}},renderRow(e,t,a,n){const r=document.createElement("tr");if(a.id&&(r.dataset.id=a.id),e.config.showCheckbox){const o=document.createElement("td");o.className="check-column";const l=`select-row-${t}-${a.id||n}`,s=document.createElement("label");s.htmlFor=l;const i=document.createElement("input");i.type="checkbox",i.className="select-row",i.id=l,i.value=a.id||n,i.addEventListener("change",()=>{this.handleRowSelection(e,t)}),s.appendChild(i),o.appendChild(s),r.appendChild(o)}if(e.config.allowRowModification&&!1!==e.config.rowSortable){const e=document.createElement("td");e.className="drag-handle",e.innerHTML="⋮⋮",e.style.cursor="move",e.style.width="2rem",e.style.textAlign="center",r.appendChild(e)}if(e.columns.forEach((o,l)=>{this.renderCell(e,t,r,l,o,a,n)}),e.config.allowRowModification){const n=document.createElement("td");n.className="icons";const o=document.createElement("div");[{action:"copy",title:Now.translate("Copy"),text:"+",className:"plus",handler:async()=>this.handleCopyRow(e,t,a)},{action:"delete",title:Now.translate("Delete"),text:"-",className:"minus",handler:async()=>this.handleDeleteRow(e,t,a)}].forEach(e=>{const t=document.createElement("button");t.type="button",t.className=e.className,t.title=e.title,t.innerText=e.text,t.setAttribute("aria-label",e.title),t.addEventListener("click",async t=>{t.preventDefault(),await e.handler()}),o.appendChild(t)}),n.appendChild(o),r.appendChild(n)}const o=e.element.dataset.rowActions||e.element.dataset.rowActionsJson;if(o)try{const n=this.parseRowActions(o),l=this.createActionCell(e,t,a,n);r.appendChild(l)}catch(l){console.warn("Invalid data-row-actions for table",t,l)}return r},async handleCopyRow(e,t,a){try{const n=this.captureRowValues(e,t,a);if(Array.isArray(e.data)){const t=e.data.findIndex(e=>String(e.id)===String(a.id));-1!==t&&(e.data[t]=n)}const r=structuredClone?structuredClone(n):JSON.parse(JSON.stringify(n));e._newRowCounter||(e._newRowCounter=0),e._newRowCounter++,r.id=`new_${e._newRowCounter}`;const o=e.element.dataset.actionUrl||e.config.actionUrl,l=this.isServerSideTable(e);if(o){const s=document.createElement("button");s.className="loading";if(!(await this.sendAction(o,{action:"copy",row:a},t,s)))return;if(l)await this.loadTableData(t);else{const a=Array.isArray(e.data)?e.data.findIndex(e=>String(e.id)===String(n.id)):-1,o=a>=0?a+1:e.data.length;e.data.splice(o,0,r),this.renderTable(t)}}else{const a=Array.isArray(e.data)?e.data.findIndex(e=>String(e.id)===String(n.id)):-1,o=a>=0?a+1:e.data.length;e.data.splice(o,0,r),this.renderTable(t)}EventManager.emit("table:rowCopied",{tableId:t,originalItem:a,newItem:r})}catch(n){this.handleError("Copy row",n,"copyRow")}},async handleDeleteRow(e,t,a){try{if(window.DialogManager&&!1!==e.config.confirmDelete){await DialogManager.confirm(Now.translate("Are you sure you want to delete this item?"),Now.translate("Confirm Delete"))&&await this.deleteRow(e,t,a)}else await this.deleteRow(e,t,a)}catch(n){this.handleError("Delete row",n,"deleteRow")}},async deleteRow(e,t,a){try{const n=e.element.dataset.actionUrl||e.config.actionUrl,r=this.isServerSideTable(e),removeLocalRow=()=>{if(!Array.isArray(e.data))return;const n=e.data.findIndex(e=>e.id===a.id),r=-1!==n?n:e.data.indexOf(a);-1!==r&&e.data.splice(r,1),e.config.allowRowModification&&0===e.data.length&&e.data.push(this.createEmptyRow(e)),this.renderTable(t)};if(n){const e=document.createElement("button");e.className="loading";if(!(await this.sendAction(n,{action:"delete",id:a.id,row:a},t,e)))return;r?await this.loadTableData(t):removeLocalRow()}else removeLocalRow();NotificationManager.success("Deleted successfully"),EventManager.emit("table:rowDeleted",{tableId:t,item:a})}catch(n){this.handleError("Delete row",n,"deleteRow")}},getColumnDefinitions(e){const t=new Map,a=new Map,n=e.element.querySelector("thead");return n?(n.querySelectorAll("tr").forEach((e,r)=>{let o=0;e.querySelectorAll("th").forEach((e,l)=>{const s=e.dataset.field,i=parseInt(e.getAttribute("rowspan")||1),c=parseInt(e.getAttribute("colspan")||1);for(;a.has(`${r}-${o}`);)o++;if(i>1||c>1)for(let t=0;t<i;t++)for(let e=0;e<c;e++)a.set(`${r+t}-${o+e}`,{field:s,rowspan:i,colspan:c,startRow:r,startCol:o});if((i===n.rows.length||r===n.rows.length-1)&&s){const n=this.extractDataAttributes(e,{field:"",filter:"",value:"",type:"",placeholder:"",options:{},datalist:{},label:"",min:"",max:"",step:"",pattern:"",maxLength:0,showAll:!0,allLabel:"All items",allValue:"",formatter:"",format:"",class:"",cellClass:"",cellElement:"",autocomplete:"off",template:""});t.set(s,{...n,index:o,mergeInfo:a.get(`${r}-${o}`)||null})}o+=c})}),new Map([...t.entries()].sort((e,t)=>e[1].index-t[1].index))):t},createDynamicHeaders(e,t){const a=document.createElement("thead"),n=document.createElement("tr");if(e.config.showCheckbox){const t=document.createElement("th");t.className="check-column";const a=`select-all-${e.id}`,r=document.createElement("label");r.htmlFor=a;const o=document.createElement("input");o.type="checkbox",o.className="select-all",o.id=a,o.setAttribute("aria-label","Select all"),r.appendChild(o),t.appendChild(r),n.appendChild(t)}if(e.config.allowRowModification&&!1!==e.config.rowSortable){const e=document.createElement("th");e.className="drag-handle",e.style.width="2rem",n.appendChild(e)}if(t.forEach(e=>{const t=document.createElement("th");t.dataset.field=e.field,t.textContent=e.label||e.field,void 0!==e.sort&&(t.dataset.sort=e.sort),void 0!==e.filter&&(t.dataset.filter=e.filter),void 0!==e.type&&(t.dataset.type=e.type),void 0!==e.formatter&&(t.dataset.formatter=e.formatter),void 0!==e.format&&(t.dataset.format=e.format),void 0!==e.class&&(t.className=e.class),void 0!==e.cellClass&&(t.dataset.cellClass=e.cellClass),void 0!==e.i18n&&(t.dataset.i18n=""),void 0!==e.placeholder&&(t.dataset.placeholder=e.placeholder),void 0!==e.template&&(t.dataset.template=e.template),void 0!==e.cellElement&&(t.dataset.cellElement=e.cellElement),void 0!==e.align&&(t.dataset.align=e.align),void 0!==e.emptyText&&(t.dataset.emptyText=e.emptyText),void 0!==e.options&&(("object"!=typeof e.options||Array.isArray(e.options))&&"string"==typeof e.options?t.dataset.options=e.options:t.dataset.options=JSON.stringify(e.options)),void 0!==e.datalist&&(t.dataset.datalist=JSON.stringify(e.datalist)),void 0!==e.min&&(t.dataset.min=e.min),void 0!==e.max&&(t.dataset.max=e.max),void 0!==e.step&&(t.dataset.step=e.step),void 0!==e.pattern&&(t.dataset.pattern=e.pattern),void 0!==e.maxLength&&(t.dataset.maxLength=e.maxLength),void 0!==e.showAll&&(t.dataset.showAll=e.showAll),void 0!==e.allLabel&&(t.dataset.allLabel=e.allLabel),void 0!==e.allValue&&(t.dataset.allValue=e.allValue),void 0!==e.autocomplete&&(t.dataset.autocomplete=e.autocomplete),n.appendChild(t)}),e.config.allowRowModification){const e=document.createElement("th");e.className="icons",n.appendChild(e)}if(e.element.dataset.rowActions||e.element.dataset.rowActionsJson){const t=document.createElement("th");t.className="row-actions",t.textContent=e.element.dataset.rowActionsLabel||(window.Now?Now.translate("Actions"):"Actions"),n.appendChild(t)}return a.appendChild(n),a},setupFooter(e){const t=e.element.querySelector("tfoot");if(!t)return;const a=this.getColumnGroups(e);t.querySelectorAll("td[data-processed]").forEach(e=>{delete e.dataset.processed}),e.config.showCheckbox&&t.querySelectorAll("tr").forEach(t=>{if(!t.querySelector(".check-column")){const a=document.createElement("td");if(a.className="check-column","true"===t.dataset.showCheckbox){const t=`select-all-${e.id}-footer`,n=document.createElement("label");n.htmlFor=t;const r=document.createElement("input");r.type="checkbox",r.className="select-all",r.id=t,r.setAttribute("aria-label",Now.translate("Select all")),r.addEventListener("change",t=>{this.handleSelectAll(e,e.id,t.target.checked)}),n.appendChild(r),a.appendChild(n)}t.insertBefore(a,t.firstChild)}}),t.querySelectorAll("tr").forEach(t=>{t.querySelectorAll("td").forEach((t,n)=>{var r,o;if("true"===t.dataset.processed)return;const l=Object.keys(t.dataset).find(e=>["sum","avg","count","min","max","custom"].includes(e));if(!l)return;if("custom"===l){const a=t.dataset.custom;if(a&&window[a]&&"function"==typeof window[a])try{const n=window[a](e.data,t,e);t.textContent=n}catch(h){console.error(`Error executing custom footer function ${a}:`,h)}return void(t.dataset.processed="true")}const s=t.dataset[l];if(!s)return;const i=this.calculateAggregate(e.data,s,l),c=t.dataset.format||(null==(r=a[n])?void 0:r.format),d=this.formatValue(i,c),u=t.dataset.prefix||"",m=t.dataset.suffix||"";t.textContent=u+d+m,t.dataset.class||(null==(o=a[n])?void 0:o.class)?t.className=(t.dataset.class||a[n].class)+" aggregate-cell":t.className="aggregate-cell",t.dataset.processed="true"})}),EventManager.emit("table:footerSetup",{tableId:e.id,tfoot:t,data:e.data})},calculateAggregate(e,t,a){if(!(null==e?void 0:e.length)||!t)return 0;const n=e.map(e=>parseFloat(e[t])).filter(e=>!isNaN(e));if(!n.length)return 0;switch(a){case"sum":return n.reduce((e,t)=>e+t,0);case"avg":return n.reduce((e,t)=>e+t,0)/n.length;case"count":return n.length;case"min":return Math.min(...n);case"max":return Math.max(...n);default:return 0}},calculateGroupAggregate(e,t,a){if(!(null==e?void 0:e.length)||!(null==t?void 0:t.length))return 0;const n=e.map(e=>t.reduce((t,a)=>{const n=parseFloat(e[a]);return t+(isNaN(n)?0:n)},0));return this.calculateAggregate(n,"value",a)},getColumnGroups(e){const t=[],a=e.element.querySelector("thead");if(!a||!a.rows.length)return t;const n=a.rows[a.rows.length-1];if(!n)return t;return Array.from(n.cells).map(e=>({field:e.dataset.field||null,format:e.dataset.format||null,class:e.dataset.class||null}))},updateTableCaption(e,t,a){var n;if(!(null==e?void 0:e.element)||!e.config.showCaption)return;const{pageSize:r,page:o,search:l}=e.config.params;let s=e.element.querySelector("caption");s||(s=document.createElement("caption"),e.element.appendChild(s));let i="";i=l&&l.length>0?"Search <strong>{search}</strong> found {count} entries, displayed {start} to {end}, page {page} of {total} pages":"All {count} entries, displayed {start} to {end}, page {page} of {total} pages";const c={count:t,start:(o-1)*r+1,end:Math.min(o*r,t),page:o,total:a,search:l};let d=Now.translate(i,c);if("string"==typeof d&&/\{[^}]+\}/.test(d))try{const e=Now.getManager?Now.getManager("i18n"):window.I18nManager;d=e&&"function"==typeof e.interpolate?e.interpolate(d,c,null==(n=e.getTranslations)?void 0:n.call(e)):String(d).replace(/\{([^}]+)\}/g,(e,t)=>void 0!==c[t]?c[t]:e)}catch(u){}s.innerHTML=d},filterData(e,t){if(!e||!e.config.params||0===Object.keys(e.config.params).length)return t;const a=e.config.params,n=e.config.searchColumns||[];return t.filter(t=>{const r=Object.entries(a).every(([a,n])=>{var r;if(["search","pageSize","page","total","summary"].includes(a))return!0;if(""===n)return!0;const o=t[a],l=e.columns.get(a);if(!l)return!0;if(null==o)return!1;if(l.showAll&&n.toString()===l.allValue.toString())return!0;const s=null==(r=e.element.querySelector(`th[data-field="${a}"]`))?void 0:r.dataset.filterFn;return s&&"function"==typeof window[s]?window[s](o,n,t):"text"===l.type?o.toString().toLowerCase().includes(n.toString().toLowerCase()):o.toString()===n.toString()}),o=!a.search||n.some(e=>{const n=t[e];return null!=n&&n.toString().toLowerCase().includes(a.search.toLowerCase())});return r&&o})},sortData:(e,t)=>e&&e.sortState&&0!==Object.keys(e.sortState).length?[...t].sort((t,a)=>{var n;for(const[r,o]of Object.entries(e.sortState)){const l=t[r],s=a[r],i=null==(n=e.element.querySelector(`th[data-field="${r}"]`))?void 0:n.dataset.sorter;if(i&&"function"==typeof window[i]){const e=window[i](l,s,t,a);if(0!==e)return"asc"===o?e:-e;continue}if(l===s)continue;const c=l>s?1:-1;return"asc"===o?c:-c}return 0}):t,paginateData(e,t){if(!e||e.config.params.pageSize<=0)return{pageData:t,totalPages:1,totalRecords:t.length};const{pageSize:a,page:n}=e.config.params,r=(n-1)*a;let o;o=e.serverSide?t:t.slice(r,r+a);const l=parseInt(e.config.params.total||t.length||0);return{pageData:o,totalPages:a>0?Math.max(1,Math.ceil(l/a)):1,totalRecords:l}},updatePagination(e,t,a,n){if(e){if(e.paginationWrapper.innerHTML="",n>1){let a=Math.max(1,e.config.params.page-2),r=Math.min(n,a+4);r-a<4&&(a=Math.max(1,r-4)),a>1&&this.addPaginationButton(e,t,1,"1",e.config.params.page);for(let n=a;n<=r;n++)this.addPaginationButton(e,t,n,n,e.config.params.page);r<n&&this.addPaginationButton(e,t,n,n,e.config.params.page)}this.updateTableCaption(e,a,n)}},addPaginationButton(e,t,a,n,r){const o=document.createElement("button");o.textContent=n,o.setAttribute("type","button"),a!==r?(o.classList.add("pagination-button"),o.setAttribute("aria-label",Now.translate("Go to page {page}",{page:a})),o.onclick=n=>{n.preventDefault(),this.handleFilterChange(e,t,"page",parseInt(a))}):(o.disabled=!0,o.setAttribute("aria-current","page")),e.paginationWrapper.appendChild(o)},renderCell(e,t,a,n,r,o,l){var s,i;const c=document.createElement("td");c.dataset.field=n;let d=o[n];const normalizeValue=e=>null==e?e:"object"==typeof e?void 0!==e.text?e.text:void 0!==e.html?e.html:void 0!==e.value?e.value:JSON.stringify(e):e,u=d,m=normalizeValue(d);try{if(r.cellClass&&(c.className=r.cellClass),r.align&&(c.style.textAlign=r.align),null==m)return c.textContent=r.emptyText||"",void a.appendChild(c);if(r.cellElement&&""!==r.cellElement)this.renderElementCell(c,e,t,n,r,o,l);else if(r.formatter&&"function"==typeof window[r.formatter])window[r.formatter](c,u,o,r);else if(r.format){const t=(null==(s=e.dataOptions)?void 0:s[n])||(null==(i=e.filterOptions)?void 0:i[n])||r.options;c.textContent=this.formatValue(m,r.format,t)}else if(r.template){let e=r.template.replace(/\${(\w+)}/g,(e,t)=>{const a=o[t];return void 0!==a?normalizeValue(a):e});try{const t=window.Now&&Now.getManager?Now.getManager("i18n"):null;if(t&&"function"==typeof t.interpolate)e=t.interpolate(e);else if(window.Now&&"function"==typeof Now.translate){const t=e.replace(/^\s+|\s+$/g,"");!t.includes("<")&&t.startsWith("{LNG_")&&t.endsWith("}")&&(e=Now.translate(t.slice(1,-1)))}}catch(h){}try{const t=window.TemplateManager;if(!t||"function"!=typeof t.processTemplateString)throw new Error("TemplateManager.processTemplateString not available");const a=document.createElement("div"),n={state:{data:o},data:o,skipScan:!0};t.processTemplateString(e,n,a),e=a.innerHTML}catch(h){const t=`Template error: ${h.message||h}`;e=`<span class="template-error" title="${t}">${t}</span>`;try{ErrorManager.handle(t,{context:"TableManager.renderCell.template",data:{field:n,template:r.template,error:h}})}catch(p){console.error(t,h)}}c.innerHTML=e;try{const e=window.Now&&Now.getManager?Now.getManager("i18n"):null;c.querySelectorAll("[data-i18n]").forEach(t=>{const a=t.getAttribute("data-i18n"),n=a;if(null!=a)try{t.dataset.i18n=a}catch(h){}if(""===n||null===n)"undefined"!=typeof Now&&"function"==typeof Now.translate&&(t.textContent=Now.translate(t.textContent||""));else{let a=n;if(e&&"function"==typeof e.interpolate)try{a=e.interpolate(a)}catch(h){}"undefined"!=typeof Now&&"function"==typeof Now.translate?t.textContent=Now.translate(a):t.textContent=a}})}catch(h){}}else u&&"object"==typeof u&&void 0!==u.html?c.innerHTML=u.html:c.textContent=m;r.dataAttributes&&Object.entries(r.dataAttributes).forEach(([e,t])=>{const a="function"==typeof t?t(o):t;c.dataset[e]=a}),r.events&&Object.entries(r.events).forEach(([t,a])=>{c.addEventListener(t,t=>a(t,o,c,e))}),a.appendChild(c)}catch(f){this.handleError("Rendering cell failed",f,"renderCell"),c.textContent=void 0!==d?d:"",a.appendChild(c)}},translateValue(e){try{const t=window.Now&&Now.getManager?Now.getManager("i18n"):null;if(t&&"function"==typeof t.interpolate)return t.interpolate(e);if("undefined"!=typeof Now&&"function"==typeof Now.translate)return Now.translate(e)}catch(t){}return e},retranslateFilter(e){if(!e)return;const t=e.config||{};if(e.filterElements&&e.filterElements instanceof Map){const a=e.filterElements.get("search");(null==a?void 0:a.element)&&Array.isArray(t.searchColumns)&&t.searchColumns.length&&(a.element.placeholder=`${Now.translate("Search in")}: ${t.searchColumns.join(", ")}`)}},renderElementCell(e,t,a,n,r,o,l){const s=Now.getManager("element"),i=o[n];if(!s)return void(e.textContent=i||"");let c=r.cellElement,d=this.getElementConfig(t,a,n,r,o,l);if(d)try{const a=s.create(c,d);a&&a.element?(e.dataset.elementId=a.element.id,a.wrapper?e.appendChild(a.wrapper):e.appendChild(a.element),t.elementInstances||(t.elementInstances=new Map),t.elementInstances.set(a.element.id,a)):e.textContent=i}catch(u){console.error("Failed to create element in cell:",u),e.textContent=i}else e.textContent=i},getElementConfig(e,t,a,n,r,o){if(!n.cellElement&&n.type&&(n.cellElement=n.type),!n.cellElement)return null;const l=r[a],s=null==(i=l)?i:"object"==typeof i?void 0!==i.value?i.value:void 0!==i.text?i.text:void 0!==i.html?i.html:JSON.stringify(i):i;var i;const c={type:n.cellElement,name:`${a}[${r.id||o}]`,id:`${t}_${a}_${r.id||o}`,wrapper:n.wrapper||"div",value:s,autocomplete:n.autocomplete||"off",className:n.class,readOnly:n.readOnly,disabled:n.disabled,required:n.required,placeholder:n.placeholder||n.label};switch(n.cellElement){case"select":c.options=e.filterOptions&&e.filterOptions[a]||n.options||{},"string"==typeof c.options&&window[c.options]&&(c.options=window[c.options]),c.multiple=n.multiple,c.allowEmpty=!1!==n.allowEmpty;break;case"text":case"email":case"url":case"password":if(void 0!==n.minLength&&null!==n.minLength&&""!==n.minLength){const e=parseInt(n.minLength,10);!isNaN(e)&&e>=0&&(c.minLength=e)}if(void 0!==n.maxLength&&null!==n.maxLength&&""!==n.maxLength){const e=parseInt(n.maxLength,10);!isNaN(e)&&e>0&&(c.maxLength=e)}c.pattern=n.pattern,c.autocomplete=n.autocomplete||c.type,n.datalist&&(c.datalist=n.datalist);break;case"number":c.min=n.min,c.max=n.max,c.step=n.step||1;break;case"textarea":c.rows=n.rows||3,c.cols=n.cols,c.resizable=!1!==n.resizable;break;case"date":case"time":case"datetime-local":c.min=n.min,c.max=n.max,c.format=n.format;break;case"color":c.value&&!c.value.startsWith("#")&&(c.value="#"+c.value),c.value&&(c.value=c.value.toUpperCase());break;case"file":c.accept=n.accept,c.multiple=n.multiple,c.maxFileSize=n.maxFileSize,c.preview=n.preview;break;case"checkbox":case"radio":c.checked=!0===s||"1"===s||"true"===s,n.options&&(c.options=n.options);break;case"search":c.minLength=n.minLength||2,c.delay=n.delay||300,n.source&&(c.source=n.source),c.onSearch=n.onSearch}return n.validate&&(c.validate=n.validate),n.formatter&&(c.formatter=n.formatter),c},cleanupTableResources(e){try{const t=this.state.tables.get(e);if(!t)return;if(t._externalFilterCleanup&&Array.isArray(t._externalFilterCleanup)&&(t._externalFilterCleanup.forEach(e=>{try{e()}catch(t){console.warn("External filter cleanup error:",t)}}),t._externalFilterCleanup=[]),t.eventHandlers){if(t.eventHandlers.sort instanceof Map&&t.eventHandlers.sort.forEach((e,t)=>{t.removeEventListener("click",e.sort),t.removeEventListener("keydown",e.key)}),t.eventHandlers.keyboard&&t.element.removeEventListener("keydown",t.eventHandlers.keyboard),t.eventHandlers.delegation&&t.element){const e=t.element.querySelector("tbody");e&&(e.removeEventListener("click",t.eventHandlers.delegation.click),e.removeEventListener("change",t.eventHandlers.delegation.change))}t.eventHandlers.filterWrapperChange&&t.filterWrapper&&t.filterWrapper.removeEventListener("change",t.eventHandlers.filterWrapperChange),t.eventHandlers.actionButton&&t.actionElements&&t.actionElements.submit&&t.actionElements.submit.element&&(t.actionElements.submit.element.removeEventListener("click",t.eventHandlers.actionButton),delete t.eventHandlers.actionButton),t.eventHandlers={}}t.elementInstances&&t.elementInstances instanceof Map&&(t.elementInstances.forEach((e,t)=>{const a=Now.getManager("element");a&&a.destroy(t)}),t.elementInstances.clear()),t.filterElements&&t.filterElements instanceof Map&&(t.filterElements.forEach(e=>{if(e&&e.element&&e.element.id){const t=Now.getManager("element");t&&t.destroy(e.element.id)}}),t.filterElements.clear()),["filterWrapper","actionWrapper","paginationWrapper"].forEach(e=>{t[e]&&(t[e].remove(),t[e]=null)}),t.data=null,t.columns&&t.columns.clear&&t.columns.clear(),t.filterData&&t.filterData.clear&&t.filterData.clear(),t.filterOptions&&(t.filterOptions instanceof Map?t.filterOptions.clear():t.filterOptions={}),t.dataOptions&&(t.dataOptions={}),t.sortable=null,this.clearTableCache(e),t.element&&(t.element.removeAttribute("data-table-initialized"),t.element.classList.remove("table-initialized")),t.unsubscribe&&(t.unsubscribe(),t.unsubscribe=null)}catch(t){this.handleError("Failed to cleanup table resources",t,"cleanup")}},_handleDelegatedClick(e,t){var a,n;const r=this.state.tables.get(t);if(!r)return;const o=e.target.closest("[data-action]");if(o&&r.element.contains(o)){e.preventDefault();const n=o.dataset.action,l=o.dataset.params?JSON.parse(o.dataset.params):null,s=o.closest("tr"),i=null==(a=null==s?void 0:s.dataset)?void 0:a.id,c=i?this.getRowObjectById(t,i):null,d=r.element.dataset.actionUrl||r.config.actionUrl;return void this._executeRowAction(t,d,c||{},n,{...l||{}})}const l=e.target.closest("button, a");if(l&&r.element.contains(l)){const a=l.dataset.action;if(a){e.preventDefault();const o=l.closest("tr"),s=null==(n=null==o?void 0:o.dataset)?void 0:n.id,i=s?this.getRowObjectById(t,s):null,c=r.element.dataset.actionUrl||r.config.actionUrl;this._executeRowAction(t,c,i||{},a,{})}}},_handleDelegatedChange(e,t){var a,n;const r=this.state.tables.get(t);if(!r)return;const o=e.target;if(!r.element.contains(o))return;const l=o.closest("[data-field]")||o,s=l.dataset.field||l.name||l.dataset.name;if(s){const e=o.closest("tr"),l=null==(a=null==e?void 0:e.dataset)?void 0:a.id,i=l?this.getRowObjectById(t,l):null;if(o.classList&&o.classList.contains("select-all"))return;let c;if("checkbox"===o.type)c=o.checked?"1":"0";else if("radio"===o.type){const e=null==(n=o.closest("tr"))?void 0:n.querySelector(`input[name="${o.name}"]:checked`);c=e?e.value:null}else c=o.value;const d=!0;this.handleFieldChange(r,t,s,c,i,o,{send:d})}},getSelectedRowIds(e){if(!e||!e.element)return[];const t=e.element.querySelectorAll("tbody .select-row:checked");return Array.from(t).map(e=>e.value)},_performActionWrapperSubmission(e){var t,a;const n=this.state.tables.get(e);if(!n)return;const r=null==(t=n.actionElements)?void 0:t.select,o=null==(a=n.actionElements)?void 0:a.submit,l=n.element.dataset.actionUrl||n.config.actionUrl;if(!r||!o)return;const s=r.element,i=s?s.value:null;if(!i||""===i)return void NotificationManager.warning("Please select an action");const c=this.getSelectedRowIds(n);if(!c||0===c.length)return void NotificationManager.warning("Please select at least one row");const d={ids:c};if(i.includes("|")){const[e,t]=i.split("|",2);d.action=e,d[e]=t}else d.action=i;this.sendAction(l,d,e,o.element).catch(e=>console.error("Action submit error",e))},setupColumnResizing(e){const t=this.state.tables.get(e);if(!t||!t.element)return;if(!t.config.persistColumnWidths)return;const a=t.element.querySelector("thead");if(!a)return;try{const t=localStorage.getItem(`table_${e}_columns`);if(t){const e=JSON.parse(t);a.querySelectorAll("th").forEach((t,a)=>{e[a]&&(t.style.width=e[a])})}}catch(n){}a.querySelectorAll("th").forEach((t,r)=>{if(t.querySelector(".col-resizer"))return;const o=document.createElement("div");o.className="col-resizer",o.setAttribute("role","separator"),o.style.position="absolute",o.style.top="0",o.style.right="0",o.style.width="6px",o.style.cursor="col-resize",o.style.userSelect="none",o.style.height="100%",o.style.zIndex="5",t.appendChild(o);let l=0,s=0;const onMouseMove=e=>{const a=e.clientX-l,n=Math.max(30,s+a);t.style.width=`${n}px`},onMouseUp=t=>{document.removeEventListener("mousemove",onMouseMove),document.removeEventListener("mouseup",onMouseUp);try{const t=Array.from(a.querySelectorAll("th")).map(e=>e.style.width||window.getComputedStyle(e).width);localStorage.setItem(`table_${e}_columns`,JSON.stringify(t))}catch(n){console.warn("Failed to persist column widths",n)}};o.addEventListener("mousedown",e=>{e.preventDefault(),l=e.clientX,s=t.offsetWidth,document.addEventListener("mousemove",onMouseMove),document.addEventListener("mouseup",onMouseUp)})})},getRowObjectById(e,t){const a=this.state.tables.get(e);return a&&a.data&&a.data.find(e=>String(e.id)===String(t))||null},clearTableCache(e){try{const t=this.state.tables.get(e);if(!t)return;t.config.persistColumnWidths&&localStorage.removeItem(`table_${e}_columns`),localStorage.removeItem(`table_${e}_filters`),localStorage.removeItem(`table_${e}_sort`),localStorage.removeItem(`table_${e}_page`)}catch(t){this.handleError("Clear table cache",t,"clearCache")}},destroyTable(e){try{this.cleanupTableResources(e),this.state.tables.delete(e),EventManager.emit("table:destroyed",{tableId:e,timestamp:Date.now()})}catch(t){this.handleError("Destroy table",t,"destroy")}},destroy(){try{this.state.tables.forEach((e,t)=>{this.destroyTable(t)}),this.state.tables.clear(),this.dynamicObserver&&(this.dynamicObserver.disconnect(),this.dynamicObserver=null),EventManager.off("locale:changed"),this.globalEventHandlers&&(Object.entries(this.globalEventHandlers).forEach(([e,t])=>{window.removeEventListener(e,t)}),this.globalEventHandlers=null),this.resetState(),EventManager.emit("tablemanager:destroyed",{timestamp:Date.now()})}catch(e){this.handleError("Error during TableManager destruction",e,"destroy")}},bindToState(e,t){if(!e||!t)return this.handleError("Invalid parameters for bindToState",null,"bindToState");try{const a=this.state.tables.get(e);if(!a)return this.handleError(`Table ${e} not found`,null,"bindToState");if(!t.startsWith("state."))return a.initializing||this.loadTableData(e),!0;const n=Now.getManager("state");if(!n)return console.warn("[TableManager] StateManager not found, loading data from other source"),a.initializing||this.loadTableData(e),!0;n.get(t)||console.warn(`[TableManager] Data not found at path "${t}"`),a.unsubscribe&&(a.unsubscribe(),a.unsubscribe=null);const r=n.subscribe(t,a=>{const n=Array.isArray(a)?a:[];this.setData(e,n),EventManager.emit("table:stateUpdate",{tableId:e,statePath:t,recordCount:n.length,timestamp:Date.now()})});a.unsubscribe=r,a.statePath=t;const o=n.get(t);return o&&this.setData(e,Array.isArray(o)?o:[]),EventManager.emit("table:bound",{tableId:e,statePath:t,timestamp:Date.now()}),!0}catch(a){return this.handleError(`Error binding table ${e}`,a,"bindToState")}},setupDynamicTableObserver(){if(!window.MutationObserver)return;const e=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{1===e.nodeType&&(e.matches("table[data-table]")&&this.initTable(e),e.querySelectorAll&&e.querySelectorAll("table[data-table]").forEach(e=>{this.initTable(e)}))}),e.removedNodes.forEach(e=>{1===e.nodeType&&setTimeout(()=>{if(e.matches&&e.matches("table[data-table]")&&!e.isConnected){const t=e.dataset.table;t&&this.destroyTable(t)}e.querySelectorAll&&e.querySelectorAll("table[data-table]").forEach(e=>{if(!e.isConnected){const t=e.dataset.table;t&&this.destroyTable(t)}})},0)})})});e.observe(document.body,{childList:!0,subtree:!0}),this.dynamicObserver=e},handleError(e,t,a){const n=t||new Error(e);return ErrorManager.handle(n,{context:`TableManager.${a}`,type:"error:table",data:{message:e,error:t?{name:t.name,message:t.message,stack:t.stack}:null,tableId:this.currentTableId},notify:!0})},setupTouchEvents(e){if(!("ontouchstart"in window))return;let t,a,n,r;e.addEventListener("touchstart",o=>{const l=o.touches[0];t=l.clientX,a=l.clientY,n=Date.now(),r=setTimeout(()=>{const t=o.target.closest("tr");if(t){const a=t.querySelector(".select-all");a&&(a.checked=!a.checked,this.updateSelectedRows(e))}},500)}),e.addEventListener("touchmove",e=>{const n=e.touches[0],o=Math.abs(n.clientX-t),l=Math.abs(n.clientY-a);(o>10||l>10)&&clearTimeout(r)}),e.addEventListener("touchend",o=>{clearTimeout(r);const l=Date.now()-n,s=o.changedTouches[0],i=Math.abs(s.clientX-t),c=Math.abs(s.clientY-a);if(l<300&&i<10&&c<10){const t=o.target.closest("tr");if(t&&!o.target.closest(".select-all")){const a=t.querySelector(".select-all");a&&(a.checked=!a.checked,this.updateSelectedRows(e))}}}),e.addEventListener("touchcancel",()=>{clearTimeout(r)})},setupActions(e,t){if(!(null==e?void 0:e.actionWrapper))return;e.actionWrapper.innerHTML="";const a=Now.getManager("element");if(a){if(""!==e.config.actionUrl&&Object.keys(e.config.actions).length>0){const n={"":e.element.dataset.actionSelectLabel||e.config.actionSelectLabel||"Please select",...e.config.actions},r=a.create("select",{id:`select_action_${t}`,options:n,value:"",wrapper:"div"});let o=e.element.dataset.actionButton||e.config.actionButton||"Process";if("string"==typeof o){const e=o.split("|");e.length&&(o={value:e[0],className:e[1]||"btn-info"})}const l=a.create("button",{id:`action_button_${t}`,type:"button",value:o.value||"Process",className:`btn ${o.className||"btn-info"}`,wrapper:"div",disabled:!0});l.element.dataset.i18n=o.value||"Process",r&&l&&(e.actionWrapper.appendChild(r.wrapper),e.actionWrapper.appendChild(l.wrapper),e.actionElements={select:{element:r.element,id:r.element.id},submit:{element:l.element,id:l.element.id}},EventManager.on("table:selectionChange",e=>{e.data.tableId===t&&(l.element.disabled=!e.data.selectedRows||0===e.data.selectedRows.length)}))}this.setupFilterActions(e,t)}},setupFilterActions(e,t){const a=e.element.dataset.filterActions;if(!a)return;let n;try{n=JSON.parse(a)}catch(r){return void console.warn("Invalid data-filter-actions JSON:",r)}n&&"object"==typeof n&&Object.entries(n).forEach(([a,n])=>{const{label:r=a,url:o,type:l="button",className:s="",method:i="POST",target:c="_self",confirm:d}=n;if(o)if("link"===l){const n=document.createElement("a");n.className=`btn ${s}`.trim(),n.textContent=Now.translate(r),n.href="#",n.target=c,n.dataset.action=a,n.addEventListener("click",async n=>{var r;if(n.preventDefault(),d){if(!(await(null==(r=null==DialogManager?void 0:DialogManager.confirm)?void 0:r.call(DialogManager,Now.translate(d),Now.translate("Confirm")))))return}const l=this.getFilterParams(e),s=new URLSearchParams(l).toString(),i=o.includes("?")?`${o}&${s}`:`${o}?${s}`;"_blank"===c?window.open(i,"_blank"):window.location.href=i,EventManager.emit("table:filterAction",{tableId:t,action:a,type:"link",url:i,params:l})}),e.actionWrapper.appendChild(n)}else{const n=document.createElement("button");n.type="button",n.className=`btn ${s}`.trim(),n.textContent=Now.translate(r),n.dataset.action=a,n.addEventListener("click",async r=>{var l,s,i,c;if(r.preventDefault(),d){if(!(await(null==(l=null==DialogManager?void 0:DialogManager.confirm)?void 0:l.call(DialogManager,Now.translate(d),Now.translate("Confirm")))))return}n.classList.add("loading");try{const r=this.getFilterParams(e),l=this.getSortParams(e),c={action:a,tableId:t,filters:r,sort:l},d=await window.http.post(o,c);if(403===(null==d?void 0:d.status)){const e=(null==(s=null==d?void 0:d.data)?void 0:s.data)??(null==d?void 0:d.data)??d;return NotificationManager.error((null==e?void 0:e.message)||"Access forbidden"),void n.classList.remove("loading")}if(401===(null==d?void 0:d.status)){console.warn("TableManager: Unauthorized (401) for filter action");const e=new Error(d.statusText||"Unauthorized");return e.status=401,e.response=d,await AuthErrorHandler.handleError(e,{currentPath:window.location.pathname}),void n.classList.remove("loading")}const u=(null==(i=null==d?void 0:d.data)?void 0:i.data)??(null==d?void 0:d.data)??d;await ResponseHandler.process(u,{reload:async()=>this.loadTableData(t)}),EventManager.emit("table:filterAction",{tableId:t,action:a,type:"button",params:r,response:u})}catch(u){console.error("Filter action error:",u),null==(c=null==NotificationManager?void 0:NotificationManager.error)||c.call(NotificationManager,u.message||"Action failed")}finally{n.classList.remove("loading")}}),e.actionWrapper.appendChild(n)}else console.warn(`Filter action "${a}" missing URL`)})},async sendAction(e,t,a,n,r={}){var o,l,s,i,c,d,u,m,h,p,f,g;try{if(!e)throw new Error("Action URL is required");if(!t||"object"!=typeof t)throw new Error("Invalid action data");if(!this.state.tables.get(a))throw new Error(`Table ${a} not found`);const f=n||document.createElement("button");null==(l=(o=f.classList).add)||l.call(o,"loading");const g={...t,tableId:a},w=await window.http.post(e,g);if(403===(null==w?void 0:w.status)){const e=(null==(s=null==w?void 0:w.data)?void 0:s.data)??(null==w?void 0:w.data)??w;return NotificationManager.error((null==e?void 0:e.message)||"Access forbidden"),null==(c=(i=f.classList).remove)||c.call(i,"loading"),EventManager.emit("table:error",{tableId:a,action:t.action,error:{message:(null==e?void 0:e.message)||"Access forbidden",status:403},timestamp:Date.now()}),!1}if(401===(null==w?void 0:w.status)){console.warn("TableManager: Unauthorized (401) for table action");const e=new Error(w.statusText||"Unauthorized");return e.status=401,e.response=w,await AuthErrorHandler.handleError(e,{currentPath:window.location.pathname}),null==(u=(d=f.classList).remove)||u.call(d,"loading"),!1}const y=(null==(m=null==w?void 0:w.data)?void 0:m.data)??(null==w?void 0:w.data)??w;try{r.modalConfig&&y.actions?Array.isArray(y.actions)?y.actions=[...Array.isArray(r.modalConfig)?r.modalConfig:[r.modalConfig],...y.actions]:y.actions={...r.modalConfig,...y.actions}:r.modalConfig&&(y.actions=r.modalConfig),await ResponseHandler.process(y,{...r,data:y,reload:async()=>{await this.loadTableData(a)}})}catch(b){console.error("[TableManager] ResponseHandler error:",b)}const v=!1!==y.success;return EventManager.emit("table:action",{tableId:a,action:t.action,success:v,response:y,timestamp:Date.now()}),null==(p=(h=f.classList).remove)||p.call(h,"loading"),v}catch(b){console.error("Table action error:",b);return null==(g=(f=(n||{classList:{remove:()=>{}}}).classList).remove)||g.call(f,"loading"),window.NotificationManager&&(NotificationManager.clear(),NotificationManager.error(b.message||"An error occurred")),EventManager.emit("table:error",{tableId:a,action:t.action,error:b,timestamp:Date.now()}),!1}},removeTableRows(e,t){(null==e?void 0:e.element)&&(null==t?void 0:t.length)&&t.forEach(t=>{const a=e.element.querySelector(`tr[data-id="${t}"]`);a&&(a.style.transition="opacity 0.3s",a.style.opacity="0",setTimeout(()=>{a.remove(),this.updateTableInfo(e),EventManager.emit("table:rowRemoved",{tableId:e.id,rowId:t})},300))})},updateTableInfo(e){if(0===e.element.querySelectorAll("tbody tr").length){const t=e.element.querySelector("tbody"),a=document.createElement("tr"),n=document.createElement("td");n.colSpan=e.element.querySelectorAll("thead th").length,n.className="empty-table",n.textContent=Now.translate("No data available"),a.appendChild(n),t.appendChild(a)}if(e.config.pagination){const t=parseInt(e.config.params.total)-1;e.config.params.total=t,e.paginationWrapper&&this.updatePagination(e,e.id,t,Math.ceil(t/e.config.params.pageSize))}},setupKeyboardNavigation(e,t){if(!e)return;const a=this.state.tables.get(t);if(!a)return;const handleKeydown=n=>{const r=n.target;if(r.matches("th[data-sort]"))switch(n.key){case"Enter":case" ":n.preventDefault(),this.handleSort(a,t,r);break;case"ArrowLeft":case"ArrowRight":n.preventDefault(),this.navigateHeaders(e,r,"ArrowRight"===n.key)}if(r.matches("tbody tr")){const t=Array.from(e.querySelectorAll("tbody tr")),a=t.indexOf(r);switch(n.key){case"ArrowUp":n.preventDefault(),a>0&&(t[a-1].focus(),this.announceRowChange(e,a-1));break;case"ArrowDown":n.preventDefault(),a<t.length-1&&(t[a+1].focus(),this.announceRowChange(e,a+1));break;case"Home":n.preventDefault(),t[0].focus(),this.announceRowChange(e,0);break;case"End":n.preventDefault(),t[t.length-1].focus(),this.announceRowChange(e,t.length-1)}}};e.addEventListener("keydown",handleKeydown),e.eventHandlers||(e.eventHandlers={}),e.eventHandlers.keyboard=handleKeydown},navigateHeaders(e,t,a){const n=Array.from(e.querySelectorAll("th[data-sort]")),r=n.indexOf(t);let o;o=a?r<n.length-1?r+1:0:r>0?r-1:n.length-1,n[o].focus()},announceRowChange(e,t){const a=document.getElementById(e.dataset.announcer);if(a){const n=e.querySelectorAll("tbody tr")[t].querySelector("td");a.textContent=Now.translate("Row")+` ${t+1}: ${(null==n?void 0:n.textContent)||""}`}},async loadData(e,t,a={}){var n;const r=this.state.tables.get(e);if(r&&!r.isLoading){r.isLoading=!0;try{this.showLoading(r);const o=`${t}?${new URLSearchParams({...r.config.params,...this.getSortParams(r),...this.getPaginationParams(r),...a})}`,l=await http.get(o,{headers:{Accept:"application/json"}}),s=(null==l?void 0:l.data)||l;this.setData(e,s.data),(null==(n=s.meta)?void 0:n.total)&&this.updatePagination(r,e,s.meta)}catch(o){return this.handleError("Error loading table data",o,"loadData")}finally{r.isLoading=!1}}},showLoading(e){e.element.querySelector("tbody").innerHTML=`<tr><td colspan="100%" class="center">${Now.translate("Loading")}...</td></tr>`},updateSelectedRows(e){const t=e.querySelectorAll(".select-all"),a=[];return t.forEach((e,t)=>{const n=e.closest("tr");e.checked?(a.push({index:t,row:n,data:this.getRowData(n)}),n.classList.add("selected-row")):n.classList.remove("selected-row")}),this.updateSelectedCount(e,a.length),this.onSelectionChange&&this.onSelectionChange(a),a},getRowData(e){const t=e.querySelectorAll("td");return Array.from(t).map(e=>e.textContent.trim())},parseRowActions(e){if(!e)return null;if("object"==typeof e)return e;try{if(/^[\s]*\{/.test(e)||/^[\s]*\[/.test(e))return JSON.parse(e)}catch(t){}return e.split(",").map(e=>e.trim()).reduce((e,t)=>(e[t]=t.charAt(0).toUpperCase()+t.slice(1),e),{})},createActionCell(e,t,a,n){const r=document.createElement("td");r.className="row-actions-cell";const o=document.createElement("div");o.className="btn-group";const l=e.element.dataset.actionUrl||e.config.actionUrl,s=Now.getManager("element");return Object.entries(n).forEach(([e,n])=>{let r=(n="string"==typeof n?{label:n}:n||{}).label||e;if(n&&"object"==typeof n&&n.submenu){const i=document.createElement("div");i.className="action-dropdown";const c=document.createElement("button");c.type="button",c.className=n.className||`action-btn action-${e}`,c.textContent=r,i.appendChild(c);const d=document.createElement("div");d.className="action-submenu",Object.entries(n.submenu).forEach(([e,n])=>{const r="string"==typeof n?{label:n}:n||{};let o;s&&r.element?o=s.create(r.element,{id:r.id||`row_action_${e}_${a.id||""}`,type:r.type||"button",value:Now.translate(r.label||e),className:r.className||`action-sub action-${e}`,wrapper:null,attrs:r.attrs||{}}).element:(o=document.createElement("button"),o.type="button",o.className=r.className||`action-sub action-${e}`,o.textContent=r.label||e),o.addEventListener("click",n=>{n.preventDefault(),this._executeRowAction(t,l,a,e,r)}),d.appendChild(o)}),i.appendChild(d),o.appendChild(i)}else{let i;if(s&&(n.element||n.className||n.attrs)){const t={id:n.id||`row_action_${e}_${a.id||""}`,type:n.type||"button",value:Now.translate(n.label||e),className:n.className||`action-btn action-${e}`,wrapper:null,attrs:n.attrs||{}};i=s.create(n.element||"button",t).element}else i=document.createElement("button"),i.type="button",i.className=n.className||`action-btn action-${e}`,i.textContent=r;i.addEventListener("click",r=>{r.preventDefault(),this._executeRowAction(t,l,a,e,n)}),o.appendChild(i)}}),r.appendChild(o),r},async _executeRowAction(e,t,a,n,r=null){const o=this.state.tables.get(e);if(!o)return;const l=r&&r.modal?r.modal:null;try{let e=null;if(r&&r.confirm?e="string"==typeof r.confirm?r.confirm:Now.translate("Are you sure you want to perform this action?"):"delete"===n&&!1!==o.config.confirmDelete&&(e=Now.translate("Are you sure you want to delete this item?")),e){let t=!1;if(window.DialogManager&&"function"==typeof DialogManager.confirm)try{t=await DialogManager.confirm(e,Now.translate("Confirm"))}catch(c){t=!1}else if(window.Modal)try{const a=new Modal({title:Now.translate("Confirm"),content:`<div class="confirm-body">${e}</div><div style="margin-top:1rem;text-align:right"><button class="modal-cancel">${Now.translate("Cancel")}</button> <button class="modal-confirm primary">${Now.translate("Confirm")}</button></div>`,width:"420px",backdrop:!0});a.show(),t=await new Promise(e=>{const listener=t=>{t.target.classList.contains("modal-confirm")?(cleanup(),e(!0)):t.target.classList.contains("modal-cancel")&&(cleanup(),e(!1))};function cleanup(){try{a.hide()}catch(c){}setTimeout(()=>{var e;try{null==(e=a.modal)||e.remove()}catch(t){}},300),document.removeEventListener("click",listener)}document.addEventListener("click",listener)})}catch(c){console.error("Modal confirm error",c),t=!1}else t=confirm(e);if(!t)return}}catch(c){return void console.error("Confirmation error:",c)}let s={action:n,id:a.id,row:a};if(r&&r.params&&"object"==typeof r.params){const interpolate=e=>"string"!=typeof e?e:e.replace(/\{([^}]+)\}/g,(e,t)=>{const n=t.split(".");let r=a;for(let a of n){if(null==r)return"";r=r[a]}return null!=r?r:""}),e={};Object.entries(r.params).forEach(([t,a])=>{e[t]="object"==typeof a?JSON.stringify(a):interpolate(a)}),s={...s,...e}}const i=r&&r.method?r.method.toUpperCase():"POST";if(t){if("GET"===i){const e=new URLSearchParams;Object.entries(s).forEach(([t,a])=>{"object"==typeof a?e.append(t,JSON.stringify(a)):e.append(t,null==a?"":a)});const a=t+(-1===t.indexOf("?")?"?":"&")+e.toString();return void(window.location.href=a)}try{const r=document.createElement("button");r.className="loading",await this.sendAction(t,s,e,r,{modalConfig:l,table:o,row:a,action:n})}catch(c){console.error("Row action error:",c)}}else EventManager.emit("table:rowAction",{tableId:e,action:n,payload:s,row:a})},updateSelectedCount(e,t){var a;const n=null==(a=e.closest(".table-container"))?void 0:a.querySelector(".selected-count");n&&(n.textContent=Now.translate("Selected {count} rows",{count:t}),n.style.display=t>0?"block":"none")},formatValue(e,t,a={}){if(null==e)return a.emptyText||"";if(!t)return e;if("function"==typeof t)return t(e,a);try{switch(t){case"text":return String(e);case"html":return e;case"boolean":return e?a.trueText||"Yes":a.falseText||"No";case"lookup":if(!a)return e;if(Array.isArray(a)){const t=a.find(t=>{if(t&&"object"==typeof t){const a=void 0!==t.value?t.value:t.key;return String(a)===String(e)}return String(t)===String(e)});return t?t.label||t.text||String(t.value||t):e}return a instanceof Map?a.get(e)||e:"object"==typeof a&&void 0!==a[e]?a[e]:e;case"number":return new Intl.NumberFormat(a.locale,{minimumFractionDigits:a.decimals||0,maximumFractionDigits:a.decimals||0,useGrouping:!1!==a.useGrouping}).format(e);case"currency":return Utils.number.currency(e,a.currency||null,a.locale||"en-US");case"percent":return new Intl.NumberFormat(a.locale,{style:"percent",minimumFractionDigits:a.decimals||0,maximumFractionDigits:a.decimals||0}).format(e/(a.base||100));case"date":return Utils.date.format(e,a.pattern||"D MMM YYYY");case"time":return Utils.date.format(e,a.pattern||"HH:mm");case"datetime":return Utils.date.format(e,a.pattern||"D MMM YYYY HH:mm");case"bytes":return Utils.number.fileSize(e);case"duration":const n=Number(e);if(isNaN(n))return e;const r=Math.floor(n/3600),o=Math.floor(n%3600/60),l=Math.floor(n%60),s=[];return r>0&&s.push(`${r}${a.hourLabel||"h"}`),(o>0||r>0)&&s.push(`${o}${a.minuteLabel||"m"}`),s.push(`${l}${a.secondLabel||"s"}`),s.join(" ");case"humanize":return Utils.string.humanize(e);case"truncate":return Utils.string.truncate(String(e),a.length||50,a.end||"...");default:return window.formatters&&"function"==typeof window.formatters[t]?window.formatters[t](e,a):e}}catch(n){return console.warn("Format error:",n),e}},getSortParams(e){const t={};if(e.sortState&&Object.keys(e.sortState).length>0){const a=Object.entries(e.sortState).map(([e,t])=>`${e} ${t}`);a.length>0&&(t.sort=a.join(","))}return t},getPaginationParams(e){const t={};return e.config.params.page&&(t.page=e.config.params.page),e.config.params.pageSize&&(t.pageSize=e.config.params.pageSize),e.config.params.search&&(t.search=e.config.params.search),t},getFilterParams(e){const t={},a=["page","pageSize","search","total","totalPages"];return Object.keys(e.config.params).forEach(n=>{if(!a.includes(n)){const a=e.config.params[n];null!=a&&""!==a&&(t[n]=a)}}),t},async exportData(e,t="csv",a={}){const n=this.state.tables.get(e);if(!n)return this.handleError("Table not found for export",null,"exportData");t=(t||"csv").toLowerCase();const r=n.element.dataset.exportUrl||n.element.dataset.export||n.config.exportUrl;if(n.serverSide&&r)try{const o=new URLSearchParams({...n.config.params,format:t}),l=-1===r.indexOf("?")?`${r}?${o}`:`${r}&${o}`,s=await http.get(l,{method:"GET"});if((null==s?void 0:s.data)instanceof Blob){const n=s.data,r=s.headers["content-disposition"]||"";let o=a.filename||`${e}.${t}`;const l=r.match(/filename\*=UTF-8''([^;\n\r]+)/i)||r.match(/filename="?([^";\n\r]+)"?/i);return l&&l[1]&&(o=decodeURIComponent(l[1])),this.downloadBlob(n,o),EventManager.emit("table:export",{tableId:e,format:t,success:!0}),!0}if(!window.http||"function"!=typeof window.http.get)throw new Error("HttpClient (window.http) is required but not available");const i=await window.http.get(l,{throwOnError:!1,headers:{Accept:"application/octet-stream"}});if(!i.success)throw new Error("Export request failed");const c=i.data instanceof Blob?i.data:new Blob([i.data]),d=i.headers["content-disposition"]||"";let u=a.filename||`${e}.${t}`;const m=d.match(/filename\*=UTF-8''([^;\n\r]+)/i)||d.match(/filename="?([^";\n\r]+)"?/i);return m&&m[1]&&(u=decodeURIComponent(m[1])),this.downloadBlob(c,u),EventManager.emit("table:export",{tableId:e,format:t,success:!0}),!0}catch(s){return console.error("Export error (server):",s),EventManager.emit("table:export",{tableId:e,format:t,success:!1,error:s}),!1}let o=Array.isArray(n.data)?n.data:[],l=this.filterData(n,o);l=this.sortData(n,l);try{let r=[],o={},s={};try{n.columns&&n.columns.size&&(r=Array.from(n.columns.keys()),n.columns.forEach((e,t)=>{s[t]=e;const a=n.element.querySelector(`th[data-field="${t}"]`);o[t]=a?a.textContent.trim():t}))}catch(i){r=[]}!r.length&&l.length&&(r=Object.keys(l[0]),r.forEach(e=>{o[e]=e,s[e]={}}));const formatExportValue=(e,t)=>{const a=s[t]||{};if(a.format||a.options){return this.formatValue(e,a.format||"lookup",{options:a.options||{},...a})}return e};if("json"===t){const n=l.map(e=>{const t={};return r.forEach(a=>{t[o[a]||a]=formatExportValue(e[a],a)}),t}),s=JSON.stringify(n,null,2),i=new Blob([s],{type:"application/json;charset=utf-8"});return this.downloadBlob(i,a.filename||`${e}.json`),EventManager.emit("table:export",{tableId:e,format:t,success:!0,count:l.length}),!0}const escape=e=>{if(null==e)return"";let t=e;return"object"==typeof t&&(t=JSON.stringify(t)),t=String(t),-1!==t.indexOf('"')&&(t=t.replace(/"/g,'""')),/[",\n\r]/.test(t)&&(t=`"${t}"`),t},c=r.map(e=>escape(o[e]||e)).join(","),d=[c,...l.map(e=>r.map(t=>escape(formatExportValue(e[t],t))).join(","))].join("\r\n"),u=new Blob([d],{type:"text/csv;charset=utf-8"});return this.downloadBlob(u,a.filename||`${e}.csv`),EventManager.emit("table:export",{tableId:e,format:"csv",success:!0,count:l.length}),!0}catch(s){return console.error("Export error (client):",s),EventManager.emit("table:export",{tableId:e,format:t,success:!1,error:s}),!1}},downloadBlob(e,t){try{const a=window.URL.createObjectURL(e),n=document.createElement("a");n.href=a,n.download=t,document.body.appendChild(n),n.click(),setTimeout(()=>{document.body.removeChild(n),window.URL.revokeObjectURL(a)},1e3)}catch(a){console.error("Failed to initiate download:",a)}},resetState(){this.state={initialized:!1,tables:new Map},this.config={}}};(null==(e=window.Now)?void 0:e.registerManager)&&Now.registerManager("table",t),window.TableManager=t}();
//# sourceMappingURL=now.table.min.js.map
