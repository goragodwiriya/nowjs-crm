{"version":3,"file":"now.table.min.js","sources":["../js/TableManager.js"],"sourcesContent":["const TableManager = {\n  config: {\n    urlParams: true, // Enable URL parameter persistence\n    pageSizes: [10, 25, 50, 100],\n    showCaption: true,\n    showCheckbox: false,\n    showFooter: false,\n    footerAggregates: {}, // e.g. {price: 'sum', quantity: 'sum', rating: 'avg'}\n    searchColumns: [],\n    persistColumnWidths: true,\n    rowSortable: false,\n    allowRowModification: false,\n    confirmDelete: true,\n    dynamicColumns: false, // Enable dynamic column generation from API response\n    source: '',\n    method: 'GET', // HTTP method for API calls (GET or POST)\n    actions: {}, // e.g. {delete:\"Delete\",activate:\"Activate\"}\n    actionUrl: '',\n    actionButton: 'Process',\n    rowActions: {}, // e.g. {print:\"Print\",edit:{label:\"Edit\",submenu:{inline:\"Inline Edit\",page:\"Open Editor\"}},delete:\"Delete\"}\n    params: {\n      search: '',\n      pageSize: 0,\n      page: 1,\n    }\n  },\n\n  state: {\n    initialized: false,\n    tables: new Map()\n  },\n\n  async init(options = {}) {\n    if (this.state.initialized) return this;\n\n    this.config = {...this.config, ...options};\n\n    this.setupDynamicTableObserver();\n\n    document.querySelectorAll('table[data-table]').forEach(table => {\n      this.initTable(table);\n    });\n\n    try {\n      EventManager.on('locale:changed', (data) => {\n        this.state.tables.forEach((table, tableId) => {\n          this.retranslateFilter(table);\n          this.renderTable(tableId);\n        });\n      });\n    } catch (e) {\n      // ignore listener setup errors\n    }\n\n    this.state.initialized = true;\n    return this;\n  },\n\n  /**\n   * URL Parameter Management for State Persistence\n   */\n  getUrlParams(tableId) {\n    const table = this.state.tables.get(tableId);\n    const urlParamsEnabled = table?.config?.urlParams !== undefined ? table.config.urlParams : this.config.urlParams;\n\n    if (!urlParamsEnabled) return {};\n\n    // Get URL parameters from current location, supporting both history and hash modes\n    let searchParams = '';\n    const currentUrl = window.location.href;\n\n    if (currentUrl.includes('#')) {\n      // Hash mode: extract query params from hash fragment\n      const hashPart = window.location.hash;\n      const queryIndex = hashPart.indexOf('?');\n      if (queryIndex !== -1) {\n        searchParams = hashPart.substring(queryIndex + 1);\n      }\n    } else {\n      // History mode: use standard search params\n      searchParams = window.location.search.substring(1);\n    }\n\n    const urlParams = new URLSearchParams(searchParams);\n    const params = {};\n\n    // Parse URL parameters (simple format without table prefix)\n    for (const [key, value] of urlParams.entries()) {\n      // Parse numeric parameters\n      if (key === 'page' || key === 'pageSize') {\n        params[key] = parseInt(value) || (key === 'page' ? 1 : 10);\n      }\n      // Handle sort parameter in compact format (e.g., 'name asc,status desc')\n      else if (key === 'sort') {\n        params[key] = value;\n      }\n      // Handle other filter parameters\n      else {\n        params[key] = value;\n      }\n    }\n\n    return params;\n  },\n\n  updateUrlParams(tableId, newParams = {}) {\n    const table = this.state.tables.get(tableId);\n    const urlParamsEnabled = table?.config?.urlParams !== undefined ? table.config.urlParams : this.config.urlParams;\n\n    if (!urlParamsEnabled) return;\n\n    // Get current URL parameters, supporting both history and hash modes\n    let searchParams = '';\n    const currentUrl = window.location.href;\n    const isHashMode = currentUrl.includes('#');\n\n    if (isHashMode) {\n      // Hash mode: extract query params from hash fragment\n      const hashPart = window.location.hash;\n      const queryIndex = hashPart.indexOf('?');\n      if (queryIndex !== -1) {\n        searchParams = hashPart.substring(queryIndex + 1);\n      }\n    } else {\n      // History mode: use standard search params\n      searchParams = window.location.search.substring(1);\n    }\n\n    const urlParams = new URLSearchParams(searchParams);\n\n    // Clear all existing table-related parameters\n    const commonTableParams = ['page', 'pageSize', 'search', 'sort'];\n\n    // Internal parameters that should NOT be synced to URL\n    const internalParams = ['total', 'totalPages', 'totalRecords', 'loading', 'error'];\n\n    // Get all column field names for filtering\n    const columnFields = [];\n    if (table.columns && table.columns.size > 0) {\n      for (const [field] of table.columns) {\n        columnFields.push(field);\n      }\n    }\n\n    // Remove all table-related parameters (but not internal ones - they shouldn't be there anyway)\n    const keysToRemove = [...commonTableParams, ...columnFields];\n    keysToRemove.forEach(key => {\n      // Remove all instances of the key (important for array params like sort[])\n      while (urlParams.has(key)) {\n        urlParams.delete(key);\n      }\n    });\n\n    // Add new parameters (simple format without table prefix)\n    Object.entries(newParams).forEach(([key, value]) => {\n      if (value === undefined || value === null || value === '') return;\n\n      // Skip internal parameters that shouldn't appear in URLs\n      if (internalParams.includes(key)) return;\n\n      if (Array.isArray(value)) {\n        // Handle array parameters (for multi-sort)\n        value.forEach(v => {\n          if (v !== undefined && v !== null && v !== '') {\n            urlParams.append(key, v);\n          }\n        });\n      } else {\n        urlParams.set(key, value);\n      }\n    });\n\n    // Build new URL supporting both modes\n    let newUrl;\n    const queryString = urlParams.toString();\n\n    if (isHashMode) {\n      // Hash mode: put params in hash fragment\n      const hashBase = window.location.hash.split('?')[0] || '#/';\n      newUrl = `${window.location.pathname}${hashBase}${queryString ? '?' + queryString : ''}`;\n    } else {\n      // History mode: standard query params\n      newUrl = `${window.location.pathname}${queryString ? '?' + queryString : ''}${window.location.hash}`;\n    }\n\n    try {\n      window.history.replaceState({}, '', newUrl);\n    } catch (e) {\n      console.warn('Failed to update URL parameters:', e);\n    }\n  },\n\n  syncStateToUrl(tableId) {\n    const table = this.state.tables.get(tableId);\n    if (!table) return;\n\n    // Check if URL params are enabled for this table\n    const urlParamsEnabled = table.config.urlParams !== undefined ? table.config.urlParams : this.config.urlParams;\n    if (!urlParamsEnabled) return;\n\n    // Internal parameters that should NOT be synced to URL\n    const internalParams = ['total', 'totalPages', 'totalRecords', 'loading', 'error'];\n\n    const params = {};\n    // Only include user-facing parameters, exclude internal ones\n    Object.entries(table.config.params).forEach(([key, value]) => {\n      if (!internalParams.includes(key)) {\n        params[key] = value;\n      }\n    });\n\n    // Add sort state in compact format (e.g., 'name asc,status desc')\n    if (table.sortState && Object.keys(table.sortState).length > 0) {\n      const sortPairs = Object.entries(table.sortState).map(([field, direction]) => `${field} ${direction}`);\n\n      if (sortPairs.length > 0) {\n        params.sort = sortPairs.join(',');\n      }\n    }\n\n    // Clean up empty values\n    Object.keys(params).forEach(key => {\n      const value = params[key];\n\n      // Handle regular parameters\n      if (value === '' || value === undefined || value === null) {\n        delete params[key];\n      }\n\n      // Remove default page value\n      if (key === 'page' && value === 1) {\n        delete params[key];\n      }\n    });\n\n    this.updateUrlParams(tableId, params);\n  },\n\n  loadStateFromUrl(tableId) {\n    const urlParams = this.getUrlParams(tableId);\n    const table = this.state.tables.get(tableId);\n    if (!table || Object.keys(urlParams).length === 0) return false;\n\n    // Update table config params\n    Object.keys(urlParams).forEach(key => {\n      if (['sort', 'order'].includes(key)) return; // Handle separately\n      table.config.params[key] = urlParams[key];\n    });\n\n    // Restore sort state from compact format (e.g., 'name asc,status desc')\n    if (urlParams.sort) {\n      table.sortState = {};\n\n      // Parse compact sort format: 'name asc,status desc'\n      const sortPairs = urlParams.sort.split(',').map(pair => pair.trim());\n\n      sortPairs.forEach(pair => {\n        const parts = pair.split(/\\s+/); // Split by whitespace\n        if (parts.length >= 2) {\n          const field = parts[0];\n          const direction = parts[1].toLowerCase();\n\n          if (['asc', 'desc'].includes(direction)) {\n            table.sortState[field] = direction;\n          }\n        } else if (parts.length === 1) {\n          // Default to 'asc' if no direction specified\n          table.sortState[parts[0]] = 'asc';\n        }\n      });\n    }\n\n    return true;\n  },\n\n  restoreFilterUIFromState(tableId) {\n    const table = this.state.tables.get(tableId);\n    if (!table || !table.filterElements) return;\n\n    // Update filter element values to match loaded state\n    Object.entries(table.config.params).forEach(([key, value]) => {\n      const filterElement = table.filterElements.get(key);\n      if (filterElement && filterElement.element && value !== undefined && value !== null && value !== '') {\n        try {\n          const element = filterElement.element;\n\n          // Use the generic setter for external filters or direct assignment for internal\n          if (table.externalFilterForm) {\n            this.setFormElementValue(element, value);\n          } else {\n            // Internal filter elements (ElementManager-created)\n            if (element.type === 'checkbox') {\n              element.checked = !!value;\n            } else {\n              element.value = value;\n            }\n\n            // For select elements, ensure the option exists\n            if (element.tagName === 'SELECT') {\n              const options = Array.from(element.options);\n              const hasOption = options.some(opt => opt.value === String(value));\n              if (hasOption) {\n                element.value = value;\n              }\n            }\n          }\n        } catch (error) {\n          console.warn('Failed to restore filter UI value:', {key, value, error});\n        }\n      }\n    });\n  },\n\n  initTable(table, options = {}) {\n    if (!table) {\n      return this.handleError('Table element is required', null, 'init');\n    }\n\n    const tableId = table.dataset.table;\n    if (!tableId) {\n      return this.handleError('Table ID is required', null, 'init');\n    }\n\n    if (this.state.tables.has(tableId)) {\n      this.handleError('Table already exists', null, 'init');\n      return;\n    }\n\n    try {\n      const config = {\n        ...this.config,\n        ...options,\n        ...this.extractDataAttributes(table, this.config),\n        params: {\n          ...this.config.params,\n          ...this.extractDataAttributes(table, this.config.params)\n        }\n      };\n\n      // data-editable-rows is an alias for allowing row modification (add/delete/drag)\n      if (table.dataset.editableRows === 'true') {\n        config.allowRowModification = true;\n        // Auto-disable caption for editable tables (unless explicitly overridden)\n        // Editable tables typically show all data without pagination, so caption is misleading\n        if (table.dataset.showCaption === undefined) {\n          config.showCaption = false;\n        }\n      }\n\n      // Detect external filter form\n      const externalFilterForm = document.querySelector(`[data-table-filter=\"${tableId}\"]`);\n\n      this.state.tables.set(tableId, {\n        id: tableId,\n        element: table,\n        config,\n        data: [],\n        sortState: {},\n        filterWrapper: null,\n        actionWrapper: null,\n        paginationWrapper: null,\n        filterElements: new Map(),\n        filterData: new Map(),\n        columns: new Map(),\n        filterOptions: new Map(),\n        elementInstances: new Map(),\n        initializing: true, // Flag to prevent redundant renders during setup\n        externalFilterForm: externalFilterForm || null // Store reference to external filter form\n      });\n\n      if (config.source) {\n        this.bindToState(tableId, config.source);\n      }\n\n      this.setupTableStructure(tableId);\n      this.setupAccessibility(table, tableId, config);\n      this.setupEventListeners(tableId);\n\n      // Apply data-default-sort if provided (before URL state is loaded)\n      const tableObj = this.state.tables.get(tableId);\n      if (table.dataset.defaultSort && tableObj) {\n        this.applyDefaultSort(tableObj, table.dataset.defaultSort);\n      }\n\n      // Load state from URL after setup so filter elements exist\n      // URL sort takes precedence over data-default-sort\n      const urlStateLoaded = this.loadStateFromUrl(tableId);\n      if (urlStateLoaded) {\n        // Restore filter UI values from loaded URL state\n        this.restoreFilterUIFromState(tableId);\n      }\n\n      // Load table data once (preventing redundant renders during init)\n      // Only load if not already bound to state\n      try {\n        const tableObj = this.state.tables.get(tableId);\n        const needsDataLoad = !config.source || !config.source.startsWith('state.');\n\n        if (needsDataLoad) {\n          const loadPromise = this.loadTableData(tableId);\n\n          // Handle async completion\n          if (loadPromise && typeof loadPromise.then === 'function') {\n            loadPromise.finally(() => {\n              const currentTableObj = this.state.tables.get(tableId);\n              if (currentTableObj) {\n                currentTableObj.initializing = false;\n                this.renderTable(tableId);\n              }\n            });\n          } else {\n            // Synchronous completion\n            if (tableObj) {\n              tableObj.initializing = false;\n              this.renderTable(tableId);\n            }\n          }\n        } else {\n          // For state-bound tables, just finish initialization\n          if (tableObj) {\n            tableObj.initializing = false;\n          }\n        }\n      } catch (err) {\n        console.warn(`TableManager: failed to load initial data for table ${tableId}:`, err);\n\n        // Ensure initialization completes even on error\n        const tableObj = this.state.tables.get(tableId);\n        if (tableObj) {\n          tableObj.initializing = false;\n          this.renderTable(tableId);\n        }\n      }\n\n      return tableId;\n\n    } catch (error) {\n      return this.handleError('Failed to initialize table', error, 'init');\n    }\n  },\n\n  /**\n   * Apply default sort from data-default-sort attribute\n   * Format: \"field direction\" or \"field1 direction1,field2 direction2\"\n   * Example: \"create_date desc\" or \"status asc,name desc\"\n   */\n  applyDefaultSort(table, sortString) {\n    if (!table || !sortString) return;\n\n    // Parse compact sort format: 'name asc,status desc'\n    const sortPairs = sortString.split(',').map(pair => pair.trim());\n\n    sortPairs.forEach(pair => {\n      const parts = pair.split(/\\s+/); // Split by whitespace\n      if (parts.length >= 2) {\n        const field = parts[0];\n        const direction = parts[1].toLowerCase();\n\n        if (['asc', 'desc'].includes(direction)) {\n          table.sortState[field] = direction;\n\n          // Apply visual indicator to th\n          const th = table.element.querySelector(`th[data-sort=\"${field}\"]`);\n          if (th) {\n            th.classList.remove('sort_asc', 'sort_desc');\n            th.classList.add(direction === 'asc' ? 'sort_asc' : 'sort_desc');\n            th.setAttribute('aria-sort', direction === 'asc' ? 'ascending' : 'descending');\n          }\n        }\n      } else if (parts.length === 1 && parts[0]) {\n        // Default to 'asc' if no direction specified\n        table.sortState[parts[0]] = 'asc';\n\n        const th = table.element.querySelector(`th[data-sort=\"${parts[0]}\"]`);\n        if (th) {\n          th.classList.remove('sort_asc', 'sort_desc');\n          th.classList.add('sort_asc');\n          th.setAttribute('aria-sort', 'ascending');\n        }\n      }\n    });\n\n    // Add sort order indicators for multi-column sort\n    if (Object.keys(table.sortState).length > 1) {\n      Object.keys(table.sortState).forEach((column, index) => {\n        const th = table.element.querySelector(`th[data-sort=\"${column}\"]`);\n        if (th) {\n          let sortOrder = th.querySelector('.sort-order');\n          if (!sortOrder) {\n            sortOrder = document.createElement('span');\n            sortOrder.className = 'sort-order';\n            th.appendChild(sortOrder);\n          }\n          sortOrder.textContent = index + 1;\n          sortOrder.setAttribute('aria-label', `Sort priority ${index + 1}`);\n        }\n      });\n    }\n  },\n\n  extractDataAttributes(element, defaultConfig) {\n    const config = {};\n    Object.keys(element.dataset).forEach(key => {\n      const defaultValue = defaultConfig[key];\n\n      if (defaultValue === undefined) return;\n\n      try {\n        if (Array.isArray(defaultValue)) {\n          config[key] = element.dataset[key].split(',').map(item => item.trim());\n        } else if (typeof defaultValue === 'object' && defaultValue !== null) {\n          config[key] = JSON.parse(element.dataset[key]);\n        } else if (typeof defaultValue === 'boolean') {\n          config[key] = element.dataset[key] === 'true';\n        } else if (typeof defaultValue === 'number') {\n          config[key] = parseInt(element.dataset[key]);\n        } else {\n          config[key] = element.dataset[key];\n        }\n      } catch (error) {\n        console.warn(`Unable to parse value for ${key}:`, error);\n      }\n    });\n    return {...defaultConfig, ...config};\n  },\n\n  setupCheckboxes(table, tableId) {\n    if (!table.config.showCheckbox) return;\n\n    ['thead', 'tfoot'].forEach(section => {\n      const tr = table.element.querySelector(`${section} tr:first-child`);\n      if (tr) {\n        let checkboxId = `select-all-${tableId}-${section}`;\n        let checkbox = tr.querySelector('.select-all');\n        if (!checkbox) {\n          const label = document.createElement('label');\n          label.htmlFor = checkboxId;\n\n          checkbox = document.createElement('input');\n          checkbox.type = 'checkbox';\n\n          const cell = document.createElement(section === 'thead' ? 'th' : 'td');\n          const rowspan = table.element.querySelectorAll(`${section} tr:first-child`).length;\n          if (rowspan > 1) {\n            cell.setAttribute('rowspan', rowspan);\n          }\n          cell.className = 'check-column';\n\n          label.appendChild(checkbox);\n          cell.appendChild(label);\n          tr.insertBefore(cell, tr.firstChild);\n        } else {\n          if (checkbox.id) {\n            checkboxId = checkbox.id;\n          }\n          const label = checkbox.closest('label');\n          if (label) {\n            label.htmlFor = checkboxId;\n          }\n          checkbox.closest('th, td').classList.add('check-column');\n        }\n        checkbox.className = 'select-all';\n        checkbox.id = checkboxId;\n        checkbox.setAttribute('aria-label', Now.translate('Select all'));\n\n        // Remove old event listener if exists to prevent duplicate handlers\n        const oldHandler = checkbox._selectAllHandler;\n        if (oldHandler) {\n          checkbox.removeEventListener('change', oldHandler);\n        }\n\n        // Create and store new handler\n        const newHandler = (e) => {\n          this.handleSelectAll(table, tableId, e.target.checked);\n        };\n        checkbox._selectAllHandler = newHandler;\n        checkbox.addEventListener('change', newHandler);\n      }\n    });\n  },\n\n  handleSelectAll(table, tableId, checked) {\n    if (!table?.element) return;\n\n    const checkboxes = table.element.querySelectorAll('tbody .select-row');\n    checkboxes.forEach(cb => {\n      cb.checked = checked;\n    });\n\n    const allCheckboxes = table.element.querySelectorAll('.select-all');\n    allCheckboxes.forEach(cb => {\n      cb.checked = checked;\n    });\n\n    this.handleRowSelection(table, tableId);\n  },\n\n  handleRowSelection(table, tableId) {\n    const checkboxes = table.element.querySelectorAll('tbody .select-row');\n    const checkedBoxes = table.element.querySelectorAll('tbody .select-row:checked');\n\n    const allChecked = checkboxes.length > 0 && checkboxes.length === checkedBoxes.length;\n    const someChecked = checkedBoxes.length > 0 && checkedBoxes.length < checkboxes.length;\n\n    const allCheckboxes = table.element.querySelectorAll('.select-all');\n    allCheckboxes.forEach(cb => {\n      cb.checked = allChecked;\n      cb.indeterminate = someChecked;\n    });\n\n    table.selectedRows = Array.from(checkedBoxes).map(cb => cb.value);\n\n    if (table.config.onSelectionChange) {\n      table.config.onSelectionChange(table.selectedRows);\n    }\n\n    EventManager.emit('table:selectionChange', {\n      tableId: tableId,\n      selectedRows: table.selectedRows\n    });\n  },\n\n  clearSelection(table, tableId, options = {}) {\n    if (!table?.element || !table.config.showCheckbox) return;\n\n    const {emit = true} = options;\n\n    const rowCheckboxes = table.element.querySelectorAll('tbody .select-row');\n    rowCheckboxes.forEach(cb => {\n      cb.checked = false;\n      cb.closest('tr')?.classList.remove('selected-row');\n    });\n\n    const masterCheckboxes = table.element.querySelectorAll('.select-all');\n    masterCheckboxes.forEach(cb => {\n      cb.checked = false;\n      cb.indeterminate = false;\n    });\n\n    const hadSelection = Array.isArray(table.selectedRows) && table.selectedRows.length > 0;\n    table.selectedRows = [];\n\n    if (table.actionElements?.submit?.element) {\n      table.actionElements.submit.element.disabled = true;\n    }\n\n    if (typeof this.updateSelectedCount === 'function') {\n      this.updateSelectedCount(table.element, 0);\n    }\n\n    if (emit && hadSelection) {\n      if (typeof table.config.onSelectionChange === 'function') {\n        table.config.onSelectionChange([]);\n      }\n\n      EventManager.emit('table:selectionChange', {\n        tableId,\n        selectedRows: []\n      });\n    }\n  },\n\n  setupTableStructure(tableId) {\n    const table = this.state.tables.get(tableId);\n    if (!table) return;\n\n    const {element: tableEl, config} = table;\n    const thead = tableEl.querySelector('thead');\n\n    // Create tfoot if showFooter is enabled and tfoot doesn't exist\n    let tfoot = tableEl.querySelector('tfoot');\n    if (config.showFooter && !tfoot) {\n      tfoot = document.createElement('tfoot');\n      tableEl.appendChild(tfoot);\n\n      // Create a default footer row matching thead structure\n      if (thead) {\n        const tr = document.createElement('tr');\n        const thCount = thead.querySelector('tr')?.querySelectorAll('th').length || 0;\n\n        for (let i = 0; i < thCount; i++) {\n          const td = document.createElement('td');\n          tr.appendChild(td);\n        }\n\n        tfoot.appendChild(tr);\n      }\n    }\n\n    if (thead) {\n      thead.querySelectorAll('th[data-sort]').forEach(th => {\n        th.classList.add('sortable');\n        th.setAttribute('role', 'columnheader');\n        th.setAttribute('tabindex', '0');\n      });\n\n      // If row modification is enabled, ensure header has an actions column\n      if (config.allowRowModification) {\n        thead.querySelectorAll('tr').forEach(tr => {\n          if (tr.querySelector('th.icons')) return;\n          const th = document.createElement('th');\n          th.className = 'icons';\n          tr.appendChild(th);\n        });\n\n        if (tfoot) {\n          tfoot.querySelectorAll('tr').forEach(tr => {\n            if (tr.querySelector('td.icons')) return;\n            const td = document.createElement('td');\n            td.className = 'icons';\n            tr.appendChild(td);\n          });\n        }\n      }\n\n      const rowActionsRaw = tableEl.dataset.rowActions || tableEl.dataset.rowActionsJson;\n      if (rowActionsRaw) {\n        const actionLabel = tableEl.dataset.rowActionsLabel || 'Actions';\n        thead.querySelectorAll('tr').forEach(tr => {\n          if (tr.querySelector('th.row-actions')) return;\n          const th = document.createElement('th');\n          th.className = 'row-actions';\n          th.textContent = actionLabel;\n          th.dataset.i18n = actionLabel;\n          tr.appendChild(th);\n        });\n\n        if (tfoot) {\n          tfoot.querySelectorAll('tr').forEach(tr => {\n            if (tr.querySelector('td.row-actions')) return;\n            const td = document.createElement('td');\n            td.className = 'row-actions';\n            tr.appendChild(td);\n          });\n        }\n      }\n    }\n\n    // Create filter wrapper only if no external form exists\n    if (!table.externalFilterForm) {\n      table.filterWrapper = document.createElement('div');\n      table.filterWrapper.className = 'table_nav';\n      tableEl.parentNode.insertBefore(table.filterWrapper, tableEl);\n    } else {\n      // Use external form as filter wrapper\n      table.filterWrapper = table.externalFilterForm;\n    }\n\n    table.actionWrapper = document.createElement('div');\n    table.actionWrapper.className = 'table_nav';\n    tableEl.parentNode.appendChild(table.actionWrapper);\n\n    table.paginationWrapper = document.createElement('div');\n    table.paginationWrapper.className = 'splitpage';\n    tableEl.parentNode.appendChild(table.paginationWrapper);\n\n    // Setup filters (always run to read column definitions). When an external\n    // filter form exists, setupFilter will skip building UI but still parse\n    // <th> attributes, defaults, and derived filters. External form wiring is\n    // handled separately.\n    this.setupFilter(table, tableId);\n    if (table.externalFilterForm) {\n      this.setupExternalFilter(table, tableId);\n    }\n    this.setupFooter(table);\n    this.setupCheckboxes(table, tableId);\n    this.setupActions(table, tableId);\n    if (config?.pageSize > 0) {\n      this.setupPagination(table, tableId);\n    }\n  },\n\n  setupEventListeners(tableId) {\n    const table = this.state.tables.get(tableId);\n    if (!table) return;\n\n    const {element: tableEl, config} = table;\n\n    // Setup handler registry used by delegation and sort setup\n    const handlers = {\n      sort: new Map(),\n      filter: new Map(),\n      keyboard: null\n    };\n\n    // ensure table.eventHandlers exists for delegation code to append into\n    if (!table.eventHandlers) table.eventHandlers = {};\n\n    if (config.touchEnabled) {\n      this.setupTouchEvents(table);\n    }\n\n    // Delegated event handlers on tbody to avoid per-element listeners\n    try {\n      const tbody = table.element.querySelector('tbody');\n      if (tbody) {\n        const delegatedClick = (e) => this._handleDelegatedClick(e, tableId);\n        const delegatedChange = (e) => this._handleDelegatedChange(e, tableId);\n\n        tbody.addEventListener('click', delegatedClick);\n        tbody.addEventListener('change', delegatedChange);\n\n        // store references for cleanup\n        table.eventHandlers.delegation = {\n          click: delegatedClick,\n          change: delegatedChange\n        };\n      }\n\n      // delegate filter controls (pageSize, selects, search) from filterWrapper\n      if (table.filterWrapper) {\n        const fwChange = (e) => {\n          // rely on existing data-field or element ids from elementFactory\n          const target = e.target;\n          if (!target) return;\n          // pageSize handled by attribute 'pageSize' name or element id starting with pageSize_\n          const id = target.id || '';\n          if (id.startsWith(`pageSize_${tableId}`) || target.dataset.field === 'pageSize') {\n            const value = parseInt(target.value);\n            this.handleFilterChange(table, tableId, 'pageSize', value, target);\n            return;\n          }\n\n          // generic field-based filters\n          const field = target.dataset.name || target.dataset.field || target.name;\n          if (field) {\n            const value = (target.type === 'checkbox') ? target.checked : target.value;\n            this.handleFilterChange(table, tableId, field, value, target);\n          }\n        };\n\n        table.filterWrapper.addEventListener('change', fwChange);\n        table.eventHandlers.filterWrapperChange = fwChange;\n      }\n    } catch (err) {\n      console.warn('Delegation setup failed', err);\n    }\n\n    // Setup column resizing if enabled\n    this.setupColumnResizing(tableId);\n\n    // Hook up actionWrapper button behavior (only button triggers action)\n    if (table.actionWrapper && table.actionElements && table.actionElements.submit && table.actionElements.select) {\n      const submitBtn = table.actionElements.submit.element;\n      const selectEl = table.actionElements.select.element;\n      if (submitBtn) {\n        const onActionButtonClick = async (e) => {\n          e.preventDefault();\n\n          // Validate action selection first\n          if (!selectEl.value || selectEl.value === '') {\n            NotificationManager.warning('Please select an action');\n            return;\n          }\n\n          // Validate row selection\n          const selectedCount = this.getSelectedRowIds(table)?.length || 0;\n          if (selectedCount === 0) {\n            NotificationManager.warning('Please select at least one row');\n            return;\n          }\n\n          // Show confirmation dialog with action name\n          const message = Now.translate('You want to {action} the selected items ?', {action: selectEl.options[selectEl.selectedIndex].textContent});\n          const confirmed = await DialogManager.confirm(message);\n          if (confirmed) {\n            this._performActionWrapperSubmission(tableId);\n          }\n        };\n        submitBtn.addEventListener('click', onActionButtonClick);\n\n        // store for cleanup\n        table.eventHandlers.actionButton = onActionButtonClick;\n      }\n    }\n\n\n    tableEl.querySelectorAll('thead th[data-sort]').forEach(th => {\n      const sortHandler = (e) => {\n        e.preventDefault();\n        e.stopPropagation();\n        // Prevent text selection when Shift+clicking\n        if (e.shiftKey) {\n          window.getSelection()?.removeAllRanges();\n        }\n        this.handleSort(table, tableId, th, e);\n      };\n\n      const keyHandler = (e) => {\n        if (e.key === 'Enter' || e.key === ' ') {\n          e.preventDefault();\n          this.handleSort(table, tableId, th, e);\n        }\n      };\n\n      th.addEventListener('click', sortHandler);\n      th.addEventListener('keydown', keyHandler);\n\n      handlers.sort.set(th, {\n        sort: sortHandler,\n        key: keyHandler\n      });\n\n      th.setAttribute('role', 'columnheader');\n      th.setAttribute('tabindex', '0');\n      th.setAttribute('aria-sort', 'none');\n    });\n\n    // finalize event handler registry\n    table.eventHandlers = handlers;\n  },\n\n  cleanupFilterEvents(table) {\n    if (!table.filterElements) return;\n\n    table.filterElements.forEach((element, elementId) => {\n      if (elementId) {\n        ElementManager.destroy(elementId);\n      }\n    });\n\n    table.filterElements.clear();\n  },\n\n  handleSort(table, tableId, th, event = null) {\n    if (!table || !tableId || !(th instanceof HTMLElement)) {\n      throw new Error('Invalid parameters');\n    }\n\n    const {config} = table;\n    const column = th.dataset.sort;\n\n    const currentSort = table.sortState[column] || 'none';\n\n    const newSort = currentSort === 'asc' ? 'desc' :\n      currentSort === 'desc' ? 'none' : 'asc';\n\n    // Check if multi-sort is enabled (either via config or Shift key)\n    const isMultiSort = config.multiSort || (event && event.shiftKey);\n\n    if (!isMultiSort) {\n      // Single sort: clear other columns\n      Object.keys(table.sortState).forEach(key => {\n        if (key !== column) {\n          delete table.sortState[key];\n          const otherTh = table.element.querySelector(`th[data-sort=\"${key}\"]`);\n          if (otherTh) {\n            otherTh.classList.remove('sort_asc', 'sort_desc');\n            otherTh.setAttribute('aria-sort', 'none');\n          }\n        }\n      });\n    }\n\n    if (newSort === 'none') {\n      delete table.sortState[column];\n      th.classList.remove('sort_asc', 'sort_desc');\n      th.setAttribute('aria-sort', 'none');\n      // Remove sort order indicator\n      const sortOrder = th.querySelector('.sort-order');\n      if (sortOrder) sortOrder.remove();\n    } else {\n      table.sortState[column] = newSort;\n      th.classList.remove('sort_asc', 'sort_desc');\n      th.classList.add(newSort === 'asc' ? 'sort_asc' : 'sort_desc');\n      th.setAttribute('aria-sort', newSort === 'asc' ? 'ascending' : 'descending');\n\n      // Add sort order indicator for multi-column sort\n      if (isMultiSort && Object.keys(table.sortState).length > 1) {\n        const sortIndex = Object.keys(table.sortState).indexOf(column) + 1;\n        let sortOrder = th.querySelector('.sort-order');\n        if (!sortOrder) {\n          sortOrder = document.createElement('span');\n          sortOrder.className = 'sort-order';\n          th.appendChild(sortOrder);\n        }\n        sortOrder.textContent = sortIndex;\n        sortOrder.setAttribute('aria-label', `Sort priority ${sortIndex}`);\n      } else {\n        // Remove sort order indicator for single sort\n        const sortOrder = th.querySelector('.sort-order');\n        if (sortOrder) sortOrder.remove();\n      }\n    }\n\n    this.syncStateToUrl(tableId);\n\n    this.clearSelection(table, tableId);\n\n    // If table source is remote (api/... or http), reload from API with sort params\n    const source = table.element.dataset.source || table.config.source || '';\n    if (source && (source.startsWith('api/') || source.startsWith('http'))) {\n      // Reset to page 1 when sorting changes\n      table.config.params.page = 1;\n\n      // Reload data from API using current sort and filter params\n      this.loadFromApi(table, tableId, source).catch(err => {\n        console.error('Sort load error', err);\n        // On error, still render with client-side sort\n        this.renderTable(tableId);\n      });\n      return;\n    }\n\n    // Local data: re-render using client-side sorting\n    this.renderTable(tableId);\n  },\n\n  handleFieldChange(table, tableId, field, value, rowData, element, options = {send: true}) {\n    try {\n      if (options.send !== false) {\n        if (rowData && typeof rowData === 'object') {\n          try {rowData[field] = value;} catch (e) { /* ignore */}\n        }\n      }\n\n      // If there's no action URL, or caller asked not to send, just update the local data\n      const actionUrl = table?.element?.dataset?.actionUrl || table?.config?.actionUrl;\n      if (!actionUrl || options.send === false) {\n        // Emit event for local handling\n        EventManager.emit('table:fieldChange', {\n          tableId,\n          field,\n          value,\n          rowData,\n          element\n        });\n        return;\n      }\n\n      // Prepare data for server update\n      const data = {\n        action: 'update',\n        field,\n        ids: [rowData?.id],\n        value\n      };\n\n      // Add loading state (guarding for missing element)\n      const submitEl = (element && element.classList) ? element : (table?.element || null);\n      if (submitEl && submitEl.classList) {\n        submitEl.classList.add('loading');\n      }\n\n      // Send the update to the server\n      this.sendAction(actionUrl, data, tableId, submitEl)\n        .then(success => {\n          if (success) {\n            // Highlight success if element present\n            if (element && element.classList) {\n              element.classList.add('update-success');\n              setTimeout(() => {\n                if (element && element.classList) element.classList.remove('update-success');\n              }, 1000);\n            }\n          } else {\n            // Revert changes on error\n            this.renderTable(tableId);\n          }\n        })\n        .catch(error => {\n          console.error('Field update error:', error);\n          // Revert changes on error\n          this.renderTable(tableId);\n        })\n        .finally(() => {\n          // Remove loading state (guarded)\n          if (submitEl && submitEl.classList) {\n            submitEl.classList.remove('loading');\n          }\n          if (element && element.wrapper && element.wrapper.classList) {\n            element.wrapper.classList.remove('loading');\n          }\n        });\n    } catch (error) {\n      this.handleError('Error updating field', error, 'handleFieldChange');\n\n      // Remove loading state\n      if (element) {\n        element.classList.remove('loading');\n        if (element.wrapper) {\n          element.wrapper.classList.remove('loading');\n        }\n      }\n    }\n  },\n\n  setupFilter(table, tableId) {\n    if (!table?.filterWrapper) return;\n\n    const isExternalFilter = !!table.externalFilterForm;\n\n    // For external filters, do NOT clear or rebuild the form UI. We still need\n    // column metadata from <th>. For internal filters, clear and rebuild UI.\n    if (isExternalFilter) {\n      table.filterElements = table.filterElements || new Map();\n      table.filterData = table.filterData || new Map();\n    } else {\n      table.filterWrapper.innerHTML = '';\n      table.filterElements = new Map();\n      table.filterData = new Map();\n    }\n\n    const {config} = table;\n    const elementManager = Now.getManager('element');\n    if (!elementManager && !isExternalFilter) return;\n\n    // Create a debounced filter change handler\n    const debouncedFilterChange = Utils.function.debounce((table, tableId, key, value, element) => {\n      this.handleFilterChange(table, tableId, key, value, element);\n    }, 300);\n\n    // Add page size selector if configured (internal UI only)\n    if (!isExternalFilter && config.params.pageSize > 0 && Array.isArray(config.pageSizes) && config.pageSizes.length > 0) {\n      const pageSizeOptions = {};\n      config.pageSizes.forEach(size => {\n        pageSizeOptions[size] = `${size} {LNG_entries}`;\n      });\n\n      const select = elementManager.create('select', {\n        id: `pageSize_${tableId}`,\n        options: pageSizeOptions,\n        value: config.params.pageSize,\n        label: 'Show',\n        wrapper: 'div',\n        onChange: (element, value) => {\n          debouncedFilterChange(table, tableId, 'pageSize', parseInt(value), element);\n        }\n      });\n\n      if (select?.element) {\n        table.filterWrapper.appendChild(select.wrapper);\n        table.filterElements.set('pageSize', select);\n        table.filterData.set('pageSize', select);\n      }\n    }\n\n    // Get column definitions for filter setup\n    table.columns = this.getColumnDefinitions(table);\n\n    // Add column-specific filters\n    table.columns.forEach((attributes, field) => {\n      if (!attributes.filter) return;\n\n      // Set initial filter value if defined\n      if (attributes.value !== '') {\n        config.params[field] = attributes.value;\n      }\n\n      // Persist options for later use (e.g., formatting/lookup)\n      if (attributes.options) {\n        if (!table.filterOptions) table.filterOptions = new Map();\n        table.filterOptions.set(field, attributes.options);\n      }\n\n      // External form: skip UI creation, just keep metadata/defaults\n      if (isExternalFilter) {\n        return;\n      }\n\n      // Configure element based on column attributes\n      let elementConfig = {\n        id: `filter_${field}_${tableId}`,\n        name: field,\n        label: attributes.label || field,\n        placeholder: attributes.placeholder,\n        value: config.params[field] || attributes.value || '',\n        // Prepare options - if showAll is enabled, ensure an \"All\" option is present at the start\n        options: (() => {\n          const opts = attributes.options || {};\n          if (attributes.showAll) {\n            const allValue = attributes.allValue !== undefined ? attributes.allValue : '';\n            const allLabel = attributes.allLabel || 'All';\n\n            if (Array.isArray(opts)) {\n              // Assume array of {value,text} or similar - insert at front\n              return [{value: allValue, text: allLabel}, ...opts];\n            }\n\n            if (opts && typeof opts === 'object') {\n              // Create a new object with the all option first (object property order preserved in most engines)\n              return Object.assign({[allValue]: allLabel}, opts);\n            }\n\n            // Fallback: return as-is\n            return opts;\n          }\n          return opts;\n        })(),\n        datalist: attributes.datalist || null,\n        autocomplete: attributes.autocomplete || null,\n        wrapper: 'div',\n        wrapperClass: 'filter-control',\n        onChange: (element, value) => {\n          debouncedFilterChange(table, tableId, field, value, element);\n        }\n      };\n\n      const elementObj = elementManager.create(attributes.type, elementConfig);\n\n      if (elementObj?.element) {\n        table.filterWrapper.appendChild(elementObj.wrapper);\n        table.filterElements.set(field, elementObj);\n        table.filterData.set(field, elementObj);\n      }\n    });\n\n    // Add search box if search columns defined (internal UI only)\n    if (!isExternalFilter && config.searchColumns?.length > 0) {\n      const search = elementManager.create('search', {\n        id: `search_${tableId}`,\n        itemClass: 'search',\n        value: config.params.search || '',\n        placeholder: `${Now.translate('Search in')}: ${config.searchColumns.join(', ')}`,\n        minLength: 2,\n        onChange: (element, value) => {\n          debouncedFilterChange(table, tableId, 'search', value, element);\n        }\n      });\n\n      if (search?.element) {\n        table.filterWrapper.appendChild(search.wrapper || search.element);\n        table.filterElements.set('search', search);\n        table.filterData.set('search', search);\n      }\n    }\n\n    // If data arrived before filter setup and derived filters were stored, apply them now\n    if (table.pendingDerivedFilters && Object.keys(table.pendingDerivedFilters).length) {\n      try {\n        this.setFilters(tableId, table.pendingDerivedFilters);\n      } catch (err) {\n        console.warn('Failed to apply pending derived filters:', err);\n      }\n      // clear pending\n      table.pendingDerivedFilters = null;\n    }\n  },\n\n  /**\n   * Setup external filter form (when data-table-filter attribute exists)\n   * @param {Object} table - Table instance object\n   * @param {string} tableId - Table identifier\n   */\n  setupExternalFilter(table, tableId) {\n    if (!table?.externalFilterForm) return;\n\n    const form = table.externalFilterForm;\n    const {config} = table;\n\n    // Clear existing filter elements/data\n    table.filterElements = new Map();\n    table.filterData = new Map();\n\n    // Store cleanup function for later\n    if (!table._externalFilterCleanup) {\n      table._externalFilterCleanup = [];\n    }\n\n    // Prevent default form submission\n    const submitHandler = (e) => {\n      e.preventDefault();\n      e.stopPropagation();\n\n      // Collect all form data and trigger reload\n      this.handleExternalFilterSubmit(table, tableId);\n    };\n    form.addEventListener('submit', submitHandler);\n    table._externalFilterCleanup.push(() => form.removeEventListener('submit', submitHandler));\n\n    // Find all form elements and register them\n    const formElements = form.querySelectorAll('input, select, textarea');\n\n    formElements.forEach(element => {\n      const name = element.name || element.id;\n      if (!name) return;\n\n      // Store reference to the raw element\n      table.filterElements.set(name, {element});\n\n      // Initialize config params if not set\n      if (config.params[name] === undefined) {\n        const value = this.getFormElementValue(element);\n        if (value !== '' && value !== null && value !== undefined) {\n          config.params[name] = value;\n        }\n      }\n    });\n\n    // Apply existing config params (including URL state) to form elements\n    Object.entries(config.params || {}).forEach(([key, value]) => {\n      const entry = table.filterElements.get(key);\n      if (entry?.element && value !== undefined && value !== null && value !== '') {\n        this.setFormElementValue(entry.element, value);\n      }\n    });\n\n    // Load initial state from URL if available\n    const urlParams = this.getUrlParams(tableId);\n    if (urlParams && Object.keys(urlParams).length > 0) {\n      // Update form elements with URL values\n      Object.entries(urlParams).forEach(([key, value]) => {\n        const filterData = table.filterElements.get(key);\n        if (filterData?.element) {\n          this.setFormElementValue(filterData.element, value);\n          config.params[key] = value;\n        }\n      });\n    }\n  },\n\n  /**\n   * Handle external filter form submission\n   * @param {Object} table - Table instance\n   * @param {string} tableId - Table identifier\n   */\n  handleExternalFilterSubmit(table, tableId) {\n    const form = table.externalFilterForm;\n    if (!form) return;\n\n    // Collect all form values\n    const formData = new FormData(form);\n    const params = {};\n\n    // Process all form fields, including range filters\n    for (const [key, value] of formData.entries()) {\n      // Skip empty values\n      if (value === '' || value === null || value === undefined) continue;\n\n      params[key] = value;\n    }\n\n    // Also handle unchecked checkboxes and empty fields\n    const formElements = form.querySelectorAll('input, select, textarea');\n    formElements.forEach(element => {\n      const name = element.name || element.id;\n      if (!name) return;\n\n      // For checkboxes/radios not in formData, set to empty/false\n      if ((element.type === 'checkbox' || element.type === 'radio') && !formData.has(name)) {\n        params[name] = '';\n      }\n    });\n\n    // Update table config params\n    Object.assign(table.config.params, params);\n\n    // Reset to page 1 when filtering\n    table.config.params.page = 1;\n\n    // Clear selection\n    this.clearSelection(table, tableId);\n\n    // Sync to URL\n    this.syncStateToUrl(tableId);\n\n    // Reload table data\n    this.loadTableData(tableId);\n  },\n\n  /**\n   * Get value from a form element\n   * @param {HTMLElement} element - Form element\n   * @returns {*} Element value\n   */\n  getFormElementValue(element) {\n    if (!element) return '';\n\n    switch (element.type) {\n      case 'checkbox':\n        return element.checked ? (element.value || '1') : '';\n      case 'radio':\n        return element.checked ? element.value : '';\n      case 'select-multiple':\n        return Array.from(element.selectedOptions).map(opt => opt.value);\n      default:\n        return element.value || '';\n    }\n  },\n\n  /**\n   * Set value for a form element\n   * @param {HTMLElement} element - Form element\n   * @param {*} value - Value to set\n   */\n  setFormElementValue(element, value) {\n    if (!element) return;\n\n    // If element is enhanced by ElementManager (e.g., DateElementFactory), prefer its setter\n    try {\n      const elementManager = (typeof ElementManager !== 'undefined' && typeof ElementManager.getInstanceByElement === 'function')\n        ? ElementManager\n        : (typeof Now !== 'undefined' && Now.getManager ? Now.getManager('element') : null);\n\n      const instance = elementManager?.getInstanceByElement?.(element);\n      if (instance && typeof instance.setValue === 'function') {\n        instance.setValue(value);\n        return;\n      }\n    } catch (err) {\n      // fall back to direct assignment\n    }\n\n    switch (element.type) {\n      case 'checkbox':\n        element.checked = (value === '1' || value === 'true' || value === true || value === element.value);\n        break;\n      case 'radio':\n        element.checked = (element.value === value);\n        break;\n      case 'select-multiple':\n        const values = Array.isArray(value) ? value : [value];\n        Array.from(element.options).forEach(opt => {\n          opt.selected = values.includes(opt.value);\n        });\n        break;\n      default:\n        element.value = value;\n        break;\n    }\n  },\n\n  /**\n   * Populate external filter form select elements with options from API\n   * @param {Object} table - Table instance\n   * @param {Object} options - Options object from API response\n   * Format: {fieldName: [{value: '1', text: 'Option 1'}, ...]} or {fieldName: {1: 'Option 1', ...}}\n   */\n  populateExternalFilterOptions(table, options) {\n    if (!table.externalFilterForm || !options) return;\n\n    const form = table.externalFilterForm;\n\n    Object.entries(options).forEach(([fieldName, fieldOptions]) => {\n      // Find select element by name\n      const selectElement = form.querySelector(`select[name=\"${fieldName}\"]`);\n      if (!selectElement) return;\n\n      // Store current value to restore after population\n      const currentValue = selectElement.value;\n\n      // Clear existing options (except first if it's a placeholder/all option)\n      const firstOption = selectElement.options[0];\n      const keepFirst = firstOption && (\n        firstOption.value === '' ||\n        firstOption.textContent.toLowerCase().includes('all') ||\n        firstOption.textContent.toLowerCase().includes('')\n      );\n\n      if (keepFirst) {\n        // Keep first option, remove rest\n        while (selectElement.options.length > 1) {\n          selectElement.remove(1);\n        }\n      } else {\n        // Clear all options\n        selectElement.innerHTML = '';\n      }\n\n      // Add new options\n      if (Array.isArray(fieldOptions)) {\n        // Array format: [{value: '1', text: 'Label'}, ...]\n        fieldOptions.forEach(opt => {\n          const option = document.createElement('option');\n          option.value = opt.value !== undefined ? opt.value : (opt.key || opt.id || '');\n          option.textContent = opt.text || opt.label || opt.name || option.value;\n          selectElement.appendChild(option);\n        });\n      } else if (typeof fieldOptions === 'object') {\n        // Object format: {value: 'Label', ...}\n        Object.entries(fieldOptions).forEach(([value, label]) => {\n          const option = document.createElement('option');\n          option.value = value;\n          option.textContent = label;\n          selectElement.appendChild(option);\n        });\n      }\n\n      // Restore previous value if it exists in new options\n      if (currentValue) {\n        selectElement.value = currentValue;\n      }\n    });\n  },\n\n  handleFilterChange(table, tableId, filterKey, value, element) {\n    // Update filter data, reset to page 1\n    table.config.params['page'] = 1;\n    table.config.params[filterKey] = value;\n\n    this.clearSelection(table, tableId);\n\n    // Update URL with new parameters\n    this.syncStateToUrl(tableId);\n\n    // If table source is remote (api/... or http), reload from API with params\n    const source = table.element.dataset.source || table.config.source || '';\n    if (source && (source.startsWith('api/') || source.startsWith('http'))) {\n      // reload data from API using current params\n      this.loadFromApi(table, tableId, source).catch(err => console.error('Filter load error', err));\n      return;\n    }\n\n    // local data: re-render using client-side filtering\n    this.renderTable(tableId);\n  },\n\n  setupAccessibility(table, tableId, config) {\n    if (!table) return;\n\n    try {\n      table.setAttribute('role', 'grid');\n      table.setAttribute('aria-label', config?.label || table.dataset.label || 'Data Table');\n\n      const thead = table.querySelector('thead');\n      if (thead) {\n        thead.setAttribute('role', 'rowgroup');\n\n        thead.querySelectorAll('th[data-sort]').forEach(th => {\n          th.setAttribute('role', 'columnheader');\n          th.setAttribute('tabindex', '0');\n          th.setAttribute('aria-sort', 'none');\n          th.setAttribute('aria-label', `${th.textContent.trim()}, sortable column`);\n        });\n\n        thead.querySelectorAll('th:not([data-sort])').forEach(th => {\n          th.setAttribute('role', 'columnheader');\n        });\n      }\n\n      const tbody = table.querySelector('tbody');\n      if (tbody) {\n        tbody.setAttribute('role', 'rowgroup');\n\n        tbody.querySelectorAll('tr').forEach((tr, index) => {\n          tr.setAttribute('role', 'row');\n          tr.setAttribute('tabindex', '0');\n          tr.setAttribute('aria-rowindex', index + 1);\n\n          tr.querySelectorAll('td').forEach((td, cellIndex) => {\n            td.setAttribute('role', 'gridcell');\n            td.setAttribute('aria-colindex', cellIndex + 1);\n          });\n        });\n      }\n\n      this.setupKeyboardNavigation(table, tableId);\n\n      const announcer = document.createElement('div');\n      announcer.setAttribute('role', 'status');\n      announcer.setAttribute('aria-live', 'polite');\n      announcer.className = 'sr-only';\n      table.parentNode.insertBefore(announcer, table.nextSibling);\n\n      table.dataset.announcer = announcer.id = `table-announcer-${Date.now()}`;\n\n    } catch (error) {\n      this.handleError('Error setting up table accessibility', error, 'setupAccessibility');\n    }\n  },\n\n  setupSortableRows(tableId) {\n    const instance = this.state.tables.get(tableId);\n    if (!instance?.element) return;\n\n    const tbody = instance.element.querySelector('tbody');\n    if (!tbody) return;\n\n    if (typeof Sortable === 'undefined') {\n      console.warn('Sortable library is required for drag-and-drop rows');\n      return;\n    }\n\n    instance.sortable = new Sortable(tbody, {\n      draggable: 'tr',\n      handle: '.drag-handle',\n      animation: 150,\n      onStart: () => {\n        tbody.classList.add('sorting');\n      },\n      onEnd: async (evt) => {\n        tbody.classList.remove('sorting');\n\n        const rows = Array.from(tbody.children);\n\n        // Get new order\n        const order = rows.map((row, index) => ({\n          id: row.dataset.id,\n          position: index\n        }));\n\n        const newData = [];\n        order.forEach(item => {\n          const data = instance.data.find(d => d.id === item.id);\n          if (data) {\n            newData.push(data);\n          }\n        });\n        instance.data = newData;\n\n        const sortUrl = instance.element.dataset.sortUrl;\n        const actionUrl = sortUrl || instance.element.dataset.actionUrl || instance.config.actionUrl;\n        if (!actionUrl) return;\n\n        try {\n          let success = false;\n\n          if (sortUrl) {\n            const resp = await http.post(sortUrl, {order});\n            success = resp && resp.success !== false;\n          } else {\n            const fakeButton = document.createElement('button');\n            fakeButton.className = 'loading';\n            success = await this.sendAction(actionUrl, {action: 'reorder', order}, tableId, fakeButton);\n          }\n\n          if (success) {\n            NotificationManager.success('Saved successfully');\n          } else {\n            throw new Error('Failed to process request');\n          }\n\n        } catch (error) {\n          console.error('Sort error:', error);\n          NotificationManager.error('Failed to process request');\n          this.renderTable(tableId); // Revert to original order\n        }\n      }\n    });\n\n    return instance.sortable;\n  },\n\n  enableRowSort(tableId) {\n    const instance = this.state.tables.get(tableId);\n    if (!instance?.element) return;\n\n    const theadRow = instance.element.querySelector('thead tr');\n    if (theadRow && !theadRow.querySelector('th.drag-handle')) {\n      const th = document.createElement('th');\n      th.className = 'drag-handle';\n      th.innerHTML = '';\n      th.style.width = '2rem';\n      th.style.textAlign = 'center';\n\n      const insertBefore = theadRow.querySelector('.check-column')?.nextSibling || theadRow.firstChild;\n      theadRow.insertBefore(th, insertBefore);\n    }\n\n    instance.element.querySelectorAll('tbody tr').forEach(row => {\n      if (!row.querySelector('.drag-handle')) {\n        const handle = document.createElement('td');\n        handle.className = 'drag-handle';\n        handle.innerHTML = '';\n        handle.style.cursor = 'move';\n        handle.style.width = '2rem';\n        handle.style.textAlign = 'center';\n        const insertBefore = row.querySelector('.check-column')?.nextSibling || row.firstChild;\n        row.insertBefore(handle, insertBefore);\n      }\n    });\n\n    if (!instance.sortable) {\n      this.setupSortableRows(tableId);\n    }\n  },\n\n  disableRowSort(tableId) {\n    const instance = this.state.tables.get(tableId);\n    if (!instance?.element) return;\n\n    // Remove drag handles\n    instance.element.querySelectorAll('.drag-handle').forEach(handle => {\n      handle.remove();\n    });\n\n    const dragHead = instance.element.querySelector('th.drag-handle');\n    if (dragHead) dragHead.remove();\n\n    if (instance.sortable) {\n      instance.sortable.destroy();\n      instance.sortable = null;\n    }\n  },\n\n  async loadTableData(tableId) {\n    const table = this.state.tables.get(tableId);\n    if (!table?.element) return;\n\n    this.clearSelection(table, tableId);\n\n    try {\n      const source = table.element.dataset.source;\n\n      if (!source) {\n        this.loadFromHtml(table);\n        return;\n      }\n\n      this.showLoading(table);\n\n      if (source.startsWith('api/') || source.startsWith('http')) {\n        await this.loadFromApi(table, tableId, source);\n      } else if (source.endsWith('.json')) {\n        await this.loadFromJson(tableId, source);\n      } else {\n        this.loadFromState(tableId, source);\n      }\n\n    } catch (error) {\n      this.handleError(`Error loading table data`, error, 'loadData');\n    }\n  },\n\n  isServerSideTable(table) {\n    if (!table) return false;\n    const source = table?.element?.dataset?.source || table?.config?.source || '';\n    return !!(source && (source.startsWith('api/') || source.startsWith('http')));\n  },\n\n  createEmptyRow(table) {\n    // Use counter instead of timestamp for predictable IDs\n    // This ensures element IDs like tableId_field_new_1 are consistent\n    if (!table._newRowCounter) {\n      table._newRowCounter = 0;\n    }\n    table._newRowCounter++;\n\n    const row = {id: `new_${table._newRowCounter}`};\n    if (table?.columns instanceof Map) {\n      table.columns.forEach((_, field) => {\n        row[field] = '';\n      });\n    }\n    return row;\n  },\n\n  captureRowValues(table, tableId, item, index = 0) {\n    if (!table?.element) return item;\n\n    let tr = null;\n    if (item?.id) {\n      tr = table.element.querySelector(`tbody tr[data-id=\"${item.id}\"]`);\n    }\n    if (!tr) {\n      tr = table.element.querySelectorAll('tbody tr')[index] || null;\n    }\n    if (!tr) return item;\n\n    const updated = {...item};\n\n    table.columns.forEach((_, field) => {\n      const cell = tr.querySelector(`td[data-field=\"${field}\"]`);\n      if (!cell) return;\n\n      let el = null;\n      if (cell.dataset.elementId) {\n        el = document.getElementById(cell.dataset.elementId);\n      }\n      if (!el) {\n        el = cell.querySelector('input, select, textarea, [contenteditable=\"true\"]');\n      }\n\n      if (el) {\n        updated[field] = this.getFormElementValue(el);\n      } else {\n        updated[field] = cell.textContent;\n      }\n    });\n\n    return updated;\n  },\n\n  async loadFromApi(table, tableId, source) {\n    const params = {\n      ...this.getFilterParams(table),\n      ...this.getSortParams(table),\n      ...this.getPaginationParams(table)\n    };\n\n    await this.fetchAndSet(tableId, source, {\n      method: table.config.method || 'GET',\n      headers: {\n        'Accept': 'application/json'\n      },\n      params\n    });\n  },\n\n  async loadFromJson(tableId, source) {\n    const options = {\n      method: 'GET',\n      headers: {\n        'Accept': 'application/json'\n      }\n    };\n\n    await this.fetchAndSet(tableId, source, options);\n  },\n\n  async fetchAndSet(tableId, url, options = {}) {\n    try {\n      const {\n        method = 'GET',\n        headers = {},\n        params,\n        body,\n        data,\n        credentials,\n        ...restOptions\n      } = options;\n\n      const upperMethod = method.toUpperCase();\n      const payload = typeof body !== 'undefined' ? body : data;\n      const defaultCredentials = credentials || (window.ApiService?.config?.security?.sendCredentials ? 'include' : 'same-origin');\n      const apiCache = ApiService.config.cache;\n      apiCache.enabled = false; // disable caching for table data fetches\n      let response;\n\n      const apiOptions = {\n        ...restOptions,\n        headers,\n        credentials: defaultCredentials,\n        cache: apiCache\n      };\n\n      const methodName = upperMethod.toLowerCase();\n\n      if (upperMethod === 'GET') {\n        response = await ApiService.get(url, params || {}, apiOptions);\n      } else if (typeof ApiService[methodName] === 'function') {\n        response = await ApiService[methodName](url, payload, {\n          ...apiOptions,\n          params\n        });\n      } else {\n        throw new Error(`Unsupported request method: ${upperMethod}`);\n      }\n\n      // Handle 403 Forbidden - redirect to 403 page\n      if (response?.status === 403) {\n        console.warn('TableManager: Access forbidden (403) for table data');\n\n        if (window.RouterManager?.navigate) {\n          window.RouterManager.navigate('/403');\n          return;\n        }\n\n        if (window.LocationManager?.redirect) {\n          window.LocationManager.redirect('/403');\n          return;\n        }\n\n        window.location.href = '/403';\n        return;\n      }\n\n      // Handle 401 Unauthorized - redirect to login\n      if (response?.status === 401) {\n        console.warn('TableManager: Unauthorized (401) for table data');\n\n        const error = new Error(response.statusText || 'Unauthorized');\n        error.status = 401;\n        error.response = response;\n\n        await AuthErrorHandler.handleError(error, {\n          currentPath: window.location.pathname\n        });\n        return;\n      }\n\n\n      if (response?.success === false) {\n        throw new Error(response?.message || response?.statusText || `Request failed (${response?.status || 'unknown'})`);\n      }\n\n      let responseData;\n      if (response?.data) {\n        if (response.data.columns || response.data.meta || response.data.filters) {\n          // Has metadata alongside data - use the whole object\n          responseData = response.data;\n        } else if (response.data.data) {\n          // No metadata, but has nested data - unwrap it\n          responseData = response.data.data;\n        } else {\n          // Just use response.data as is\n          responseData = response.data;\n        }\n      } else {\n        responseData = response;\n      }\n\n      const table = this.state.tables.get(tableId);\n      if (table && responseData && responseData.meta && typeof responseData.meta === 'object') {\n        table.serverSide = true;\n      }\n\n      this.setData(tableId, responseData);\n    } catch (error) {\n      this.handleError('Fetch error', error, 'fetchAndSet');\n    }\n  },\n\n  loadFromHtml(table, tableId) {\n    // Support being passed either the internal table state object or a DOM element.\n    let tableObj = null;\n    let tableEl = null;\n    let finalTableId = tableId;\n\n    if (!table) return;\n\n    if (table.element) {\n      // table is the internal state object\n      tableObj = table;\n      tableEl = table.element;\n      finalTableId = finalTableId || tableObj.id || (tableEl && tableEl.dataset && tableEl.dataset.table);\n    } else if (table instanceof Element) {\n      // table is a DOM element\n      tableEl = table;\n      finalTableId = finalTableId || (tableEl.dataset && tableEl.dataset.table);\n      tableObj = this.state.tables.get(finalTableId) || {element: tableEl, id: finalTableId};\n    } else {\n      // unknown input\n      return;\n    }\n\n    if (!tableEl) return;\n\n    // Prevent race condition: Skip if table already has data from API or is loading\n    // This stops loadFromHtml from overwriting API data with empty array\n    if (tableObj) {\n      // Skip if data already loaded from API\n      if (tableObj.data && tableObj.data.length > 0) return;\n      // Skip if currently loading from API\n      if (tableObj.loading) return;\n    }\n\n    const headers = [...tableEl.querySelectorAll('th')]\n      .map(th => ({\n        field: th.dataset.field || th.textContent.trim().toLowerCase(),\n        sort: th.dataset.sort,\n        formatter: th.dataset.formatter\n      }));\n\n    const rawRows = [...tableEl.querySelectorAll('tbody tr')]\n      .map(tr => {\n        const row = {};\n        [...tr.cells].forEach((cell, index) => {\n          const header = headers[index] || {field: `col_${index}`};\n          row[header.field] = {\n            text: cell.textContent.trim(),\n            html: cell.innerHTML\n          };\n        });\n        return row;\n      });\n\n    // Build normalized rows where each cell is a primitive (string) for filtering/sorting\n    const normalizedRows = rawRows.map(r => {\n      const nr = {};\n      Object.entries(r).forEach(([k, v]) => {\n        if (v === null || v === undefined) {\n          nr[k] = v;\n        } else if (typeof v === 'object') {\n          nr[k] = v.text !== undefined ? v.text : (v.html !== undefined ? v.html : JSON.stringify(v));\n        } else {\n          nr[k] = v;\n        }\n      });\n      return nr;\n    });\n\n    // store originalData on the internal table object if available\n    try {\n      if (tableObj) tableObj.originalData = rawRows;\n    } catch (e) {\n      // ignore\n    }\n\n    // Ensure we pass a valid tableId into setData using normalized primitive data\n    if (finalTableId) {\n      this.setData(finalTableId, normalizedRows);\n    } else {\n      // fallback: attempt to find tableId by matching element reference\n      for (const [tid, t] of this.state.tables.entries()) {\n        if (t.element === tableEl) {\n          this.setData(tid, normalizedRows);\n          return;\n        }\n      }\n      // If still not found, log and skip\n      console.warn('TableManager: unable to determine tableId for HTML data load');\n    }\n  },\n\n  loadFromState(tableId, stateKey) {\n    // Prefer using the registered state manager if available\n    const stateManager = Now.getManager ? Now.getManager('state') : null;\n    if (!stateManager || typeof stateManager.get !== 'function') {\n      throw new Error('Now.js state manager not available');\n    }\n\n    // Try to read current value first\n    const data = stateManager.get(stateKey);\n    if (data) {\n      this.setData(tableId, data);\n      return;\n    }\n\n    // If no data yet, try to subscribe for future updates (StateManager should provide subscribe)\n    if (typeof stateManager.subscribe === 'function') {\n      const handler = (newValue) => {\n        if (!newValue) return;\n        try {\n          this.setData(tableId, newValue);\n        } catch (err) {\n          console.error('Error applying state update to table:', err);\n        } finally {\n          // Unsubscribe after first successful set if possible\n          if (typeof stateManager.unsubscribe === 'function') {\n            stateManager.unsubscribe(stateKey, handler);\n          } else if (typeof stateManager.off === 'function') {\n            stateManager.off(stateKey, handler);\n          }\n        }\n      };\n\n      try {\n        stateManager.subscribe(stateKey, handler);\n      } catch (err) {\n        console.warn(`Unable to subscribe to state key ${stateKey}:`, err);\n      }\n      return;\n    }\n\n    // Fallback: no data and no subscribe method  leave table empty but do not throw\n    console.warn(`State key ${stateKey} not found and state manager has no subscribe; table ${tableId} will remain empty until data is set`);\n  },\n\n  setData(tableId, data) {\n    if (!tableId) {\n      throw new Error('Invalid parameters');\n    }\n\n    let normalized = null;\n    if (Array.isArray(data)) {\n      normalized = {\n        data,\n        meta: (data && data.meta) ? {...data.meta} : {total: data.length},\n        filters: (data && data.filters) ? data.filters : {},\n        options: (data && data.options) ? data.options : {},\n        columns: (data && data.columns) ? data.columns : undefined\n      };\n    } else if (data && Array.isArray(data.data)) {\n      normalized = {\n        data: data.data,\n        meta: data.meta ? {...data.meta} : {total: data.data.length},\n        filters: data.filters || {},\n        options: data.options || {},\n        columns: data.columns || undefined\n      };\n    } else {\n      throw new Error('Invalid data payload: expected canonical schema {data:[], meta:{page: 1, pageSize: 20, total: 0}, filters:{}, options:{}}');\n    }\n\n    const table = this.state.tables.get(tableId);\n    if (!table) return;\n\n    try {\n      // Handle dynamic columns from API response\n      let columnsMetadata = null;\n\n      if (table.config.dynamicColumns) {\n        // Check normalized.columns (from API response)\n        if (normalized.columns && Array.isArray(normalized.columns)) {\n          columnsMetadata = normalized.columns;\n        }\n        // If using nested data (data-attr), check in normalized.data.columns\n        else if (normalized.data && normalized.data.columns && Array.isArray(normalized.data.columns)) {\n          columnsMetadata = normalized.data.columns;\n        }\n      }\n\n      if (columnsMetadata) {\n        const existingThead = table.element.querySelector('thead');\n\n        // Only create dynamic headers if thead doesn't exist or is empty\n        if (!existingThead || existingThead.querySelectorAll('th[data-field]').length === 0) {\n          // Create new thead from column metadata\n          const newThead = this.createDynamicHeaders(table, columnsMetadata);\n\n          // Remove old thead if exists\n          if (existingThead) {\n            existingThead.remove();\n          }\n\n          // Insert new thead before tbody\n          const tbody = table.element.querySelector('tbody');\n          table.element.insertBefore(newThead, tbody);\n\n          // Translate headers if i18n is available\n          if (window.Now && window.Now.translate) {\n            newThead.querySelectorAll('[data-i18n]').forEach(el => {\n              const original = el.textContent.trim();\n              if (original) {\n                el.textContent = window.Now.translate(original);\n              }\n            });\n          }\n\n          // Update column definitions from new thead\n          table.columns = this.getColumnDefinitions(table);\n\n          // Setup sortable headers with event listeners\n          newThead.querySelectorAll('th[data-sort]').forEach(th => {\n            th.classList.add('sortable');\n            th.setAttribute('role', 'columnheader');\n            th.setAttribute('tabindex', '0');\n            th.setAttribute('aria-sort', 'none');\n\n            // Bind sort event listeners\n            const sortHandler = (e) => {\n              e.preventDefault();\n              e.stopPropagation();\n              if (e.shiftKey) {\n                window.getSelection()?.removeAllRanges();\n              }\n              this.handleSort(table, tableId, th, e);\n            };\n\n            const keyHandler = (e) => {\n              if (e.key === 'Enter' || e.key === ' ') {\n                e.preventDefault();\n                this.handleSort(table, tableId, th, e);\n              }\n            };\n\n            th.addEventListener('click', sortHandler);\n            th.addEventListener('keydown', keyHandler);\n\n            // Store handlers for cleanup\n            if (!table.eventHandlers) table.eventHandlers = {sort: new Map()};\n            if (!table.eventHandlers.sort) table.eventHandlers.sort = new Map();\n            table.eventHandlers.sort.set(th, {\n              sort: sortHandler,\n              key: keyHandler\n            });\n          });\n\n\n\n          // Create tfoot for dynamic headers if showFooter is enabled\n          if (table.config.showFooter) {\n            let tfoot = table.element.querySelector('tfoot');\n\n            // Only create if doesn't exist\n            if (!tfoot) {\n              tfoot = document.createElement('tfoot');\n              const tr = document.createElement('tr');\n\n              // Create footer cells matching the header structure\n              const thCount = newThead.querySelector('tr')?.querySelectorAll('th').length || 0;\n              for (let i = 0; i < thCount; i++) {\n                const td = document.createElement('td');\n                tr.appendChild(td);\n              }\n\n              tfoot.appendChild(tr);\n              table.element.appendChild(tfoot);\n            }\n          }\n\n          // Setup checkboxes for dynamic headers (both thead and tfoot)\n          this.setupCheckboxes(table, tableId);\n\n          // Setup filters for new headers\n          this.setupFilter(table, tableId);\n\n          // Setup column resizing for dynamic headers\n          this.setupColumnResizing(tableId);\n\n          // Setup accessibility after all components are created\n          this.setupAccessibility(table.element, tableId, table.config);\n\n          // Update search columns from column metadata if not already set\n          if (!table.config.searchColumns || table.config.searchColumns.length === 0) {\n            const searchableFields = columnsMetadata\n              .filter(col => col.searchable === true)\n              .map(col => col.field);\n\n            if (searchableFields.length > 0) {\n              table.config.searchColumns = searchableFields.join(',');\n            }\n          }\n        }\n      }\n\n      // Store options from API response for data formatting (e.g., lookup)\n      if (normalized.options && Object.keys(normalized.options).length) {\n        if (!table.dataOptions) table.dataOptions = {};\n        Object.assign(table.dataOptions, normalized.options);\n\n        // Populate external filter form options if available\n        if (table.externalFilterForm) {\n          this.populateExternalFilterOptions(table, normalized.options);\n        }\n      }\n\n      // Also check if filters contain option arrays and store them as dataOptions\n      if (normalized.filters && Object.keys(normalized.filters).length) {\n        this.setFilters(tableId, normalized.filters);\n\n        // Populate external filter form options from filters\n        if (table.externalFilterForm) {\n          this.populateExternalFilterOptions(table, normalized.filters);\n        }\n\n        // Extract options from filters for data formatting\n        if (!table.dataOptions) table.dataOptions = {};\n        Object.entries(normalized.filters).forEach(([key, value]) => {\n          if (Array.isArray(value) && value.length > 0) {\n            // Convert array to object for lookup\n            const optionsMap = {};\n            value.forEach(item => {\n              if (item && typeof item === 'object') {\n                const val = item.value !== undefined ? item.value : (item.key !== undefined ? item.key : item);\n                const label = item.label || item.text || String(item);\n                optionsMap[val] = label;\n              } else {\n                optionsMap[item] = String(item);\n              }\n            });\n            table.dataOptions[key] = optionsMap;\n          }\n        });\n      }\n\n      // Parse meta values\n      const metaPage = parseInt(normalized.meta.page || table.config.params.page);\n      const metaPageSize = parseInt(normalized.meta.pageSize || table.config.params.pageSize);\n      const metaTotal = parseInt(normalized.meta.total || 0);\n      const metaTotalPages = parseInt(normalized.meta.totalPages || Math.max(1, Math.ceil(metaTotal / metaPageSize)));\n\n      // Auto-correct page if it exceeds totalPages (e.g., from stale URL params)\n      const correctedPage = metaPage > metaTotalPages ? metaTotalPages : metaPage;\n\n      table.config.params = {\n        ...table.config.params,\n        ...normalized.meta,\n        page: correctedPage,\n        pageSize: metaPageSize,\n        total: metaTotal,\n        totalPages: metaTotalPages\n      };\n\n\n      // Extract table data - handle both array and nested object structures\n      let tableContent = normalized.data || [];\n\n      // If normalized.data is an object with a 'data' property, use that instead\n      if (!Array.isArray(tableContent) && tableContent.data && Array.isArray(tableContent.data)) {\n        tableContent = tableContent.data;\n      }\n\n      if (!Array.isArray(tableContent)) {\n        throw new Error('Invalid data format: expected array');\n      }\n      table.data = tableContent;\n\n      // If API/state did not provide filter option lists, derive them from data for select filters\n      try {\n        const derived = this.deriveFiltersFromData(table);\n        if (derived && Object.keys(derived).length) {\n          // If filter elements already exist, apply immediately; otherwise store for setupFilter to apply\n          if (table.filterElements && (typeof table.filterElements.size === 'number' ? table.filterElements.size > 0 : Object.keys(table.filterElements).length > 0)) {\n            this.setFilters(tableId, derived);\n          } else {\n            table.pendingDerivedFilters = derived;\n          }\n        }\n      } catch (err) {\n        console.warn('Failed to derive filter options from data:', err);\n      }\n\n      // Sync sortState from API response if sortState is empty (initial load)\n      // This ensures TableManager knows the actual sort order used by API\n      if (normalized.meta.sort && Object.keys(table.sortState).length === 0) {\n        const sortString = normalized.meta.sort;\n        const sortPairs = sortString.split(',').map(pair => pair.trim());\n\n        sortPairs.forEach(pair => {\n          const parts = pair.split(/\\s+/);\n          if (parts.length >= 2) {\n            const field = parts[0];\n            const direction = parts[1].toLowerCase();\n            if (['asc', 'desc'].includes(direction)) {\n              table.sortState[field] = direction;\n            }\n          } else if (parts.length === 1 && parts[0]) {\n            table.sortState[parts[0]] = 'asc';\n          }\n        });\n      }\n\n      // Don't reset sortState - preserve user's sort selection\n      // Only reset if explicitly requested via options\n      if (normalized.resetSort === true) {\n        table.sortState = {};\n      }\n\n      // Only render if not initializing to prevent redundant renders\n      if (!table.initializing) {\n        this.renderTable(tableId);\n      }\n    } catch (error) {\n      this.handleError('Setting table data', error, 'setData');\n      table.data = [];\n\n      // Only render if not initializing\n      if (!table.initializing) {\n        this.renderTable(tableId);\n      }\n    }\n  },\n\n  setFilters(tableId, filters) {\n    const table = this.state.tables.get(tableId);\n    if (!table) return;\n\n    try {\n      table.filterOptions = filters;\n      Object.entries(filters).forEach(([key, values]) => {\n        const filterElement = table.filterData.get(key);\n        const attributes = table.columns.get(key);\n        if (filterElement && filterElement.element) {\n          // Build ordered array of options: [{value, text}, ...]\n          const optionsArray = [];\n\n          // If configured to show an \"All\" option, add it first\n          if (attributes && attributes.showAll) {\n            optionsArray.push({\n              value: attributes.allValue || '',\n              text: attributes.allLabel || 'All'\n            });\n          }\n\n          // Normalize values (can be Map, Array, or plain object)\n          if (values instanceof Map) {\n            for (const [v, label] of values.entries()) {\n              optionsArray.push({value: v, text: label});\n            }\n          } else if (Array.isArray(values)) {\n            values.forEach(item => {\n              if (item && typeof item === 'object') {\n                const val = item.value !== undefined ? item.value : (item.key !== undefined ? item.key : item);\n                const txt = item.text || item.label || String(item);\n                optionsArray.push({value: val, text: txt});\n              } else {\n                optionsArray.push({value: item, text: String(item)});\n              }\n            });\n          } else if (typeof values === 'object' && values !== null) {\n            // plain object: iterate entries in insertion order\n            Object.entries(values).forEach(([v, label]) => {\n              optionsArray.push({value: v, text: label});\n            });\n          }\n\n          // Prefer element-based lookup to avoid stale id-only instances\n          let emInstance = null;\n          try {\n            if (ElementManager && typeof ElementManager.getInstanceByElement === 'function') {\n              emInstance = ElementManager.getInstanceByElement(filterElement.element) || null;\n            }\n            if (!emInstance && filterElement.element?.id && typeof ElementManager.getInstance === 'function') {\n              emInstance = ElementManager.getInstance(filterElement.element.id) || null;\n              if (emInstance && emInstance.element && emInstance.element !== filterElement.element && !emInstance.element.isConnected) {\n                try {ElementManager.destroy(filterElement.element.id);} catch (e) {}\n                emInstance = null;\n              }\n            }\n          } catch (e) {\n            emInstance = null;\n          }\n\n          if (emInstance?.updateOptions && typeof emInstance.updateOptions === 'function') {\n            emInstance.updateOptions(optionsArray);\n\n            // Restore selected value from config params (URL state) after updating options\n            let valueToRestore = null;\n            if (table.config.params[key] !== undefined && table.config.params[key] !== null && table.config.params[key] !== '') {\n              valueToRestore = table.config.params[key];\n            } else if (filterElement.element.value !== undefined) {\n              valueToRestore = filterElement.element.value;\n            }\n\n            if (valueToRestore !== null) {\n              // Set value through instance if available\n              if (emInstance.setValue && typeof emInstance.setValue === 'function') {\n                emInstance.setValue(valueToRestore);\n              } else if (filterElement.element) {\n                filterElement.element.value = valueToRestore;\n              }\n            }\n          } else {\n            // Fallback: try to update DOM select element directly\n            try {\n              const el = filterElement.element;\n              // If wrapper contains select, prefer that\n              const selectEl = (el && el.tagName === 'SELECT') ? el : (el && el.querySelector ? el.querySelector('select') : null);\n              if (selectEl) {\n                selectEl.innerHTML = '';\n                optionsArray.forEach(opt => {\n                  const option = document.createElement('option');\n                  option.value = opt.value;\n                  option.textContent = opt.text;\n                  selectEl.appendChild(option);\n                });\n\n                // Restore selected value from config params (URL state) or current element value\n                let valueToRestore = null;\n                if (table.config.params[key] !== undefined && table.config.params[key] !== null && table.config.params[key] !== '') {\n                  // Prioritize URL/config params\n                  valueToRestore = table.config.params[key];\n                } else if (filterElement.element.value !== undefined) {\n                  // Fallback to current element value\n                  valueToRestore = filterElement.element.value;\n                }\n\n                if (valueToRestore !== null) {\n                  // Check if the value exists in options\n                  const hasOption = Array.from(selectEl.options).some(opt => opt.value === String(valueToRestore));\n                  if (hasOption) {\n                    selectEl.value = valueToRestore;\n                  }\n                }\n              } else if (el && el.updateOptions && typeof el.updateOptions === 'function') {\n                el.updateOptions(optionsArray);\n              } else {\n                console.warn('No method found to update filter element options for', key);\n              }\n            } catch (err) {\n              console.warn('Failed DOM fallback for updating filter options', err);\n            }\n          }\n        }\n      });\n\n      // After updating all filter options, restore UI state from config params\n      // This ensures URL parameters are applied after API options are loaded\n      this.restoreFilterUIFromState(tableId);\n\n    } catch (error) {\n      console.error('Error setting filters:', error);\n    }\n  },\n\n  deriveFiltersFromData(table) {\n    if (!table || !Array.isArray(table.data)) return {};\n\n    const result = {};\n    // Only derive for columns configured as filterable and of select type\n    table.columns.forEach((attributes, field) => {\n      if (!attributes.filter) return;\n      // If options already provided via attributes or filterOptions, skip deriving\n      if ((attributes.options && Object.keys(attributes.options).length) || (table.filterOptions && table.filterOptions[field])) return;\n\n      const values = new Map();\n      table.data.forEach(row => {\n        const val = row[field];\n        if (val === undefined || val === null) return;\n        const key = typeof val === 'object' ? (val.value !== undefined ? val.value : (val.text !== undefined ? val.text : JSON.stringify(val))) : val;\n        if (!values.has(key)) values.set(key, String(key));\n      });\n\n      // Convert Map to array of {value,text} for deterministic ordering\n      if (values.size > 0) {\n        result[field] = Array.from(values.entries()).map(([value, text]) => ({value, text}));\n      }\n    });\n\n    return result;\n  },\n\n  renderTable(tableId) {\n    const table = this.state.tables.get(tableId);\n    if (!table) return;\n\n    const {element: tableEl, config} = table;\n\n    const tbody = tableEl.querySelector('tbody');\n    if (!tbody) return;\n\n    try {\n      tbody.innerHTML = '';\n\n      // Check if data comes from API (server-side)\n      const source = tableEl.dataset.source || config.source || '';\n      const hasApiSource = source && (source.startsWith('api/') || source.startsWith('http'));\n\n      // Also check if response has meta.total which indicates server-side pagination\n      const hasServerMeta = table.serverSide || (config.params.total !== undefined && config.params.total !== (table.data || []).length);\n\n      const isServerSide = hasApiSource || hasServerMeta;\n\n      // Ensure at least one editable row exists so add/copy controls are visible\n      if (config.allowRowModification && (!Array.isArray(table.data) || table.data.length === 0)) {\n        table.data = [this.createEmptyRow(table)];\n      }\n\n      const baseData = table.data || [];\n\n      let filteredData = baseData;\n      let pageData = baseData;\n      let totalPages = 1;\n      let totalRecords = baseData.length;\n\n      if (isServerSide) {\n        // Server-side: API already filtered, sorted, and paginated\n        // Just display the data as-is\n        pageData = baseData;\n        totalRecords = config.params.total || baseData.length;\n        totalPages = config.params.totalPages || Math.ceil(totalRecords / (config.params.pageSize || baseData.length || 1));\n      } else {\n        // Client-side: apply filtering, sorting, and pagination\n        filteredData = this.filterData(table, baseData);\n        filteredData = this.sortData(table, filteredData);\n        const paginationResult = this.paginateData(table, filteredData);\n        pageData = paginationResult.pageData;\n        totalPages = paginationResult.totalPages;\n        totalRecords = paginationResult.totalRecords;\n      }\n\n      if (pageData.length === 0) {\n        const tr = document.createElement('tr');\n        const td = document.createElement('td');\n        td.colSpan = tableEl.querySelectorAll('thead th').length;\n        td.className = 'empty-table';\n        td.textContent = Now.translate('No data available');\n        tr.appendChild(td);\n        tbody.appendChild(tr);\n      } else {\n        pageData.forEach((item, index) => {\n          const tr = this.renderRow(table, tableId, item, index);\n          tbody.appendChild(tr);\n        });\n      }\n\n      if (config.allowRowModification && config.rowSortable !== false) {\n        this.enableRowSort(tableId);\n      } else {\n        this.disableRowSort(tableId);\n      }\n\n      // Restore sort UI state on headers\n      this.restoreSortUI(table);\n\n      this.setupFooter(table);\n\n      if (config.params.pageSize > 0) {\n        this.updatePagination(table, tableId, totalRecords, totalPages);\n      }\n\n      EventManager.emit('table:render', {\n        tableId,\n        data: pageData,\n        totalRecords: isServerSide ? totalRecords : baseData.length,\n        filteredRecords: isServerSide ? totalRecords : filteredData.length,\n        isServerSide\n      });\n    } catch (error) {\n      this.handleError('Rendering table', error, 'render');\n    }\n  },\n\n  restoreSortUI(table) {\n    if (!table || !table.element) return;\n\n    // First, clear all sort classes, aria-sort, and sort order indicators\n    table.element.querySelectorAll('th[data-sort]').forEach(th => {\n      th.classList.remove('sort_asc', 'sort_desc');\n      th.setAttribute('aria-sort', 'none');\n      const sortOrder = th.querySelector('.sort-order');\n      if (sortOrder) sortOrder.remove();\n    });\n\n    // Then, apply current sort state\n    if (table.sortState && Object.keys(table.sortState).length > 0) {\n      const sortKeys = Object.keys(table.sortState);\n      const isMultiSort = sortKeys.length > 1;\n\n      Object.entries(table.sortState).forEach(([column, direction], index) => {\n        const th = table.element.querySelector(`th[data-sort=\"${column}\"]`);\n        if (th) {\n          th.classList.add(direction === 'asc' ? 'sort_asc' : 'sort_desc');\n          th.setAttribute('aria-sort', direction === 'asc' ? 'ascending' : 'descending');\n\n          // Add sort order indicator for multi-column sort\n          if (isMultiSort) {\n            let sortOrder = th.querySelector('.sort-order');\n            if (!sortOrder) {\n              sortOrder = document.createElement('span');\n              sortOrder.className = 'sort-order';\n              th.appendChild(sortOrder);\n            }\n            sortOrder.textContent = index + 1;\n            sortOrder.setAttribute('aria-label', `Sort priority ${index + 1}`);\n          }\n        }\n      });\n    }\n  },\n\n  renderRow(table, tableId, item, index) {\n    const tr = document.createElement('tr');\n\n    if (item.id) {\n      tr.dataset.id = item.id;\n    }\n\n    if (table.config.showCheckbox) {\n      const td = document.createElement('td');\n      td.className = 'check-column';\n\n      const checkboxId = `select-row-${tableId}-${item.id || index}`;\n\n      const label = document.createElement('label');\n      label.htmlFor = checkboxId;\n\n      const checkbox = document.createElement('input');\n      checkbox.type = 'checkbox';\n      checkbox.className = 'select-row';\n      checkbox.id = checkboxId;\n      checkbox.value = item.id || index;\n      checkbox.addEventListener('change', () => {\n        this.handleRowSelection(table, tableId);\n      });\n\n      label.appendChild(checkbox);\n      td.appendChild(label);\n      tr.appendChild(td);\n    }\n\n    if (table.config.allowRowModification && table.config.rowSortable !== false) {\n      const handle = document.createElement('td');\n      handle.className = 'drag-handle';\n      handle.innerHTML = '';\n      handle.style.cursor = 'move';\n      handle.style.width = '2rem';\n      handle.style.textAlign = 'center';\n      tr.appendChild(handle);\n    }\n\n    table.columns.forEach((attributes, field) => {\n      this.renderCell(table, tableId, tr, field, attributes, item, index);\n    });\n\n    if (table.config.allowRowModification) {\n      const td = document.createElement('td');\n      td.className = 'icons';\n      const div = document.createElement('div');\n      const buttons = [\n        {\n          action: 'copy',\n          title: Now.translate('Copy'),\n          text: '+',\n          className: 'plus',\n          handler: async () => this.handleCopyRow(table, tableId, item)\n        },\n        {\n          action: 'delete',\n          title: Now.translate('Delete'),\n          text: '-',\n          className: 'minus',\n          handler: async () => this.handleDeleteRow(table, tableId, item)\n        }\n      ];\n\n      buttons.forEach(btn => {\n        const button = document.createElement('button');\n        button.type = 'button';\n        button.className = btn.className;\n        button.title = btn.title;\n        button.innerText = btn.text;\n        button.setAttribute('aria-label', btn.title);\n\n        button.addEventListener('click', async (e) => {\n          e.preventDefault();\n          await btn.handler();\n        });\n\n        div.appendChild(button);\n      });\n\n      td.appendChild(div);\n      tr.appendChild(td);\n    }\n\n    // If table defines data-row-actions, render action cell (uses data-row-actions JSON)\n    const rowActionsRaw = table.element.dataset.rowActions || table.element.dataset.rowActionsJson;\n    if (rowActionsRaw) {\n      try {\n        const actions = this.parseRowActions(rowActionsRaw);\n        const actionCell = this.createActionCell(table, tableId, item, actions);\n        tr.appendChild(actionCell);\n      } catch (err) {\n        console.warn('Invalid data-row-actions for table', tableId, err);\n      }\n    }\n\n    return tr;\n  },\n\n  async handleCopyRow(table, tableId, item) {\n    try {\n      // Capture current DOM values to ensure edits are preserved\n      const updatedItem = this.captureRowValues(table, tableId, item);\n\n      // Persist updated item back into table.data\n      if (Array.isArray(table.data)) {\n        const idx = table.data.findIndex(r => String(r.id) === String(item.id));\n        if (idx !== -1) {\n          table.data[idx] = updatedItem;\n        }\n      }\n\n      const newItem = structuredClone ? structuredClone(updatedItem) : JSON.parse(JSON.stringify(updatedItem));\n\n      // Use counter for predictable IDs instead of random timestamp\n      if (!table._newRowCounter) {\n        table._newRowCounter = 0;\n      }\n      table._newRowCounter++;\n      newItem.id = `new_${table._newRowCounter}`;\n\n      const actionUrl = table.element.dataset.actionUrl || table.config.actionUrl;\n      const isServerSide = this.isServerSideTable(table);\n\n      if (actionUrl) {\n        const fakeButton = document.createElement('button');\n        fakeButton.className = 'loading';\n\n        const success = await this.sendAction(actionUrl, {action: 'copy', row: item}, tableId, fakeButton);\n        if (!success) return;\n\n        if (isServerSide) {\n          await this.loadTableData(tableId);\n        } else {\n          const idx = Array.isArray(table.data)\n            ? table.data.findIndex(r => String(r.id) === String(updatedItem.id))\n            : -1;\n          const insertAt = idx >= 0 ? idx + 1 : table.data.length;\n          table.data.splice(insertAt, 0, newItem);\n          this.renderTable(tableId);\n        }\n      } else {\n        const idx = Array.isArray(table.data)\n          ? table.data.findIndex(r => String(r.id) === String(updatedItem.id))\n          : -1;\n        const insertAt = idx >= 0 ? idx + 1 : table.data.length;\n        table.data.splice(insertAt, 0, newItem);\n        this.renderTable(tableId);\n      }\n\n      EventManager.emit('table:rowCopied', {\n        tableId,\n        originalItem: item,\n        newItem\n      });\n    } catch (error) {\n      this.handleError('Copy row', error, 'copyRow');\n    }\n  },\n\n  async handleDeleteRow(table, tableId, item) {\n    try {\n      if (window.DialogManager && table.config.confirmDelete !== false) {\n        const confirmed = await DialogManager.confirm(\n          Now.translate('Are you sure you want to delete this item?'),\n          Now.translate('Confirm Delete')\n        );\n\n        if (confirmed) {\n          await this.deleteRow(table, tableId, item);\n        }\n      } else {\n        await this.deleteRow(table, tableId, item);\n      }\n\n    } catch (error) {\n      this.handleError('Delete row', error, 'deleteRow');\n    }\n  },\n\n  async deleteRow(table, tableId, item) {\n    try {\n      const actionUrl = table.element.dataset.actionUrl || table.config.actionUrl;\n      const isServerSide = this.isServerSideTable(table);\n\n      const removeLocalRow = () => {\n        if (!Array.isArray(table.data)) return;\n        const index = table.data.findIndex(row => row.id === item.id);\n        const idx = index !== -1 ? index : table.data.indexOf(item);\n        if (idx !== -1) {\n          table.data.splice(idx, 1);\n        }\n        // Keep at least one empty row for editable tables\n        if (table.config.allowRowModification && table.data.length === 0) {\n          table.data.push(this.createEmptyRow(table));\n        }\n        this.renderTable(tableId);\n      };\n\n      if (actionUrl) {\n        const fakeButton = document.createElement('button');\n        fakeButton.className = 'loading';\n        const success = await this.sendAction(actionUrl, {action: 'delete', id: item.id, row: item}, tableId, fakeButton);\n        if (!success) return;\n\n        if (isServerSide) {\n          await this.loadTableData(tableId);\n        } else {\n          removeLocalRow();\n        }\n      } else {\n        removeLocalRow();\n      }\n\n      NotificationManager.success('Deleted successfully');\n\n      EventManager.emit('table:rowDeleted', {\n        tableId,\n        item\n      });\n    } catch (error) {\n      this.handleError('Delete row', error, 'deleteRow');\n    }\n  },\n\n  getColumnDefinitions(table) {\n    const columns = new Map();\n    const mergeInfo = new Map();\n    const thead = table.element.querySelector('thead');\n\n    // Return empty Map if thead doesn't exist (e.g., dynamic columns not yet loaded)\n    if (!thead) {\n      return columns;\n    }\n\n    thead.querySelectorAll('tr').forEach((tr, rowIndex) => {\n      let currentCol = 0;\n      tr.querySelectorAll('th').forEach((th, colIndex) => {\n        const field = th.dataset.field;\n        const rowspan = parseInt(th.getAttribute('rowspan') || 1);\n        const colspan = parseInt(th.getAttribute('colspan') || 1);\n\n        while (mergeInfo.has(`${rowIndex}-${currentCol}`)) {\n          currentCol++;\n        }\n\n        if (rowspan > 1 || colspan > 1) {\n          for (let r = 0; r < rowspan; r++) {\n            for (let c = 0; c < colspan; c++) {\n              mergeInfo.set(`${rowIndex + r}-${currentCol + c}`, {\n                field,\n                rowspan,\n                colspan,\n                startRow: rowIndex,\n                startCol: currentCol\n              });\n            }\n          }\n        }\n\n        if ((rowspan === thead.rows.length || rowIndex === thead.rows.length - 1) && field) {\n          const attributes = this.extractDataAttributes(th, {\n            field: '',\n            filter: '',\n            value: '',\n            type: '',\n            placeholder: '',\n            options: {},\n            datalist: {},\n            label: '',\n            min: '',\n            max: '',\n            step: '',\n            pattern: '',\n            maxLength: 0,\n            showAll: true,\n            allLabel: 'All items',\n            allValue: '',\n            formatter: '',\n            format: '',\n            class: '',\n            cellClass: '',\n            cellElement: '',\n            autocomplete: 'off',\n            template: ''\n          });\n\n          columns.set(field, {\n            ...attributes,\n            index: currentCol,\n            mergeInfo: mergeInfo.get(`${rowIndex}-${currentCol}`) || null\n          });\n        }\n\n        currentCol += colspan;\n      });\n    });\n\n    return new Map([...columns.entries()].sort((a, b) => a[1].index - b[1].index));\n  },\n\n  /**\n   * Create dynamic table headers from column metadata\n   * @param {Object} table - Table instance\n   * @param {Array} columns - Column metadata from API\n   * @returns {HTMLElement} thead element\n   */\n  createDynamicHeaders(table, columns) {\n    const thead = document.createElement('thead');\n    const tr = document.createElement('tr');\n\n    // Add checkbox column if enabled\n    if (table.config.showCheckbox) {\n      const th = document.createElement('th');\n      th.className = 'check-column';\n\n      const checkboxId = `select-all-${table.id}`;\n      const label = document.createElement('label');\n      label.htmlFor = checkboxId;\n\n      const checkbox = document.createElement('input');\n      checkbox.type = 'checkbox';\n      checkbox.className = 'select-all';\n      checkbox.id = checkboxId;\n      checkbox.setAttribute('aria-label', 'Select all');\n\n      label.appendChild(checkbox);\n      th.appendChild(label);\n      tr.appendChild(th);\n    }\n\n    // Add drag handle column if row modification with sortable is enabled\n    if (table.config.allowRowModification && table.config.rowSortable !== false) {\n      const th = document.createElement('th');\n      th.className = 'drag-handle';\n      th.style.width = '2rem';\n      tr.appendChild(th);\n    }\n\n    // Add data columns from API metadata\n    columns.forEach(col => {\n      const th = document.createElement('th');\n\n      // Required attributes\n      th.dataset.field = col.field;\n      th.textContent = col.label || col.field;\n\n      // Optional attributes - map column metadata to data attributes\n      if (col.sort !== undefined) th.dataset.sort = col.sort;\n      if (col.filter !== undefined) th.dataset.filter = col.filter;\n      if (col.type !== undefined) th.dataset.type = col.type;\n      if (col.formatter !== undefined) th.dataset.formatter = col.formatter;\n      if (col.format !== undefined) th.dataset.format = col.format;\n      // Apply class to th only\n      if (col.class !== undefined) {\n        th.className = col.class;\n      }\n\n      // Store cellClass in dataset for td rendering\n      if (col.cellClass !== undefined) {\n        th.dataset.cellClass = col.cellClass;\n      }\n      if (col.i18n !== undefined) th.dataset.i18n = '';\n      if (col.placeholder !== undefined) th.dataset.placeholder = col.placeholder;\n      if (col.template !== undefined) th.dataset.template = col.template;\n      if (col.cellElement !== undefined) th.dataset.cellElement = col.cellElement;\n      if (col.align !== undefined) th.dataset.align = col.align;\n      if (col.emptyText !== undefined) th.dataset.emptyText = col.emptyText;\n\n      // Handle options (for filter dropdowns)\n      if (col.options !== undefined) {\n        if (typeof col.options === 'object' && !Array.isArray(col.options)) {\n          th.dataset.options = JSON.stringify(col.options);\n        } else if (typeof col.options === 'string') {\n          th.dataset.options = col.options;\n        } else {\n          th.dataset.options = JSON.stringify(col.options);\n        }\n      }\n\n      // Handle datalist\n      if (col.datalist !== undefined) {\n        th.dataset.datalist = JSON.stringify(col.datalist);\n      }\n\n      // Numeric constraints\n      if (col.min !== undefined) th.dataset.min = col.min;\n      if (col.max !== undefined) th.dataset.max = col.max;\n      if (col.step !== undefined) th.dataset.step = col.step;\n      if (col.pattern !== undefined) th.dataset.pattern = col.pattern;\n      if (col.maxLength !== undefined) th.dataset.maxLength = col.maxLength;\n\n      // Filter specific options\n      if (col.showAll !== undefined) th.dataset.showAll = col.showAll;\n      if (col.allLabel !== undefined) th.dataset.allLabel = col.allLabel;\n      if (col.allValue !== undefined) th.dataset.allValue = col.allValue;\n\n      // Autocomplete\n      if (col.autocomplete !== undefined) th.dataset.autocomplete = col.autocomplete;\n\n      tr.appendChild(th);\n    });\n\n    // Add row modification actions column if enabled\n    if (table.config.allowRowModification) {\n      const th = document.createElement('th');\n      th.className = 'icons';\n      tr.appendChild(th);\n    }\n\n    // Add row actions column if defined\n    const rowActionsRaw = table.element.dataset.rowActions || table.element.dataset.rowActionsJson;\n    if (rowActionsRaw) {\n      const th = document.createElement('th');\n      th.className = 'row-actions';\n      th.textContent = table.element.dataset.rowActionsLabel || (window.Now ? Now.translate('Actions') : 'Actions');\n      tr.appendChild(th);\n    }\n\n    thead.appendChild(tr);\n    return thead;\n  },\n\n  setupFooter(table) {\n    const tfoot = table.element.querySelector('tfoot');\n    if (!tfoot) return;\n\n    const columns = this.getColumnGroups(table);\n\n    // Reset processed flags to allow re-calculation on each render\n    tfoot.querySelectorAll('td[data-processed]').forEach(td => {\n      delete td.dataset.processed;\n    });\n\n    // Add checkbox column to footer if enabled\n    if (table.config.showCheckbox) {\n      tfoot.querySelectorAll('tr').forEach(tr => {\n        // Check if checkbox column already exists\n        if (!tr.querySelector('.check-column')) {\n          const td = document.createElement('td');\n          td.className = 'check-column';\n\n          // Add checkbox if specified\n          if (tr.dataset.showCheckbox === 'true') {\n            const checkboxId = `select-all-${table.id}-footer`;\n            const label = document.createElement('label');\n            label.htmlFor = checkboxId;\n\n            const checkbox = document.createElement('input');\n            checkbox.type = 'checkbox';\n            checkbox.className = 'select-all';\n            checkbox.id = checkboxId;\n            checkbox.setAttribute('aria-label', Now.translate('Select all'));\n            checkbox.addEventListener('change', (e) => {\n              this.handleSelectAll(table, table.id, e.target.checked);\n            });\n\n            label.appendChild(checkbox);\n            td.appendChild(label);\n          }\n\n          tr.insertBefore(td, tr.firstChild);\n        }\n      });\n    }\n\n    // Process each footer row\n    tfoot.querySelectorAll('tr').forEach(tr => {\n      tr.querySelectorAll('td').forEach((td, index) => {\n        // Skip if already processed (has data-processed attribute)\n        if (td.dataset.processed === 'true') return;\n\n        // Check for aggregate functions\n        const aggregateType = Object.keys(td.dataset)\n          .find(key => ['sum', 'avg', 'count', 'min', 'max', 'custom'].includes(key));\n\n        if (!aggregateType) return;\n\n        // Handle custom aggregate function\n        if (aggregateType === 'custom') {\n          const customFn = td.dataset.custom;\n          if (customFn && window[customFn] && typeof window[customFn] === 'function') {\n            try {\n              const value = window[customFn](table.data, td, table);\n              td.textContent = value;\n            } catch (error) {\n              console.error(`Error executing custom footer function ${customFn}:`, error);\n            }\n          }\n          td.dataset.processed = 'true';\n          return;\n        }\n\n        const field = td.dataset[aggregateType];\n        if (!field) return;\n\n        // Calculate aggregate value\n        const value = this.calculateAggregate(\n          table.data,\n          field,\n          aggregateType\n        );\n\n        // Format the value\n        const format = td.dataset.format || columns[index]?.format;\n        const formattedValue = this.formatValue(value, format);\n\n        // Add prefix/suffix if specified\n        const prefix = td.dataset.prefix || '';\n        const suffix = td.dataset.suffix || '';\n        td.textContent = prefix + formattedValue + suffix;\n\n        // Apply CSS class\n        if (td.dataset.class || columns[index]?.class) {\n          td.className = (td.dataset.class || columns[index].class) + ' aggregate-cell';\n        } else {\n          td.className = 'aggregate-cell';\n        }\n\n        // Mark as processed\n        td.dataset.processed = 'true';\n      });\n    });\n\n    // Emit event for custom processing\n    EventManager.emit('table:footerSetup', {\n      tableId: table.id,\n      tfoot: tfoot,\n      data: table.data\n    });\n  },\n\n  calculateAggregate(data, field, type) {\n    if (!data?.length || !field) return 0;\n\n    const values = data\n      .map(row => parseFloat(row[field]))\n      .filter(val => !isNaN(val));\n\n    if (!values.length) return 0;\n\n    switch (type) {\n      case 'sum':\n        return values.reduce((a, b) => a + b, 0);\n      case 'avg':\n        return values.reduce((a, b) => a + b, 0) / values.length;\n      case 'count':\n        return values.length;\n      case 'min':\n        return Math.min(...values);\n      case 'max':\n        return Math.max(...values);\n      default:\n        return 0;\n    }\n  },\n\n  calculateGroupAggregate(data, fields, type) {\n    if (!data?.length || !fields?.length) return 0;\n\n    const values = data.map(row =>\n      fields.reduce((sum, field) => {\n        const val = parseFloat(row[field]);\n        return sum + (isNaN(val) ? 0 : val);\n      }, 0)\n    );\n\n    return this.calculateAggregate(values, 'value', type);\n  },\n\n  getColumnGroups(table) {\n    const groups = [];\n    const thead = table.element.querySelector('thead');\n    if (!thead || !thead.rows.length) return groups;\n\n    const lastRow = thead.rows[thead.rows.length - 1];\n    if (!lastRow) return groups;\n\n    const columns = Array.from(lastRow.cells).map(th => ({\n      field: th.dataset.field || null,\n      format: th.dataset.format || null,\n      class: th.dataset.class || null\n    }));\n\n    return columns;\n  },\n\n  updateTableCaption(table, totalRecords, totalPages) {\n    if (!table?.element || !table.config.showCaption) return;\n\n    const {pageSize, page, search} = table.config.params;\n\n    let caption = table.element.querySelector('caption');\n\n    if (!caption) {\n      caption = document.createElement('caption');\n      table.element.appendChild(caption);\n    }\n\n    let searchText = '';\n    if (search && search.length > 0) {\n      searchText = \"Search <strong>{search}</strong> found {count} entries, displayed {start} to {end}, page {page} of {total} pages\";\n    } else {\n      searchText = \"All {count} entries, displayed {start} to {end}, page {page} of {total} pages\";\n    }\n\n    const params = {\n      count: totalRecords,\n      start: (page - 1) * pageSize + 1,\n      end: Math.min(page * pageSize, totalRecords),\n      page: page,\n      total: totalPages,\n      search: search\n    };\n\n    let translated = Now.translate(searchText, params);\n\n    if (typeof translated === 'string' && /\\{[^}]+\\}/.test(translated)) {\n      try {\n        const i18n = Now.getManager ? Now.getManager('i18n') : window.I18nManager;\n        if (i18n && typeof i18n.interpolate === 'function') {\n          translated = i18n.interpolate(translated, params, i18n.getTranslations?.());\n        } else {\n          // Fallback simple interpolation\n          translated = String(translated).replace(/\\{([^}]+)\\}/g, (m, k) => {\n            return params[k] !== undefined ? params[k] : m;\n          });\n        }\n      } catch (err) {}\n    }\n\n    caption.innerHTML = translated;\n  },\n\n  filterData(table, data) {\n    if (!table || !table.config.params || Object.keys(table.config.params).length === 0) {\n      return data;\n    }\n\n    const filters = table.config.params;\n    const searchColumns = table.config.searchColumns || [];\n\n    return data.filter(item => {\n      const generalFilters = Object.entries(filters).every(([field, filterValue]) => {\n        if (['search', 'pageSize', 'page', 'total', 'summary'].includes(field)) return true;\n\n        if (filterValue === '') return true;\n\n        const value = item[field];\n        // If there's no corresponding column for this param (e.g., 'totalPages'), skip it\n        const attributes = table.columns.get(field);\n        if (!attributes) return true;\n\n        if (value === undefined || value === null) return false;\n\n        if (attributes.showAll && filterValue.toString() === attributes.allValue.toString()) return true;\n\n        const filterFn = table.element.querySelector(`th[data-field=\"${field}\"]`)?.dataset.filterFn;\n        if (filterFn && typeof window[filterFn] === 'function') {\n          return window[filterFn](value, filterValue, item);\n        }\n\n        // For text-type filters, use partial match (contains)\n        if (attributes.type === 'text') {\n          return value.toString().toLowerCase().includes(filterValue.toString().toLowerCase());\n        }\n\n        // For select and other types, use exact match\n        return value.toString() === filterValue.toString();\n      });\n\n      const searchFilter = !filters.search || searchColumns.some(column => {\n        const value = item[column];\n        if (value === undefined || value === null) return false;\n\n        return value.toString().toLowerCase()\n          .includes(filters.search.toLowerCase());\n      });\n\n      return generalFilters && searchFilter;\n    });\n  },\n\n  sortData(table, data) {\n    if (!table || !table.sortState || Object.keys(table.sortState).length === 0) {\n      return data;\n    }\n\n    return [...data].sort((a, b) => {\n      for (const [field, direction] of Object.entries(table.sortState)) {\n        const aVal = a[field];\n        const bVal = b[field];\n\n        const sorter = table.element.querySelector(`th[data-field=\"${field}\"]`)?.dataset.sorter;\n        if (sorter && typeof window[sorter] === 'function') {\n          const result = window[sorter](aVal, bVal, a, b);\n          if (result !== 0) return direction === 'asc' ? result : -result;\n          continue;\n        }\n\n        if (aVal === bVal) continue;\n\n        const result = aVal > bVal ? 1 : -1;\n        return direction === 'asc' ? result : -result;\n      }\n      return 0;\n    });\n  },\n\n  paginateData(table, data) {\n    if (!table || table.config.params.pageSize <= 0) {\n      return {pageData: data, totalPages: 1, totalRecords: data.length};\n    }\n\n    const {pageSize, page} = table.config.params;\n    const start = (page - 1) * pageSize;\n    let pageData;\n    if (table.serverSide) {\n      // Assume server returned the page's rows already\n      pageData = data;\n    } else {\n      pageData = data.slice(start, start + pageSize);\n    }\n\n    // If server provided a total (via meta), use it; otherwise derive from data length\n    const totalRecords = parseInt(table.config.params.total || data.length || 0);\n    const totalPages = pageSize > 0 ? Math.max(1, Math.ceil(totalRecords / pageSize)) : 1;\n\n    return {pageData, totalPages, totalRecords};\n  },\n\n  updatePagination(table, tableId, totalRecords, totalPages) {\n    if (!table) return;\n\n    table.paginationWrapper.innerHTML = '';\n\n    if (totalPages > 1) {\n      let startPage = Math.max(1, table.config.params.page - 2);\n      let endPage = Math.min(totalPages, startPage + 4);\n\n      if (endPage - startPage < 4) {\n        startPage = Math.max(1, endPage - 4);\n      }\n\n      if (startPage > 1) {\n        this.addPaginationButton(table, tableId, 1, '1', table.config.params.page);\n      }\n\n      for (let i = startPage; i <= endPage; i++) {\n        this.addPaginationButton(table, tableId, i, i, table.config.params.page);\n      }\n\n      if (endPage < totalPages) {\n        this.addPaginationButton(table, tableId, totalPages, totalPages, table.config.params.page);\n      }\n    }\n\n    this.updateTableCaption(table, totalRecords, totalPages);\n  },\n\n  addPaginationButton(table, tableId, page, text, currentPage) {\n    const button = document.createElement('button');\n    button.textContent = text;\n    button.setAttribute('type', 'button');\n\n    if (page !== currentPage) {\n      button.classList.add('pagination-button');\n      button.setAttribute('aria-label', Now.translate('Go to page {page}', {page}));\n      button.onclick = (e) => {\n        e.preventDefault();\n        this.handleFilterChange(table, tableId, 'page', parseInt(page));\n      };\n    } else {\n      button.disabled = true;\n      button.setAttribute('aria-current', 'page');\n    }\n\n    table.paginationWrapper.appendChild(button);\n  },\n\n  renderCell(table, tableId, row, field, attributes, rowData, index) {\n    const cell = document.createElement('td');\n    cell.dataset.field = field;\n    let value = rowData[field];\n\n    const normalizeValue = (v) => {\n      if (v === null || v === undefined) return v;\n      if (typeof v === 'object') {\n        if (v.text !== undefined) return v.text;\n        if (v.html !== undefined) return v.html;\n        if (v.value !== undefined) return v.value;\n        return JSON.stringify(v);\n      }\n      return v;\n    };\n\n    const rawValue = value;\n    const primValue = normalizeValue(value);\n\n    try {\n      // Setup cell attributes\n      if (attributes.cellClass) {\n        cell.className = attributes.cellClass;\n      }\n\n      if (attributes.align) {\n        cell.style.textAlign = attributes.align;\n      }\n\n      // Handle null or undefined values\n      if (primValue === null || primValue === undefined) {\n        cell.textContent = attributes.emptyText || '';\n        row.appendChild(cell);\n        return;\n      }\n\n      // Handle different render types\n      if (attributes.cellElement && attributes.cellElement !== '') {\n        // Render as interactive element\n        this.renderElementCell(cell, table, tableId, field, attributes, rowData, index);\n      } else if (attributes.formatter && typeof window[attributes.formatter] === 'function') {\n        // Custom formatter function - pass rawValue and primValue for flexibility\n        window[attributes.formatter](cell, rawValue, rowData, attributes);\n      } else if (attributes.format) {\n        // Built-in formatter - look up options in priority order:\n        // 1. API response options (table.dataOptions)\n        // 2. Filter options (table.filterOptions)\n        // 3. HTML data-options (attributes.options)\n        const lookupOptions = table.dataOptions?.[field] || table.filterOptions?.[field] || attributes.options;\n        cell.textContent = this.formatValue(primValue, attributes.format, lookupOptions);\n      } else if (attributes.template) {\n        // Template-based rendering\n        // 1) Replace ${key} placeholders with row values\n        let template = attributes.template.replace(/\\${(\\w+)}/g, (match, key) => {\n          const v = rowData[key];\n          return v !== undefined ? normalizeValue(v) : match;\n        });\n\n        // 2) Run i18n interpolation on the resulting HTML string so tokens like\n        //    {LNG_*} (including patterns formed like {LNG_${status_text}}) are resolved\n        try {\n          const i18n = window.Now && Now.getManager ? Now.getManager('i18n') : null;\n          if (i18n && typeof i18n.interpolate === 'function') {\n            template = i18n.interpolate(template);\n          } else if (window.Now && typeof Now.translate === 'function') {\n            // Fallback: if translate exists but no interpolate, attempt a best-effort\n            // Translate plain tokens that match exactly one token inside the template\n            // (not ideal for full HTML, but better than nothing)\n            // Only translate when the template is simple text\n            const plain = template.replace(/^\\s+|\\s+$/g, '');\n            if (!plain.includes('<') && plain.startsWith('{LNG_') && plain.endsWith('}')) {\n              template = Now.translate(plain.slice(1, -1));\n            }\n          }\n        } catch (e) {\n          // Ignore i18n errors and fall back to raw template\n        }\n\n        // 2.5) If TemplateManager is available, process the template string so it can use\n        // its directives/interpolation and sanitization with the current row context\n        try {\n          const tm = window.TemplateManager;\n          if (!tm || typeof tm.processTemplateString !== 'function') {\n            throw new Error('TemplateManager.processTemplateString not available');\n          }\n\n          const container = document.createElement('div');\n          const context = {\n            state: {data: rowData},\n            data: rowData,\n            skipScan: true // avoid re-scanning element/form managers inside table cells\n          };\n          tm.processTemplateString(template, context, container);\n          template = container.innerHTML;\n        } catch (e) {\n          const message = `Template error: ${e.message || e}`;\n          // Surface visibly in cell and log for developers\n          template = `<span class=\"template-error\" title=\"${message}\">${message}</span>`;\n          try {\n            ErrorManager.handle(message, {\n              context: 'TableManager.renderCell.template',\n              data: {field, template: attributes.template, error: e}\n            });\n          } catch (logErr) {\n            console.error(message, e);\n          }\n        }\n\n        // 3) Insert HTML\n        cell.innerHTML = template;\n\n        // 4) Immediately translate any elements inside the inserted HTML that carry data-i18n\n        try {\n          const i18n = window.Now && Now.getManager ? Now.getManager('i18n') : null;\n          // Query for elements with data-i18n attribute inside this cell\n          const els = cell.querySelectorAll('[data-i18n]');\n          els.forEach(el => {\n            const originalAttr = el.getAttribute('data-i18n');\n            const attr = originalAttr;\n            // Preserve original i18n key for later re-translation\n            if (originalAttr !== null && originalAttr !== undefined) {\n              try {el.dataset.i18n = originalAttr;} catch (e) { /* ignore */}\n            }\n            // If attribute is empty (just presence), translate current textContent\n            if (attr === '' || attr === null) {\n              if (typeof Now !== 'undefined' && typeof Now.translate === 'function') {\n                el.textContent = Now.translate(el.textContent || '');\n              }\n            } else {\n              // Attribute has a value (possibly produced by ${...}); use it as the key\n              // If i18n.interpolate exists, run it so tokens are resolved; otherwise use Now.translate\n              let key = attr;\n              if (i18n && typeof i18n.interpolate === 'function') {\n                try {key = i18n.interpolate(key);} catch (e) { /* ignore */}\n              }\n              if (typeof Now !== 'undefined' && typeof Now.translate === 'function') {\n                el.textContent = Now.translate(key);\n              } else {\n                // Fallback: set to interpolated value\n                el.textContent = key;\n              }\n            }\n          });\n        } catch (e) {\n          // ignore translation errors for cell post-processing\n        }\n      } else {\n        // Default rendering - prefer HTML when original value had an html property\n        if (rawValue && typeof rawValue === 'object' && rawValue.html !== undefined) {\n          cell.innerHTML = rawValue.html;\n        } else {\n          cell.textContent = primValue;\n        }\n      }\n\n      // Add any data attributes\n      if (attributes.dataAttributes) {\n        Object.entries(attributes.dataAttributes).forEach(([attr, val]) => {\n          const attrValue = typeof val === 'function' ? val(rowData) : val;\n          cell.dataset[attr] = attrValue;\n        });\n      }\n\n      // Add any event handlers directly to the cell\n      if (attributes.events) {\n        Object.entries(attributes.events).forEach(([event, handler]) => {\n          cell.addEventListener(event, (e) => handler(e, rowData, cell, table));\n        });\n      }\n\n      row.appendChild(cell);\n    } catch (error) {\n      this.handleError('Rendering cell failed', error, 'renderCell');\n      // Fallback to simple text rendering\n      cell.textContent = value !== undefined ? value : '';\n      row.appendChild(cell);\n    }\n  },\n\n  translateValue(value) {\n    try {\n      const i18n = window.Now && Now.getManager ? Now.getManager('i18n') : null;\n      if (i18n && typeof i18n.interpolate === 'function') {\n        return i18n.interpolate(value);\n      }\n      if (typeof Now !== 'undefined' && typeof Now.translate === 'function') {\n        return Now.translate(value);\n      }\n    } catch (e) {}\n    return value;\n  },\n\n  retranslateFilter(table) {\n    if (!table) return;\n\n    const config = table.config || {};\n\n    // Internal filter UI (ElementManager-built)\n    if (table.filterElements && table.filterElements instanceof Map) {\n      // Search placeholder\n      const searchObj = table.filterElements.get('search');\n      if (searchObj?.element && Array.isArray(config.searchColumns) && config.searchColumns.length) {\n        searchObj.element.placeholder = `${Now.translate('Search in')}: ${config.searchColumns.join(', ')}`;\n      }\n    }\n  },\n\n  renderElementCell(cell, table, tableId, field, attributes, rowData, index) {\n    const elementManager = Now.getManager('element');\n    const value = rowData[field];\n\n    if (!elementManager) {\n      cell.textContent = value || '';\n      return;\n    }\n\n    let elementType = attributes.cellElement;\n    let config = this.getElementConfig(table, tableId, field, attributes, rowData, index);\n\n    if (!config) {\n      cell.textContent = value;\n      return;\n    }\n\n    try {\n      // Create the element using ElementManager\n      const element = elementManager.create(elementType, config);\n\n      if (element && element.element) {\n        // Store element ID for later reference\n        cell.dataset.elementId = element.element.id;\n\n        // Append the element or its wrapper to the cell\n        if (element.wrapper) {\n          cell.appendChild(element.wrapper);\n        } else {\n          cell.appendChild(element.element);\n        }\n\n        // Track the element in table state for cleanup\n        if (!table.elementInstances) {\n          table.elementInstances = new Map();\n        }\n        table.elementInstances.set(element.element.id, element);\n      } else {\n        // Fallback if element creation failed\n        cell.textContent = value;\n      }\n    } catch (error) {\n      console.error('Failed to create element in cell:', error);\n      cell.textContent = value;\n    }\n  },\n\n  getElementConfig(table, tableId, field, attributes, rowData, index) {\n    // Allow using data-type as a shorthand for data-cell-element.\n    if (!attributes.cellElement && attributes.type) {\n      attributes.cellElement = attributes.type;\n    }\n    if (!attributes.cellElement) return null;\n\n    // Base configuration common to all elements\n    const rawValue = rowData[field];\n    const normalizeValue = (v) => {\n      if (v === null || v === undefined) return v;\n      if (typeof v === 'object') {\n        if (v.value !== undefined) return v.value;\n        if (v.text !== undefined) return v.text;\n        if (v.html !== undefined) return v.html;\n        return JSON.stringify(v);\n      }\n      return v;\n    };\n    const value = normalizeValue(rawValue);\n    const config = {\n      type: attributes.cellElement,\n      name: `${field}[${rowData.id || index}]`,\n      id: `${tableId}_${field}_${rowData.id || index}`, // Predictable format for error highlighting\n      wrapper: attributes.wrapper || 'div',\n      value: value,\n      autocomplete: attributes.autocomplete || 'off',\n      className: attributes.class,\n      readOnly: attributes.readOnly,\n      disabled: attributes.disabled,\n      required: attributes.required,\n      placeholder: attributes.placeholder || attributes.label\n    };\n\n    // Element-specific configurations\n    switch (attributes.cellElement) {\n      case 'select':\n        // Handle select element. options can come from several places:\n        config.options = (table.filterOptions && table.filterOptions[field]) || attributes.options || {};\n        if (typeof config.options === 'string' && window[config.options]) {\n          config.options = window[config.options];\n        }\n        config.multiple = attributes.multiple;\n        config.allowEmpty = attributes.allowEmpty !== false;\n        break;\n\n      case 'text':\n      case 'email':\n      case 'url':\n      case 'password':\n        // Text-like elements\n        if (attributes.minLength !== undefined && attributes.minLength !== null && attributes.minLength !== '') {\n          const parsedMin = parseInt(attributes.minLength, 10);\n          if (!isNaN(parsedMin) && parsedMin >= 0) config.minLength = parsedMin;\n        }\n        if (attributes.maxLength !== undefined && attributes.maxLength !== null && attributes.maxLength !== '') {\n          const parsedMax = parseInt(attributes.maxLength, 10);\n          if (!isNaN(parsedMax) && parsedMax > 0) config.maxLength = parsedMax;\n        }\n        config.pattern = attributes.pattern;\n        config.autocomplete = attributes.autocomplete || config.type;\n        // Add datalist if provided\n        if (attributes.datalist) {\n          config.datalist = attributes.datalist;\n        }\n        break;\n\n      case 'number':\n        // Number input\n        config.min = attributes.min;\n        config.max = attributes.max;\n        config.step = attributes.step || 1;\n        break;\n\n      case 'textarea':\n        // Textarea\n        config.rows = attributes.rows || 3;\n        config.cols = attributes.cols;\n        config.resizable = attributes.resizable !== false;\n        break;\n\n      case 'date':\n      case 'time':\n      case 'datetime-local':\n        // Date/time inputs\n        config.min = attributes.min;\n        config.max = attributes.max;\n        config.format = attributes.format;\n        break;\n\n      case 'color':\n        // Color input - ensure value is in #RRGGBB format\n        if (config.value && !config.value.startsWith('#')) {\n          config.value = '#' + config.value;\n        }\n        // Ensure uppercase for consistency\n        if (config.value) {\n          config.value = config.value.toUpperCase();\n        }\n        break;\n\n      case 'file':\n        // File upload\n        config.accept = attributes.accept;\n        config.multiple = attributes.multiple;\n        config.maxFileSize = attributes.maxFileSize;\n        config.preview = attributes.preview;\n        break;\n\n      case 'checkbox':\n      case 'radio':\n        // Checkbox/radio\n        config.checked = value === true || value === '1' || value === 'true';\n        if (attributes.options) {\n          config.options = attributes.options;\n        }\n        break;\n\n      case 'search':\n        // Search element\n        config.minLength = attributes.minLength || 2;\n        config.delay = attributes.delay || 300;\n        if (attributes.source) {\n          config.source = attributes.source;\n        }\n        config.onSearch = attributes.onSearch;\n        break;\n    }\n\n    // Add validators if specified\n    if (attributes.validate) {\n      config.validate = attributes.validate;\n    }\n\n    // Add formatter if specified\n    if (attributes.formatter) {\n      config.formatter = attributes.formatter;\n    }\n\n    return config;\n  },\n\n  cleanupTableResources(tableId) {\n    try {\n      const table = this.state.tables.get(tableId);\n      if (!table) return;\n\n      // Cleanup external filter form handlers\n      if (table._externalFilterCleanup && Array.isArray(table._externalFilterCleanup)) {\n        table._externalFilterCleanup.forEach(cleanup => {\n          try {\n            cleanup();\n          } catch (err) {\n            console.warn('External filter cleanup error:', err);\n          }\n        });\n        table._externalFilterCleanup = [];\n      }\n\n      // Cleanup event handlers\n      if (table.eventHandlers) {\n        // Cleanup sort handlers\n        if (table.eventHandlers.sort instanceof Map) {\n          table.eventHandlers.sort.forEach((handlers, th) => {\n            th.removeEventListener('click', handlers.sort);\n            th.removeEventListener('keydown', handlers.key);\n          });\n        }\n\n        // Cleanup other handlers\n        if (table.eventHandlers.keyboard) {\n          table.element.removeEventListener('keydown', table.eventHandlers.keyboard);\n        }\n\n        // Remove delegation listeners if present\n        if (table.eventHandlers.delegation && table.element) {\n          const tbody = table.element.querySelector('tbody');\n          if (tbody) {\n            tbody.removeEventListener('click', table.eventHandlers.delegation.click);\n            tbody.removeEventListener('change', table.eventHandlers.delegation.change);\n          }\n        }\n\n        if (table.eventHandlers.filterWrapperChange && table.filterWrapper) {\n          table.filterWrapper.removeEventListener('change', table.eventHandlers.filterWrapperChange);\n        }\n\n        // Remove action button handler if present\n        if (table.eventHandlers.actionButton && table.actionElements && table.actionElements.submit && table.actionElements.submit.element) {\n          table.actionElements.submit.element.removeEventListener('click', table.eventHandlers.actionButton);\n          delete table.eventHandlers.actionButton;\n        }\n\n        table.eventHandlers = {};\n      }\n\n      // Cleanup elements created by the table\n      if (table.elementInstances) {\n        if (table.elementInstances instanceof Map) {\n          table.elementInstances.forEach((instance, id) => {\n            const elementManager = Now.getManager('element');\n            if (elementManager) {\n              elementManager.destroy(id);\n            }\n          });\n          table.elementInstances.clear();\n        }\n      }\n\n      // Cleanup filter elements\n      if (table.filterElements) {\n        if (table.filterElements instanceof Map) {\n          table.filterElements.forEach((element) => {\n            if (element && element.element && element.element.id) {\n              const elementManager = Now.getManager('element');\n              if (elementManager) {\n                elementManager.destroy(element.element.id);\n              }\n            }\n          });\n          table.filterElements.clear();\n        }\n      }\n\n      // Remove DOM elements\n      ['filterWrapper', 'actionWrapper', 'paginationWrapper'].forEach(wrapper => {\n        if (table[wrapper]) {\n          table[wrapper].remove();\n          table[wrapper] = null;\n        }\n      });\n\n      // Clear data\n      table.data = null;\n      if (table.columns && table.columns.clear) table.columns.clear();\n      if (table.filterData && table.filterData.clear) table.filterData.clear();\n\n      // Clear filterOptions (can be Map or Object)\n      if (table.filterOptions) {\n        if (table.filterOptions instanceof Map) {\n          table.filterOptions.clear();\n        } else {\n          table.filterOptions = {};\n        }\n      }\n\n      // Clear dataOptions (Object)\n      if (table.dataOptions) {\n        table.dataOptions = {};\n      }\n\n      // Clear sort state\n      table.sortable = null;\n\n      // Clear cache\n      this.clearTableCache(tableId);\n\n      // Remove table attributes\n      if (table.element) {\n        table.element.removeAttribute('data-table-initialized');\n        table.element.classList.remove('table-initialized');\n      }\n\n      // Remove table state binding\n      if (table.unsubscribe) {\n        table.unsubscribe();\n        table.unsubscribe = null;\n      }\n\n    } catch (error) {\n      this.handleError('Failed to cleanup table resources', error, 'cleanup');\n    }\n  },\n\n  // Delegated event handlers\n  _handleDelegatedClick(e, tableId) {\n    const table = this.state.tables.get(tableId);\n    if (!table) return;\n\n    const btn = e.target.closest('[data-action]');\n    if (btn && table.element.contains(btn)) {\n      e.preventDefault();\n      const action = btn.dataset.action;\n      const params = btn.dataset.params ? JSON.parse(btn.dataset.params) : null;\n      const tr = btn.closest('tr');\n      const id = tr?.dataset?.id;\n      const row = id ? this.getRowObjectById(tableId, id) : null;\n      const actionUrl = table.element.dataset.actionUrl || table.config.actionUrl;\n\n      // always route data operations to table actionUrl\n      this._executeRowAction(tableId, actionUrl, row || {}, action, {...(params || {})});\n      return;\n    }\n\n    // handle buttons inside action cell without data-action (icons etc.)\n    const iconBtn = e.target.closest('button, a');\n    if (iconBtn && table.element.contains(iconBtn)) {\n      // if it has data-field or data-action via other attrs, treat accordingly\n      const action = iconBtn.dataset.action;\n      if (action) {\n        e.preventDefault();\n        const tr = iconBtn.closest('tr');\n        const id = tr?.dataset?.id;\n        const row = id ? this.getRowObjectById(tableId, id) : null;\n        const actionUrl = table.element.dataset.actionUrl || table.config.actionUrl;\n        this._executeRowAction(tableId, actionUrl, row || {}, action, {});\n      }\n    }\n  },\n\n  _handleDelegatedChange(e, tableId) {\n    const table = this.state.tables.get(tableId);\n    if (!table) return;\n\n    const target = e.target;\n    if (!table.element.contains(target)) return;\n\n    // Find field attribute\n    const fieldEl = target.closest('[data-field]') || target;\n    const field = fieldEl.dataset.field || fieldEl.name || fieldEl.dataset.name;\n\n    if (field) {\n      const tr = target.closest('tr');\n      const id = tr?.dataset?.id;\n      const row = id ? this.getRowObjectById(tableId, id) : null;\n\n      // Do not treat header/select-all checkboxes as row-level field updates\n      if (target.classList && target.classList.contains('select-all')) return;\n\n      let value;\n      if (target.type === 'checkbox') value = target.checked ? '1' : '0';\n      else if (target.type === 'radio') {\n        const checked = target.closest('tr')?.querySelector(`input[name=\"${target.name}\"]:checked`);\n        value = checked ? checked.value : null;\n      } else {\n        value = target.value;\n      }\n\n      const shouldSend = true;\n\n      this.handleFieldChange(table, tableId, field, value, row, target, {send: shouldSend});\n    }\n  },\n\n  // Helper to get selected row ids (from tbody .select-row checkboxes)\n  getSelectedRowIds(table) {\n    if (!table || !table.element) return [];\n    const checked = table.element.querySelectorAll('tbody .select-row:checked');\n    return Array.from(checked).map(cb => cb.value);\n  },\n\n  _performActionWrapperSubmission(tableId) {\n    const table = this.state.tables.get(tableId);\n    if (!table) return;\n\n    const selectInfo = table.actionElements?.select;\n    const submitInfo = table.actionElements?.submit;\n    const actionUrl = table.element.dataset.actionUrl || table.config.actionUrl;\n\n    if (!selectInfo || !submitInfo) return;\n\n    const selectEl = selectInfo.element;\n    const selectedAction = selectEl ? selectEl.value : null;\n\n    // Validate that an action is selected (not empty value)\n    if (!selectedAction || selectedAction === '') {\n      NotificationManager.warning('Please select an action');\n      return;\n    }\n\n    const ids = this.getSelectedRowIds(table);\n    if (!ids || ids.length === 0) {\n      NotificationManager.warning('Please select at least one row');\n      return;\n    }\n\n    // Parse action key with pipe separator (e.g., \"stage|lead\" -> action=stage, stage=lead)\n    const data = {ids: ids};\n    if (selectedAction.includes('|')) {\n      const [actionName, actionValue] = selectedAction.split('|', 2);\n      data.action = actionName;\n      data[actionName] = actionValue;\n    } else {\n      data.action = selectedAction;\n    }\n\n    // sendAction will handle UI feedback\n    this.sendAction(actionUrl, data, tableId, submitInfo.element).catch(err => console.error('Action submit error', err));\n  },\n\n  setupColumnResizing(tableId) {\n    const tableObj = this.state.tables.get(tableId);\n    if (!tableObj || !tableObj.element) return;\n    if (!tableObj.config.persistColumnWidths) return;\n\n    const tableEl = tableObj.element;\n    const thead = tableEl.querySelector('thead');\n    if (!thead) return;\n\n    // Load saved widths if present\n    try {\n      const saved = localStorage.getItem(`table_${tableId}_columns`);\n      if (saved) {\n        const widths = JSON.parse(saved);\n        const cols = thead.querySelectorAll('th');\n        cols.forEach((th, idx) => {\n          if (widths[idx]) th.style.width = widths[idx];\n        });\n      }\n    } catch (err) {\n      // ignore\n    }\n\n    // Add simple resizer handles to last row headers\n    const headers = thead.querySelectorAll('th');\n    headers.forEach((th, idx) => {\n      // Skip if already has resizer\n      if (th.querySelector('.col-resizer')) return;\n\n      const resizer = document.createElement('div');\n      resizer.className = 'col-resizer';\n      resizer.setAttribute('role', 'separator');\n      resizer.style.position = 'absolute';\n      resizer.style.top = '0';\n      resizer.style.right = '0';\n      resizer.style.width = '6px';\n      resizer.style.cursor = 'col-resize';\n      resizer.style.userSelect = 'none';\n      resizer.style.height = '100%';\n      resizer.style.zIndex = '5';\n\n      th.appendChild(resizer);\n\n      let startX = 0;\n      let startWidth = 0;\n\n      const onMouseDown = (e) => {\n        e.preventDefault();\n        startX = e.clientX;\n        startWidth = th.offsetWidth;\n        document.addEventListener('mousemove', onMouseMove);\n        document.addEventListener('mouseup', onMouseUp);\n      };\n\n      const onMouseMove = (e) => {\n        const dx = e.clientX - startX;\n        const newWidth = Math.max(30, startWidth + dx);\n        th.style.width = `${newWidth}px`;\n      };\n\n      const onMouseUp = (e) => {\n        document.removeEventListener('mousemove', onMouseMove);\n        document.removeEventListener('mouseup', onMouseUp);\n\n        // save widths\n        try {\n          const cols = Array.from(thead.querySelectorAll('th'));\n          const widths = cols.map(c => c.style.width || window.getComputedStyle(c).width);\n          localStorage.setItem(`table_${tableId}_columns`, JSON.stringify(widths));\n        } catch (err) {\n          console.warn('Failed to persist column widths', err);\n        }\n      };\n\n      resizer.addEventListener('mousedown', onMouseDown);\n    });\n  },\n\n  getRowObjectById(tableId, id) {\n    const table = this.state.tables.get(tableId);\n    if (!table || !table.data) return null;\n    return table.data.find(r => String(r.id) === String(id)) || null;\n  },\n\n  clearTableCache(tableId) {\n    try {\n      const table = this.state.tables.get(tableId);\n      if (!table) return;\n\n      if (table.config.persistColumnWidths) {\n        localStorage.removeItem(`table_${tableId}_columns`);\n      }\n\n      localStorage.removeItem(`table_${tableId}_filters`);\n\n      localStorage.removeItem(`table_${tableId}_sort`);\n\n      localStorage.removeItem(`table_${tableId}_page`);\n\n    } catch (error) {\n      this.handleError('Clear table cache', error, 'clearCache');\n    }\n  },\n\n  destroyTable(tableId) {\n    try {\n      this.cleanupTableResources(tableId);\n\n      this.state.tables.delete(tableId);\n\n      EventManager.emit('table:destroyed', {\n        tableId,\n        timestamp: Date.now()\n      });\n    } catch (error) {\n      this.handleError('Destroy table', error, 'destroy');\n    }\n  },\n\n  destroy() {\n    try {\n      this.state.tables.forEach((_, tableId) => {\n        this.destroyTable(tableId);\n      });\n\n      this.state.tables.clear();\n\n      if (this.dynamicObserver) {\n        this.dynamicObserver.disconnect();\n        this.dynamicObserver = null;\n      }\n\n      EventManager.off('locale:changed');\n\n      if (this.globalEventHandlers) {\n        Object.entries(this.globalEventHandlers).forEach(([event, handler]) => {\n          window.removeEventListener(event, handler);\n        });\n        this.globalEventHandlers = null;\n      }\n\n      this.resetState();\n\n      EventManager.emit('tablemanager:destroyed', {\n        timestamp: Date.now()\n      });\n    } catch (error) {\n      this.handleError('Error during TableManager destruction', error, 'destroy');\n    }\n  },\n\n  bindToState(tableId, statePath) {\n    if (!tableId || !statePath) {\n      return this.handleError('Invalid parameters for bindToState', null, 'bindToState');\n    }\n\n    try {\n      const table = this.state.tables.get(tableId);\n      if (!table) {\n        return this.handleError(`Table ${tableId} not found`, null, 'bindToState');\n      }\n\n      if (!statePath.startsWith('state.')) {\n        // Skip loading data during initialization - will be handled by initTable\n        if (!table.initializing) {\n          this.loadTableData(tableId);\n        }\n        return true;\n      }\n\n      const stateManager = Now.getManager('state');\n      if (!stateManager) {\n        console.warn('[TableManager] StateManager not found, loading data from other source');\n        // Skip loading data during initialization - will be handled by initTable\n        if (!table.initializing) {\n          this.loadTableData(tableId);\n        }\n        return true;\n      }\n\n      if (!stateManager.get(statePath)) {\n        console.warn(`[TableManager] Data not found at path \"${statePath}\"`);\n      }\n\n      if (table.unsubscribe) {\n        table.unsubscribe();\n        table.unsubscribe = null;\n      }\n\n      const unsubscribe = stateManager.subscribe(statePath, (newData) => {\n        const data = Array.isArray(newData) ? newData : [];\n        this.setData(tableId, data);\n        EventManager.emit('table:stateUpdate', {\n          tableId,\n          statePath,\n          recordCount: data.length,\n          timestamp: Date.now()\n        });\n      });\n\n      table.unsubscribe = unsubscribe;\n      table.statePath = statePath;\n\n      const initialData = stateManager.get(statePath);\n      if (initialData) {\n        this.setData(tableId, Array.isArray(initialData) ? initialData : []);\n      }\n\n      EventManager.emit('table:bound', {\n        tableId,\n        statePath,\n        timestamp: Date.now()\n      });\n\n      return true;\n\n    } catch (error) {\n      return this.handleError(`Error binding table ${tableId}`, error, 'bindToState');\n    }\n  },\n\n  setupDynamicTableObserver() {\n    if (!window.MutationObserver) return;\n\n    const observer = new MutationObserver((mutations) => {\n      mutations.forEach((mutation) => {\n        mutation.addedNodes.forEach((node) => {\n          if (node.nodeType === 1) {\n            if (node.matches('table[data-table]')) {\n              this.initTable(node);\n            }\n            if (node.querySelectorAll) {\n              node.querySelectorAll('table[data-table]').forEach(table => {\n                this.initTable(table);\n              });\n            }\n          }\n        });\n\n        mutation.removedNodes.forEach((node) => {\n          if (node.nodeType === 1) {\n            // Wait for DOM operations to settle before cleanup\n            // This prevents premature cleanup when nodes are moved in DOM\n            setTimeout(() => {\n              if (node.matches && node.matches('table[data-table]')) {\n                if (!node.isConnected) {\n                  const tableId = node.dataset.table;\n                  if (tableId) {\n                    this.destroyTable(tableId);\n                  }\n                }\n              }\n              if (node.querySelectorAll) {\n                node.querySelectorAll('table[data-table]').forEach(table => {\n                  if (!table.isConnected) {\n                    const tableId = table.dataset.table;\n                    if (tableId) {\n                      this.destroyTable(tableId);\n                    }\n                  }\n                });\n              }\n            }, 0);\n          }\n        });\n      });\n    });\n\n    observer.observe(document.body, {\n      childList: true,\n      subtree: true\n    });\n\n    this.dynamicObserver = observer;\n  },\n\n  handleError(message, error, type) {\n    const errorObj = error || new Error(message);\n\n    return ErrorManager.handle(errorObj, {\n      context: `TableManager.${type}`,\n      type: 'error:table',\n      data: {\n        message,\n        error: error ? {\n          name: error.name,\n          message: error.message,\n          stack: error.stack\n        } : null,\n        tableId: this.currentTableId\n      },\n      notify: true\n    });\n  },\n\n  setupTouchEvents(table) {\n    if (!('ontouchstart' in window)) return;\n\n    let startX, startY, touchStartTime;\n    let longPressTimer;\n\n    table.addEventListener('touchstart', (e) => {\n      const touch = e.touches[0];\n      startX = touch.clientX;\n      startY = touch.clientY;\n      touchStartTime = Date.now();\n\n      longPressTimer = setTimeout(() => {\n        const row = e.target.closest('tr');\n        if (row) {\n          const checkbox = row.querySelector('.select-all');\n          if (checkbox) {\n            checkbox.checked = !checkbox.checked;\n            this.updateSelectedRows(table);\n          }\n        }\n      }, 500);\n    });\n\n    table.addEventListener('touchmove', (e) => {\n      const touch = e.touches[0];\n      const deltaX = Math.abs(touch.clientX - startX);\n      const deltaY = Math.abs(touch.clientY - startY);\n\n      if (deltaX > 10 || deltaY > 10) {\n        clearTimeout(longPressTimer);\n      }\n    });\n\n    table.addEventListener('touchend', (e) => {\n      clearTimeout(longPressTimer);\n\n      const touchDuration = Date.now() - touchStartTime;\n      const touch = e.changedTouches[0];\n      const deltaX = Math.abs(touch.clientX - startX);\n      const deltaY = Math.abs(touch.clientY - startY);\n\n      if (touchDuration < 300 && deltaX < 10 && deltaY < 10) {\n        const row = e.target.closest('tr');\n        if (row && !e.target.closest('.select-all')) {\n          const checkbox = row.querySelector('.select-all');\n          if (checkbox) {\n            checkbox.checked = !checkbox.checked;\n            this.updateSelectedRows(table);\n          }\n        }\n      }\n    });\n\n    table.addEventListener('touchcancel', () => {\n      clearTimeout(longPressTimer);\n    });\n  },\n\n  setupActions(table, tableId) {\n    if (!table?.actionWrapper) return;\n\n    // Clear existing actions\n    table.actionWrapper.innerHTML = '';\n\n    const elementManager = Now.getManager('element');\n    if (!elementManager) return;\n\n    // If no bulk row actions defined, return\n    if (table.config.actionUrl !== '' && Object.keys(table.config.actions).length > 0) {\n      // Create the action select dropdown with placeholder as first option\n      const selectLabel = table.element.dataset.actionSelectLabel || table.config.actionSelectLabel || 'Please select';\n      const actionOptions = {\n        '': selectLabel, // Empty value with translatable label\n        ...table.config.actions\n      };\n\n      const select = elementManager.create('select', {\n        id: `select_action_${tableId}`,\n        options: actionOptions,\n        value: '', // Set default to empty\n        wrapper: 'div'\n      });\n\n      // Create the action button data-action-button=\"Process|btn-success\" (Text|Class)\n      let actionButtonConfig = table.element.dataset.actionButton || table.config.actionButton || 'Process';\n      if (typeof actionButtonConfig === 'string') {\n        const parsed = actionButtonConfig.split('|');\n        if (parsed.length) {\n          actionButtonConfig = {\n            value: parsed[0],\n            className: parsed[1] || 'btn-info'\n          };\n        }\n      }\n\n      const button = elementManager.create('button', {\n        id: `action_button_${tableId}`,\n        type: 'button',\n        value: actionButtonConfig.value || 'Process',\n        className: `btn ${actionButtonConfig.className || 'btn-info'}`,\n        wrapper: 'div',\n        disabled: true\n      });\n      button.element.dataset.i18n = actionButtonConfig.value || 'Process';\n\n      // Add elements to action wrapper\n      if (select && button) {\n        table.actionWrapper.appendChild(select.wrapper);\n        table.actionWrapper.appendChild(button.wrapper);\n\n        // Store references to action elements\n        table.actionElements = {\n          select: {\n            element: select.element,\n            id: select.element.id\n          },\n          submit: {\n            element: button.element,\n            id: button.element.id\n          }\n        };\n\n        // Disable button when no rows selected\n        EventManager.on('table:selectionChange', (event) => {\n          if (event.data.tableId === tableId) {\n            button.element.disabled = !event.data.selectedRows || event.data.selectedRows.length === 0;\n          }\n        });\n      }\n    }\n\n    // Setup filter actions first (table-level actions with filters)\n    // This runs regardless of whether bulk row actions are defined\n    this.setupFilterActions(table, tableId);\n  },\n\n  /**\n   * Setup filter-based actions (buttons/links that include current filters)\n   * Configuration via data-filter-actions attribute:\n   * data-filter-actions='{\n   *   \"export\": {\"label\": \"Export\", \"url\": \"api/export\", \"type\": \"button\", \"className\": \"btn-primary\"},\n   *   \"report\": {\"label\": \"View Report\", \"url\": \"/reports\", \"type\": \"link\", \"className\": \"btn-info\"}\n   * }'\n   */\n  setupFilterActions(table, tableId) {\n    const filterActionsRaw = table.element.dataset.filterActions;\n    if (!filterActionsRaw) return;\n\n    let filterActions;\n    try {\n      filterActions = JSON.parse(filterActionsRaw);\n    } catch (e) {\n      console.warn('Invalid data-filter-actions JSON:', e);\n      return;\n    }\n\n    if (!filterActions || typeof filterActions !== 'object') return;\n\n    Object.entries(filterActions).forEach(([key, config]) => {\n      const {\n        label = key,\n        url,\n        type = 'button',\n        className = '',\n        method = 'POST',\n        target = '_self',\n        confirm: confirmMessage\n      } = config;\n\n      if (!url) {\n        console.warn(`Filter action \"${key}\" missing URL`);\n        return;\n      }\n\n      if (type === 'link') {\n        // Create link element\n        const link = document.createElement('a');\n        link.className = `btn ${className}`.trim();\n        link.textContent = Now.translate(label);\n        link.href = '#';\n        link.target = target;\n        link.dataset.action = key;\n\n        link.addEventListener('click', async (e) => {\n          e.preventDefault();\n\n          if (confirmMessage) {\n            const confirmed = await DialogManager?.confirm?.(\n              Now.translate(confirmMessage),\n              Now.translate('Confirm')\n            );\n            if (!confirmed) return;\n          }\n\n          // Build URL with filter params\n          const params = this.getFilterParams(table);\n          const queryString = new URLSearchParams(params).toString();\n          const finalUrl = url.includes('?')\n            ? `${url}&${queryString}`\n            : `${url}?${queryString}`;\n\n          if (target === '_blank') {\n            window.open(finalUrl, '_blank');\n          } else {\n            window.location.href = finalUrl;\n          }\n\n          EventManager.emit('table:filterAction', {\n            tableId,\n            action: key,\n            type: 'link',\n            url: finalUrl,\n            params\n          });\n        });\n\n        table.actionWrapper.appendChild(link);\n\n      } else {\n        // Create button element\n        const button = document.createElement('button');\n        button.type = 'button';\n        button.className = `btn ${className}`.trim();\n        button.textContent = Now.translate(label);\n        button.dataset.action = key;\n\n        button.addEventListener('click', async (e) => {\n          e.preventDefault();\n\n          if (confirmMessage) {\n            const confirmed = await DialogManager?.confirm?.(\n              Now.translate(confirmMessage),\n              Now.translate('Confirm')\n            );\n            if (!confirmed) return;\n          }\n\n          button.classList.add('loading');\n\n          try {\n            const params = this.getFilterParams(table);\n            const sortParams = this.getSortParams(table);\n\n            const requestData = {\n              action: key,\n              tableId,\n              filters: params,\n              sort: sortParams\n            };\n\n            // Send POST request\n            const resp = await window.http.post(url, requestData);\n\n            // Handle 403 Forbidden - let ResponseHandler show the error message\n            if (resp?.status === 403) {\n              const responseData = resp?.data?.data ?? resp?.data ?? resp;\n\n              NotificationManager.error(responseData?.message || 'Access forbidden');\n\n              button.classList.remove('loading');\n              return;\n            }\n\n            // Handle 401 Unauthorized\n            if (resp?.status === 401) {\n              console.warn('TableManager: Unauthorized (401) for filter action');\n\n              const error = new Error(resp.statusText || 'Unauthorized');\n              error.status = 401;\n              error.response = resp;\n\n              await AuthErrorHandler.handleError(error, {\n                currentPath: window.location.pathname\n              });\n\n              button.classList.remove('loading');\n              return;\n            }\n\n            const responseData = resp?.data?.data ?? resp?.data ?? resp;\n\n            // Handle response via ResponseHandler if available\n            await ResponseHandler.process(responseData, {\n              reload: async () => this.loadTableData(tableId)\n            });\n\n            EventManager.emit('table:filterAction', {\n              tableId,\n              action: key,\n              type: 'button',\n              params,\n              response: responseData\n            });\n\n          } catch (error) {\n            console.error('Filter action error:', error);\n            NotificationManager?.error?.(error.message || 'Action failed');\n          } finally {\n            button.classList.remove('loading');\n          }\n        });\n\n        table.actionWrapper.appendChild(button);\n      }\n    });\n  },\n\n  async sendAction(actionUrl, data, tableId, submitEl, context = {}) {\n    try {\n      if (!actionUrl) {\n        throw new Error('Action URL is required');\n      }\n\n      if (!data || typeof data !== 'object') {\n        throw new Error('Invalid action data');\n      }\n\n      const table = this.state.tables.get(tableId);\n      if (!table) {\n        throw new Error(`Table ${tableId} not found`);\n      }\n\n      const submitButton = submitEl || document.createElement('button');\n      submitButton.classList.add?.('loading');\n\n      const requestData = {\n        ...data,\n        tableId\n      };\n\n      // Use HttpClient (window.http) with CSRF protection, fallback to simpleFetch\n      const resp = await window.http.post(actionUrl, requestData);\n\n      // Handle 403 Forbidden - let ResponseHandler show the error message\n      if (resp?.status === 403) {\n\n        const responseData = resp?.data?.data ?? resp?.data ?? resp;\n        NotificationManager.error(responseData?.message || 'Access forbidden');\n\n        submitButton.classList.remove?.('loading');\n\n        EventManager.emit('table:error', {\n          tableId,\n          action: data.action,\n          error: {message: responseData?.message || 'Access forbidden', status: 403},\n          timestamp: Date.now()\n        });\n\n        return false;\n      }\n\n      // Handle 401 Unauthorized - redirect to login\n      if (resp?.status === 401) {\n        console.warn('TableManager: Unauthorized (401) for table action');\n\n        const error = new Error(resp.statusText || 'Unauthorized');\n        error.status = 401;\n        error.response = resp;\n\n        await AuthErrorHandler.handleError(error, {\n          currentPath: window.location.pathname\n        });\n\n        submitButton.classList.remove?.('loading');\n        return false;\n      }\n\n      const responseData = resp?.data?.data ?? resp?.data ?? resp;\n\n      // Use ResponseHandler to process API response\n      try {\n        // Merge actions properly - preserve Array structure\n        if (context.modalConfig && responseData.actions) {\n          // If both are arrays, concatenate them\n          if (Array.isArray(responseData.actions)) {\n            responseData.actions = [\n              ...(Array.isArray(context.modalConfig) ? context.modalConfig : [context.modalConfig]),\n              ...responseData.actions\n            ];\n          } else {\n            // If actions is object, merge as objects\n            responseData.actions = {...context.modalConfig, ...responseData.actions};\n          }\n        } else if (context.modalConfig) {\n          responseData.actions = context.modalConfig;\n        }\n\n        await ResponseHandler.process(responseData, {\n          ...context,\n          data: responseData,\n          reload: async () => {\n            await this.loadTableData(tableId);\n          }\n        });\n      } catch (error) {\n        console.error('[TableManager] ResponseHandler error:', error);\n      }\n\n      // Determine success from response\n      const success = responseData.success !== false;\n\n      EventManager.emit('table:action', {\n        tableId,\n        action: data.action,\n        success,\n        response: responseData,\n        timestamp: Date.now()\n      });\n\n      submitButton.classList.remove?.('loading');\n\n      return success;\n\n    } catch (error) {\n      console.error('Table action error:', error);\n\n      const submitButton = submitEl || {classList: {remove: () => {}}};\n      submitButton.classList.remove?.('loading');\n\n      if (window.NotificationManager) {\n        NotificationManager.clear();\n        NotificationManager.error(error.message || 'An error occurred');\n      }\n\n      EventManager.emit('table:error', {\n        tableId,\n        action: data.action,\n        error,\n        timestamp: Date.now()\n      });\n\n      return false;\n    }\n  },\n\n  removeTableRows(table, ids) {\n    if (!table?.element || !ids?.length) return;\n\n    ids.forEach(id => {\n      const row = table.element.querySelector(`tr[data-id=\"${id}\"]`);\n      if (!row) return;\n\n      row.style.transition = 'opacity 0.3s';\n      row.style.opacity = '0';\n\n      setTimeout(() => {\n        row.remove();\n\n        this.updateTableInfo(table);\n\n        EventManager.emit('table:rowRemoved', {\n          tableId: table.id,\n          rowId: id\n        });\n      }, 300);\n    });\n  },\n\n  updateTableInfo(table) {\n    const rowCount = table.element.querySelectorAll('tbody tr').length;\n\n    if (rowCount === 0) {\n      const tbody = table.element.querySelector('tbody');\n      const tr = document.createElement('tr');\n      const td = document.createElement('td');\n      td.colSpan = table.element.querySelectorAll('thead th').length;\n      td.className = 'empty-table';\n      td.textContent = Now.translate('No data available');\n      tr.appendChild(td);\n      tbody.appendChild(tr);\n    }\n\n    if (table.config.pagination) {\n      const total = parseInt(table.config.params.total) - 1;\n      table.config.params.total = total;\n\n      if (table.paginationWrapper) {\n        this.updatePagination(table, table.id, total,\n          Math.ceil(total / table.config.params.pageSize));\n      }\n    }\n  },\n\n  setupKeyboardNavigation(table, tableId) {\n    if (!table) return;\n\n    const tableData = this.state.tables.get(tableId);\n    if (!tableData) return;\n\n    const handleKeydown = (event) => {\n      const target = event.target;\n\n      if (target.matches('th[data-sort]')) {\n        switch (event.key) {\n          case 'Enter':\n          case ' ':\n            event.preventDefault();\n            this.handleSort(tableData, tableId, target);\n            break;\n          case 'ArrowLeft':\n          case 'ArrowRight':\n            event.preventDefault();\n            this.navigateHeaders(table, target, event.key === 'ArrowRight');\n            break;\n        }\n      }\n\n      if (target.matches('tbody tr')) {\n        const rows = Array.from(table.querySelectorAll('tbody tr'));\n        const currentIndex = rows.indexOf(target);\n\n        switch (event.key) {\n          case 'ArrowUp':\n            event.preventDefault();\n            if (currentIndex > 0) {\n              rows[currentIndex - 1].focus();\n              this.announceRowChange(table, currentIndex - 1);\n            }\n            break;\n\n          case 'ArrowDown':\n            event.preventDefault();\n            if (currentIndex < rows.length - 1) {\n              rows[currentIndex + 1].focus();\n              this.announceRowChange(table, currentIndex + 1);\n            }\n            break;\n\n          case 'Home':\n            event.preventDefault();\n            rows[0].focus();\n            this.announceRowChange(table, 0);\n            break;\n\n          case 'End':\n            event.preventDefault();\n            rows[rows.length - 1].focus();\n            this.announceRowChange(table, rows.length - 1);\n            break;\n        }\n      }\n    };\n\n    table.addEventListener('keydown', handleKeydown);\n\n    if (!table.eventHandlers) table.eventHandlers = {};\n    table.eventHandlers.keyboard = handleKeydown;\n  },\n\n  navigateHeaders(table, currentHeader, forward) {\n    const headers = Array.from(table.querySelectorAll('th[data-sort]'));\n    const currentIndex = headers.indexOf(currentHeader);\n    let nextIndex;\n\n    if (forward) {\n      nextIndex = currentIndex < headers.length - 1 ? currentIndex + 1 : 0;\n    } else {\n      nextIndex = currentIndex > 0 ? currentIndex - 1 : headers.length - 1;\n    }\n\n    headers[nextIndex].focus();\n  },\n\n  announceRowChange(table, rowIndex) {\n    const announcer = document.getElementById(table.dataset.announcer);\n    if (announcer) {\n      const row = table.querySelectorAll('tbody tr')[rowIndex];\n      const firstCell = row.querySelector('td');\n      announcer.textContent = Now.translate('Row') + ` ${rowIndex + 1}: ${firstCell?.textContent || ''}`;\n    }\n  },\n\n  async loadData(tableId, source, params = {}) {\n    const table = this.state.tables.get(tableId);\n    if (!table) return;\n\n    if (table.isLoading) return;\n    table.isLoading = true;\n\n    try {\n      this.showLoading(table);\n\n      const queryParams = new URLSearchParams({\n        ...table.config.params,\n        ...this.getSortParams(table),\n        ...this.getPaginationParams(table),\n        ...params\n      });\n\n      const finalUrl = `${source}?${queryParams}`;\n      const resp = await http.get(finalUrl, {headers: {'Accept': 'application/json'}});\n      const data = resp?.data || resp;\n\n\n      this.setData(tableId, data.data);\n\n      if (data.meta?.total) {\n        this.updatePagination(table, tableId, data.meta);\n      }\n\n    } catch (error) {\n      return this.handleError('Error loading table data', error, 'loadData');\n    } finally {\n      table.isLoading = false;\n    }\n  },\n\n  showLoading(table) {\n    const tbody = table.element.querySelector('tbody');\n    tbody.innerHTML = `<tr><td colspan=\"100%\" class=\"center\">${Now.translate('Loading')}...</td></tr>`;\n  },\n\n  updateSelectedRows(table) {\n    const checkboxes = table.querySelectorAll('.select-all');\n\n    const selectedRows = [];\n\n    checkboxes.forEach((checkbox, index) => {\n      const row = checkbox.closest('tr');\n\n      if (checkbox.checked) {\n        selectedRows.push({\n          index: index,\n          row: row,\n          data: this.getRowData(row)\n        });\n\n        row.classList.add('selected-row');\n      } else {\n        row.classList.remove('selected-row');\n      }\n    });\n\n    this.updateSelectedCount(table, selectedRows.length);\n\n    if (this.onSelectionChange) {\n      this.onSelectionChange(selectedRows);\n    }\n\n    return selectedRows;\n  },\n\n  getRowData(row) {\n    const cells = row.querySelectorAll('td');\n    return Array.from(cells).map(cell => cell.textContent.trim());\n  },\n\n  // Parse data-row-actions attribute. Accepts JSON object or shorthand string 'print,edit,delete'\n  parseRowActions(raw) {\n    if (!raw) return null;\n    if (typeof raw === 'object') return raw;\n    try {\n      // Try JSON first\n      if (/^[\\s]*\\{/.test(raw) || /^[\\s]*\\[/.test(raw)) {\n        return JSON.parse(raw);\n      }\n    } catch (e) {\n      // fallthrough to shorthand\n    }\n\n    // Shorthand comma separated: 'print,edit,delete'\n    return raw.split(',').map(s => s.trim()).reduce((acc, key) => {\n      acc[key] = key.charAt(0).toUpperCase() + key.slice(1);\n      return acc;\n    }, {});\n  },\n\n  // Create action cell for a row. actions can be:\n  // { key: \"Label\" }\n  // { key: { label: \"Label\", params: { id: \"{id}\" }, method: 'POST', submenu: { ... } } }\n  createActionCell(table, tableId, item, actions) {\n    const td = document.createElement('td');\n    td.className = 'row-actions-cell';\n\n    const wrapper = document.createElement('div');\n    wrapper.className = 'btn-group';\n\n    const actionUrl = table.element.dataset.actionUrl || table.config.actionUrl;\n\n    const elementManager = Now.getManager('element');\n\n    Object.entries(actions).forEach(([key, cfg]) => {\n      // normalize cfg to object\n      cfg = (typeof cfg === 'string') ? {label: cfg} : (cfg || {});\n      let label = cfg.label || key;\n\n      // If submenu is provided, create a dropdown\n      if (cfg && typeof cfg === 'object' && cfg.submenu) {\n        const dropdown = document.createElement('div');\n        dropdown.className = 'action-dropdown';\n\n        const mainBtn = document.createElement('button');\n        mainBtn.type = 'button';\n        mainBtn.className = cfg.className || `action-btn action-${key}`;\n        mainBtn.textContent = label;\n\n        dropdown.appendChild(mainBtn);\n\n        const menu = document.createElement('div');\n        menu.className = 'action-submenu';\n        Object.entries(cfg.submenu).forEach(([subKey, subCfg]) => {\n          // submenu value can be string or object\n          const subObj = (typeof subCfg === 'string') ? {label: subCfg} : subCfg || {};\n          let m;\n          if (elementManager && subObj.element) {\n            m = elementManager.create(subObj.element, {\n              id: subObj.id || `row_action_${subKey}_${item.id || ''}`,\n              type: subObj.type || 'button',\n              value: Now.translate(subObj.label || subKey),\n              className: subObj.className || `action-sub action-${subKey}`,\n              wrapper: null,\n              attrs: subObj.attrs || {}\n            }).element;\n          } else {\n            m = document.createElement('button');\n            m.type = 'button';\n            m.className = subObj.className || `action-sub action-${subKey}`;\n            m.textContent = subObj.label || subKey;\n          }\n          m.addEventListener('click', (e) => {\n            e.preventDefault();\n            this._executeRowAction(tableId, actionUrl, item, subKey, subObj);\n          });\n          menu.appendChild(m);\n        });\n\n        dropdown.appendChild(menu);\n        wrapper.appendChild(dropdown);\n      } else {\n        // Single action button\n        let btnEl;\n        if (elementManager && (cfg.element || cfg.className || cfg.attrs)) {\n          // use ElementManager to create a richer element\n          const cfgEl = {\n            id: cfg.id || `row_action_${key}_${item.id || ''}`,\n            type: cfg.type || 'button',\n            value: Now.translate(cfg.label || key),\n            className: cfg.className || `action-btn action-${key}`,\n            wrapper: null,\n            attrs: cfg.attrs || {}\n          };\n          btnEl = elementManager.create(cfg.element || 'button', cfgEl).element;\n        } else {\n          btnEl = document.createElement('button');\n          btnEl.type = 'button';\n          btnEl.className = cfg.className || `action-btn action-${key}`;\n          btnEl.textContent = label;\n        }\n        btnEl.addEventListener('click', (e) => {\n          e.preventDefault();\n          this._executeRowAction(tableId, actionUrl, item, key, cfg);\n        });\n        wrapper.appendChild(btnEl);\n      }\n    });\n\n    td.appendChild(wrapper);\n    return td;\n  },\n\n  // Internal executor for per-row actions\n  async _executeRowAction(tableId, actionUrl, item, actionKey, cfg = null) {\n    const table = this.state.tables.get(tableId);\n    if (!table) return;\n\n    // Extract modal config if defined\n    const modalConfig = (cfg && cfg.modal) ? cfg.modal : null;\n\n    try {\n      let confirmMsg = null;\n      if (cfg && cfg.confirm) {\n        confirmMsg = typeof cfg.confirm === 'string' ? cfg.confirm : Now.translate('Are you sure you want to perform this action?');\n      } else if (actionKey === 'delete' && table.config.confirmDelete !== false) {\n        confirmMsg = Now.translate('Are you sure you want to delete this item?');\n      }\n\n      if (confirmMsg) {\n        let confirmed = false;\n        if (window.DialogManager && typeof DialogManager.confirm === 'function') {\n          try {\n            confirmed = await DialogManager.confirm(confirmMsg, Now.translate('Confirm'));\n          } catch (err) {\n            confirmed = false;\n          }\n        } else if (window.Modal) {\n          // Use Modal as a nicer fallback for confirmation when DialogManager isn't available\n          try {\n            const modal = new Modal({\n              title: Now.translate('Confirm'),\n              content: `<div class=\"confirm-body\">${confirmMsg}</div><div style=\"margin-top:1rem;text-align:right\"><button class=\"modal-cancel\">${Now.translate('Cancel')}</button> <button class=\"modal-confirm primary\">${Now.translate('Confirm')}</button></div>`,\n              width: '420px',\n              backdrop: true\n            });\n\n            modal.show();\n\n            confirmed = await new Promise(resolve => {\n              const listener = (e) => {\n                if (e.target.classList.contains('modal-confirm')) {\n                  cleanup();\n                  resolve(true);\n                } else if (e.target.classList.contains('modal-cancel')) {\n                  cleanup();\n                  resolve(false);\n                }\n              };\n\n              function cleanup() {\n                try {modal.hide();} catch (err) { /* ignore */}\n                setTimeout(() => {try {modal.modal?.remove();} catch (_) {} }, 300);\n                document.removeEventListener('click', listener);\n              }\n\n              document.addEventListener('click', listener);\n            });\n          } catch (err) {\n            console.error('Modal confirm error', err);\n            confirmed = false;\n          }\n        } else {\n          confirmed = confirm(confirmMsg);\n        }\n\n        if (!confirmed) return; // user canceled\n      }\n    } catch (err) {\n      console.error('Confirmation error:', err);\n      return;\n    }\n\n    // Build base payload\n    let payload = {action: actionKey, id: item.id, row: item};\n\n    // If action config provides params, interpolate templates against row data\n    if (cfg && cfg.params && typeof cfg.params === 'object') {\n      const interpolate = (val) => {\n        if (typeof val !== 'string') return val;\n        return val.replace(/\\{([^}]+)\\}/g, (m, key) => {\n          // support nested keys like user.id\n          const parts = key.split('.');\n          let cur = item;\n          for (let p of parts) {\n            if (cur == null) return '';\n            cur = cur[p];\n          }\n          return cur != null ? cur : '';\n        });\n      };\n\n      const resolved = {};\n      Object.entries(cfg.params).forEach(([k, v]) => {\n        if (typeof v === 'object') {\n          resolved[k] = JSON.stringify(v); // simple fallback\n        } else {\n          resolved[k] = interpolate(v);\n        }\n      });\n\n      payload = {...payload, ...resolved};\n    }\n\n    // Allow overriding method (GET will perform navigation with query string)\n    const method = (cfg && cfg.method) ? cfg.method.toUpperCase() : 'POST';\n\n    if (actionUrl) {\n      if (method === 'GET') {\n        const params = new URLSearchParams();\n        Object.entries(payload).forEach(([k, v]) => {\n          if (typeof v === 'object') params.append(k, JSON.stringify(v));\n          else params.append(k, v == null ? '' : v);\n        });\n        const dest = actionUrl + (actionUrl.indexOf('?') === -1 ? '?' : '&') + params.toString();\n        window.location.href = dest;\n        return;\n      }\n\n      // use existing sendAction helper which handles response (POST)\n      try {\n        const fakeButton = document.createElement('button');\n        fakeButton.className = 'loading';\n        await this.sendAction(actionUrl, payload, tableId, fakeButton, {\n          modalConfig: modalConfig,\n          table: table,\n          row: item,\n          action: actionKey\n        });\n      } catch (err) {\n        console.error('Row action error:', err);\n      }\n    } else {\n      // No actionUrl: emit an event for external handling, include payload\n      EventManager.emit('table:rowAction', {tableId, action: actionKey, payload, row: item});\n    }\n  },\n\n  updateSelectedCount(table, count) {\n    const selectedCountElement = table.closest('.table-container')\n      ?.querySelector('.selected-count');\n\n    if (selectedCountElement) {\n      selectedCountElement.textContent = Now.translate('Selected {count} rows', {count: count});\n\n      selectedCountElement.style.display = count > 0 ? 'block' : 'none';\n    }\n  },\n\n  formatValue(value, format, options = {}) {\n    if (value === null || value === undefined) {\n      return options.emptyText || '';\n    }\n\n    if (!format) return value;\n\n    // If format is a function, use it\n    if (typeof format === 'function') {\n      return format(value, options);\n    }\n\n    try {\n      switch (format) {\n        case 'text':\n          return String(value);\n\n        case 'html':\n          // Be cautious with HTML content - ensure it's sanitized\n          return value;\n\n        case 'boolean':\n          return value ? (options.trueText || 'Yes') : (options.falseText || 'No');\n\n        case 'lookup':\n          // For select options display - support multiple formats\n          // options can be: object {value: label}, array [{value, text/label}], or Map\n          if (!options) {\n            return value; // No options provided, return raw value\n          }\n\n          // Handle array format from API: [{value: \"active\", label: \"Active\"}, ...]\n          if (Array.isArray(options)) {\n            const found = options.find(opt => {\n              if (opt && typeof opt === 'object') {\n                const optVal = opt.value !== undefined ? opt.value : opt.key;\n                return String(optVal) === String(value);\n              }\n              return String(opt) === String(value);\n            });\n            if (found) {\n              return found.label || found.text || String(found.value || found);\n            }\n            return value; // No data available, return raw value\n          }\n\n          // Handle Map format\n          if (options instanceof Map) {\n            return options.get(value) || value;\n          }\n\n          // Handle object format: {value: label, ...}\n          if (typeof options === 'object') {\n            return options[value] !== undefined ? options[value] : value;\n          }\n\n          return value;\n\n        case 'number':\n          return new Intl.NumberFormat(options.locale, {\n            minimumFractionDigits: options.decimals || 0,\n            maximumFractionDigits: options.decimals || 0,\n            useGrouping: options.useGrouping !== false\n          }).format(value);\n\n        case 'currency':\n          return Utils.number.currency(value, options.currency || null, options.locale || 'en-US');\n\n        case 'percent':\n          return new Intl.NumberFormat(options.locale, {\n            style: 'percent',\n            minimumFractionDigits: options.decimals || 0,\n            maximumFractionDigits: options.decimals || 0\n          }).format(value / (options.base || 100));\n\n        case 'date':\n          // Format as date (locale-aware by default)\n          return Utils.date.format(value, options.pattern || 'D MMM YYYY');\n\n        case 'time':\n          // Format as time (locale-aware by default)\n          return Utils.date.format(value, options.pattern || 'HH:mm');\n\n        case 'datetime':\n          // Format as datetime (locale-aware by default)\n          return Utils.date.format(value, options.pattern || 'D MMM YYYY HH:mm');\n\n        case 'bytes':\n          return Utils.number.fileSize(value);\n\n        case 'duration':\n          // Format duration in seconds to readable format\n          const seconds = Number(value);\n          if (isNaN(seconds)) return value;\n\n          const h = Math.floor(seconds / 3600);\n          const m = Math.floor((seconds % 3600) / 60);\n          const s = Math.floor(seconds % 60);\n\n          const parts = [];\n          if (h > 0) parts.push(`${h}${options.hourLabel || 'h'}`);\n          if (m > 0 || h > 0) parts.push(`${m}${options.minuteLabel || 'm'}`);\n          parts.push(`${s}${options.secondLabel || 's'}`);\n\n          return parts.join(' ');\n\n        case 'humanize':\n          return Utils.string.humanize(value);\n\n        case 'truncate':\n          return Utils.string.truncate(String(value), options.length || 50, options.end || '...');\n\n        default:\n          // Try to use a global formatter if available\n          if (window.formatters && typeof window.formatters[format] === 'function') {\n            return window.formatters[format](value, options);\n          }\n          return value;\n      }\n    } catch (error) {\n      console.warn('Format error:', error);\n      return value;\n    }\n  },\n\n  // Get sort parameters for API\n  getSortParams(table) {\n    const params = {};\n\n    if (table.sortState && Object.keys(table.sortState).length > 0) {\n      // Use compact format for API consistency with URL parameters\n      // Convert to 'name asc,status desc' format\n      const sortPairs = Object.entries(table.sortState).map(([field, direction]) => `${field} ${direction}`);\n\n      if (sortPairs.length > 0) {\n        params.sort = sortPairs.join(',');\n      }\n    }\n\n    return params;\n  },\n\n  // Get pagination parameters for API\n  getPaginationParams(table) {\n    const params = {};\n\n    if (table.config.params.page) {\n      params.page = table.config.params.page;\n    }\n\n    if (table.config.params.pageSize) {\n      params.pageSize = table.config.params.pageSize;\n    }\n\n    if (table.config.params.search) {\n      params.search = table.config.params.search;\n    }\n\n    return params;\n  },\n\n  getFilterParams(table) {\n    const params = {};\n    const excludeKeys = ['page', 'pageSize', 'search', 'total', 'totalPages'];\n\n    // Include all filter parameters from config.params except pagination/meta keys\n    Object.keys(table.config.params).forEach(key => {\n      if (!excludeKeys.includes(key)) {\n        const value = table.config.params[key];\n        // Only include non-empty values\n        if (value !== null && value !== undefined && value !== '') {\n          params[key] = value;\n        }\n      }\n    });\n\n    return params;\n  },\n\n  async exportData(tableId, format = 'csv', options = {}) {\n    const table = this.state.tables.get(tableId);\n    if (!table) {\n      return this.handleError('Table not found for export', null, 'exportData');\n    }\n\n    format = (format || 'csv').toLowerCase();\n\n    // If server-side and an export URL is provided, delegate to the server\n    const exportUrl = table.element.dataset.exportUrl || table.element.dataset.export || table.config.exportUrl;\n    if (table.serverSide && exportUrl) {\n      try {\n        const params = new URLSearchParams({\n          ...table.config.params,\n          format\n        });\n        const url = exportUrl.indexOf('?') === -1 ? `${exportUrl}?${params}` : `${exportUrl}&${params}`;\n        const resp = await http.get(url, {method: 'GET'});\n        // http.get returns parsed response, but for blobs we need to check response type\n        if (resp?.data instanceof Blob) {\n          const blob = resp.data;\n          const disposition = resp.headers['content-disposition'] || '';\n          let filename = options.filename || `${tableId}.${format}`;\n          const m = disposition.match(/filename\\*=UTF-8''([^;\\n\\r]+)/i) || disposition.match(/filename=\"?([^\";\\n\\r]+)\"?/i);\n          if (m && m[1]) filename = decodeURIComponent(m[1]);\n          this.downloadBlob(blob, filename);\n          EventManager.emit('table:export', {tableId, format, success: true});\n          return true;\n        }\n\n        // If http.get didn't return blob, request again with explicit blob handling\n        if (!window.http || typeof window.http.get !== 'function') {\n          throw new Error('HttpClient (window.http) is required but not available');\n        }\n\n        const blobResp = await window.http.get(url, {\n          throwOnError: false,\n          headers: {'Accept': 'application/octet-stream'}\n        });\n\n        if (!blobResp.success) throw new Error('Export request failed');\n        const blob = blobResp.data instanceof Blob ? blobResp.data : new Blob([blobResp.data]);\n        const disposition = blobResp.headers['content-disposition'] || '';\n        let filename = options.filename || `${tableId}.${format}`;\n        const m = disposition.match(/filename\\*=UTF-8''([^;\\n\\r]+)/i) || disposition.match(/filename=\"?([^\";\\n\\r]+)\"?/i);\n        if (m && m[1]) filename = decodeURIComponent(m[1]);\n        this.downloadBlob(blob, filename);\n        EventManager.emit('table:export', {tableId, format, success: true});\n        return true;\n      } catch (err) {\n        console.error('Export error (server):', err);\n        EventManager.emit('table:export', {tableId, format, success: false, error: err});\n        return false;\n      }\n    }\n\n    // Client-side export: apply filtering and sorting first\n    let rawData = Array.isArray(table.data) ? table.data : [];\n\n    // Apply filtering and sorting (same as what user sees)\n    let exportData = this.filterData(table, rawData);\n    exportData = this.sortData(table, exportData);\n\n    try {\n      // Determine columns order and get column attributes\n      let columns = [];\n      let columnLabels = {};\n      let columnAttributes = {};\n\n      try {\n        if (table.columns && table.columns.size) {\n          columns = Array.from(table.columns.keys());\n          // Get column headers and attributes for formatting\n          table.columns.forEach((attrs, field) => {\n            columnAttributes[field] = attrs;\n            // Get header label from th element\n            const th = table.element.querySelector(`th[data-field=\"${field}\"]`);\n            columnLabels[field] = th ? th.textContent.trim() : field;\n          });\n        }\n      } catch (e) {\n        columns = [];\n      }\n\n      if (!columns.length && exportData.length) {\n        columns = Object.keys(exportData[0]);\n        columns.forEach(col => {\n          columnLabels[col] = col;\n          columnAttributes[col] = {};\n        });\n      }\n\n      // Helper function to format cell value for export\n      const formatExportValue = (value, field) => {\n        const attrs = columnAttributes[field] || {};\n\n        // Use formatValue with lookup to get rendered text\n        if (attrs.format || attrs.options) {\n          const formatted = this.formatValue(value, attrs.format || 'lookup', {\n            options: attrs.options || {},\n            ...attrs\n          });\n          return formatted;\n        }\n\n        return value;\n      };\n\n      if (format === 'json') {\n        // For JSON export, format the values as well\n        const formattedData = exportData.map(row => {\n          const formattedRow = {};\n          columns.forEach(col => {\n            formattedRow[columnLabels[col] || col] = formatExportValue(row[col], col);\n          });\n          return formattedRow;\n        });\n        const json = JSON.stringify(formattedData, null, 2);\n        const blob = new Blob([json], {type: 'application/json;charset=utf-8'});\n        this.downloadBlob(blob, options.filename || `${tableId}.json`);\n        EventManager.emit('table:export', {tableId, format, success: true, count: exportData.length});\n        return true;\n      }\n\n      // default: csv\n      // Build CSV string\n      const escape = (v) => {\n        if (v === null || v === undefined) return '';\n        let s = v;\n        if (typeof s === 'object') s = JSON.stringify(s);\n        s = String(s);\n        if (s.indexOf('\"') !== -1) s = s.replace(/\"/g, '\"\"');\n        if (/[\",\\n\\r]/.test(s)) s = `\"${s}\"`;\n        return s;\n      };\n\n      // Use column labels (header text) instead of field names\n      const header = columns.map(col => escape(columnLabels[col] || col)).join(',');\n\n      // Format each cell value before escaping\n      const rows = exportData.map(row =>\n        columns.map(col => escape(formatExportValue(row[col], col))).join(',')\n      );\n\n      const csv = [header, ...rows].join('\\r\\n');\n      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});\n      this.downloadBlob(blob, options.filename || `${tableId}.csv`);\n      EventManager.emit('table:export', {tableId, format: 'csv', success: true, count: exportData.length});\n      return true;\n    } catch (err) {\n      console.error('Export error (client):', err);\n      EventManager.emit('table:export', {tableId, format, success: false, error: err});\n      return false;\n    }\n  },\n\n  downloadBlob(blob, filename) {\n    try {\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = filename;\n      document.body.appendChild(a);\n      a.click();\n      setTimeout(() => {\n        document.body.removeChild(a);\n        window.URL.revokeObjectURL(url);\n      }, 1000);\n    } catch (err) {\n      console.error('Failed to initiate download:', err);\n    }\n  },\n\n  resetState() {\n    this.state = {\n      initialized: false,\n      tables: new Map()\n    };\n    this.config = {};\n  }\n};\n\nif (window.Now?.registerManager) {\n  Now.registerManager('table', TableManager);\n}\n\n// Expose globally\nwindow.TableManager = TableManager;\n"],"names":["TableManager","config","urlParams","pageSizes","showCaption","showCheckbox","showFooter","footerAggregates","searchColumns","persistColumnWidths","rowSortable","allowRowModification","confirmDelete","dynamicColumns","source","method","actions","actionUrl","actionButton","rowActions","params","search","pageSize","page","state","initialized","tables","Map","init","options","this","setupDynamicTableObserver","document","querySelectorAll","forEach","table","initTable","EventManager","on","data","tableId","retranslateFilter","renderTable","e","getUrlParams","get","_a","searchParams","window","location","href","includes","hashPart","hash","queryIndex","indexOf","substring","URLSearchParams","key","value","entries","parseInt","updateUrlParams","newParams","isHashMode","internalParams","columnFields","columns","size","field","push","newUrl","has","delete","Object","Array","isArray","v","append","set","queryString","toString","hashBase","split","pathname","history","replaceState","console","warn","syncStateToUrl","sortState","keys","length","sortPairs","map","direction","sort","join","loadStateFromUrl","pair","trim","parts","toLowerCase","restoreFilterUIFromState","filterElements","filterElement","element","externalFilterForm","setFormElementValue","type","checked","tagName","from","some","opt","String","error","handleError","dataset","extractDataAttributes","editableRows","querySelector","id","filterWrapper","actionWrapper","paginationWrapper","filterData","filterOptions","elementInstances","initializing","bindToState","setupTableStructure","setupAccessibility","setupEventListeners","tableObj","defaultSort","applyDefaultSort","startsWith","loadPromise","loadTableData","then","finally","currentTableObj","err","sortString","th","classList","remove","add","setAttribute","column","index","sortOrder","createElement","className","appendChild","textContent","defaultConfig","defaultValue","item","JSON","parse","setupCheckboxes","section","tr","checkboxId","checkbox","label","closest","htmlFor","cell","rowspan","insertBefore","firstChild","Now","translate","oldHandler","_selectAllHandler","removeEventListener","newHandler","handleSelectAll","target","addEventListener","cb","handleRowSelection","checkboxes","checkedBoxes","allChecked","someChecked","indeterminate","selectedRows","onSelectionChange","emit","clearSelection","hadSelection","_b","actionElements","submit","disabled","updateSelectedCount","tableEl","thead","tfoot","thCount","i","td","rowActionsJson","actionLabel","rowActionsLabel","i18n","parentNode","setupFilter","setupExternalFilter","setupFooter","setupActions","setupPagination","handlers","filter","keyboard","eventHandlers","touchEnabled","setupTouchEvents","tbody","delegatedClick","_handleDelegatedClick","delegatedChange","_handleDelegatedChange","delegation","click","change","fwChange","handleFilterChange","name","filterWrapperChange","setupColumnResizing","select","submitBtn","selectEl","onActionButtonClick","async","preventDefault","NotificationManager","warning","getSelectedRowIds","message","action","selectedIndex","DialogManager","confirm","_performActionWrapperSubmission","sortHandler","stopPropagation","shiftKey","getSelection","removeAllRanges","handleSort","keyHandler","cleanupFilterEvents","elementId","ElementManager","destroy","clear","event","HTMLElement","Error","currentSort","newSort","isMultiSort","multiSort","otherTh","sortIndex","loadFromApi","catch","handleFieldChange","rowData","send","_c","ids","submitEl","sendAction","success","setTimeout","wrapper","isExternalFilter","innerHTML","elementManager","getManager","debouncedFilterChange","Utils","function","debounce","pageSizeOptions","create","onChange","getColumnDefinitions","attributes","elementConfig","placeholder","opts","showAll","allValue","allLabel","text","assign","datalist","autocomplete","wrapperClass","elementObj","itemClass","minLength","pendingDerivedFilters","setFilters","form","_externalFilterCleanup","submitHandler","handleExternalFilterSubmit","getFormElementValue","entry","formData","FormData","selectedOptions","getInstanceByElement","instance","call","setValue","values","selected","populateExternalFilterOptions","fieldName","fieldOptions","selectElement","currentValue","firstOption","option","filterKey","cellIndex","setupKeyboardNavigation","announcer","nextSibling","Date","now","setupSortableRows","Sortable","sortable","draggable","handle","animation","onStart","onEnd","evt","order","children","row","position","newData","find","d","sortUrl","resp","http","post","fakeButton","enableRowSort","theadRow","style","width","textAlign","cursor","disableRowSort","dragHead","loadFromHtml","showLoading","endsWith","loadFromJson","loadFromState","isServerSideTable","createEmptyRow","_newRowCounter","_","captureRowValues","updated","el","getElementById","getFilterParams","getSortParams","getPaginationParams","fetchAndSet","headers","Accept","url","body","credentials","restOptions","upperMethod","toUpperCase","payload","defaultCredentials","ApiService","security","sendCredentials","apiCache","cache","response","enabled","apiOptions","methodName","status","_d","RouterManager","navigate","_e","LocationManager","redirect","statusText","AuthErrorHandler","currentPath","responseData","meta","filters","serverSide","setData","finalTableId","Element","loading","formatter","rawRows","cells","header","html","normalizedRows","r","nr","k","stringify","originalData","tid","t","stateKey","stateManager","subscribe","handler","newValue","unsubscribe","off","normalized","total","columnsMetadata","existingThead","newThead","createDynamicHeaders","original","searchableFields","col","searchable","dataOptions","optionsMap","val","metaPage","metaPageSize","metaTotal","metaTotalPages","totalPages","Math","max","ceil","correctedPage","tableContent","derived","deriveFiltersFromData","resetSort","optionsArray","txt","emInstance","getInstance","isConnected","updateOptions","valueToRestore","result","hasApiSource","hasServerMeta","isServerSide","baseData","filteredData","pageData","totalRecords","sortData","paginationResult","paginateData","colSpan","renderRow","restoreSortUI","updatePagination","filteredRecords","renderCell","div","title","handleCopyRow","handleDeleteRow","btn","button","innerText","rowActionsRaw","parseRowActions","actionCell","createActionCell","updatedItem","idx","findIndex","newItem","structuredClone","insertAt","splice","originalItem","deleteRow","removeLocalRow","mergeInfo","rowIndex","currentCol","colIndex","getAttribute","colspan","c","startRow","startCol","rows","min","step","pattern","maxLength","format","class","cellClass","cellElement","template","a","b","align","emptyText","getColumnGroups","processed","aggregateType","customFn","custom","calculateAggregate","formattedValue","formatValue","prefix","suffix","parseFloat","isNaN","reduce","calculateGroupAggregate","fields","sum","groups","lastRow","updateTableCaption","caption","searchText","count","start","end","translated","test","I18nManager","interpolate","getTranslations","replace","m","generalFilters","every","filterValue","filterFn","searchFilter","aVal","bVal","sorter","slice","startPage","endPage","addPaginationButton","currentPage","onclick","normalizeValue","rawValue","primValue","renderElementCell","lookupOptions","match","plain","tm","TemplateManager","processTemplateString","container","context","skipScan","ErrorManager","logErr","originalAttr","attr","dataAttributes","attrValue","events","translateValue","searchObj","elementType","getElementConfig","readOnly","required","multiple","allowEmpty","parsedMin","parsedMax","cols","resizable","accept","maxFileSize","preview","delay","onSearch","validate","cleanupTableResources","cleanup","clearTableCache","removeAttribute","contains","getRowObjectById","_executeRowAction","iconBtn","fieldEl","shouldSend","selectInfo","submitInfo","selectedAction","actionName","actionValue","saved","localStorage","getItem","widths","resizer","top","right","userSelect","height","zIndex","startX","startWidth","onMouseMove","dx","clientX","newWidth","onMouseUp","getComputedStyle","setItem","offsetWidth","removeItem","destroyTable","timestamp","dynamicObserver","disconnect","globalEventHandlers","resetState","statePath","recordCount","initialData","MutationObserver","observer","mutations","mutation","addedNodes","node","nodeType","matches","removedNodes","observe","childList","subtree","errorObj","stack","currentTableId","notify","startY","touchStartTime","longPressTimer","touch","touches","clientY","updateSelectedRows","deltaX","abs","deltaY","clearTimeout","touchDuration","changedTouches","actionOptions","actionSelectLabel","actionButtonConfig","parsed","setupFilterActions","filterActionsRaw","filterActions","confirmMessage","link","finalUrl","open","sortParams","requestData","ResponseHandler","process","reload","submitButton","_g","_f","_h","modalConfig","_j","_i","_l","_k","removeTableRows","transition","opacity","updateTableInfo","rowId","pagination","tableData","handleKeydown","navigateHeaders","currentIndex","focus","announceRowChange","currentHeader","forward","nextIndex","firstCell","loadData","isLoading","getRowData","raw","s","acc","charAt","cfg","submenu","dropdown","mainBtn","menu","subKey","subCfg","subObj","attrs","btnEl","cfgEl","actionKey","modal","confirmMsg","confirmed","Modal","content","backdrop","show","Promise","resolve","listener","hide","cur","p","resolved","dest","selectedCountElement","display","trueText","falseText","found","optVal","Intl","NumberFormat","locale","minimumFractionDigits","decimals","maximumFractionDigits","useGrouping","number","currency","base","date","fileSize","seconds","Number","h","floor","hourLabel","minuteLabel","secondLabel","string","humanize","truncate","formatters","excludeKeys","exportData","exportUrl","export","Blob","blob","disposition","filename","decodeURIComponent","downloadBlob","blobResp","throwOnError","rawData","columnLabels","columnAttributes","formatExportValue","formattedData","formattedRow","json","escape","csv","URL","createObjectURL","download","removeChild","revokeObjectURL","registerManager"],"mappings":"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"}