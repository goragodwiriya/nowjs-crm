!function(){"use strict";var e;const t={config:{enabled:!1,serviceWorkerPath:"/service-worker.js",scope:"/",version:"1.0.0",cacheName:"now-js-cache",debug:!1,updateInterval:864e5,precache:["/","/index.html"],cacheJavascriptFiles:!0,cachePatterns:[/\.js$/,/\.css$/,/\.html$/,/\.json$/,/\.png$/,/\.jpe?g$/,/\.svg$/,/\.woff2?$/,/\.ttf$/],networkFirst:[],excludeFromCache:[],notifyOnUpdate:!0,offlineContent:null,push:{enabled:!1,publicKey:null,userVisibleOnly:!0},strategies:{}},state:{initialized:!1,registration:null,updateFound:!1,installingWorker:null,offlineReady:!1,lastUpdateCheck:0,status:"unregistered",errors:[],pushEnabled:!1,pushSubscription:null},async init(e={}){try{return this.state.initialized?this:(this.config={...this.config,...e},this.config.enabled?this.isSupported()?(await this.registerServiceWorker(),this.setupUpdateChecks(),await this.setupPushNotifications(),await this.updateConfig(),this.state.initialized=!0,this):(this.log("Service Worker is not supported in this browser"),this):(this.log("Service Worker is disabled in configuration"),this))}catch(t){return this.handleError(t),this}},async updateConfig(){if(this.state.registration)try{let e=this.state.registration.active;if(e||(await new Promise(e=>{const checkActive=()=>{this.state.registration.active?e():setTimeout(checkActive,100)};checkActive(),this.state.registration.addEventListener("updatefound",()=>{const t=this.state.registration.installing;t&&t.addEventListener("statechange",()=>{"activated"===t.state&&e()})})}),e=this.state.registration.active),!e)throw new Error("No active service worker after waiting");const toPatternSource=e=>e.map(e=>e instanceof RegExp?e.source:e);e.postMessage({type:"UPDATE_CONFIG",payload:{cacheName:this.config.cacheName,precacheUrls:this.config.precache,cachePatterns:toPatternSource(this.config.cachePatterns),networkFirstPatterns:toPatternSource(this.config.networkFirst),excludeFromCachePatterns:toPatternSource(this.config.excludeFromCache),strategies:this.config.strategies||{},push:{enabled:this.config.push.enabled,publicKey:this.config.push.publicKey,userVisibleOnly:this.config.push.userVisibleOnly}}}),this.log("Sent config to service worker")}catch(e){this.handleError(e,"updateConfig")}},isSupported:()=>"serviceWorker"in navigator&&"PushManager"in window,async registerServiceWorker(){try{this.state.status="registering",this.log("Registering service worker");const e=await navigator.serviceWorker.register(this.config.serviceWorkerPath,{scope:this.config.scope});return this.state.registration=e,this.state.status="registered",this.log("Service worker registered successfully"),this.setupEventListeners(e),this.checkForUpdates(e),EventManager.emit("serviceworker:registered",{registration:e}),e}catch(e){throw this.state.status="failed",this.handleError(e),e}},async setupPushNotifications(){if(this.config.push.enabled&&this.state.registration)if("PushManager"in window)try{const e=await this.state.registration.pushManager.getSubscription();e&&(this.state.pushEnabled=!0,this.state.pushSubscription=e,this.log("Push notifications already subscribed"))}catch(e){this.handleError(e,"pushSetup")}else this.log("Push Notifications are not supported in this browser")},async subscribePush(){if(!this.state.registration||!this.config.push.publicKey)throw new Error("Push not configured or no active service worker");try{const e=await this.state.registration.pushManager.subscribe({userVisibleOnly:this.config.push.userVisibleOnly,applicationServerKey:this.config.push.publicKey});return this.state.pushEnabled=!0,this.state.pushSubscription=e,this.log("Subscribed to push notifications"),EventManager.emit("serviceworker:push-subscribed",{subscription:e}),e}catch(e){throw this.handleError(e,"pushSubscribe"),e}},async unsubscribePush(){try{const e=await this.state.registration.pushManager.getSubscription();return!!e&&(await e.unsubscribe(),this.state.pushEnabled=!1,this.state.pushSubscription=null,this.log("Unsubscribed from push notifications"),EventManager.emit("serviceworker:push-unsubscribed"),!0)}catch(e){throw this.handleError(e,"pushUnsubscribe"),e}},isPushEnabled(){return this.state.pushEnabled},setupEventListeners(e){e.addEventListener("updatefound",()=>{this.state.updateFound=!0,this.state.installingWorker=e.installing,this.state.installingWorker&&this.state.installingWorker.addEventListener("statechange",()=>{this.handleStateChange(this.state.installingWorker)}),this.log("New service worker found and is installing"),EventManager.emit("serviceworker:update-found",{registration:e})}),navigator.serviceWorker.addEventListener("controllerchange",()=>{this.state.updateFound&&(this.log("New service worker activated"),this.showUpdateNotification())}),navigator.serviceWorker.addEventListener("message",e=>{this.handleWorkerMessage(e)})},handleStateChange(e){switch(this.log(`Service worker state changed to: ${e.state}`),e.state){case"installed":navigator.serviceWorker.controller?(this.log("New content is available; please refresh."),this.state.status="updated",this.config.notifyOnUpdate&&this.showUpdateNotification()):(this.log("Content is now cached for offline use."),this.state.status="installed",this.state.offlineReady=!0);break;case"activated":this.state.status="activated",this.log("Service worker activated and controlling the page");break;case"redundant":this.state.status="redundant",this.log("The installing service worker became redundant")}EventManager.emit("serviceworker:state-change",{state:e.state,status:this.state.status})},showUpdateNotification(){this.config.notifyOnUpdate&&(window.NotificationManager?NotificationManager.info("A new version is available. Refresh the page to update.",{duration:0,id:"sw-update",actions:[{label:"Refresh",callback:()=>window.location.reload()}]}):this.log("A new version is available. Refresh the page to update.","info"))},async checkForUpdates(e){try{this.log("Checking for service worker updates"),this.state.lastUpdateCheck=Date.now(),await e.update(),this.log("Update check completed")}catch(t){this.handleError(t)}},setupUpdateChecks(){this.config.updateInterval&&(window.addEventListener("online",()=>{this.log("Network connection restored, checking for updates"),this.state.registration&&this.checkForUpdates(this.state.registration)}),setInterval(()=>{navigator.onLine&&this.state.registration&&(this.log("Performing scheduled update check"),this.checkForUpdates(this.state.registration))},this.config.updateInterval))},handleWorkerMessage(e){const t=e.data;if(t&&t.type){switch(this.log(`Received message from service worker: ${t.type}`,"debug"),t.type){case"CACHE_UPDATED":this.log(`Cache updated: ${t.payload.cacheName}`);break;case"CACHE_ERROR":this.handleError(new Error(t.payload.message),"cache");break;case"OFFLINE_READY":this.state.offlineReady=!0,this.log("Application is ready for offline use"),EventManager.emit("serviceworker:offline-ready");break;case"LOG":this.log(`[SW] ${t.payload.message}`,t.payload.level);break;case"PUSH_SUBSCRIPTION":this.state.pushSubscription=t.payload,this.state.pushEnabled=!0,this.log("Push subscription updated from worker");break;case"CONFIG_UPDATED":this.log("Service worker confirmed config update")}EventManager.emit("serviceworker:message",t)}},log(e,t="log"){if(!this.config.debug)return;const s="[ServiceWorkerManager]";switch(t){case"error":console.error(s,e);break;case"warn":console.warn(s,e);break;case"info":console.info(s,e);break;default:console.log(s,e)}},handleError(e,t="general"){const s={message:e.message,stack:e.stack,context:t,timestamp:Date.now()};this.state.errors.push(s),this.log(`Error (${t}): ${e.message}`,"error"),window.ErrorManager&&ErrorManager.handle(e,{context:`ServiceWorkerManager.${t}`,type:"error:serviceworker",data:s}),EventManager.emit("serviceworker:error",s)},async cacheUrls(e){if(!this.state.registration||!e||!Array.isArray(e))return!1;try{const t=this.state.registration.active;if(!t)throw new Error("No active service worker found");return t.postMessage({type:"CACHE_URLS",payload:{urls:e}}),!0}catch(t){return this.handleError(t,"cacheUrls"),!1}},async clearCache(){if(!this.state.registration)return!1;try{const e=this.state.registration.active;if(!e)throw new Error("No active service worker found");return e.postMessage({type:"CLEAR_CACHE"}),!0}catch(e){return this.handleError(e,"clearCache"),!1}},async update(){if(!this.state.registration)return!1;try{return await this.state.registration.update(),!0}catch(e){return this.handleError(e,"update"),!1}},async skipWaiting(){if(!this.state.registration||!this.state.installingWorker)return!1;try{return this.state.installingWorker.postMessage({type:"SKIP_WAITING"}),!0}catch(e){return this.handleError(e,"skipWaiting"),!1}},isOfflineReady(){return this.state.offlineReady},getStatus(){return{supported:this.isSupported(),initialized:this.state.initialized,status:this.state.status,offlineReady:this.state.offlineReady,registration:this.state.registration,lastUpdateCheck:this.state.lastUpdateCheck,errors:this.state.errors.length,pushEnabled:this.state.pushEnabled}},async unregister(){if(!this.state.registration)return!1;try{const e=await this.state.registration.unregister();return e&&(this.log("Service worker unregistered successfully"),this.state.registration=null,this.state.status="unregistered",this.state.offlineReady=!1,EventManager.emit("serviceworker:unregistered")),e}catch(e){return this.handleError(e,"unregister"),!1}}};(null==(e=window.Now)?void 0:e.registerManager)&&Now.registerManager("serviceWorker",t),window.ServiceWorkerManager=t}();
//# sourceMappingURL=now.serviceworker.min.js.map
