var RichTextEditor=function(){"use strict";var e=Object.defineProperty,__publicField=(t,i,n)=>((t,i,n)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[i]=n)(t,"symbol"!=typeof i?i+"":i,n);class EventBus{constructor(){this.listeners=new Map,this.onceListeners=new Map}on(e,t,i=null){if("function"!=typeof t)throw new Error("Callback must be a function");this.listeners.has(e)||this.listeners.set(e,[]);const n={callback:t,context:i};return this.listeners.get(e).push(n),()=>this.off(e,t)}once(e,t,i=null){if("function"!=typeof t)throw new Error("Callback must be a function");this.onceListeners.has(e)||this.onceListeners.set(e,[]);const n={callback:t,context:i};return this.onceListeners.get(e).push(n),()=>{const i=this.onceListeners.get(e);if(i){const e=i.findIndex(e=>e.callback===t);-1!==e&&i.splice(e,1)}}}off(e,t){const i=this.listeners.get(e);if(i){const e=i.findIndex(e=>e.callback===t);-1!==e&&i.splice(e,1)}}emit(e,...t){const i=this.listeners.get(e);i&&i.forEach(({callback:i,context:n})=>{try{i.apply(n,t)}catch(s){console.error(`Error in event listener for "${e}":`,s)}});const n=this.onceListeners.get(e);if(n&&n.length>0){const i=[...n];this.onceListeners.set(e,[]),i.forEach(({callback:i,context:n})=>{try{i.apply(n,t)}catch(s){console.error(`Error in once listener for "${e}":`,s)}})}}removeAllListeners(e=null){e?(this.listeners.delete(e),this.onceListeners.delete(e)):(this.listeners.clear(),this.onceListeners.clear())}listenerCount(e){var t,i;return((null==(t=this.listeners.get(e))?void 0:t.length)||0)+((null==(i=this.onceListeners.get(e))?void 0:i.length)||0)}hasListeners(e){return this.listenerCount(e)>0}destroy(){this.removeAllListeners()}}EventBus.Events={EDITOR_INIT:"editor:init",EDITOR_READY:"editor:ready",EDITOR_DESTROY:"editor:destroy",EDITOR_FOCUS:"editor:focus",EDITOR_BLUR:"editor:blur",CONTENT_CHANGE:"content:change",CONTENT_BEFORE_CHANGE:"content:beforeChange",CONTENT_PASTE:"content:paste",CONTENT_SET:"content:set",COMMAND_EXECUTE:"command:execute",COMMAND_BEFORE_EXECUTE:"command:beforeExecute",COMMAND_UNDO:"command:undo",COMMAND_REDO:"command:redo",SELECTION_CHANGE:"selection:change",TOOLBAR_UPDATE:"toolbar:update",TOOLBAR_BUTTON_CLICK:"toolbar:buttonClick",PLUGIN_LOAD:"plugin:load",PLUGIN_UNLOAD:"plugin:unload",DIALOG_OPEN:"dialog:open",DIALOG_CLOSE:"dialog:close",MODE_CHANGE:"mode:change",HISTORY_CHANGE:"history:change",HISTORY_SNAPSHOT:"history:snapshot",AUTOSAVE_START:"autosave:start",AUTOSAVE_SUCCESS:"autosave:success",AUTOSAVE_ERROR:"autosave:error"};class CommandManager{constructor(e){this.editor=e,this.commands=new Map,this.registerBuiltInCommands()}registerBuiltInCommands(){this.register("bold",{execute:()=>this.execNative("bold"),isActive:()=>document.queryCommandState("bold"),shortcut:"Ctrl+B"}),this.register("italic",{execute:()=>this.execNative("italic"),isActive:()=>document.queryCommandState("italic"),shortcut:"Ctrl+I"}),this.register("underline",{execute:()=>this.execNative("underline"),isActive:()=>document.queryCommandState("underline"),shortcut:"Ctrl+U"}),this.register("strikethrough",{execute:()=>this.execNative("strikeThrough"),isActive:()=>document.queryCommandState("strikeThrough")}),this.register("heading",{execute:e=>this.formatBlock(`h${e}`),isActive:e=>this.isBlockType(`h${e}`)}),this.register("paragraph",{execute:()=>this.formatBlock("p"),isActive:()=>this.isBlockType("p")}),this.register("blockquote",{execute:()=>this.formatBlock("blockquote"),isActive:()=>this.isBlockType("blockquote")}),this.register("pre",{execute:()=>this.formatBlock("pre"),isActive:()=>this.isBlockType("pre")}),this.register("insertOrderedList",{execute:()=>this.execNative("insertOrderedList"),isActive:()=>document.queryCommandState("insertOrderedList"),shortcut:"Ctrl+Shift+O"}),this.register("insertUnorderedList",{execute:()=>this.execNative("insertUnorderedList"),isActive:()=>document.queryCommandState("insertUnorderedList"),shortcut:"Ctrl+Shift+L"}),this.register("justifyLeft",{execute:()=>this.execNative("justifyLeft"),isActive:()=>document.queryCommandState("justifyLeft")}),this.register("justifyCenter",{execute:()=>this.execNative("justifyCenter"),isActive:()=>document.queryCommandState("justifyCenter")}),this.register("justifyRight",{execute:()=>this.execNative("justifyRight"),isActive:()=>document.queryCommandState("justifyRight")}),this.register("justifyFull",{execute:()=>this.execNative("justifyFull"),isActive:()=>document.queryCommandState("justifyFull")}),this.register("indent",{execute:()=>this.execNative("indent"),shortcut:"Tab"}),this.register("outdent",{execute:()=>this.execNative("outdent"),shortcut:"Shift+Tab"}),this.register("insertHorizontalRule",{execute:()=>this.execNative("insertHorizontalRule")}),this.register("createLink",{execute:e=>{e&&this.execNative("createLink",e)},shortcut:"Ctrl+K"}),this.register("unlink",{execute:()=>this.execNative("unlink")}),this.register("insertImage",{execute:e=>{e&&this.execNative("insertImage",e)}}),this.register("insertHTML",{execute:e=>{var t;e&&(null==(t=this.editor.selection)||t.insertHtml(e))}}),this.register("insertText",{execute:e=>{var t;e&&(null==(t=this.editor.selection)||t.insertText(e))}}),this.register("foreColor",{execute:e=>this.execNative("foreColor",e),getValue:()=>document.queryCommandValue("foreColor")}),this.register("backColor",{execute:e=>this.execNative("backColor",e),getValue:()=>document.queryCommandValue("backColor")}),this.register("removeFormat",{execute:()=>this.execNative("removeFormat")}),this.register("selectAll",{execute:()=>{var e;return null==(e=this.editor.selection)?void 0:e.selectAll()},shortcut:"Ctrl+A"}),this.register("undo",{execute:()=>{var e;return null==(e=this.editor.history)?void 0:e.undo()},canExecute:()=>{var e;return(null==(e=this.editor.history)?void 0:e.canUndo())||!1},shortcut:"Ctrl+Z"}),this.register("redo",{execute:()=>{var e;return null==(e=this.editor.history)?void 0:e.redo()},canExecute:()=>{var e;return(null==(e=this.editor.history)?void 0:e.canRedo())||!1},shortcut:"Ctrl+Y"})}register(e,t){this.commands.set(e,{execute:t.execute,isActive:t.isActive||(()=>!1),canExecute:t.canExecute||(()=>!0),getValue:t.getValue||(()=>null),shortcut:t.shortcut||null})}unregister(e){this.commands.delete(e)}execute(e,...t){var i,n,s,r,o,a,l;const c=this.commands.get(e);if(!c)return console.warn(`Command "${e}" not found`),!1;if(!c.canExecute(...t))return!1;null==(i=this.editor.events)||i.emit(EventBus.Events.COMMAND_BEFORE_EXECUTE,{name:e,args:t}),(null==(n=this.editor.contentArea)?void 0:n.hasFocus())||null==(s=this.editor.selection)||s.focus(),null==(r=this.editor.selection)||r.saveSelection();try{return c.execute(...t),null==(o=this.editor.history)||o.record(),null==(a=this.editor.events)||a.emit(EventBus.Events.COMMAND_EXECUTE,{name:e,args:t}),null==(l=this.editor.events)||l.emit(EventBus.Events.TOOLBAR_UPDATE),!0}catch(h){return console.error(`Error executing command "${e}":`,h),!1}}execNative(e,t=null){try{return document.execCommand(e,!1,t)}catch(i){return console.warn(`Native command "${e}" failed:`,i),!1}}formatBlock(e){const t=e.toLowerCase();this.isBlockType(t)?this.execNative("formatBlock","<p>"):this.execNative("formatBlock",`<${t}>`)}isBlockType(e){var t;const i=null==(t=this.editor.selection)?void 0:t.getParentBlock();return i&&i.tagName.toLowerCase()===e.toLowerCase()}isActive(e,...t){const i=this.commands.get(e);if(!i||"function"!=typeof i.isActive)return!1;try{return i.isActive(...t)}catch(n){return!1}}canExecute(e,...t){const i=this.commands.get(e);if(!i)return!1;try{return i.canExecute(...t)}catch(n){return!1}}getValue(e){const t=this.commands.get(e);if(!t||"function"!=typeof t.getValue)return null;try{return t.getValue()}catch(i){return null}}getShortcut(e){const t=this.commands.get(e);return(null==t?void 0:t.shortcut)||null}getCommandNames(){return Array.from(this.commands.keys())}hasCommand(e){return this.commands.has(e)}getFormattingState(){return{bold:this.isActive("bold"),italic:this.isActive("italic"),underline:this.isActive("underline"),strikethrough:this.isActive("strikethrough"),orderedList:this.isActive("insertOrderedList"),unorderedList:this.isActive("insertUnorderedList"),justifyLeft:this.isActive("justifyLeft"),justifyCenter:this.isActive("justifyCenter"),justifyRight:this.isActive("justifyRight"),justifyFull:this.isActive("justifyFull"),foreColor:this.getValue("foreColor"),backColor:this.getValue("backColor")}}destroy(){this.commands.clear()}}class HistoryManager{constructor(e,t={}){this.editor=e,this.options={maxHistory:100,debounceDelay:300,...t},this.undoStack=[],this.redoStack=[],this.currentState=null,this.debounceTimer=null,this.isRecording=!0,this.batchLevel=0,this.batchState=null}init(){var e;const t=(null==(e=this.editor.contentArea)?void 0:e.getContent())||"";this.currentState=this.createSnapshot(t),this.undoStack=[],this.redoStack=[]}createSnapshot(e){var t;return{content:e,timestamp:Date.now(),selection:null==(t=this.editor.selection)?void 0:t.saveSelection()}}record(e=!1){!this.isRecording||this.batchLevel>0||(this.debounceTimer&&clearTimeout(this.debounceTimer),e?this.recordImmediate():this.debounceTimer=setTimeout(()=>{this.recordImmediate()},this.options.debounceDelay))}recordImmediate(){var e,t,i;const n=(null==(e=this.editor.contentArea)?void 0:e.getContent())||"";this.currentState&&this.currentState.content===n||(this.currentState&&(this.undoStack.push(this.currentState),this.undoStack.length>this.options.maxHistory&&this.undoStack.shift()),this.currentState=this.createSnapshot(n),this.redoStack=[],null==(t=this.editor.events)||t.emit(EventBus.Events.HISTORY_CHANGE,{canUndo:this.canUndo(),canRedo:this.canRedo()}),null==(i=this.editor.events)||i.emit(EventBus.Events.HISTORY_SNAPSHOT,this.currentState))}startBatch(){0===this.batchLevel&&(this.batchState=this.currentState),this.batchLevel++}endBatch(){this.batchLevel--,0===this.batchLevel&&this.recordImmediate()}batch(e){this.startBatch();try{e()}finally{this.endBatch()}}canUndo(){return this.undoStack.length>0}canRedo(){return this.redoStack.length>0}undo(){var e,t,i,n;if(!this.canUndo())return!1;const s=(null==(e=this.editor.contentArea)?void 0:e.getContent())||"";return this.currentState&&this.currentState.content!==s&&(this.currentState=this.createSnapshot(s)),this.currentState&&this.redoStack.push(this.currentState),this.currentState=this.undoStack.pop(),this.isRecording=!1,null==(t=this.editor.contentArea)||t.setContent(this.currentState.content),this.currentState.selection&&(this.editor.selection.savedSelection=this.currentState.selection,this.editor.selection.restoreSelection()),this.isRecording=!0,null==(i=this.editor.events)||i.emit(EventBus.Events.COMMAND_UNDO,this.currentState),null==(n=this.editor.events)||n.emit(EventBus.Events.HISTORY_CHANGE,{canUndo:this.canUndo(),canRedo:this.canRedo()}),!0}redo(){var e,t,i;return!!this.canRedo()&&(this.currentState&&this.undoStack.push(this.currentState),this.currentState=this.redoStack.pop(),this.isRecording=!1,null==(e=this.editor.contentArea)||e.setContent(this.currentState.content),this.currentState.selection&&(this.editor.selection.savedSelection=this.currentState.selection,this.editor.selection.restoreSelection()),this.isRecording=!0,null==(t=this.editor.events)||t.emit(EventBus.Events.COMMAND_REDO,this.currentState),null==(i=this.editor.events)||i.emit(EventBus.Events.HISTORY_CHANGE,{canUndo:this.canUndo(),canRedo:this.canRedo()}),!0)}clear(){var e,t;this.undoStack=[],this.redoStack=[],this.currentState=this.createSnapshot((null==(e=this.editor.contentArea)?void 0:e.getContent())||""),null==(t=this.editor.events)||t.emit(EventBus.Events.HISTORY_CHANGE,{canUndo:!1,canRedo:!1})}pause(){this.isRecording=!1}resume(){this.isRecording=!0}getInfo(){return{undoCount:this.undoStack.length,redoCount:this.redoStack.length,canUndo:this.canUndo(),canRedo:this.canRedo()}}destroy(){this.debounceTimer&&clearTimeout(this.debounceTimer),this.undoStack=[],this.redoStack=[],this.currentState=null}}class SelectionManager{constructor(e){this.editor=e,this.savedSelection=null}getSelection(){return window.getSelection()}getRange(){const e=this.getSelection();return e&&e.rangeCount>0?e.getRangeAt(0):null}isWithinEditor(){const e=this.getRange();if(!e||!this.editor.contentArea)return!1;const t=this.editor.contentArea.getElement();return t&&t.contains(e.commonAncestorContainer)}hasSelection(){const e=this.getRange();return e&&!e.collapsed}getSelectedText(){const e=this.getSelection();return e?e.toString():""}getSelectedHtml(){const e=this.getRange();if(!e)return"";const t=e.cloneContents(),i=document.createElement("div");return i.appendChild(t),i.innerHTML}saveSelection(){const e=this.getRange();return e&&this.isWithinEditor()?(this.savedSelection={startContainer:e.startContainer,startOffset:e.startOffset,endContainer:e.endContainer,endOffset:e.endOffset,collapsed:e.collapsed},this.savedSelection):null}restoreSelection(){if(!this.savedSelection)return!1;try{const e=this.getSelection(),t=document.createRange();return t.setStart(this.savedSelection.startContainer,this.savedSelection.startOffset),t.setEnd(this.savedSelection.endContainer,this.savedSelection.endOffset),e.removeAllRanges(),e.addRange(t),!0}catch(e){return console.warn("Failed to restore selection:",e),!1}}clearSavedSelection(){this.savedSelection=null}selectAll(){var e;const t=null==(e=this.editor.contentArea)?void 0:e.getElement();if(!t)return;const i=document.createRange();i.selectNodeContents(t);const n=this.getSelection();n.removeAllRanges(),n.addRange(i)}collapseToStart(){const e=this.getSelection();e&&e.collapseToStart()}collapseToEnd(){const e=this.getSelection();e&&e.collapseToEnd()}setCursorAtEnd(e){const t=document.createRange(),i=this.getSelection();t.selectNodeContents(e),t.collapse(!1),i.removeAllRanges(),i.addRange(t)}setCursorAtStart(e){const t=document.createRange(),i=this.getSelection();t.selectNodeContents(e),t.collapse(!0),i.removeAllRanges(),i.addRange(t)}insertHtml(e){var t;const i=null==(t=this.editor.contentArea)?void 0:t.getElement();if(!i)return;let n=this.getRange();if(!n||!this.isWithinEditor()){i.focus(),n=document.createRange(),i.lastChild?n.setStartAfter(i.lastChild):n.setStart(i,0),n.collapse(!0);const e=this.getSelection();e.removeAllRanges(),e.addRange(n)}n.deleteContents();const s=document.createRange().createContextualFragment(e),r=s.lastChild;if(n.insertNode(s),r){const e=document.createRange();e.setStartAfter(r),e.collapse(!0);const t=this.getSelection();t.removeAllRanges(),t.addRange(e)}}insertText(e){const t=this.getRange();if(!t||!this.isWithinEditor())return;t.deleteContents();const i=document.createTextNode(e);t.insertNode(i);const n=document.createRange();n.setStartAfter(i),n.collapse(!0);const s=this.getSelection();s.removeAllRanges(),s.addRange(n)}wrapSelection(e,t={}){const i=this.getRange();if(!i||i.collapsed||!this.isWithinEditor())return null;const n=document.createElement(e);Object.entries(t).forEach(([e,t])=>{n.setAttribute(e,t)});try{return i.surroundContents(n),n}catch(s){const e=i.extractContents();return n.appendChild(e),i.insertNode(n),n}}unwrapSelection(e){var t;const i=this.getRange();if(!i||!this.isWithinEditor())return;const n=i.commonAncestorContainer,s=(n.nodeType===Node.ELEMENT_NODE?n:n.parentElement).closest(e);if(s&&(null==(t=this.editor.contentArea)?void 0:t.getElement().contains(s))){const e=s.parentNode;for(;s.firstChild;)e.insertBefore(s.firstChild,s);e.removeChild(s)}}getParentBlock(){var e;const t=this.getRange();if(!t)return null;const i=["P","H1","H2","H3","H4","H5","H6","DIV","LI","BLOCKQUOTE","PRE"];let n=t.commonAncestorContainer;for(n.nodeType===Node.TEXT_NODE&&(n=n.parentElement);n&&n!==(null==(e=this.editor.contentArea)?void 0:e.getElement());){if(n.nodeType===Node.ELEMENT_NODE&&i.includes(n.tagName))return n;n=n.parentElement}return null}getAncestor(e){var t;const i=this.getRange();if(!i)return null;let n=i.commonAncestorContainer;if(n.nodeType===Node.TEXT_NODE&&(n=n.parentElement),n&&"function"==typeof n.closest){const i=n.closest(e);if(i&&(null==(t=this.editor.contentArea)?void 0:t.getElement().contains(i)))return i}return null}containsElement(e){return null!==this.getAncestor(e)}isStyleApplied(e){try{return document.queryCommandState(e)}catch(t){return!1}}focus(){var e;const t=null==(e=this.editor.contentArea)?void 0:e.getElement();t&&(t.focus(),this.restoreSelection())}destroy(){this.savedSelection=null}}class KeyboardManager{constructor(e){this.editor=e,this.shortcuts=new Map,this.enabled=!0,this.handleKeyDown=this.handleKeyDown.bind(this)}init(){this.registerDefaultShortcuts(),this.attachListeners()}registerDefaultShortcuts(){this.register("ctrl+b","bold"),this.register("ctrl+i","italic"),this.register("ctrl+u","underline"),this.register("ctrl+z","undo"),this.register("ctrl+y","redo"),this.register("ctrl+shift+z","redo"),this.register("ctrl+shift+l","insertUnorderedList"),this.register("ctrl+shift+o","insertOrderedList"),this.register("ctrl+k",()=>{var e;null==(e=this.editor.events)||e.emit("toolbar:buttonClick",{id:"link"})}),this.register("ctrl+a","selectAll"),this.register("tab",e=>{var t;e.preventDefault(),null==(t=this.editor.commands)||t.execute("indent")}),this.register("shift+tab",e=>{var t;e.preventDefault(),null==(t=this.editor.commands)||t.execute("outdent")}),this.register("escape",()=>{var e;null==(e=this.editor.events)||e.emit(EventBus.Events.DIALOG_CLOSE)})}attachListeners(){var e;const t=null==(e=this.editor.contentArea)?void 0:e.getElement();t&&t.addEventListener("keydown",this.handleKeyDown)}detachListeners(){var e;const t=null==(e=this.editor.contentArea)?void 0:e.getElement();t&&t.removeEventListener("keydown",this.handleKeyDown)}handleKeyDown(e){var t;if(!this.enabled)return;const i=this.normalizeShortcut(e),n=this.shortcuts.get(i);n&&("string"==typeof n?(e.preventDefault(),null==(t=this.editor.commands)||t.execute(n)):"function"==typeof n&&n(e))}normalizeShortcut(e){const t=[];(e.ctrlKey||e.metaKey)&&t.push("ctrl"),e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt");let i=e.key.toLowerCase();const n={" ":"space",control:null,shift:null,alt:null,meta:null,arrowup:"up",arrowdown:"down",arrowleft:"left",arrowright:"right",enter:"enter",escape:"escape",backspace:"backspace",delete:"delete",tab:"tab"};return n.hasOwnProperty(i)&&(i=n[i]),i&&t.push(i),t.join("+")}parseShortcut(e){const t=e.toLowerCase().split("+").map(e=>e.trim()),i=[];let n="";return t.forEach(e=>{["ctrl","cmd","meta"].includes(e)?i.push("ctrl"):["shift"].includes(e)?i.push("shift"):["alt","option"].includes(e)?i.push("alt"):n=e}),i.sort(),[...i,n].join("+")}register(e,t){const i=this.parseShortcut(e);this.shortcuts.set(i,t)}unregister(e){const t=this.parseShortcut(e);this.shortcuts.delete(t)}hasShortcut(e){const t=this.parseShortcut(e);return this.shortcuts.has(t)}getHandler(e){const t=this.parseShortcut(e);return this.shortcuts.get(t)||null}getAllShortcuts(){return new Map(this.shortcuts)}formatForDisplay(e){const t=navigator.platform.toUpperCase().indexOf("MAC")>=0,i=e.split("+").map(e=>{switch(e.toLowerCase()){case"ctrl":return t?"⌘":"Ctrl";case"shift":return t?"⇧":"Shift";case"alt":return t?"⌥":"Alt";case"enter":return t?"↩":"Enter";case"escape":return"Esc";case"tab":return"Tab";case"backspace":return t?"⌫":"Backspace";case"delete":return t?"⌦":"Del";case"up":return"↑";case"down":return"↓";case"left":return"←";case"right":return"→";default:return e.toUpperCase()}});return t?i.join(""):i.join("+")}enable(){this.enabled=!0}disable(){this.enabled=!1}isEnabled(){return this.enabled}destroy(){this.detachListeners(),this.shortcuts.clear()}}class Toolbar{constructor(e,t={}){this.editor=e,this.options={items:Toolbar.defaultItems,sticky:!1,...t},this.element=null,this.buttons=new Map,this.dropdowns=new Map,this.activeDropdown=null,this.handleButtonClick=this.handleButtonClick.bind(this),this.handleButtonMousedown=this.handleButtonMousedown.bind(this),this.handleDocumentClick=this.handleDocumentClick.bind(this),this.updateButtonStates=this.updateButtonStates.bind(this)}create(){var e,t;return this.element=document.createElement("div"),this.element.className="rte-toolbar",this.element.setAttribute("role","toolbar"),this.element.setAttribute("aria-label","Text formatting toolbar"),this.options.sticky&&this.element.classList.add("sticky"),this.buildItems(),null==(e=this.editor.events)||e.on(EventBus.Events.TOOLBAR_UPDATE,this.updateButtonStates),null==(t=this.editor.events)||t.on(EventBus.Events.SELECTION_CHANGE,this.updateButtonStates),document.addEventListener("click",this.handleDocumentClick),this.element}buildItems(){const e=this.options.items;(Array.isArray(e[0])?e:[e]).forEach((e,t)=>{const i=document.createElement("div");i.className="rte-toolbar-group",e.forEach(e=>{if("|"===e||"separator"===e){const e=document.createElement("div");e.className="rte-toolbar-separator",i.appendChild(e)}else{const t=Toolbar.buttonDefinitions[e];if(t){const n=this.createButton(e,t);i.appendChild(n)}}}),this.element.appendChild(i)})}createButton(e,t){var i,n;if("dropdown"===t.type)return this.createDropdownButton(e,t);const s=document.createElement("button");if(s.type="button",s.className="rte-toolbar-btn",s.dataset.command=e,s.setAttribute("aria-label",(null==(i=window.translate)?void 0:i.call(window,t.title))||t.title),s.setAttribute("title",this.getButtonTooltip(e,t)),t.icon){const e=document.createElement("span");e.className=`rte-icon ${t.icon}`,e.setAttribute("aria-hidden","true"),s.appendChild(e)}else t.text&&(s.textContent=(null==(n=window.translate)?void 0:n.call(window,t.text))||t.text);return s.addEventListener("mousedown",this.handleButtonMousedown),s.addEventListener("click",i=>this.handleButtonClick(i,e,t)),this.buttons.set(e,{element:s,definition:t}),s}createDropdownButton(e,t){const i=document.createElement("div");i.className="rte-toolbar-dropdown";const n=document.createElement("button");if(n.type="button",n.className="rte-toolbar-btn rte-dropdown-trigger",n.dataset.command=e,n.setAttribute("aria-haspopup","true"),n.setAttribute("aria-expanded","false"),n.setAttribute("title",this.getButtonTooltip(e,t)),t.icon){const e=document.createElement("span");e.className=`rte-icon ${t.icon}`,e.setAttribute("aria-hidden","true"),n.appendChild(e)}const s=document.createElement("span");s.className="rte-dropdown-arrow",s.innerHTML="▼",n.appendChild(s);const r=document.createElement("div");if(r.className="rte-dropdown-menu",r.setAttribute("role","menu"),t.items&&t.items.forEach(i=>{var n,s;const o=document.createElement("button");if(o.type="button",o.className="rte-dropdown-item",o.dataset.value=i.value,o.setAttribute("role","menuitem"),i.icon){const e=document.createElement("span");e.className=`rte-icon ${i.icon}`,o.appendChild(e)}const a=document.createElement("span");if(a.className="rte-dropdown-item-label",a.textContent=(null==(n=window.translate)?void 0:n.call(window,i.label))||i.label,i.tag){const e=document.createElement(i.tag);e.style.margin="0",e.style.fontSize=i.fontSize||"inherit",e.textContent=(null==(s=window.translate)?void 0:s.call(window,i.label))||i.label,o.appendChild(e)}else o.appendChild(a);o.addEventListener("click",n=>{n.stopPropagation(),this.handleDropdownItemClick(e,i,t)}),r.appendChild(o)}),t.colorPicker){const i=this.createColorPicker(e,t);r.appendChild(i)}return n.addEventListener("mousedown",this.handleButtonMousedown),n.addEventListener("click",t=>{t.stopPropagation(),this.toggleDropdown(e,i,n)}),i.appendChild(n),i.appendChild(r),this.buttons.set(e,{element:n,definition:t}),this.dropdowns.set(e,{container:i,button:n,menu:r}),i}createColorPicker(e,t){var i,n;const s=document.createElement("div");s.className="rte-color-picker";const r=t.colors||Toolbar.defaultColors,o=document.createElement("div");o.className="rte-color-grid",r.forEach(i=>{const n=document.createElement("button");n.type="button",n.className="rte-color-btn",n.style.backgroundColor=i,n.dataset.color=i,n.setAttribute("title",i),n.addEventListener("click",n=>{n.stopPropagation(),this.handleColorSelect(e,i,t)}),o.appendChild(n)}),s.appendChild(o);const a=document.createElement("div");a.className="rte-color-custom";const l=document.createElement("input");l.type="color",l.className="rte-color-input",l.value="#000000";const c=document.createElement("span");if(c.textContent=(null==(i=window.translate)?void 0:i.call(window,"Custom color"))||"Custom color",l.addEventListener("change",i=>{this.handleColorSelect(e,i.target.value,t)}),a.appendChild(l),a.appendChild(c),s.appendChild(a),t.allowClear){const i=document.createElement("button");i.type="button",i.className="rte-color-clear",i.textContent=(null==(n=window.translate)?void 0:n.call(window,"Remove color"))||"Remove color",i.addEventListener("click",i=>{i.stopPropagation(),this.handleColorSelect(e,null,t)}),s.appendChild(i)}return s}getButtonTooltip(e,t){var i,n,s;let r=(null==(i=window.translate)?void 0:i.call(window,t.title))||t.title;const o=null==(n=this.editor.keyboard)?void 0:n.getHandler(t.command||e);if("string"==typeof o){const e=null==(s=this.editor.keyboard)?void 0:s.formatForDisplay(o);e&&(r+=` (${e})`)}return r}handleButtonMousedown(e){var t;e.preventDefault(),(null==(t=this.editor.selection)?void 0:t.isWithinEditor())&&this.editor.selection.saveSelection()}handleButtonClick(e,t,i){var n,s,r;e.preventDefault(),e.stopPropagation(),null==(n=this.editor.selection)||n.restoreSelection(),i.command?null==(s=this.editor.commands)||s.execute(i.command,i.value):null==(r=this.editor.events)||r.emit(EventBus.Events.TOOLBAR_BUTTON_CLICK,{id:t,def:i})}handleDropdownItemClick(e,t,i){var n,s,r,o;this.closeAllDropdowns(),null==(n=this.editor.selection)||n.restoreSelection(),t.command?null==(s=this.editor.commands)||s.execute(t.command,t.value):i.command?null==(r=this.editor.commands)||r.execute(i.command,t.value):null==(o=this.editor.events)||o.emit(EventBus.Events.TOOLBAR_BUTTON_CLICK,{id:e,item:t,def:i})}handleColorSelect(e,t,i){var n,s,r;this.closeAllDropdowns(),null==(n=this.editor.selection)||n.restoreSelection(),i.command&&(t?null==(s=this.editor.commands)||s.execute(i.command,t):null==(r=this.editor.commands)||r.execute("removeFormat"))}toggleDropdown(e,t,i){var n;const s=t.classList.contains("open");this.closeAllDropdowns(),s||(null==(n=this.editor.selection)||n.saveSelection(),t.classList.add("open"),i.setAttribute("aria-expanded","true"),this.activeDropdown=e)}closeAllDropdowns(){this.dropdowns.forEach(({container:e,button:t})=>{e.classList.remove("open"),t.setAttribute("aria-expanded","false")}),this.activeDropdown=null}handleDocumentClick(e){if(this.activeDropdown){const t=this.dropdowns.get(this.activeDropdown);t&&!t.container.contains(e.target)&&this.closeAllDropdowns()}}updateButtonStates(){var e;(null==(e=this.editor.contentArea)?void 0:e.hasFocus())&&this.buttons.forEach(({element:e,definition:t},i)=>{var n,s;if(t.command){const i=null==(n=this.editor.commands)?void 0:n.isActive(t.command,t.value);e.classList.toggle("active",i),e.setAttribute("aria-pressed",i)}if(t.canExecute){const i="function"==typeof t.canExecute?t.canExecute(this.editor):null==(s=this.editor.commands)?void 0:s.canExecute(t.command);e.disabled=!i}})}getElement(){return this.element}setItems(e){this.options.items=e,this.element&&(this.element.innerHTML="",this.buttons.clear(),this.dropdowns.clear(),this.buildItems())}enableButton(e){const t=this.buttons.get(e);t&&(t.element.disabled=!1)}disableButton(e){const t=this.buttons.get(e);t&&(t.element.disabled=!0)}showButton(e){const t=this.buttons.get(e);t&&(t.element.style.display="")}hideButton(e){const t=this.buttons.get(e);t&&(t.element.style.display="none")}destroy(){var e,t;document.removeEventListener("click",this.handleDocumentClick),null==(e=this.editor.events)||e.off(EventBus.Events.TOOLBAR_UPDATE,this.updateButtonStates),null==(t=this.editor.events)||t.off(EventBus.Events.SELECTION_CHANGE,this.updateButtonStates),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.buttons.clear(),this.dropdowns.clear(),this.element=null}}Toolbar.defaultItems=["bold","italic","underline","strikethrough","|","heading","|","bulletList","numberedList","|","alignLeft","alignCenter","alignRight","|","indent","outdent","|","link","image","|","textColor","backgroundColor","|","undo","redo","|","removeFormat","sourceView"],Toolbar.defaultColors=["#000000","#434343","#666666","#999999","#b7b7b7","#cccccc","#d9d9d9","#efefef","#f3f3f3","#ffffff","#980000","#ff0000","#ff9900","#ffff00","#00ff00","#00ffff","#4a86e8","#0000ff","#9900ff","#ff00ff","#e6b8af","#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#c9daf8","#cfe2f3","#d9d2e9","#ead1dc","#dd7e6b","#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#a4c2f4","#9fc5e8","#b4a7d6","#d5a6bd"],Toolbar.buttonDefinitions={bold:{icon:"icon-bold",title:"Bold",command:"bold"},italic:{icon:"icon-italic",title:"Italic",command:"italic"},underline:{icon:"icon-underline",title:"Underline",command:"underline"},strikethrough:{icon:"icon-strikethrough",title:"Strikethrough",command:"strikethrough"},heading:{icon:"icon-heading",title:"Heading",type:"dropdown",items:[{label:"Paragraph",value:"p",tag:"p",command:"paragraph"},{label:"Heading 1",value:1,tag:"h1",fontSize:"2em",command:"heading"},{label:"Heading 2",value:2,tag:"h2",fontSize:"1.5em",command:"heading"},{label:"Heading 3",value:3,tag:"h3",fontSize:"1.17em",command:"heading"},{label:"Heading 4",value:4,tag:"h4",fontSize:"1em",command:"heading"},{label:"Heading 5",value:5,tag:"h5",fontSize:"0.83em",command:"heading"},{label:"Heading 6",value:6,tag:"h6",fontSize:"0.67em",command:"heading"}]},bulletList:{icon:"icon-list",title:"Bullet list",command:"insertUnorderedList"},numberedList:{icon:"icon-list-ol",title:"Numbered list",command:"insertOrderedList"},alignLeft:{icon:"icon-align-left",title:"Align left",command:"justifyLeft"},alignCenter:{icon:"icon-align-center",title:"Align center",command:"justifyCenter"},alignRight:{icon:"icon-align-right",title:"Align right",command:"justifyRight"},alignJustify:{icon:"icon-align-justify",title:"Justify",command:"justifyFull"},indent:{icon:"icon-indent",title:"Increase indent",command:"indent"},outdent:{icon:"icon-outdent",title:"Decrease indent",command:"outdent"},link:{icon:"icon-link",title:"Insert link"},image:{icon:"icon-image",title:"Insert image"},video:{icon:"icon-video",title:"Insert video"},table:{icon:"icon-table",title:"Insert table"},horizontalRule:{icon:"icon-minus",title:"Horizontal line",command:"insertHorizontalRule"},blockquote:{icon:"icon-blockquote",title:"Blockquote",command:"blockquote"},codeBlock:{icon:"icon-code",title:"Code block",command:"pre"},textColor:{icon:"icon-text-color",title:"Text color",type:"dropdown",colorPicker:!0,command:"foreColor"},backgroundColor:{icon:"icon-highlight",title:"Background color",type:"dropdown",colorPicker:!0,allowClear:!0,command:"backColor"},specialChars:{icon:"icon-omega",title:"Special characters"},emoji:{icon:"icon-emoji",title:"Emoji"},undo:{icon:"icon-undo",title:"Undo",command:"undo",canExecute:e=>{var t;return null==(t=e.history)?void 0:t.canUndo()}},redo:{icon:"icon-redo",title:"Redo",command:"redo",canExecute:e=>{var t;return null==(t=e.history)?void 0:t.canRedo()}},removeFormat:{icon:"icon-eraser",title:"Clear formatting",command:"removeFormat"},sourceView:{icon:"icon-code-alt",title:"Source code"},fullscreen:{icon:"icon-fullscreen",title:"Fullscreen"},findReplace:{icon:"icon-search",title:"Find and replace"}};class ContentArea{constructor(e,t={}){this.editor=e,this.options={minHeight:200,maxHeight:null,autoResize:!0,placeholder:"",readOnly:!1,...t},this.element=null,this.focused=!1,this.handleInput=this.handleInput.bind(this),this.handleFocus=this.handleFocus.bind(this),this.handleBlur=this.handleBlur.bind(this),this.handlePaste=this.handlePaste.bind(this),this.handleDrop=this.handleDrop.bind(this),this.handleDragOver=this.handleDragOver.bind(this)}create(){return this.container=document.createElement("div"),this.container.className="rte-content-wrapper",this.element=document.createElement("div"),this.element.className="rte-content",this.element.contentEditable=!this.options.readOnly,this.element.setAttribute("role","textbox"),this.element.setAttribute("aria-multiline","true"),this.element.setAttribute("aria-label","Rich text editor content"),this.element.setAttribute("data-placeholder",this.options.placeholder),this.options.minHeight&&(this.element.style.minHeight=`${this.options.minHeight}px`),this.options.maxHeight&&(this.element.style.maxHeight=`${this.options.maxHeight}px`,this.element.style.overflowY="auto"),this.container.appendChild(this.element),this.attachListeners(),this.container}attachListeners(){this.element.addEventListener("input",this.handleInput),this.element.addEventListener("focus",this.handleFocus),this.element.addEventListener("blur",this.handleBlur),this.element.addEventListener("paste",this.handlePaste),this.element.addEventListener("drop",this.handleDrop),this.element.addEventListener("dragover",this.handleDragOver),this.element.addEventListener("mouseup",()=>{var e;null==(e=this.editor.events)||e.emit(EventBus.Events.SELECTION_CHANGE)}),this.element.addEventListener("keyup",e=>{var t;["ArrowUp","ArrowDown","ArrowLeft","ArrowRight","Home","End"].includes(e.key)&&(null==(t=this.editor.events)||t.emit(EventBus.Events.SELECTION_CHANGE))})}detachListeners(){this.element&&(this.element.removeEventListener("input",this.handleInput),this.element.removeEventListener("focus",this.handleFocus),this.element.removeEventListener("blur",this.handleBlur),this.element.removeEventListener("paste",this.handlePaste),this.element.removeEventListener("drop",this.handleDrop),this.element.removeEventListener("dragover",this.handleDragOver))}handleInput(){var e,t;null==(e=this.editor.history)||e.record(),null==(t=this.editor.events)||t.emit(EventBus.Events.CONTENT_CHANGE,this.getContent())}handleFocus(){var e,t;this.focused=!0,null==(e=this.container)||e.classList.add("focused"),null==(t=this.editor.events)||t.emit(EventBus.Events.EDITOR_FOCUS)}handleBlur(){var e,t;this.focused=!1,null==(e=this.container)||e.classList.remove("focused"),null==(t=this.editor.events)||t.emit(EventBus.Events.EDITOR_BLUR)}handlePaste(e){var t,i;if(null==(t=this.editor.events)||t.emit(EventBus.Events.CONTENT_PASTE,e),!e.defaultPrevented){const t=e.clipboardData||window.clipboardData;if(t){const n=t.getData("text/html");if(t.getData("text/plain"),n){e.preventDefault();const t=this.cleanPastedHtml(n);null==(i=this.editor.selection)||i.insertHtml(t),this.handleInput()}}}}cleanPastedHtml(e){const t=document.createElement("div");t.innerHTML=e;t.querySelectorAll('[class^="Mso"], [style*="mso-"]').forEach(e=>{if(e.hasAttribute("style")){const t=e.getAttribute("style").split(";").filter(e=>!e.trim().startsWith("mso-")).join(";");t.trim()?e.setAttribute("style",t):e.removeAttribute("style")}e.className=e.className.split(" ").filter(e=>!e.startsWith("Mso")).join(" "),e.className||e.removeAttribute("class")}),t.querySelectorAll("script, style, meta, link").forEach(e=>e.remove());const i=document.createNodeIterator(t,NodeFilter.SHOW_COMMENT,null,!1);let n;for(;n=i.nextNode();)n.parentNode.removeChild(n);return t.querySelectorAll("span:empty").forEach(e=>e.remove()),t.querySelectorAll("span").forEach(e=>{if(!e.hasAttribute("style")&&!e.hasAttribute("class")){for(;e.firstChild;)e.parentNode.insertBefore(e.firstChild,e);e.parentNode.removeChild(e)}}),t.querySelectorAll("font").forEach(e=>{for(;e.firstChild;)e.parentNode.insertBefore(e.firstChild,e);e.parentNode.removeChild(e)}),t.innerHTML}handleDrop(e){var t,i;const n=null==(t=e.dataTransfer)?void 0:t.files;n&&n.length>0&&(null==(i=this.editor.events)||i.emit("content:drop",{event:e,files:Array.from(n)}))}handleDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="copy"}isEmpty(){var e,t;if(!this.element)return!0;const i=null==(e=this.element.textContent)?void 0:e.trim(),n=null==(t=this.element.innerHTML)?void 0:t.trim();return!(i||n&&"<br>"!==n&&"<p></p>"!==n&&"<p><br></p>"!==n&&"<div></div>"!==n&&"<div><br></div>"!==n)}getElement(){return this.element}getContainer(){return this.container}getContent(){return this.element?this.isEmpty()?"":this.element.innerHTML:""}setContent(e,t=!1){var i,n;this.element&&(this.element.innerHTML=e,t&&(null==(i=this.editor.history)||i.record(!0)),null==(n=this.editor.events)||n.emit(EventBus.Events.CONTENT_SET,e))}clear(){this.setContent("",!0)}focus(){this.element&&this.element.focus()}blur(){this.element&&this.element.blur()}hasFocus(){return this.focused}setReadOnly(e){this.options.readOnly=e,this.element&&(this.element.contentEditable=!e)}isReadOnly(){return this.options.readOnly}setPlaceholder(e){this.options.placeholder=e,this.element&&this.element.setAttribute("data-placeholder",e)}getTextContent(){var e;return(null==(e=this.element)?void 0:e.textContent)||""}getWordCount(){const e=this.getTextContent().trim();return e?e.split(/\s+/).filter(e=>e.length>0).length:0}getCharacterCount(e=!1){const t=this.getTextContent();return e?t.replace(/\s/g,"").length:t.length}destroy(){this.detachListeners(),this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container),this.element=null,this.container=null}}class RichTextEditor2{constructor(e,t={}){if(this.targetElement="string"==typeof e?document.querySelector(e):e,!this.targetElement)throw new Error("RichTextEditor: Target element not found");this.options={height:"auto",minHeight:200,maxHeight:null,placeholder:"",readOnly:!1,toolbar:Toolbar.defaultItems,stickyToolbar:!1,plugins:[],autofocus:!1,sanitize:!0,...t},this.events=null,this.commands=null,this.history=null,this.selection=null,this.keyboard=null,this.toolbar=null,this.contentArea=null,this.container=null,this.plugins=new Map,this.initialized=!1,this.isSourceMode=!1,this.isFullscreen=!1,this.init()}init(){if(this.events=new EventBus,this.selection=new SelectionManager(this),this.commands=new CommandManager(this),this.history=new HistoryManager(this,{maxHistory:this.options.maxHistory||100}),this.keyboard=new KeyboardManager(this),this.buildUI(),this.keyboard.init(),this.history.init(),this.loadPlugins(),"TEXTAREA"===this.targetElement.tagName){const e=this.targetElement.value;e&&this.setContent(e)}this.initialized=!0,this.events.emit(EventBus.Events.EDITOR_INIT,this),this.options.autofocus&&this.focus(),requestAnimationFrame(()=>{this.events.emit(EventBus.Events.EDITOR_READY,this),this.plugins.forEach(e=>{var t;return null==(t=e.onReady)?void 0:t.call(e)})})}buildUI(){if(this.container=document.createElement("div"),this.container.className="rte-container","auto"!==this.options.height&&(this.container.style.height="number"==typeof this.options.height?`${this.options.height}px`:this.options.height),this.toolbar=new Toolbar(this,{items:this.options.toolbar,sticky:this.options.stickyToolbar}),this.container.appendChild(this.toolbar.create()),this.contentArea=new ContentArea(this,{minHeight:this.options.minHeight,maxHeight:this.options.maxHeight,placeholder:this.options.placeholder,readOnly:this.options.readOnly}),this.container.appendChild(this.contentArea.create()),this.footer=document.createElement("div"),this.footer.className="rte-footer",this.container.appendChild(this.footer),"TEXTAREA"===this.targetElement.tagName)this.targetElement.style.display="none",this.targetElement.parentNode.insertBefore(this.container,this.targetElement.nextSibling),this.events.on(EventBus.Events.CONTENT_CHANGE,()=>{this.targetElement.value=this.getContent()});else{const e=this.targetElement.innerHTML;this.targetElement.innerHTML="",this.targetElement.appendChild(this.container),e.trim()&&this.setContent(e)}}loadPlugins(){this.options.plugins.forEach(e=>{let t,i={};"string"==typeof e?(t=RichTextEditor2.registeredPlugins.get(e),i=this.options[e]||{}):"object"==typeof e?(t=e.plugin||RichTextEditor2.registeredPlugins.get(e.name),i=e.options||this.options[e.name]||{}):"function"==typeof e&&(t=e),t?this.loadPlugin(t,i):"string"==typeof e&&console.warn(`RichTextEditor: Plugin "${e}" not found`)})}loadPlugin(e,t={}){const i=e.pluginName||e.name;if(this.plugins.has(i))return void console.warn(`RichTextEditor: Plugin "${i}" already loaded`);const n=e.requires||[];for(const r of n)this.plugins.has(r)||console.warn(`RichTextEditor: Plugin "${i}" requires "${r}"`);const s=new e(this,t);s.init(),this.plugins.set(i,s),this.events.emit(EventBus.Events.PLUGIN_LOAD,{name:i,plugin:s})}unloadPlugin(e){const t=this.plugins.get(e);t&&(t.destroy(),this.plugins.delete(e),this.events.emit(EventBus.Events.PLUGIN_UNLOAD,{name:e}))}getPlugin(e){return this.plugins.get(e)||null}getContent(){var e,t;return this.isSourceMode?(null==(e=this.sourceEditor)?void 0:e.value)||"":(null==(t=this.contentArea)?void 0:t.getContent())||""}setContent(e,t=!0){var i;const n=this.options.sanitize?this.sanitizeHtml(e):e;this.isSourceMode?this.sourceEditor&&(this.sourceEditor.value=n):null==(i=this.contentArea)||i.setContent(n,t),this.events.emit(EventBus.Events.CONTENT_SET,n)}sanitizeHtml(e){if(!e)return"";const t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll("script").forEach(e=>e.remove()),t.querySelectorAll("*").forEach(e=>{Array.from(e.attributes).forEach(t=>{(t.name.startsWith("on")||t.value.includes("javascript:"))&&e.removeAttribute(t.name)})}),t.innerHTML}clear(){this.setContent("")}focus(){var e;null==(e=this.contentArea)||e.focus()}blur(){var e;null==(e=this.contentArea)||e.blur()}hasFocus(){var e;return(null==(e=this.contentArea)?void 0:e.hasFocus())||!1}execute(e,...t){var i;return null==(i=this.commands)?void 0:i.execute(e,...t)}on(e,t){var i;return null==(i=this.events)?void 0:i.on(e,t)}off(e,t){var i;null==(i=this.events)||i.off(e,t)}emit(e,...t){var i;null==(i=this.events)||i.emit(e,...t)}getTextContent(){var e;return(null==(e=this.contentArea)?void 0:e.getTextContent())||""}getWordCount(){var e;return(null==(e=this.contentArea)?void 0:e.getWordCount())||0}getCharacterCount(e=!1){var t;return(null==(t=this.contentArea)?void 0:t.getCharacterCount(e))||0}isEmpty(){var e;return(null==(e=this.contentArea)?void 0:e.isEmpty())||!0}setReadOnly(e){var t,i,n;this.options.readOnly=e,null==(t=this.contentArea)||t.setReadOnly(e),e?null==(i=this.container)||i.classList.add("readonly"):null==(n=this.container)||n.classList.remove("readonly")}isReadOnly(){return this.options.readOnly}toggleSourceView(e){this.isSourceMode=void 0!==e?e:!this.isSourceMode,this.events.emit(EventBus.Events.MODE_CHANGE,{mode:this.isSourceMode?"source":"wysiwyg"})}toggleFullscreen(e){var t,i;this.isFullscreen=void 0!==e?e:!this.isFullscreen,this.isFullscreen?(null==(t=this.container)||t.classList.add("fullscreen"),document.body.classList.add("rte-fullscreen-active")):(null==(i=this.container)||i.classList.remove("fullscreen"),document.body.classList.remove("rte-fullscreen-active")),this.events.emit(EventBus.Events.MODE_CHANGE,{fullscreen:this.isFullscreen})}showNotification(e,t="info",i=3e3){var n,s;const r=document.createElement("div");r.className=`rte-notification rte-notification-${t}`,r.textContent=(null==(n=window.translate)?void 0:n.call(window,e))||e,null==(s=this.container)||s.appendChild(r),requestAnimationFrame(()=>{r.classList.add("show")}),setTimeout(()=>{r.classList.remove("show"),setTimeout(()=>r.remove(),300)},i)}getContainer(){return this.container}getContentElement(){var e;return null==(e=this.contentArea)?void 0:e.getElement()}destroy(){var e,t,i,n,s,r,o,a,l,c;null==(e=this.events)||e.emit(EventBus.Events.EDITOR_DESTROY,this),this.plugins.forEach(e=>e.destroy()),this.plugins.clear(),null==(t=this.keyboard)||t.destroy(),null==(i=this.history)||i.destroy(),null==(n=this.commands)||n.destroy(),null==(s=this.selection)||s.destroy(),null==(r=this.toolbar)||r.destroy(),null==(o=this.contentArea)||o.destroy(),null==(a=this.events)||a.destroy(),"TEXTAREA"===(null==(l=this.targetElement)?void 0:l.tagName)&&(this.targetElement.style.display=""),(null==(c=this.container)?void 0:c.parentNode)&&this.container.parentNode.removeChild(this.container),this.container=null,this.targetElement=null,this.initialized=!1}static registerPlugin(e,t){RichTextEditor2.registeredPlugins.set(e,t)}static unregisterPlugin(e){RichTextEditor2.registeredPlugins.delete(e)}static getRegisteredPlugins(){return RichTextEditor2.registeredPlugins}static create(e,t={}){return new RichTextEditor2(e,t)}}RichTextEditor2.registeredPlugins=new Map,RichTextEditor2.Events=EventBus.Events,"undefined"!=typeof window&&(window.RichTextEditor=RichTextEditor2);class PluginBase{constructor(e,t={}){this.editor=e,this.options=t,this.initialized=!1,this.eventSubscriptions=[]}init(){this.initialized=!0}onReady(){}getName(){return this.constructor.pluginName}subscribe(e,t){var i;const n=t.bind(this);null==(i=this.editor.events)||i.on(e,n),this.eventSubscriptions.push({event:e,callback:n})}execute(e,...t){var i;return null==(i=this.editor.commands)?void 0:i.execute(e,...t)}registerCommand(e,t){var i;null==(i=this.editor.commands)||i.register(e,t)}registerShortcut(e,t){var i;null==(i=this.editor.keyboard)||i.register(e,t)}getSelection(){return this.editor.selection}getRange(){var e;return null==(e=this.editor.selection)?void 0:e.getRange()}saveSelection(){var e;null==(e=this.editor.selection)||e.saveSelection()}restoreSelection(){var e;null==(e=this.editor.selection)||e.restoreSelection()}insertHtml(e){var t;null==(t=this.editor.selection)||t.insertHtml(e)}getContent(){return this.editor.getContent()}setContent(e){this.editor.setContent(e)}emit(e,...t){var i;null==(i=this.editor.events)||i.emit(e,...t)}translate(e,t={}){return window.translate?window.translate(e,t):e}notify(e,t="info"){var i,n;null==(n=(i=this.editor).showNotification)||n.call(i,e,t)}getToolbarButton(e){var t,i;return null==(i=null==(t=this.editor.toolbar)?void 0:t.buttons.get(e))?void 0:i.element}setButtonActive(e,t){const i=this.getToolbarButton(e);i&&(i.classList.toggle("active",t),i.setAttribute("aria-pressed",t))}enableButton(e){const t=this.getToolbarButton(e);t&&(t.disabled=!1)}disableButton(e){const t=this.getToolbarButton(e);t&&(t.disabled=!0)}focusEditor(){this.editor.focus()}hasFocus(){var e;return(null==(e=this.editor.contentArea)?void 0:e.hasFocus())||!1}recordHistory(e=!1){var t;null==(t=this.editor.history)||t.record(e)}startBatch(){var e;null==(e=this.editor.history)||e.startBatch()}endBatch(){var e;null==(e=this.editor.history)||e.endBatch()}batch(e){var t;null==(t=this.editor.history)||t.batch(e)}destroy(){this.eventSubscriptions.forEach(({event:e,callback:t})=>{var i;null==(i=this.editor.events)||i.off(e,t)}),this.eventSubscriptions=[],this.initialized=!1}}__publicField(PluginBase,"pluginName","base"),__publicField(PluginBase,"requires",[]);class BaseDialog{constructor(e,t={}){this.editor=e,this.options={title:"Dialog",width:450,closable:!0,closeOnOverlay:!0,closeOnEscape:!0,...t},this.overlay=null,this.dialog=null,this.isOpen=!1,this.savedSelection=null,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleOverlayClick=this.handleOverlayClick.bind(this)}translate(e,t={}){return window.translate?window.translate(e,t):e}create(){var e,t;this.overlay=document.createElement("div"),this.overlay.className="rte-dialog-overlay",this.dialog=document.createElement("div"),this.dialog.className="rte-dialog",this.dialog.style.width=`${this.options.width}px`,this.dialog.setAttribute("role","dialog"),this.dialog.setAttribute("aria-modal","true"),this.dialog.setAttribute("aria-labelledby","rte-dialog-title");const i=document.createElement("div");i.className="rte-dialog-header";const n=document.createElement("h3");if(n.id="rte-dialog-title",n.className="rte-dialog-title",n.textContent=(null==(e=window.translate)?void 0:e.call(window,this.options.title))||this.options.title,i.appendChild(n),this.options.closable){const e=document.createElement("button");e.type="button",e.className="rte-dialog-close",e.innerHTML="&times;",e.setAttribute("aria-label",(null==(t=window.translate)?void 0:t.call(window,"Close"))||"Close"),e.addEventListener("click",()=>this.close()),i.appendChild(e)}return this.body=document.createElement("div"),this.body.className="rte-dialog-body",this.footer=document.createElement("div"),this.footer.className="rte-dialog-footer",this.dialog.appendChild(i),this.dialog.appendChild(this.body),this.dialog.appendChild(this.footer),this.overlay.appendChild(this.dialog),this.overlay}buildBody(){}buildFooter(){var e,t;const i=document.createElement("button");i.type="button",i.className="rte-dialog-btn rte-dialog-btn-cancel",i.textContent=(null==(e=window.translate)?void 0:e.call(window,"Cancel"))||"Cancel",i.addEventListener("click",()=>this.close());const n=document.createElement("button");n.type="button",n.className="rte-dialog-btn rte-dialog-btn-primary",n.textContent=(null==(t=window.translate)?void 0:t.call(window,"Confirm"))||"Confirm",n.addEventListener("click",()=>this.handleConfirm()),this.footer.appendChild(i),this.footer.appendChild(n),this.confirmBtn=n,this.cancelBtn=i}createField(e){var t,i,n,s;const r=document.createElement("div");if(r.className="rte-dialog-field",e.label){const i=document.createElement("label");i.className="rte-dialog-label",i.textContent=(null==(t=window.translate)?void 0:t.call(window,e.label))||e.label,e.id&&i.setAttribute("for",e.id),r.appendChild(i)}let o;switch(e.type){case"text":case"url":case"email":case"number":o=document.createElement("input"),o.type=e.type,o.className="rte-dialog-input";break;case"textarea":o=document.createElement("textarea"),o.className="rte-dialog-textarea",o.rows=e.rows||3;break;case"select":o=document.createElement("select"),o.className="rte-dialog-select",e.options&&e.options.forEach(e=>{var t;const i=document.createElement("option");i.value=e.value,i.textContent=(null==(t=window.translate)?void 0:t.call(window,e.label))||e.label,o.appendChild(i)});break;case"checkbox":const t=document.createElement("label");t.className="rte-dialog-checkbox",o=document.createElement("input"),o.type="checkbox",t.appendChild(o);const n=document.createElement("span");n.textContent=(null==(i=window.translate)?void 0:i.call(window,e.checkLabel))||e.checkLabel||"",t.appendChild(n),r.appendChild(t);break;default:o=document.createElement("input"),o.type="text",o.className="rte-dialog-input"}if(o&&"checkbox"!==e.type?(e.id&&(o.id=e.id),e.name&&(o.name=e.name),e.placeholder&&(o.placeholder=(null==(n=window.translate)?void 0:n.call(window,e.placeholder))||e.placeholder),void 0!==e.value&&(o.value=e.value),e.required&&(o.required=!0),e.pattern&&(o.pattern=e.pattern),r.appendChild(o)):"checkbox"===e.type&&o&&(e.id&&(o.id=e.id),e.name&&(o.name=e.name),e.checked&&(o.checked=!0)),e.help){const t=document.createElement("div");t.className="rte-dialog-help",t.textContent=(null==(s=window.translate)?void 0:s.call(window,e.help))||e.help,r.appendChild(t)}return r}getInputFromField(e){return e.querySelector("input, textarea, select")}open(e={}){var t,i;this.isOpen||(this.savedSelection=null==(t=this.editor.selection)?void 0:t.saveSelection(),this.overlay||(this.create(),this.buildBody(),this.buildFooter()),this.populate(e),document.body.appendChild(this.overlay),requestAnimationFrame(()=>{this.overlay.classList.add("open"),this.dialog.classList.add("open")}),this.options.closeOnOverlay&&this.overlay.addEventListener("click",this.handleOverlayClick),this.options.closeOnEscape&&document.addEventListener("keydown",this.handleKeyDown),this.isOpen=!0,this.focusFirst(),null==(i=this.editor.events)||i.emit(EventBus.Events.DIALOG_OPEN,{dialog:this}))}close(){var e;this.isOpen&&(this.overlay.classList.remove("open"),this.dialog.classList.remove("open"),setTimeout(()=>{this.overlay&&this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay)},200),this.overlay.removeEventListener("click",this.handleOverlayClick),document.removeEventListener("keydown",this.handleKeyDown),this.isOpen=!1,this.savedSelection&&(this.editor.selection.savedSelection=this.savedSelection,this.editor.selection.restoreSelection(),this.savedSelection=null),null==(e=this.editor.events)||e.emit(EventBus.Events.DIALOG_CLOSE,{dialog:this}))}populate(e){}getData(){return{}}validate(){return!0}handleConfirm(){if(!this.validate())return;const e=this.getData();this.onConfirm(e),this.close()}onConfirm(e){}handleOverlayClick(e){e.target===this.overlay&&this.close()}handleKeyDown(e){"Escape"===e.key?(e.preventDefault(),this.close()):"Enter"!==e.key||e.shiftKey||"TEXTAREA"!==e.target.tagName&&(e.preventDefault(),this.handleConfirm())}focusFirst(){const e=this.body.querySelector("input, textarea, select");e&&(e.focus(),e.select&&e.select())}showError(e,t=null){var i;this.clearError();const n=document.createElement("div");n.className="rte-dialog-error",n.textContent=(null==(i=window.translate)?void 0:i.call(window,e))||e,t?(t.classList.add("error"),t.appendChild(n)):this.body.insertBefore(n,this.body.firstChild)}clearError(){this.body.querySelectorAll(".rte-dialog-error").forEach(e=>e.remove());this.body.querySelectorAll(".error").forEach(e=>e.classList.remove("error"))}setLoading(e){this.confirmBtn&&(this.confirmBtn.disabled=e,this.confirmBtn.classList.toggle("loading",e))}destroy(){this.close(),this.overlay=null,this.dialog=null,this.body=null,this.footer=null}}class LinkDialog extends BaseDialog{constructor(e){super(e,{title:"Insert Link",width:400})}buildBody(){this.urlField=this.createField({type:"url",label:"URL",id:"rte-link-url",placeholder:"https://example.com",required:!0}),this.body.appendChild(this.urlField),this.textField=this.createField({type:"text",label:"Display text",id:"rte-link-text",placeholder:"Link text"}),this.body.appendChild(this.textField),this.titleField=this.createField({type:"text",label:"Title",id:"rte-link-title",placeholder:"Tooltip text (optional)"}),this.body.appendChild(this.titleField),this.newTabField=this.createField({type:"checkbox",id:"rte-link-newtab",checkLabel:"Open in new tab"}),this.body.appendChild(this.newTabField)}buildFooter(){this.removeBtn=document.createElement("button"),this.removeBtn.type="button",this.removeBtn.className="rte-dialog-btn rte-dialog-btn-danger",this.removeBtn.textContent=this.translate("Remove link"),this.removeBtn.style.marginRight="auto",this.removeBtn.style.display="none",this.removeBtn.addEventListener("click",()=>{this.onRemove(),this.close()}),this.footer.appendChild(this.removeBtn),super.buildFooter()}populate(e){const t=this.urlField.querySelector("input"),i=this.textField.querySelector("input"),n=this.titleField.querySelector("input"),s=this.newTabField.querySelector("input");t.value=e.url||"",i.value=e.text||"",n.value=e.title||"",s.checked=e.newTab||!1,this.removeBtn.style.display=e.isEdit?"block":"none",this.isEdit=e.isEdit||!1,this.existingLink=e.element||null}getData(){const e=this.urlField.querySelector("input"),t=this.textField.querySelector("input"),i=this.titleField.querySelector("input"),n=this.newTabField.querySelector("input");return{url:e.value.trim(),text:t.value.trim(),title:i.value.trim(),newTab:n.checked,isEdit:this.isEdit,existingLink:this.existingLink}}validate(){this.clearError();const e=this.getData();if(!e.url)return this.showError("Please enter a URL",this.urlField),!1;if(!e.url.match(/^(https?:\/\/|mailto:|tel:|#)/i)){this.urlField.querySelector("input").value="https://"+e.url}return!0}onRemove(){}}class LinkPlugin extends PluginBase{init(){super.init(),this.dialog=new LinkDialog(this.editor),this.dialog.onConfirm=e=>this.insertLink(e),this.dialog.onRemove=()=>this.removeLink(),this.registerCommand("insertLink",{execute:e=>this.insertLink(e),isActive:()=>this.isInLink()}),this.registerCommand("removeLink",{execute:()=>this.removeLink()}),this.registerShortcut("ctrl+k",()=>this.openDialog()),this.subscribe(EventBus.Events.TOOLBAR_BUTTON_CLICK,e=>{"link"===e.id&&this.openDialog()})}openDialog(){this.restoreSelection();const e=this.getSelection().getAncestor("a"),t={url:"",text:this.getSelection().getSelectedText(),title:"",newTab:!1,isEdit:!1,element:null};e&&(t.url=e.href,t.text=e.textContent,t.title=e.title||"",t.newTab="_blank"===e.target,t.isEdit=!0,t.element=e),this.dialog.open(t)}insertLink(e){if(this.restoreSelection(),e.isEdit&&e.existingLink)e.existingLink.href=e.url,e.existingLink.title=e.title||"",e.newTab?(e.existingLink.target="_blank",e.existingLink.rel="noopener noreferrer"):(e.existingLink.removeAttribute("target"),e.existingLink.removeAttribute("rel")),e.text&&(e.existingLink.textContent=e.text);else{const t=e.text||e.url;let i=`<a href="${this.escapeHtml(e.url)}"`;if(e.title&&(i+=` title="${this.escapeHtml(e.title)}"`),e.newTab&&(i+=' target="_blank" rel="noopener noreferrer"'),i+=`>${this.escapeHtml(t)}</a>`,this.getSelection().hasSelection()){this.execute("createLink",e.url);const t=this.getSelection().getAncestor("a");t&&(e.title&&(t.title=e.title),e.newTab&&(t.target="_blank",t.rel="noopener noreferrer"))}else this.insertHtml(i)}this.recordHistory(!0),this.focusEditor()}removeLink(){this.restoreSelection(),this.execute("unlink"),this.recordHistory(!0),this.focusEditor()}isInLink(){return this.getSelection().containsElement("a")}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}destroy(){var e;null==(e=this.dialog)||e.destroy(),super.destroy()}}__publicField(LinkPlugin,"pluginName","link");class ImageDialog extends BaseDialog{constructor(e,t={}){super(e,{title:"Insert Image",width:500}),this.pluginOptions=t}buildBody(){var e;const t=document.createElement("div");t.className="rte-dialog-tabs";const i=document.createElement("button");i.type="button",i.className="rte-dialog-tab active",i.textContent=this.translate("URL"),i.dataset.tab="url";const n=document.createElement("button");n.type="button",n.className="rte-dialog-tab",n.textContent=this.translate("Upload"),n.dataset.tab="upload",t.appendChild(i),t.appendChild(n),this.body.appendChild(t),this.urlContent=document.createElement("div"),this.urlContent.className="rte-dialog-tab-content active",this.urlContent.dataset.tab="url",this.uploadContent=document.createElement("div"),this.uploadContent.className="rte-dialog-tab-content",this.uploadContent.dataset.tab="upload",this.urlField=this.createField({type:"url",label:"Image URL",id:"rte-image-url",placeholder:"https://example.com/image.jpg"}),this.urlContent.appendChild(this.urlField);const s=document.createElement("div");if(s.className="rte-upload-zone",s.innerHTML=`\n      <div class="rte-upload-icon">📷</div>\n      <div class="rte-upload-text">${this.translate("Drop image here or click to browse")}</div>\n      <input type="file" accept="image/*" style="display: none;">\n    `,this.fileInput=s.querySelector('input[type="file"]'),s.addEventListener("click",()=>this.fileInput.click()),s.addEventListener("dragover",e=>{e.preventDefault(),s.classList.add("dragover")}),s.addEventListener("dragleave",()=>{s.classList.remove("dragover")}),s.addEventListener("drop",e=>{e.preventDefault(),s.classList.remove("dragover"),e.dataTransfer.files[0]&&this.handleFileSelect(e.dataTransfer.files[0])}),this.fileInput.addEventListener("change",e=>{e.target.files[0]&&this.handleFileSelect(e.target.files[0])}),this.uploadContent.appendChild(s),this.previewArea=document.createElement("div"),this.previewArea.className="rte-image-preview",this.previewArea.style.display="none",this.uploadContent.appendChild(this.previewArea),!1!==(null==(e=this.pluginOptions.fileBrowser)?void 0:e.enabled)){const e=document.createElement("button");e.type="button",e.className="rte-dialog-btn rte-dialog-btn-secondary",e.style.marginTop="12px",e.textContent=this.translate("Browse files"),e.addEventListener("click",()=>this.openFileBrowser()),this.uploadContent.appendChild(e)}this.body.appendChild(this.urlContent),this.body.appendChild(this.uploadContent);const r=document.createElement("div");r.className="rte-dialog-common-fields",r.style.marginTop="16px",r.style.paddingTop="16px",r.style.borderTop="1px solid var(--rte-border-color)",this.altField=this.createField({type:"text",label:"Alt text",id:"rte-image-alt",placeholder:"Description for accessibility"}),r.appendChild(this.altField);const o=document.createElement("div");o.style.display="flex",o.style.gap="12px",this.widthField=this.createField({type:"number",label:"Width",id:"rte-image-width",placeholder:"Auto"}),this.widthField.style.flex="1",this.heightField=this.createField({type:"number",label:"Height",id:"rte-image-height",placeholder:"Auto"}),this.heightField.style.flex="1",o.appendChild(this.widthField),o.appendChild(this.heightField),r.appendChild(o),this.alignField=this.createField({type:"select",label:"Alignment",id:"rte-image-align",options:[{value:"",label:"None"},{value:"left",label:"Left"},{value:"center",label:"Center"},{value:"right",label:"Right"}]}),r.appendChild(this.alignField),this.body.appendChild(r),t.addEventListener("click",e=>{if(e.target.classList.contains("rte-dialog-tab")){t.querySelectorAll(".rte-dialog-tab").forEach(e=>e.classList.remove("active")),e.target.classList.add("active");const i=e.target.dataset.tab;this.body.querySelectorAll(".rte-dialog-tab-content").forEach(e=>{e.classList.toggle("active",e.dataset.tab===i)})}}),this.addTabStyles()}addTabStyles(){if(document.getElementById("rte-image-dialog-styles"))return;const e=document.createElement("style");e.id="rte-image-dialog-styles",e.textContent="\n      .rte-dialog-tabs {\n        display: flex;\n        gap: 4px;\n        margin-bottom: 16px;\n        border-bottom: 1px solid var(--rte-border-color);\n      }\n      .rte-dialog-tab {\n        padding: 8px 16px;\n        border: none;\n        background: none;\n        color: var(--rte-text-secondary);\n        cursor: pointer;\n        border-bottom: 2px solid transparent;\n        transition: all 0.2s;\n      }\n      .rte-dialog-tab.active {\n        color: var(--rte-primary-color);\n        border-bottom-color: var(--rte-primary-color);\n      }\n      .rte-dialog-tab-content {\n        display: none;\n      }\n      .rte-dialog-tab-content.active {\n        display: block;\n      }\n      .rte-upload-zone {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        padding: 32px;\n        border: 2px dashed var(--rte-border-color);\n        border-radius: 8px;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n      .rte-upload-zone:hover,\n      .rte-upload-zone.dragover {\n        border-color: var(--rte-primary-color);\n        background: var(--rte-primary-light);\n      }\n      .rte-upload-icon {\n        font-size: 48px;\n        margin-bottom: 8px;\n      }\n      .rte-upload-text {\n        color: var(--rte-text-secondary);\n      }\n      .rte-image-preview {\n        margin-top: 12px;\n        text-align: center;\n      }\n      .rte-image-preview img {\n        max-width: 100%;\n        max-height: 200px;\n        border-radius: 4px;\n      }\n      .rte-dialog-btn-secondary {\n        background: var(--rte-bg-secondary);\n        border: 1px solid var(--rte-border-color);\n        color: var(--rte-text-color);\n      }\n    ",document.head.appendChild(e)}handleFileSelect(e){if(!e.type.startsWith("image/"))return void this.showError("Please select an image file");this.selectedFile=e;const t=new FileReader;t.onload=e=>{this.previewArea.innerHTML=`<img src="${e.target.result}" alt="Preview">`,this.previewArea.style.display="block",this.previewDataUrl=e.target.result},t.readAsDataURL(e)}openFileBrowser(){var e;if("undefined"!=typeof FileBrowser){new FileBrowser({...null==(e=this.pluginOptions.fileBrowser)?void 0:e.options,allowedFileTypes:"image/*",multiSelect:!1,onSelect:e=>{this.urlField.querySelector("input").value=e.url,this.body.querySelectorAll(".rte-dialog-tab").forEach(e=>{e.classList.toggle("active","url"===e.dataset.tab)}),this.body.querySelectorAll(".rte-dialog-tab-content").forEach(e=>{e.classList.toggle("active","url"===e.dataset.tab)})}}).open()}}populate(e){const t=this.urlField.querySelector("input"),i=this.altField.querySelector("input"),n=this.widthField.querySelector("input"),s=this.heightField.querySelector("input"),r=this.alignField.querySelector("select");t.value=e.src||"",i.value=e.alt||"",n.value=e.width||"",s.value=e.height||"",r.value=e.align||"",this.selectedFile=null,this.previewDataUrl=null,this.previewArea.style.display="none",this.isEdit=e.isEdit||!1,this.existingImage=e.element||null}getData(){const e=this.urlField.querySelector("input"),t=this.altField.querySelector("input"),i=this.widthField.querySelector("input"),n=this.heightField.querySelector("input"),s=this.alignField.querySelector("select");return{src:e.value.trim()||this.previewDataUrl,alt:t.value.trim(),width:i.value.trim(),height:n.value.trim(),align:s.value,file:this.selectedFile,isEdit:this.isEdit,existingImage:this.existingImage}}validate(){this.clearError();const e=this.getData();return!(!e.src&&!e.file)||(this.showError("Please provide an image URL or upload a file"),!1)}}class ImagePlugin extends PluginBase{init(){super.init(),this.dialog=new ImageDialog(this.editor,this.options),this.dialog.onConfirm=e=>this.insertImage(e),this.registerCommand("insertImage",{execute:e=>this.insertImage(e)}),this.subscribe(EventBus.Events.TOOLBAR_BUTTON_CLICK,e=>{"image"===e.id&&this.openDialog()}),this.subscribe("content:drop",e=>{const t=e.files.filter(e=>e.type.startsWith("image/"));t.length>0&&(e.event.preventDefault(),this.handleDroppedFiles(t))})}openDialog(){this.restoreSelection();const e=this.getSelectedImage(),t={src:"",alt:"",width:"",height:"",align:"",isEdit:!1,element:null};e&&(t.src=e.src,t.alt=e.alt,t.width=e.width||"",t.height=e.height||"",t.align=this.getImageAlignment(e),t.isEdit=!0,t.element=e),this.dialog.open(t)}getSelectedImage(){const e=this.getSelection().getRange();if(e&&e.collapsed){const t=e.startContainer;if(t.nodeType===Node.ELEMENT_NODE&&"IMG"===t.tagName)return t;if(t.parentElement&&"IMG"===t.parentElement.tagName)return t.parentElement}return null}getImageAlignment(e){const t=e.style;return"left"===t.float?"left":"right"===t.float?"right":"block"===t.display&&"auto"===t.marginLeft&&"auto"===t.marginRight?"center":""}async insertImage(e){let t=e.src;if(e.file&&this.options.uploadUrl)try{t=await this.uploadImage(e.file)}catch(i){return void this.notify("Failed to upload image","error")}if(this.restoreSelection(),e.isEdit&&e.existingImage){const i=e.existingImage;i.src=t,i.alt=e.alt,e.width?i.width=parseInt(e.width):i.removeAttribute("width"),e.height?i.height=parseInt(e.height):i.removeAttribute("height"),this.applyImageAlignment(i,e.align)}else{const i=document.createElement("img");i.src=t,i.alt=e.alt,e.width&&(i.width=parseInt(e.width)),e.height&&(i.height=parseInt(e.height)),this.applyImageAlignment(i,e.align),this.insertHtml(i.outerHTML)}this.recordHistory(!0),this.focusEditor()}applyImageAlignment(e,t){switch(e.style.float="",e.style.display="",e.style.marginLeft="",e.style.marginRight="",t){case"left":e.style.float="left",e.style.marginRight="1em";break;case"right":e.style.float="right",e.style.marginLeft="1em";break;case"center":e.style.display="block",e.style.marginLeft="auto",e.style.marginRight="auto"}}async uploadImage(e){var t;const i=new FormData;i.append("file",e),this.options.uploadPath&&i.append("path",this.options.uploadPath);const n=await fetch(this.options.uploadUrl,{method:"POST",body:i,credentials:"include"});if(!n.ok)throw new Error("Upload failed");const s=await n.json();return s.url||(null==(t=s.data)?void 0:t.url)}handleDroppedFiles(e){e.forEach(async e=>{if(this.options.uploadUrl)try{const t=await this.uploadImage(e);this.insertImage({src:t,alt:e.name})}catch(t){this.notify("Failed to upload image","error")}else{const t=new FileReader;t.onload=t=>{this.insertImage({src:t.target.result,alt:e.name})},t.readAsDataURL(e)}})}destroy(){var e;null==(e=this.dialog)||e.destroy(),super.destroy()}}__publicField(ImagePlugin,"pluginName","image");class TableDialog extends BaseDialog{constructor(e){super(e,{title:"Insert Table",width:350})}buildBody(){this.rowsField=this.createField({type:"number",label:"Rows",id:"rte-table-rows",value:3,placeholder:"3"});const e=this.rowsField.querySelector("input");e.min=1,e.max=50,this.body.appendChild(this.rowsField),this.colsField=this.createField({type:"number",label:"Columns",id:"rte-table-cols",value:3,placeholder:"3"});const t=this.colsField.querySelector("input");t.min=1,t.max=20,this.body.appendChild(this.colsField),this.headerField=this.createField({type:"checkbox",id:"rte-table-header",checkLabel:"First row as header",checked:!0}),this.body.appendChild(this.headerField),this.borderField=this.createField({type:"checkbox",id:"rte-table-border",checkLabel:"Show border",checked:!0}),this.body.appendChild(this.borderField),this.widthField=this.createField({type:"text",label:"Width",id:"rte-table-width",placeholder:"100% or 500px"}),this.body.appendChild(this.widthField)}populate(e){const t=this.rowsField.querySelector("input"),i=this.colsField.querySelector("input"),n=this.headerField.querySelector("input"),s=this.borderField.querySelector("input"),r=this.widthField.querySelector("input");t.value=e.rows||3,i.value=e.cols||3,n.checked=!1!==e.hasHeader,s.checked=!1!==e.hasBorder,r.value=e.width||"100%"}getData(){const e=this.rowsField.querySelector("input"),t=this.colsField.querySelector("input"),i=this.headerField.querySelector("input"),n=this.borderField.querySelector("input"),s=this.widthField.querySelector("input");return{rows:parseInt(e.value)||3,cols:parseInt(t.value)||3,hasHeader:i.checked,hasBorder:n.checked,width:s.value.trim()||"100%"}}validate(){this.clearError();const e=this.getData();return e.rows<1||e.rows>50?(this.showError("Rows must be between 1 and 50",this.rowsField),!1):!(e.cols<1||e.cols>20)||(this.showError("Columns must be between 1 and 20",this.colsField),!1)}}class TablePlugin extends PluginBase{init(){super.init(),this.dialog=new TableDialog(this.editor),this.dialog.onConfirm=e=>this.insertTable(e),this.setupContextMenu(),this.subscribe(EventBus.Events.TOOLBAR_BUTTON_CLICK,e=>{"table"===e.id&&this.openDialog()}),this.registerCommand("insertTable",{execute:e=>this.insertTable(e)}),this.registerCommand("addRowBefore",{execute:()=>this.addRow("before")}),this.registerCommand("addRowAfter",{execute:()=>this.addRow("after")}),this.registerCommand("addColBefore",{execute:()=>this.addColumn("before")}),this.registerCommand("addColAfter",{execute:()=>this.addColumn("after")}),this.registerCommand("deleteRow",{execute:()=>this.deleteRow()}),this.registerCommand("deleteCol",{execute:()=>this.deleteColumn()}),this.registerCommand("deleteTable",{execute:()=>this.deleteTable()})}setupContextMenu(){var e;const t=null==(e=this.editor.contentArea)?void 0:e.getElement();t&&t.addEventListener("contextmenu",e=>{const t=e.target.closest("td, th");t&&(e.preventDefault(),this.showTableContextMenu(e,t))})}showTableContextMenu(e,t){this.hideContextMenu();const i=document.createElement("div");i.className="rte-table-context-menu",i.style.cssText=`\n      position: fixed;\n      left: ${e.clientX}px;\n      top: ${e.clientY}px;\n      background: var(--rte-bg-color, #fff);\n      border: 1px solid var(--rte-border-color, #ddd);\n      border-radius: 6px;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n      padding: 4px 0;\n      z-index: 10001;\n      min-width: 180px;\n    `;[{label:"Insert row above",action:()=>this.addRow("before")},{label:"Insert row below",action:()=>this.addRow("after")},{type:"separator"},{label:"Insert column left",action:()=>this.addColumn("before")},{label:"Insert column right",action:()=>this.addColumn("after")},{type:"separator"},{label:"Delete row",action:()=>this.deleteRow()},{label:"Delete column",action:()=>this.deleteColumn()},{type:"separator"},{label:"Delete table",action:()=>this.deleteTable(),danger:!0}].forEach(e=>{if("separator"===e.type){const e=document.createElement("div");e.style.cssText="height: 1px; background: var(--rte-border-color, #ddd); margin: 4px 0;",i.appendChild(e)}else{const t=document.createElement("button");t.type="button",t.textContent=this.translate(e.label),t.style.cssText=`\n          display: block;\n          width: 100%;\n          padding: 8px 16px;\n          border: none;\n          background: transparent;\n          text-align: left;\n          cursor: pointer;\n          color: ${e.danger?"#f44336":"inherit"};\n        `,t.addEventListener("mouseover",()=>{t.style.background="var(--rte-bg-hover, #f0f0f0)"}),t.addEventListener("mouseout",()=>{t.style.background="transparent"}),t.addEventListener("click",()=>{this.hideContextMenu(),e.action()}),i.appendChild(t)}}),document.body.appendChild(i),this.contextMenu=i,this.currentCell=t;const closeHandler=e=>{i.contains(e.target)||(this.hideContextMenu(),document.removeEventListener("click",closeHandler))};setTimeout(()=>{document.addEventListener("click",closeHandler)},0)}hideContextMenu(){this.contextMenu&&(this.contextMenu.remove(),this.contextMenu=null)}openDialog(){this.saveSelection(),this.dialog.open({})}insertTable(e){this.restoreSelection();const{rows:t,cols:i,hasHeader:n,hasBorder:s,width:r}=e;let o=`<table style="width: ${r}; border-collapse: collapse;">`;for(let a=0;a<t;a++){o+="<tr>";for(let e=0;e<i;e++){const e=n&&0===a,t=e?"th":"td";o+=`<${t} style="${s?"border: 1px solid #ddd;":""} ${e?"background: #f5f5f5;":""} padding: 8px;">&nbsp;</${t}>`}o+="</tr>"}o+="</table><p></p>",this.insertHtml(o),this.recordHistory(!0),this.focusEditor()}getTableContext(){var e;const t=this.currentCell||(null==(e=this.getSelection())?void 0:e.getAncestor("td, th"));if(!t)return null;const i=t.parentElement,n=t.closest("table");if(!n||!i)return null;const s=Array.from(i.cells).indexOf(t);return{table:n,row:i,cell:t,rowIndex:Array.from(n.rows).indexOf(i),colIndex:s}}addRow(e){var t;const i=this.getTableContext();if(!i)return;const n=i.row.cells.length,s=i.table.insertRow("before"===e?i.rowIndex:i.rowIndex+1);for(let r=0;r<n;r++){const e=s.insertCell();e.innerHTML="&nbsp;",e.style.cssText=(null==(t=i.row.cells[0])?void 0:t.style.cssText)||"border: 1px solid #ddd; padding: 8px;"}this.recordHistory(!0)}addColumn(e){const t=this.getTableContext();if(!t)return;const i="before"===e?t.colIndex:t.colIndex+1;Array.from(t.table.rows).forEach((e,t)=>{var n,s,r;const o=0===t&&"TH"===(null==(n=e.cells[0])?void 0:n.tagName),a=e.insertCell(i);if(o){const t=document.createElement("th");t.innerHTML="&nbsp;",t.style.cssText=(null==(s=e.cells[0])?void 0:s.style.cssText)||"border: 1px solid #ddd; padding: 8px; background: #f5f5f5;",e.replaceChild(t,a)}else a.innerHTML="&nbsp;",a.style.cssText=(null==(r=e.cells[0])?void 0:r.style.cssText)||"border: 1px solid #ddd; padding: 8px;"}),this.recordHistory(!0)}deleteRow(){const e=this.getTableContext();e&&(e.table.rows.length<=1?this.deleteTable():(e.table.deleteRow(e.rowIndex),this.recordHistory(!0)))}deleteColumn(){const e=this.getTableContext();e&&(e.row.cells.length<=1?this.deleteTable():(Array.from(e.table.rows).forEach(t=>{t.cells[e.colIndex]&&t.deleteCell(e.colIndex)}),this.recordHistory(!0)))}deleteTable(){const e=this.getTableContext();e&&(e.table.remove(),this.recordHistory(!0))}destroy(){var e;this.hideContextMenu(),null==(e=this.dialog)||e.destroy(),super.destroy()}}__publicField(TablePlugin,"pluginName","table");class VideoDialog extends BaseDialog{constructor(e){super(e,{title:"Insert Video",width:500})}buildBody(){this.urlField=this.createField({type:"url",label:"Video URL",id:"rte-video-url",placeholder:"https://www.youtube.com/watch?v=...",help:"Supports YouTube, Vimeo, or direct video URLs"}),this.body.appendChild(this.urlField),this.previewArea=document.createElement("div"),this.previewArea.className="rte-video-preview",this.previewArea.style.cssText="\n      margin-top: 16px;\n      padding: 16px;\n      background: var(--rte-bg-secondary);\n      border-radius: 6px;\n      display: none;\n    ",this.body.appendChild(this.previewArea);const e=document.createElement("div");e.style.display="flex",e.style.gap="12px",e.style.marginTop="16px",this.widthField=this.createField({type:"text",label:"Width",id:"rte-video-width",value:"100%",placeholder:"100% or 560px"}),this.widthField.style.flex="1",this.heightField=this.createField({type:"text",label:"Height",id:"rte-video-height",value:"315",placeholder:"315"}),this.heightField.style.flex="1",e.appendChild(this.widthField),e.appendChild(this.heightField),this.body.appendChild(e),this.responsiveField=this.createField({type:"checkbox",id:"rte-video-responsive",checkLabel:"Make video responsive (16:9)",checked:!0}),this.body.appendChild(this.responsiveField);this.urlField.querySelector("input").addEventListener("input",()=>{this.updatePreview()})}updatePreview(){const e=this.urlField.querySelector("input").value.trim();if(!e)return void(this.previewArea.style.display="none");const t=this.getEmbedUrl(e);t?(this.previewArea.style.display="block",this.previewArea.innerHTML=`\n        <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">\n          <iframe src="${t}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;" allowfullscreen></iframe>\n        </div>\n      `):(this.previewArea.style.display="block",this.previewArea.innerHTML='<p style="color: var(--rte-text-muted); text-align: center;">Cannot preview this URL</p>')}getEmbedUrl(e){let t=e.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/ ]{11})/);return t?`https://www.youtube.com/embed/${t[1]}`:(t=e.match(/(?:vimeo\.com\/)(\d+)/),t?`https://player.vimeo.com/video/${t[1]}`:(e.match(/\.(mp4|webm|ogg)$/i),null))}populate(e){const t=this.urlField.querySelector("input"),i=this.widthField.querySelector("input"),n=this.heightField.querySelector("input"),s=this.responsiveField.querySelector("input");t.value=e.url||"",i.value=e.width||"100%",n.value=e.height||"315",s.checked=!1!==e.responsive,e.url&&this.updatePreview()}getData(){const e=this.urlField.querySelector("input"),t=this.widthField.querySelector("input"),i=this.heightField.querySelector("input"),n=this.responsiveField.querySelector("input");return{url:e.value.trim(),width:t.value.trim()||"100%",height:i.value.trim()||"315",responsive:n.checked}}validate(){this.clearError();return!!this.getData().url||(this.showError("Please enter a video URL",this.urlField),!1)}}class VideoPlugin extends PluginBase{init(){super.init(),this.dialog=new VideoDialog(this.editor),this.dialog.onConfirm=e=>this.insertVideo(e),this.subscribe(EventBus.Events.TOOLBAR_BUTTON_CLICK,e=>{"video"===e.id&&this.openDialog()}),this.registerCommand("insertVideo",{execute:e=>this.insertVideo(e)})}openDialog(){this.saveSelection(),this.dialog.open({})}insertVideo(e){this.restoreSelection();const t=this.getEmbedUrl(e.url);let i;i=t?e.responsive?`\n          <div class="rte-video-wrapper" style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; margin: 1em 0;">\n            <iframe src="${t}" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;" allowfullscreen></iframe>\n          </div>\n        `:`\n          <div class="rte-video-wrapper" style="margin: 1em 0;">\n            <iframe src="${t}" width="${e.width}" height="${e.height}" style="border: 0;" allowfullscreen></iframe>\n          </div>\n        `:e.url.match(/\.(mp4|webm|ogg)$/i)?e.responsive?`\n          <div class="rte-video-wrapper" style="margin: 1em 0;">\n            <video src="${e.url}" style="width: 100%; height: auto;" controls></video>\n          </div>\n        `:`\n          <div class="rte-video-wrapper" style="margin: 1em 0;">\n            <video src="${e.url}" width="${e.width}" height="${e.height}" controls></video>\n          </div>\n        `:`<a href="${e.url}" target="_blank">${e.url}</a>`,this.insertHtml(i),this.recordHistory(!0),this.focusEditor()}getEmbedUrl(e){let t=e.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/ ]{11})/);return t?`https://www.youtube.com/embed/${t[1]}`:(t=e.match(/(?:vimeo\.com\/)(\d+)/),t?`https://player.vimeo.com/video/${t[1]}`:null)}destroy(){var e;null==(e=this.dialog)||e.destroy(),super.destroy()}}__publicField(VideoPlugin,"pluginName","video");const t=class _EmojiPlugin extends PluginBase{init(){super.init(),this.picker=null,this.isOpen=!1,this.subscribe(EventBus.Events.TOOLBAR_BUTTON_CLICK,e=>{"emoji"===e.id&&this.toggle()}),document.addEventListener("click",this.handleDocumentClick.bind(this))}toggle(){this.isOpen?this.close():this.open()}open(){this.saveSelection(),this.picker||this.createPicker();const e=this.getToolbarButton("emoji");if(e){const t=e.getBoundingClientRect();this.picker.style.top=`${t.bottom+4}px`,this.picker.style.left=`${t.left}px`}this.picker.style.display="block",this.isOpen=!0}close(){this.picker&&(this.picker.style.display="none"),this.isOpen=!1}handleDocumentClick(e){if(this.isOpen&&this.picker&&!this.picker.contains(e.target)){const t=this.getToolbarButton("emoji");t&&t.contains(e.target)||this.close()}}createPicker(){this.picker=document.createElement("div"),this.picker.className="rte-emoji-picker",this.picker.style.cssText="\n      position: fixed;\n      z-index: 10001;\n      background: var(--rte-bg-color, #fff);\n      border: 1px solid var(--rte-border-color, #ddd);\n      border-radius: 8px;\n      box-shadow: 0 4px 16px rgba(0,0,0,0.15);\n      padding: 12px;\n      width: 253px;\n      max-height: 350px;\n      display: none;\n    ";const e=document.createElement("input");e.type="text",e.placeholder=this.translate("Search emoji..."),e.className="rte-emoji-search",e.style.cssText="\n      width: 100%;\n      padding: 8px 12px;\n      border: 1px solid var(--rte-border-color, #ddd);\n      border-radius: 6px;\n      margin-bottom: 12px;\n      font-size: 14px;\n    ",e.addEventListener("input",e=>this.filterEmojis(e.target.value)),this.picker.appendChild(e);const t=document.createElement("div");t.className="rte-emoji-tabs",t.style.cssText="\n      display: flex;\n      gap: 4px;\n      margin-bottom: 8px;\n      border-bottom: 1px solid var(--rte-border-color, #ddd);\n      padding-bottom: 8px;\n    ",_EmojiPlugin.categories.forEach((e,i)=>{const n=document.createElement("button");n.type="button",n.className="rte-emoji-tab",n.textContent=e.icon,n.title=this.translate(e.name),n.style.cssText="\n        width: 32px;\n        height: 32px;\n        border: none;\n        background: transparent;\n        font-size: 18px;\n        cursor: pointer;\n        border-radius: 4px;\n        transition: background 0.2s;\n      ",n.addEventListener("mouseover",()=>n.style.background="var(--rte-bg-hover, #f0f0f0)"),n.addEventListener("mouseout",()=>n.style.background="transparent"),n.addEventListener("click",()=>this.showCategory(i)),t.appendChild(n)}),this.picker.appendChild(t),this.emojiGrid=document.createElement("div"),this.emojiGrid.className="rte-emoji-grid",this.emojiGrid.style.cssText="\n      display: flex;\n      flex-wrap: wrap;\n      gap: 4px;\n      max-height: 220px;\n      overflow-y: auto;\n    ",this.picker.appendChild(this.emojiGrid),this.showCategory(0),document.body.appendChild(this.picker)}showCategory(e){const t=_EmojiPlugin.categories[e];t&&(this.currentEmojis=t.emojis,this.renderEmojis(t.emojis))}filterEmojis(e){if(!e)return void this.renderEmojis(this.currentEmojis||_EmojiPlugin.categories[0].emojis);const t=e.toLowerCase(),i=[];_EmojiPlugin.categories.forEach(e=>{e.emojis.forEach(e=>{e.name&&e.name.toLowerCase().includes(t)&&i.push(e)})}),this.renderEmojis(i)}renderEmojis(e){this.emojiGrid.innerHTML="",e.forEach(e=>{const t=document.createElement("button");t.type="button",t.className="rte-emoji-btn",t.textContent=e.char,t.title=e.name||"",t.style.cssText="\n        width: 32px;\n        height: 32px;\n        border: none;\n        background: transparent;\n        font-size: 20px;\n        cursor: pointer;\n        border-radius: 4px;\n        transition: all 0.15s;\n      ",t.addEventListener("mouseover",()=>{t.style.background="var(--rte-bg-hover, #f0f0f0)",t.style.transform="scale(1.2)"}),t.addEventListener("mouseout",()=>{t.style.background="transparent",t.style.transform="scale(1)"}),t.addEventListener("click",()=>this.insertEmoji(e.char)),this.emojiGrid.appendChild(t)})}insertEmoji(e){this.restoreSelection(),this.insertHtml(e),this.recordHistory(!0),this.close(),this.focusEditor()}destroy(){this.picker&&this.picker.parentNode&&this.picker.parentNode.removeChild(this.picker),document.removeEventListener("click",this.handleDocumentClick),super.destroy()}};__publicField(t,"pluginName","emoji");let i=t;i.categories=[{name:"Smileys",icon:"😀",emojis:[{char:"😀",name:"grinning"},{char:"😃",name:"smiley"},{char:"😄",name:"smile"},{char:"😁",name:"grin"},{char:"😆",name:"laughing"},{char:"😅",name:"sweat smile"},{char:"🤣",name:"rofl"},{char:"😂",name:"joy"},{char:"🙂",name:"slightly smiling"},{char:"😉",name:"wink"},{char:"😊",name:"blush"},{char:"😇",name:"innocent"},{char:"🥰",name:"smiling hearts"},{char:"😍",name:"heart eyes"},{char:"🤩",name:"star struck"},{char:"😘",name:"kissing heart"},{char:"😗",name:"kissing"},{char:"😚",name:"kissing closed eyes"},{char:"😙",name:"kissing smiling"},{char:"🥲",name:"smiling tear"},{char:"😋",name:"yum"},{char:"😛",name:"stuck out tongue"},{char:"😜",name:"winking tongue"},{char:"🤪",name:"zany"},{char:"😝",name:"squinting tongue"},{char:"🤑",name:"money mouth"},{char:"🤗",name:"hugging"},{char:"🤭",name:"hand over mouth"},{char:"🤫",name:"shushing"},{char:"🤔",name:"thinking"},{char:"🤐",name:"zipper mouth"},{char:"🤨",name:"raised eyebrow"},{char:"😐",name:"neutral"},{char:"😑",name:"expressionless"},{char:"😶",name:"no mouth"},{char:"😏",name:"smirk"},{char:"😒",name:"unamused"},{char:"🙄",name:"rolling eyes"},{char:"😬",name:"grimacing"},{char:"😮‍💨",name:"exhaling"},{char:"🤥",name:"lying"},{char:"😌",name:"relieved"},{char:"😔",name:"pensive"},{char:"😪",name:"sleepy"},{char:"🤤",name:"drooling"},{char:"😴",name:"sleeping"},{char:"😷",name:"mask"},{char:"🤒",name:"thermometer"},{char:"🤕",name:"bandage"},{char:"🤢",name:"nauseated"},{char:"🤮",name:"vomiting"},{char:"😵",name:"dizzy"},{char:"🤯",name:"exploding head"},{char:"🥳",name:"partying"},{char:"🥸",name:"disguised"},{char:"😎",name:"sunglasses"},{char:"🤓",name:"nerd"},{char:"😕",name:"confused"},{char:"😟",name:"worried"},{char:"🙁",name:"frowning"},{char:"😮",name:"open mouth"},{char:"😯",name:"hushed"},{char:"😲",name:"astonished"},{char:"😳",name:"flushed"},{char:"🥺",name:"pleading"},{char:"😦",name:"frowning open"},{char:"😧",name:"anguished"},{char:"😨",name:"fearful"},{char:"😰",name:"cold sweat"},{char:"😥",name:"sad relieved"},{char:"😢",name:"crying"},{char:"😭",name:"loudly crying"},{char:"😱",name:"screaming"},{char:"😖",name:"confounded"},{char:"😣",name:"persevering"},{char:"😞",name:"disappointed"},{char:"😓",name:"sweat"},{char:"😩",name:"weary"},{char:"😫",name:"tired"},{char:"🥱",name:"yawning"},{char:"😤",name:"triumph"},{char:"😡",name:"pouting"},{char:"😠",name:"angry"},{char:"🤬",name:"cursing"},{char:"😈",name:"smiling devil"},{char:"👿",name:"angry devil"},{char:"💀",name:"skull"},{char:"☠️",name:"skull crossbones"},{char:"💩",name:"poop"},{char:"🤡",name:"clown"},{char:"👹",name:"ogre"},{char:"👺",name:"goblin"},{char:"👻",name:"ghost"},{char:"👽",name:"alien"},{char:"👾",name:"alien monster"},{char:"🤖",name:"robot"}]},{name:"Gestures",icon:"👍",emojis:[{char:"👍",name:"thumbs up"},{char:"👎",name:"thumbs down"},{char:"👌",name:"ok"},{char:"✌️",name:"victory"},{char:"🤞",name:"crossed fingers"},{char:"🤟",name:"love you"},{char:"🤘",name:"rock on"},{char:"🤙",name:"call me"},{char:"👋",name:"waving"},{char:"🤚",name:"raised back"},{char:"🖐️",name:"raised hand"},{char:"✋",name:"raised palm"},{char:"🖖",name:"vulcan"},{char:"👏",name:"clapping"},{char:"🙌",name:"raised hands"},{char:"🤲",name:"palms up"},{char:"🤝",name:"handshake"},{char:"🙏",name:"pray"},{char:"✍️",name:"writing"},{char:"💪",name:"strong"},{char:"🦾",name:"mechanical arm"},{char:"🖕",name:"middle finger"},{char:"☝️",name:"point up"},{char:"👆",name:"pointing up"},{char:"👇",name:"pointing down"},{char:"👈",name:"pointing left"},{char:"👉",name:"pointing right"},{char:"✊",name:"raised fist"},{char:"👊",name:"punch"},{char:"🤛",name:"left fist"},{char:"🤜",name:"right fist"}]},{name:"Hearts",icon:"❤️",emojis:[{char:"❤️",name:"red heart"},{char:"🧡",name:"orange heart"},{char:"💛",name:"yellow heart"},{char:"💚",name:"green heart"},{char:"💙",name:"blue heart"},{char:"💜",name:"purple heart"},{char:"🖤",name:"black heart"},{char:"🤍",name:"white heart"},{char:"🤎",name:"brown heart"},{char:"💔",name:"broken heart"},{char:"❤️‍🔥",name:"heart fire"},{char:"❤️‍🩹",name:"mending heart"},{char:"💕",name:"two hearts"},{char:"💞",name:"revolving hearts"},{char:"💓",name:"beating heart"},{char:"💗",name:"growing heart"},{char:"💖",name:"sparkling heart"},{char:"💘",name:"heart arrow"},{char:"💝",name:"heart ribbon"},{char:"💟",name:"heart decoration"},{char:"💌",name:"love letter"}]},{name:"Objects",icon:"📦",emojis:[{char:"⌚",name:"watch"},{char:"📱",name:"phone"},{char:"💻",name:"laptop"},{char:"⌨️",name:"keyboard"},{char:"🖥️",name:"computer"},{char:"🖨️",name:"printer"},{char:"🖱️",name:"mouse"},{char:"💾",name:"floppy disk"},{char:"💿",name:"cd"},{char:"📷",name:"camera"},{char:"📹",name:"video camera"},{char:"🎥",name:"movie camera"},{char:"📺",name:"tv"},{char:"📻",name:"radio"},{char:"🎙️",name:"microphone"},{char:"🔋",name:"battery"},{char:"🔌",name:"plug"},{char:"💡",name:"light bulb"},{char:"🔦",name:"flashlight"},{char:"📚",name:"books"},{char:"📖",name:"book"},{char:"📝",name:"memo"},{char:"✏️",name:"pencil"},{char:"📎",name:"paperclip"},{char:"📌",name:"pushpin"},{char:"✂️",name:"scissors"},{char:"📁",name:"folder"},{char:"🗂️",name:"folders"},{char:"📅",name:"calendar"},{char:"📆",name:"tear calendar"}]},{name:"Symbols",icon:"✅",emojis:[{char:"✅",name:"check mark"},{char:"❌",name:"cross"},{char:"❓",name:"question"},{char:"❗",name:"exclamation"},{char:"💯",name:"100"},{char:"🔥",name:"fire"},{char:"⭐",name:"star"},{char:"🌟",name:"glowing star"},{char:"✨",name:"sparkles"},{char:"💫",name:"dizzy"},{char:"🎯",name:"target"},{char:"🏆",name:"trophy"},{char:"🎉",name:"party"},{char:"🎊",name:"confetti"},{char:"🎁",name:"gift"},{char:"🔔",name:"bell"},{char:"🔕",name:"no bell"},{char:"🔒",name:"lock"},{char:"🔓",name:"unlock"},{char:"🔑",name:"key"},{char:"⚙️",name:"gear"},{char:"🔧",name:"wrench"},{char:"🔨",name:"hammer"},{char:"⚡",name:"lightning"},{char:"💎",name:"gem"},{char:"🔗",name:"link"},{char:"📍",name:"pin"},{char:"🏷️",name:"tag"},{char:"⏰",name:"alarm"},{char:"⏳",name:"hourglass"}]},{name:"Arrows",icon:"➡️",emojis:[{char:"⬆️",name:"up"},{char:"⬇️",name:"down"},{char:"⬅️",name:"left"},{char:"➡️",name:"right"},{char:"↗️",name:"up right"},{char:"↘️",name:"down right"},{char:"↙️",name:"down left"},{char:"↖️",name:"up left"},{char:"↕️",name:"up down"},{char:"↔️",name:"left right"},{char:"🔄",name:"arrows"},{char:"🔃",name:"clockwise"},{char:"🔀",name:"shuffle"},{char:"🔁",name:"repeat"},{char:"🔂",name:"repeat one"},{char:"▶️",name:"play"},{char:"⏸️",name:"pause"},{char:"⏹️",name:"stop"},{char:"⏺️",name:"record"},{char:"⏭️",name:"next"},{char:"⏮️",name:"previous"},{char:"⏩",name:"fast forward"},{char:"⏪",name:"rewind"},{char:"🔼",name:"up button"},{char:"🔽",name:"down button"}]}];class SpecialCharsDialog extends BaseDialog{constructor(e,t){super(e,{title:"Special Characters",width:500}),this.plugin=t}buildBody(){const e=document.createElement("div");e.className="rte-specialchars-tabs",e.style.cssText="\n      display: flex;\n      flex-wrap: wrap;\n      gap: 4px;\n      margin-bottom: 16px;\n      border-bottom: 1px solid var(--rte-border-color);\n      padding-bottom: 8px;\n    ",SpecialCharsPlugin.categories.forEach((t,i)=>{const n=document.createElement("button");n.type="button",n.className="rte-specialchars-tab "+(0===i?"active":""),n.textContent=this.translate(t.name),n.style.cssText="\n        padding: 6px 12px;\n        border: none;\n        background: transparent;\n        font-size: 13px;\n        cursor: pointer;\n        border-radius: 4px;\n        transition: all 0.2s;\n        color: var(--rte-text-secondary);\n      ",0===i&&(n.style.background="var(--rte-primary-light)",n.style.color="var(--rte-primary-color)"),n.addEventListener("click",()=>{e.querySelectorAll(".rte-specialchars-tab").forEach(e=>{e.style.background="transparent",e.style.color="var(--rte-text-secondary)"}),n.style.background="var(--rte-primary-light)",n.style.color="var(--rte-primary-color)",this.showCategory(i)}),e.appendChild(n)}),this.body.appendChild(e),this.charGrid=document.createElement("div"),this.charGrid.className="rte-specialchars-grid",this.charGrid.style.cssText="\n      display: flex;\n      flex-wrap: wrap;\n      gap: 4px;\n      max-height: 300px;\n      overflow-y: auto;\n    ",this.body.appendChild(this.charGrid),this.preview=document.createElement("div"),this.preview.className="rte-specialchars-preview",this.preview.style.cssText="\n      margin-top: 16px;\n      padding: 12px;\n      background: var(--rte-bg-secondary);\n      border-radius: 6px;\n      display: flex;\n      align-items: center;\n      gap: 16px;\n    ",this.preview.innerHTML='\n      <span class="preview-char" style="font-size: 32px; width: 48px; text-align: center;"></span>\n      <div class="preview-info">\n        <div class="preview-name" style="font-weight: 500; margin-bottom: 4px;"></div>\n        <div class="preview-code" style="font-size: 12px; color: var(--rte-text-muted); font-family: monospace;"></div>\n      </div>\n    ',this.body.appendChild(this.preview),this.showCategory(0)}buildFooter(){const e=document.createElement("button");e.type="button",e.className="rte-dialog-btn rte-dialog-btn-primary",e.textContent=this.translate("Insert"),e.addEventListener("click",()=>{this.selectedChar&&(this.plugin.insertChar(this.selectedChar),this.close())});const t=document.createElement("button");t.type="button",t.className="rte-dialog-btn",t.textContent=this.translate("Close"),t.addEventListener("click",()=>this.close()),this.footer.appendChild(t),this.footer.appendChild(e)}showCategory(e){const t=SpecialCharsPlugin.categories[e];t&&(this.charGrid.innerHTML="",t.chars.forEach(e=>{const t=document.createElement("button");t.type="button",t.className="rte-specialchar-btn",t.textContent=e.char,t.title=e.name,t.style.cssText="\n        width: 36px;\n        height: 36px;\n        border: 1px solid var(--rte-border-color);\n        background: var(--rte-bg-color);\n        font-size: 18px;\n        cursor: pointer;\n        border-radius: 4px;\n        transition: all 0.15s;\n      ",t.addEventListener("mouseover",()=>{t.style.background="var(--rte-bg-hover)",t.style.transform="scale(1.1)"}),t.addEventListener("mouseout",()=>{t.style.background="var(--rte-bg-color)",t.style.transform="scale(1)",this.selectedCharBtn!==t&&(t.style.borderColor="var(--rte-border-color)")}),t.addEventListener("click",()=>{this.selectChar(e,t)}),t.addEventListener("dblclick",()=>{this.plugin.insertChar(e.char),this.close()}),this.charGrid.appendChild(t)}))}selectChar(e,t){this.selectedCharBtn&&(this.selectedCharBtn.style.borderColor="var(--rte-border-color)"),t.style.borderColor="var(--rte-primary-color)",this.selectedCharBtn=t,this.selectedChar=e.char,this.preview.querySelector(".preview-char").textContent=e.char,this.preview.querySelector(".preview-name").textContent=e.name,this.preview.querySelector(".preview-code").textContent=e.code||`U+${e.char.charCodeAt(0).toString(16).toUpperCase().padStart(4,"0")}`}}class SpecialCharsPlugin extends PluginBase{init(){super.init(),this.dialog=new SpecialCharsDialog(this.editor,this),this.subscribe(EventBus.Events.TOOLBAR_BUTTON_CLICK,e=>{"specialChars"===e.id&&this.openDialog()})}openDialog(){this.saveSelection(),this.dialog.open()}insertChar(e){this.restoreSelection(),this.insertHtml(e),this.recordHistory(!0),this.focusEditor()}destroy(){var e;null==(e=this.dialog)||e.destroy(),super.destroy()}}__publicField(SpecialCharsPlugin,"pluginName","specialChars"),SpecialCharsPlugin.categories=[{name:"Currency",chars:[{char:"$",name:"Dollar",code:"U+0024"},{char:"€",name:"Euro",code:"U+20AC"},{char:"£",name:"Pound",code:"U+00A3"},{char:"¥",name:"Yen",code:"U+00A5"},{char:"¢",name:"Cent",code:"U+00A2"},{char:"₹",name:"Rupee",code:"U+20B9"},{char:"₩",name:"Won",code:"U+20A9"},{char:"₽",name:"Ruble",code:"U+20BD"},{char:"฿",name:"Baht",code:"U+0E3F"},{char:"₿",name:"Bitcoin",code:"U+20BF"},{char:"₫",name:"Dong",code:"U+20AB"},{char:"₱",name:"Peso",code:"U+20B1"}]},{name:"Math",chars:[{char:"±",name:"Plus Minus",code:"U+00B1"},{char:"×",name:"Multiplication",code:"U+00D7"},{char:"÷",name:"Division",code:"U+00F7"},{char:"≠",name:"Not Equal",code:"U+2260"},{char:"≈",name:"Approximately",code:"U+2248"},{char:"≤",name:"Less or Equal",code:"U+2264"},{char:"≥",name:"Greater or Equal",code:"U+2265"},{char:"∞",name:"Infinity",code:"U+221E"},{char:"√",name:"Square Root",code:"U+221A"},{char:"∑",name:"Sum",code:"U+2211"},{char:"∏",name:"Product",code:"U+220F"},{char:"∫",name:"Integral",code:"U+222B"},{char:"∂",name:"Partial Derivative",code:"U+2202"},{char:"π",name:"Pi",code:"U+03C0"},{char:"Ω",name:"Omega",code:"U+03A9"},{char:"µ",name:"Micro",code:"U+00B5"},{char:"∆",name:"Delta",code:"U+2206"},{char:"∇",name:"Nabla",code:"U+2207"},{char:"∈",name:"Element Of",code:"U+2208"},{char:"∉",name:"Not Element Of",code:"U+2209"},{char:"∅",name:"Empty Set",code:"U+2205"},{char:"∩",name:"Intersection",code:"U+2229"},{char:"∪",name:"Union",code:"U+222A"},{char:"⊂",name:"Subset",code:"U+2282"}]},{name:"Greek",chars:[{char:"α",name:"Alpha"},{char:"β",name:"Beta"},{char:"γ",name:"Gamma"},{char:"δ",name:"Delta"},{char:"ε",name:"Epsilon"},{char:"ζ",name:"Zeta"},{char:"η",name:"Eta"},{char:"θ",name:"Theta"},{char:"ι",name:"Iota"},{char:"κ",name:"Kappa"},{char:"λ",name:"Lambda"},{char:"μ",name:"Mu"},{char:"ν",name:"Nu"},{char:"ξ",name:"Xi"},{char:"ο",name:"Omicron"},{char:"π",name:"Pi"},{char:"ρ",name:"Rho"},{char:"σ",name:"Sigma"},{char:"τ",name:"Tau"},{char:"υ",name:"Upsilon"},{char:"φ",name:"Phi"},{char:"χ",name:"Chi"},{char:"ψ",name:"Psi"},{char:"ω",name:"Omega"},{char:"Α",name:"Alpha (Upper)"},{char:"Β",name:"Beta (Upper)"},{char:"Γ",name:"Gamma (Upper)"},{char:"Δ",name:"Delta (Upper)"},{char:"Σ",name:"Sigma (Upper)"},{char:"Ω",name:"Omega (Upper)"}]},{name:"Punctuation",chars:[{char:"—",name:"Em Dash",code:"U+2014"},{char:"–",name:"En Dash",code:"U+2013"},{char:"…",name:"Ellipsis",code:"U+2026"},{char:"‹",name:"Single Left Quote"},{char:"›",name:"Single Right Quote"},{char:"«",name:"Double Left Quote"},{char:"»",name:"Double Right Quote"},{char:'"',name:"Left Double Quote"},{char:'"',name:"Right Double Quote"},{char:"'",name:"Single Quote"},{char:"•",name:"Bullet",code:"U+2022"},{char:"·",name:"Middle Dot",code:"U+00B7"},{char:"†",name:"Dagger",code:"U+2020"},{char:"‡",name:"Double Dagger",code:"U+2021"},{char:"§",name:"Section",code:"U+00A7"},{char:"¶",name:"Paragraph",code:"U+00B6"},{char:"©",name:"Copyright",code:"U+00A9"},{char:"®",name:"Registered",code:"U+00AE"},{char:"™",name:"Trademark",code:"U+2122"},{char:"°",name:"Degree",code:"U+00B0"},{char:"′",name:"Prime",code:"U+2032"},{char:"″",name:"Double Prime",code:"U+2033"},{char:"№",name:"Numero",code:"U+2116"}]},{name:"Arrows",chars:[{char:"←",name:"Left Arrow"},{char:"→",name:"Right Arrow"},{char:"↑",name:"Up Arrow"},{char:"↓",name:"Down Arrow"},{char:"↔",name:"Left Right Arrow"},{char:"↕",name:"Up Down Arrow"},{char:"↖",name:"Up Left Arrow"},{char:"↗",name:"Up Right Arrow"},{char:"↘",name:"Down Right Arrow"},{char:"↙",name:"Down Left Arrow"},{char:"⇐",name:"Double Left Arrow"},{char:"⇒",name:"Double Right Arrow"},{char:"⇑",name:"Double Up Arrow"},{char:"⇓",name:"Double Down Arrow"},{char:"⇔",name:"Double Left Right"},{char:"⇕",name:"Double Up Down"},{char:"↩",name:"Left Hook"},{char:"↪",name:"Right Hook"},{char:"↺",name:"Anticlockwise"},{char:"↻",name:"Clockwise"},{char:"⟵",name:"Long Left"},{char:"⟶",name:"Long Right"},{char:"▲",name:"Triangle Up"},{char:"▼",name:"Triangle Down"}]},{name:"Shapes",chars:[{char:"■",name:"Black Square"},{char:"□",name:"White Square"},{char:"▪",name:"Small Black Square"},{char:"▫",name:"Small White Square"},{char:"●",name:"Black Circle"},{char:"○",name:"White Circle"},{char:"◆",name:"Black Diamond"},{char:"◇",name:"White Diamond"},{char:"★",name:"Black Star"},{char:"☆",name:"White Star"},{char:"▶",name:"Right Triangle"},{char:"◀",name:"Left Triangle"},{char:"▲",name:"Up Triangle"},{char:"▼",name:"Down Triangle"},{char:"►",name:"Right Pointer"},{char:"◄",name:"Left Pointer"},{char:"♠",name:"Spade"},{char:"♣",name:"Club"},{char:"♥",name:"Heart"},{char:"♦",name:"Diamond"},{char:"♪",name:"Music Note"},{char:"♫",name:"Music Notes"},{char:"✓",name:"Check Mark"},{char:"✗",name:"Cross Mark"}]},{name:"Latin",chars:[{char:"À",name:"A Grave"},{char:"Á",name:"A Acute"},{char:"Â",name:"A Circumflex"},{char:"Ã",name:"A Tilde"},{char:"Ä",name:"A Umlaut"},{char:"Å",name:"A Ring"},{char:"Æ",name:"AE"},{char:"Ç",name:"C Cedilla"},{char:"È",name:"E Grave"},{char:"É",name:"E Acute"},{char:"Ê",name:"E Circumflex"},{char:"Ë",name:"E Umlaut"},{char:"Ñ",name:"N Tilde"},{char:"Ö",name:"O Umlaut"},{char:"Ü",name:"U Umlaut"},{char:"ß",name:"Sharp S"},{char:"à",name:"a Grave"},{char:"á",name:"a Acute"},{char:"â",name:"a Circumflex"},{char:"ã",name:"a Tilde"},{char:"ä",name:"a Umlaut"},{char:"å",name:"a Ring"},{char:"æ",name:"ae"},{char:"ç",name:"c Cedilla"},{char:"è",name:"e Grave"},{char:"é",name:"e Acute"},{char:"ê",name:"e Circumflex"},{char:"ë",name:"e Umlaut"},{char:"ñ",name:"n Tilde"},{char:"ö",name:"o Umlaut"},{char:"ü",name:"u Umlaut"},{char:"ÿ",name:"y Umlaut"},{char:"œ",name:"OE"}]}];class SourceViewPlugin extends PluginBase{init(){super.init(),this.sourceEditor=null,this.isActive=!1,this.createSourceEditor(),this.subscribe(EventBus.Events.TOOLBAR_BUTTON_CLICK,e=>{"sourceView"===e.id&&this.toggle()}),this.registerCommand("sourceView",{execute:()=>this.toggle(),isActive:()=>this.isActive})}createSourceEditor(){var e;this.sourceEditor=document.createElement("textarea"),this.sourceEditor.className="rte-source-view",this.sourceEditor.spellcheck=!1,this.sourceEditor.setAttribute("aria-label","HTML source code");const t=this.editor.getContainer(),i=null==(e=this.editor.contentArea)?void 0:e.getContainer();t&&i&&t.insertBefore(this.sourceEditor,i.nextSibling),this.sourceEditor.addEventListener("input",()=>{})}toggle(e){var t,i,n;this.isActive=void 0!==e?e:!this.isActive;const s=this.editor.getContainer(),r=null==(t=this.editor.contentArea)?void 0:t.getContainer();if(this.isActive){const e=(null==(i=this.editor.contentArea)?void 0:i.getContent())||"";this.sourceEditor.value=this.formatHtml(e),s.classList.add("source-mode"),r.style.display="none",this.sourceEditor.style.display="block",this.sourceEditor.focus()}else{const e=this.sourceEditor.value;null==(n=this.editor.contentArea)||n.setContent(e,!0),s.classList.remove("source-mode"),r.style.display="",this.sourceEditor.style.display="none",this.focusEditor()}this.setButtonActive("sourceView",this.isActive),this.emit(EventBus.Events.MODE_CHANGE,{mode:this.isActive?"source":"wysiwyg"}),this.editor.isSourceMode=this.isActive}formatHtml(e){if(!e)return"";let t=e.replace(/(<\/?(p|div|h[1-6]|ul|ol|li|blockquote|pre|table|tr|thead|tbody|hr)[^>]*>)/gi,"\n$1").replace(/^\n/,"").trim();return t=t.replace(/\n{3,}/g,"\n\n"),t}getSource(){var e;return(null==(e=this.sourceEditor)?void 0:e.value)||""}setSource(e){this.sourceEditor&&(this.sourceEditor.value=this.formatHtml(e))}isSourceViewActive(){return this.isActive}destroy(){this.sourceEditor&&this.sourceEditor.parentNode&&this.sourceEditor.parentNode.removeChild(this.sourceEditor),super.destroy()}}__publicField(SourceViewPlugin,"pluginName","sourceView");class FullscreenPlugin extends PluginBase{init(){super.init(),this.isActive=!1,this.originalStyles=null,this.subscribe(EventBus.Events.TOOLBAR_BUTTON_CLICK,e=>{"fullscreen"===e.id&&this.toggle()}),this.registerCommand("fullscreen",{execute:()=>this.toggle(),isActive:()=>this.isActive}),this.registerShortcut("escape",()=>{this.isActive&&this.toggle(!1)}),document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(e){"F11"===e.key&&(e.preventDefault(),this.toggle())}toggle(e){this.isActive=void 0!==e?e:!this.isActive;const t=this.editor.getContainer();t&&(this.isActive?this.enterFullscreen(t):this.exitFullscreen(t),this.setButtonActive("fullscreen",this.isActive),this.emit(EventBus.Events.MODE_CHANGE,{fullscreen:this.isActive}),this.editor.isFullscreen=this.isActive)}enterFullscreen(e){var t,i;this.originalStyles={position:e.style.position,top:e.style.top,left:e.style.left,right:e.style.right,bottom:e.style.bottom,width:e.style.width,height:e.style.height,zIndex:e.style.zIndex,borderRadius:e.style.borderRadius},e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.right="0",e.style.bottom="0",e.style.width="100%",e.style.height="100%",e.style.zIndex="9999",e.style.borderRadius="0",e.classList.add("fullscreen"),document.body.classList.add("rte-fullscreen-active");const n=null==(t=this.editor.contentArea)?void 0:t.getContainer();n&&(n.style.flex="1",n.style.maxHeight="none");const s=null==(i=this.editor.contentArea)?void 0:i.getElement();s&&(s.style.minHeight="auto",s.style.maxHeight="none")}exitFullscreen(e){var t,i;this.originalStyles&&Object.entries(this.originalStyles).forEach(([t,i])=>{e.style[t]=i}),e.classList.remove("fullscreen"),document.body.classList.remove("rte-fullscreen-active");const n=null==(t=this.editor.contentArea)?void 0:t.getContainer();n&&(n.style.flex="",n.style.maxHeight="");const s=null==(i=this.editor.contentArea)?void 0:i.getElement();s&&(s.style.minHeight="",s.style.maxHeight="")}isFullscreenActive(){return this.isActive}destroy(){this.isActive&&this.toggle(!1),document.removeEventListener("keydown",this.handleKeyDown),super.destroy()}}__publicField(FullscreenPlugin,"pluginName","fullscreen");class AutosavePlugin extends PluginBase{init(){super.init(),this.options={interval:3e4,key:"rte-autosave",saveHandler:null,useLocalStorage:!0,showIndicator:!0,...this.options},this.saveTimer=null,this.isDirty=!1,this.lastSavedContent="",this.indicator=null,this.options.showIndicator&&this.createIndicator(),this.subscribe(EventBus.Events.CONTENT_CHANGE,()=>{this.markDirty()}),this.checkRecovery(),this.startTimer(),window.addEventListener("beforeunload",this.handleBeforeUnload.bind(this))}createIndicator(){this.indicator=document.createElement("span"),this.indicator.className="rte-autosave-indicator",this.indicator.style.cssText="\n      display: none;\n      padding: 2px 8px;\n      font-size: 11px;\n      color: var(--rte-text-muted);\n    ";const e=this.editor.footer;e&&e.appendChild(this.indicator)}markDirty(){this.isDirty=!0,this.updateIndicator("Unsaved changes","warning")}markClean(){this.isDirty=!1,this.lastSavedContent=this.getContent()}updateIndicator(e,t="info"){if(this.indicator){switch(this.indicator.textContent=e,this.indicator.style.display="inline",t){case"success":this.indicator.style.color="var(--rte-notification-success)";break;case"warning":this.indicator.style.color="var(--rte-notification-warning)";break;case"error":this.indicator.style.color="var(--rte-notification-error)";break;default:this.indicator.style.color="var(--rte-text-muted)"}"success"===t&&setTimeout(()=>{this.indicator&&(this.indicator.style.display="none")},3e3)}}startTimer(){this.saveTimer&&clearInterval(this.saveTimer),this.saveTimer=setInterval(()=>{this.save()},this.options.interval)}stopTimer(){this.saveTimer&&(clearInterval(this.saveTimer),this.saveTimer=null)}async save(e=!1){if(!e&&!this.isDirty)return!0;const t=this.getContent();if(t===this.lastSavedContent)return this.isDirty=!1,!0;this.emit(EventBus.Events.AUTOSAVE_START,{content:t}),this.updateIndicator("Saving...","info");try{return"function"==typeof this.options.saveHandler&&await this.options.saveHandler(t),this.options.useLocalStorage&&this.saveToLocalStorage(t),this.markClean(),this.updateIndicator("Saved","success"),this.emit(EventBus.Events.AUTOSAVE_SUCCESS,{content:t}),!0}catch(i){return console.error("Autosave failed:",i),this.updateIndicator("Save failed","error"),this.emit(EventBus.Events.AUTOSAVE_ERROR,{error:i}),this.options.useLocalStorage&&this.saveToLocalStorage(t),!1}}saveToLocalStorage(e){try{const t={content:e,timestamp:Date.now(),key:this.options.key};localStorage.setItem(this.options.key,JSON.stringify(t))}catch(t){console.warn("Failed to save to localStorage:",t)}}getFromLocalStorage(){try{const e=localStorage.getItem(this.options.key);if(e)return JSON.parse(e)}catch(e){console.warn("Failed to get from localStorage:",e)}return null}clearLocalStorage(){try{localStorage.removeItem(this.options.key)}catch(e){console.warn("Failed to clear localStorage:",e)}}checkRecovery(){const e=this.getFromLocalStorage();if(!e||!e.content)return;const t=this.getContent();if(e.content!==t&&e.content.trim()){new Date(e.timestamp);const t=this.formatTimeAgo(e.timestamp);confirm(`${this.translate("Recovered content found from")} ${t}.\n\n${this.translate("Do you want to restore this content?")}`)?(this.setContent(e.content),this.recordHistory(!0),this.notify("Content restored","success")):this.clearLocalStorage()}}formatTimeAgo(e){const t=Math.floor((Date.now()-e)/1e3);return t<60?`${t} seconds ago`:t<3600?`${Math.floor(t/60)} minutes ago`:t<86400?`${Math.floor(t/3600)} hours ago`:`${Math.floor(t/86400)} days ago`}handleBeforeUnload(e){if(this.isDirty)return this.save(!0),e.preventDefault(),e.returnValue="You have unsaved changes. Are you sure you want to leave?",e.returnValue}isDirtyContent(){return this.isDirty}saveNow(){return this.save(!0)}setInterval(e){this.options.interval=e,this.startTimer()}destroy(){this.isDirty&&this.save(!0),this.stopTimer(),window.removeEventListener("beforeunload",this.handleBeforeUnload),this.indicator&&this.indicator.parentNode&&this.indicator.parentNode.removeChild(this.indicator),super.destroy()}}__publicField(AutosavePlugin,"pluginName","autosave");class WordCountPlugin extends PluginBase{init(){super.init(),this.options={showWords:!0,showCharacters:!0,showCharactersWithoutSpaces:!1,...this.options},this.element=null,this.createCounter(),this.subscribe(EventBus.Events.CONTENT_CHANGE,()=>{this.update()}),this.subscribe(EventBus.Events.CONTENT_SET,()=>{this.update()}),this.update()}createCounter(){this.element=document.createElement("div"),this.element.className="rte-wordcount",this.element.style.cssText="\n      display: flex;\n      gap: 16px;\n      font-size: 12px;\n      color: var(--rte-text-muted);\n    ";const e=this.editor.footer;e&&e.appendChild(this.element)}update(){if(!this.element)return;const e=[];if(this.options.showWords){const t=this.editor.getWordCount();e.push(`${t} ${this.translate(1===t?"word":"words")}`)}if(this.options.showCharacters){const t=this.editor.getCharacterCount(!1);e.push(`${t} ${this.translate(1===t?"character":"characters")}`)}if(this.options.showCharactersWithoutSpaces){const t=this.editor.getCharacterCount(!0);e.push(`${t} ${this.translate("characters (no spaces)")}`)}this.element.textContent=e.join(" | ")}getWordCount(){return this.editor.getWordCount()}getCharacterCount(e=!1){return this.editor.getCharacterCount(e)}destroy(){this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),super.destroy()}}__publicField(WordCountPlugin,"pluginName","wordcount");class FindReplaceDialog extends BaseDialog{constructor(e,t){super(e,{title:"Find and Replace",width:450,closeOnEscape:!1}),this.plugin=t}buildBody(){this.findField=this.createField({type:"text",label:"Find",id:"rte-find-text",placeholder:"Text to find"}),this.body.appendChild(this.findField),this.replaceField=this.createField({type:"text",label:"Replace with",id:"rte-replace-text",placeholder:"Replacement text"}),this.body.appendChild(this.replaceField);const e=document.createElement("div");e.style.cssText="display: flex; gap: 16px; margin-top: 8px;",this.matchCaseField=this.createField({type:"checkbox",id:"rte-find-matchcase",checkLabel:"Match case"}),e.appendChild(this.matchCaseField),this.wholeWordField=this.createField({type:"checkbox",id:"rte-find-wholeword",checkLabel:"Whole word"}),e.appendChild(this.wholeWordField),this.body.appendChild(e),this.resultsCounter=document.createElement("div"),this.resultsCounter.className="rte-find-results",this.resultsCounter.style.cssText="\n      margin-top: 16px;\n      padding: 8px 12px;\n      background: var(--rte-bg-secondary);\n      border-radius: 4px;\n      font-size: 13px;\n      color: var(--rte-text-secondary);\n    ",this.resultsCounter.textContent="No results",this.body.appendChild(this.resultsCounter);const t=this.findField.querySelector("input");t.addEventListener("input",()=>{this.plugin.find(t.value)}),t.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),e.shiftKey?this.plugin.findPrevious():this.plugin.findNext())})}buildFooter(){const e=document.createElement("button");e.type="button",e.className="rte-dialog-btn",e.textContent="◀ "+this.translate("Previous"),e.addEventListener("click",()=>this.plugin.findPrevious());const t=document.createElement("button");t.type="button",t.className="rte-dialog-btn",t.textContent=this.translate("Next")+" ▶",t.addEventListener("click",()=>this.plugin.findNext());const i=document.createElement("button");i.type="button",i.className="rte-dialog-btn rte-dialog-btn-secondary",i.textContent=this.translate("Replace"),i.addEventListener("click",()=>this.plugin.replace());const n=document.createElement("button");n.type="button",n.className="rte-dialog-btn rte-dialog-btn-primary",n.textContent=this.translate("Replace All"),n.addEventListener("click",()=>this.plugin.replaceAll());const s=document.createElement("button");s.type="button",s.className="rte-dialog-btn",s.textContent=this.translate("Close"),s.addEventListener("click",()=>this.close()),this.footer.appendChild(e),this.footer.appendChild(t),this.footer.appendChild(i),this.footer.appendChild(n),this.footer.appendChild(s)}getData(){const e=this.findField.querySelector("input"),t=this.replaceField.querySelector("input"),i=this.matchCaseField.querySelector("input"),n=this.wholeWordField.querySelector("input");return{find:e.value,replace:t.value,matchCase:i.checked,wholeWord:n.checked}}updateResultsCount(e,t){this.resultsCounter.textContent=0===t?"No results":`${e} of ${t} matches`}close(){this.plugin.clearHighlights(),super.close()}}class FindReplacePlugin extends PluginBase{init(){super.init(),this.dialog=new FindReplaceDialog(this.editor,this),this.matches=[],this.currentMatchIndex=-1,this.highlightClass="rte-find-highlight",this.currentHighlightClass="rte-find-current",this.addStyles(),this.subscribe(EventBus.Events.TOOLBAR_BUTTON_CLICK,e=>{"findReplace"===e.id&&this.openDialog()}),this.registerShortcut("ctrl+f",()=>this.openDialog()),this.registerShortcut("ctrl+h",()=>this.openDialog())}addStyles(){if(document.getElementById("rte-find-styles"))return;const e=document.createElement("style");e.id="rte-find-styles",e.textContent=`\n      .${this.highlightClass} {\n        background-color: #fff3cd;\n        padding: 1px 0;\n      }\n      .${this.currentHighlightClass} {\n        background-color: #ffc107;\n      }\n    `,document.head.appendChild(e)}openDialog(){const e=this.getSelection().getSelectedText();this.dialog.open({find:e}),e&&this.find(e)}find(e){var t;if(this.clearHighlights(),this.matches=[],this.currentMatchIndex=-1,!e)return void this.dialog.updateResultsCount(0,0);const i=this.dialog.getData(),n=null==(t=this.editor.contentArea)?void 0:t.getElement();if(!n)return;let s="g";i.matchCase||(s+="i");let r=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");i.wholeWord&&(r=`\\b${r}\\b`);const o=new RegExp(r,s);this.highlightMatches(n,o),this.dialog.updateResultsCount(this.matches.length>0?1:0,this.matches.length),this.matches.length>0&&(this.currentMatchIndex=0,this.highlightCurrentMatch())}highlightMatches(e,t){const i=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1),n=[];for(;i.nextNode();)n.push(i.currentNode);n.forEach(e=>{const i=e.textContent,n=[];let s;for(t.lastIndex=0;null!==(s=t.exec(i));)n.push({index:s.index,length:s[0].length,text:s[0]});n.length>0&&this.replaceWithHighlights(e,n)})}replaceWithHighlights(e,t){const i=e.textContent,n=document.createDocumentFragment();let s=0;t.forEach((e,t)=>{e.index>s&&n.appendChild(document.createTextNode(i.substring(s,e.index)));const r=document.createElement("span");r.className=this.highlightClass,r.textContent=e.text,r.dataset.matchIndex=this.matches.length,n.appendChild(r),this.matches.push(r),s=e.index+e.length}),s<i.length&&n.appendChild(document.createTextNode(i.substring(s))),e.parentNode.replaceChild(n,e)}highlightCurrentMatch(){if(this.matches.forEach(e=>{e.classList.remove(this.currentHighlightClass)}),this.currentMatchIndex>=0&&this.matches[this.currentMatchIndex]){const e=this.matches[this.currentMatchIndex];e.classList.add(this.currentHighlightClass),e.scrollIntoView({behavior:"smooth",block:"center"})}this.dialog.updateResultsCount(this.currentMatchIndex+1,this.matches.length)}findNext(){0!==this.matches.length&&(this.currentMatchIndex=(this.currentMatchIndex+1)%this.matches.length,this.highlightCurrentMatch())}findPrevious(){0!==this.matches.length&&(this.currentMatchIndex--,this.currentMatchIndex<0&&(this.currentMatchIndex=this.matches.length-1),this.highlightCurrentMatch())}replace(){if(this.currentMatchIndex<0||!this.matches[this.currentMatchIndex])return;const e=this.dialog.getData(),t=this.matches[this.currentMatchIndex];t.textContent=e.replace,t.classList.remove(this.highlightClass,this.currentHighlightClass),this.matches.splice(this.currentMatchIndex,1),this.recordHistory(!0),this.matches.length>0?(this.currentMatchIndex>=this.matches.length&&(this.currentMatchIndex=0),this.highlightCurrentMatch()):this.dialog.updateResultsCount(0,0)}replaceAll(){if(0===this.matches.length)return;const e=this.dialog.getData();let t=0;this.matches.forEach(i=>{i.textContent=e.replace,i.classList.remove(this.highlightClass,this.currentHighlightClass),t++}),this.matches=[],this.currentMatchIndex=-1,this.recordHistory(!0),this.dialog.updateResultsCount(0,0),this.notify(`Replaced ${t} occurrences`,"success")}clearHighlights(){var e;const t=null==(e=this.editor.contentArea)?void 0:e.getElement();if(!t)return;t.querySelectorAll(`.${this.highlightClass}`).forEach(e=>{const t=document.createTextNode(e.textContent);e.parentNode.replaceChild(t,e)}),t.normalize(),this.matches=[],this.currentMatchIndex=-1}destroy(){var e;this.clearHighlights(),null==(e=this.dialog)||e.destroy(),super.destroy()}}__publicField(FindReplacePlugin,"pluginName","findReplace");class MaxLengthPlugin extends PluginBase{init(){super.init(),this.options={maxLength:1e4,maxWords:null,countMode:"characters",showCounter:!0,showWarning:!0,warningThreshold:.9,enforceLimit:!0,...this.options},this.counterElement=null,this.isWarning=!1,this.isOverLimit=!1,this.options.showCounter&&this.createCounter(),this.subscribe(EventBus.Events.CONTENT_CHANGE,()=>{this.checkLimit()}),this.subscribe(EventBus.Events.CONTENT_PASTE,e=>{this.options.enforceLimit&&this.handlePaste(e)}),this.checkLimit()}createCounter(){this.counterElement=document.createElement("span"),this.counterElement.className="rte-maxlength-counter",this.counterElement.style.cssText="\n      padding: 2px 8px;\n      font-size: 12px;\n      color: var(--rte-text-muted);\n      transition: color 0.2s;\n    ";const e=this.editor.footer;e&&e.appendChild(this.counterElement),this.updateCounter()}updateCounter(){if(!this.counterElement)return;const e=this.getCurrentCount(),t=this.getMaxCount(),i=e/t;"words"===this.options.countMode?this.counterElement.textContent=`${e} / ${t} ${this.translate("words")}`:this.counterElement.textContent=`${e} / ${t}`,e>t?(this.counterElement.style.color="var(--rte-notification-error)",this.counterElement.style.fontWeight="600"):i>=this.options.warningThreshold?(this.counterElement.style.color="var(--rte-notification-warning)",this.counterElement.style.fontWeight="500"):(this.counterElement.style.color="var(--rte-text-muted)",this.counterElement.style.fontWeight="normal")}getCurrentCount(){return"words"===this.options.countMode?this.editor.getWordCount():this.editor.getCharacterCount()}getMaxCount(){return"words"===this.options.countMode&&this.options.maxWords||this.options.maxLength}checkLimit(){const e=this.getCurrentCount(),t=this.getMaxCount(),i=e/t;this.updateCounter();const n=this.isWarning;this.isWarning=i>=this.options.warningThreshold&&e<=t,this.isWarning&&!n&&this.options.showWarning&&this.emit("maxLength:warning",{current:e,max:t,remaining:t-e});const s=this.isOverLimit;this.isOverLimit=e>t,this.isOverLimit&&!s&&(this.emit("maxLength:exceeded",{current:e,max:t,over:e-t}),this.options.showWarning&&this.notify(this.translate("Content exceeds maximum length"),"warning"),this.options.enforceLimit&&this.trimContent())}trimContent(){"words"===this.options.countMode?this.trimToWords(this.getMaxCount()):this.trimToCharacters(this.getMaxCount())}trimToCharacters(e){var t;const i=null==(t=this.editor.contentArea)?void 0:t.getElement();if(!i)return;if(i.textContent.length<=e)return;let n=0;const s=document.createTreeWalker(i,NodeFilter.SHOW_TEXT,null,!1);for(;s.nextNode();){const t=s.currentNode,i=t.textContent.length;if(n+i>=e){const i=e-n;t.textContent=t.textContent.substring(0,i);let r=s.nextNode();for(;r;){const e=r;r=s.nextNode(),e.parentNode.removeChild(e)}break}n+=i}this.recordHistory(!0)}trimToWords(e){var t;const i=null==(t=this.editor.contentArea)?void 0:t.getElement();if(!i)return;let n=0;const s=document.createTreeWalker(i,NodeFilter.SHOW_TEXT,null,!1);for(;s.nextNode();){const t=s.currentNode,i=t.textContent.split(/\s+/).filter(e=>e.length>0);if(n+i.length>=e){const r=e-n,o=i.slice(0,r);t.textContent=o.join(" ");let a=s.nextNode();for(;a;){const e=a;a=s.nextNode(),e.parentNode.removeChild(e)}break}n+=i.length}this.recordHistory(!0)}handlePaste(e){const t=e.clipboardData||window.clipboardData;if(!t)return;const i=t.getData("text/plain");if(!i)return;const n=this.getCurrentCount(),s=this.getMaxCount()-n;if("words"===this.options.countMode){const t=i.split(/\s+/).filter(e=>e.length>0);if(t.length>s){e.preventDefault();const i=t.slice(0,s).join(" ");this.insertHtml(i),this.notify(this.translate("Pasted content was trimmed to fit limit"),"warning")}}else if(i.length>s){e.preventDefault();const t=i.substring(0,s);this.insertHtml(t),this.notify(this.translate("Pasted content was trimmed to fit limit"),"warning")}}getRemainingCount(){return this.getMaxCount()-this.getCurrentCount()}isAtLimit(){return this.getCurrentCount()>=this.getMaxCount()}isExceeded(){return this.isOverLimit}setMaxLength(e){this.options.maxLength=e,this.checkLimit()}setMaxWords(e){this.options.maxWords=e,this.options.countMode="words",this.checkLimit()}destroy(){this.counterElement&&this.counterElement.parentNode&&this.counterElement.parentNode.removeChild(this.counterElement),super.destroy()}}__publicField(MaxLengthPlugin,"pluginName","maxLength");class MentionPlugin extends PluginBase{init(){super.init(),this.options={trigger:"@",minChars:1,maxSuggestions:10,debounceTime:200,dataSource:null,renderItem:null,insertTemplate:null,linkTemplate:null,...this.options},this.dropdown=null,this.isOpen=!1,this.searchQuery="",this.selectedIndex=-1,this.suggestions=[],this.debounceTimer=null,this.triggerPosition=null,this.createDropdown(),this.attachListeners()}createDropdown(){this.dropdown=document.createElement("div"),this.dropdown.className="rte-mention-dropdown",this.dropdown.style.cssText="\n      position: absolute;\n      z-index: 10002;\n      background: var(--rte-bg-color, #fff);\n      border: 1px solid var(--rte-border-color, #ddd);\n      border-radius: 8px;\n      box-shadow: 0 4px 16px rgba(0,0,0,0.15);\n      max-width: 300px;\n      min-width: 200px;\n      max-height: 250px;\n      overflow-y: auto;\n      display: none;\n    ",document.body.appendChild(this.dropdown)}attachListeners(){var e;const t=null==(e=this.editor.contentArea)?void 0:e.getElement();t&&(t.addEventListener("input",this.handleInput.bind(this)),t.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("click",this.handleDocumentClick.bind(this)))}handleInput(e){if(this.checkTrigger())this.open();else if(this.isOpen){const e=this.getSearchQuery();null!==e?this.search(e):this.close()}}checkTrigger(){const e=this.getRange();if(!e||!e.collapsed)return!1;const t=this.getTextBeforeCursor();if(!t)return!1;return new RegExp(`(^|\\s)${this.escapeRegex(this.options.trigger)}$`).test(t)}getTextBeforeCursor(){var e;const t=this.getRange();if(!t)return"";this.getSelection();const i=null==(e=this.editor.contentArea)?void 0:e.getElement();if(!i)return"";const n=document.createRange();n.selectNodeContents(i),n.setEnd(t.startContainer,t.startOffset);return n.toString()}getSearchQuery(){const e=this.getTextBeforeCursor(),t=e.lastIndexOf(this.options.trigger);if(-1===t)return null;const i=e.substring(t+this.options.trigger.length);return/\s/.test(i)?null:i}handleKeyDown(e){if(this.isOpen)switch(e.key){case"ArrowDown":e.preventDefault(),this.selectNext();break;case"ArrowUp":e.preventDefault(),this.selectPrevious();break;case"Enter":case"Tab":this.selectedIndex>=0&&(e.preventDefault(),this.insertMention(this.suggestions[this.selectedIndex]));break;case"Escape":e.preventDefault(),this.close()}}handleDocumentClick(e){this.isOpen&&!this.dropdown.contains(e.target)&&this.close()}open(){this.isOpen=!0,this.selectedIndex=-1,this.triggerPosition=this.getCaretPosition(),this.search("")}close(){this.isOpen=!1,this.dropdown.style.display="none",this.selectedIndex=-1,this.suggestions=[]}search(e){this.searchQuery=e,this.debounceTimer&&clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout(async()=>{await this.performSearch(e)},this.options.debounceTime)}async performSearch(e){if(e.length<this.options.minChars&&e.length>0)return void this.renderSuggestions([]);let t=[];if("function"==typeof this.options.dataSource)try{t=await this.options.dataSource(e)}catch(i){console.error("Mention search error:",i)}else Array.isArray(this.options.dataSource)&&(t=this.options.dataSource.filter(t=>(t.name||t.label||t).toLowerCase().includes(e.toLowerCase())));t=t.slice(0,this.options.maxSuggestions),this.suggestions=t,this.renderSuggestions(t)}renderSuggestions(e){this.dropdown.innerHTML="",0!==e.length?(e.forEach((e,t)=>{const i=document.createElement("div");i.className="rte-mention-item",i.style.cssText="\n        padding: 10px 14px;\n        cursor: pointer;\n        display: flex;\n        align-items: center;\n        gap: 10px;\n        transition: background 0.15s;\n      ","function"==typeof this.options.renderItem?i.innerHTML=this.options.renderItem(e):i.innerHTML=this.defaultRenderItem(e),i.addEventListener("mouseover",()=>{i.style.background="var(--rte-bg-hover, #f0f0f0)",this.selectedIndex=t,this.updateSelection()}),i.addEventListener("mouseout",()=>{this.selectedIndex!==t&&(i.style.background="transparent")}),i.addEventListener("click",()=>{this.insertMention(e)}),this.dropdown.appendChild(i)}),this.positionDropdown(),this.dropdown.style.display="block",e.length>0&&(this.selectedIndex=0,this.updateSelection())):this.dropdown.style.display="none"}defaultRenderItem(e){if("string"==typeof e)return`<span>${this.escapeHtml(e)}</span>`;let t="";return(e.avatar||e.image)&&(t+=`<img src="${e.avatar||e.image}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">`),t+='<div style="flex: 1; min-width: 0;">',t+=`<div style="font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${this.escapeHtml(e.name||e.label)}</div>`,(e.description||e.username)&&(t+=`<div style="font-size: 12px; color: var(--rte-text-muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${this.escapeHtml(e.description||"@"+e.username)}</div>`),t+="</div>",t}positionDropdown(){var e;if(!this.triggerPosition)return;const t=null==(e=this.editor.contentArea)?void 0:e.getContainer();if(!t)return;t.getBoundingClientRect();let i=this.triggerPosition.top+this.triggerPosition.height+4,n=this.triggerPosition.left;this.dropdown.getBoundingClientRect(),n+300>window.innerWidth&&(n=window.innerWidth-310),i+250>window.innerHeight&&(i=this.triggerPosition.top-260),this.dropdown.style.top=`${i}px`,this.dropdown.style.left=`${n}px`}getCaretPosition(){const e=this.getRange();if(!e)return{top:0,left:0,height:20};const t=e.getBoundingClientRect();return{top:t.bottom||t.top+20,left:t.left,height:t.height||20}}selectNext(){0!==this.suggestions.length&&(this.selectedIndex=(this.selectedIndex+1)%this.suggestions.length,this.updateSelection())}selectPrevious(){0!==this.suggestions.length&&(this.selectedIndex--,this.selectedIndex<0&&(this.selectedIndex=this.suggestions.length-1),this.updateSelection())}updateSelection(){this.dropdown.querySelectorAll(".rte-mention-item").forEach((e,t)=>{t===this.selectedIndex?(e.style.background="var(--rte-bg-hover, #f0f0f0)",e.scrollIntoView({block:"nearest"})):e.style.background="transparent"})}insertMention(e){let t;if(this.close(),this.deleteTriggerAndQuery(),"function"==typeof this.options.insertTemplate)t=this.options.insertTemplate(e);else{const i=e.name||e.label||e,n="function"==typeof this.options.linkTemplate?this.options.linkTemplate(e):null;t=n?`<a href="${this.escapeHtml(n)}" class="rte-mention" contenteditable="false">@${this.escapeHtml(i)}</a>&nbsp;`:`<span class="rte-mention" contenteditable="false" data-mention-id="${this.escapeHtml(e.id||"")}">@${this.escapeHtml(i)}</span>&nbsp;`}this.insertHtml(t),this.recordHistory(!0),this.emit("mention:insert",{item:e})}deleteTriggerAndQuery(){const e=this.getRange();if(!e)return;const t=this.getTextBeforeCursor(),i=t.lastIndexOf(this.options.trigger);if(-1===i)return;const n=t.length-i,s=document.createRange();s.setStart(e.startContainer,e.startOffset-n),s.setEnd(e.startContainer,e.startOffset),s.deleteContents()}escapeHtml(e){if("string"!=typeof e)return"";const t=document.createElement("div");return t.textContent=e,t.innerHTML}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}destroy(){this.dropdown&&this.dropdown.parentNode&&this.dropdown.parentNode.removeChild(this.dropdown),this.debounceTimer&&clearTimeout(this.debounceTimer),super.destroy()}}__publicField(MentionPlugin,"pluginName","mention");const n={full:{name:"full",plugins:["link","image","table","video","emoji","specialChars","sourceView","fullscreen","findReplace","autosave","wordcount","maxLength","mention"],toolbar:[["bold","italic","underline","strikethrough"],["heading"],["bulletList","numberedList"],["alignLeft","alignCenter","alignRight","alignJustify"],["indent","outdent"],["link","image","video","table"],["blockquote","codeBlock","horizontalRule"],["textColor","backgroundColor"],["emoji","specialChars"],["undo","redo"],["removeFormat","findReplace","sourceView","fullscreen"]],options:{minHeight:300,autosave:{interval:3e4,useLocalStorage:!0},maxLength:{maxLength:5e4,showCounter:!0},wordcount:{showWords:!0,showCharacters:!0}}},basic:{name:"basic",plugins:["link","image","table","sourceView","wordcount"],toolbar:[["bold","italic","underline"],["heading"],["bulletList","numberedList"],["alignLeft","alignCenter","alignRight"],["link","image","table"],["textColor","backgroundColor"],["undo","redo"],["removeFormat","sourceView"]],options:{minHeight:250,wordcount:{showWords:!0,showCharacters:!1}}},minimal:{name:"minimal",plugins:[],toolbar:[["bold","italic","underline"],["bulletList","numberedList"],["undo","redo"],["removeFormat"]],options:{minHeight:150}},comment:{name:"comment",plugins:["link","emoji"],toolbar:[["bold","italic"],["link","emoji"],["undo","redo"]],options:{minHeight:100,maxLength:{maxLength:2e3,showCounter:!0}}},email:{name:"email",plugins:["link","image","autosave"],toolbar:[["bold","italic","underline"],["bulletList","numberedList"],["alignLeft","alignCenter","alignRight"],["link","image"],["textColor"],["undo","redo"]],options:{minHeight:300,autosave:{interval:1e4,useLocalStorage:!0}}}},s={height:"auto",minHeight:200,maxHeight:null,placeholder:"",readOnly:!1,autofocus:!1,sanitize:!0,toolbar:["bold","italic","underline","|","heading","|","bulletList","numberedList","|","alignLeft","alignCenter","alignRight","|","link","image","|","textColor","backgroundColor","|","undo","redo","|","removeFormat"],stickyToolbar:!1,plugins:[],autosave:{interval:3e4,key:"rte-autosave",saveHandler:null,useLocalStorage:!0,showIndicator:!0},wordcount:{showWords:!0,showCharacters:!0,showCharactersWithoutSpaces:!1},maxLength:{maxLength:1e4,maxWords:null,countMode:"characters",showCounter:!0,showWarning:!0,warningThreshold:.9,enforceLimit:!0},mention:{trigger:"@",minChars:1,maxSuggestions:10,debounceTime:200,dataSource:null,renderItem:null,insertTemplate:null,linkTemplate:null},image:{uploadUrl:null,fileBrowser:{enabled:!0,options:{apiActions:{getPresetCategories:"../../js/components/editor/php/filebrowser.php?action=get_preset_categories",getPresets:"../../js/components/editor/php/filebrowser.php?action=get_presets",getFiles:"../../js/components/editor/php/filebrowser.php?action=get_files",getFolderTree:"../../js/components/editor/php/filebrowser.php?action=get_folder_tree",upload:"../../js/components/editor/php/filebrowser.php?action=upload",createFolder:"../../js/components/editor/php/filebrowser.php?action=create_folder",rename:"../../js/components/editor/php/filebrowser.php?action=rename",delete:"../../js/components/editor/php/filebrowser.php?action=delete",copy:"../../js/components/editor/php/filebrowser.php?action=copy",move:"../../js/components/editor/php/filebrowser.php?action=move"}}},maxFileSize:5242880,allowedTypes:["image/jpeg","image/png","image/gif","image/webp"]},video:{allowedProviders:["youtube","vimeo"],responsive:!0},findReplace:{matchCase:!1,wholeWord:!1},theme:{primaryColor:null,borderRadius:null,fontFamily:null}};function mergeOptions(e={},t={}){const i={...s};return Object.keys(t).forEach(e=>{"object"!=typeof t[e]||Array.isArray(t[e])?i[e]=t[e]:i[e]={...i[e],...t[e]}}),Object.keys(e).forEach(t=>{"object"==typeof e[t]&&!Array.isArray(e[t])&&i[t]?i[t]={...i[t],...e[t]}:i[t]=e[t]}),i}const r={link:LinkPlugin,image:ImagePlugin,table:TablePlugin,video:VideoPlugin,emoji:i,specialChars:SpecialCharsPlugin,sourceView:SourceViewPlugin,fullscreen:FullscreenPlugin,autosave:AutosavePlugin,wordcount:WordCountPlugin,findReplace:FindReplacePlugin,maxLength:MaxLengthPlugin,mention:MentionPlugin};Object.entries(r).forEach(([e,t])=>{RichTextEditor2.registerPlugin(e,t)}),RichTextEditor2.create=function(e,t="basic"){let i={};if("string"==typeof t){const e=n[t];e?(i=mergeOptions({},e.options),i.plugins=e.plugins,i.toolbar=e.toolbar):(console.warn(`Profile "${t}" not found, using "basic"`),i=mergeOptions({},n.basic.options),i.plugins=n.basic.plugins,i.toolbar=n.basic.toolbar)}else if("object"==typeof t){const e=t.profile||"basic",s=n[e]||n.basic;i=mergeOptions(t,s.options),i.plugins=t.plugins||s.plugins,i.toolbar=t.toolbar||s.toolbar}return new RichTextEditor2(e,i)},RichTextEditor2.getProfiles=function(){return{...n}},RichTextEditor2.getDefaults=function(){return{...s}},RichTextEditor2.registerProfile=function(e,t){n[e]=t};let o=class FileBrowser{constructor(e={}){var t,i,n,s;this.options={apiActions:{getPresetCategories:"/file-browser/get_preset_categories",getPresets:"/file-browser/get_presets",getFiles:"/file-browser/get_files",getFolderTree:"/file-browser/get_folder_tree",upload:"/file-browser/upload",createFolder:"/file-browser/create_folder",rename:"/file-browser/rename",delete:"/file-browser/delete",copy:"/file-browser/copy",move:"/file-browser/move"},requestTransformer:null,responseTransformer:null,showPresetTab:!0,presetTabName:"Prepared file",browserTabName:"File management",allowedFileTypes:(null==(i=null==(t=window.CONFIG)?void 0:t.FILE_UPLOAD)?void 0:i.ALLOWED_FILE_TYPES)||"image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt",thumbnailSize:120,maxFileSize:(null==(s=null==(n=window.CONFIG)?void 0:n.FILE_UPLOAD)?void 0:s.MAX_FILE_SIZE)||5242880,onSelect:null,onClose:null,onError:null,activeTab:1,multiSelect:!1,customContextMenuItems:[],useApiClient:void 0!==window.ApiClient,auth:{type:"token",getToken:null,headerName:"Authorization",headerFormat:"Bearer {token}",credentials:"include"},...e},window.translate||(window.translate=e=>e),this.options.useApiClient&&!window.ApiClient&&(console.warn("ApiClient not found. Setting useApiClient to false."),this.options.useApiClient=!1),this.currentPath="/",this.currentPresetCategory=null,this.selectedFiles=[],this.clipboardFile=null,this.clipboardAction=null,this.searchTerm="",this.sortBy="name",this.sortDir="asc",this.viewMode="grid",this.isLoading=!1,this.breadcrumbs=[{name:"Home",path:"/"}],this.fileIcons={default:"icon-file",folder:"icon-folder",image:"icon-image",pdf:"icon-pdf",doc:"icon-word",docx:"icon-word",xls:"icon-excel",xlsx:"icon-excel",ppt:"icon-ppt",pptx:"icon-ppt",txt:"icon-document",zip:"icon-zip",rar:"icon-zip",mp3:"icon-song",mp4:"icon-video",mov:"icon-video"},this.imageExtensions=["jpg","jpeg","png","gif","webp","svg","ico","bmp"],this.bindMethods(),this.createDOMElements(),this.addEventListeners()}isImageExtension(e){return!!e&&this.imageExtensions.includes(e.toLowerCase().replace(".",""))}bindMethods(){this.open=this.open.bind(this),this.close=this.close.bind(this),this.loadFiles=this.loadFiles.bind(this),this.loadPresets=this.loadPresets.bind(this),this.loadPresetCategories=this.loadPresetCategories.bind(this),this.switchTab=this.switchTab.bind(this),this.selectFile=this.selectFile.bind(this),this.uploadFiles=this.uploadFiles.bind(this),this.createFolder=this.createFolder.bind(this),this.renameFile=this.renameFile.bind(this),this.deleteFile=this.deleteFile.bind(this),this.showContextMenu=this.showContextMenu.bind(this),this.hideContextMenu=this.hideContextMenu.bind(this),this.navigateToFolder=this.navigateToFolder.bind(this),this.search=this.search.bind(this),this.sort=this.sort.bind(this),this.confirmSelection=this.confirmSelection.bind(this),this.pasteFromClipboard=this.pasteFromClipboard.bind(this),this.changeViewMode=this.changeViewMode.bind(this),this.handleEscapeKey=this.handleEscapeKey.bind(this),this.handleDragOver=this.handleDragOver.bind(this),this.handleDrop=this.handleDrop.bind(this),this.updateStatus=this.updateStatus.bind(this),this.makeApiRequest=this.makeApiRequest.bind(this),this.uploadFilesWithApi=this.uploadFilesWithApi.bind(this)}async makeApiRequest(e,t,i="POST"){try{let n,s=this.options.apiActions[e]||e,r=t;if("function"==typeof this.options.requestTransformer&&(r=this.options.requestTransformer(e,t)),this.options.useApiClient&&window.ApiClient)return window.ApiClient.fetch(s,{method:i,headers:{"Content-Type":"application/json"},body:"GET"!==i?r:void 0}).then(t=>"function"==typeof this.options.responseTransformer?this.options.responseTransformer(e,t):t);{const t={method:i,headers:{"Content-Type":"application/json"},credentials:this.options.auth.credentials||"include"};"GET"!==i&&r&&(t.body=JSON.stringify(r)),t.headers=this.addAuthToRequest(t.headers);const o=s,a=await fetch(o,t);if(401===a.status||403===a.status)throw new Error("Authentication required");if(!a.ok){const e=await a.json().catch(()=>({}));throw new Error(e.message||`Request failed with status ${a.status}`)}n=await a.json(),"function"==typeof this.options.responseTransformer&&(n=this.options.responseTransformer(e,n))}return n}catch(n){throw console.error("API request error:",n),this.updateStatus("Error: "+(n.message||"Unknown error")),this.options.onError&&this.options.onError(n),n}}addAuthToRequest(e){const t=this.options.auth;if(!t||"none"===t.type)return e;switch(t.type){case"token":const i="function"==typeof t.getToken?t.getToken():null;i&&(e[t.headerName]=t.headerFormat.replace("{token}",i));break;case"basic":if(t.username&&t.password){const i=btoa(`${t.username}:${t.password}`);e[t.headerName]=`Basic ${i}`}break;case"custom":"function"==typeof t.customHandler&&(e=t.customHandler(e))}return e}async uploadFilesWithApi(e,t){try{const i=Array.from(e).filter(e=>e.size>this.options.maxFileSize?(this.logSecurityIssue(`File too large: ${this.sanitizeFileName(e.name)}`),!1):!!this.isAllowedFileType(e)||(this.logSecurityIssue(`File type not allowed: ${this.sanitizeFileName(e.name)}`),!1));if(0===i.length)return this.updateStatus("No valid files to upload"),{success:!1,message:"No valid files to upload"};const n=this.options.apiActions.upload||"/file-browser/upload",s={path:t||this.currentPath};if(this.options.useApiClient&&window.ApiClient){const e=await window.ApiClient.uploadFile(n,i,s);return"function"==typeof this.options.responseTransformer?this.options.responseTransformer("upload",e):e}{const e=new FormData;Object.keys(s).forEach(t=>{e.append(t,s[t])}),i.forEach(t=>{e.append(this.options.fileFieldName||"files[]",t)});let t={method:"POST",body:e,credentials:this.options.auth.credentials||"include"};const r={};t.headers=this.addAuthToRequest(r);const o=await fetch(n,t),a=await o.json();return"function"==typeof this.options.responseTransformer?this.options.responseTransformer("upload",a):a}}catch(i){return console.error("File upload error:",i),this.options.onError&&this.options.onError(i),{success:!1,message:i.message||"Upload failed"}}}checkCsrfMetaTag(){const e=document.querySelector('meta[name="csrf-token"]');e&&(this.csrfToken=e.getAttribute("content"))}async getCsrfToken(){if(this.csrfToken&&""!==this.csrfToken)return this.csrfToken;if(!this.options.csrfProtection)return"";try{const e=await fetch(this.options.csrfTokenUrl,{method:"GET",credentials:"same-origin"});if(!e.ok)throw new Error(`Failed to get CSRF token: ${e.status}`);const t=await e.json();if(!t.success||!t.data.csrf_token)throw new Error("Invalid CSRF token response");return this.csrfToken=t.data.csrf_token,this.csrfToken}catch(e){return console.error("Error getting CSRF token:",e),this.options.onError&&this.options.onError(e),""}}createDOMElements(){this.overlay=document.createElement("div"),this.overlay.className="file-browser-overlay",this.modal=document.createElement("div"),this.modal.className="file-browser-modal";const e=document.createElement("div");e.className="file-browser-header";const t=document.createElement("h3");t.textContent=window.translate("Select the file");const i=document.createElement("button");i.type="button",i.className="file-browser-close",i.innerHTML="&times;",i.title=window.translate("Close"),i.addEventListener("click",this.close),e.appendChild(t),e.appendChild(i);const n=document.createElement("div");if(n.className="file-browser-tabs",this.options.showPresetTab){const e=document.createElement("button");e.type="button",e.className="file-browser-tab active",e.textContent=window.translate(this.options.presetTabName),e.dataset.tab="preset",e.addEventListener("click",()=>this.switchTab("preset")),n.appendChild(e)}const s=document.createElement("button");s.type="button",s.className="file-browser-tab",s.textContent=window.translate(this.options.browserTabName),s.dataset.tab="browser",s.addEventListener("click",()=>this.switchTab("browser")),n.appendChild(s),this.content=document.createElement("div"),this.content.className="file-browser-content",this.presetContent=document.createElement("div"),this.presetContent.className="file-browser-tab-content active",this.presetContent.id="preset-content";const r=document.createElement("div");r.className="file-browser-categories",this.presetContent.appendChild(r);const o=document.createElement("div");o.className="file-browser-files-container";const a=document.createElement("div");a.className="file-browser-search";const l=document.createElement("input");l.type="text",l.placeholder=window.translate("Search"),l.addEventListener("input",e=>{this.searchTerm=e.target.value.trim(),this.loadPresets()});const c=document.createElement("span");c.className="search-icon icon-search",a.appendChild(l),a.appendChild(c);const h=document.createElement("div");h.className="file-browser-toolbar",h.appendChild(a);const d=document.createElement("div");d.className="view-options";const u=document.createElement("button");u.type="button",u.className="view-option active",u.innerHTML='<span class="icon-grid"></span>',u.title=window.translate("Grid view"),u.addEventListener("click",()=>this.changeViewMode("grid"));const m=document.createElement("button");m.type="button",m.className="view-option",m.innerHTML='<span class="icon-listview"></span>',m.title=window.translate("List view"),m.addEventListener("click",()=>this.changeViewMode("list")),d.appendChild(u),d.appendChild(m),h.appendChild(d);const p=document.createElement("div");p.className="file-browser-files grid-view",o.appendChild(h),o.appendChild(p),this.presetContent.appendChild(o),this.browserContent=document.createElement("div"),this.browserContent.className="file-browser-tab-content",this.browserContent.id="browser-content";const g=document.createElement("div");g.className="file-browser-sidebar";const v=document.createElement("div");v.className="sidebar-title",v.textContent=window.translate("Folder"),this.folderTree=document.createElement("div"),this.folderTree.className="folder-tree",g.appendChild(v),g.appendChild(this.folderTree),this.browserContent.appendChild(g);const f=document.createElement("div");f.className="file-browser-main-content";const b=document.createElement("div");b.className="file-browser-toolbar";const y=document.createElement("div");y.className="file-browser-breadcrumbs",b.appendChild(y);const w=document.createElement("div");w.className="file-browser-actions";const E=document.createElement("button");E.type="button",E.className="action-button",E.innerHTML=`<span class="icon-upload"></span> ${window.translate("Upload")}`,E.addEventListener("click",()=>{const e=document.createElement("input");e.type="file",e.multiple=!0,e.accept=this.options.allowedFileTypes,e.style.display="none",document.body.appendChild(e),e.addEventListener("change",t=>{t.target.files.length>0&&this.uploadFiles(t.target.files),document.body.removeChild(e)}),e.click()});const C=document.createElement("button");C.type="button",C.className="action-button",C.innerHTML=`<span class="icon-create-folder"></span> ${window.translate("Create a folder")}`,C.addEventListener("click",this.createFolder),w.appendChild(E),w.appendChild(C),b.appendChild(w);const x=document.createElement("div");x.className="search-view-container";const T=document.createElement("div");T.className="file-browser-search";const S=document.createElement("input");S.type="text",S.placeholder=window.translate("Search"),S.addEventListener("input",e=>{this.searchTerm=e.target.value.trim(),this.loadFiles()});const L=document.createElement("span");L.className="search-icon icon-search",T.appendChild(S),T.appendChild(L);const k=document.createElement("div");k.className="view-options";const A=document.createElement("button");A.type="button",A.className="view-option active",A.innerHTML='<span class="icon-grid"></span>',A.title=window.translate("Grid view"),A.addEventListener("click",()=>this.changeViewMode("grid"));const N=document.createElement("button");N.type="button",N.className="view-option",N.innerHTML='<span class="icon-listview"></span>',N.title=window.translate("List view"),N.addEventListener("click",()=>this.changeViewMode("list")),k.appendChild(A),k.appendChild(N),x.appendChild(T),x.appendChild(k),b.appendChild(x);const F=document.createElement("div");F.className="file-browser-drop-area",F.innerHTML=`<div class="drop-message"><span class="icon-upload"></span><p>${window.translate("Drag the file here to upload.")}</p></div>`,F.addEventListener("dragover",this.handleDragOver),F.addEventListener("drop",this.handleDrop),F.addEventListener("dragleave",()=>{F.classList.remove("drag-over")}),this.fileList=document.createElement("div"),this.fileList.className="file-browser-files grid-view",F.appendChild(this.fileList),f.appendChild(b),f.appendChild(F),this.browserContent.appendChild(f);const R=document.createElement("div");R.className="file-browser-footer",this.status=document.createElement("div"),this.status.className="file-browser-status",this.status.textContent=window.translate("Ready to use");const D=document.createElement("div");D.className="file-browser-buttons";const B=document.createElement("button");B.type="button",B.className="file-browser-button cancel border",B.textContent=window.translate("Cancel"),B.addEventListener("click",this.close);const M=document.createElement("button");M.type="button",M.className="file-browser-button select",M.textContent=window.translate("Choose"),M.addEventListener("click",this.confirmSelection),D.appendChild(B),D.appendChild(M),R.appendChild(this.status),R.appendChild(D),this.contextMenu=document.createElement("div"),this.contextMenu.className="file-browser-context-menu",this.contextMenu.style.display="none",document.body.appendChild(this.contextMenu),this.content.appendChild(this.presetContent),this.content.appendChild(this.browserContent),this.options.showPresetTab&&this.content.appendChild(this.presetContent),this.modal.appendChild(e),this.modal.appendChild(n),this.modal.appendChild(this.content),this.modal.appendChild(R),this.overlay.appendChild(this.modal)}addEventListeners(){document.addEventListener("keydown",this.handleEscapeKey),document.addEventListener("click",this.hideContextMenu)}handleEscapeKey(e){"Escape"===e.key&&("none"!==this.contextMenu.style.display?this.hideContextMenu():this.close())}async getToken(){if(!this.options.useToken)return null;try{const e=await fetch(this.options.tokenUrl,{method:"GET",credentials:"same-origin"});if(!e.ok)throw new Error(`Failed to get token: ${e.status}`);const t=await e.json();if(!t.success||!t.token)throw new Error("Invalid token response");return this.token=t.token,this.setupTokenRefresh(),this.token}catch(e){return console.error("Error getting token:",e),this.options.onError&&this.options.onError(e),null}}setupTokenRefresh(){this.tokenRefreshTimer&&clearTimeout(this.tokenRefreshTimer),this.tokenRefreshTimer=setTimeout(this.refreshToken,this.options.refreshTokenInterval)}async refreshToken(){await this.getToken()}open(){try{document.body.appendChild(this.overlay),2===this.options.activeTab?this.switchTab("browser"):this.switchTab("preset"),this.loadPresetCategories(),setTimeout(()=>{this.overlay.classList.add("active"),this.modal.classList.add("active")},10),this.selectedFiles=[],this.updateStatus()}catch(e){console.error("Error opening file browser:",e),this.options.onError&&this.options.onError(e)}}close(){this.overlay.classList.remove("active"),this.modal.classList.remove("active"),setTimeout(()=>{this.overlay.parentNode&&document.body.removeChild(this.overlay)},300),"function"==typeof this.options.onClose&&this.options.onClose()}switchTab(e){const t=this.modal.querySelectorAll(".file-browser-tab"),i=this.modal.querySelectorAll(".file-browser-tab-content");t.forEach(t=>{t.classList.remove("active"),t.dataset.tab===e&&t.classList.add("active")}),i.forEach(e=>{e.classList.remove("active")}),"preset"===e?(this.presetContent.classList.add("active"),this.loadPresets().catch(e=>console.error("Error in loadPresets:",e))):(this.browserContent.classList.add("active"),this.loadFiles().catch(e=>console.error("Error in loadFiles:",e)),this.loadFolderTree().catch(e=>console.error("Error in loadFolderTree:",e)))}async loadPresetCategories(){try{this.updateStatus("Loading");const e=this.options.apiActions.getPresetCategories||"/file-browser/get_preset_categories",t=await this.makeApiRequest(e,null,"GET");t.success&&t.data.categories?this.renderPresetCategories(t.data.categories):this.updateStatus("Unable to load the category")}catch(e){console.error("Error loading preset categories:",e),this.updateStatus("There is an error in loading categories.")}}renderPresetCategories(e){if(!this.presetContent)return;const t=this.presetContent.querySelector(".file-browser-categories");if(!t)return;t.innerHTML="";const i=document.createElement("ul"),n=document.createElement("li");n.className=null===this.currentPresetCategory?"active":"",n.innerHTML=`<span class="icon-folder"></span> ${window.translate("all")}`,n.addEventListener("click",()=>{this.currentPresetCategory=null,this.loadPresets(),i.querySelectorAll("li").forEach(e=>{e.classList.remove("active")}),n.classList.add("active")}),i.appendChild(n),e.forEach(e=>{const t=document.createElement("li");t.className=this.currentPresetCategory===e.id?"active":"",t.innerHTML=`<span class="${e.icon||"icon-folder"}"></span> ${window.translate(e.name)}`,e.description&&(t.title=e.description),t.addEventListener("click",()=>{this.currentPresetCategory=e.id,this.loadPresets(),i.querySelectorAll("li").forEach(e=>{e.classList.remove("active")}),t.classList.add("active")}),i.appendChild(t)}),t.appendChild(i)}async loadPresets(){const e=this.presetContent.querySelector(".file-browser-files");e.innerHTML="",this.isLoading=!0,this.updateStatus("Loading");const t=new URLSearchParams({category:this.currentPresetCategory||"all",search:this.searchTerm,sort_by:this.sortBy,sort_dir:this.sortDir});try{const i=this.options.apiActions.getPresets||"/file-browser/get_presets",n=i.includes("?")?"&":"?",s=`${i}${n}${t.toString()}`,r=await this.makeApiRequest(s,null,"GET");r.success?(this.displayFiles(e,r.data.files,"preset"),this.updateStatus("{items} items.",{items:r.data.files.length})):this.updateStatus("Error: {message}",{message:r.message})}catch(i){console.error("Error loading presets:",i),this.updateStatus("Unable to load data")}finally{this.isLoading=!1}}async loadFiles(){const e=this.browserContent.querySelector(".file-browser-files");e.innerHTML="",this.isLoading=!0,this.updateStatus("Loading"),this.updateBreadcrumbs();const t=new URLSearchParams({path:this.currentPath,search:this.searchTerm,sort_by:this.sortBy,sort_dir:this.sortDir});try{const i=this.options.apiActions.getFiles||"/file-browser/get_files",n=i.includes("?")?"&":"?",s=`${i}${n}${t.toString()}`,r=await this.makeApiRequest(s,null,"GET");r.success?(this.displayFiles(e,r.data.files,"browser"),this.updateStatus("{items} items.",{items:r.data.files.length})):this.updateStatus("Error: {message}",{message:r.message})}catch(i){console.error("Error loading files:",i),this.updateStatus("Unable to load data")}finally{this.isLoading=!1}}async loadFolderTree(){this.folderTree.innerHTML=`<div class="loading">${window.translate("Loading")}...</div>`;try{const e=this.options.apiActions.getFolderTree||"/file-browser/get_folder_tree",t=await this.makeApiRequest(e,null,"GET");t.success?this.displayFolderTree(t.data.folders):this.folderTree.innerHTML=`<div class="error">${window.translate(t.message)}</div>`}catch(e){console.error("Error loading folder tree:",e),this.folderTree.innerHTML=`<div class="error">${window.translate("Unable to download the list of folders")}</div>`}}displayFolderTree(e,t=null){const i=document.createElement("ul");if(i.className="folder-tree-list",t)e.forEach(e=>{const t=this.createFolderTreeItem(e);i.appendChild(t)}),i.children.length>0&&t.appendChild(i);else{this.folderTree.innerHTML="",this.folderTree.appendChild(i);const t=document.createElement("li");t.className="folder-tree-item"+("/"===this.currentPath?" active":"");const n=document.createElement("a");n.href="#",n.className="folder-tree-link",n.innerHTML=`<span class="icon-folder"></span> ${window.translate("Home")}`,n.addEventListener("click",e=>{e.preventDefault(),this.navigateToFolder("/")}),t.appendChild(n),i.appendChild(t),e.forEach(e=>{const t=this.createFolderTreeItem(e);i.appendChild(t)})}}createFolderTreeItem(e){const t=document.createElement("li");t.className="folder-tree-item";this.currentPath===e.path&&t.classList.add("active");const i=document.createElement("a");i.href="#",i.className="folder-tree-link",i.dataset.path=e.path;const n=e.children&&e.children.length>0;let s="";return n&&(s='<span class="expand-icon"></span>',t.classList.add("has-children")),i.innerHTML=`${s}<span class="icon-folder"></span> ${e.name}`,i.addEventListener("click",t=>{t.preventDefault(),this.navigateToFolder(e.path)}),n&&i.querySelector(".expand-icon").addEventListener("click",i=>{if(i.preventDefault(),i.stopPropagation(),t.classList.contains("expanded")){t.classList.remove("expanded");const e=t.querySelector("ul");e&&t.removeChild(e)}else t.classList.add("expanded"),this.displayFolderTree(e.children,t)}),t.appendChild(i),i.addEventListener("contextmenu",t=>{t.preventDefault();const i=[{label:"เปิด",icon:"icon-folder-open",action:()=>this.navigateToFolder(e.path)},{label:"สร้างโฟลเดอร์ใหม่",icon:"icon-create-folder",action:()=>this.createFolder(e.path)},{label:"เปลี่ยนชื่อ",icon:"icon-edit",action:()=>this.renameFile(e.path,"folder")},{label:"ลบ",icon:"icon-delete",action:()=>this.deleteFile(e.path,"folder")}];this.options.customContextMenuItems.length>0&&(i.push({type:"separator"}),this.options.customContextMenuItems.forEach(e=>{i.push(e)})),this.showContextMenu(t,i)}),t}async createFolder(e=null){let t;t=e&&"object"==typeof e&&e.preventDefault?this.currentPath:"string"==typeof e?e:this.currentPath;const i=prompt(window.translate("Please specify the name of the new folder."));if(!i)return;if(!/^[a-zA-Z0-9_\-]+$/.test(i))return void alert(window.translate("The name of the folder is incorrect. Please use the numbers, numbers, numbers and signs only."));this.isLoading=!0,this.updateStatus("Creating a folder");const n={path:t,name:i};try{const e=this.options.apiActions.createFolder||"/file-browser/create_folder",t=await this.makeApiRequest(e,n);t.success?(this.updateStatus("Already created the folder"),this.loadFiles(),this.loadFolderTree()):this.updateStatus("Error: {message}",{message:t.message})}catch(s){console.error("Error creating folder:",s),this.updateStatus("Unable to create a folder")}finally{this.isLoading=!1}}displayFiles(e,t,i){if(e.innerHTML="",0===t.length){const t=document.createElement("div");return t.className="empty-message",t.textContent=window.translate("Not found files"),void e.appendChild(t)}t.sort((e,t)=>{if("folder"===e.type&&"folder"!==t.type)return-1;if("folder"!==e.type&&"folder"===t.type)return 1;const i=e[this.sortBy],n=t[this.sortBy];return"asc"===this.sortDir?i>n?1:-1:i<n?1:-1}),t.forEach(t=>{const n=this.createFileItem(t,i);e.appendChild(n)})}createFileItem(e,t){const i=document.createElement("div");i.className="file-item",i.dataset.path=e.path,i.dataset.type=e.type,i.dataset.mode=t;const n=this.selectedFiles.some(i=>i.path===e.path&&i.mode===t);n&&i.classList.add("selected");const s=document.createElement("div");s.className="file-thumbnail";const r=e.thumbnail||e.mimeType&&e.mimeType.startsWith("image/")||e.type&&e.type.startsWith("image/")||this.isImageExtension(e.extension);if("folder"===e.type)s.innerHTML='<span class="icon-folder"></span>';else if(r){const t=e.thumbnail||e.url;s.innerHTML=`<span style="background-image:url(${t})"></span>`}else{const t=e.extension?e.extension.toLowerCase().replace(".",""):"default",i=this.fileIcons[t]||this.fileIcons.default;s.innerHTML=`<span class="${i}"></span>`}const o=document.createElement("div");o.className="file-info";const a=document.createElement("div");if(a.className="file-name",a.textContent=e.name,a.title=e.name,o.appendChild(a),"list"===this.viewMode){const t=document.createElement("div");if(t.className="file-details","folder"!==e.type){const i=document.createElement("span");i.className="file-size",i.textContent=this.formatFileSize(e.size),t.appendChild(i)}const i=document.createElement("span");i.className="file-date",i.textContent=this.formatDate(e.modified),t.appendChild(i),o.appendChild(t)}return i.appendChild(s),i.appendChild(o),i.addEventListener("click",i=>{"folder"!==e.type||"browser"!==t?this.selectFile(e,t,i.ctrlKey||i.metaKey):this.navigateToFolder(e.path)}),i.addEventListener("dblclick",()=>{"folder"!==e.type||"browser"!==t?(this.selectedFiles=[{...e,mode:t}],this.confirmSelection()):this.navigateToFolder(e.path)}),i.addEventListener("contextmenu",i=>{i.preventDefault(),n||this.selectFile(e,t,!1);const s=[];"folder"===e.type&&"browser"===t?s.push({label:"Open",icon:"icon-folder-open",action:()=>this.navigateToFolder(e.path)},{label:"Create a new folder",icon:"icon-create-folder",action:()=>this.createFolder(e.path)}):s.push({label:"Choose",icon:"icon-valid",action:()=>this.confirmSelection()}),"browser"===t&&(s.push({label:"Rename",icon:"icon-edit",action:()=>this.renameFile(e.path,e.type)},{label:"Delete",icon:"icon-delete",action:()=>this.deleteFile(e.path,e.type)}),this.clipboardFile&&s.push({type:"separator"},{label:"Paste",icon:"icon-paste",action:()=>this.pasteFromClipboard(e.path)})),this.options.customContextMenuItems.length>0&&(s.push({type:"separator"}),this.options.customContextMenuItems.forEach(e=>{s.push(e)})),this.showContextMenu(i,s)}),i}selectFile(e,t,i=!1){i&&!this.options.multiSelect&&(i=!1);const n={...e,mode:t};if(i){const i=this.selectedFiles.findIndex(i=>i.path===e.path&&i.mode===t);-1!==i?this.selectedFiles.splice(i,1):this.selectedFiles.push(n)}else this.selectedFiles=[n];this.updateFileSelection(),this.updateStatus()}updateFileSelection(){this.modal.querySelectorAll(".file-item").forEach(e=>e.classList.remove("selected")),this.selectedFiles.forEach(e=>{const t=`.file-item[data-path="${e.path}"][data-mode="${e.mode}"]`,i=this.modal.querySelector(t);i&&i.classList.add("selected")})}updateBreadcrumbs(){const e=this.browserContent.querySelector(".file-browser-breadcrumbs");if(!e)return;e.innerHTML="";const t=this.currentPath.split("/").filter(e=>e);let i="/";const n=document.createElement("a");n.href="#",n.className="breadcrumb-item",n.innerHTML='<span class="icon-home"></span>',n.title=window.translate("Home"),n.addEventListener("click",e=>{e.preventDefault(),this.navigateToFolder("/")}),e.appendChild(n);const s=document.createElement("span");s.className="breadcrumb-separator",s.textContent="/",e.appendChild(s.cloneNode(!0)),t.forEach((n,r)=>{i+=n+"/";const o=document.createElement("a");o.href="#",o.className="breadcrumb-item",o.textContent=n,o.dataset.path=i,o.addEventListener("click",e=>{e.preventDefault(),this.navigateToFolder(i)}),e.appendChild(o),r<t.length-1&&e.appendChild(s.cloneNode(!0))})}navigateToFolder(e){this.currentPath=e,this.loadFiles();this.folderTree.querySelectorAll(".folder-tree-item").forEach(t=>{t.classList.remove("active");const i=t.querySelector(".folder-tree-link");i&&i.dataset.path===e&&t.classList.add("active")})}async uploadFiles(e){if(0!==e.length){this.isLoading=!0,this.updateStatus("Uploading 0/{length}",{length:e.length});try{const t=await this.uploadFilesWithApi(e,this.currentPath);t.success?(this.updateStatus("Uploading {uploaded}/{total} files",{uploaded:t.uploaded,total:t.total}),window.Editor&&window.Editor.showNotification&&window.Editor.showNotification("The upload is finished.","success"),setTimeout(()=>{this.loadFiles()},1e3)):(this.updateStatus("Unable to upload files"),window.Editor&&window.Editor.showNotification&&window.Editor.showNotification("Unable to upload files","error"))}catch(t){console.error("Error uploading files:",t),this.updateStatus("Unable to upload files"),window.Editor&&window.Editor.showNotification&&window.Editor.showNotification("Unable to upload files","error")}finally{this.isLoading=!1}}}logSecurityIssue(e){console.warn("Security Issue:",e)}isAllowedFileType(e){const t=this.options.allowedFileTypes.split(","),i=e.name.toLowerCase(),n=e.type;let s=!1;for(const r of t){const e=r.trim();if("*"===e){s=!0;break}if(e===n){s=!0;break}if(e.startsWith(".")){if("."+i.split(".").pop()===e.toLowerCase()){s=!0;break}}if(e.endsWith("/*")){const t=e.replace("/*","");if(n.startsWith(t+"/")){s=!0;break}}}return s}sanitizeFileName(e){return e.length>30?e.substring(0,15)+"..."+e.substring(e.length-10):e}async renameFile(e,t){const i=e.split("/").pop(),n=prompt(window.translate("Please specify a new name for {type}",{type:"folder"===t?"folder":"file"}),i);if(!n||n===i)return;if(!/^[a-zA-Z0-9_\-\.]+$/.test(n))return void alert(window.translate("Incorrect name Please use the numbers, numbers, numbers and signs only."));this.isLoading=!0,this.updateStatus("Renaming");const s={path:e,new_name:n};try{const e=this.options.apiActions.rename||"/file-browser/rename",i=await this.makeApiRequest(e,s,"POST");i.success?(this.updateStatus("The name has been changed."),this.loadFiles(),"folder"===t&&this.loadFolderTree()):this.updateStatus("Error: {message}",{message:i.message})}catch(r){console.error("Error renaming:",r),this.updateStatus("Unable to change the name")}finally{this.isLoading=!1}}async deleteFile(e,t){const i=e.split("/").pop(),n="folder"===t;let s=window.translate('Want to delete {type} "{name}" or not?',{type:n?"folder":"file",name:i});if(n&&(s+=`\n\n${window.translate("Warning: Deleting the folder will delete all files in the folder as well.")}`),!confirm(s))return;this.isLoading=!0,this.updateStatus("Delete");const r={path:e};try{const e=this.options.apiActions.delete||"/file-browser/delete",t=await this.makeApiRequest(e,r,"POST");t.success?(this.updateStatus("Already deleted"),this.loadFiles(),n&&this.loadFolderTree()):this.updateStatus("Error: {message}",{message:t.message})}catch(o){console.error("Error deleting:",o),this.updateStatus("Unable to delete")}finally{this.isLoading=!1}}async pasteFromClipboard(e=null){if(!this.clipboardFile)return;const t=e||this.currentPath;this.isLoading=!0,this.updateStatus("Operating");const i={action:"cut"===this.clipboardAction?"move":"copy",source:this.clipboardFile.path,destination:t};try{const e=await this.makeApiRequest("/file-browser",i);e.success?(this.updateStatus("cut"===this.clipboardAction?"Already moved":"Already copied"),"cut"===this.clipboardAction&&(this.clipboardFile=null,this.clipboardAction=null),this.loadFiles(),this.loadFolderTree()):this.updateStatus("Error: {message}",{message:e.message})}catch(n){console.error("Error pasting:",n),this.updateStatus("Cannot be placed")}finally{this.isLoading=!1}}showContextMenu(e,t){this.contextMenu.innerHTML="",t.forEach(e=>{if("separator"===e.type){const e=document.createElement("div");return e.className="context-menu-separator",void this.contextMenu.appendChild(e)}const t=document.createElement("div");if(t.className="context-menu-item",e.icon){const i=document.createElement("span");i.className=e.icon,t.appendChild(i)}const i=document.createElement("span");i.className="context-menu-label",i.textContent=window.translate(e.label),t.appendChild(i),e.disabled?t.classList.add("disabled"):t.addEventListener("click",()=>{this.hideContextMenu(),"function"==typeof e.action&&e.action()}),this.contextMenu.appendChild(t)}),this.contextMenu.style.display="block",this.contextMenu.style.left=`${e.pageX}px`,this.contextMenu.style.top=`${e.pageY}px`;const i=this.contextMenu.getBoundingClientRect(),n=window.innerWidth,s=window.innerHeight;i.right>n&&(this.contextMenu.style.left=n-i.width-5+"px"),i.bottom>s&&(this.contextMenu.style.top=e.pageY-i.height+"px")}hideContextMenu(){this.contextMenu.style.display="none"}changeViewMode(e){this.viewMode=e;const t=this.modal.querySelectorAll(".view-option:first-child"),i=this.modal.querySelectorAll(".view-option:last-child");t.forEach(t=>{t.classList.toggle("active","grid"===e)}),i.forEach(t=>{t.classList.toggle("active","list"===e)});this.modal.querySelectorAll(".file-browser-files").forEach(t=>{t.className=`file-browser-files ${e}-view`}),this.presetContent.classList.contains("active")?this.loadPresets():this.loadFiles()}search(e){this.searchTerm=e,this.presetContent.classList.contains("active")?this.loadPresets():this.loadFiles()}sort(e,t=null){t||(t=e===this.sortBy&&"asc"===this.sortDir?"desc":"asc"),this.sortBy=e,this.sortDir=t,this.presetContent.classList.contains("active")?this.loadPresets():this.loadFiles()}updateStatus(e=null,t){e?this.status.textContent=window.translate(e,t):this.selectedFiles.length>0?this.status.textContent=window.translate("Select {items}",{items:this.selectedFiles.length}):this.status.textContent=window.translate("Ready to use")}confirmSelection(){if(0!==this.selectedFiles.length){if("function"==typeof this.options.onSelect){const e=this.selectedFiles.map(e=>({name:e.name,path:e.path,url:e.url,type:e.type,size:e.size,extension:e.extension,thumbnail:e.thumbnail}));this.options.onSelect(this.options.multiSelect?e:e[0])}this.close()}else alert(window.translate("Please select the file."))}handleDragOver(e){e.preventDefault(),e.stopPropagation(),e.dataTransfer.dropEffect="copy";e.currentTarget.classList.add("drag-over")}handleDrop(e){e.preventDefault(),e.stopPropagation();e.currentTarget.classList.remove("drag-over"),e.dataTransfer.files.length>0&&this.uploadFiles(e.dataTransfer.files)}formatFileSize(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB","TB"][t]}formatDate(e){if(!e)return"";const t=new Date(e);return`${t.getDate().toString().padStart(2,"0")}/${(t.getMonth()+1).toString().padStart(2,"0")}/${t.getFullYear()} ${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}`}destroy(){this.tokenRefreshTimer&&clearTimeout(this.tokenRefreshTimer),document.removeEventListener("keydown",this.handleEscapeKey),document.removeEventListener("click",this.hideContextMenu),this.contextMenu&&this.contextMenu.parentNode&&this.contextMenu.parentNode.removeChild(this.contextMenu),this.overlay&&this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay)}};return"undefined"!=typeof window&&(window.RichTextEditor=RichTextEditor2,window.FileBrowser=o,window.RichTextEditor.EventBus=EventBus,window.RichTextEditor.CommandManager=CommandManager,window.RichTextEditor.HistoryManager=HistoryManager,window.RichTextEditor.SelectionManager=SelectionManager,window.RichTextEditor.KeyboardManager=KeyboardManager,window.RichTextEditor.profiles=n,window.RichTextEditor.defaults=s,window.RichTextEditor.mergeOptions=mergeOptions,window.RichTextEditor.FileBrowser=o),RichTextEditor2}();
//# sourceMappingURL=richtext-editor.min.js.map
