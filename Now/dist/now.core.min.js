var __defProp=Object.defineProperty,__defNormalProp=(e,t,a)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,__publicField=(e,t,a)=>__defNormalProp(e,"symbol"!=typeof t?t+"":t,a);!function(){"use strict";var e,t,a,n,s,r,i,o,l,c,d,u,h,p,m,g,f,y,v,w,b,E,S,C,M,x,T,A,k,L,I,D,N,_,F,O,R;const P={version:"1.0.0",managers:new Map,plugins:new Map,paths:{framework:"/Now",application:"/",components:"/js/components",plugins:"/plugins",templates:"/templates",translations:"/translations"},resources:{core:["/js/Utils.js","/js/NotificationManager.js","/js/ErrorManager.js","/js/ErrorRenderer.js","/js/I18nManager.js","/js/BackdropManager.js","/js/Modal.js","/js/ModalDataBinder.js","/js/EventManager.js","/js/EventSystemManager.js","/js/ThemeManager.js","/js/StateManager.js","/js/ScrollManager.js","/js/DialogManager.js","/js/TemplateManager.js","/js/ReactiveHelpers.js","/js/ComponentManager.js","/js/ReactiveManager.js","/js/ExpressionEvaluator.js","/js/WatchManager.js","/js/StorageManager.js","/js/SyncManager.js","/js/TokenService.js","/js/AuthManager.js","/js/RouterManager.js","/js/SecurityConfig.js","/js/SecurityManager.js","/js/ResponseHandler.js","/js/HttpClient.js","/js/ApiService.js","/js/ApiComponent.js","/js/ElementManager.js","/js/Autocomplete.js","/js/FormError.js","/js/FormManager.js","/js/ElementFactory.js","/js/DropdownPanel.js","/js/TextElementFactory.js","/js/MaskElementFactory.js","/js/NumberElementFactory.js","/js/SelectElementFactory.js","/js/CascadingSelectManager.js","/js/TextareaElementFactory.js","/js/FileElementFactory.js","/js/SearchElementFactory.js","/js/DateElementFactory.js","/js/ColorElementFactory.js","/js/TagsElementFactory.js","/js/MultiSelectElementFactory.js","/js/RangeElementFactory.js","/js/PasswordElementFactory.js","/js/CalendarManager.js","/js/FilterManager.js","/js/MenuManager.js","/js/Sortable.js","/js/AnimationManager.js","/js/MediaViewer.js"],components:[],plugins:[]},DEFAULT_CONFIG:{debug:!1,environment:"development",strictMode:!0,mainSelector:'#main, [role="main"]',auth:{enabled:!1,type:"jwt-httponly",autoInit:!1,endpoints:{login:"api/auth/login",logout:"api/auth/logout",verify:"api/auth/verify",refresh:"api/auth/refresh"},redirects:{afterLogin:"/",afterLogout:"/login",unauthorized:"/login",forbidden:"/403"}},router:{enabled:!1,mode:"history",base:"/",auth:{enabled:!1,autoGuard:!1,defaultRequireAuth:!1,publicPaths:["/login","/register","/forgot-password"],guestOnlyPaths:["/login","/register"],conventions:{"/auth/*":{public:!0},"/admin/*":{roles:["admin"]},"/api/*":{skipRouter:!0}}},errorHandling:{unauthorized:{action:"redirect",target:"/login",preservePath:!0,message:"Please login to continue"},forbidden:{action:"render",template:"/errors/403.html",notify:!0},notFound:{action:"render",template:"/errors/404.html",title:"Page Not Found"}}},component:{reactive:!1,autoRender:!0,batchUpdates:!0,batchDelay:16,devTools:{enabled:!0,logStateChanges:!0}},stateManager:{persistent:!1,storage:"localStorage",devTools:!0},security:{csrf:{enabled:!1,tokenName:"_token",headerName:"X-CSRF-Token"},xss:{enabled:!1},csp:{enabled:!1},validateInput:{enabled:!1},sanitizeOutput:{enabled:!1}},devTools:{enabled:!1,performance:!0,logger:!0,inspector:!0},performance:{monitoring:!1,metrics:!0,warnings:!0,errorReporting:!0},i18n:{enabled:!1,defaultLocale:"en",availableLocales:["en","th"],fallbackLocale:"en"},serviceWorker:{enabled:!1,debug:!1,serviceWorkerPath:"/service-worker.js",scope:"/"},http:{baseURL:"",timeout:3e4,retries:3,retryDelay:1e3},storage:{enabled:!0,type:"indexeddb",name:"now_app_storage"},app:{name:"Now.js Application",version:"1.0.0",description:"",author:"",homepage:""}},state:{initialized:!1,loading:!1,error:null,loadedResources:new Set,activeApp:null,performance:{startTime:null,metrics:new Map}},managers:new Map,async init(e={}){var t,a,n,s,r,i,o,l,c,d;try{this.state.loading=!0,this.state.loadedResources||(this.state.loadedResources=new Set),this.state.performance||(this.state.performance={startTime:null,metrics:new Map}),this.setupErrorHandling(),this.config=this.mergeConfig(this.DEFAULT_CONFIG,e),e.paths&&(this.paths={...this.paths,...e.paths});const h=await this.detectBasePath();try{let e=h||"";e||(e="/"),e.startsWith("/")||(e="/"+e),e.length>1&&e.endsWith("/")&&(e=e.slice(0,-1)),this.basePath=e,this.config.router||(this.config.router={}),this.config.router.base&&"/"!==this.config.router.base||(this.config.router.base=e)}catch(u){console.warn("[Now.js] Failed to normalize detected base path",u)}"development"===this.config.environment&&this.setupDevTools();if("production"===this.config.environment||await this.loadResources(this.resources.core,"framework"),await this.initializeManagers(),(null==(a=null==(t=e.resources)?void 0:t.plugins)?void 0:a.length)>0&&(await this.loadResources(e.resources.plugins,"plugins"),await this.initializePlugins(e.resources.plugins)),(null==(s=null==(n=e.resources)?void 0:n.components)?void 0:s.length)>0&&(await this.loadResources(e.resources.components,"components"),await this.initializeComponents(e.resources.components)),this.state.initialized=!0,null==(r=this.config.auth)||r.enabled,null==(i=this.config.router)||i.enabled,(null==(o=this.config.authTemplate)?void 0:o.enabled)||(null==(l=this.config.auth)?void 0:l.enabled)&&(null==(c=this.config.template)?void 0:c.auth)){const e=window.AuthTemplateManager;e&&(await e.init(this.config.authTemplate||(null==(d=this.config.template)?void 0:d.auth)||{}),this.registerManager("authTemplate",e))}return this.state.loading=!1,this.endPerformanceTracking("initialization"),this}catch(h){throw this.state.loading=!1,this.handleError(h),h}},async createApp(e={}){if(!this.state.initialized)throw new Error("Framework must be initialized first");try{this.startPerformanceTracking("app-creation");const t={config:this.mergeConfig(this.config.app,e),framework:this,managers:this.managers,plugins:this.plugins,state:{},mount:async e=>this.mountApp(t,e)};return e.state&&this.managers.has("state")&&(t.state=await this.managers.get("state").init(e.state)),e.i18n&&this.managers.has("i18n")&&await this.managers.get("i18n").init(e.i18n),e.plugins&&await this.initializeAppPlugins(t,e.plugins),this.endPerformanceTracking("app-creation"),this.state.activeApp=t,t}catch(t){throw this.handleError(t),t}},publicRoute(e,t){if(!RouterManager.state.initialized)throw new Error("RouterManager must be initialized first");return RouterManager.register(e,{...t,requireAuth:!1,isPublic:!0})},protectedRoute(e,t){if(!RouterManager.state.initialized)throw new Error("RouterManager must be initialized first");return RouterManager.register(e,{...t,requireAuth:!0})},adminRoute(e,t){if(!RouterManager.state.initialized)throw new Error("RouterManager must be initialized first");const a=window.AuthGuards;return RouterManager.register(e,{...t,requireAuth:!0,roles:["admin"],beforeEnter:a?a.adminOnly():null})},roleRoute(e,t,a){if(!RouterManager.state.initialized)throw new Error("RouterManager must be initialized first");const n=window.AuthGuards;return RouterManager.register(e,{...a,requireAuth:!0,roles:Array.isArray(t)?t:[t],beforeEnter:n?n.requireRole(t):null})},guestRoute(e,t){if(!RouterManager.state.initialized)throw new Error("RouterManager must be initialized first");const a=window.AuthGuards;return RouterManager.register(e,{...t,requireGuest:!0,beforeEnter:a?a.requireGuest():null})},updateAuthTemplates(e=document.body){const t=this.getManager("authTemplate");t&&t.processContainer(e)},async refreshAuthTemplates(){const e=this.getManager("authTemplate");e&&await e.forceUpdate()},translate(e,t={}){const a=this.getManager("i18n");return a?a.translate(e,t):e},emit(e,t={}){const a=this.getManager("event");if(a)return a.emit(e,{...t,timestamp:Date.now()})},async mountApp(e,t){try{this.startPerformanceTracking("app-mount");const a="string"==typeof t?document.querySelector(t):t;if(!a)throw new Error("Mount element not found");a.innerHTML="",this.managers.has("component")&&await this.managers.get("component").init(a),this.managers.has("event")&&this.managers.get("event").emit("app:mounted",{app:e}),this.endPerformanceTracking("app-mount")}catch(a){throw this.handleError(a),a}},use(e,t={}){if(!e.name)throw new Error("Plugin must have a name");return this.plugins.has(e.name)||this.plugins.set(e.name,{instance:e,config:t}),this},registerManager(e,t){return this.managers.has(e)||this.managers.set(e,t),this},async initializeComponents(e){const t=this.getManager("component");if(t)for(const n of e)try{const e=n.split("/").pop().replace(".js",""),a=e.replace(/Component$/,"").toLowerCase();let s=0;const r=5;for(;s<r&&!t.has(a);)await new Promise(e=>setTimeout(e,100)),s++;if(s===r){const s=`❌ Component initialization failed!\n\nExpected component name: "${a}"\nFrom file: ${e}.js\nFull path: ${n}\n\nThe component was not registered within ${100*r}ms.\n\nCommon causes:\n1. Component name mismatch - Check that the component registers as "${a}"\n   Example: Now.getManager('component').define('${a}', {...})\n\n2. Component name conflict - Another component may already use this name\n   Check console for "Component name conflict" warnings\n\n3. JavaScript error in component file - Check browser console for errors\n\n4. File not loaded - Verify the file path is correct\n\nRegistered components: ${Array.from(t.components.keys()).join(", ")||"none"}`;if(this.config.strictMode)throw new Error(s);console.error(s)}}catch(a){if(this.config.strictMode)throw a;console.error("Component initialization error:",a)}},async loadResources(e,t){if(e&&0!==e.length)for(const n of e)if(!this.state.loadedResources.has(n))try{const e=this.resolvePath(n,t);await this.loadResource(e),this.state.loadedResources.add(n);const a=e.match(/(([^\/]+)Manager).js$/);if(a){const e=window[a[1]];e&&this.managers.set(a[2].toLowerCase(),e)}}catch(a){if(this.config.strictMode)throw a}},async loadResource(e){const t=performance.now();try{const a=e.split(".").pop().toLowerCase();let n;switch(a){case"css":n=document.createElement("link"),n.rel="stylesheet",n.href=e;break;case"js":n=document.createElement("script"),n.src=e,n.async=!0;break;default:throw new Error(`Unsupported resource type: ${a}`)}await new Promise((t,a)=>{n.onload=t,n.onerror=()=>a(new Error(`Failed to load: ${e}`)),document.head.appendChild(n)});const s=performance.now();return this.recordPerformance("resource-load",{url:e,duration:s-t,type:a}),!0}catch(a){const t=document.querySelector(`[src="${e}"], [href="${e}"]`);throw t&&t.remove(),this.recordPerformance("resource-error",{url:e,error:a.message}),a}},resolvePath(e,t="framework"){e=String(e||"").replace(/^(?:\.\.\/|\.\/|\/)+/,"");const a={framework:this.paths.framework,application:this.paths.application,components:this.paths.components,plugins:this.paths.plugins,templates:this.paths.templates,translations:this.paths.translations},n=String(a[t]||""),s=[];let r=String(this.basePath||"").trim();if(r&&"/"!==r&&(r=r.replace(/^\/+|\/+$/g,""),r&&s.push(r)),n&&"/"!==n){const e=n.replace(/^\/+|\/+$/g,"");e&&s.push(e)}const i=e.replace(/^\/+/,"");return i&&s.push(i),"/"+s.join("/")},getBasePath(){return this.basePath||"/"},resolveUrl(e){if(!e)return this.getBasePath();const t=String(e).trim();if(/^(https?:)?\/\//i.test(t))return t;if(t.startsWith("/"))return t;const a=this.getBasePath();return"/"===a?"/"+t:a+"/"+t},buildUrl(...e){const t=e.filter(e=>null!=e&&""!==e).map(e=>String(e).replace(/^\/+|\/+$/g,"")).filter(e=>""!==e),a=this.getBasePath(),n=[];return a&&"/"!==a&&n.push(a.replace(/^\/+|\/+$/g,"")),n.push(...t),"/"+n.join("/")},getCurrentPath(){const e=window.location.pathname||"/";return"/"===e?"/":e.replace(/\/+$/,"")},getCurrentDir(){const e=this.getCurrentPath();return e.endsWith("/")?e:e+"/"},getCurrentRelativePath(){const e=this.getCurrentPath(),t=this.getBasePath();if("/"===t||!e.startsWith(t))return e;const a=e.substring(t.length);return a.startsWith("/")?a:"/"+a},async detectBasePath(){const e=document.getElementsByTagName("script"),t=Array.from(e).find(e=>e.src&&(e.src.includes("Now.js")||e.src.includes("now.core")));let a="";if(t){const e=t.src,n=new URL(e).pathname;if(n.endsWith("/Now/Now.js")){a=n.replace("/Now/Now.js","")||""}}return a},async isBundleAvailable(){try{const e=this.resolvePath("/dist/now.core.min.js","framework");return(await fetch(e,{method:"HEAD"})).ok}catch(e){return!1}},async initializeManagers(){for(const[t,a]of this.managers)if("function"==typeof a.init)try{await a.init(this.config[t])}catch(e){if(this.config.strictMode)throw e}},async initializePlugins(e){for(const a of e)try{const e=a.match(/(([^\/]+)Plugin).js$/);if(e){const t=window[e[1]];if("function"==typeof(null==t?void 0:t.init)){const a=this.config[e[2].toLowerCase()];await t.init(this,a)}}}catch(t){if(this.config.strictMode)throw t;console.warn(`Failed to initialize plugin ${a}:`,t)}},async initializeAppPlugins(e,t){for(const n of t)try{"function"==typeof n.init&&await n.init(e)}catch(a){if(this.config.strictMode)throw a;console.warn("Failed to initialize app plugin:",a)}},handleEvent(e,t){var a;const n=null==(a=t.closest("[data-component]"))?void 0:a.dataset.componentId;if(!n)return;const s=this.getManager("component");if(s){const t=s.instances.get(n);(null==t?void 0:t.methods[e])&&t.methods[e].call(t)}},setupErrorHandling(){window.onerror=(e,t,a,n,s)=>{this.handleError(s||new Error(e),{source:t,line:a,column:n})},window.onunhandledrejection=e=>{this.handleError(e.reason,{type:"unhandledrejection"})}},handleError(e,t={}){var a,n;this.state.error=e,this.state.loading=!1;const s={message:e.message,stack:e.stack,timestamp:Date.now(),...t};this.config.debug&&console.error("Framework Error:",s);try{const t=this.getManager("notification");t&&t.error(e.message||"An error occurred")}catch(r){console.error("Failed to show error notification:",r)}try{const a=this.getManager("event");a&&a.emit("error",{error:e,context:t})}catch(i){console.error("Failed to emit error event:",i)}(null==(a=this.config.performance)?void 0:a.errorReporting)&&(null==(n=this.state.performance)?void 0:n.metrics)&&this.logErrorMetrics(e,t)},setupDevTools(){this.config.devTools.enabled&&(window.__NOW_DEV__={framework:this,inspect:()=>this.inspect(),getManagers:()=>Array.from(this.managers.keys()),getPlugins:()=>Array.from(this.plugins.keys()),getResources:()=>Array.from(this.state.loadedResources),getConfig:()=>this.config,getState:()=>this.state,getPerformance:()=>this.getPerformanceMetrics(),reload:()=>window.location.reload(),clearCache:()=>{this.state.loadedResources.clear(),this.state.performance.metrics.clear()}},console.log("Now.js Dev Tools available at window.__NOW_DEV__"))},startPerformanceTracking(e="general"){if(!this.config.performance.monitoring)return;const t={start:performance.now(),end:null,duration:null};this.state.performance.metrics.set(e,t)},endPerformanceTracking(e="general"){if(!this.config.performance.monitoring)return;const t=this.state.performance.metrics.get(e);t&&(t.end=performance.now(),t.duration=t.end-t.start,this.recordPerformance(e,{duration:t.duration,start:t.start,end:t.end}))},recordPerformance(e,t){if(!this.config.performance.monitoring)return;const a={name:e,timestamp:Date.now(),...t};this.state.performance.metrics.set(`${e}_${Date.now()}`,a);const n=this.getManager("event");n&&n.emit("performance:recorded",a),this.config.performance.warnings&&this.checkPerformanceWarning(a)},checkPerformanceWarning(e){const t={"resource-load":2e3,initialization:5e3,"app-mount":1e3,"component-render":100,"app-creation":500}[e.name];if(t&&e.duration>t){const a=`Performance warning: ${e.name} took ${e.duration.toFixed(2)}ms (threshold: ${t}ms)`;this.config.debug&&console.warn(a);const n=this.getManager("notification");n&&this.config.devTools.enabled&&n.warning(a,{duration:3e3})}},getPerformanceMetrics(){const e={};return this.state.performance.metrics.forEach((t,a)=>{e[a]={duration:t.duration,timestamp:t.start||t.timestamp}}),e},inspect(){return{version:this.version,state:{initialized:this.state.initialized,loading:this.state.loading,error:this.state.error,resources:Array.from(this.state.loadedResources),performance:this.getPerformanceMetrics()},config:this.config,managers:Array.from(this.managers.keys()),plugins:Array.from(this.plugins.keys()),activeApp:this.state.activeApp?{name:this.state.activeApp.config.name,version:this.state.activeApp.config.version,plugins:Object.keys(this.state.activeApp.plugins||{})}:null}},logErrorMetrics(e,t={}){const a={timestamp:Date.now(),type:e.name,message:e.message,stack:e.stack,location:window.location.href,context:t};this.state.performance.metrics.set(`error_${Date.now()}`,a)},mergeConfig(e,t){const a={...e};for(const[n,s]of Object.entries(t))s&&"object"==typeof s&&!Array.isArray(s)?a[n]=this.mergeConfig(e[n]||{},s):a[n]=s;return a},getManager(e){return this.managers.get(e)||null},getPlugin(e){var t;return(null==(t=this.plugins.get(e))?void 0:t.instance)||null},async cleanup(){var e;for(const[a,n]of this.managers)if("function"==typeof n.cleanup)try{await n.cleanup()}catch(t){console.warn(`Failed to cleanup manager ${a}:`,t)}for(const[a,n]of this.plugins)if("function"==typeof(null==(e=n.instance)?void 0:e.cleanup))try{await n.instance.cleanup()}catch(t){console.warn(`Failed to cleanup plugin ${a}:`,t)}this.state.loadedResources.clear(),this.state.performance.metrics.clear(),this.state.activeApp=null,this.state.error=null},async reset(){await this.cleanup(),this.managers.clear(),this.plugins.clear(),this.state.initialized=!1,this.state.loading=!1,this.config={...this.DEFAULT_CONFIG}}};window.Now=P;const H={string:{random:(e=8)=>Array.from(crypto.getRandomValues(new Uint8Array(e))).map(e=>e.toString(16).padStart(2,"0")).join(""),escape:e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),sanitizeFilename:e=>e.replace(/[^a-z0-9.-]/gi,"_"),capitalize:e=>e.charAt(0).toUpperCase()+e.slice(1),humanize(e){const t=String(e),a=t.includes("_");let n=t.replace(/([a-z])([A-Z])/g,"$1 $2").replace(/[_-]+/g," ").replace(/\s+/g," ").trim();return a?(n=n.toLowerCase(),n.charAt(0).toUpperCase()+n.slice(1)):n.replace(/\b\w/g,e=>e.toUpperCase())},truncate:(e,t=100,a="...")=>e.length>t?e.substring(0,t-a.length)+a:e,slugify:e=>e.normalize("NFKD").toLowerCase().replace(/[^\w\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-+|-+$/g,""),stripTags(e){const t=document.createElement("div");return t.innerHTML=e,t.textContent||t.innerText||""},applyFormatters(e,t,a){return t.reduce((e,t)=>{var n;const[s,...r]=t.split(":");if(!s||""===s.trim()||!isNaN(s))return e;const i=(null==(n=a.filters)?void 0:n[s])||this.builtinFormatters[s];return"function"==typeof i?i(e,...r):(console.warn(`[Utils] Formatter "${s}" not found`),e)},e)},builtinFormatters:{number:(e,t=0)=>Number(e).toLocaleString(void 0,{minimumFractionDigits:parseInt(t),maximumFractionDigits:parseInt(t)}),currency:(e,t="USD")=>Number(e).toLocaleString(void 0,{style:"currency",currency:t}),percent:(e,t=0)=>(100*Number(e)).toFixed(t)+"%",lowercase:e=>String(e).toLowerCase(),uppercase:e=>String(e).toUpperCase(),capitalize:e=>{const t=String(e);return t.charAt(0).toUpperCase()+t.slice(1)},humanize:e=>H.string.humanize(e),date:(e,t="medium")=>new Date(e).toLocaleDateString(void 0,{dateStyle:t}),time:(e,t="medium")=>new Date(e).toLocaleTimeString(void 0,{timeStyle:t}),default:(e,t="")=>null==e?t:e}},number:{format:(e,t=0)=>Number(e).toLocaleString(void 0,{minimumFractionDigits:t,maximumFractionDigits:t}),currency:(e,t=null,a="en-US")=>t?new Intl.NumberFormat(a,{style:"currency",currency:t}).format(e):new Intl.NumberFormat(a,{minimumFractionDigits:2,maximumFractionDigits:2}).format(e),percentage:(e,t=0)=>(100*e).toFixed(t)+"%",fileSize(e){if(0===e)return"0 Byte";const t=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return Math.round(e/Math.pow(1024,t),2)+" "+["Bytes","KB","MB","GB","TB"][t]},round(e,t=2){const a=Math.pow(10,t);return Math.round(e*a)/a},ceil(e,t=2){const a=Math.pow(10,t);return Math.ceil(e*a)/a},floor(e,t=2){const a=Math.pow(10,t);return Math.floor(e*a)/a},truncate(e,t=2){const a=Math.pow(10,t);return Math.trunc(e*a)/a}},date:{format(e,t="YYYY-MM-DD",a=null){var n,s,r;const i=new Date(e);if(isNaN(i.getTime()))return"";if(!a){const e=(null==(s=null==(n=window.Now)?void 0:n.getManager)?void 0:s.call(n,"i18n"))||window.I18nManager;if((null==e?void 0:e.getCurrentLocale)?a=e.getCurrentLocale():(null==(r=window.LanguageManager)?void 0:r.getCurrentLanguage)&&(a=window.LanguageManager.getCurrentLanguage()),!a){a=(navigator.language||navigator.userLanguage||"en").startsWith("th")?"th":"en"}}const o=a.startsWith("th")&&!a.includes("-CE"),l=a.split("-")[0],c=i.getFullYear(),d=o?c+543:c,u=i.getMonth(),h="th"===l?["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"][u]:["January","February","March","April","May","June","July","August","September","October","November","December"][u],p="th"===l?["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."][u]:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][u],m={YYYY:d,YY:String(d).slice(-2),MMMM:h,MMM:p,MM:String(u+1).padStart(2,"0"),M:u+1,DD:String(i.getDate()).padStart(2,"0"),D:i.getDate(),HH:String(i.getHours()).padStart(2,"0"),H:i.getHours(),hh:String(i.getHours()%12||12).padStart(2,"0"),h:i.getHours()%12||12,mm:String(i.getMinutes()).padStart(2,"0"),ss:String(i.getSeconds()).padStart(2,"0"),A:i.getHours()<12?"AM":"PM",a:i.getHours()<12?"am":"pm"};return t.replace(/YYYY|YY|MMMM|MMM|MM|M|DD|D|HH|H|hh|h|mm|ss|A|a/g,e=>m[e])},fromTimestamp:e=>new Date(1e3*e),toTimestamp:e=>Math.floor(new Date(e).getTime()/1e3),add(e,t,a){const n=new Date(e);switch(a){case"years":n.setFullYear(n.getFullYear()+t);break;case"months":n.setMonth(n.getMonth()+t);break;case"days":n.setDate(n.getDate()+t);break;case"hours":n.setHours(n.getHours()+t);break;case"minutes":n.setMinutes(n.getMinutes()+t);break;case"seconds":n.setSeconds(n.getSeconds()+t)}return n},moveDate(e,t){const a=new Date(e);return a.setDate(a.getDate()+t),a},moveMonth(e,t){const a=new Date(e);return a.setMonth(a.getMonth()+t),a},moveYear(e,t){const a=new Date(e);return a.setFullYear(a.getFullYear()+t),a},timeToMinute(e){const[t,a]=e.split(":").map(Number);return 60*t+a},timeToSecond(e){const[t,a,n]=e.split(":").map(Number);return 3600*t+60*a+(n||0)},isLeapYear:e=>e%4==0&&e%100!=0||e%400==0,daysInMonth:(e,t)=>new Date(e,t,0).getDate(),compare(e,t){const a=new Date(e),n=new Date(t),s=a.getTime()-n.getTime();return{days:Math.floor(s/864e5),months:a.getMonth()-n.getMonth()+12*(a.getFullYear()-n.getFullYear()),years:a.getFullYear()-n.getFullYear()}},getLocale(e=null){var t,a;if(e)return e;const n=(null==(a=null==(t=window.Now)?void 0:t.getManager)?void 0:a.call(t,"i18n"))||window.I18nManager;if(null==n?void 0:n.getCurrentLocale)return n.getCurrentLocale();return(navigator.language||navigator.userLanguage||"en").split("-")[0]},getMonthNames(e=null){return"th"===this.getLocale(e).split("-")[0]?["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"]:["January","February","March","April","May","June","July","August","September","October","November","December"]},getMonthNamesShort(e=null){return"th"===this.getLocale(e).split("-")[0]?["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."]:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]},getDayNames(e=null){return"th"===this.getLocale(e).split("-")[0]?["อา","จ","อ","พ","พฤ","ศ","ส"]:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"]},getDayNamesNarrow(e=null){return"th"===this.getLocale(e).split("-")[0]?["อ","จ","อ","พ","พ","ศ","ส"]:["S","M","T","W","T","F","S"]}},object:{deepClone(e){if(null===e||"object"!=typeof e)return e;if(Array.isArray(e))return e.map(e=>this.deepClone(e));const t={};for(let a in e)t[a]=this.deepClone(e[a]);return t},merge(e,...t){if(!t.length)return e;const a=t.shift();if(this.isObject(e)&&this.isObject(a))for(const n in a)this.isObject(a[n])?(e[n]||Object.assign(e,{[n]:{}}),this.merge(e[n],a[n])):Object.assign(e,{[n]:a[n]});return this.merge(e,...t)},isObject:e=>e&&"object"==typeof e&&!Array.isArray(e),get(e,t,a=null){if(!e||!t)return console.warn("[Utils.object.get] Invalid parameters"),a;const travel=a=>String.prototype.split.call(t,a).filter(Boolean).reduce((e,t)=>null!=e?e[t]:e,e),n=travel(/[,[\]]+?/)||travel(/[,[\].]+?/);return void 0===n||n===e?a:n}},array:{chunk(e,t){if(!Array.isArray(e))throw new Error("[Utils.array.chunk] Input must be an array");if("number"!=typeof t||t<=0)throw new Error("[Utils.array.chunk] Size must be a positive number");return Array.from({length:Math.ceil(e.length/t)},(a,n)=>e.slice(n*t,n*t+t))},unique(e,t=null){if(!Array.isArray(e))throw new Error("[Utils.array.unique] Input must be an array");if(!t)return[...new Set(e)];const a=new Set;return e.filter(e=>{const n=t?e[t]:e;return!a.has(n)&&a.add(n)})},shuffle(e){if(!Array.isArray(e))throw new Error("[Utils.array.shuffle] Input must be an array");const t=[...e];for(let a=t.length-1;a>0;a--){const e=Math.floor(Math.random()*(a+1));[t[a],t[e]]=[t[e],t[a]]}return t},groupBy:(e,t)=>e.reduce((e,a)=>({...e,[a[t]]:[...e[a[t]]||[],a]}),{}),flatten(e,t=1){if(!Array.isArray(e))throw new Error("[Utils.array.flatten] Input must be an array");return e.reduce((e,a)=>e.concat(t>0&&Array.isArray(a)?this.flatten(a,t-1):a),[])},findBy(e,t,a){if(!Array.isArray(e))throw new Error("[Utils.array.findBy] Input must be an array");return e.find(e=>e[t]===a)}},validate:{email:e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),url(e){try{return new URL(e),!0}catch{return!1}},phone(e){if("string"!=typeof e)return!1;const t=e.replace(/[^\d]/g,"");return!(t.length<9||t.length>15)&&/^\+?[\d\s().-]{10,}$/.test(e)},password(e){let t=0;return e.length>=8&&t++,/[A-Z]/.test(e)&&/[a-z]/.test(e)&&t++,/[0-9]/.test(e)&&t++,/[^A-Za-z0-9]/.test(e)&&t++,{score:t,label:{0:"Too weak",1:"Weak",2:"Medium",3:"Strong"}[t],isStrong:t>=3}}},dom:{create(e,t={},a=[]){const n=document.createElement(e);return Object.entries(t).forEach(([e,t])=>{"className"===e?n.className=t:"dataset"===e?Object.entries(t).forEach(([e,t])=>{n.dataset[e]=t}):n.setAttribute(e,t)}),a.forEach(e=>{"string"==typeof e?n.appendChild(document.createTextNode(e)):n.appendChild(e)}),n},toggleClass(e,...t){t.forEach(t=>e.classList.toggle(t))},closest:(e,t)=>e.closest(t),isVisible:e=>!!(e.offsetWidth||e.offsetHeight||e.getClientRects().length),async copyToClipboard(e){if("string"!=typeof e)return console.error("[Utils.dom.copyToClipboard] Text must be a string"),!1;if(navigator.clipboard&&window.isSecureContext)try{return await navigator.clipboard.writeText(e),!0}catch(t){console.warn("[Utils.dom.copyToClipboard] Clipboard API failed, trying fallback:",t)}try{const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-999999px",t.style.top="-999999px",t.setAttribute("aria-hidden","true"),document.body.appendChild(t),t.focus(),t.select();const a=document.execCommand("copy");return document.body.removeChild(t),!!a||(console.error("[Utils.dom.copyToClipboard] Fallback method failed"),!1)}catch(t){return console.error("[Utils.dom.copyToClipboard] Failed to copy text:",t),!1}}},browser:{info(){const e=navigator.userAgent;let t,a=e.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];return/trident/i.test(a[1])?(t=/\brv[ :]+(\d+)/g.exec(e)||[],{name:"IE",version:t[1]||""}):"Chrome"===a[1]&&(t=e.match(/\bOPR|Edge\/(\d+)/),null!=t)?{name:"Opera",version:t[1]}:(a=a[2]?[a[1],a[2]]:[navigator.appName,navigator.appVersion,"-?"],null!=(t=e.match(/version\/(\d+)/i))&&a.splice(1,1,t[1]),{name:a[0],version:a[1]})},isMobile:()=>/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),orientation:()=>window.innerHeight>window.innerWidth?"portrait":"landscape"},session:{set(e,t,a=null){const n={value:t,timestamp:(new Date).getTime()};a&&(n.expires=n.timestamp+1e3*a);try{sessionStorage.setItem(e,JSON.stringify(n))}catch(s){console.error(`[Utils.session.set] Error setting key ${e}:`,s)}},get(e,t=null){try{const a=sessionStorage.getItem(e);if(!a)return t;const n=JSON.parse(a);return n.expires&&(new Date).getTime()>n.expires?(this.remove(e),t):n.value}catch(a){return console.error(`[Utils.session.get] Error getting key ${e}:`,a),t}},remove(e){try{sessionStorage.removeItem(e)}catch(t){console.error(`[Utils.session.remove] Error removing key ${e}:`,t)}},clear(){try{sessionStorage.clear()}catch(e){console.error("[Utils.session.clear] Error clearing session:",e)}},has:e=>null!==sessionStorage.getItem(e),size:()=>sessionStorage.length,keys:()=>Object.keys(sessionStorage)},generateUUID:()=>crypto&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)}),function:{debounce(e,t=300){let a;return function executedFunction(...n){clearTimeout(a),a=setTimeout(()=>{clearTimeout(a),e(...n)},t)}},throttle(e,t=300){let a;return function executedFunction(...n){a||(e(...n),a=!0,setTimeout(()=>a=!1,t))}},debounceAsync(e,t=300){let a;return function executedFunction(...n){return new Promise(s=>{clearTimeout(a),a=setTimeout(async()=>{clearTimeout(a);try{const t=await e(...n);s(t)}catch(t){s(Promise.reject(t))}},t)})}}},cookie:{set:function(e,t,a={}){if("string"!=typeof e||"string"!=typeof t)throw new Error("[Utils.cookie.set] Name and value must be strings");const n={days:7,path:"/",domain:"",secure:!0,sameSite:"Strict",...a};let s=`${encodeURIComponent(e)}=${encodeURIComponent(t)}`;if("number"==typeof n.days&&0!==n.days){const e=new Date;e.setTime(e.getTime()+24*n.days*60*60*1e3),s+=`;expires=${e.toUTCString()}`}n.path&&(s+=`;path=${n.path}`),n.domain&&(s+=`;domain=${n.domain}`),n.secure&&(s+=";secure"),n.sameSite&&(s+=`;samesite=${n.sameSite}`);try{document.cookie=s}catch(r){console.error(`[Utils.cookie.set] Failed to set cookie ${e}:`,r)}},get:function(e){if("string"!=typeof e)throw new Error("[Utils.cookie.get] Name must be a string");const t=e.replace(/([.*+?^${}()|[\]\\])/g,"\\$1"),a=new RegExp(`(?:^|;)\\s*${t}=([^;]*)`),n=document.cookie.match(a);return n?decodeURIComponent(n[1]):null},remove:function(e,t={}){if("string"!=typeof e)throw new Error("[Utils.cookie.remove] Name must be a string");const a={days:-1,path:t.path||"/",domain:t.domain||""};this.set(e,"",a)},isEnabled(){try{document.cookie="cookietest=1";const e=-1!==document.cookie.indexOf("cookietest=");return document.cookie="cookietest=1; expires=Thu, 01-Jan-1970 00:00:01 GMT",e}catch(e){return!1}}},url:{getQueryParams(e){const t={};return new URL(e).searchParams.forEach((e,a)=>{t[a]=e}),t},addQueryParams(e,t){const a=new URL(e);return Object.entries(t).forEach(([e,t])=>{a.searchParams.append(e,t)}),a.toString()}},path:{join:(...e)=>e.map(e=>e.replace(/^\/+|\/+$/g,"")).filter(e=>e.length>0).join("/"),normalize:e=>e.replace(/\/+/g,"/"),basename:e=>e.split("/").pop(),dirname:e=>e.split("/").slice(0,-1).join("/"),extname(e){const t=this.basename(e),a=t.lastIndexOf(".");return-1===a?"":t.slice(a)}},keyboard:{isKey:(e,t,a={})=>e.key===t&&((void 0===a.shift||e.shiftKey===a.shift)&&((void 0===a.ctrl||e.ctrlKey===a.ctrl)&&((void 0===a.alt||e.altKey===a.alt)&&(void 0===a.meta||e.metaKey===a.meta)))),isEnter:e=>"Enter"===e.key,isShiftEnter:e=>"Enter"===e.key&&e.shiftKey,isCtrlEnter:e=>"Enter"===e.key&&e.ctrlKey,isEscape:e=>"Escape"===e.key,isTab:e=>"Tab"===e.key,isShiftTab:e=>"Tab"===e.key&&e.shiftKey,isArrow:e=>["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)}};window.Utils=H;const q={config:{position:"top-right",duration:3e3,maxVisible:5,animation:!0,dismissible:!0,rtl:"rtl"===document.dir,progressBar:!1,pauseOnHover:!1,closeButton:!0,icons:!0,aria:!0},state:{notifications:new Set,queue:[],isProcessing:!1,container:null,initialized:!1},async init(e={}){return this.state.initialized||(this.config={...this.config,...e},this.createContainer(),this.setupEventListeners(),this.state.initialized=!0),this},createContainer(){const e=document.createElement("div");e.className=`notification-container notification-${this.config.position}`,this.config.rtl&&e.setAttribute("dir","rtl"),this.config.aria&&(e.setAttribute("role","alert"),e.setAttribute("aria-live","polite")),document.body.appendChild(e),this.state.container=e},setPosition(e){const t=["top-right","top-left","bottom-right","bottom-left"];t.includes(e)?(this.config.position=e,this.state.container?(t.forEach(e=>{this.state.container.classList.remove(`notification-${e}`)}),this.state.container.classList.add(`notification-${e}`)):this.createContainer()):console.warn(`Invalid position: ${e}. Valid positions are: ${t.join(", ")}`)},show(e={}){this.state.initialized&&this.state.container||(this.state.initialized=!1,this.init());const t=this.createNotification(e);if(t.type&&"loading"!==t.type){const e=Array.from(this.state.notifications).filter(e=>e.type===t.type);e.length>0&&e.forEach(e=>{this.dismiss(e.id)})}return this.state.notifications.size>=this.config.maxVisible?(this.state.queue.push(t),t.id):(this.renderNotification(t),t.id)},createNotification(e){var t;return"string"==typeof e&&(e={message:e}),e.message&&(null==(t=window.I18nManager)?void 0:t.translate)&&(e.message=I18nManager.translate(e.message)),{id:Utils.generateUUID(),type:"info",duration:this.config.duration,dismissible:this.config.dismissible,animation:this.config.animation,progressBar:this.config.progressBar,timestamp:Date.now(),...e}},renderNotification(e){const t=document.createElement("div");t.className=`notification notification-${e.type}`,t.id=e.id;const a=document.createElement("div");a.className="notification-content";const n=document.createElement("div");let s="notification-message";if(this.config.icons&&e.icon&&(s+=` icon-${e.icon}`),n.className=s,n.textContent=e.message,a.appendChild(n),e.dismissible&&this.config.closeButton){const t=document.createElement("button");t.className="btn-close",t.onclick=()=>this.dismiss(e.id),a.appendChild(t)}t.appendChild(a),e.progressBar&&e.duration>0&&this.addProgressBar(t,e),this.state.container||this.createContainer(),this.state.container.appendChild(t),this.state.notifications.add(e),requestAnimationFrame(()=>{t.classList.add("notification-show")}),e.duration>0&&this.setupAutoDismiss(e)},addProgressBar(e,t){const a=document.createElement("div");a.className="notification-progress";const n=document.createElement("div");n.className="notification-progress-bar",a.appendChild(n),e.appendChild(a),t.progressBar={element:n,startTime:Date.now(),duration:t.duration,paused:!1},requestAnimationFrame(()=>{n.style.width="0%",n.style.transition=`width ${t.duration}ms linear`})},setupAutoDismiss(e){let t=e.duration,a=Date.now();const checkDismiss=()=>{var n;if(null==(n=e.progressBar)?void 0:n.paused)return a=Date.now(),void requestAnimationFrame(checkDismiss);const s=Date.now();t-=s-a,a=s,t<=0?this.dismiss(e.id):requestAnimationFrame(checkDismiss)};requestAnimationFrame(checkDismiss)},dismiss(e){const t=Array.from(this.state.notifications).find(t=>t.id===e);if(!t)return;const a=document.getElementById(e);if(!a)return;a.classList.remove("notification-show"),a.classList.add("notification-hide");let n=!1;const cleanUp=()=>{if(!n){n=!0;try{a.remove()}catch(e){}this.state.notifications.delete(t),this.processQueue()}};a.addEventListener("transitionend",()=>{cleanUp()},{once:!0}),window.setTimeout(()=>cleanUp(),3e3)},processQueue(){if(this.state.isProcessing||0===this.state.queue.length)return;this.state.isProcessing=!0;const e=this.state.queue.shift();this.renderNotification(e),this.state.isProcessing=!1,this.state.queue.length>0&&this.processQueue()},setupEventListeners(){this.config.pauseOnHover&&(this.state.container.addEventListener("mouseenter",e=>{const t=e.target.closest(".notification");if(t){const e=t.id,a=Array.from(this.state.notifications).find(t=>t.id===e);(null==a?void 0:a.progressBar)&&(a.progressBar.paused=!0)}}),this.state.container.addEventListener("mouseleave",e=>{const t=e.target.closest(".notification");if(t){const e=t.id,a=Array.from(this.state.notifications).find(t=>t.id===e);(null==a?void 0:a.progressBar)&&(a.progressBar.paused=!1)}})),window.addEventListener("beforeunload",()=>{this.destroy()})},success(e,t={}){return this.show({type:"success",message:e,icon:"valid",...t})},error(e,t={}){return this.show({type:"error",message:e,icon:"ban",duration:8e3,...t})},warning(e,t={}){return this.show({type:"warning",message:e,icon:"warning",duration:8e3,...t})},info(e,t={}){return this.show({type:"info",message:e,icon:"info",...t})},loading(e,t={}){return this.show({type:"loading",message:e,icon:"loader",duration:0,dismissible:!1,progressBar:!1,...t})},clear(){Array.from(this.state.notifications).forEach(e=>{this.dismiss(e.id)}),this.state.queue=[]},destroy(){this.clear(),this.state.container&&(this.state.container.remove(),this.state.container=null),this.state.initialized=!1}};(null==(e=window.Now)?void 0:e.registerManager)&&Now.registerManager("notification",q),window.NotificationManager=q;const B={config:{debug:!0,notificationDuration:5e3},lastError:null,init(e={}){return this.config={...this.config,...e},this},createError:(e,t)=>(Array.isArray(t)||(t=[]),t.forEach((t,a)=>{null!=t&&(e=e.replace(`{${a}}`,t.toString()))}),new Error(e)),normalizeError(e){return"string"==typeof e?this.createError(e):e},handle(e,t={}){if(!e)throw new Error("Error parameter is required");let a;"string"==typeof t&&(t={context:t}),e instanceof Error?a=e:t.error&&t.error instanceof Error?(a=t.error,a.message=e.toString()):a=new Error(e.toString()),this.lastError=a;const{context:n="",notify:s=!1,logLevel:r="error",data:i=[]}=t,o=a.message;if((this.config.debug||t.debug)&&(this.config.debug?console[r](a.stack,{message:o,context:n,...i}):console[r](`[${n}] ${o}`)),s&&"undefined"!=typeof window&&window.NotificationManager){const e=NotificationManager[r]?r:"error";NotificationManager[e](o,{duration:this.config.notificationDuration})}return t.type&&EventManager.emit(t.type,{message:o,context:n,data:i}),a}};(null==(t=window.Now)?void 0:t.registerManager)&&Now.registerManager("error",B),window.ErrorManager=B;class ErrorRenderer{static renderError(e,t={}){const a={containerId:"main",title:"Application Error",message:"The application failed to initialize. Please try again later.",showStack:!1,showDetails:!0,actions:null,...t},n=document.getElementById(a.containerId);if(!n)return void console.error(`Container element #${a.containerId} not found`);const s=this.generateErrorHtml(e,a);n.innerHTML=s,this.attachEventListeners(n,a)}static generateErrorHtml(e,t){const a=(null==e?void 0:e.message)||"Unknown error occurred",n=(null==e?void 0:e.stack)||"";let s="";return t.showStack&&n&&(s='<div class="error-details-toggle">\n                  <button type="button" class="error-toggle-btn" data-action="toggle-details">\n                    <span class="toggle-text">Show Details</span>\n                    <svg class="toggle-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                      <polyline points="6 9 12 15 18 9"></polyline>\n                    </svg>\n                  </button>\n                </div>'),`\n      <div class="error-container">\n        <div class="error-card">\n          <div class="error-icon">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="64" height="64">\n              <circle cx="12" cy="12" r="10" fill="#fee2e2" />\n              <path d="M12 8v5" stroke="#ef4444" stroke-width="2" stroke-linecap="round" />\n              <circle cx="12" cy="16" r="1" fill="#ef4444" />\n            </svg>\n          </div>\n          <h1 class="error-title">${t.title}</h1>\n          <p class="error-message">${t.message}</p>\n          <div class="error-details">\n            <div class="error-code-heading"><div>Error Message:</div>${s}</div>\n            <pre class="error-code">${this.escapeHtml(a)}</pre>\n            <div class="error-details-content" style="display: none;">\n              ${t.showStack&&n?`\n                <div class="error-code-heading">Stack Trace:</div>\n                <pre class="error-code">${this.escapeHtml(n)}</pre>\n              `:""}\n            </div>\n          </div>\n          <div class="error-help">\n            If the problem persists, please contact your system administrator or try clearing your browser cache.\n          </div>\n        </div>\n      </div>`}static attachEventListeners(e,t){const a=e.querySelector('[data-action="toggle-details"]');a&&a.addEventListener("click",()=>{const t=e.querySelector(".error-details-content"),n=a.querySelector(".toggle-icon"),s=a.querySelector(".toggle-text");"none"===t.style.display?(t.style.display="block",s.textContent="Hide Details",n.style.transform="rotate(180deg)"):(t.style.display="none",s.textContent="Show Details",n.style.transform="rotate(0deg)")});const n=e.querySelector('[data-action="reload"]');n&&n.addEventListener("click",()=>window.location.reload());const s=e.querySelector('[data-action="home"]');s&&s.addEventListener("click",()=>window.location.href="/");e.querySelectorAll('[data-action]:not([data-action="reload"]):not([data-action="home"]):not([data-action="toggle-details"])').forEach(e=>{const a=e.dataset.action;t.customHandlers&&t.customHandlers[a]&&e.addEventListener("click",t.customHandlers[a])})}static escapeHtml(e){return"string"!=typeof e?"":e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}static render404(e={}){return this.renderError(new Error("Page not found"),{title:"404 - Page Not Found",message:"The page you're looking for doesn't exist.",showDetails:!1,...e})}static renderNetworkError(e={}){return this.renderError(new Error("Network connection failed"),{title:"Connection Error",message:"Unable to connect to the server. Please check your internet connection.",actions:[{text:"Try Again",type:"primary",action:"retry"},{text:"Go Home",type:"secondary",action:"home"}],customHandlers:{retry:()=>window.location.reload()},...e})}static renderAuthError(e={}){return this.renderError(new Error("Authentication failed"),{title:"Authentication Required",message:"You need to log in to access this page.",showDetails:!1,actions:[{text:"Go to Login",type:"primary",action:"login"}],customHandlers:{login:()=>window.location.href="/login"},...e})}}"undefined"!=typeof module&&module.exports&&(module.exports=ErrorRenderer),window.ErrorRenderer=ErrorRenderer;const z={config:{enabled:!1,defaultLocale:"en",availableLocales:["en"],storageKey:"app_lang",useBrowserLocale:!0,noTranslateEnglish:!0},state:{current:null,initialized:!1,translations:new Map},async init(e={}){return this.config={...this.config,...e},this.config.enabled?(await this.loadInitialLocale(),this.state.initialized=!0,EventManager.emit("i18n:initialized"),this):(this.state.disabled=!0,this)},async setLocale(e,t=!1){try{if(!this.config.enabled)return;if(!this.config.availableLocales.includes(e))throw new Error(`Unsupported locale: ${e}`);if(e===this.state.current&&!t)return;if(!(this.config.noTranslateEnglish&&"en"===e||this.state.translations.has(e)))try{await this.loadTranslations(e)}catch(a){}this.state.current=e,document.documentElement.setAttribute("lang",e),this.setStoredLocale(e),window.setTimeout(()=>{this.updateTranslations()},100),EventManager.emit("locale:changed",{locale:e,forced:t})}catch(a){ErrorManager.handle(a,{context:"I18nManager.setLocale",type:"error:i18n",data:{locale:e,force:t},notify:!0})}},getCurrentLocale(){return this.state.current},async loadTranslations(e,t=2){const a=`${Now.resolvePath(e,"translations")}.json`;for(let s=0;s<=t;s++)try{const t=await fetch(a,{method:"GET",headers:{Accept:"application/json","Cache-Control":"no-cache"},credentials:"same-origin"});if(!t.ok){if(404===t.status)return console.warn(`Translation file not found for locale: ${e}`),void EventManager.emit("i18n:loaded",{locale:e,success:!1,reason:"404"});throw new Error(`HTTP ${t.status}: ${t.statusText}`)}const n=await t.json();if(!n||"object"!=typeof n)throw new Error("Invalid translation format: expected object");return this.state.translations.set(e,n),void EventManager.emit("i18n:loaded",{locale:e,success:!0,translationCount:Object.keys(n).length})}catch(n){const r=s===t;if("SyntaxError"===n.name||n.message.includes("404"))throw n;if(r)throw ErrorManager.handle(n,{context:"I18nManager.loadTranslations",type:"error:i18n",data:{locale:e,url:a,attempts:s+1,errorType:n.name,errorMessage:n.message},notify:!0}),new Error(`Failed to load translations for ${e} after ${s+1} attempts: ${n.message}`);const i=Math.min(1e3*Math.pow(2,s),3e3);console.warn(`Translation load failed (attempt ${s+1}/${t+1}), retrying in ${i}ms...`,n),await new Promise(e=>setTimeout(e,i))}},updateTranslations(){const e=this.state.translations.get(this.state.current),t=document.querySelectorAll("[data-i18n]");t.forEach(t=>{var a;const n=null==(a=t.getAttribute("data-i18n"))?void 0:a.trim(),s=n?n.trim():t.textContent.trim();if(!s)return;let r;e?(r=this.getTranslation(s,e),r&&r!==s||(r=this.interpolate(s,{},e))):r=this.interpolate(s,{},{}),t.textContent=r,n||t.setAttribute("data-i18n",s)}),this.translateAttributes(),EventManager.emit("i18n:updated",{locale:this.state.current,elementsUpdated:t.length})},translateAttributes(){this.translateAttributesIn(document)},getTranslation(e,t,a={}){let n;return n=e.includes(" ")?t[e]:e.split(".").reduce((e,t)=>null==e?void 0:e[t],t),n||(n=e),this.interpolate(n,a,t)},async loadInitialLocale(){let e=this.config.defaultLocale;const t=document.documentElement.getAttribute("lang");if(t&&this.config.availableLocales.includes(t))e=t;else{const t=this.getStoredLocale();if(t&&this.config.availableLocales.includes(t))e=t;else if(this.config.useBrowserLocale){const t=navigator.language.split("-")[0];this.config.availableLocales.includes(t)&&(e=t)}}await this.setLocale(e)},async updateElements(e=document){if(!this.config.enabled||!this.state.initialized)return;const t=this.state.translations.get(this.state.current),a=e.querySelectorAll("[data-i18n]");a.forEach(e=>{var a;const n=null==(a=e.getAttribute("data-i18n"))?void 0:a.trim(),s=n?n.trim():e.textContent.trim();if(!s)return;let r;t?(r=this.getTranslation(s,t),r&&r!==s||(r=this.interpolate(s,{},t))):r=this.interpolate(s,{},{}),e.textContent=r,n||e.setAttribute("data-i18n",s)}),this.translateAttributesIn(e),EventManager.emit("i18n:elements:updated",{container:e,elementsUpdated:a.length,locale:this.state.current})},translateAttributesIn(e){const t=this.state.translations.get(this.state.current)||{},a=/\{LNG_[^}]+\}/,n=["placeholder","title","alt","aria-label","aria-placeholder","label"],s=n.map(e=>`[${e}]`).join(", ");e.querySelectorAll(s).forEach(e=>{n.forEach(n=>{const s=e.getAttribute(n);s&&a.test(s)&&e.setAttribute(n,this.interpolate(s,{},t))})})},translate(e,t={},a=null){if("string"!=typeof e)return e;const n=a||this.getCurrentLocale();if("en"===n&&this.config.noTranslateEnglish)return e;const s=this.state.translations.get(n);return s?this.getTranslation(e,s,t):this.getFallbackTranslation(e,t)},getFallbackTranslation(e,t){if(!t||0===Object.keys(t).length)return e;if(this.state.current!==this.config.defaultLocale){const a=this.state.translations.get(this.config.defaultLocale);if(a){const n=e.includes(" ")?a[e]:e.split(".").reduce((e,t)=>null==e?void 0:e[t],a);if(n)return this.interpolate(n,t)}}return this.interpolate(e,t)},interpolate(e,t,a){const n=a||this.getTranslations();let s=e.replace(/\{LNG_([^}]+)\}/g,(e,t)=>n[t]??t);return s=s.replace(/\{([^}]+)\}/g,(e,a)=>void 0!==t[a]?t[a]:n[a]?n[a]:a),s},getTranslator(e){return(t,a={})=>this.translate(t,a,e)},getTranslations(e=null){const t=e||this.getCurrentLocale();return this.state.translations.get(t)||{}},getKeyTranslations(e){const t={};return this.state.translations.forEach((a,n)=>{const s=e.includes(" ")?a[e]:e.split(".").reduce((e,t)=>null==e?void 0:e[t],a);s&&(t[n]=s)}),t},hasTranslation(e,t=null){const a=this.getTranslations(t);return e.includes(" ")?void 0!==a[e]:void 0!==e.split(".").reduce((e,t)=>null==e?void 0:e[t],a)}};(null==(a=window.Now)?void 0:a.registerManager)&&Now.registerManager("i18n",z),window.I18nManager=z,z.getStoredLocale=function(){if(!this.config.storageKey)return null;try{return localStorage.getItem(this.config.storageKey)}catch(e){return console.warn("I18nManager: Unable to read from localStorage",e),null}},z.setStoredLocale=function(e){if(this.config.storageKey)try{localStorage.setItem(this.config.storageKey,e)}catch(t){console.warn("I18nManager: Unable to write to localStorage",t)}},(()=>{const registerLangToggle=()=>{if(z._langToggleRegistered)return!0;const e=(Now.getManager?Now.getManager("component"):null)||window.ComponentManager;return!(!e||"function"!=typeof e.define)&&(e.define("lang-toggle",{mounted(){const e=this.element,t=Now.getManager?Now.getManager("i18n"):null,a=t&&t.config&&Array.isArray(t.config.availableLocales)?t.config.availableLocales:["en"];let n=(e.getAttribute("data-locales")||a.join(",")).trim().split(",").map(e=>e.trim()).filter(Boolean);const s=e.getAttribute("data-theme-map")||"",r={};s.split(",").map(e=>e.trim()).forEach(e=>{if(!e)return;const[t,a]=e.split(":").map(e=>e.trim());t&&a&&(r[t]=a)});const i=e.querySelector("[data-lang-label]")||e.querySelector("span"),o=e.querySelector("ul"),l=o?Array.from(o.querySelectorAll("a")):[],c=l.map(e=>(e.getAttribute("data-locale")||e.textContent||"").trim()).filter(Boolean);c.length&&(n=c);const updateLabel=()=>{try{const a=t&&"function"==typeof t.getCurrentLocale?t.getCurrentLocale():document.documentElement.lang||n[0],s=(a||n[0]||"").toUpperCase();i?(i.textContent=s,i.setAttribute("aria-label",`Language: ${a}`)):e.setAttribute("data-lang",s),l.forEach(e=>{(e.getAttribute("data-locale")||e.textContent||"").trim()===a?(e.classList.add("active"),e.setAttribute("aria-current","true")):(e.classList.remove("active"),e.removeAttribute("aria-current"))})}catch(a){}},clickHandler=e=>{const a=e.target.closest("a");if(a){e.preventDefault();const n=(a.getAttribute("data-locale")||a.textContent||"").trim();if(t&&"function"==typeof t.setLocale&&n){t.setLocale(n);try{const e=Now.getManager?Now.getManager("theme"):null;e&&"function"==typeof e.setTheme&&r[n]&&e.setTheme(r[n])}catch(l){}}return}if(!t||"function"!=typeof t.setLocale)return;const s=t.getCurrentLocale()||n[0],i=n.indexOf(s),o=n[(i+1)%n.length]||n[0];t.setLocale(o);try{const e=Now.getManager?Now.getManager("theme"):null;e&&"function"==typeof e.setTheme&&r[o]&&e.setTheme(r[o])}catch(l){}};e.__langToggleClick=clickHandler,e.addEventListener("click",clickHandler),e.__langToggleUpdate=updateLabel;try{EventManager.on("locale:changed",updateLabel)}catch(d){}updateLabel()},destroyed(){const e=this.element;try{e.__langToggleClick&&e.removeEventListener("click",e.__langToggleClick)}catch(t){}try{e.__langToggleUpdate&&EventManager.off&&EventManager.off("locale:changed",e.__langToggleUpdate)}catch(t){}}}),z._langToggleRegistered=!0,!0)};registerLangToggle()||("loading"===document.readyState?document.addEventListener("DOMContentLoaded",registerLangToggle,{once:!0}):setTimeout(registerLangToggle,0))})();const $={config:{baseZIndex:990,animation:!0,duration:200,className:"backdrop",background:"rgba(0,0,0,0.5)",opacity:.5,useTransition:!0,preventScroll:!0,debug:!1},state:{backdrops:new Map,activeBackdrops:[],nextId:1,isInitialized:!1},async init(e={}){return this.state.isInitialized||(this.config={...this.config,...e},this.handleKeydown=this.handleKeydown.bind(this),document.addEventListener("keydown",this.handleKeydown),this.state.isInitialized=!0),this},createBackdropElement(e,t){const a=document.createElement("div");a.className=`${this.config.className} ${t.className||""}`.trim(),a.setAttribute("aria-hidden","true"),a.setAttribute("role","presentation");const n={position:"fixed",top:0,left:0,width:"100vw",height:"100vh",background:t.background||this.config.background,opacity:0,pointerEvents:"auto",zIndex:t.zIndex||this.config.baseZIndex};return this.config.useTransition&&(n.transition=`opacity ${this.config.duration}ms`),Object.assign(a.style,n),(null==e?void 0:e.parentNode)?e.parentNode.insertBefore(a,e):document.body.appendChild(a),a},show(e,t=null,a={}){try{const n=this.state.nextId++,s={...this.config,...a,zIndex:this.config.baseZIndex+10*this.state.activeBackdrops.length},r={id:n,element:this.createBackdropElement(e,s),targetElement:e,onClick:t,options:s};return t&&r.element.addEventListener("click",t),this.state.backdrops.set(n,r),this.state.activeBackdrops.push(n),s.preventScroll&&(document.body.style.overflow="hidden"),requestAnimationFrame(()=>{r.element.style.opacity=s.opacity}),n}catch(n){return console.error("Error showing backdrop:",n),null}},hide(e){try{const t=this.state.backdrops.get(e);if(!t)return;t.element.style.opacity=0;const cleanup=()=>{t.onClick&&t.element.removeEventListener("click",t.onClick),t.element.remove(),this.state.backdrops.delete(e);const a=this.state.activeBackdrops.indexOf(e);a>-1&&this.state.activeBackdrops.splice(a,1),0===this.state.activeBackdrops.length&&(document.body.style.overflow="")};this.config.useTransition?setTimeout(cleanup,this.config.duration):cleanup()}catch(t){console.error("Error hiding backdrop:",t)}},update(e,t={}){const a=this.state.backdrops.get(e);if(!a)return;const n=a.element,s={...a.options,...t};n.style.background=s.background,n.style.opacity=-1!==this.state.activeBackdrops.indexOf(a)?s.opacity:"0",n.style.zIndex=s.zIndex,a.options=s},hideAll(){[...this.state.activeBackdrops].forEach(e=>this.hide(e))},handleKeydown(e){if("Escape"===e.key&&this.state.activeBackdrops.length>0){const e=this.state.activeBackdrops[this.state.activeBackdrops.length-1];this.hide(e)}},getBackdropById(e){for(const t of this.state.backdrops.values())if(t.id===e)return t.element;return null},isActive(e){const t=this.state.backdrops.get(e);return t&&this.state.activeBackdrops.includes(t)},destroy(){this.hideAll(),document.removeEventListener("keydown",this.handleKeydown),this.state.isInitialized=!1}};(null==(n=window.Now)?void 0:n.registerManager)&&Now.registerManager("backdrop",$),window.BackdropManager=$;let j=class Modal{constructor(e={}){this.options={id:null,title:"",content:"",width:"auto",maxWidth:"90%",height:"auto",maxHeight:"90vh",closeButton:!0,animation:!0,backdrop:!0,keyboard:!0,focus:!0,className:"",onShow:null,onShown:null,onHide:null,onHidden:null,backdropOpacity:.5,backdropColor:"rgba(0,0,0,0.5)",...e},this.id=this.options.id||"modal_"+Math.random().toString(36).substr(2,9),this.backdropId=null,this.visible=!1,this.boundData={},this.createModal(),this.bindEvents()}createModal(){this.modal=document.createElement("div"),this.modal.id=this.id,this.modal.className=`modal ${this.options.className}`.trim(),this.modal.setAttribute("role","dialog"),this.modal.setAttribute("aria-modal","true"),this.modal.setAttribute("aria-hidden","true"),this.modal.inert=!0,this.dialog=document.createElement("div"),this.dialog.className="modal-dialog",this.dialog.style.width=this.options.width,this.dialog.style.maxWidth=this.options.maxWidth,this.dialog.style.height=this.options.height,this.dialog.style.maxHeight=this.options.maxHeight,this.options.title&&(this.header=document.createElement("div"),this.header.className="modal-header",this.header.innerHTML=`\n        <h4 class="modal-title">${this.options.title}</h4>\n        ${this.options.closeButton?'<button type="button" class="modal-close" aria-label="Close"></button>':""}\n      `,this.dialog.appendChild(this.header)),this.body=document.createElement("div"),this.body.className="modal-body",this.body.innerHTML=this.options.content,this.dialog.appendChild(this.body),this.modal.appendChild(this.dialog),document.body.appendChild(this.modal)}bindEvents(){window.setTimeout(()=>{this._bindCloseButtons(this.modal)},100),this.options.keyboard&&document.addEventListener("keydown",e=>{"Escape"===e.key&&this.visible&&this.hide()}),this.options.focus&&this.modal.addEventListener("keydown",e=>{if("Tab"===e.key){const t=this.modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),a=t[0],n=t[t.length-1];e.shiftKey?document.activeElement===a&&(n.focus(),e.preventDefault()):document.activeElement===n&&(a.focus(),e.preventDefault())}})}show(){if(!this.visible&&(this.backdropId=BackdropManager.show(()=>{this.options.backdrop&&this.hide()},{opacity:this.options.backdropOpacity,background:this.options.backdropColor}),"function"==typeof this.options.onShow&&this.options.onShow.call(this),this.modal.setAttribute("aria-hidden","false"),this.modal.inert=!1,document.body.classList.add("modal-open"),this.options.animation?(this.modal.classList.add("fade-in"),setTimeout(()=>{this.modal.classList.add("show"),"function"==typeof this.options.onShown&&this.options.onShown.call(this)},150)):(this.modal.classList.add("show"),"function"==typeof this.options.onShown&&this.options.onShown.call(this)),this.visible=!0,this.options.focus)){const e=this.modal.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');null==e||e.focus()}}hide(){if(!this.visible)return;null!==this.backdropId&&(BackdropManager.hide(this.backdropId),this.backdropId=null),"function"==typeof this.options.onHide&&this.options.onHide.call(this);const e=this.modal.querySelector(":focus");e&&e.blur(),this.modal.setAttribute("aria-hidden","true"),this.modal.inert=!0,document.body.classList.remove("modal-open"),this.options.animation?(this.modal.classList.remove("fade-in"),this.modal.classList.add("fade-out")):(this.modal.classList.remove("show"),"function"==typeof this.options.onHidden&&this.options.onHidden.call(this)),this.visible=!1,setTimeout(()=>{this._cleanupModalElements(),this.body.innerHTML="",this.options.animation&&(this.modal.classList.remove("show","fade-out"),"function"==typeof this.options.onHidden&&this.options.onHidden.call(this))},150)}_cleanupModalElements(){window.FormManager&&"function"==typeof window.FormManager.destroyContainer&&window.FormManager.destroyContainer(this.body),window.ElementManager&&"function"==typeof window.ElementManager.destroyContainer&&window.ElementManager.destroyContainer(this.body)}setContent(e){this.body.children.length>0&&(this._cleanupModalElements(),this.body.innerHTML=""),e instanceof DocumentFragment||e instanceof Node?this.body.appendChild(e):this.body.innerHTML=e,this._bindCloseButtons(this.body),this._scanModalElements()}_scanModalElements(){var e,t,a,n;try{const s=window.ElementManager||(null==(t=null==(e=window.Now)?void 0:e.getManager)?void 0:t.call(e,"element")),r=window.FormManager||(null==(n=null==(a=window.Now)?void 0:a.getManager)?void 0:n.call(a,"form"));s&&"function"==typeof s.scan&&s.scan(this.body),r&&"function"==typeof r.scan&&r.scan(this.body)}catch(s){console.warn("Modal: Failed to scan elements",s)}}setTitle(e){const t=this.modal.querySelector(".modal-title");t&&(t.innerHTML=e)}bindData(e){if(!e||"object"!=typeof e)return this;this.boundData={...this.boundData,...e};for(const[t,a]of Object.entries(e)){this.modal.querySelectorAll(`[data-modal-target="${t}"]`).forEach(e=>{this._setElementContent(e,a,t)})}return this}updateData(e){return this.bindData(e)}getData(){return{...this.boundData}}_setElementContent(e,t,a){const n=e.tagName.toLowerCase(),s=this._sanitizeValue(t,a);if("img"===n)return e.src=s,void(e.alt||(e.alt=a));"a"!==n?"input"!==n&&"textarea"!==n?"video"!==n&&"audio"!==n&&"source"!==n?e.hasAttribute("data-modal-html")?e.innerHTML=this._sanitizeHTML(s):e.textContent=s:e.src=s:e.value=s:e.href=s}_sanitizeValue(e,t){if(null==e)return"";const a=String(e);return t.includes("url")||t.includes("src")||t.includes("href")?this._sanitizeURL(a):this._sanitizeText(a)}_sanitizeText(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}_sanitizeHTML(e){if(window.DOMPurify)return DOMPurify.sanitize(e);const t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll("script").forEach(e=>e.remove()),t.querySelectorAll("*").forEach(e=>{Array.from(e.attributes).forEach(t=>{t.name.startsWith("on")&&e.removeAttribute(t.name)})}),t.innerHTML}_sanitizeURL(e){if(!e)return"";try{const t=new URL(e,window.location.origin);return["http:","https:","mailto:","tel:","data:"].includes(t.protocol)?t.href:"#"}catch(t){return e.startsWith("/")||e.startsWith("./")||e.startsWith("../")?e:"#"}}_bindCloseButtons(e){if(!e)return;e.querySelectorAll(".modal-close").forEach(e=>{const t=e.cloneNode(!0);e.parentNode&&(e.parentNode.replaceChild(t,e),t.addEventListener("click",e=>{e.preventDefault(),this.hide()}))})}destroy(){this.modal.remove(),this.boundData={}}};(null==(s=window.Now)?void 0:s.registerManager)&&Now.registerManager("modal",j),window.Modal=j;const U={config:{galleryClass:"modal-gallery",bindAttribute:"data-modal-bind",targetAttribute:"data-modal-target",contentAttribute:"data-gallery-content",sanitize:!0,defaultEffect:"fade",effectDuration:300,swipeThreshold:50},state:{initialized:!1,modalInstances:new Map,galleryData:new Map},init(){this.state.initialized||(this.bindModalTriggers(),this.bindGalleryNavigation(),this.bindTouchNavigation(),this.state.initialized=!0)},bindModalTriggers(){document.addEventListener("click",e=>{const t=e.target.closest("[data-modal]");t&&(e.preventDefault(),this.handleModalTrigger(t))})},bindGalleryNavigation(){document.addEventListener("click",e=>{const t=e.target.closest("[data-modal-nav]");if(!t)return;e.preventDefault();const a=t.dataset.modalNav,n=t.closest(".modal");n&&a&&this.navigateGallery(n.id,a)})},bindTouchNavigation(){let e=0,t=0,a=0,n=0,s=null;document.addEventListener("touchstart",a=>{const n=a.target.closest(".modal.show");n&&this.state.galleryData.has(n.id)&&(s=n,e=a.changedTouches[0].screenX,t=a.changedTouches[0].screenY)},{passive:!0}),document.addEventListener("touchend",r=>{if(!s)return;a=r.changedTouches[0].screenX,n=r.changedTouches[0].screenY;const i=a-e,o=n-t;Math.abs(i)>Math.abs(o)&&Math.abs(i)>this.config.swipeThreshold&&(i<0?this.navigateGallery(s.id,"next"):this.navigateGallery(s.id,"prev")),s=null},{passive:!0})},handleModalTrigger(e){const t=e.dataset.modal;if(!t)return;const a=this.parseBindData(e.dataset.modalBind),n=this.evaluateBindData(a,e),s="true"===e.dataset.modalGallery;s&&this.setupGallery(t,e,n),this.openModalWithData(t,n,{gallery:s,trigger:e})},parseBindData(e){if(!e)return{};const t=e.split(",").map(e=>e.trim()),a={};return t.forEach(e=>{const[t,n]=e.split(":").map(e=>e.trim());t&&n&&(a[t]=n)}),a},evaluateBindData(e,t){const a={},n=this.findTemplateContext(t);for(const[r,i]of Object.entries(e))try{const e=this.evaluateExpression(i,n,t);a[r]=e}catch(s){a[r]=""}return a},findTemplateContext(e){let t=e;for(;t&&t!==document.body;){const e=t.dataset;if(e.category||e.title||e.id||e.index)return t;t=t.parentElement}return e},evaluateExpression(e,t,a){if("$index"===e)return this.getElementIndex(t);if("$item"===e)return t.dataset;if(e.startsWith("item.")){const a=e.substring(5),n=a.replace(/([A-Z])/g,"-$1").toLowerCase();return t.dataset[a]||t.getAttribute(`data-${n}`)||""}if(e.startsWith('"')||e.startsWith("'"))return e.slice(1,-1);const n=t.dataset[e]||t.getAttribute(`data-${e}`);return null!==n?n:e},getElementIndex(e){if(!e.parentElement)return 0;return Array.from(e.parentElement.children).indexOf(e)},setupGallery(e,t,a){var n;const s=(null==(n=t.closest("[data-for]"))?void 0:n.parentElement)||t.parentElement,r=Array.from(s.querySelectorAll('[data-modal="'+e+'"]')),i=r.indexOf(t);this.state.galleryData.set(e,{items:r,currentIndex:i,loop:"false"!==t.dataset.modalGalleryLoop,effect:t.dataset.modalEffect||this.config.defaultEffect})},navigateGallery(e,t){const a=this.state.galleryData.get(e);if(!a)return;const{items:n,currentIndex:s,loop:r,effect:i}=a;let o=s;if("prev"===t?(o=s-1,o<0&&(o=r?n.length-1:0)):"next"===t&&(o=s+1,o>=n.length&&(o=r?0:n.length-1)),o!==s){a.currentIndex=o;const s=n[o],r=this.parseBindData(s.dataset.modalBind),l=this.evaluateBindData(r,s);this.applyGalleryEffect(e,l,i,t)}},applyGalleryEffect(e,t,a,n){const s=this.state.modalInstances.get(e);if(!s)return;const r=s.isPreExisting?s.element:s.modal;if(!r)return;let i,o,l=r.querySelector(`[${this.config.contentAttribute}]`);if(l||(l=r.querySelector(".lightbox-body, .modal-body")),l||(l=r.querySelector("img[data-modal-target]")),l){switch(a){case"slide":case"slide-horizontal":i="next"===n?"gallery-slide-out-left":"gallery-slide-out-right",o="next"===n?"gallery-slide-in-right":"gallery-slide-in-left";break;case"slide-left":i="gallery-slide-out-left",o="gallery-slide-in-left";break;case"slide-right":i="gallery-slide-out-right",o="gallery-slide-in-right";break;case"slide-up":case"slide-vertical":i="next"===n?"gallery-slide-out-up":"gallery-slide-out-down",o="next"===n?"gallery-slide-in-up":"gallery-slide-in-down";break;case"slide-down":i="gallery-slide-out-down",o="gallery-slide-in-down";break;case"zoom":i="gallery-zoom-out",o="gallery-zoom-in";break;default:i="gallery-fade-out",o="gallery-fade-in"}l.classList.add(i),setTimeout(()=>{l.classList.remove(i),this.updateModalData(e,t),l.classList.add(o),setTimeout(()=>{l.classList.remove(o)},this.config.effectDuration)},this.config.effectDuration/2)}else this.updateModalData(e,t)},openModalWithData(e,t,a={}){var n;const s=document.getElementById(e);if(!s)return void console.warn(`Modal element with id "${e}" not found`);if(s.classList.contains("modal"))this._bindDataToElement(s,t),this._showPreExistingModal(s),this.state.modalInstances.set(e,{element:s,isPreExisting:!0});else{let a=this.state.modalInstances.get(e);if(!a||a.isPreExisting){const t=s.innerHTML,r=(null==(n=s.querySelector(".modal-title"))?void 0:n.textContent)||"";s.remove(),a=new Modal({id:e,title:r,content:t,closeButton:!0,backdrop:!0,keyboard:!0,animation:!0}),this.state.modalInstances.set(e,a)}a.bindData(t),a.show()}},_bindDataToElement(e,t){for(const[a,n]of Object.entries(t)){e.querySelectorAll(`[${this.config.targetAttribute}="${a}"]`).forEach(e=>{this._setElementContent(e,n,a)})}},_setElementContent(e,t,a){const n=e.tagName.toLowerCase();if("img"===n)return e.src=t||"",void(e.alt||(e.alt=a));"a"!==n?"input"!==n&&"textarea"!==n?e.textContent=t||"":e.value=t||"":e.href=t||"#"},_showPreExistingModal(e){e.dataset.modalInitialized||(this._bindPreExistingModalEvents(e),e.dataset.modalInitialized="true"),window.BackdropManager&&(e._backdropId=BackdropManager.show(()=>this.closeModal(e.id),{zIndex:1040})),e.classList.add("show"),e.setAttribute("aria-hidden","false"),document.body.classList.add("modal-open"),requestAnimationFrame(()=>{const t=e.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');t&&t.focus()})},_bindPreExistingModalEvents(e){e.querySelectorAll('.modal-close, [data-close], [data-dismiss="modal"]').forEach(t=>{t.addEventListener("click",t=>{t.preventDefault(),this.closeModal(e.id)})}),e.addEventListener("click",t=>{t.target===e&&this.closeModal(e.id)});const escHandler=t=>{"Escape"===t.key&&e.classList.contains("show")&&this.closeModal(e.id)};document.addEventListener("keydown",escHandler),e._escHandler=escHandler},updateModalData(e,t){const a=this.state.modalInstances.get(e);a?a.isPreExisting?this._bindDataToElement(a.element,t):a.updateData(t):console.warn(`Modal "${e}" not found`)},closeModal(e){const t=this.state.modalInstances.get(e);if(t)if(t.isPreExisting){const e=t.element;e._backdropId&&window.BackdropManager&&(BackdropManager.hide(e._backdropId),e._backdropId=null),e.classList.remove("show"),e.setAttribute("aria-hidden","true"),document.body.classList.remove("modal-open")}else t.hide();this.state.galleryData.delete(e)},getModalData(e){const t=this.state.modalInstances.get(e);return t?t.isPreExisting?null:t.getData():null},destroy(){this.state.modalInstances.forEach(e=>e.destroy()),this.state.modalInstances.clear(),this.state.galleryData.clear(),this.state.initialized=!1}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>U.init()):U.init(),"undefined"!=typeof module&&module.exports&&(module.exports=U);const V={config:{asyncTimeout:5e3,maxListeners:2048,traceEvents:!1,cleanup:{enabled:!0,interval:6e4,maxAge:18e5,batchSize:100}},state:{events:new Map,groups:new Map,patterns:new Set,listenerCounts:new Map,middleware:[],history:[],cleanupTimer:null,lastCleanup:Date.now()},async init(e={}){return this.config={...this.config,...e},this.config.cleanup.enabled&&this.startCleanup(),this},removePatternListener(e,t=null){let a=!1;if(null===t)return this.state.patterns.forEach((t,n)=>{n.toString()===e&&(this.state.patterns.delete(n),a=!0)}),a;for(const[n,s]of this.state.patterns.entries())n.toString()===e&&("string"==typeof t&&s.id===t||"function"==typeof t&&s.callback===t)&&(this.state.patterns.delete(n),a=!0);return a},once(e,t,a={}){return this.on(e,t,{...a,once:!0})},getEventPath(e){const t=e.split("."),a=[];for(;t.length>0;)a.push(t.join(".")),t.pop();return a},async processPromises(e,t){if(0!==e.length)try{(await Promise.allSettled(e)).forEach(e=>{"fulfilled"===e.status&&void 0!==e.value?t.results.push(e.value):"rejected"===e.status&&this.handleListenerError(e.reason,t.event)})}catch(a){this.handleAsyncError(a,t.event)}},async emit(e,t={}){try{if(!1===await this.runMiddleware("beforeEmit",{event:e,data:t}))return[];const n=this.getEventPath(e),s={event:e,data:t,timestamp:Date.now(),preventDefault:!1,stopPropagation:!1,stopImmediatePropagation:!1,results:[],source:null,path:n,currentPath:null};this.config.traceEvents&&this.addToHistory(s);for(const e of n){if(s.stopPropagation)break;await this.emitPatternMatches(e,s);const t=this.state.events.get(e);if(t&&t.size>0){const n=[];for(const r of t){if(s.stopImmediatePropagation)break;try{r.options.once&&(t.delete(r),this.updateListenerCount(e,-1));const a=await r.callback(s);r.options.async||a instanceof Promise?n.push(this.handleAsyncListener(Promise.resolve(a),r,s)):void 0!==a&&s.results.push(a)}catch(a){this.handleListenerError(a,e,r)}}await this.processPromises(n,s)}for(const[n,r]of this.state.groups)if(r.has(e)){const t=r.get(e),n=[];for(const r of t){if(s.stopImmediatePropagation)break;try{r.options.once&&(t.delete(r),this.updateListenerCount(e,-1));const a=await r.callback(s);r.options.async||a instanceof Promise?n.push(this.handleAsyncListener(Promise.resolve(a),r,s)):void 0!==a&&s.results.push(a)}catch(a){this.handleListenerError(a,e,r)}}await this.processPromises(n,s)}}return await this.runMiddleware("afterEmit",{event:e,data:t,context:s}),s.results}catch(a){return this.handleEmitError(a,e),[]}},createPattern:e=>new RegExp("^"+e.replace(/\./g,"\\.").replace(/\*/g,".*").replace(/\?/g,".")+"$"),on(e,t,a={}){try{if(!e||"string"!=typeof e)throw new Error("Event name must be a non-empty string");if("function"!=typeof t)throw new Error("Callback must be a function");e=e.trim();const n={priority:parseInt(a.priority)||0,once:Boolean(a.once),async:Boolean(a.async),group:a.group||null,timeout:a.timeout||this.config.asyncTimeout,maxRetries:a.maxRetries||1,onError:a.onError||null};if(this.isPattern(e)){const a={pattern:this.createPattern(e),callback:t,options:n,id:Utils.generateUUID(),timestamp:Date.now()};return this.state.patterns.add(a),()=>{this.state.patterns.delete(a)}}const s={id:Utils.generateUUID(),callback:t,options:n,timestamp:Date.now(),retryCount:0,active:!0};this.state.events.has(e)||this.state.events.set(e,new Set);const r=this.state.events.get(e);if(r.size>=this.config.maxListeners){if(!a.force)return ErrorManager.handle(`Max listeners exceeded for event: ${e}`,{context:"EventManager.on",type:"error:event",notify:!0}),null;this.cleanupStaleListeners(e)}return r.add(s),this.updateListenerCount(e,1),n.group&&this.addToGroup(n.group,e,s),this.sortListeners(e),()=>{this.off(e,s.id)}}catch(n){return ErrorManager.handle(n,{context:"EventManager.on",type:"error:event",notify:!0}),null}},off(e,t=null){try{if(!e||"string"!=typeof e)throw new Error("Event name must be a non-empty string");if(e=e.trim(),this.isPattern(e))return this.removePatternListener(e,t);const a=this.state.events.get(e);if(!a||0===a.size)return!1;let n=!1;if(null===t){const t=a.size;a.clear(),this.updateListenerCount(e,-t),this.state.groups.forEach(t=>{t.has(e)&&t.delete(e)}),0===a.size&&this.state.events.delete(e),n=!0}else{for(const s of a)t!==s.id&&t!==s.callback||(a.delete(s),this.updateListenerCount(e,-1),this.state.groups.forEach(t=>{const a=t.get(e);(null==a?void 0:a.has(s))&&(a.delete(s),0===a.size&&t.delete(e))}),n=!0);0===a.size&&this.state.events.delete(e)}return this.state.groups.forEach((e,t)=>{0===e.size&&this.state.groups.delete(t)}),n}catch(a){return ErrorManager.handle(a,{context:"EventManager.off",type:"error:event",notify:!0}),!1}},async emitPatternMatches(e,t){var a,n;if(!this.state.patterns||0===this.state.patterns.size)return;const s=[];for(const i of this.state.patterns.values()){if(t.stopImmediatePropagation)break;if(i.pattern.test(e))try{(null==(a=i.options)?void 0:a.once)&&this.state.patterns.delete(i);const e=await i.callback(t);(null==(n=i.options)?void 0:n.async)?s.push(this.handleAsyncListener(Promise.resolve(e),i,t)):e instanceof Promise?s.push(this.handleAsyncListener(e,i,t)):void 0!==e&&t.results.push(e)}catch(r){this.handleListenerError(r,e,i)}}if(s.length>0)try{const e=await Promise.race([Promise.all(s),new Promise((e,t)=>setTimeout(()=>t(new Error("Pattern matching timeout")),this.config.asyncTimeout))]);t.results.push(...e.filter(e=>void 0!==e))}catch(r){this.handleAsyncError(r,e)}},addPatternListener(e,t,a){const n=new RegExp(e);return this.state.patterns.set(n,{callback:t,options:a}),()=>this.state.patterns.delete(n)},addToGroup(e,t,a){this.state.groups.has(e)||this.state.groups.set(e,new Map);const n=this.state.groups.get(e);n.has(t)||n.set(t,new Set),n.get(t).add(a)},removeFromGroup(e,t,a){const n=this.state.groups.get(e);if(!n)return;const s=n.get(t);s&&(s.delete(a),0===s.size&&n.delete(t)),0===n.size&&this.state.groups.delete(e)},async emitGroup(e,t={}){const a=this.state.groups.get(e);if(!a)return[];const n=[];for(const[r,i]of a){const e={event:r,data:t,timestamp:Date.now(),preventDefault:!1,stopPropagation:!1,stopImmediatePropagation:!1,results:[],source:null,path:[r],currentPath:r},a=[];for(const t of i){if(e.stopImmediatePropagation)break;try{t.options.once&&(i.delete(t),this.updateListenerCount(r,-1));const n=await t.callback(e);t.options.async||n instanceof Promise?a.push(this.handleAsyncListener(Promise.resolve(n),t,e)):void 0!==n&&e.results.push(n)}catch(s){this.handleListenerError(s,r,t)}}await this.processPromises(a,e),n.push(...e.results)}return n},use(e){return("function"==typeof e||"object"==typeof e)&&this.state.middleware.push(e),this},async runMiddleware(e,t){for(const n of this.state.middleware)try{if("function"==typeof n){if(!1===await n(t))return!1}else if(n[e]){if(!1===await n[e](t))return!1}}catch(a){this.handleMiddlewareError(a,e)}return!0},startCleanup(){this.state.cleanupTimer&&clearInterval(this.state.cleanupTimer),this.state.cleanupTimer=setInterval(()=>{this.cleanup()},this.config.cleanup.interval),window.addEventListener("beforeunload",()=>{this.cleanup(),clearInterval(this.state.cleanupTimer)}),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&(this.cleanup(),clearInterval(this.state.cleanupTimer))})},cleanup(){const e=Date.now();let t=0;for(const[a,n]of this.state.events){if(t>=this.config.cleanup.batchSize)break;this.cleanupStaleListeners(a),0===n.size&&(this.state.events.delete(a),this.state.listenerCounts.delete(a)),t++}for(const a of this.state.patterns){if(t>=this.config.cleanup.batchSize)break;a.timestamp&&e-a.timestamp>this.config.cleanup.maxAge&&this.state.patterns.delete(a),t++}for(;this.state.history.length>0&&e-this.state.history[0].timestamp>this.config.cleanup.maxAge;)this.state.history.shift();this.state.lastCleanup=e},cleanupStaleListeners(e){const t=this.state.events.get(e);if(!t)return;const a=Date.now();let n=0;for(const s of t)a-s.timestamp>this.config.cleanup.maxAge&&(t.delete(s),n++);n>0&&this.updateListenerCount(e,-n)},updateListenerCount(e,t){const a=this.state.listenerCounts.get(e)||0,n=Math.max(0,a+t);0===n?this.state.listenerCounts.delete(e):this.state.listenerCounts.set(e,n)},addToHistory(e){for(this.state.history.push({...e,stack:(new Error).stack});this.state.history.length>100;)this.state.history.shift()},sortListeners(e){const t=this.state.events.get(e);if(!t)return;const a=Array.from(t).sort((e,t)=>t.options.priority-e.options.priority);this.state.events.set(e,new Set(a))},getParentEvent(e){const t=e.split(".");return t.length>1?t.slice(0,-1).join("."):null},isPattern:e=>e.includes("*")||e.includes("?")||e.includes("+")||e.includes("|"),async handleAsyncListener(e,t,a){try{return await Promise.race([e,new Promise((e,a)=>setTimeout(()=>a(new Error("Async handler timeout")),t.options.timeout||this.config.asyncTimeout))])}catch(n){return void this.handleListenerError(n,a.event,t)}},handleListenerError(e,t,a){const n=e||new Error("Listener execution failed");return ErrorManager.handle(n,{context:"EventManager.listener",type:"error:event",data:{event:t,listenerId:a.id,listenerOptions:a.options},notify:!0}),!1},handleAsyncError(e,t){const a=e||new Error("Async execution failed");return ErrorManager.handle(a,{context:"EventManager.async",type:"error:event",data:{event:t,timestamp:Date.now()},notify:!0}),!1},handleEmitError(e,t){const a=e||new Error("Event emission failed");return ErrorManager.handle(a,{context:"EventManager.emit",type:"error:event",data:{event:t,timestamp:Date.now()},notify:!0}),!1},handleMiddlewareError(e,t){const a=e||new Error("Middleware execution failed");return ErrorManager.handle(a,{context:"EventManager.middleware",type:"error:event",data:{hook:t,timestamp:Date.now()},notify:!0}),!1},getEventInfo(e){const t=this.state.events.get(e);return{name:e,listenerCount:(null==t?void 0:t.size)||0,groups:Array.from(this.state.groups.entries()).filter(([t,a])=>a.has(e)).map(([e])=>e),patterns:Array.from(this.state.patterns.keys()).filter(t=>t.test(e)).map(e=>e.toString())}},getDebugInfo(){return{events:Array.from(this.state.events.keys()).map(e=>({name:e,...this.getEventInfo(e)})),patterns:Array.from(this.state.patterns.entries()).map(([e,t])=>({pattern:e.toString(),options:t.options})),groups:Array.from(this.state.groups.entries()).map(([e,t])=>({name:e,eventCount:t.size,events:Array.from(t.keys())})),listenerCounts:Object.fromEntries(this.state.listenerCounts),history:this.state.history.slice(-20).map(e=>({name:e.event,timestamp:e.timestamp,hasData:!!e.data,prevented:e.preventDefault,propagationStopped:e.stopPropagation})),middleware:{count:this.state.middleware.length,types:this.state.middleware.map(e=>"function"==typeof e?"function":"object")},state:{lastCleanup:this.state.lastCleanup,historyLength:this.state.history.length},config:{...this.config,onError:this.config.onError?"function configured":"not configured"},system:{timestamp:Date.now(),memoryUsage:(null==performance?void 0:performance.memory)?{usedJSHeapSize:performance.memory.usedJSHeapSize,totalJSHeapSize:performance.memory.totalJSHeapSize}:"not available"}}},clear(){this.state.events.clear(),this.state.groups.clear(),this.state.patterns.clear(),this.state.listenerCounts.clear(),this.state.history=[],this.state.middleware=[]},destroy(){this.state.cleanupTimer&&clearInterval(this.state.cleanupTimer),this.clear(),window.removeEventListener("unload",this.cleanup)}};(null==(r=window.Now)?void 0:r.registerManager)&&Now.registerManager("event",V),window.EventManager=V;const W={config:{cleanupInterval:6e5,maxMemoryUsage:52428800,delegation:{enabled:!0,matchingStrategy:"closestFirst",maxDelegationDepth:10,optimizeSelectors:!0,rootElement:document},memoryManagement:{checkInterval:3e4,maxHandlersPerElement:100,maxCacheSize:1e3,gcThreshold:.8,detailedTracking:!0},filtering:{enabled:!0,maxThrottleRate:60,debounceWait:100,highFrequencyEvents:null}},state:{handlers:new Map,elementHandlers:new Map,idCounter:0,initialized:!1,memoryUsage:0,eventPaths:new WeakMap,cleanupTimer:null,delegationCache:new WeakMap,selectorCache:new Map,delegatedEvents:new Map,selectorsByType:new Map,selectorMatchCache:new WeakMap,uiEventQueue:new Map,rafScheduled:!1,memoryStats:{handlerCount:0,cacheSize:0,weakMapSize:0,lastGC:Date.now(),peakMemoryUsage:0,memoryWarnings:0},elementStats:new WeakMap,gcTimer:null,filtering:{throttleTimers:new Map,debounceTimers:new Map,lastEventTimes:new Map,filteredCount:0}},windowEvents:new Set(["popstate","hashchange","resize","scroll","load","pagehide","visibilitychange","beforeunload","online","offline","message","storage"]),nonPassiveEvents:new Set(["click","submit","dragstart","dragenter","dragleave","dragover","drop","touchstart","touchmove","wheel","keydown","paste"]),supportedEvents:["click","dblclick","mousedown","mouseup","mousemove","mouseenter","mouseleave","mouseover","mouseout","submit","change","input","focus","blur","keydown","keyup","keypress","paste","touchstart","touchend","touchmove","touchcancel","dragstart","dragend","dragenter","dragleave","dragover","drop","scroll","resize","contextmenu","wheel","popstate","hashchange"],uiEvents:new Set(["resize","scroll","mousemove","touchmove","drag","dragover"]),init(){return this.state.initialized||(this.config.filtering.highFrequencyEvents=new Set(["mousemove","scroll","resize","touchmove","pointermove"]),this.state.filtering={throttleTimers:new Map,debounceTimers:new Map,lastEventTimes:new Map,filteredCount:0},this.setupGlobalHandlers(),this.setupCleanup(),this.observeDOM(),this.setupMemoryMonitoring(),this.state.initialized=!0),this},setupGlobalHandlers(){this.supportedEvents.forEach(e=>{this.config.delegation.rootElement.addEventListener(e,e=>this.handleEvent(e),{capture:!0,passive:!this.nonPassiveEvents.has(e)})}),this.windowEvents.forEach(e=>{window.addEventListener(e,e=>this.handleWindowEvent(e),{capture:!0,passive:!this.nonPassiveEvents.has(e)})})},addHandler(e,t,a,n={}){if(this.state.initialized||this.init(),!t||!this.supportedEvents.includes(t))throw new Error(`Unsupported event: ${t}`);const s=this.windowEvents.has(t);s&&(e=window);const r=e===document;if(!e||!(e instanceof Element||e===window||e===document))throw new Error("Invalid element provided");if("function"!=typeof a)throw new Error("Handler must be a function");const i=++this.state.idCounter,o={id:i,type:t,handler:a,element:e,isWindowEvent:s,isDocumentEvent:r,timestamp:Date.now(),options:{capture:Boolean(n.capture),once:Boolean(n.once),passive:Boolean(n.passive),priority:Number(n.priority)||0,componentId:n.componentId,selector:n.selector}};if(this.state.handlers.set(i,o),!s){this.state.elementHandlers.has(e)||this.state.elementHandlers.set(e,new Map);const a=this.state.elementHandlers.get(e);if(a.has(t)||a.set(t,new Set),a.get(t).add(i),this.config.delegation.enabled&&n.selector){this.state.delegatedEvents.has(t)||this.state.delegatedEvents.set(t,new Map);const e=this.state.delegatedEvents.get(t);e.has(n.selector)||e.set(n.selector,new Set),e.get(n.selector).add(i)}}return i},removeHandler(e){const t=this.state.handlers.get(e);if(!t)return!1;const{element:a,type:n}=t,s=this.state.elementHandlers.get(a);if(s){const t=s.get(n);t&&(t.delete(e),0===t.size&&s.delete(n)),0===s.size&&this.state.elementHandlers.delete(a)}return this.state.handlers.delete(e)},handleEvent(e){if(this.shouldProcessEvent(e))try{if("keydown"===e.type||"keyup"===e.type||"keypress"===e.type){const t=this.handleKeyboardEvent(e);e._enhanced=t}if(this.uiEvents.has(e.type))return void this.queueUIEvent(e);this.processEvent(e)}catch(t){ErrorManager.handle(t,{context:"EventSystemManager.handleEvent",data:{event:e}})}},handleKeyboardEvent:e=>({originalEvent:e,key:e.key,code:e.code,keyCode:e.keyCode,ctrlKey:e.ctrlKey||!1,altKey:e.altKey||!1,shiftKey:e.shiftKey||!1,metaKey:e.metaKey||!1,isEnter:"Enter"===e.key,isShiftEnter:"Enter"===e.key&&e.shiftKey,isCtrlEnter:"Enter"===e.key&&e.ctrlKey,isAltEnter:"Enter"===e.key&&e.altKey,isTab:"Tab"===e.key,isShiftTab:"Tab"===e.key&&e.shiftKey,isArrowKey:["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key),preventDefault(){e.preventDefault()},stopPropagation(){e.stopPropagation()}}),handleWindowEvent(e){if(this.shouldProcessEvent(e))try{const t={stopped:!1,immediateStopped:!1,path:[window],type:e.type,key:e.key,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,altKey:e.altKey,metaKey:e.metaKey,originalEvent:e,target:window,currentTarget:window,processedHandlers:new Set},a=Array.from(this.state.handlers.entries()).filter(([t,a])=>a.isWindowEvent&&a.type===e.type).sort((e,t)=>(t[1].options.priority||0)-(e[1].options.priority||0));for(const[e,n]of a){if(t.immediateStopped)break;t.processedHandlers.has(e)||(t.processedHandlers.add(e),this.executeHandler(n,t))}}catch(t){ErrorManager.handle(t,{context:"EventSystemManager.handleWindowEvent",data:{event:e}})}},queueUIEvent(e){const t=e.type;this.state.uiEventQueue.set(t,e),this.state.rafScheduled||(this.state.rafScheduled=!0,requestAnimationFrame(()=>{this.processUIEventQueue()}))},processUIEventQueue(){this.state.rafScheduled=!1;for(const[e,t]of this.state.uiEventQueue)this.processEvent(t);this.state.uiEventQueue.clear()},processEvent(e){const t=this.getEventPath(e),a={stopped:!1,immediateStopped:!1,path:t,type:e.type,key:e.key,shiftKey:e.shiftKey,ctrlKey:e.ctrlKey,altKey:e.altKey,metaKey:e.metaKey,originalEvent:e,target:e.target,currentTarget:null,processedHandlers:new Set};for(let n=t.length-1;n>=0&&!a.stopped;n--)a.currentTarget=t[n],this.processElementHandlers(a,!0);if(!a.stopped)for(let n=0;n<t.length&&!a.stopped;n++)a.currentTarget=t[n],this.processElementHandlers(a,!1)},processElementHandlers(e,t){const a=this.state.elementHandlers.get(e.currentTarget);if(!a)return;const n=a.get(e.type);if(!n||0===n.size)return;const s=[],r=Array.from(n).map(e=>{const t=this.state.handlers.get(e);return t||s.push(e),t}).filter(a=>{if(!a)return!1;if(e.processedHandlers.has(a.id))return!1;return a.options.capture===t}).sort((e,t)=>(t.options.priority||0)-(e.options.priority||0));s.length>0&&s.forEach(e=>n.delete(e));for(const i of r){if(e.immediateStopped)break;this.shouldHandleEvent(i,e)&&(e.processedHandlers.add(i.id),this.executeHandler(i,e))}},shouldHandleEvent(e,t){if(e.options.selector){const a=this.findDelegateTarget(t.target,e.options.selector);if(!a)return!1;t.delegateTarget=a}return!0},findDelegateTarget(e,t){const a=e,n=this.state.selectorMatchCache;n.has(a)||n.set(a,new Map);const s=n.get(a);if(s.has(t))return s.get(t);try{const a=e.closest(t),n=a&&this.config.delegation.rootElement.contains(a)?a:null;return s.set(t,n),n}catch(r){return ErrorManager.handle(`Invalid selector: ${t}`,{context:"EventSystemManager.findDelegateTarget",data:{target:e,selector:t,error:r}}),s.set(t,null),null}},executeHandler(e,t){try{const a={type:t.type,key:t.key,shiftKey:t.shiftKey,ctrlKey:t.ctrlKey,altKey:t.altKey,metaKey:t.metaKey,target:t.target,currentTarget:t.currentTarget,delegateTarget:t.delegateTarget,timestamp:Date.now(),originalEvent:t.originalEvent,preventDefault(){t.originalEvent.preventDefault()},stopPropagation(){t.stopped=!0,t.originalEvent.stopPropagation()},stopImmediatePropagation(){t.stopped=!0,t.immediateStopped=!0,t.originalEvent.stopImmediatePropagation()},matches(e){var a,n;return(null==(n=(a=t.target).matches)?void 0:n.call(a,e))||!1}};let n;n=e.isWindowEvent?window:e.isDocumentEvent?document:e.options.selector&&t.delegateTarget?t.delegateTarget:e.element;return e.handler.bind(n)(a)}catch(a){ErrorManager.handle(a,{context:"EventSystemManager.executeHandler",data:{handlerId:e.id,type:t.type,target:t.target}})}},getEventPath(e){if(e&&"function"==typeof e.composedPath)return e.composedPath();const t=(null==e?void 0:e.target)||e;if(this.state.eventPaths.has(t))return this.state.eventPaths.get(t);const a=[];let n=t;for(;n&&n!==window;)a.push(n),n=n.parentElement||n.parentNode;return document&&a.push(document),window&&a.push(window),this.state.eventPaths.set(t,a),a},setupCleanup(){this.state.cleanupTimer&&clearInterval(this.state.cleanupTimer),this.state.cleanupTimer=setInterval(()=>{this.cleanup()},this.config.cleanupInterval)},observeDOM(){new MutationObserver(e=>{e.forEach(e=>{e.removedNodes.forEach(e=>{1===e.nodeType&&setTimeout(()=>{e.isConnected||this.removeElementHandlers(e)},0)})})}).observe(document.body,{childList:!0,subtree:!0})},removeElementHandlers(e){const t=this.state.elementHandlers.get(e);t&&(t.forEach((e,t)=>{e.forEach(e=>{this.removeHandler(e)})}),this.state.elementHandlers.delete(e))},removeComponentHandlers(e){const t=[];this.state.handlers.forEach((a,n)=>{a.options.componentId===e&&t.push(n)}),t.forEach(e=>this.removeHandler(e))},cleanup(){this.state.handlers.forEach((e,t)=>{e.element!==window&&e.element!==document&&(document.contains(e.element)||this.removeHandler(t))}),this.state.eventPaths=new WeakMap,this.state.delegationCache=new WeakMap,this.state.selectorMatchCache=new WeakMap,this.state.uiEventQueue.clear(),this.state.filtering={throttleTimers:new Map,debounceTimers:new Map,lastEventTimes:new Map,filteredCount:0},this.state.memoryUsage>this.config.maxMemoryUsage&&this.performGC()},setupMemoryMonitoring(){this.state.gcTimer=setInterval(()=>{this.checkMemoryUsage()},this.config.memoryManagement.checkInterval)},checkMemoryUsage(){const e=this.gatherMemoryStats();this.updateMemoryStats(e),this.shouldTriggerGC(e)&&this.performGC(),this.config.memoryManagement.detailedTracking&&this.logMemoryWarnings(e)},gatherMemoryStats(){const e={handlerCount:this.state.handlers.size,cacheSize:this.state.selectorCache.size,weakMapSize:this.estimateWeakMapSize(),timestamp:Date.now(),elementHandlers:new Map};return this.state.elementHandlers.forEach((t,a)=>{let n=0;t.forEach(e=>{n+=e.size}),n>0&&e.elementHandlers.set(a,n)}),e},estimateWeakMapSize(){const e=Math.min(100,Math.max(20,Math.floor(.1*document.querySelectorAll("*").length))),t=(performance.now(),Array.from(document.querySelectorAll("*"))),a=[],n=Math.floor(t.length/e);for(let i=0;i<t.length&&a.length<e;i+=n)a.push(t[i]);let s=0;a.forEach(e=>{this.state.elementHandlers.has(e)&&s++,this.state.eventPaths.has(e)&&s++,this.state.delegationCache.has(e)&&s++,this.state.selectorMatchCache.has(e)&&s++});const r=Math.round(s/a.length*t.length);return performance.now(),r},updateMemoryStats(e){const t=this.state.memoryStats;t.handlerCount=e.handlerCount,t.cacheSize=e.cacheSize,t.weakMapSize=e.weakMapSize,t.peakMemoryUsage=Math.max(t.peakMemoryUsage,e.handlerCount+e.cacheSize)},shouldTriggerGC(e){const t=this.config.memoryManagement.gcThreshold,a=this.config.memoryManagement.maxHandlersPerElement;return e.handlerCount>this.config.maxMemoryUsage*t||e.cacheSize>this.config.memoryManagement.maxCacheSize||Array.from(e.elementHandlers.values()).some(e=>e>a)},performGC(){const e=Date.now(),t={handlersRemoved:0,cachesCleared:0};this.state.handlers.forEach((a,n)=>{this.isHandlerStale(a,e)&&(this.removeHandler(n),t.handlersRemoved++)}),this.clearUnusedCaches(),t.cachesCleared=this.state.selectorCache.size,this.state.memoryStats.lastGC=e,this.config.memoryManagement.detailedTracking&&console.info("GC Stats:",t)},isHandlerStale(e,t){if(!e.timestamp)return!1;const a=t-e.timestamp,n=e.element;return a>2*this.config.cleanupInterval||!document.contains(n)||!this.isElementVisible(n)},clearUnusedCaches(){for(const[e,t]of this.state.selectorCache)Date.now()-t>this.config.cleanupInterval&&this.state.selectorCache.delete(e);this.state.memoryStats.weakMapSize>this.config.memoryManagement.maxCacheSize&&(this.state.eventPaths=new WeakMap,this.state.delegationCache=new WeakMap,this.state.selectorMatchCache=new WeakMap)},logMemoryWarnings(e){const t=[],a=this.config.memoryManagement.maxHandlersPerElement;e.elementHandlers.forEach((e,n)=>{e>a&&t.push(`Element has too many handlers (${e}): ${n.tagName}`)}),t.length>0&&(this.state.memoryStats.memoryWarnings++,console.warn("Memory warnings:",t))},destroy(){this.state.cleanupTimer&&clearInterval(this.state.cleanupTimer),this.state.handlers.clear(),this.state.elementHandlers=new WeakMap,this.state.eventPaths=new WeakMap,this.state.delegationCache=new WeakMap,this.state.selectorCache.clear(),this.state.selectorMatchCache=new WeakMap,this.state.uiEventQueue.clear(),this.state.initialized=!1,this.state.gcTimer&&clearInterval(this.state.gcTimer),this.state.memoryStats={handlerCount:0,cacheSize:0,weakMapSize:0,lastGC:0,peakMemoryUsage:0,memoryWarnings:0}},shouldProcessEvent(e){var t;if(!this.config.filtering.enabled)return!0;const a=e.type;if(!(null==(t=this.config.filtering.highFrequencyEvents)?void 0:t.has(a))){const e=performance.now();if(e-(this.state.filtering.lastEventTimes.get(a)||0)<1e3/this.config.filtering.maxThrottleRate)return this.state.filtering.filteredCount++,!1;this.state.filtering.lastEventTimes.set(a,e)}return!0},isRapidFire(e){const t=performance.now(),a=e.type;return t-(this.state.filtering.lastEventTimes.get(a)||0)<1e3/this.config.filtering.maxThrottleRate||(this.state.filtering.lastEventTimes.set(a,t),!1)},throttle(e,t){const a=e.type,n=Date.now();n-(this.state.filtering.throttleTimers.get(a)||0)>=1e3/this.config.filtering.maxThrottleRate&&(t(e),this.state.filtering.throttleTimers.set(a,n))},debounce(e,t){const a=e.type;clearTimeout(this.state.filtering.debounceTimers.get(a)),this.state.filtering.debounceTimers.set(a,setTimeout(()=>{t(e),this.state.filtering.debounceTimers.delete(a)},this.config.filtering.debounceWait))}};(null==(i=window.Now)?void 0:i.registerManager)&&Now.registerManager("eventsystem",W),window.EventSystemManager=W;const Y={config:{debug:!1,persistence:{enabled:!0,key:"app_state",blacklist:["temp","ui"],encrypt:!1},history:{enabled:!0,maxSize:50,include:["user","data"]},batch:{enabled:!0,delay:16},strict:!0},state:{},modules:new Map,computed:new Map,watchers:new Map,subscriptions:new Map,subscriberCount:0,activeSubscriptions:new Set,history:[],historyIndex:-1,isTimeTraveling:!1,middleware:[],batchQueue:new Map,batchTimeout:null,async init(e={}){return this.config={...this.config,...e},await this.restoreState(),this.setupReactivity(),this},setupReactivity(){this.state=new Proxy(this.state,{set:(e,t,a)=>(e[t]=a,this.notifyWatchers(t),!0)})},hasModule(e){return this.modules.has(e)},registerModule(e,t,a={}){if(this.modules.has(e)){const t=this.modules.get(e);if(!a.force)return this.config.debug&&console.warn(`[StateManager] Module "${e}" already exists. Use force:true to replace.`),t;if(t.cleanup)try{t.cleanup()}catch(r){console.warn(`[StateManager] Error cleaning up module "${e}": ${r.message}`)}this.modules.delete(e),this.state[e]&&delete this.state[e];for(const[a,n]of this.computed.entries())a.startsWith(`${e}.`)&&this.computed.delete(a);for(const[a,n]of this.watchers.entries())a.startsWith(`${e}.`)&&this.watchers.delete(a);for(const[a,n]of this.subscriptions.entries())a.startsWith(`${e}.`)&&(n.forEach(e=>this.unsubscribe(e.id)),this.subscriptions.delete(a));this.history=this.history.map(t=>{if(t.state&&t.state[e]){const a={...t};return delete a.state[e],a}return t}),this.config.debug&&console.warn(`[StateManager] Force registering module "${e}". Module data completely reset.`)}const n="function"==typeof t.state?t.state():t.state,s={...t,initialState:JSON.parse(JSON.stringify(n)),state:n};return this.modules.set(e,s),this.state[e]||(this.state[e]=JSON.parse(JSON.stringify(n))),t.computed&&Object.entries(t.computed).forEach(([t,a])=>{this.registerComputed(`${e}.${t}`,a)}),t.watch&&Object.entries(t.watch).forEach(([e,t])=>{this.watch(e,t)}),s.init&&s.init(this.getModuleContext(e)),this},processModule(e,t){return{name:e,state:t.state||{},mutations:this.processMutations(t.mutations||{}),actions:this.processActions(t.actions||{}),getters:t.getters||{},init:t.init,computed:t.computed||{},watch:t.watch||{}}},processMutations(e){return Object.entries(e).reduce((e,[t,a])=>(e[t]=(e,n)=>{this.config.strict&&!this.isTimeTraveling&&console.log("[StateManager]",`Mutation: ${t}`,n),a(e,n)},e),{})},processActions(e){return Object.entries(e).reduce((e,[t,a])=>(e[t]=async(e,n)=>{try{return await a(e,n)}catch(s){throw this.handleError("Action error",{action:t,error:s},"processActions"),s}},e),{})},getModuleContext(e){if(!this.modules.get(e))throw new Error(`Module ${e} not found`);return{state:this.state[e],getters:this.getModuleGetters(e),commit:(t,a)=>this.commit(`${e}/${t}`,a),dispatch:(t,a)=>this.dispatch(`${e}/${t}`,a),watch:(t,a)=>this.watch(`${e}.${t}`,a)}},getModuleGetters(e){const t=this.modules.get(e);return Object.entries(t.getters).reduce((t,[a,n])=>(Object.defineProperty(t,a,{get:()=>n(this.state[e],t)}),t),{})},commit(e,t){var a;try{const[n,s]=e.split("/"),r=this.modules.get(n);if(!r)throw new Error(`Module ${n} not found`);const i=null==(a=r.mutations)?void 0:a[s];if(!i)throw new Error(`Mutation ${s} not found in module ${n}`);i(this.state[n],t),this.addToHistory(e,t),this.notifyWatchers(n)}catch(n){throw ErrorManager.handle(n,{context:"StateManager.commit",type:"error:state",data:{type:e,payload:t}}),n}},async dispatch(e,t){var a;try{const[n,s]=e.split("/"),r=this.modules.get(n);if(!r)throw new Error(`Module ${n} not found`);const i=null==(a=r.actions)?void 0:a[s];if(!i)throw new Error(`Action ${s} not found in module ${n}`);const o=this.getModuleContext(n);return await i(o,t)}catch(n){throw ErrorManager.handle(n,{context:"StateManager.dispatch",type:"error:state",data:{type:e,payload:t}}),n}},registerComputed(e,t){this.computed.set(e,{getter:t,cache:null,deps:new Set});let a=null;Object.defineProperty(this.state,e,{get:()=>{const n=this.computed.get(e);return a&&a!==e&&n.deps.add(a),null===n.cache&&(a=e,n.cache=t(this.state),a=null),n.cache}})},watch(e,t){try{if(!this.isValidPath(e))throw new Error(`Invalid state path: ${e}`);return this.watchers.has(e)||this.watchers.set(e,new Set),this.watchers.get(e).add(t),()=>{const a=this.watchers.get(e);a&&a.delete(t)}}catch(a){throw ErrorManager.handle(a,{context:"StateManager.watch",type:"error:state",data:{path:e}}),a}},notifyWatchers(e){this.watchers.forEach((t,a)=>{if(a.startsWith(e)){const e=this.getStateValue(a);t.forEach(t=>{try{t(e)}catch(n){this.handleError("Watcher error",{path:a,error:n},"notifyWatchers")}})}}),this.computed.forEach((t,a)=>{a.startsWith(e)&&(t.cache=null,t.deps.forEach(e=>{const t=this.computed.get(e);t&&(t.cache=null)}))})},getStateValue(e){return e.split(".").reduce((e,t)=>e[t],this.state)},use(e){return this.middleware.push(e),this},async runMiddleware(e,t){for(const a of this.middleware)a[e]&&await a[e](t)},addToHistory(e,t){if(!this.config.history.enabled||this.isTimeTraveling)return;const a={};Object.keys(this.state).forEach(e=>{this.state[e]&&(a[e]=JSON.parse(JSON.stringify(this.state[e])))}),this.history=this.history.slice(0,this.historyIndex+1),this.history.push({type:e,payload:void 0!==t?JSON.parse(JSON.stringify(t)):null,state:a,timestamp:Date.now()}),this.history.length>this.config.history.maxSize&&this.history.shift(),this.historyIndex=this.history.length-1},subscribe(e,t,a={}){if(!e||"string"!=typeof e)throw new Error("Path must be a string");if("function"!=typeof t)throw new Error("Callback must be a function");const n="sub_"+this.subscriberCount++,s={id:n,path:e,callback:t,options:{immediate:!0,deep:!1,...a},active:!0,timestamp:Date.now()};if(this.subscriptions.has(e)||this.subscriptions.set(e,new Map),this.subscriptions.get(e).set(n,s),this.activeSubscriptions.add(n),s.options.immediate){const a=this.get(e);try{t(a)}catch(r){this.handleError("Immediate subscription callback",r,"subscribe")}}return()=>this.unsubscribe(n)},unsubscribe(e){let t=!1;this.subscriptions.forEach((a,n)=>{a.has(e)&&(a.delete(e),this.activeSubscriptions.delete(e),t=!0,0===a.size&&this.subscriptions.delete(n))}),!t&&this.config.debug&&console.warn(`[StateManager] Subscription ${e} not found`)},notifySubscribers(e,t,a){const n=this.subscriptions.get(e);n&&n.forEach(n=>{if(n.active)try{if(n.options.deep&&"object"==typeof t&&JSON.stringify(t)===JSON.stringify(a))return;n.callback(t,a)}catch(s){this.handleError(`Subscription callback for ${e}`,s,"notifySubscribers"),n.active=!1}})},get(e){return e.split(".").reduce((e,t)=>null==e?void 0:e[t],this.state)},set(e,t){const a=e.split("."),n=a.pop(),s=a.length?a.reduce((e,t)=>e[t],this.state):this.state;s&&(s[n]=t,this.notifySubscribers(e,t))},cleanupSubscriptions(){const e=Date.now(),t=this.config.cleanup.maxSubscriptionAge||36e5;this.subscriptions.forEach((a,n)=>{a.forEach((a,n)=>{(!a.active||e-a.timestamp>t)&&this.unsubscribe(n)})})},timeTravel(e){try{if(!this.config.history.enabled||e<0||e>=this.history.length)throw new Error("Invalid history index");this.isTimeTraveling=!0;try{const t=this.history[e];if(!t||!t.state)throw new Error("Invalid history entry");Object.keys(t.state).forEach(e=>{t.state[e]&&(this.state[e]=JSON.parse(JSON.stringify(t.state[e])))}),this.historyIndex=e,Object.keys(this.state).forEach(e=>{this.notifyWatchers(e),this.state[e]&&void 0!==this.state[e].count&&this.notifySubscribers(`${e}.count`,this.state[e].count)})}catch(t){throw t}finally{this.isTimeTraveling=!1}}catch(t){throw ErrorManager.handle(t,{context:"StateManager.timeTravel",type:"error:state",data:{index:e}}),t}},persistState(){try{if(!this.config.persistence.enabled)return;const e=JSON.stringify(this.state);localStorage.setItem(this.config.persistence.key,e)}catch(e){throw ErrorManager.handle(e,{context:"StateManager.persistState",type:"error:state",data:{state:this.state}}),e}},async restoreState(){if(!this.config.persistence.enabled)return;const e=localStorage.getItem(this.config.persistence.key);if(e)try{const t=this.config.persistence.encrypt?await this.decrypt(e):JSON.parse(e);Object.assign(this.state,t)}catch(t){this.handleError("State restoration failed",t,"restoreState")}},batch(e){if(!this.config.batch.enabled)return e();const t=Date.now();this.batchQueue.set(t,e),this.batchTimeout&&clearTimeout(this.batchTimeout),this.batchTimeout=setTimeout(async()=>{const e=Array.from(this.batchQueue.values());this.batchQueue.clear();for(const t of e)await t()},this.config.batch.delay)},handleError(e,t,a){const n=t||new Error(e),s={message:e,error:t?{name:t.name,message:t.message,stack:t.stack}:null,timestamp:(new Date).toISOString(),moduleStates:{},activeSubscriptions:Array.from(this.activeSubscriptions),batchQueueSize:this.batchQueue.size};this.modules.forEach((e,t)=>{s.moduleStates[t]={hasState:!!this.state[t],subscriberCount:this.getModuleSubscriberCount(t)}}),ErrorManager.handle(n,{context:`StateManager.${a}`,type:"error:state",data:s,notify:!0})},reset(){this.modules.forEach((e,t)=>{e.initialState&&(this.state[t]=JSON.parse(JSON.stringify(e.initialState)))}),this.history=[],this.historyIndex=-1,this.computed.forEach(e=>e.cache=null),Object.keys(this.state).forEach(e=>{var t;this.notifyWatchers(e),void 0!==(null==(t=this.state[e])?void 0:t.count)&&this.notifySubscribers(`${e}.count`,this.state[e].count)}),this.config.persistence.enabled&&this.persistState()},isValidPath(e){if(!e||"string"!=typeof e)return!1;const t=e.split(".");return t.length>=1&&t.every(e=>e.length>0)}};window.StateManager=Y;const G={config:{enabled:!1,core:{offset:0,duration:500,easing:"easeInOutCubic"},selectors:{container:"body",content:"#main",tracked:"[data-scroll-track]",anchors:"[data-scroll-anchor]",waypoints:"[data-scroll-waypoint]",ignore:"[data-scroll-ignore]",reveal:"[data-scroll-reveal]",nav:"[data-scroll-nav]",sections:"[data-scroll-section]",parallax:"[data-parallax]",progress:".scroll-progress"},animation:{enabled:!0,types:{linear:e=>e,easeInOutCubic:e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,easeOutQuart:e=>1- --e*e*e*e,easeInQuad:e=>e*e}},performance:{throttle:16,debounce:100,passive:!0,observer:!0,requestAnimationFrame:{enabled:!0,maxFPS:60,skipThreshold:16},batchSize:5,maxQueue:100},restoration:{enabled:!0,key:"scroll_positions",ttl:864e5},mobile:{enabled:!0,touchAction:"pan-y",momentumScroll:!0,pullToRefresh:!1,touchThreshold:5},accessibility:{enabled:!0,announceChanges:!0,smoothFocus:!0,ariaLabels:!0,focusableSelectors:'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'},waypoints:{offset:0,threshold:.5,once:!1,delay:100},scroll:{infinite:{enabled:!1,threshold:100,loadMore:null},parallax:{enabled:!1,speed:.5},progress:{enabled:!1,color:"var(--color-primary)",height:"3px",zIndex:1e3},snap:{enabled:!1,type:"y",stop:!0,align:"start"},section:{highlight:!0,threshold:.5,activeClass:"active"},nav:{updateHash:!0,highlightClass:"active",smoothScroll:!0}},smoothScroll:{enabled:!1,autoScroll:!1,selector:'a[href^="#"]',excludeSelector:".no-smooth",hashChangeEnabled:!0}},state:{initialized:!1,isScrolling:!1,isLoading:!1,activeAnimation:null,positions:new Map,waypoints:new Map,observers:new Map,events:new Map,history:[],lastPosition:null,scrollRestoration:new Map,rafId:null,lastFrameTime:0,touchStartY:null,touchStartX:null,scrollQueue:[],activeSection:null,scrollDirection:null,scrollQueueLock:!1},async init(e={}){if(this.state.initialized)return this;if(this.config=Now.mergeConfig(this.config,e),!this.config.enabled)return this.state.disabled=!0,this;this.setupSmoothScroll(),window.requestAnimationFrame||(console.warn("requestAnimationFrame not supported"),this.config.animation.enabled=!1),window.IntersectionObserver||(console.warn("IntersectionObserver not supported"),this.config.performance.observer=!1);try{return this.setupErrorHandling(),await this.initializeCore(),this.config.performance.observer&&this.initializeObservers(),this.setupScrollTracking(),this.setupWaypoints(),this.config.mobile.enabled&&this.initializeMobileSupport(),this.config.accessibility.enabled&&this.initializeAccessibility(),this.config.restoration.enabled&&this.initScrollRestoration(),await this.initializeScrollFeatures(),this.setupEventListeners(),this.state.initialized=!0,this.emit("scroll:initialized"),this}catch(t){throw ErrorManager.handle("Initialization failed",{context:"ScrollManager.init",type:"scroll:error",data:{error:t}})}},async initializeCore(){this.contentArea=document.querySelector(this.config.selectors.content),this.contentArea||console.warn(`Main content area not found: ${this.config.selectors.content} in ${document.location.href}`),this.state.scrollQueue=[],"scrollRestoration"in history&&(history.scrollRestoration="manual"),this.config.animation.enabled&&this.initializeAnimationSystem()},setupSmoothScroll(){this.config.smoothScroll.enabled&&(this.config.smoothScroll.selector&&document.addEventListener("click",e=>{const t=e.target.closest(this.config.smoothScroll.selector);if(!t||t.matches(this.config.smoothScroll.excludeSelector))return;const a=t.getAttribute("href").slice(1);if(!a)return;const n=document.getElementById(a);n&&(e.preventDefault(),this.scrollTo(n,{offset:this.config.core.offset,duration:this.config.core.duration,easing:this.config.core.easing}))}),this.config.smoothScroll.hashChangeEnabled&&window.addEventListener("hashchange",()=>{const e=window.location.hash;if(!e)return;const t=document.querySelector(e);t&&this.scrollTo(t,{offset:this.config.core.offset,duration:this.config.core.duration,easing:this.config.core.easing})}),this.config.smoothScroll.autoScroll&&window.location.hash&&setTimeout(()=>{const e=document.querySelector(window.location.hash);e&&this.scrollTo(e,{offset:this.config.core.offset,duration:this.config.core.duration,easing:this.config.core.easing})},100))},async initializeScrollFeatures(){const{scroll:e}=this.config;e.infinite.enabled&&this.initInfiniteScroll(e.infinite.loadMore),e.parallax.enabled&&this.initParallax(),e.progress.enabled&&this.initProgressBar(),e.snap.enabled&&this.initScrollSnap(),e.section.highlight&&this.initSectionHighlight(),e.nav.updateHash&&this.initScrollNav()},initializeObservers(){"IntersectionObserver"in window&&this.state.observers.set("intersection",new IntersectionObserver(e=>this.handleIntersection(e),{threshold:[0,.25,.5,.75,1],rootMargin:"20px"})),"MutationObserver"in window&&this.state.observers.set("mutation",new MutationObserver(e=>this.handleMutations(e))),"ResizeObserver"in window&&this.state.observers.set("resize",new ResizeObserver(e=>this.handleResize(e))),this.startObservers()},handleIntersection(e){e.forEach(e=>{if(this.state.waypoints.forEach((t,a)=>{if(t.element===e.target){e.isIntersecting&&!t.triggered&&(t.options.callback&&t.options.callback(e),this.emit("waypoint:trigger",{id:a,entry:e}),t.options.once&&(t.triggered=!0))}}),e.target.hasAttribute("data-scroll-reveal")&&e.isIntersecting&&(e.target.classList.add("revealed"),this.emit("scroll:reveal",{element:e.target})),e.target.hasAttribute("data-scroll-section")&&e.isIntersecting){const t=e.target.id;this.state.activeSection=t,this.emit("section:active",{id:t}),this.config.scroll.nav.updateHash&&t&&history.replaceState(null,null,`#${t}`),document.querySelectorAll(this.config.selectors.nav).forEach(e=>{e.querySelectorAll("a").forEach(e=>{e.classList.toggle(this.config.scroll.nav.highlightClass,e.getAttribute("href")===`#${t}`)})})}})},handleMutations(e){let t=!1;e.forEach(e=>{e.addedNodes.forEach(e=>{var a,n,s;1===e.nodeType&&((null==(a=e.matches)?void 0:a.call(e,this.config.selectors.waypoints))&&(t=!0),(null==(n=e.matches)?void 0:n.call(e,this.config.selectors.reveal))&&(null==(s=this.state.observers.get("intersection"))||s.observe(e)))}),e.removedNodes.forEach(e=>{var a;1===e.nodeType&&(null==(a=e.matches)?void 0:a.call(e,this.config.selectors.waypoints))&&(t=!0)})}),t&&this.setupWaypoints()},handleResize(e){this.emit("scroll:resize",{entries:e})},startObservers(){const e=document.querySelector(this.config.selectors.container),t=this.state.observers.get("mutation");t&&e&&t.observe(e,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["data-scroll-track","data-scroll-waypoint"]});const a=this.state.observers.get("intersection");a&&(document.querySelectorAll(this.config.selectors.waypoints).forEach(e=>{a.observe(e)}),document.querySelectorAll(this.config.selectors.reveal).forEach(e=>{a.observe(e)}),document.querySelectorAll(this.config.selectors.sections).forEach(e=>{a.observe(e)}));const n=this.state.observers.get("resize");n&&e&&n.observe(e)},initScrollNav(){const e=document.querySelector(this.config.selectors.nav);e&&e.addEventListener("click",e=>{var t;const a=e.target.closest("a");if(!a)return;const n=null==(t=a.getAttribute("href"))?void 0:t.slice(1);if(!n)return;e.preventDefault();const s=document.getElementById(n);s&&this.scrollTo(s,{duration:this.config.scroll.nav.smoothScroll?this.config.core.duration:0})})},setupEventListeners(){this.on("route:changed",e=>{this.handleRouteChange(e.data)}),document.addEventListener("keydown",e=>{"Home"===e.key?(e.preventDefault(),this.scrollToTop()):"End"===e.key?(e.preventDefault(),this.scrollToBottom()):"PageUp"===e.key?(e.preventDefault(),window.scrollBy({top:.9*-window.innerHeight,behavior:"smooth"})):"PageDown"===e.key&&(e.preventDefault(),window.scrollBy({top:.9*window.innerHeight,behavior:"smooth"}))})},removeAllListeners(){const e=Now.getManager("event");this.state.events.forEach((t,a)=>{t.forEach(n=>{t.delete(n),(null==e?void 0:e.off)&&e.off(a,n)})}),this.state.events.clear(),(null==e?void 0:e.emit)&&e.emit("scroll:cleanup",{timestamp:Date.now(),source:"ScrollManager"})},cleanup(){this.cancelScroll(),this.removeAllListeners(),this.state.observers.forEach(e=>{(null==e?void 0:e.disconnect)&&e.disconnect()}),this.state.observers.clear(),this.debounceTimers&&(Object.values(this.debounceTimers).forEach(e=>{clearTimeout(e)}),this.debounceTimers={}),this.state.positions.clear(),this.state.waypoints.clear(),this.state.scrollQueue=[],this.state.history=[],this.state.events.clear(),this.state.initialized=!1,this.state.isScrolling=!1,this.state.isProcessingEvents=!1,this.announcer&&(this.announcer.remove(),this.announcer=null)},cleanSelector:e=>e.replace(/[^\w\s\-_]/g,""),async scrollTo(e,t={}){if(this.config.enabled&&e)try{let a=null;if("string"==typeof e?(e=this.cleanSelector(e),a=document.querySelector(e)):e instanceof HTMLElement&&(a=e),!a)throw new Error("Invalid scroll target");if(a.matches(this.config.selectors.ignore))return;t={offset:Number(t.offset)||0,duration:Math.max(0,Number(t.duration))||500,easing:"string"==typeof t.easing?t.easing:"easeInOutCubic"};const n={offset:this.config.core.offset,duration:this.config.core.duration,easing:this.config.core.easing,...t};this.cancelScroll();const s=a.getBoundingClientRect(),r=window.pageYOffset,i=s.top+r-n.offset;if(this.state.isScrolling)return void this.queueScroll(i,n);this.emit("scroll:start",{element:a,options:n}),this.state.isScrolling=!0,this.config.animation.enabled&&n.duration>0?await this.animateScroll(i,n):window.scrollTo({top:i,behavior:"auto"}),!1!==n.focus&&this.config.accessibility.smoothFocus&&a.focus({preventScroll:!0}),this.state.isScrolling=!1,this.processScrollQueue(),this.updateScrollPosition(),this.emit("scroll:complete",{element:a,position:this.getScrollPosition()})}catch(a){ErrorManager.handle("Scroll failed",{context:"ScrollManager.scrollTo",type:"scroll:error",data:{error:a}}),this.state.isScrolling=!1}},cancelScroll(){this.state.activeAnimation&&(cancelAnimationFrame(this.state.activeAnimation),this.state.activeAnimation=null,this.state.isScrolling=!1,this.emit("scroll:cancel"))},async scrollToContent(e={}){this.contentArea&&await this.scrollTo(this.contentArea,e)},async scrollToTop(e={}){await this.scrollTo(document.documentElement,e)},async scrollToBottom(e={}){const t=Array.from(document.body.children).pop();await this.scrollTo(t,e)},addWaypoint(e,t,a={}){if(!e||"string"!=typeof e)throw new Error("Invalid waypoint ID");if(!(t instanceof HTMLElement))throw new Error("Invalid waypoint element");if(this.state.waypoints.has(e))throw new Error(`Waypoint ${e} already exists`);const n={element:t,options:{offset:a.offset||this.config.waypoints.offset,threshold:a.threshold||this.config.waypoints.threshold,once:a.once||this.config.waypoints.once,callback:a.callback},triggered:!1};if(this.state.waypoints.set(e,n),this.state.observers.has("intersection")){this.state.observers.get("intersection").observe(t)}},removeWaypoint(e){const t=this.state.waypoints.get(e);if(t){if(this.state.observers.has("intersection")){this.state.observers.get("intersection").unobserve(t.element)}this.state.waypoints.delete(e)}},handleScrollDirection(){var e;const t=window.pageYOffset>(null==(e=this.state.lastPosition)?void 0:e.y)?"down":"up";t!==this.state.scrollDirection&&(this.state.scrollDirection=t,this.emit("scroll:direction",{direction:t}),document.body.setAttribute("data-scroll-direction",t))},queueScroll(e,t){this.state.scrollQueue.length>=this.config.performance.maxQueue&&this.state.scrollQueue.shift(),this.state.scrollQueue.push({targetY:e,options:t})},async processScrollQueue(){if(!this.scrollQueueLock)try{for(this.scrollQueueLock=!0;this.state.scrollQueue.length>0;){const e=this.state.scrollQueue.shift();await this.animateScroll(e.targetY,e.options)}}finally{this.scrollQueueLock=!1}},getScrollPosition(){return{x:window.pageXOffset,y:window.pageYOffset,direction:this.state.scrollDirection,timestamp:Date.now()}},updateScrollPosition(){const e=this.getScrollPosition();this.state.lastPosition=e,this.handleScrollDirection(),this.state.history.push(e),this.state.history.length>50&&this.state.history.shift(),this.config.restoration.enabled&&this.state.scrollRestoration.set(window.location.pathname,e)},setupErrorHandling(){window.addEventListener("error",e=>{e.error&&ErrorManager.handle(e.error,{context:"ScrollManager.setupErrorHandling",type:"scroll:error"})}),window.addEventListener("unhandledrejection",e=>{e.reason&&ErrorManager.handle(e.reason,{context:"ScrollManager.setupErrorHandling",type:"scroll:error"})})},initializeAnimationSystem(){this.easingFunctions={linear:e=>e,easeInOutCubic:e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,easeOutQuart:e=>1- --e*e*e*e,easeInQuad:e=>e*e,easeOutBack:e=>{const t=1.70158;return 1+2.70158*Math.pow(e-1,3)+t*Math.pow(e-1,2)}}},animateScroll(e,t={}){return new Promise(a=>{const n=window.pageYOffset,s=performance.now();let r=null;const i=t.duration||this.config.core.duration,o=this.easingFunctions[t.easing]||this.easingFunctions[this.config.core.easing];let l=performance.now(),c=0;const animate=t=>{try{if(r&&t-r<16)return void(this.state.rafId=requestAnimationFrame(animate));r=t;const d=t-l;if(l=t,d>this.config.performance.requestAnimationFrame.skipThreshold&&(c=Math.floor(d/16)-1),c>0)return c--,void(this.state.rafId=requestAnimationFrame(animate));const u=t-s,h=Math.min(u/i,1);if(h<1){const t=o(h),a=n+(e-n)*t;window.scrollTo(0,a),this.state.rafId=requestAnimationFrame(animate)}else window.scrollTo(0,e),this.state.rafId=null,this.emit("scroll:animationComplete",{startY:n,targetY:e,duration:u}),a()}catch(d){ErrorManager.handle(d,{context:"ScrollManager.animateScroll",type:"scroll:error"}),window.scrollTo(0,e),this.state.rafId=null,a()}};this.state.rafId=requestAnimationFrame(animate)})},easingFunctions:{linear:e=>e,easeInOutCubic:e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,easeOutQuart:e=>1- --e*e*e*e,easeInQuad:e=>e*e,easeOutBack:e=>{const t=1.70158;return 1+2.70158*Math.pow(e-1,3)+t*Math.pow(e-1,2)}},onVirtualDOMUpdate(e){this.virtualDOMHooks.push(e)},notifyVirtualDOM(){this.virtualDOMHooks.forEach(e=>{requestIdleCallback(()=>e())})},throttle(e,t){let a;return(...n)=>{a||(e.apply(this,n),a=!0,setTimeout(()=>a=!1,t))}},debounce(e,t){let a;return(...n)=>{clearTimeout(a),a=setTimeout(()=>e.apply(this,n),t)}},setupScrollTracking(){const e=this.throttle(()=>{if(this.state.isScrolling)return;const e=this.getScrollPosition();this.updateScrollState(e),this.handleScrollDirection(),this.emit("scroll:progress",e)},this.config.performance.throttle),t=this.debounce(()=>{if(!this.state.isScrolling){const e=this.getScrollPosition();this.state.lastPosition=e,this.emit("scroll:end",e),this.processScrollQueue()}},this.config.performance.debounce);window.addEventListener("scroll",e,{passive:this.config.performance.passive}),window.addEventListener("scroll",t,{passive:this.config.performance.passive})},updateScrollState(e){this.state.lastPosition=e,this.state.history.push(e),this.state.history.length>50&&this.state.history.shift()},setupWaypoints(){const e=document.querySelectorAll(this.config.selectors.waypoints);if(e.forEach(e=>{const t=e.dataset.scrollWaypoint,a=parseInt(e.dataset.scrollOffset)||this.config.waypoints.offset,n=e.dataset.scrollCallback&&window[e.dataset.scrollCallback];this.addWaypoint(t||Utils.generateUUID(),e,{offset:a,callback:n,threshold:this.config.waypoints.threshold,once:this.config.waypoints.once})}),this.state.observers.has("intersection")){const t=this.state.observers.get("intersection");e.forEach(e=>{t.observe(e)})}},addWaypoint(e,t,a={}){const n={element:t,options:{offset:a.offset||this.config.waypoints.offset,threshold:a.threshold||this.config.waypoints.threshold,once:a.once||this.config.waypoints.once,callback:a.callback},triggered:!1};if(this.state.waypoints.set(e,n),this.state.observers.has("intersection")){this.state.observers.get("intersection").observe(t)}},initializeMobileSupport(){if(!this.config.mobile.enabled)return;const e=document.querySelector(this.config.selectors.container);e&&(e.style.touchAction=this.config.mobile.touchAction,e.addEventListener("touchstart",e=>{this.state.touchStartY=e.touches[0].clientY,this.state.touchStartX=e.touches[0].clientX},{passive:!0}),e.addEventListener("touchmove",e=>{if(!this.state.touchStartY)return;const t=e.touches[0].clientY,a=e.touches[0].clientX,n=this.state.touchStartY-t,s=this.state.touchStartX-a,r=window.pageYOffset,i=document.documentElement.scrollHeight,o=document.documentElement.clientHeight;(r<=0&&n<0||r+o>=i&&n>0)&&e.preventDefault(),this.emit("touch:move",{diffY:n,diffX:s,originalEvent:e})},{passive:!1}),e.addEventListener("touchend",()=>{this.state.touchStartY=null,this.state.touchStartX=null},{passive:!0}),this.config.mobile.momentumScroll&&(e.style.WebkitOverflowScrolling="touch"),this.config.mobile.pullToRefresh||(document.body.style.overscrollBehavior="none"))},initializeAccessibility(){this.config.accessibility.enabled&&(this.config.accessibility.announceChanges&&(this.announcer=document.createElement("div"),this.announcer.setAttribute("aria-live","polite"),this.announcer.className="sr-only",this.announcer.style.cssText="\n      position: absolute;\n      width: 1px;\n      height: 1px;\n      padding: 0;\n      margin: -1px;\n      overflow: hidden;\n      clip: rect(0, 0, 0, 0);\n      white-space: nowrap;\n      border: 0;\n    ",document.body.appendChild(this.announcer)),this.config.accessibility.smoothFocus&&document.addEventListener("focus",e=>{const t=e.target;if(t.matches(this.config.accessibility.focusableSelectors)){const e=t.getBoundingClientRect();e.top>=0&&e.left>=0&&e.bottom<=window.innerHeight&&e.right<=window.innerWidth||this.scrollTo(t,{offset:this.config.core.offset,duration:this.config.core.duration})}},!0),this.config.accessibility.ariaLabels&&document.querySelectorAll(this.config.selectors.waypoints).forEach(e=>{e.getAttribute("aria-label")||e.setAttribute("aria-label","Scroll waypoint")}),this.on("scroll:complete",e=>{if(this.announcer&&e.element){const t=e.element.getAttribute("aria-label")||e.element.innerText||"Scrolled content";this.announcer.textContent=`Scrolled to ${t}`}}))},on(e,t){this.state.events.has(e)||this.state.events.set(e,new Set),this.state.events.get(e).add(t);const a=Now.getManager("event");return(null==a?void 0:a.on)&&a.on(e,t),this},off(e,t){const a=this.state.events.get(e);a&&a.delete(t);const n=Now.getManager("event");return(null==n?void 0:n.off)&&n.off(e,t),this},emit(e,t){const a=this.state.events.get(e);a&&a.forEach(a=>{try{a(t)}catch(n){ErrorManager.handle(`Error in scroll event handler for ${e}`,{context:"ScrollManager.emit",data:{error:n}})}}),EventManager.emit(e,{...t,source:"ScrollManager"})},initScrollRestoration(){if(!this.config.restoration.enabled)return;const e=localStorage.getItem(this.config.restoration.key);if(e)try{const t=JSON.parse(e);Object.entries(t).forEach(([e,t])=>{Date.now()-t.timestamp<this.config.restoration.ttl&&this.state.scrollRestoration.set(e,t)})}catch(t){ErrorManager.handle("Failed to restore scroll positions",{context:"ScrollManager.initScrollRestoration",data:{error:t}})}window.addEventListener("beforeunload",()=>{const e={};this.state.scrollRestoration.forEach((t,a)=>{e[a]=t}),localStorage.setItem(this.config.restoration.key,JSON.stringify(e))}),window.addEventListener("popstate",()=>{const e=this.state.scrollRestoration.get(window.location.pathname);e&&window.scrollTo(0,e.y)})},initializeScrollFeatures(){const{scroll:e}=this.config;e.section.highlight&&this.initSectionHighlight(),e.nav.updateHash&&this.initScrollNav(),e.infinite.enabled&&this.initInfiniteScroll(e.infinite.loadMore),e.parallax.enabled&&this.initParallax()},initSectionHighlight(){const e=document.querySelectorAll(this.config.selectors.sections),t=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target.id;this.state.activeSection=t,this.emit("section:active",{id:t}),this.config.scroll.nav.updateHash&&t&&history.replaceState(null,null,`#${t}`),document.querySelectorAll(this.config.selectors.nav).forEach(e=>{e.querySelectorAll("a").forEach(e=>{e.classList.toggle(this.config.scroll.nav.highlightClass,e.getAttribute("href")===`#${t}`)})})}})},{threshold:this.config.scroll.section.threshold});e.forEach(e=>t.observe(e))},initParallax(){const e=document.querySelectorAll(this.config.selectors.parallax);window.addEventListener("scroll",()=>{const t=window.scrollY;e.forEach(e=>{const a=e.dataset.parallaxSpeed||this.config.scroll.parallax.speed,n=-t*a;e.style.transform=`translate3d(0, ${n}px, 0)`})},{passive:!0})},initInfiniteScroll(e){if(!e)return;const t=this.throttle(()=>{if(this.state.isLoading)return;document.documentElement.scrollHeight-(window.scrollY+window.innerHeight)<this.config.scroll.infinite.threshold&&(this.state.isLoading=!0,Promise.resolve(e()).finally(()=>{this.state.isLoading=!1}))},100);window.addEventListener("scroll",t,{passive:!0})},handleRouteChange(e){if(!e||!e.path)return;if(e.path.includes("#")){const[,t]=e.path.split("#");if(t)return void setTimeout(()=>{const e=document.getElementById(t);e&&this.scrollTo(e,{offset:this.config.core.offset,duration:this.config.core.duration})},100)}const t=document.querySelector(this.config.selectors.content);t?this.scrollTo(t,{offset:this.config.core.offset,duration:this.config.core.duration}):window.scrollTo({top:0,behavior:this.config.animation.enabled?"smooth":"auto"}),this.state.activeSection=null},handleScrollProgress(e){if(!this.config.scroll.progress.enabled)return;const t=document.documentElement.scrollHeight-window.innerHeight,a=e.y/t*100,n=document.querySelector(this.config.selectors.progress);n&&(n.style.width=`${a}%`),this.emit("scroll:progress",{position:e,progress:a,total:t})},handleResize(e){e.forEach(e=>{this.updateScrollPosition();const t=this.getScrollPosition();this.handleScrollProgress(t)}),this.emit("scroll:resize",{entries:e,timestamp:Date.now()})}};(null==(o=window.Now)?void 0:o.registerManager)&&Now.registerManager("scroll",G),window.ScrollManager=G;const K={config:{animation:!0,duration:200,draggable:!0,modal:!0,closeOnEscape:!0,closeOnBackdrop:!0,preventScroll:!0,baseZIndex:1e3,focusTrap:!0,keyboard:!0,templates:{alert:'\n        <div class="dialog-header">\n          <h2 class="dialog-title"></h2>\n          <button class="dialog-close" aria-label="Close"></button>\n        </div>\n        <div class="dialog-body"></div>\n        <div class="dialog-footer"></div>\n      ',confirm:'\n        <div class="dialog-header">\n          <h2 class="dialog-title"></h2>\n          <button class="dialog-close" aria-label="Close"></button>\n        </div>\n        <div class="dialog-body"></div>\n        <div class="dialog-footer"></div>\n      ',prompt:'\n        <div class="dialog-header">\n          <h2 class="dialog-title"></h2>\n          <button class="dialog-close" aria-label="Close"></button>\n        </div>\n        <div class="dialog-body">\n          <input type="text" class="dialog-input" />\n        </div>\n        <div class="dialog-footer"></div>\n      '}},state:{dialogs:new Map,activeDialogs:[],templates:new Map,nextId:1,previousFocus:null,initialized:!1,errorHandlers:new Set},async init(e={}){return this.state.initialized||(this.config={...this.config,...e},this.backdropManager=Now.getManager("backdrop"),this.config.keyboard&&this.setupKeyboardEvents(),e.templates&&Object.entries(e.templates).forEach(([e,t])=>{this.state.templates.set(e,t)}),this.state.initialized=!0),this},alert(e,t=null,a={}){return t=t||Now.translate("Alert"),new Promise(n=>{const s=this.createDialog({template:"alert",title:t,message:e,buttons:{ok:{text:Now.translate("OK"),class:"btn-primary",callback:()=>n(!0)}},...a});this.show(s)})},confirm(e,t=null,a={}){return t=t||Now.translate("Confirm"),new Promise(n=>{const s=this.createDialog({template:"confirm",title:t,message:e,buttons:{cancel:{text:Now.translate("Cancel"),class:"text",callback:()=>n(!1)},confirm:{text:Now.translate("Confirm"),class:"btn-primary",callback:()=>n(!0)}},...a});this.show(s)})},prompt(e,t="",a=null,n={}){return a=a||Now.translate("Prompt"),new Promise(s=>{const r=this.createDialog({template:"prompt",title:a,message:e,defaultValue:t,buttons:{cancel:{text:Now.translate("Cancel"),class:"text",callback:()=>s(null)},ok:{text:Now.translate("OK"),class:"btn-primary",callback:e=>{const t=e.querySelector(".dialog-input");s((null==t?void 0:t.value)??null)}}},...n});this.show(r),setTimeout(()=>{const e=r.querySelector(".dialog-input");e&&(e.value=t,e.select())},this.config.duration)})},custom(e){const t=this.createDialog({template:e.template||"alert",...e});return e.onShow&&t.addEventListener("dialog:shown",e.onShow),e.onClose&&t.addEventListener("dialog:closed",e.onClose),this.show(t),t},createDialog(e){try{const t=this.state.nextId++,a=document.createElement("div");a.className=`dialog ${e.customClass||""}`,a.setAttribute("role","dialog"),a.setAttribute("aria-modal","true"),a.id=`dialog-${t}`;const n=this.state.templates.get(e.template)||this.config.templates[e.template]||this.config.templates.alert;if(a.innerHTML=n,e.title){const n=a.querySelector(".dialog-title");n&&(n.textContent=e.title,a.setAttribute("aria-labelledby",n.id=`dialog-title-${t}`))}if(e.message){const t=a.querySelector(".dialog-body");t&&("string"==typeof e.message?t.innerHTML=e.message:e.message instanceof HTMLElement&&t.appendChild(e.message))}return a.querySelectorAll(".dialog-close").forEach(e=>{e.addEventListener("click",()=>this.close(a))}),this.setupButtons(a,e.buttons),this.config.draggable&&!1!==e.draggable&&this.setupDraggable(a),this.config.focusTrap&&this.setupFocusTrap(a),a}catch(t){throw this.handleError("Create Dialog",t,"create"),t}},setupFocusTrap(e){const t=e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');if(0===t.length)return;const a=t[0],n=t[t.length-1];e.addEventListener("keydown",e=>{"Tab"===e.key&&(e.shiftKey?document.activeElement===a&&(e.preventDefault(),n.focus()):document.activeElement===n&&(e.preventDefault(),a.focus()))})},setupDraggable(e){const t=e.querySelector(".dialog-header");if(!t)return;t.style.cursor="move";let a=!1,n=0,s=0,r=0,i=0;const startDrag=t=>{if(t.target.closest("button"))return;const o="mousedown"===t.type?t:t.touches[0];a=!0,n=o.clientX,s=o.clientY,r=parseInt(e.style.left)||0,i=parseInt(e.style.top)||0,e.classList.add("dragging")},doDrag=t=>{if(!a)return;t.preventDefault();const o="mousemove"===t.type?t:t.touches[0],l=o.clientX-n,c=o.clientY-s,d=r+l,u=i+c,h=window.innerWidth-e.offsetWidth,p=window.innerHeight-e.offsetHeight;e.style.left=Math.min(Math.max(0,d),h)+"px",e.style.top=Math.min(Math.max(0,u),p)+"px"},stopDrag=()=>{a&&(a=!1,e.classList.remove("dragging"))};t.addEventListener("mousedown",startDrag),document.addEventListener("mousemove",doDrag),document.addEventListener("mouseup",stopDrag),t.addEventListener("touchstart",startDrag,{passive:!1}),document.addEventListener("touchmove",doDrag,{passive:!1}),document.addEventListener("touchend",stopDrag),document.addEventListener("touchcancel",stopDrag)},setupButtons(e,t={}){const a=e.querySelector(".dialog-footer");a&&(a.innerHTML="",Object.entries(t).forEach(([t,n])=>{const s=document.createElement("button");s.type="button",s.className=`btn ${n.class||"text"}`,s.textContent=n.text,n.callback&&(s.onclick=t=>{t.preventDefault(),n.callback(e),this.close(e)}),n.attrs&&Object.entries(n.attrs).forEach(([e,t])=>{s.setAttribute(e,t)}),a.appendChild(s)}))},show(e){var t;if(!e||this.state.dialogs.has(e.id))return e;this.state.previousFocus=document.activeElement;const a=e.offsetWidth||320,n=e.offsetHeight||200,s=Math.max(0,(window.innerWidth-a)/2),r=Math.max(0,(window.innerHeight-n)/2);e.style.left=s+"px",e.style.top=r+"px";const i=null==(t=this.backdropManager)?void 0:t.show(e,()=>{this.config.closeOnBackdrop&&this.close(e)}),o={element:e,backdropId:i,options:{preventScroll:this.config.preventScroll}};this.state.dialogs.set(e.id,o),this.state.activeDialogs.push(e.id);const l=this.config.baseZIndex+2*this.state.activeDialogs.length;return e.style.zIndex=l,this.config.preventScroll&&(document.body.style.overflow="hidden"),document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("show");const t=e.querySelector(".dialog-button-primary"),a=e.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');t?t.focus():a&&a.focus(),e.dispatchEvent(new CustomEvent("dialog:shown",{detail:{dialog:e}}))}),e},bringToFront(e){try{const t=Math.max(...Array.from(this.state.dialogs.values()).map(e=>parseInt(e.element.style.zIndex)||0)),a=Math.max(this.config.baseZIndex,t+2);e.style.zIndex=a;const n=this.state.dialogs.get(e.id);if(null==n?void 0:n.backdropId){const e=document.getElementById(n.backdropId);e&&(e.style.zIndex=a-1)}const s=this.state.activeDialogs.indexOf(e.id);s>-1&&(this.state.activeDialogs.splice(s,1),this.state.activeDialogs.push(e.id))}catch(t){this.handleError("Bring To Front",t,"bringToFront")}},close(e){var t;if(!e)return;const a=this.state.dialogs.get(e.id);a&&(e.classList.remove("show"),e.classList.add("hiding"),a.backdropId&&(null==(t=this.backdropManager)||t.hide(a.backdropId)),setTimeout(()=>{e.remove(),this.state.dialogs.delete(e.id);const t=this.state.activeDialogs.indexOf(e.id);t>-1&&this.state.activeDialogs.splice(t,1),0===this.state.activeDialogs.length&&a.options.preventScroll&&(document.body.style.overflow=""),this.state.previousFocus&&document.contains(this.state.previousFocus)&&this.state.previousFocus.focus(),e.dispatchEvent(new CustomEvent("dialog:closed",{detail:{dialog:e}}))},this.config.duration))},closeAll(){[...this.state.activeDialogs].forEach(e=>{const t=document.getElementById(e);t&&this.close(t)})},setupKeyboardEvents(){document.addEventListener("keydown",e=>{if(0===this.state.activeDialogs.length)return;const t=this.state.activeDialogs[this.state.activeDialogs.length-1],a=document.getElementById(t);a&&"Escape"===e.key&&this.config.closeOnEscape&&(e.preventDefault(),this.close(a))})},translate(e,t={}){const a=Now.getManager("i18n");return a?a.translate(e,t):e},destroy(){this.closeAll(),this.config.keyboard&&document.removeEventListener("keydown",this.handleKeydown),this.state={dialogs:new Map,activeDialogs:[],templates:new Map,nextId:1,previousFocus:null,initialized:!1,errorHandlers:new Set},this.config=null},cleanupDialog(e){try{const t=e.querySelector(".dialog-header");t&&(t.removeEventListener("mousedown",t._startDrag),t.removeEventListener("touchstart",t._startDrag)),e.removeEventListener("keydown",e._keyHandler),e._dragHandlers&&Object.entries(e._dragHandlers).forEach(([e,t])=>{document.removeEventListener(e,t)}),e._dragHandlers=null,e._keyHandler=null,e._startDrag=null,e.removeAttribute("aria-labelledby"),e.removeAttribute("aria-modal"),e.removeAttribute("role"),e.className="dialog",e.style=""}catch(t){this.handleError("Cleanup Dialog",t,"cleanup")}},handleError(e,t,a){ErrorManager.handle(e,{context:`DialogManager.${a}`,type:"error:dialog",data:{error:{name:t.name,message:t.message,stack:t.stack}},notify:!0});try{this.closeAll()}catch(n){console.error("Dialog cleanup failed:",n)}}};(null==(l=window.Now)?void 0:l.registerManager)&&Now.registerManager("dialog",K),window.DialogManager=K;const J={config:{debug:!1,cache:!0,cacheDuration:3e5,security:{allowedOrigins:[],allowedExtensions:[".html",".htm"],maxContentSize:2097152,sanitize:!0,validateMarkup:!0,allowedTags:["html","head","body","title","meta","link","style","base","header","nav","main","section","article","aside","footer","h1","h2","h3","h4","h5","h6","p","br","hr","pre","blockquote","ol","ul","li","dl","dt","dd","a","em","strong","small","s","cite","code","sub","sup","span","mark","b","i","u","var","time","img","figure","figcaption","audio","video","source","track","iframe","embed","object","param","picture","template","canvas","svg","math","table","caption","thead","tbody","tfoot","tr","th","td","colgroup","col","summary","form","input","textarea","button","select","option","label","fieldset","legend","datalist","output","div","details","dialog","meter","progress","ruby","rt","rp","abbr","kbd","samp","font","center","big","strike","marquee"],allowedAttributes:{all:["id","class","title","lang","dir","hidden","tabindex","translate","draggable","aria-*","role","data-*","accesskey","contenteditable","contextmenu"],img:["src","alt","width","height","loading","srcset","sizes","decoding","referrerpolicy","crossorigin"],a:["href","target","rel","download","hreflang","type"],input:["type","value","placeholder","required","checked","disabled","readonly","maxlength","minlength","pattern","size","step","multiple","min","max","list","inputmode","autocomplete","autofocus","name"],select:["value","placeholder","multiple","required","size","autofocus","name"],option:["value","selected","disabled","label"],textarea:["placeholder","required","rows","cols","maxlength","minlength","readonly","autofocus","name"],button:["type","disabled","name","value","autofocus","form"],form:["action","method","enctype","autocomplete","novalidate","target","name","accept-charset"],label:["for"],time:["datetime"],iframe:["src","width","height","allow","loading","sandbox","referrerpolicy","name"],meta:["name","content","http-equiv","charset"]}},events:{cleanupInterval:6e4},cleanup:{interval:6e4,maxCacheAge:18e5,maxHandlerAge:3e5,batchSize:100}},state:{cache:new Map,initialized:!1,serverPaths:new Set,handlers:new Map,cleanupInterval:null,lastCleanup:Date.now(),itemTimestamps:new Map,performanceObserver:null,activeScripts:new Map},async init(e={}){return this.state.initialized||(0===this.config.security.allowedOrigins.length&&this.config.security.allowedOrigins.push(window.location.origin),this.config=Now.mergeConfig(this.config,e),e.serverPaths&&(this.state.serverPaths=new Set(e.serverPaths)),this.setupPerformanceMonitoring(),this.state.initialized=!0,this.state.cleanupInterval=setInterval(()=>{this.cleanupHandlers(),this.cleanupCache()},this.config.events.cleanupInterval),window.Now.handleEvent=(e,t,a)=>{const n=this.state.handlers.get(e);n?n.call(a):ErrorManager.handle(`Handler with ID ${e} not found`,{context:"TemplateManager.window.Now.handleEvent",data:{handlerId:e,element:t,event:a}})},this.startCleanupInterval(),EventManager.on("route:before",()=>{this.cleanupScripts()},{priority:-100})),this},async loadFromServer(e){var t,a,n,s;if(!this.state.initialized)throw new Error("TemplateManager is not initialized");try{!window.Now||"function"!=typeof window.Now.resolvePath||e.trim().startsWith("<")||/^(https?:)?\/\//i.test(e)?!(null==(a=null==(t=Now.config)?void 0:t.paths)?void 0:a.templates)||e.trim().startsWith("<")||e.startsWith(Now.config.paths.templates)||(e=Now.config.paths.templates+e):e=window.Now.resolvePath(e,"templates")}catch(m){!(null==(s=null==(n=Now.config)?void 0:n.paths)?void 0:s.templates)||e.trim().startsWith("<")||e.startsWith(Now.config.paths.templates)||(e=Now.config.paths.templates+e)}const r=performance.now();if(!this.isValidPath(e))throw new Error(`Invalid template path format: ${e}`);const i=`template:${e}`;if(this.config.cache){const e=this.state.cache.get(i);if(e&&e.expires>Date.now())return e.content}const o=new URL(e,window.location.origin);if(await this.validateRequest(o),!window.http||"function"!=typeof window.http.get)throw new Error("HttpClient (window.http) is required but not available");const l=await window.http.get(o.toString(),{throwOnError:!1,headers:{Accept:"text/html"}});if(!l.success)throw new Error(`Failed to fetch template: ${e}`);const c=l.headers["content-type"];if(!(null==c?void 0:c.includes("text/html")))throw new Error("Invalid content type: Expected HTML");const d=l.headers["content-length"];if(d&&parseInt(d)>this.config.security.maxContentSize)throw new Error("Template size exceeds limit");const u="string"==typeof l.data?l.data:await l.data.text(),h=await this.processContent(u,e);this.config.cache&&(this.state.cache.set(i,{content:h,expires:Date.now()+this.config.cacheDuration}),this.state.itemTimestamps.set(i,Date.now()));const p=performance.now();return this.recordPerformance("template-load",{path:e,duration:p-r,size:u.length}),h},async validateRequest(e){if(!this.config.security.allowedOrigins.includes(e.origin))throw new Error("Invalid origin");if(!e.pathname.toLowerCase().endsWith(".html"))throw new Error("Invalid file type");return!0},async processContent(e,t){try{const a=document.createElement("div");a.innerHTML=e.trim();const n=Now.getManager("component"),s=null==n?void 0:n.getContextForPath(t);return s&&(this.processDataDirectives(a,s),this.processInterpolation(a,s)),this.config.security.sanitize&&this.sanitizeElement(a),this.config.security.validateMarkup&&await this.validateMarkup(a),a.innerHTML}catch(a){throw ErrorManager.handle(a,{context:"TemplateManager.processContent",data:{content:e,path:t}})}},sanitizeElement(e){try{let t=e;if("string"==typeof e){const a=document.createElement("div");a.innerHTML=e,t=a}if(window.DOMPurify)DOMPurify.sanitize(t,{ALLOWED_TAGS:this.config.security.allowedTags,ALLOWED_ATTR:Object.values(this.config.security.allowedAttributes).flat(),IN_PLACE:!0});else{const e=[],a=[],n=document.createTreeWalker(t,NodeFilter.SHOW_ELEMENT,null,!1);let s=n.currentNode;for(;s;){const t=s.tagName.toLowerCase();this.config.security.allowedTags.includes(t)?s.attributes&&Array.from(s.attributes).forEach(e=>{var n;const r=e.name.toLowerCase(),i=this.config.security.allowedAttributes.all.some(e=>e.endsWith("*")?r.startsWith(e.slice(0,-1)):e===r),o=null==(n=this.config.security.allowedAttributes[t])?void 0:n.includes(r),l=["href","src","action","formaction","poster"].includes(r),c="style"===r;if(i||o){if(l){const t=this.sanitizeUrlAttribute(e.value);if(!t)return void a.push({el:s,attrName:r});t!==e.value&&s.setAttribute(r,t)}if(c){const t=this.sanitizeInlineStyle(e.value);if(null===t)return void a.push({el:s,attrName:r});s.setAttribute("style",t)}}else a.push({el:s,attrName:r})}):e.push(s),s=n.nextNode()}e.forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)}),a.forEach(({el:e,attrName:t})=>{e.isConnected&&e.removeAttribute(t)})}if("string"==typeof e)return t.innerHTML}catch(t){throw ErrorManager.handle(t,{context:"TemplateManager.sanitizeElement",data:{element:e}})}},sanitizeUrlAttribute(e){if("string"!=typeof e)return null;const t=e.trim(),a=t.toLowerCase();if(["javascript:","data:","vbscript:","file:","about:"].some(e=>a.startsWith(e)))return ErrorManager.handle("Blocked dangerous protocol in attribute URL",{context:"TemplateManager.sanitizeUrlAttribute",data:{value:t},logLevel:"warn"}),null;if(a.startsWith("http://")||a.startsWith("https://")){try{const e=new URL(t,window.location.origin);if("http:"===e.protocol||"https:"===e.protocol)return e.toString()}catch(n){return null}return null}return a.includes(":")||t.includes("../")||t.includes("..\\")?null:t},sanitizeInlineStyle(e){if("string"!=typeof e||!e.trim())return null;const t=e.split(";").reduce((e,t)=>{const a=t.indexOf(":");if(-1===a)return e;const n=t.substring(0,a).trim(),s=t.substring(a+1).trim();if(n&&s){e[n.replace(/-([a-z])/g,e=>e[1].toUpperCase())]=s}return e},{}),a=this.sanitizeStyles(t),n=Object.entries(a).filter(([,e])=>null!=e&&""!==e);return 0===n.length?"":n.map(([e,t])=>`${e.replace(/([A-Z])/g,"-$1").toLowerCase()}: ${t}`).join("; ")},validateMarkup:async e=>new Promise((t,a)=>{try{const n=new DOMParser,s=n.parseFromString(e,"text/html").querySelector("parsererror");if(s)return void a(new Error("HTML parsing error: "+s.textContent));t(!0)}catch(n){ErrorManager.handle(n,{context:"TemplateManager.validateMarkup",data:{content:e}}),a(n)}}),isValidPath(e){if("string"!=typeof e||!e)return!1;if(!e.startsWith("/"))return!1;const t=e.toLowerCase();return!!this.config.security.allowedExtensions.some(e=>t.endsWith(e))&&(!t.includes("../")&&!t.includes("./")&&(!(this.state.serverPaths.size>0)||this.state.serverPaths.has(this.normalizePath(e))))},isValidUrl(e){try{const t=new URL(e,window.location.origin);return["http:","https:"].includes(t.protocol)}catch{return!1}},normalizePath:e=>e.replace(/^\/+|\/+$/g,""),setupPerformanceMonitoring(){window.PerformanceObserver&&(this.state.performanceObserver=new PerformanceObserver(e=>{e.getEntries().forEach(e=>{"measure"===e.entryType&&e.name.startsWith("template-")&&this.recordPerformance(e.name,{duration:e.duration,startTime:e.startTime,detail:e.detail})})}),this.state.performanceObserver.observe({entryTypes:["measure"]}),performance.getEntriesByType("measure").forEach(e=>{e.name.startsWith("template-")&&this.recordPerformance(e.name,{duration:e.duration,startTime:e.startTime,detail:e.detail})}))},recordPerformance(e,t){const a=Now.getManager("event");a&&a.emit("template:performance",{name:e,...t,timestamp:Date.now()})},recordError(e,t){const a=Now.getManager("event");a&&a.emit("template:error",{error:e,path:t,timestamp:Date.now()})},clearCache(){this.state.cache.clear()},processDataScript(e,t){var a;const n=e.dataset.script;if(n)if("function"==typeof window[n]){this.state.activeScripts.set(e,{fn:n});try{const s=(null==(a=t.state)?void 0:a.data)||t.data||{},r=window[n](e,s);"function"==typeof r&&(this.state.activeScripts.get(e).cleanupFn=r)}catch(s){ErrorManager.handle(s,{context:"TemplateManager.processDataScript",data:{scriptFn:n,element:e}})}}else console.warn(`TemplateManager: Function "${n}" not found in global scope`)},cleanupScripts(){for(const[t,a]of this.state.activeScripts)if("function"==typeof a.cleanupFn)try{a.cleanupFn()}catch(e){console.warn("TemplateManager: Script cleanup error for",a.fn,e)}this.state.activeScripts.clear()},processTemplate(e,t){var a;if(e&&t){e._apiComponent&&e._apiComponent.data&&!(null==(a=t.state)?void 0:a.data)&&(t={...t,state:{...t.state,data:e._apiComponent.data},data:e._apiComponent.data}),this.config.reactive=t.reactive,this.config.debug=t.debug;try{this.config.security.validateMarkup&&this.validateMarkup(e.innerHTML),this.config.security.sanitize&&this.sanitizeElement(e),this.processDataDirectives(e,t),this.processInterpolation(e,t);if(!0!==t.skipScan&&e.isConnected)try{const t=Now.getManager("element"),a=Now.getManager("form");t&&"function"==typeof t.scan&&t.scan(e),a&&"function"==typeof a.scan&&a.scan(e)}catch(n){ErrorManager.handle("TemplateManager.postProcessScan failed",{context:"TemplateManager.processTemplate",data:{error:n}})}}catch(s){return ErrorManager.handle(s,{context:"TemplateManager.processTemplate",data:{element:e,context:t}}),this.renderError(s)}}},processTemplateString(e,t,a){try{a||(a=document.createElement("div")),a.innerHTML=e,this.processDataDirectives(a,t),this.processInterpolation(a,t);try{const e=Now.getManager("element"),t=Now.getManager("form");e&&"function"==typeof e.scan&&e.scan(a),t&&"function"==typeof t.scan&&t.scan(a)}catch(n){ErrorManager.handle("TemplateManager.processTemplateString.postScan",{context:"TemplateManager.processTemplateString",data:{error:n}})}}catch(s){ErrorManager.handle(s,{context:"TemplateManager.processTemplateString",data:{template:e,context:t,container:a}}),a.innerHTML=this.renderError(s)}},processInterpolation(e,t){const a=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);let n=a.currentNode;for(;n;){if(n.textContent){const e=n.textContent.match(/\{\{(.+?)\}\}/g);e&&e.forEach(e=>{const a=e.slice(2,-2).trim(),s=ExpressionEvaluator.evaluate(a,{...t.state,...t.methods},t);n.textContent=n.textContent.replace(e,s??"")})}n=a.nextNode()}},hasOperators:e=>/[\+\-\*\/\(\)\[\]\{\}\!\?\:\<\>\&\|\=\,]/.test(e),renderError:e=>`\n        <div class="error-boundary">\n          <p>Template Error: ${e.message}</p>\n          <button class="button close-modal">Close</button>\n        </div>\n      `,processDataDirectives(e,t){var a;if(!t||!t.state)return void ErrorManager.handle("Invalid context for data directives processing",{context:"TemplateManager.processDataDirectives",data:{element:e,context:t}});t.reactive&&!t._updateQueue&&(t._updateQueue=new Set),t.parentId&&this.cleanupComponentHandlers(t.parentId);const n=document.createTreeWalker(e,NodeFilter.SHOW_ELEMENT,null,!1);let s=n.currentNode;const r=[];for(;s;)s.attributes&&this.config.security.allowedTags.includes(s.tagName.toLowerCase())&&Array.from(s.attributes).forEach(e=>{if(!e.name.startsWith("data-"))return;const a=e.name.substring(5),n=e.value;if("for"!==a){if(!s.closest||!s.closest("template"))switch(a){case"text":this.processDataText(s,n,t);break;case"html":this.processDataHtml(s,n,t);break;case"if":this.processDataIf(s,n,t);break;case"class":this.processDataClass(s,n,t);break;case"attr":this.processDataAttr(s,n,t);break;case"style":this.processDataStyle(s,n,t);break;case"on":this.processDataOn(s,n,t);break;case"container":this.processDataContainer(s,n,t);break;case"model":this.processDataModel(s,n,t);break;case"checked":this.processDataChecked(s,n,t);break;case"show":case"enter":case"leave":case"transition":"function"==typeof this.processDataAnimation&&this.processDataAnimation(s,t)}}else r.push({el:s,value:n})}),s=n.nextNode();r.forEach(({el:e,value:a})=>{this.processDataFor(e,a,t)}),t.id&&(null==(a=e.dataset)?void 0:a.parentContext)&&(e.dataset.parentContext=t.id)},processDataText(e,t,a){var n,s;if(e&&t&&a)try{if(e._textBinding){const t=null==(n=e._textBinding.originalState)?void 0:n.data;!(null==(s=a.state)?void 0:s.data)&&t||(e._textBinding.originalState=this.deepClone(a.state),e._textBinding.originalContext={...a})}else{e._textBinding={expression:t,originalState:this.deepClone(a.state),originalContext:{...a},formatters:[],lastValue:null};const n=t.split("|").map(e=>e.trim());n.length>1&&(e._textBinding.expression=n[0],e._textBinding.formatters=n.slice(1))}const updateText=()=>{var n;if(e)try{const t=null==(n=e.textContent)?void 0:n.trim(),s=e._textBinding.originalState||a.state,r=e._textBinding.originalContext||a;let i=ExpressionEvaluator.evaluate(e._textBinding.expression,{...s,...r.computed},r);e._textBinding.formatters.length>0&&(i=Utils.string.applyFormatters(i,e._textBinding.formatters,r));const o=this.valueToString(i);if(o===t)return;e.textContent=o,e._textBinding.lastValue=o}catch(s){ErrorManager.handle(s,{context:"TemplateManager.processDataText",data:{el:e,expression:t,context:a}}),e.textContent=""}};updateText(),this.setupReactiveUpdate(e,a,"Text",updateText)}catch(r){ErrorManager.handle(r,{context:"TemplateManager.processDataText",data:{el:e,expression:t,context:a}}),e.textContent=""}},processDataHtml(e,t,a){var n,s;if(e&&t&&a)try{if(e._htmlBinding){const t=null==(n=e._htmlBinding.originalState)?void 0:n.data;!(null==(s=a.state)?void 0:s.data)&&t||(e._htmlBinding.originalState=this.deepClone(a.state),e._htmlBinding.originalContext={...a})}else e._htmlBinding={value:t,originalState:this.deepClone(a.state),originalContext:{...a},lastHtml:null};const updateDataHtml=()=>{(t=>{if(null!=t){if((t=String(t))!==e._htmlBinding.lastHtml){if(this.config.security.sanitize){const e=this.sanitizeElement(t);"string"==typeof e&&(t=e)}e.innerHTML=t,e._htmlBinding.lastHtml=t,this.processDataDirectives(e,a),this.processInterpolation(e,a)}}else e.innerHTML=""})((()=>{const t=e._htmlBinding.originalState||a.state,n=e._htmlBinding.originalContext||a;let s=ExpressionEvaluator.evaluate(e._htmlBinding.value,{...t,...n.computed},n);return void 0===s&&e._htmlBinding&&(s=ExpressionEvaluator.evaluate(e._htmlBinding.value,{...e._htmlBinding.originalState,...e._htmlBinding.originalContext.computed},a)),s})())};updateDataHtml(),this.setupReactiveUpdate(e,a,"Html",updateDataHtml)}catch(r){ErrorManager.handle(r,{context:"TemplateManager.processDataHtml",data:{el:e,value:t,context:a}}),e.innerHTML=""}},processDataIf(e,t,a){var n,s;if(e&&t&&a)try{if(e._ifBinding){const t=null==(n=e._ifBinding.originalState)?void 0:n.data;!(null==(s=a.state)?void 0:s.data)&&t||(e._ifBinding.originalState=this.deepClone(a.state),e._ifBinding.originalContext={...a})}else e._ifBinding={expression:t,originalState:this.deepClone(a.state),originalContext:{...a},parent:e.parentNode,nextSibling:e.nextSibling,comment:document.createComment(`if: ${t}`),condition:!0,isAnimating:!1,listeners:new Set,cleanup:null},e._ifBinding.originalStyles={display:window.getComputedStyle(e).display,animationName:window.getComputedStyle(e).animationName},e.classList.contains("animated")&&(e._ifBinding.animated=!0);const r=e._ifBinding,evaluateCondition=()=>{const e=r.originalState||a.state,t=r.originalContext||a;return!!ExpressionEvaluator.evaluate(r.expression,{...e,...t.computed},t)},cleanupElement=e=>{var t;e._eventBinding&&e._eventBinding.handlers.forEach(e=>{EventSystemManager.removeHandler(e)}),["text","html","class","attr","model"].forEach(t=>{this.cleanupReactiveUpdate(e,t)});const a=Now.getManager("component");if(a){const n=null==(t=e.dataset)?void 0:t.componentId;n&&a.destroyComponent(n)}Array.from(e.children).forEach(e=>{cleanupElement(e)}),Object.keys(e).forEach(t=>{t.startsWith("_")&&delete e[t]})},handleAnimation=(e,t)=>new Promise(a=>{if(!r.animated)return void a();r.isAnimating=!0;const n=t?["fade-in","animate-in"]:["fade-out","animate-out"];e.classList.add(...n);const cleanup=()=>{e.classList.remove(...n),e.removeEventListener("animationend",onAnimationEnd),r.isAnimating=!1,a()},onAnimationEnd=t=>{t.target===e&&cleanup()};e.addEventListener("animationend",onAnimationEnd),setTimeout(cleanup,1e3)}),updateVisibility=async()=>{const n=evaluateCondition();if(n!==r.condition||r.isAnimating)try{if(n){if(!e.parentNode){r.parent||(r.parent=document.body),r.comment&&r.nextSibling?r.parent.insertBefore(r.comment,r.nextSibling):r.parent.appendChild(r.comment),r.nextSibling?r.parent.insertBefore(e,r.comment):r.parent.appendChild(e),await handleAnimation(e,!0),e.style.display=r.originalStyles.display,this.processDataDirectives(e,a),this.processInterpolation(e,a);const t=Now.getManager("component");t&&t.initializeExistingElements();try{const t=Now.getManager("element"),a=Now.getManager("form");t&&"function"==typeof t.scan&&t.scan(e),a&&"function"==typeof a.scan&&a.scan(e)}catch(s){ErrorManager.handle("processDataIf.postInsertScan failed",{context:"TemplateManager.processDataIf",data:{error:s}})}r.comment&&r.comment.parentNode&&r.comment.parentNode.removeChild(r.comment)}}else if(e.parentNode&&(await handleAnimation(e,!1),cleanupElement(e),r.parent=e.parentNode,r.nextSibling=e.nextSibling,r.parent)){if(r.comment)try{r.parent.insertBefore(r.comment,e.nextSibling)}catch(s){r.parent.appendChild(r.comment)}e.remove()}r.condition=n,EventManager.emit("if:updated",{element:e,condition:n,expression:t})}catch(i){ErrorManager.handle(i,{context:"TemplateManager.processDataIf",type:"error:template",data:{expression:t,el:e}})}};updateVisibility(),this.setupReactiveUpdate(e,a,"If",updateVisibility),r.cleanup=()=>{cleanupElement(e),this.cleanupReactiveUpdate(e,"If"),r.comment.remove(),r.listeners.clear();try{delete e._ifBinding}catch(t){e._ifBinding=null}}}catch(r){ErrorManager.handle(r,{context:"TemplateManager.processDataIf",type:"error:template",data:{expression:t,el:e}})}},processDataClass(e,t,a){var n,s;if(e&&t&&a)try{if(e._classBinding){const t=null==(n=e._classBinding.originalState)?void 0:n.data;!(null==(s=a.state)?void 0:s.data)&&t||(e._classBinding.originalState=this.deepClone(a.state),e._classBinding.originalContext={...a})}else e._classBinding={value:t,originalState:this.deepClone(a.state),originalContext:{...a}};const r=/[\s]+\?[\s]*['"][^'"]+['"][\s]*:[\s]*['"][^'"]+['"]/.test(t),i=t.includes(":")&&!r;if(r){const n=/(.+?)[\s]+\?[\s]*['"]([^'"]+)['"][\s]*:[\s]*['"]([^'"]+)['"]/.exec(t);if(n){const updateClassTernary=()=>{try{const t=e._classBinding.originalState||a.state,s=e._classBinding.originalContext||a;ExpressionEvaluator.evaluate(n[1].trim(),{...t,...s.computed},s)?(e.classList.add(n[2]),e.classList.remove(n[3])):(e.classList.remove(n[2]),e.classList.add(n[3]))}catch(s){ErrorManager.handle(`Error evaluating class ternary "${t}"`,{context:"TemplateManager.processDataClass",data:{el:e,value:t,context:a}})}};return updateClassTernary(),void this.setupReactiveUpdate(e,a,"Class",updateClassTernary)}}if(i){return void t.split(",").map(e=>e.trim()).forEach(n=>{try{const updateClass=()=>{const s=n.indexOf(":");if(-1===s)return;const r=n.substring(0,s).trim(),i=n.substring(s+1).trim();if(!r||!i)return void ErrorManager.handle(`Invalid data-class binding: '${n}'. Expected format "className:expression"`,{context:"TemplateManager.processDataClass",data:{el:e,value:t,context:a},logLevel:"warn"});const o=e._classBinding.originalState||a.state,l=e._classBinding.originalContext||a;ExpressionEvaluator.evaluate(i,{...o,...l.computed},l)?e.classList.add(r):e.classList.remove(r)};updateClass(),this.setupReactiveUpdate(e,a,"Class",updateClass)}catch(s){ErrorManager.handle(s,{context:"TemplateManager.processDataClass",data:{el:e,value:t,context:a,binding:n}})}})}const updateClassExpression=()=>{try{const n=e._classBinding.originalState||a.state,s=e._classBinding.originalContext||a;let r=ExpressionEvaluator.evaluate(t,{...n,...s.computed},s);if(e._classBinding.addedClasses&&e._classBinding.addedClasses.forEach(t=>{t&&e.classList.remove(t)}),r){const t=String(r).split(/\s+/).filter(e=>e);t.forEach(t=>e.classList.add(t)),e._classBinding.addedClasses=t}else e._classBinding.addedClasses=[]}catch(n){ErrorManager.handle(`Error evaluating class expression "${t}"`,{context:"TemplateManager.processDataClass",data:{el:e,value:t,context:a}})}};updateClassExpression(),this.setupReactiveUpdate(e,a,"Class",updateClassExpression)}catch(r){ErrorManager.handle(r,{context:"TemplateManager.processDataClass",data:{el:e,value:t,context:a}})}},processDataAttr(e,t,a){var n,s;if(e&&t&&a)try{if(e._Binding){const t=null==(n=e._Binding.originalState)?void 0:n.data;!(null==(s=a.state)?void 0:s.data)&&t||(e._Binding.originalState=this.deepClone(a.state),e._Binding.originalContext={...a})}else e._Binding={value:t,originalState:this.deepClone(a.state),originalContext:{...a}};t.split(",").map(e=>e.trim()).forEach(n=>{try{const updateAttr=()=>{const[s,r]=n.split(":").map(e=>e.trim());if(!s||!r)return void ErrorManager.handle(`Invalid attribute binding: ${n}`,{context:"TemplateManager.processDataAttr",data:{el:e,value:t,context:a},logLevel:"warn"});if(!/^[a-zA-Z0-9\-_]+$/.test(s))return void ErrorManager.handle(`Invalid attribute name: ${s}`,{context:"TemplateManager.processDataAttr",data:{el:e,value:t,context:a},logLevel:"warn"});const i=e._Binding.originalState||a.state,o=e._Binding.originalContext||a;let l=ExpressionEvaluator.evaluate(r,{...i,...o.computed},o);const c=Now.getManager("element"),d=null==c?void 0:c.getInstanceByElement(e);if(d&&d.constructor.propertyHandlers&&d.constructor.propertyHandlers[s]){const e=d.constructor.propertyHandlers[s];e.set?e.set.call(d.constructor,d,l):console.error(`Property handler for '${s}' has no setter`)}else{const t=["disabled","checked","readonly","required","autofocus","multiple","novalidate","formnovalidate","selected","hidden","open","controls","loop","muted","playsinline","reversed","scoped","async","defer"].includes(s.toLowerCase());if("value"!==s||"INPUT"!==e.tagName&&"SELECT"!==e.tagName&&"TEXTAREA"!==e.tagName)t&&l?e.setAttribute(s,s):t||null==l?e.removeAttribute(s):e.setAttribute(s,l);else{if("file"===e.type)return void ErrorManager.handle("Cannot set value on file input. Use data-files attribute for existing files.",{context:"TemplateManager.processDataAttr",data:{el:e,attrName:s,expression:r},logLevel:"warn"});"SELECT"===e.tagName?null!=l&&(e.value=String(l)):e.value=l??""}}};updateAttr(),this.setupReactiveUpdate(e,a,"Attr",updateAttr)}catch(s){ErrorManager.handle(s,{context:"TemplateManager.processDataAttr",data:{el:e,value:t,context:a,binding:n}})}})}catch(r){ErrorManager.handle(r,{context:"TemplateManager.processDataAttr",data:{el:e,value:t,context:a}})}},processDataStyle(e,t,a){if(e&&t&&a)try{e._styleBinding?(e._styleBinding.originalState=this.cloneState(a.state),e._styleBinding.originalContext={...a}):e._styleBinding={value:t,originalState:this.cloneState(a.state),originalContext:{...a},lastStyles:null};const updateStyles=()=>{try{let n={};if(t.startsWith("{")&&t.endsWith("}")){const e=ExpressionEvaluator.evaluate(t,{...a.state,...a.computed},a);"object"==typeof e&&(n=e)}else{n=t.replace(/\{\{(.+?)\}\}/g,(e,t)=>{const n=ExpressionEvaluator.evaluate(t,{...a.state,...a.computed},a);return null!=n?n:""}).split(";").reduce((e,t)=>{const a=t.indexOf(":");if(-1===a)return e;const n=t.substring(0,a).trim(),s=t.substring(a+1).trim();if(n&&s){e[n.replace(/-([a-z])/g,e=>e[1].toUpperCase())]=s}return e},{})}if(JSON.stringify(n)===e._styleBinding.lastStyles)return;const s=this.sanitizeStyles(n);Object.assign(e.style,s),e._styleBinding.lastStyles=JSON.stringify(n)}catch(n){ErrorManager.handle(n,{context:"TemplateManager.processDataStyle",data:{el:e,value:t,context:a,binding:binding}})}};updateStyles(),a.reactive&&a._updateQueue&&a._updateQueue.add(updateStyles)}catch(n){ErrorManager.handle(n,{context:"TemplateManager.processDataStyle",data:{el:e,value:t,context:a}})}},sanitizeStyles(e){const t=["display","position","top","right","bottom","left","float","clear","visibility","opacity","zIndex","overflow","clip","width","height","margin","padding","border","borderWidth","borderStyle","borderColor","borderRadius","boxShadow","boxSizing","textOverflow","whiteSpace","maxWidth","maxHeight","minWidth","minHeight","color","background","backgroundColor","backgroundImage","fontSize","fontFamily","fontWeight","textAlign","lineHeight","letterSpacing","textTransform","textDecoration","textIndent","flex","flexDirection","flexWrap","flexGrow","flexShrink","flexBasis","justifyContent","alignItems","alignContent","gap","gridTemplateColumns","gridTemplateRows","gridColumn","gridRow","transform","transformOrigin","perspective","transition","animation","cursor","pointerEvents"],a={};for(const[n,s]of Object.entries(e))if(t.includes(n))if("string"==typeof s&&s.includes("url(")){const e=this.sanitizeUrlValue(s);e&&(a[n]=e)}else a[n]=s;return a},sanitizeUrlValue(e){if(!e||"string"!=typeof e)return null;const t=/url\(['"]?([^'"]*)['"]?\)/.exec(e);if(!t||!t[1])return null;const a=t[1].trim();if(!a)return null;const n=["javascript:","data:text/","vbscript:","file:","about:"],s=a.toLowerCase();for(const i of n)if(s.startsWith(i))return ErrorManager.handle(`Blocked dangerous protocol in URL: ${i}`,{context:"TemplateManager.sanitizeUrlValue",data:{url:a},logLevel:"warn"}),null;if(s.startsWith("data:")){if(!["data:image/png","data:image/jpeg","data:image/jpg","data:image/gif","data:image/svg+xml","data:image/webp","data:image/bmp","data:image/ico","data:image/x-icon"].some(e=>s.startsWith(e)))return ErrorManager.handle("Blocked non-image data URL",{context:"TemplateManager.sanitizeUrlValue",data:{url:a.substring(0,50)+"..."},logLevel:"warn"}),null;if(s.includes(";base64,")){const e=a.split(";base64,")[1];if(e&&!/^[A-Za-z0-9+/]+=*$/.test(e.substring(0,Math.min(100,e.length))))return ErrorManager.handle("Invalid base64 encoding in data URL",{context:"TemplateManager.sanitizeUrlValue",data:{url:a.substring(0,50)+"..."},logLevel:"warn"}),null}return`url(${a})`}if(s.startsWith("http://")||s.startsWith("https://"))try{const e=new URL(a);return"http:"!==e.protocol&&"https:"!==e.protocol?null:`url(${a})`}catch(r){return ErrorManager.handle("Invalid absolute URL",{context:"TemplateManager.sanitizeUrlValue",data:{url:a},logLevel:"warn"}),null}return s.includes(":")?(ErrorManager.handle("Blocked unrecognized URL format",{context:"TemplateManager.sanitizeUrlValue",data:{url:a},logLevel:"warn"}),null):a.includes("../")||a.includes("..\\")?(ErrorManager.handle("Blocked path traversal in URL",{context:"TemplateManager.sanitizeUrlValue",data:{url:a},logLevel:"warn"}),null):/^[a-zA-Z0-9\/_\-\.]+(\?[a-zA-Z0-9=&_\-]*)?$/.test(a)?`url(${a})`:(ErrorManager.handle("Invalid relative URL format",{context:"TemplateManager.sanitizeUrlValue",data:{url:a},logLevel:"warn"}),null)},processDataFor(e,t,a){if(!e||!t||!a)return;const n=t.match(/(\w+)\s+(?:in|of)\s+(.+)/);if(n)try{const[s,r,i]=n;e._forBinding?(e._forBinding.originalState=this.deepClone(a.state),e._forBinding.originalContext={...a}):e._forBinding={value:t,itemName:r,arrayExpr:i,originalState:this.deepClone(a.state),originalContext:{...a},lastHash:null};const updateList=()=>{try{let n=ExpressionEvaluator.evaluate(i,{...a.state,...a.computed},a);if(!n&&e._forBinding.originalState&&(n=ExpressionEvaluator.evaluate(i,{...e._forBinding.originalState,...e._forBinding.originalContext.computed},a)),!Array.isArray(n))return;const s=JSON.stringify(n);if(e._forBinding.lastHash===s)return;const o=e.querySelector("template");if(!o)return void ErrorManager.handle("No template found in data-for element",{context:"TemplateManager.processDataFor",data:{el:e,value:t,context:a},logLevel:"warn"});Array.from(e.childNodes).forEach(t=>{t!==o&&e.removeChild(t)}),n.forEach((t,n)=>{const s={...a,state:{...a.state,[r]:t,index:n},computed:a.computed,methods:a.methods,reactive:a.reactive,_updateQueue:a._updateQueue},i=o.content.cloneNode(!0);this.processDataDirectives(i,s),this.processInterpolation(i,s),e.appendChild(i)}),e._forBinding.lastHash=s}catch(n){ErrorManager.handle(n,{context:"TemplateManager.processDataFor",type:"error:template",data:{el:e,value:t}})}};updateList(),this.setupReactiveUpdate(e,a,"For",updateList)}catch(s){ErrorManager.handle(s,{context:"TemplateManager.processDataFor",type:"error:template",data:{el:e,value:t}})}else ErrorManager.handle(`Invalid data-for expression: ${t}`,{context:"TemplateManager.processDataFor",data:{el:e,value:t,context:a},logLevel:"warn"})},processDataOn(e,t,a){if(!e||!t||!a)return;const n={prevent:e=>(e.preventDefault(),!0),stop:e=>(e.stopPropagation(),!0),once:()=>!0,capture:()=>!0,self:(e,t)=>e.target===t,trusted:e=>e.isTrusted,enter:e=>"Enter"===e.key,tab:e=>"Tab"===e.key,esc:e=>"Escape"===e.key,space:e=>" "===e.key,left:e=>0===e.button,right:e=>2===e.button,middle:e=>1===e.button,ctrl:e=>e.ctrlKey,alt:e=>e.altKey,shift:e=>e.shiftKey,meta:e=>e.metaKey};try{e._eventBinding?(e._eventBinding.originalState=this.deepClone(a.state),e._eventBinding.originalContext={...a}):e._eventBinding={value:t,originalState:this.deepClone(a.state),originalContext:{...a},handlers:new Map,lastTriggered:{}};t.split(",").map(e=>e.trim()).forEach(s=>{var r;const[i,o]=s.split(":").map(e=>e.trim());if(!i||!o)return void ErrorManager.handle(`Invalid event binding: ${s}`,{context:"TemplateManager.processDataOn",data:{el:e,value:t,context:a},logLevel:"warn"});const[l,...c]=i.split(".");"BUTTON"===e.tagName&&"click"===l&&(c.includes("stop")||c.push("stop"));const d=e._eventBinding.handlers.get(l);d&&EventSystemManager.removeHandler(d);const u=o.match(/(\w+)(?:\((.*?)\))?/);if(!u)return void ErrorManager.handle(`Invalid method expression: ${o}`,{context:"TemplateManager.processDataOn",data:{el:e,value:t,context:a},logLevel:"warn"});const[h,p,m]=u;let g=null==(r=a.methods)?void 0:r[p],f=!1;if("function"!=typeof g){if("function"!=typeof window[p])return void ErrorManager.handle(`Method "${p}" not found in component or global scope`,{context:"TemplateManager.processDataOn",data:{el:e,value:t,context:a},logLevel:"warn"});g=window[p],f=!0}const y=m?m.split(",").map(t=>(t=null==t?void 0:t.trim())?t.startsWith("'")||t.startsWith('"')?t.slice(1,-1):()=>{let n=ExpressionEvaluator.evaluate(t,{...a.state,...a.computed,$event:null},a);return void 0===n&&e._eventBinding.originalState&&(n=ExpressionEvaluator.evaluate(t,{...e._eventBinding.originalState,...e._eventBinding.originalContext.computed},a)),n}:null).filter(Boolean):[],v=EventSystemManager.addHandler(e,l,s=>{try{const t=Date.now(),r=e._eventBinding.lastTriggered[l]||0;if(t-r<100)return;if(!e.contains(s.target)&&e!==s.target)return;if(!c.every(t=>{const a=n[t];return!a||a(s,e)}))return;e._eventBinding.lastTriggered[l]=t;const i=y.map(e=>"function"==typeof e?e():e);g.apply(f?null:a,[...i,s]),c.includes("once")&&EventSystemManager.removeHandler(v)}catch(r){ErrorManager.handle(r,{context:"TemplateManager.processDataOn",type:"template:error",data:{methodName:p,el:e,value:t,context:a}})}},{componentId:a.id,capture:c.includes("capture"),passive:"scroll"===l||"touchmove"===l});e._eventBinding.handlers.set(l,v)})}catch(s){ErrorManager.handle(s,{context:"TemplateManager.processDataOn",type:"template:error",data:{el:e,value:t,context:a}})}},processDataContainer(e,t,a){if(e&&t&&a)try{e._containerBinding?(e._containerBinding.originalState=this.deepClone(a.state),e._containerBinding.originalContext={...a}):e._containerBinding={value:t,originalState:this.deepClone(a.state),originalContext:{...a},currentPath:null};const updateContainer=()=>{const loadComponent=async n=>{try{if("string"==typeof n){const e=await this.loadFromServer(n);if(!e)throw new Error(`Failed to load template: ${n}`);return{template:e,context:{...a,parentId:a.id,state:{...a.state},path:n}}}if(n&&"object"==typeof n){if(!n.template)throw new Error("Component definition missing template");const e={...a,...n,parentId:a.id,state:{...a.state,...n.state}};return{template:n.template,context:e}}throw new Error("Invalid component reference")}catch(s){return ErrorManager.handle("Component load failed",{context:"TemplateManager.processDataContainer",data:{el:e,value:t,context:a,error:s}}),null}},n=ExpressionEvaluator.evaluate(t,{...a.state,...a.methods},a);n&&(async n=>{try{const t=await loadComponent(n);if(!t)return;e.innerHTML="";const a=document.createElement("div");a.innerHTML=t.template,this.processDataDirectives(a,t.context),this.processInterpolation(a,t.context),e.appendChild(a),e._containerBinding.currentPath="string"==typeof n?n:null}catch(s){ErrorManager.handle("Component render failed",{context:"TemplateManager.processDataContainer",data:{el:e,value:t,context:a,error:s}}),e.innerHTML=this.renderError(s)}})(n)};updateContainer(),this.setupReactiveUpdate(e,a,"Container",updateContainer)}catch(n){ErrorManager.handle(n,{context:"TemplateManager.processDataContainer",data:{el:e,value:t,context:a}}),e.innerHTML=this.renderError(n)}},processDataModel(e,t,a){if(e&&t&&a)try{if(e._modelBinding)e._modelBinding.originalState=this.deepClone(a.state),e._modelBinding.originalContext={...a};else{e._modelBinding={value:t,originalState:this.deepClone(a.state),originalContext:{...a},lastValue:null,initialValue:null,isActive:!1,selectionStart:null,selectionEnd:null,modifiers:{lazy:!1,number:!1,trim:!1}},e.addEventListener("focus",()=>{e._modelBinding.isActive=!0,e._modelBinding.selectionStart=e.selectionStart,e._modelBinding.selectionEnd=e.selectionEnd}),e.addEventListener("blur",()=>{e._modelBinding.isActive=!1,e._modelBinding.selectionStart=null,e._modelBinding.selectionEnd=null});const n=t.split(".");n.slice(1).forEach(t=>{t in e._modelBinding.modifiers&&(e._modelBinding.modifiers[t]=!0)}),e._modelBinding.value=n[0]}const updateModel=()=>{const n=e._modelBinding,updateModel2=s=>{try{const e=n.value.split("."),t=e.pop(),r=e.length?e.reduce((e,t)=>e[t],a.state):a.state;if(!r||"string"!=typeof t)return;n.modifiers.number&&(s=""===s?null:Number(s)),n.modifiers.trim&&"string"==typeof s&&(s=s.trim()),s!==n.lastValue&&(n.lastValue=s,r[t]=s)}catch(r){ErrorManager.handle(r,{context:"TemplateManager.processDataModel",data:{el:e,value:t,context:a}})}};switch(e._modelHandlers&&Object.entries(e._modelHandlers).forEach(([t,a])=>{e.removeEventListener(t,a)}),e.addEventListener("focus",()=>{n.isActive=!0,n.selectionStart=e.selectionStart,n.selectionEnd=e.selectionEnd}),e.addEventListener("blur",()=>{n.isActive=!1,n.selectionStart=null,n.selectionEnd=null}),e._modelHandlers={},e.type){case"checkbox":e._modelHandlers.change=e=>updateModel2(e.target.checked);break;case"radio":e._modelHandlers.change=e=>{e.target.checked&&updateModel2(e.target.value)};break;case"file":e._modelHandlers.change=e=>updateModel2(e.target.files);break;case"select-multiple":e._modelHandlers.change=e=>{const t=Array.from(e.target.selectedOptions).map(e=>e.value);updateModel2(t)};break;default:const t=n.modifiers.lazy?"change":"input";e._modelHandlers[t]=e=>updateModel2(e.target.value),e._modelHandlers.keydown=e=>{"Enter"===e.key&&updateModel2(e.target.value)}}Object.entries(e._modelHandlers).forEach(([t,a])=>{e.addEventListener(t,a)});const s=(()=>{let t=ExpressionEvaluator.evaluate(n.value,{...a.state,...a.computed},a);return void 0===t&&e._modelBinding.originalState&&(t=ExpressionEvaluator.evaluate(n.value,{...e._modelBinding.originalState,...e._modelBinding.originalContext.computed},a)),n.modifiers.number&&(t=""===t?null:Number(t)),n.modifiers.trim&&"string"==typeof t&&(t=t.trim()),t})();n.initialValue=s,"checkbox"===e.type?e.checked=!!s:"radio"===e.type?e.checked=e.value===String(s):"select-multiple"===e.type&&Array.isArray(s)?Array.from(e.options).forEach(e=>{e.selected=s.includes(e.value)}):"SELECT"===e.tagName?(e.value=s??"",e.value!==String(s)&&Array.from(e.options).forEach(e=>{e.selected=e.value===String(s)})):e.value=s??""};updateModel(),this.setupReactiveUpdate(e,a,"Model",updateModel)}catch(n){ErrorManager.handle(n,{context:"TemplateManager.processDataModel",data:{el:e,value:t,context:a}})}},processDataChecked(e,t,a){if(e&&t&&a)if(["checkbox","radio"].includes(e.type))try{e._checkedBinding?(e._checkedBinding.originalState=this.deepClone(a.state),e._checkedBinding.originalContext={...a}):e._checkedBinding={expression:t,originalState:this.deepClone(a.state),originalContext:{...a},lastValue:null};const updateChecked=()=>{if(e)try{const t=e.checked;let n=ExpressionEvaluator.evaluate(e._checkedBinding.expression,{...a.state,...a.computed},a);if(void 0===n&&e._checkedBinding&&(n=ExpressionEvaluator.evaluate(e._checkedBinding.expression,{...e._checkedBinding.originalState,...e._checkedBinding.originalContext.computed},a)),n===t)return;e.checked=!!n,e._checkedBinding.lastValue=!!n}catch(n){ErrorManager.handle(n,{context:"TemplateManager.processDataChecked",data:{el:e,expression:t,context:a}}),e.checked=!1}};updateChecked(),this.setupReactiveUpdate(e,a,"Checked",updateChecked)}catch(n){ErrorManager.handle(n,{context:"TemplateManager.processDataChecked",data:{el:e,expression:t,context:a}}),e.checked=!1}else ErrorManager.handle("data-checked only works with checkbox/radio inputs",{context:"TemplateManager.processDataChecked",data:{el:e,expression:t,context:a},logLevel:"warn"})},deepClone(e,t=new WeakMap){if(null===e||"object"!=typeof e)return e;if(t.has(e))return t.get(e);const a=Array.isArray(e)?[]:{};return t.set(e,a),Object.entries(e).forEach(([e,n])=>{a[e]=this.deepClone(n,t)}),a},cloneState(e){if(!e||"object"!=typeof e)return e;const t=Array.isArray(e)?[]:{};for(const a in e)if(Object.prototype.hasOwnProperty.call(e,a)){const n=e[a];t[a]="object"==typeof n?this.cloneState(n):n}return t},cleanupElement(e){var t;if(e)try{e._eventBinding&&(e._eventBinding.handlers.forEach(e=>{EventSystemManager.removeHandler(e)}),delete e._eventBinding);["_textBinding","_htmlBinding","_ifBinding","_forBinding","_classBinding","_attrBinding","_styleBinding","_modelBinding","_containerBinding","_checkedBinding"].forEach(t=>{e[t]&&(e[t].cleanup&&e[t].cleanup(),delete e[t])}),e._updateQueue&&(e._updateQueue.clear(),delete e._updateQueue);(null==(t=e.dataset)?void 0:t.componentId)&&(delete e.dataset.componentId,delete e.dataset.parentContext),Array.from(e.children).forEach(e=>{this.cleanupElement(e)}),Object.keys(e).forEach(t=>{t.startsWith("_")&&delete e[t]})}catch(a){ErrorManager.handle(a,{context:"TemplateManager.cleanupElement",data:{element:e}})}},cleanupComponent(e){if(e)try{this.cleanupComponentHandlers(e);const t=`template:${e}`;this.state.cache.has(t)&&(this.state.cache.delete(t),this.state.itemTimestamps.delete(t));document.querySelectorAll(`[data-component-id="${e}"]`).forEach(e=>{this.cleanupElement(e)}),EventManager.emit("template:cleanup",{componentId:e})}catch(t){ErrorManager.handle(t,{context:"TemplateManager.cleanupComponent",data:{componentId:e}})}},cleanup(){try{this.state.cache.clear(),this.state.itemTimestamps.clear(),this.cleanupHandlers();const e=document.querySelector(Now.config.mainSelector);e&&this.cleanupElement(e),this.state.currentComputation=null,this.state.handlers=new Map,this.state.pendingUpdates=new Set,EventManager.emit("template:cleanup:all")}catch(e){ErrorManager.handle(e,{context:"TemplateManager.cleanup"})}},valueToString(e){if(null==e)return"";if("object"==typeof e)try{return JSON.stringify(e)}catch{return String(e)}return String(e)},setStateValue(e,t,a){const n=e.split("."),s=n.pop();n.reduce((e,t)=>e[t]=e[t]||{},a)[s]=t},processTemplateContent(e,t){this.processDataDirectives(e,t),this.processInterpolation(e,t)},render(e,t){if(!e||"object"!=typeof e)return void ErrorManager.handle("Invalid context provided to render.",{context:"TemplateManager.render",data:{context:e,container:t}});if(!(t instanceof HTMLElement))return void ErrorManager.handle("Container must be a valid DOM element.",{context:"TemplateManager.render",data:{context:e,container:t}});t.innerHTML="";const a=this.processTemplate(e.template,e),n=document.createElement("div");for(n.innerHTML=a;n.firstChild;)t.appendChild(n.firstChild);const s=Now.getManager("event");s&&s.emit("template:render",{componentId:e.id,timestamp:Date.now(),container:t})},cleanupCache(){const e=Date.now();for(const[t,a]of this.state.cache)a.expires<e&&(this.state.cache.delete(t),this.state.itemTimestamps.delete(t))},registerEventHandler(e,t){const a=`evt_${Utils.generateUUID()}`,[n,s]=e.split("("),r=s?s.replace(")","").split(",").map(e=>e.trim()):[];return this.state.handlers=this.state.handlers||new Map,this.state.handlers.set(a,e=>{const a=t.methods[n.trim()];"function"==typeof a?a.apply(t,r.concat(e)):ErrorManager.handle(`Method ${n.trim()} not found in the component`,{context:"TemplateManager.registerEventHandler",data:{methodName:n,context:t}})}),this.state.itemTimestamps.set(a,Date.now()),a},cleanupHandlers(){const e=Now.getManager("component");if(!e)return;const t=new Set(Array.from(e.instances.keys()).map(e=>e.dataset.componentId).filter(Boolean));for(const[a]of this.state.handlers){const[e]=a.split("_");t.has(e)||this.state.handlers.delete(a)}},cleanupComponentHandlers(e){if(!e)return;const t=`[data-handler-id^="${e}_"]`;document.querySelectorAll(t).forEach(e=>{const t=e.dataset.handlerId,a=this.state.handlers.get(t);if(a){const n=t.split("_")[2];e.removeEventListener(n,a,!0),this.state.handlers.delete(t),delete e.dataset.handlerId}})},startCleanupInterval(){this.stopCleanupInterval(),this.state.cleanupInterval=setInterval(()=>{this.performCleanup()},this.config.cleanup.interval),window.addEventListener("beforeunload",()=>{this.stopCleanupInterval()}),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&this.stopCleanupInterval()})},stopCleanupInterval(){this.state.cleanupInterval&&(clearInterval(this.state.cleanupInterval),this.state.cleanupInterval=null)},onComponentDestroy(e){if(e.id){this.cleanupComponentHandlers(e.id);const t=`template:${e.id}`;this.state.cache.has(t)&&(this.state.cache.delete(t),this.state.itemTimestamps.delete(t))}},performCleanup(){var e;const t=Date.now(),a=this.config.cleanup.batchSize;let n=0;EventManager.emit("app:cleanup:start",{timestamp:t});for(const[s,r]of this.state.cache)if(t-this.state.itemTimestamps.get(s)>this.config.cleanup.maxCacheAge&&(this.state.cache.delete(s),this.state.itemTimestamps.delete(s),n++),n>=a)break;n=0;for(const[s,r]of(null==(e=this.state.handlers)?void 0:e.entries())||[])if(t-this.state.itemTimestamps.get(s)>this.config.cleanup.maxHandlerAge&&(this.state.handlers.delete(s),this.state.itemTimestamps.delete(s),n++),n>=a)break;this.state.lastCleanup=t,EventManager.emit("app:cleanup:end",{timestamp:t})}};(null==(c=window.Now)?void 0:c.registerManager)&&Now.registerManager("template",J),window.TemplateManager=J;const X={setupReactiveUpdate(e,t,a,n){if(e&&t&&a&&n)if("function"==typeof n){if(this.cleanupReactiveUpdate(e,a),t.reactive&&t._updateQueue){e[`_has${a}Update`]=!0;const wrappedUpdate=async()=>{try{await n()}catch(t){console.error(`Error in reactive update (${a}):`,t),EventManager.emit("reactive:error",{type:a,element:e,error:t})}};e[`_${a}UpdateFn`]=wrappedUpdate,t._updateQueue.add(wrappedUpdate)}}else console.error(`Invalid update function for ${a}`)},cleanupReactiveUpdate(e,t){var a;if(!e||!t)return;const n=`_has${t}Update`,s=`_${t}UpdateFn`;e[n]&&(e[s]&&(null==(a=e._context)?void 0:a._updateQueue)&&e._context._updateQueue.delete(e[s]),delete e[n],delete e[s])},cleanupAllReactiveUpdates(e){e&&Object.keys(e).forEach(t=>{t.startsWith("_has")&&t.endsWith("Update")&&delete e[t]})}};Object.assign(TemplateManager,X);const Q={config:{reactive:!1,templateCache:!0,performance:{monitoring:!1,batchUpdates:!1}},components:new Map,instances:new Map,templateCache:new Map,async init(e={}){return this.config={...this.config,...e},this.setupI18nListeners(),this},setupI18nListeners(){var e,t;EventManager.on("i18n:loaded",e=>{e.success&&this.updateAllComponents()}),EventManager.on("locale:changed",()=>{this.updateAllComponents()}),(null==(t=null==(e=window.I18nManager)?void 0:e.state)?void 0:t.initialized)&&this.updateAllComponents()},updateAllComponents(){this.instances.forEach(e=>{if(e._mounted&&!e._destroyed&&!e._updating)try{this.renderInstance(e)}catch(t){this.handleError("Error updating component translations","updateAllComponents",{componentId:e.id,error:t})}})},define(e,t){if(!e||"string"!=typeof e)throw new Error("Component name must be a string");if(this.components.has(e)){const t=this.components.get(e);console.warn(`⚠️ Component name conflict detected!\nComponent "${e}" is already registered.\nThis will overwrite the existing component definition.\n\nExisting component: ${t._registeredFrom||"unknown source"}\nNew component: ${this._getCurrentScriptSource()||"current script"}\n\nTo fix this:\n1. Use a unique component name (e.g., "${e}2", "${e}_custom")\n2. Or remove/rename the conflicting component\n3. Check your component registration in both files`)}const a={reactive:!1,renderStrategy:"auto",template:null,state:{},methods:{},computed:{},watch:{},events:{},...t,_registeredFrom:this._getCurrentScriptSource()||"unknown"},n=this.processDefinition(e,a);return this.components.set(e,n),"loading"!==document.readyState&&this.initializeExistingElements(e),n},_getCurrentScriptSource(){try{const e=(new Error).stack;if(!e)return null;const t=e.split("\n");for(let a=0;a<t.length;a++){const e=t[a].match(/https?:\/\/[^)]+\.js/);if(e&&!e[0].includes("ComponentManager.js"))return e[0].split("/").pop()}return null}catch(e){return null}},processDefinition:(e,t)=>({name:e,reactive:t.reactive||!1,template:t.template||null,state:t.state||{},methods:t.methods||{},computed:t.computed||{},watch:t.watch||{},validElement:t.validElement||null,aria:t.aria||{},events:t.events||{},beforeCreate:t.beforeCreate,created:t.created,beforeMount:t.beforeMount,mounted:t.mounted,beforeUpdate:t.beforeUpdate,updated:t.updated,beforeDestroy:t.beforeDestroy,destroyed:t.destroyed,errorCaptured:t.errorCaptured,renderStrategy:t.renderStrategy||"auto",errorBoundary:t.errorBoundary||!1,setupElement:t.setupElement||null}),initializeExistingElements(e=null){try{const t=e?`[data-component="${e}"]`:"[data-component]";document.querySelectorAll(t).forEach(e=>{const t=e.getAttribute("data-component");if("api"===t)return;const a=this.instances.get(e);if((!a||!a.state.initialized||a._destroyed)&&this.components.has(t)){const a=this.extractProps(e);this.mount(e,t,a).catch(e=>{console.error(`Failed to initialize component ${t}:`,e)})}}),window.ApiComponent&&"function"==typeof ApiComponent.initElements&&ApiComponent.initElements()}catch(t){this.handleError("Error initializing existing elements","initializeExistingElements",{error:t})}},extractProps(e){const t={};Array.from(e.attributes).forEach(e=>{let a=e.name,n=e.value;if("data-component"!==a)if(a=a.replace(/^data-/,""),n.startsWith("[")&&n.endsWith("]")){try{n=JSON.parse(n)}catch(s){this.handleError(`Failed to parse array value for ${a}:`,"extractProps",{propName:a,value:n,error:s})}t[a]=n}else isNaN(n)||(n=parseFloat(n)),"true"!==n&&"false"!==n||(n="true"===n),t[a]=n});const a=e.innerHTML.trim();return a&&(t.template=a),t},initializeComponent(e,t,a={}){try{const n={id:Utils.generateUUID(),element:e,props:{...a},reactive:t.reactive||!1,renderStrategy:t.renderStrategy||"auto",template:t.template||null,state:{...t.state||{}},methods:{},computed:t.computed||{},watch:t.watch||{},events:t.events||{},_definition:t,_mounted:!1,_updating:!1,_destroyed:!1,render:function(){Q.renderInstance(this)},refs:new Proxy({},{get:(e,t)=>n.element.querySelector(`[data-ref="${t}"]`)})};return t.methods&&Object.entries(t.methods).forEach(([e,t])=>{n.methods[e]=t.bind(n)}),this.config.performance.monitoring&&this.setupPerformanceMonitoring(n),n}catch(n){throw ErrorManager.handle(n,{context:"ComponentManager.initializeComponent",data:{element:e,definition:t,props:a}})}},parseEventSelector(e){const t=e.trim().split(/\s+/);return[t[0],t.slice(1).join(" ")||null]},setupEvents(e,t){const a=Now.getManager("eventsystem"),n=Now.getManager("event");e._events||(e._events=new Map),Object.entries(t).forEach(([t,s])=>{const[r,i]=this.parseEventSelector(t),o=null==a?void 0:a.supportedEvents.includes(r);if(o&&a){const wrappedHandler=t=>{const a=i?t.target.closest(i):e.element;if(a&&e.element.contains(a)){t.delegateTarget=a;return s.call(e,t)}};e.element.addEventListener(r,wrappedHandler,{capture:!1,passive:!1}),e._events.set(r,{originalHandler:s,wrappedHandler:wrappedHandler,selector:i})}else if(!o&&n){const a=s.bind(e);e._events.set(t,{originalHandler:s,wrappedHandler:a,system:"eventmanager"}),n.on(t,a)}})},cleanupEvents(e){try{if(!(e._events&&e._events instanceof Map))return void(e._events=new Map);e._events.forEach((t,a)=>{t.wrappedHandler&&e.element.removeEventListener(a,t.wrappedHandler)}),e._events.clear()}catch(t){this.handleError("Error cleaning up events","cleanupEvents",{error:t})}},async mount(e,t,a={}){if(!e||!t)return void this.handleError("Invalid mount parameters","mount",{element:e,name:t,props:a});const n=this.components.get(t);if(n)try{const t=this.initializeComponent(e,n,a);return this.instances.set(e,t),t._definition.beforeCreate&&await t._definition.beforeCreate.call(t),t.element=this.processTemplate(e,n,t),t._definition.created&&await t._definition.created.call(t),t._definition.beforeMount&&await t._definition.beforeMount.call(t),await this.renderInstance(t),t._mounted=!0,t._definition.mounted&&await t._definition.mounted.call(t),t._definition.events&&this.setupEvents(t,t._definition.events),t.reactive&&(t.state=ReactiveManager.createComponentState(t),ReactiveManager.bindComponentEvents(t)),t}catch(s){throw this.handleError(s,"mount")}else this.handleError(`Component ${t} not found`,"mount",{element:e,name:t,props:a})},processTemplate(e,t,a){try{if(this.isValidComponentElement(e,t))return this.setupExistingElement(e,t,a.state);const s=this.getTemplate(e,t);if(!s)return e;const r=document.createElement("div");r.innerHTML=s.trim();r.querySelector('[data-component="api"]')||TemplateManager.processTemplateString(s,a,r);let i=r.firstElementChild;if(!i)throw new Error("Template must contain a root element");Array.from(e.attributes).forEach(e=>{i.hasAttribute(e.name)||i.setAttribute(e.name,e.value)});i.querySelectorAll("[data-component]").forEach(async e=>{const t=e.getAttribute("data-component");this.has(t)&&await this.mount(e,t)});try{const t=Now.getManager("element"),a=Now.getManager("form");t&&"function"==typeof t.destroyByElement&&t.destroyByElement(e),a&&"function"==typeof a.destroyFormByElement&&a.destroyFormByElement(e)}catch(n){this.handleError("Error during pre-replace cleanup","processTemplate",{error:n})}e.parentNode&&e.parentNode.replaceChild(i,e),a.element=i;try{const e=Now.getManager("element"),t=Now.getManager("form");e&&"function"==typeof e.scan&&e.scan(i),t&&"function"==typeof t.scan&&t.scan(i)}catch(n){this.handleError("Error during post-replace scan","processTemplate",{error:n})}return i}catch(s){return this.handleError(s,"processTemplate",{element:e,definition:t,context:a}),e}},isValidComponentElement:(e,t)=>!!t.validElement&&t.validElement(e),setupExistingElement(e,t,a){return this.setupElementAttributes(e,t),t.setupElement&&t.setupElement(e,a),e},getTemplate(e,t){if(t.template)return t.template;const a=e.getAttribute("data-template");if(a)return a;const n=e.getAttribute("data-template-id");if(n){const e=document.getElementById(n);return(null==e?void 0:e.innerHTML)||null}return null},createDefaultElement:(e,t,a)=>t.createDefaultElement?t.createDefaultElement(e,a):e,processTemplateString(e,t){if(this.config.templateCache){let a=this.templateCache.get(e);return a||(a=TemplateManager.processTemplateString(e,t),this.templateCache.set(e,a)),a}return TemplateManager.processTemplateString(e,t)},setupElementAttributes(e,t){e.classList.add(`component-${t.name}`),t.aria&&Object.entries(t.aria).forEach(([t,a])=>{e.setAttribute(`aria-${t}`,a)})},handleError:(e,t,a={})=>ErrorManager.handle(e,{context:`ComponentManager.${t}`,type:"error:component",data:a}),createVNode(e){try{const t=new DOMParser,a=t.parseFromString(e._definition.template,"text/html").body.firstChild;return this.elementToVNode(a,e.state)}catch(t){return this.handleError("Failed to create virtual node","createVNode",{error:t}),null}},elementToVNode(e,t){if(!e)return null;const a={tag:e.tagName.toLowerCase(),props:this.getElementProps(e),children:[],text:null};return 0===e.childNodes.length||1===e.childNodes.length&&3===e.childNodes[0].nodeType?(a.text=this.processTextContent(e.textContent,t),a):(Array.from(e.childNodes).forEach(e=>{if(3===e.nodeType){const n=this.processTextContent(e.textContent,t);n.trim()&&a.children.push({tag:null,props:null,children:[],text:n})}else 1===e.nodeType&&a.children.push(this.elementToVNode(e,t))}),a)},getElementProps(e){const t={};return Array.from(e.attributes).forEach(e=>{let a=e.name,n=e.value;return"class"===a?(a="className",void(t[a]=n)):"for"===a?(a="htmlFor",void(t[a]=n)):void(t[a]=n||a)}),t},processTextContent:(e,t)=>e.replace(/\{\{([^}]+)\}\}/g,(e,a)=>{const n=(a=a.trim()).split(".").reduce((e,t)=>null==e?void 0:e[t],t);return void 0!==n?n:e}),patch(e,t,a){if(!t)return e.innerHTML="",void e.appendChild(this.createRealNode(a));if(!a)return void e.parentNode.removeChild(e);if(this.shouldReplace(t,a)){const t=this.createRealNode(a);return void e.parentNode.replaceChild(t,e)}this.updateProps(e,t.props,a.props);const n=t.children||[],s=a.children||[],r=Math.max(n.length,s.length);for(let i=0;i<r;i++)this.patch(e.childNodes[i],n[i],s[i])},shouldReplace:(e,t)=>e.tag!==t.tag||e.text!==t.text,updateProps(e,t={},a={}){Object.keys(t).forEach(t=>{t in a||e.removeAttribute(t)}),Object.entries(a).forEach(([a,n])=>{t[a]!==n&&("className"!==a?a.startsWith("on")?e[a]=n:!1===n||null==n?e.removeAttribute(a):e.setAttribute(a,n):e.className=n)})},createRealNode(e){if(!e)return null;if(null!==e.text)return document.createTextNode(e.text);const t=document.createElement(e.tag);return e.props&&Object.entries(e.props).forEach(([e,a])=>{"className"!==e?e.startsWith("on")?t[e]=a:!1===a||null==a?t.removeAttribute(e):t.setAttribute(e,a):t.className=a}),e.children&&e.children.forEach(e=>{const a=this.createRealNode(e);a&&t.appendChild(a)}),t},getContextForPath(e){for(const t of this.instances.values())if(t.path===e||t.templatePath===e)return t;return null},async renderInstance(e){if(!e._updating&&!e._destroyed)try{e._updating=!0,e._definition.beforeUpdate&&await e._definition.beforeUpdate.call(e),TemplateManager.processTemplate(e.element,e),e._definition.updated&&await e._definition.updated.call(e)}catch(t){this.handleError("Component render error","renderInstance",{error:t})}finally{e._updating=!1}},async destroy(e){var t,a;const n=this.instances.get(e);if(n&&!n._destroyed)try{n._destroying=!0,n._definition.beforeDestroy&&await n._definition.beforeDestroy.call(n),n._events||(n._events=new Map),this.cleanupEvents(n),this.instances.delete(e),n._destroyed=!0,n._destroying=!1,n._definition.destroyed&&!n._destroyedCalled&&(n._destroyedCalled=!0,await n._definition.destroyed.call(n));const t=Now.getManager("template");t&&t.onComponentDestroy(n)}catch(s){this.handleError("Component destroy error","destroy",{error:s}),n._destroyed=!0,n._destroying=!1,this.instances.delete(e)}finally{null==(t=n._events)||t.clear(),null==(a=n._updateQueue)||a.clear(),n.element=null}},async cleanup(e){if(e)try{const t=e.querySelectorAll("[data-component]");for(const e of t){const t=this.instances.get(e);t&&t.state.initialized&&await this.destroy(e)}for(const[a,n]of this.instances.entries())e.contains(a)&&n.state.initialized&&await this.destroy(a)}catch(t){this.handleError("Container cleanup error","cleanup",{error:t,container:e})}},has(e){return this.components.has(e)},get(e){return this.components.get(e)||null},isComponentInitialized(e){const t=this.instances.get(e);return t&&t.state.initialized&&!t._destroyed},getInitializedComponents(e=document){const t=e.querySelectorAll("[data-component]"),a=[];return t.forEach(e=>{if(this.isComponentInitialized(e)){const t=this.instances.get(e);a.push({element:e,name:t._definition.name,id:t.id})}}),a},getComponentStatus(e){const t=this.instances.get(e);return t?t._destroyed?"destroyed":t.state.initialized?t._mounted?"mounted":"initializing":"not-initialized":"not-found"},forceUpdate(e){if(e&&!e._destroyed)return e._vnode=null,this.renderInstance(e)},clearCache(){this.templateCache.clear()},setupPerformanceMonitoring(e){const t={renders:0,totalRenderTime:0,lastRenderTime:0,averageRenderTime:0,slowRenderThreshold:16,recordRender(a){const n=t.now()-a;this.renders++,this.totalRenderTime+=n,this.lastRenderTime=n,this.averageRenderTime=this.totalRenderTime/this.renders,n>this.slowRenderThreshold&&console.warn(`Slow render detected for component ${e.id}:`,{renderTime:n,averageRenderTime:this.averageRenderTime})}};e._performance=t},async handleComponentError(e,t,a="unknown"){try{if(t._errorBoundary)return await t._errorBoundary.handler.call(t,e),void(t._errorBoundary.fallback&&(t.element.innerHTML=await this.loadTemplate(t._errorBoundary.fallback)));let n=t._parentComponent;for(;n;){if(n._errorBoundary)return void(await n._errorBoundary.handler.call(n,e));n=n._parentComponent}EventManager.emit("component:error",{error:e,instance:t,phase:a})}catch(n){this.handleError("Component error handling error","handleComponentError",{error:n})}},scheduleUpdate(e){if(!e._updating&&!e._destroyed){if(e._updateQueue.add(Date.now()),e._updateQueue.size>10){const t=Array.from(e._updateQueue),a=t[t.length-1]-t[0];a<1e3&&console.warn("Rapid updates detected:",{component:e.id,updates:e._updateQueue.size,timeSpan:a})}this.config.performance.batchUpdates?e._updateScheduled||(e._updateScheduled=!0,requestAnimationFrame(()=>{this.processUpdate(e),e._updateScheduled=!1})):this.processUpdate(e)}},async processUpdate(e){if(!e._updating&&!e._destroyed)try{e._updating=!0;const t=performance.now();e._definition.beforeUpdate&&await e._definition.beforeUpdate.call(e),await this.renderInstance(e),e._performance&&e._performance.recordRender(t),e._definition.updated&&await e._definition.updated.call(e)}catch(t){await this.handleComponentError(t,e,"update")}finally{e._updating=!1,e._updateQueue.clear()}},async cleanupComponent(e){if(e&&!e._destroyed)try{for(const t of e._childComponents)await this.cleanupComponent(t);e._parentComponent&&e._parentComponent._childComponents.delete(e),e._events.forEach((t,a)=>{e.element.removeEventListener(a,t)}),e._events.clear(),window.ReactiveManager&&ReactiveManager.cleanup(e.state),e._vnode=null,e._errorBoundary=null,e._childComponents.clear(),e._parentComponent=null,e._updateQueue.clear(),e.refs=null,e._destroyed=!0}catch(t){this.handleError("Component cleanup error","cleanupComponent",t)}},waitForElement:e=>new Promise(t=>{if(document.querySelector(e))return t(document.querySelector(e));const a=new MutationObserver(n=>{document.querySelector(e)&&(a.disconnect(),t(document.querySelector(e)))});a.observe(document.body,{childList:!0,subtree:!0})}),deepCompare(e,t){if(e===t)return!0;if("object"!=typeof e||"object"!=typeof t||null===e||null===t)return e===t;const a=Reflect.ownKeys(e),n=Reflect.ownKeys(t);if(a.length!==n.length)return!1;for(const s of a){if(!n.includes(s))return!1;const a=Object.getOwnPropertyDescriptor(e,s),r=Object.getOwnPropertyDescriptor(t,s);if(a.get||a.set||r.get||r.set){if(a.get!==r.get||a.set!==r.set)return!1}else if(!Q.deepCompare(e[s],t[s]))return!1}return!0},compareObjects(e,t){const a=Reflect.ownKeys(e),n=Reflect.ownKeys(t);a.filter(e=>n.includes(e)),a.filter(e=>!n.includes(e)),n.filter(e=>!a.includes(e)),Q.deepCompare(e,t)},_compareObjects(e){const t=Reflect.ownKeys(this),a=Reflect.ownKeys(e),n=t.filter(e=>a.includes(e)),s=[...t.filter(e=>!a.includes(e)),...a.filter(e=>!t.includes(e))];return{isEqual:Q.deepCompare(this,e),sameKeys:n,diffKeys:s}},getDebugInfo(){const e=Array.from(this.instances.entries()).map(([e,t])=>{var a;return{element:e.tagName+(e.id?`#${e.id}`:""),component:null==(a=t._definition)?void 0:a.name,id:t.id,initialized:t.state.initialized,mounted:t._mounted,destroyed:t._destroyed,status:this.getComponentStatus(e)}}),t=e.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+1,e),{});return{totalInstances:this.instances.size,stateCounts:t,instances:e,components:Array.from(this.components.keys())}}};(null==(d=window.Now)?void 0:d.registerManager)&&Now.registerManager("component",Q),window.ComponentManager=Q;const Z={config:{debug:!1,batchUpdates:!0,cleanupInterval:6e4,computed:{cache:!0}},state:{currentEffect:null,effects:new Set,dependencies:new Map,pendingUpdates:new Set,updateQueued:!1,rawToProxy:new WeakMap,proxyToRaw:new WeakMap,cleanedEffects:new WeakSet},async init(e={}){return this.config={...this.config,...e},this.startCleanup(),this},track(e,t){if(!this.state.currentEffect)return;const a=e.__reactiveId;if(!a)return;this.state.dependencies.has(a)||this.state.dependencies.set(a,new Map);const n=this.state.dependencies.get(a);n.has(t)||n.set(t,new Set);n.get(t).add(this.state.currentEffect)},trigger(e,t){const a=e.__reactiveId;if(!a)return;const n=this.state.dependencies.get(a);if(!n)return void this.triggerEffects();const s=n.get(t);s?this.runEffects(s):this.triggerEffects()},triggerEffects(){this.state.effects.forEach(e=>{e.active&&(this.config.batchUpdates?(this.state.pendingUpdates.add(e),this.scheduleUpdate()):this.runEffect(e))})},runEffects(e){e.forEach(e=>{e.active&&(this.config.batchUpdates?(this.state.pendingUpdates.add(e),this.scheduleUpdate()):this.runEffect(e))})},runEffect(e){try{e()}catch(t){ErrorManager.handle(t,{context:"ReactiveManager.runEffect",data:{effect:e}})}},scheduleUpdate(){this.state.updateQueued||(this.state.updateQueued=!0,queueMicrotask(()=>{this.flushUpdates()}))},flushUpdates(){if(!this.state.updateQueued)return;const e=Array.from(this.state.pendingUpdates);this.state.pendingUpdates.clear(),this.state.updateQueued=!1,e.forEach(e=>{e.active&&e()})},reactive(e){return e&&"object"==typeof e?(e.__reactiveId||(e.__reactiveId=this.generateId()),Object.defineProperty(e,"__isReactive",{value:!0,enumerable:!1,configurable:!1}),Array.isArray(e)?this.createArrayProxy(e):new Proxy(e,{get:(e,t)=>("__reactiveId"===t||"__isReactive"===t||this.state.currentEffect&&this.track(e,t),e[t]),set:(e,t,a)=>{const n=e[t];return e[t]=a,n!==a&&this.trigger(e,t),!0}})):e},effect(e){const effect=()=>{if(!effect.active)return;const t=this.state.currentEffect;this.state.currentEffect=effect;try{e()}finally{this.state.currentEffect=t}};return effect.active=!0,effect.isEffect=!0,effect(),this.state.effects.add(effect),()=>{effect.active=!1,this.cleanupEffect(effect),this.state.effects.delete(effect)}},isReactive:e=>Boolean(e&&e.__isReactive),computed(e){let t,a=!0;return{get value(){const n=Z.state.currentEffect;Z.state.currentEffect=()=>{a=!0};const s=(()=>{try{return a&&(t=e(),a=!1),t}catch(n){throw n}})();return Z.state.currentEffect=n,s}}},watch(e,t,a){return"function"==typeof e?this.watchEffect(e,t):this.watchProp(e,t,a)},watchEffect(e,t){let a=!0;const effect=()=>{if(a)try{const n=e();return a&&"function"==typeof t&&t(n),n}catch(n){throw n}};effect.isEffect=!0,effect.active=!0;const n=this.state.currentEffect;this.state.currentEffect=effect;try{effect()}finally{this.state.currentEffect=n}return this.state.effects.add(effect),()=>{a=!1,effect.active=!1,this.state.effects.delete(effect),this.cleanupEffect(effect)}},watchProp(e,t,a,n={}){e.__reactiveId||(e.__reactiveId=this.generateId());const effect=()=>{if(!effect.active)return;const n=e[t];a(n)};effect.active=!0,effect.isEffect=!0,this.state.dependencies.has(e.__reactiveId)||this.state.dependencies.set(e.__reactiveId,new Map);const s=this.state.dependencies.get(e.__reactiveId);return s.has(t)||s.set(t,new Set),s.get(t).add(effect),effect(),()=>{effect.active=!1;const a=this.state.dependencies.get(e.__reactiveId);a&&a.has(t)&&a.get(t).delete(effect)}},isProxy:e=>Boolean(e&&e.__isReactive),findComponentForTarget(e){for(const[t,a]of this.state.componentStates)if(this.isStateTarget(e,a))return ComponentManager.instances.get(t);return null},isStateTarget(e,t){if(e===t)return!0;for(const a of Object.values(t))if(a&&"object"==typeof a&&(a===e||this.isStateTarget(e,a)))return!0;return!1},queueEffect(e){if(e.active)if(this.config.batchUpdates)this.state.pendingUpdates.add(e),this.scheduleUpdate();else try{e()}catch(t){throw t}},createComponentState(e){try{if(!e.reactive)return e.state;const t=this.reactive(e.state);return this.state.componentStates.set(e.id,t),t}catch(t){return ErrorManager.handle(t,{context:"ReactiveManager.createComponentState",data:{component:e}}),e.state}},getStateValue:(e,t)=>t.split(".").reduce((e,t)=>null==e?void 0:e[t],e),watchDeep(e,t,a={}){return this.watch(()=>JSON.parse(JSON.stringify(e)),t,{...a,deep:!0})},setStateValue(e,t,a){const n=this.deepClone(a),s=t.split("."),r=s.pop(),i=s.reduce((e,t)=>e[t],e);i&&(i[r]=n)},bindComponentEvents(e){if(e.events)try{const t=Now.getManager("event");if(!t)return void ErrorManager.handle("Event system not available",{context:"ReactiveManager.bindComponentEvents"});Object.entries(e.events).forEach(([a,n])=>{const s=n.bind(e);e._eventHandlers||(e._eventHandlers=new Map),e._eventHandlers.set(a,s),t.on(a,s)})}catch(t){ErrorManager.handle(t,{context:"ReactiveManager.bindComponentEvents",data:{component:e}})}},unbindComponentEvents(e){if(!e._eventHandlers)return;const t=Now.getManager("event");t&&(e._eventHandlers.forEach((e,a)=>{t.off(a,e)}),e._eventHandlers.clear(),delete e._eventHandlers)},createStateProxy(){return new Proxy(this.state,{set:(e,t,a)=>(Array.isArray(e)&&/^\d+$/.test(t)&&this.notifyArrayChange(e),e[t]=a,this.notifyChange(t),!0)})},notifyArrayChange(e){const t=this.state.watchers.get(e);t&&(this.notifyWatchers(e,"length",e.length),t.forEach((t,a)=>{"length"!==a&&this.notifyWatchers(e,a,e[a])}))},notifyChange(e){this.getWatchers(e).forEach(t=>{try{this.state.pendingUpdates.add(()=>t(this.state[e])),this.scheduleUpdate(),EventManager.emit("reactive:change",{property:e,value:this.state[e]})}catch(a){throw a}})},runWithTracking(e){const t=this.state.currentEffect;this.state.currentEffect=e;try{return e()}finally{this.state.currentEffect=t}},startCleanup(){this.state.cleanupTimer=setInterval(()=>{this.cleanup()},this.config.cleanupInterval),window.addEventListener("beforeunload",()=>{this.cleanup(),clearInterval(this.state.cleanupTimer)}),document.addEventListener("visibilitychange",()=>{"hidden"===document.visibilityState&&(this.cleanup(),clearInterval(this.state.cleanupTimer))})},cleanup(){for(const[e,t]of this.state.dependencies){for(const[e,a]of t){const n=new Set(Array.from(a).filter(e=>this.isWatcherValid(e)));0===n.size?t.delete(e):t.set(e,n)}0===t.size&&this.state.dependencies.delete(e)}for(const[e,t]of this.state.computedCache)this.isWatcherValid(e)||this.state.computedCache.delete(e)},isWatcherValid(e){for(const t of this.state.dependencies.values())for(const a of t.values())if(a.has(e))return!0;return!1},cleanupEffect(e){if(e){this.state.cleanedEffects.add(e);for(const[t,a]of this.state.dependencies)if(a){for(const[t,n]of a)n.has(e)&&(n.delete(e),0===n.size&&a.delete(t));0===a.size&&this.state.dependencies.delete(t)}this.state.pendingUpdates.delete(e)}},deepClone:e=>"object"!=typeof e||null===e?e:JSON.parse(JSON.stringify(e)),validateState(e){if(!e||"object"!=typeof e)throw new Error("Invalid state object")},createComputation(e,t){const a={fn:e,context:t,dependencies:new Set,isComputing:!1};return this.state.effects.add(a),a},runComputation(e){var t;if(!e||e.isComputing)return;if(null==(t=e.context)?void 0:t._skipReactive)return;e.isComputing=!0;const a=this.state.currentEffect;this.state.currentEffect=e;try{this.cleanup(e),e.fn.call(e.context)}finally{e.isComputing=!1,this.state.currentEffect=a}},_bindComponentEvents(e){if(!e||!e.reactive)return;const t=this.createComputation(()=>{e._skipReactive||"function"!=typeof e.render||e.render()},e);this.runComputation(t),e.watch&&Object.entries(e.watch).forEach(([t,a])=>{const n=this.createComputation(()=>{e._skipReactive||a.call(e,e.state[t])},e);this.track(t),this.runComputation(n)})},_addDependency(e){if(this.state.currentEffect){this.state.currentEffect.dependencies.add(e);const t=`${e.target.id}:${e.prop}`;this.state.dependencies.has(t)||this.state.dependencies.set(t,new Set),this.state.dependencies.get(t).add(this.state.currentEffect)}},createComponentState(e){const t={...e.state};return new Proxy(t,{get:(t,a)=>(this.addDependency({target:e,prop:a}),t[a]),set:(t,a,n)=>{const s=t[a];return t[a]=n,this.triggerUpdate({target:e,prop:a,oldValue:s,newValue:n}),!0}})},_triggerUpdate(e){const t=`${e.target.id}:${e.prop}`,a=this.state.dependencies.get(t);a&&a.forEach(e=>{this.runComputation(e)})},cleanupDependencies(e){e&&this.cleanup(e)},isIterable:e=>null!=e&&"function"==typeof e[Symbol.iterator],getDependenciesArray(e){return e?this.isIterable(e)?Array.from(e):Array.isArray(e)?e:[]:[]},isValidComputation:e=>e&&"object"==typeof e&&"function"==typeof e.fn&&e.dependencies instanceof Set,createComputation(e,t){if("function"!=typeof e)throw new Error("Computation must be a function");const a={fn:e,context:t,dependencies:new Set,isComputing:!1};if(this.isValidComputation(a))return this.state.effects.add(a),a;throw new Error("Invalid computation created")},cleanup(e){if(!this.isValidComputation(e))return;this.getDependenciesArray(e.dependencies).forEach(t=>{if(!t||!t.target||!t.prop)return;const a=`${t.target.id}:${t.prop}`,n=this.state.dependencies.get(a);n instanceof Set&&(n.delete(e),0===n.size&&this.state.dependencies.delete(a))}),e.dependencies.clear()},addDependency(e){var t,a;if(null==(a=null==(t=this.state.currentEffect)?void 0:t.context)?void 0:a._skipReactive)return;if(!this.state.currentEffect||!this.isValidComputation(this.state.currentEffect))return;if(!e||!e.target||!e.prop)return;this.state.currentEffect.dependencies.add(e);const n=`${e.target.id}:${e.prop}`;this.state.dependencies.has(n)||this.state.dependencies.set(n,new Set);const s=this.state.dependencies.get(n);s instanceof Set&&s.add(this.state.currentEffect)},triggerUpdate(e){if(!e||!e.target||!e.prop)return;if(e.target._skipReactive)return;const t=`${e.target.id}:${e.prop}`,a=this.state.dependencies.get(t);a instanceof Set&&a.forEach(e=>{this.isValidComputation(e)?this.runComputation(e):a.delete(e)})},runComputation(e){if(!this.isValidComputation(e)||e.isComputing)return;e.isComputing=!0;const t=this.state.currentEffect;this.state.currentEffect=e;try{this.cleanup(e),e.fn.call(e.context)}catch(a){throw a}finally{e.isComputing=!1,this.state.currentEffect=t}},bindComponentEvents(e){if(e&&e.reactive)try{const t=this.createComputation(()=>{"function"==typeof e.render&&e.render()},e);this.runComputation(t),e.watch&&"object"==typeof e.watch&&Object.entries(e.watch).forEach(([t,a])=>{if("function"==typeof a){const n=this.createComputation(()=>{a.call(e,e.state[t])},e);this.track(t),this.runComputation(n)}})}catch(t){throw t}},_track(e){if("function"!=typeof e)return null;const t=this.state.currentEffect,a=this.createComputation(e,null);try{return this.runComputation(a),a}catch(n){throw n}finally{this.state.currentEffect=t}},_createComponentState(e){if(!e||!e.state)return{};const t={...e.state};return new Proxy(t,{get:(t,a)=>(a in t&&(e._skipReactive||this.addDependency({target:e,prop:a})),t[a]),set:(t,a,n)=>{const s=t[a];return t[a]=n,this.triggerUpdate({target:e,prop:a,oldValue:s,newValue:n}),!0}})},validateConfig(e){if(!e||"object"!=typeof e)throw new Error("Invalid configuration object")},deepClone(e,t=new WeakMap){if(!e||"object"!=typeof e)return e;if(t.has(e))return t.get(e);const a=Array.isArray(e)?[]:{};return t.set(e,a),Object.entries(e).forEach(([e,n])=>{a[e]=this.deepClone(n,t)}),a},createArrayProxy(e){e.__reactiveId||(e.__reactiveId=this.generateId());const t=this;return new Proxy(e,{get(e,a){t.track(e,a);const n=e[a];return"function"==typeof n?function(...s){const r=e.length,i=n.apply(e,s);if(["push","pop","shift","unshift","splice"].includes(a)){const a=e.length;if(r!==a){t.trigger(e,"length");for(let n=r;n<a;n++)t.trigger(e,n.toString())}}return i}:n},set(e,a,n){const s=e[a],r=e.length;e[a]=n,s!==n&&t.trigger(e,a);return e.length!==r&&t.trigger(e,"length"),!0}})},enableDebug(){DEBUG.enabled=!0},disableDebug(){DEBUG.enabled=!1},getDebugInfo(){return{dependencies:Array.from(this.state.dependencies.entries()),computedCache:Array.from(this.state.computedCache.entries()),pendingUpdates:Array.from(this.state.pendingUpdates),componentStates:Array.from(this.state.componentStates.entries())}},handleLifecycle(e,t){if(e&&t)switch(t){case"mount":this.setupComponentReactivity(e);break;case"unmount":this.cleanupComponentReactivity(e);break;case"update":this.updateComponentReactivity(e)}},setupComponentReactivity(e){e.reactive&&(e.state=this.reactive(e.state||{}),e.watch&&Object.entries(e.watch).forEach(([t,a])=>{this.watch(()=>e.state[t],a.bind(e))}),e.computed&&Object.entries(e.computed).forEach(([t,a])=>{Object.defineProperty(e,t,{get:()=>this.computed(a.bind(e))(),enumerable:!0})}))},cleanupComponentReactivity(e){if(!e.id)return;this.state.componentStates.delete(e.id);Array.from(this.state.dependencies.values()).filter(t=>this.isComponentDependency(t,e)).forEach(e=>{this.cleanupDependencies(e)})},updateComponentReactivity(e){this.cleanupComponentReactivity(e),this.setupComponentReactivity(e)},isComponentDependency:(e,t)=>Array.from(e.values()).some(e=>Array.from(e).some(e=>e.component===t)),notifyWatchers(e,t,a,n){const s=this.state.watchers.get(e);if(!s)return;const r=s.get(t);r&&r.forEach(s=>{try{this.config.batchUpdates?(this.state.pendingUpdates.add(()=>s(a,n)),this.scheduleUpdate()):s(a,n)}catch(r){ErrorManager.handle(r,{context:"ReactiveManager.notifyWatchers",data:{target:e,key:t,value:a,oldValue:n}})}})},batch(e){this.state.batchDepth++;try{const t=e();return t instanceof Promise?t.finally(()=>{this.state.batchDepth--,0===this.state.batchDepth&&this.flushUpdates()}):(this.state.batchDepth--,0===this.state.batchDepth&&this.flushUpdates(),t)}catch(t){throw this.state.batchDepth--,0===this.state.batchDepth&&this.flushUpdates(),t}},generateId:()=>"reactive_"+Math.random().toString(36).substr(2,9)};(null==(u=window.Now)?void 0:u.registerManager)&&Now.registerManager("reactive",Z),window.ReactiveManager=Z;let ee=(__publicField(h=class{static evaluate(e,t,a){try{if(!(null==e?void 0:e.trim()))return;if("!true"===e||"!false"===e){return!("!true"===e)}const n=e.match(/^(['"])(.*)(\1)$/);if(n)return n[2];const s=e.match(/^(.+?)\s*\?\s*(.+?)\s*:\s*(.+)$/);if(s){const[,e,n,r]=s,i=this.evaluate(e.trim(),t,a);return i&&"0"!==i&&0!==i?this.evaluate(n.trim(),t,a):this.evaluate(r.trim(),t,a)}if(/^[\w.]+$/.test(e)){return this.getPropertyPath(e,t,a)}const r=this.tokenize(e);let i;const o=this.toPostfix(r);if(2===o.length){const e=this.getPropertyPath(o[1],t,a);i=void 0===e?void 0:t[o[0]].call(a,e)}else i=this.evaluatePostfix(o,t,a);return i}catch(n){return void ErrorManager.handle(n,{context:"ExpressionEvaluator.evaluate",data:{expression:e,state:t,context:a}})}}static getPropertyPath(e,t,a){return"string"!=typeof e?e:e.split(".").reduce((e,n)=>{if(null==e)return;if(e.computed&&"function"==typeof e.computed[n])return e.computed[n].call(e);let s=e[n];if(void 0!==s)return"function"==typeof s&&(s=s.call(a)),s;if(t[n]){return"function"==typeof t[n]?t[n].call(a):t[n]}return e.state&&e.state.hasOwnProperty(n)?e.state[n]:void 0},a||t)}static tokenize(e){const t=[];let a="";const pushToken=()=>{a&&(t.push(a),a="")};for(let n=0;n<e.length;n++){const s=e[n];if('"'===s||"'"===s){const t=s;for(pushToken(),a=s,n++;n<e.length&&e[n]!==t;)a+=e[n],n++;a+=t,pushToken();continue}if(/[+\-*/%=!&|<>]/.test(s)){pushToken();let a=s,r=e[n+1];for(;r&&/[=&|><]/.test(r);)a+=r,n++,r=e[n+1];t.push(a);continue}"("!==s&&")"!==s?/\s/.test(s)?pushToken():a+=s:(pushToken(),t.push(s))}return pushToken(),t}static toPostfix(e){const t=[],a=[],n={"!":4,"*":3,"/":3,"%":3,"+":2,"-":2,">=":1,"<=":1,">":1,"<":1,"===":1,"!==":1,"==":1,"!=":1,"&&":0,"||":0};for((e.forEach(e=>{if(e in this.operators){for(;a.length>0&&"("!==a[a.length-1]&&n[a[a.length-1]]>=n[e];)t.push(a.pop());a.push(e)}else if("("===e)a.push(e);else if(")"===e){for(;a.length>0&&"("!==a[a.length-1];)t.push(a.pop());a.pop()}else t.push(e)}));a.length>0;)t.push(a.pop());return t}static evaluatePostfix(e,t,a){const n=[];return e.forEach(e=>{if(e in this.operators){const s=this.operators[e],r="!"===e?1:2,i=n.splice(-r).map(e=>/^["'].*["']$/.test(e)?e.slice(1,-1):/^-?\d+(\.\d+)?$/.test(e)?Number(e):"true"===e||"false"!==e&&("null"===e?null:"undefined"!==e?this.getPropertyPath(e,t,a):void 0));if(1===r){if(void 0===i[0])return}else if(void 0===i[0]||void 0===i[1])return;"+"!==e||"string"!=typeof i[0]&&"string"!=typeof i[1]?n.push(s(...i)):n.push(String(i[0])+String(i[1]))}else n.push(e)}),n[0]}},"operators",{"+":(e,t)=>Number(e)+Number(t),"-":(e,t)=>Number(e)-Number(t),"*":(e,t)=>Number(e)*Number(t),"/":(e,t)=>Number(e)/Number(t),"%":(e,t)=>Number(e)%Number(t),"===":(e,t)=>e===t,"!==":(e,t)=>e!==t,"!=":(e,t)=>e!=t,">":(e,t)=>e>t,">=":(e,t)=>e>=t,"<":(e,t)=>e<t,"<=":(e,t)=>e<=t,"==":(e,t)=>e==t,"&&":(e,t)=>e&&t,"||":(e,t)=>e||t,"!":e=>!e,"+str":(e,t)=>String(e)+String(t)}),h);window.ExpressionEvaluator=ee;const te={setupWatchers(e,t,a={}){if(!e||!t||!a){const n=new Error("Missing required parameters: component instance, state object, or watchers");return void ErrorManager.handle(n,{context:"WatchManager.setupWatchers",data:{instance:e,state:t,watchers:a}})}return e._watchers||(e._watchers=new Map),Object.entries(a).forEach(([n,s])=>{try{const a="function"==typeof s?{handler:s,immediate:!1,deep:!1}:{immediate:!1,deep:!1,...s};if("function"!=typeof a.handler)throw new Error(`Invalid watcher handler: expected function for path "${n}"`);if(e._watchers.has(n))return;const r=this.getDeepValue(n,t);let i;i=a.debounce>0?this.debounce(function(t,s){try{a.handler.call(this,t,s)}catch(r){ErrorManager.handle(r,{context:"WatchManager.handler",source:e.id,notify:!0,data:{path:n}})}},a.debounce):function(t,s){try{a.handler.call(this,t,s)}catch(r){ErrorManager.handle(r,{context:"WatchManager.handler",source:e.id,notify:!0,data:{path:n}})}};const o={path:n,handler:i.bind(e),lastValue:this.deepClone(r),config:a,active:!0};e._watchers.set(n,o),a.immediate&&o.handler(r,void 0)}catch(r){const s=new Error(`Failed to setup watcher for "${n}": ${r.message}`);ErrorManager.handle(s,{context:"WatchManager.setupWatchers",data:{source:e.id,state:t,watchers:a}})}}),!0},getDeepValue:(e,t)=>e.split(".").reduce((e,t)=>{var a;if(t.includes("[")&&t.includes("]")){const n=t.split("[")[0],s=parseInt(t.split("[")[1].split("]")[0]);return null==(a=null==e?void 0:e[n])?void 0:a[s]}return null==e?void 0:e[t]},t),deepClone(e,t=new WeakMap){if(null===e||"object"!=typeof e)return e;if(t.has(e))return t.get(e);if(e instanceof Date)return new Date(e);if(Array.isArray(e)){const a=[];return t.set(e,a),e.forEach((e,n)=>{a[n]=this.deepClone(e,t)}),a}const a={};return t.set(e,a),Object.entries(e).forEach(([e,n])=>{a[e]=this.deepClone(n,t)}),a},deepEqual(e,t){if(e===t)return!0;if("object"!=typeof e||"object"!=typeof t)return!1;if(Array.isArray(e))return!(!Array.isArray(t)||e.length!==t.length)&&e.every((e,a)=>this.deepEqual(e,t[a]));const a=Object.keys(e),n=Object.keys(t);return a.length===n.length&&a.every(a=>Object.prototype.hasOwnProperty.call(t,a)&&this.deepEqual(e[a],t[a]))},triggerWatchers(e){(null==e?void 0:e._watchers)&&e._watchers.forEach(t=>{if(t.active)try{let n;try{n=this.getDeepValue(t.path,e.state)}catch(a){return ErrorManager.handle(a,{context:"WatchManager.getter",data:{source:e.id,path:t.path},notify:!0}),void(t.active=!1)}(t.config.deep?!this.deepEqual(n,t.lastValue):n!==t.lastValue)&&(t.handler(this.deepClone(n),this.deepClone(t.lastValue)),t.lastValue=this.deepClone(n))}catch(a){ErrorManager.handle(a,{context:"WatchManager.triggerWatchers",data:{source:e.id,path:t.path},notify:!0}),t.active=!1}})},cleanupWatchers(e){(null==e?void 0:e._watchers)&&(e._watchers.forEach(e=>{e.handler.cancel&&e.handler.cancel(),e.active=!1}),e._watchers.clear())},debounce(e,t=100){let a=null;const n=this,debouncedFn=function(...s){a&&clearTimeout(a),a=setTimeout(()=>{e.apply(n,s)},t)};return debouncedFn.cancel=function(){a&&(clearTimeout(a),a=null)},debouncedFn}};window.WatchManager=te;const ae={config:{defaultDB:"now_app_storage",defaultVersion:1,maxRetries:3,retryDelay:300,autoInit:!0,defaultStoreConfig:{keyPath:"id",autoIncrement:!0,indexes:[]},storeSizeWarningThreshold:52428800,cacheLookups:!0,cacheMaxAge:6e4,defaultAdapter:"indexeddb",statistics:{enabled:!0,trackOperations:!0,trackTiming:!0},stores:{}},state:{initialized:!1,databases:new Map,databaseSchemas:new Map,cache:new Map,statistics:{operations:{reads:0,writes:0,updates:0,deletes:0,queries:0},timing:{totalTime:0,operationCount:0},errors:0,storeSize:{}},lastError:null},async init(e={}){try{if(this.config={...this.config,...e},!this.isSupported())throw new Error("IndexedDB is not supported in this browser");if(this.state.initialized=!0,this.config.stores&&Object.keys(this.config.stores).length>0){const e={name:this.config.defaultDB,version:this.config.defaultVersion,stores:this.config.stores};await this.createDatabase(e)}return EventManager.emit("storage:ready",{manager:"StorageManager"}),this}catch(t){throw this.state.lastError=t,this.state.statistics.errors++,window.ErrorManager&&ErrorManager.handle(t,{context:"StorageManager.init",type:"storage:error"}),t}},isSupported:()=>!!window.indexedDB,async createDatabase(e){const{name:t,version:a,stores:n}=e;return new Promise((e,s)=>{if(this.state.databases.has(t)){const n=this.state.databases.get(t),s=n.version;if(!(a>s))return void e(n);n.close(),this.state.databases.delete(t)}this.state.databaseSchemas.set(t,{stores:n});const r=indexedDB.open(t,a);r.onerror=e=>{const a=new Error(`Failed to open database ${t}: ${e.target.error}`);this.state.lastError=a,this.state.statistics.errors++,s(a)},r.onsuccess=a=>{const n=a.target.result;this.state.databases.set(t,n),n.onerror=e=>{this.state.statistics.errors++},e(n)},r.onupgradeneeded=e=>{const t=e.target.result;e.oldVersion,e.newVersion;for(const[s,r]of Object.entries(n))try{if(t.objectStoreNames.contains(s)){if(r.update){const t=e.target.transaction.objectStore(s);if(r.indexes&&Array.isArray(r.indexes)){const e=Array.from(t.indexNames);r.indexes.forEach(a=>{const{name:n,keyPath:s,options:r}=a;e.includes(n)||t.createIndex(n,s,r||{unique:!1})})}}}else{const e={...this.config.defaultStoreConfig,...r},a=t.createObjectStore(s,{keyPath:e.keyPath,autoIncrement:e.autoIncrement});e.indexes&&Array.isArray(e.indexes)&&e.indexes.forEach(e=>{const{name:t,keyPath:n,options:s}=e;a.createIndex(t,n,s||{unique:!1})})}}catch(a){console.error(`StorageManager: Failed to create object store '${s}':`,a),this.state.statistics.errors++}}})},async add(e,t,a=this.config.defaultDB){const n=this.config.statistics.trackTiming?performance.now():0;let s=0;const executeOperation=async()=>{try{const n=await this.getDatabase(a);if(!n||"closed"===n.readyState)throw new Error(`Database ${a} is closed or invalid`);if(!n.objectStoreNames.contains(e))throw new Error(`Object store ${e} does not exist in database ${a}`);return new Promise((s,r)=>{try{const i=n.transaction(e,"readwrite"),o=i.objectStore(e);let l=[];const c=Array.isArray(t);if(i.onerror=t=>{r(new Error(`Failed to add data to ${e}: ${t.target.error}`))},i.oncomplete=()=>{this.invalidateStoreCache(a,e),this.config.statistics.trackOperations&&(this.state.statistics.operations.writes+=c?t.length:1),s(c?l:l[0])},c){let e=0;const addNext=()=>{if(e<t.length)try{const a=o.add(t[e]);a.onsuccess=t=>{l.push(t.target.result),e++,addNext()},a.onerror=t=>{i.abort(),r(new Error(`Failed to add item ${e}: ${t.target.error}`))}}catch(a){i.abort(),r(new Error(`Error in add operation: ${a.message}`))}};addNext()}else{o.add(t).onsuccess=e=>{l.push(e.target.result)}}}catch(i){r(new Error(`Transaction error: ${i.message}`))}})}catch(n){if(s<this.config.maxRetries)return s++,await new Promise(e=>setTimeout(e,this.config.retryDelay)),executeOperation();throw n}};try{const t=await executeOperation();if(this.config.statistics.trackTiming){const e=performance.now();this.state.statistics.timing.totalTime+=e-n,this.state.statistics.timing.operationCount++}return await this.updateStoreStats(a,e),t}catch(r){throw this.state.lastError=r,this.state.statistics.errors++,r}},async update(e,t,a=this.config.defaultDB){const n=this.config.statistics.trackTiming?performance.now():0;let s=0;const executeOperation=async()=>{try{const n=await this.getDatabase(a);return new Promise((s,r)=>{const i=n.transaction(e,"readwrite"),o=i.objectStore(e);let l=0;const c=Array.isArray(t)?t:[t];i.onerror=t=>{r(new Error(`Failed to update data in ${e}: ${t.target.error}`))},i.oncomplete=()=>{this.invalidateStoreCache(a,e),this.config.statistics.trackOperations&&(this.state.statistics.operations.updates+=l),s(!0)};let d=0;const updateNext=()=>{if(d<c.length){const e=c[d],t=o.put(e);t.onsuccess=()=>{l++,d++,updateNext()},t.onerror=e=>{d++,updateNext()}}};updateNext()})}catch(n){if(s<this.config.maxRetries)return s++,await new Promise(e=>setTimeout(e,this.config.retryDelay)),executeOperation();throw n}};try{const e=await executeOperation();if(this.config.statistics.trackTiming){const e=performance.now();this.state.statistics.timing.totalTime+=e-n,this.state.statistics.timing.operationCount++}return e}catch(r){throw this.state.lastError=r,this.state.statistics.errors++,r}},async getById(e,t,a=this.config.defaultDB){const n=this.config.statistics.trackTiming?performance.now():0,s=`${a}:${e}:${t}`;if(this.config.cacheLookups&&this.state.cache.has(s)){const e=this.state.cache.get(s);if(Date.now()-e.timestamp<this.config.cacheMaxAge)return e.data;this.state.cache.delete(s)}let r=0;const executeOperation=async()=>{try{const n=await this.getDatabase(a);return n.objectStoreNames.contains(e)?new Promise((a,r)=>{const i=n.transaction(e,"readonly").objectStore(e).get(t);i.onerror=a=>{r(new Error(`Failed to retrieve ID ${t} from ${e}: ${a.target.error}`))},i.onsuccess=e=>{const t=e.target.result||null;this.config.cacheLookups&&t&&this.state.cache.set(s,{data:t,timestamp:Date.now()}),this.config.statistics.trackOperations&&this.state.statistics.operations.reads++,a(t)}}):null}catch(n){if(r<this.config.maxRetries)return r++,await new Promise(e=>setTimeout(e,this.config.retryDelay)),executeOperation();throw n}};try{const e=await executeOperation();if(this.config.statistics.trackTiming){const e=performance.now();this.state.statistics.timing.totalTime+=e-n,this.state.statistics.timing.operationCount++}return e}catch(i){throw this.state.lastError=i,this.state.statistics.errors++,i}},async getAll(e,t={},a=this.config.defaultDB){const n=this.config.statistics.trackTiming?performance.now():0;let s=0;const executeOperation=async()=>{try{const n=await this.getDatabase(a);return n.objectStoreNames.contains(e)?new Promise((a,s)=>{const r=n.transaction(e,"readonly").objectStore(e),i=t.index?r.index(t.index):r,o=t.direction||"next",l=[];let c=0,d=0;const u=t.offset||0,h=t.limit||1/0;if(i.getAll&&!t.filter&&0===u){const n=h===1/0?void 0:h,r=i.getAll(t.range,n);return r.onsuccess=e=>{this.config.statistics.trackOperations&&(this.state.statistics.operations.reads+=e.target.result.length,this.state.statistics.operations.queries++),a(e.target.result)},void(r.onerror=t=>{s(new Error(`Failed to retrieve data from ${e}: ${t.target.error}`))})}const p=i.openCursor(t.range,o);p.onerror=t=>{s(new Error(`Failed to retrieve data from ${e}: ${t.target.error}`))},p.onsuccess=e=>{const n=e.target.result;if(n){if(d<u)return d++,void n.continue();const e=n.value;t.filter&&!t.filter(e)||(l.push(e),c++),c<h?n.continue():(this.config.statistics.trackOperations&&(this.state.statistics.operations.reads+=c,this.state.statistics.operations.queries++),a(l))}else this.config.statistics.trackOperations&&(this.state.statistics.operations.reads+=c,this.state.statistics.operations.queries++),a(l)}}):[]}catch(n){if(s<this.config.maxRetries)return s++,await new Promise(e=>setTimeout(e,this.config.retryDelay)),executeOperation();throw n}};try{const e=await executeOperation();if(this.config.statistics.trackTiming){const e=performance.now();this.state.statistics.timing.totalTime+=e-n,this.state.statistics.timing.operationCount++}return e}catch(r){throw this.state.lastError=r,this.state.statistics.errors++,r}},async query(e,t,a={},n=this.config.defaultDB){const s=this.config.statistics.trackTiming?performance.now():0;let r=0;const executeOperation=async()=>{try{const s=await this.getDatabase(n);return s.objectStoreNames.contains(e)?new Promise((n,r)=>{const i=s.transaction(e,"readonly").objectStore(e);let o=i,l=null;if(t.index){if(!i.indexNames.contains(t.index))return void r(new Error(`Index ${t.index} does not exist in ${e}`));o=i.index(t.index)}t.range?l=t.range:void 0!==t.value&&(l=IDBKeyRange.only(t.value));const c=a.direction||"next",d=[],u=a.limit||1/0;if(o.getAll&&!a.filter&&u===1/0){const t=o.getAll(l);return t.onsuccess=e=>{const t=e.target.result;this.config.statistics.trackOperations&&(this.state.statistics.operations.reads+=t.length,this.state.statistics.operations.queries++),n(t)},void(t.onerror=t=>{r(new Error(`Failed to query data in ${e}: ${t.target.error}`))})}let h=0;const p=o.openCursor(l,c);p.onerror=t=>{r(new Error(`Failed to query data in ${e}: ${t.target.error}`))},p.onsuccess=e=>{const t=e.target.result;t&&h<u?(d.push(t.value),h++,t.continue()):(this.config.statistics.trackOperations&&(this.state.statistics.operations.reads+=d.length,this.state.statistics.operations.queries++),n(d))}}):[]}catch(s){if(r<this.config.maxRetries)return r++,await new Promise(e=>setTimeout(e,this.config.retryDelay)),executeOperation();throw s}};try{const e=await executeOperation();if(this.config.statistics.trackTiming){const e=performance.now();this.state.statistics.timing.totalTime+=e-s,this.state.statistics.timing.operationCount++}return e}catch(i){throw this.state.lastError=i,this.state.statistics.errors++,i}},async count(e,t={},a=this.config.defaultDB){const n=this.config.statistics.trackTiming?performance.now():0;let s=0;const executeOperation=async()=>{try{const n=await this.getDatabase(a);return n.objectStoreNames.contains(e)?new Promise((a,s)=>{const r=n.transaction(e,"readonly").objectStore(e);let i=r,o=null;if(t.index){if(!r.indexNames.contains(t.index))return void s(new Error(`Index ${t.index} does not exist in ${e}`));i=r.index(t.index)}t.range?o=t.range:void 0!==t.value&&(o=IDBKeyRange.only(t.value));const l=i.count(o);l.onerror=t=>{s(new Error(`Failed to count data in ${e}: ${t.target.error}`))},l.onsuccess=e=>{const t=e.target.result;this.config.statistics.trackOperations&&this.state.statistics.operations.queries++,a(t)}}):0}catch(n){if(s<this.config.maxRetries)return s++,await new Promise(e=>setTimeout(e,this.config.retryDelay)),executeOperation();throw n}};try{const e=await executeOperation();if(this.config.statistics.trackTiming){const e=performance.now();this.state.statistics.timing.totalTime+=e-n,this.state.statistics.timing.operationCount++}return e}catch(r){throw this.state.lastError=r,this.state.statistics.errors++,r}},async delete(e,t,a=this.config.defaultDB){const n=this.config.statistics.trackTiming?performance.now():0;let s=0;const executeOperation=async()=>{try{const n=await this.getDatabase(a);return new Promise((s,r)=>{const i=n.transaction(e,"readwrite").objectStore(e).delete(t);i.onerror=a=>{r(new Error(`Failed to delete ID ${t} from ${e}: ${a.target.error}`))},i.onsuccess=()=>{this.invalidateItemCache(a,e,t),this.config.statistics.trackOperations&&this.state.statistics.operations.deletes++,s(!0)}})}catch(n){if(s<this.config.maxRetries)return s++,await new Promise(e=>setTimeout(e,this.config.retryDelay)),executeOperation();throw n}};try{const t=await executeOperation();if(this.config.statistics.trackTiming){const e=performance.now();this.state.statistics.timing.totalTime+=e-n,this.state.statistics.timing.operationCount++}return await this.updateStoreStats(a,e),t}catch(r){throw this.state.lastError=r,this.state.statistics.errors++,r}},async deleteByQuery(e,t,a=this.config.defaultDB){const n=this.config.statistics.trackTiming?performance.now():0;let s=0;const executeOperation=async()=>{try{const n=await this.getDatabase(a),s=await this.query(e,t,{},a);return 0===s.length?0:new Promise((t,r)=>{const i=n.transaction(e,"readwrite"),o=i.objectStore(e);let l=0;i.onerror=t=>{r(new Error(`Failed to delete data in ${e}: ${t.target.error}`))},i.oncomplete=()=>{this.config.statistics.trackOperations&&(this.state.statistics.operations.deletes+=l),this.invalidateStoreCache(a,e),t(l)},s.forEach(e=>{const t=e[o.keyPath];o.delete(t).onsuccess=()=>{l++}})})}catch(n){if(s<this.config.maxRetries)return s++,await new Promise(e=>setTimeout(e,this.config.retryDelay)),executeOperation();throw n}};try{const t=await executeOperation();if(this.config.statistics.trackTiming){const e=performance.now();this.state.statistics.timing.totalTime+=e-n,this.state.statistics.timing.operationCount++}return await this.updateStoreStats(a,e),t}catch(r){throw this.state.lastError=r,this.state.statistics.errors++,r}},async clear(e,t=this.config.defaultDB){const a=this.config.statistics.trackTiming?performance.now():0;let n=0;const executeOperation=async()=>{try{const a=await this.getDatabase(t);return new Promise((n,s)=>{const r=a.transaction(e,"readwrite").objectStore(e).clear();r.onerror=t=>{s(new Error(`Failed to clear data in ${e}: ${t.target.error}`))},r.onsuccess=()=>{this.invalidateStoreCache(t,e),n(!0)}})}catch(a){if(n<this.config.maxRetries)return n++,await new Promise(e=>setTimeout(e,this.config.retryDelay)),executeOperation();throw a}};try{const n=await executeOperation();if(this.config.statistics.trackTiming){const e=performance.now();this.state.statistics.timing.totalTime+=e-a,this.state.statistics.timing.operationCount++}return this.state.statistics.storeSize[`${t}.${e}`]=0,EventManager.emit("storage:cleared",{dbName:t,storeName:e}),n}catch(s){throw this.state.lastError=s,this.state.statistics.errors++,s}},async exists(e,t,a=this.config.defaultDB){const n=this.config.statistics.trackTiming?performance.now():0;let s=0;const executeOperation=async()=>{try{const n=await this.getDatabase(a);return!!n.objectStoreNames.contains(e)&&new Promise((a,s)=>{const r=n.transaction(e,"readonly").objectStore(e).count(t);r.onerror=a=>{s(new Error(`Failed to check ID ${t} in ${e}: ${a.target.error}`))},r.onsuccess=e=>{a(e.target.result>0)}})}catch(n){if(s<this.config.maxRetries)return s++,await new Promise(e=>setTimeout(e,this.config.retryDelay)),executeOperation();throw n}};try{const e=await executeOperation();if(this.config.statistics.trackTiming){const e=performance.now();this.state.statistics.timing.totalTime+=e-n,this.state.statistics.timing.operationCount++}return e}catch(r){throw this.state.lastError=r,this.state.statistics.errors++,r}},createKeyRange(e,t,a,n=!1,s=!1){switch(e.toLowerCase()){case"only":return IDBKeyRange.only(t);case"bound":return IDBKeyRange.bound(t,a,n,s);case"upperbound":return IDBKeyRange.upperBound(t,n);case"lowerbound":return IDBKeyRange.lowerBound(t,n);default:throw new Error(`Invalid range type: ${e}`)}},async getDatabase(e){if(this.state.databases.has(e)){const t=this.state.databases.get(e);if(t&&"closed"!==t.readyState)return t;this.state.databases.delete(e)}if(!this.state.databaseSchemas.has(e)){if(e!==this.config.defaultDB||!this.config.stores)throw new Error(`Database ${e} not found and no schema available for creation`);try{await this.createDatabase({name:e,version:this.config.defaultVersion,stores:this.config.stores});const t=this.state.databases.get(e);if(!t)throw new Error(`Failed to create database ${e}`);return t}catch(t){throw t}}try{const t=this.state.databaseSchemas.get(e);await this.createDatabase({name:e,version:t.version||1,stores:t.stores});const a=this.state.databases.get(e);if(!a)throw new Error(`Failed to create database ${e} from schema`);return a}catch(t){throw t}},invalidateStoreCache(e,t){if(this.config.cacheLookups)for(const a of this.state.cache.keys())a.startsWith(`${e}:${t}:`)&&this.state.cache.delete(a)},invalidateItemCache(e,t,a){if(!this.config.cacheLookups)return;const n=`${e}:${t}:${a}`;this.state.cache.delete(n)},async updateStoreStats(e,t){if(this.config.statistics.enabled)try{const a=await this.count(t,{},e),n=Math.min(100,a);if(n<=0)return void(this.state.statistics.storeSize[`${e}.${t}`]=0);const s=await this.getAll(t,{limit:n},e);let r=0;s.forEach(e=>{const t=JSON.stringify(e);r+=2*t.length});const i=r/s.length*a;this.state.statistics.storeSize[`${e}.${t}`]=i}catch(a){}},formatSize(e){const t=["B","KB","MB","GB","TB"];let a=e,n=0;for(;a>=1024&&n<t.length-1;)a/=1024,n++;return`${a.toFixed(2)} ${t[n]}`},async getStorageUsage(){if(!this.config.statistics.enabled)return{totalSize:0,stores:{}};let e=0;const t={};for(const[a,n]of Object.entries(this.state.statistics.storeSize)){const[s,r]=a.split(".");t[s]||(t[s]={}),t[s][r]={size:n,formatted:this.formatSize(n)},e+=n}return{totalSize:e,totalFormatted:this.formatSize(e),stores:t}},getStatistics(){var e;if(!this.config.statistics.enabled)return null;let t=0;this.state.statistics.timing.operationCount>0&&(t=this.state.statistics.timing.totalTime/this.state.statistics.timing.operationCount);const a={};for(const[n,s]of this.state.databaseSchemas.entries()){const t=Object.keys(s.stores||{});a[n]={version:(null==(e=this.state.databases.get(n))?void 0:e.version)||0,stores:t}}return{operations:this.state.statistics.operations,timing:{totalTime:this.state.statistics.timing.totalTime.toFixed(2)+" ms",operationCount:this.state.statistics.timing.operationCount,averageTime:t.toFixed(2)+" ms"},databases:a,cacheSize:this.state.cache.size,errors:this.state.statistics.errors,lastError:this.state.lastError?{message:this.state.lastError.message,timestamp:(new Date).toISOString()}:null}},async deleteDatabase(e){try{if(this.state.databases.has(e)){this.state.databases.get(e).close(),this.state.databases.delete(e)}for(const t of this.state.cache.keys())t.startsWith(`${e}:`)&&this.state.cache.delete(t);return this.state.databaseSchemas.delete(e),new Promise((t,a)=>{const n=indexedDB.deleteDatabase(e);n.onerror=t=>{const n=new Error(`Failed to delete database ${e}: ${t.target.error}`);this.state.lastError=n,this.state.statistics.errors++,a(n)},n.onsuccess=()=>{for(const t in this.state.statistics.storeSize)t.startsWith(`${e}.`)&&delete this.state.statistics.storeSize[t];EventManager.emit("storage:databaseDeleted",{dbName:e}),t(!0)}})}catch(t){throw this.state.lastError=t,this.state.statistics.errors++,t}},async batch(e,t,a="update",n=this.config.defaultDB){const s=this.config.statistics.trackTiming?performance.now():0;let r=0;if(!Array.isArray(t)||0===t.length)return[];const executeOperation=async()=>{try{const s=await this.getDatabase(n);return new Promise((r,i)=>{const o=s.transaction(e,"readwrite"),l=o.objectStore(e),c=[];let d=0;o.onerror=t=>{i(new Error(`Batch operation failed in ${e}: ${t.target.error}`))},o.oncomplete=()=>{this.invalidateStoreCache(n,e),this.config.statistics.trackOperations&&("add"===a?this.state.statistics.operations.writes+=d:this.state.statistics.operations.updates+=d),r("add"===a?c:d)},t.forEach(e=>{let t;switch(a){case"add":t=l.add(e),t.onsuccess=e=>{c.push(e.target.result),d++};break;case"update":t=l.put(e),t.onsuccess=()=>{d++};break;case"upsert":void 0!==e[l.keyPath]?(t=l.put(e),t.onsuccess=()=>{d++}):(t=l.add(e),t.onsuccess=e=>{c.push(e.target.result),d++});break;default:throw new Error(`Invalid operation type: ${a}`)}t.onerror=e=>{e.stopPropagation()}})})}catch(s){if(r<this.config.maxRetries)return r++,await new Promise(e=>setTimeout(e,this.config.retryDelay)),executeOperation();throw s}};try{const t=await executeOperation();if(this.config.statistics.trackTiming){const e=performance.now();this.state.statistics.timing.totalTime+=e-s,this.state.statistics.timing.operationCount++}return await this.updateStoreStats(n,e),t}catch(i){throw this.state.lastError=i,this.state.statistics.errors++,i}},async transaction(e,t,a="readonly",n=this.config.defaultDB){try{const s=await this.getDatabase(n);return new Promise((n,r)=>{const i=s.transaction(e,a),o=i.objectStore(e);let l;i.onerror=t=>{r(new Error(`Transaction failed in ${e}: ${t.target.error}`))},i.oncomplete=()=>{n(l)};try{l=t(o,i)}catch(c){i.abort(),r(c)}})}catch(s){throw this.state.lastError=s,this.state.statistics.errors++,s}},adapters:{indexeddb:{get:async(e,t,a)=>ae.getById(t,e,a||ae.config.defaultDB),async set(e,t,a,n){const s=n||ae.config.defaultDB,r="object"==typeof t?t:{id:e,value:t};return await ae.exists(a,e,s)?("object"!=typeof t||t.id||(t.id=e),ae.update(a,r,s)):ae.add(a,r,s)},remove:async(e,t,a)=>ae.delete(t,e,a||ae.config.defaultDB),clear:async(e,t)=>ae.clear(e,t||ae.config.defaultDB),getAll:async(e,t)=>ae.getAll(e,{},t||ae.config.defaultDB)},localStorage:{get(e){try{const t=localStorage.getItem(e);return t?JSON.parse(t):null}catch(t){return localStorage.getItem(e)}},set:(e,t)=>(localStorage.setItem(e,"object"==typeof t?JSON.stringify(t):t),!0),remove:e=>(localStorage.removeItem(e),!0),clear:()=>(localStorage.clear(),!0),getAll(){const e={};for(let t=0;t<localStorage.length;t++){const a=localStorage.key(t);e[a]=this.get(a)}return e}},sessionStorage:{get(e){try{const t=sessionStorage.getItem(e);return t?JSON.parse(t):null}catch(t){return sessionStorage.getItem(e)}},set:(e,t)=>(sessionStorage.setItem(e,"object"==typeof t?JSON.stringify(t):t),!0),remove:e=>(sessionStorage.removeItem(e),!0),clear:()=>(sessionStorage.clear(),!0),getAll(){const e={};for(let t=0;t<sessionStorage.length;t++){const a=sessionStorage.key(t);e[a]=this.get(a)}return e}},memory:{_data:new Map,get(e){return this._data.get(e)},set(e,t){return this._data.set(e,t),!0},remove(e){return this._data.delete(e)},clear(){return this._data.clear(),!0},getAll(){return Object.fromEntries(this._data.entries())}}},store(e=null){const t=e||this.config.defaultAdapter,a=this.adapters[t.toLowerCase()];if(!a)throw new Error(`Storage adapter '${t}' not found`);return a},local:{get:e=>ae.adapters.localStorage.get(e),set:(e,t)=>ae.adapters.localStorage.set(e,t),remove:e=>ae.adapters.localStorage.remove(e),clear:()=>ae.adapters.localStorage.clear(),getAll:()=>ae.adapters.localStorage.getAll()},session:{get:e=>ae.adapters.sessionStorage.get(e),set:(e,t)=>ae.adapters.sessionStorage.set(e,t),remove:e=>ae.adapters.sessionStorage.remove(e),clear:()=>ae.adapters.sessionStorage.clear(),getAll:()=>ae.adapters.sessionStorage.getAll()},memory:{get:e=>ae.adapters.memory.get(e),set:(e,t)=>ae.adapters.memory.set(e,t),remove:e=>ae.adapters.memory.remove(e),clear:()=>ae.adapters.memory.clear(),getAll:()=>ae.adapters.memory.getAll()},async addWithSync(e,t,a={}){var n;const s=null==(n=window.Now)?void 0:n.getManager("sync"),r=await this.add(e,t);if(s&&!1!==a.sync){const n={...t};n.id||void 0===r||(n.id=r),await s.addPendingOperation({storeName:e,method:"add",data:n,priority:a.priority||"medium"})}return r},async updateWithSync(e,t,a={}){var n;const s=null==(n=window.Now)?void 0:n.getManager("sync");return await this.update(e,t),s&&!1!==a.sync&&await s.addPendingOperation({storeName:e,method:"update",data:t,priority:a.priority||"medium"}),!0},async deleteWithSync(e,t,a={}){var n;const s=null==(n=window.Now)?void 0:n.getManager("sync"),r=await this.getById(e,t);return await this.delete(e,t),s&&!1!==a.sync&&r&&await s.addPendingOperation({storeName:e,method:"delete",data:r,priority:a.priority||"medium"}),!0},clearCache(){this.state.cache.clear()},closeAllConnections(){for(const[t,a]of this.state.databases.entries())try{a.close()}catch(e){}this.state.databases.clear()},reset(){this.closeAllConnections(),this.clearCache(),this.state={initialized:!1,databases:new Map,databaseSchemas:new Map,cache:new Map,statistics:{operations:{reads:0,writes:0,updates:0,deletes:0,queries:0},timing:{totalTime:0,operationCount:0},errors:0,storeSize:{}},lastError:null}}};(null==(p=window.Now)?void 0:p.registerManager)&&Now.registerManager("storage",ae),window.StorageManager=ae;const ne={config:{enabled:!1,autoSync:!1,syncInterval:6e4,retryStrategy:"exponential",maxRetries:5,pendingOperationsStore:"sync_pending_operations",onSyncComplete:null,onSyncError:null,debounceInterval:5e3,batchSize:10,concurrentRequests:3,priorityMapping:{high:0,medium:1,low:2},endpoints:{},minRetryDelay:1e3,maxRetryDelay:3e4,defaultIdField:"id",defaultHeaders:{"Content-Type":"application/json"},tokens:{enabled:!1,headerName:"Authorization",prefix:"Bearer ",tokenKey:"auth_token",storage:"localStorage"}},state:{initialized:!1,enabled:!1,online:navigator.onLine,syncing:!1,pendingSync:new Map,lastSyncTime:null,syncTimerId:null,syncPromise:null,debounceTimer:null,activeRequests:0,operationsProcessed:0,syncQueue:[],failedOperations:[]},async init(e={}){var t;try{if(this.config={...this.config,...e},this.storageManager=null==(t=window.Now)?void 0:t.getManager("storage"),!this.storageManager)throw new Error("StorageManager is required but not found");if(!this.storageManager.state.initialized)try{await this.storageManager.init()}catch(a){throw console.error("Failed to initialize StorageManager:",a),new Error(`StorageManager initialization failed: ${a.message}`)}try{await this.storageManager.createDatabase({name:this.storageManager.config.defaultDB,version:this.storageManager.config.defaultVersion,stores:{[this.config.pendingOperationsStore]:{keyPath:"id",autoIncrement:!0,indexes:[{name:"storeName",keyPath:"storeName"},{name:"operation",keyPath:"operation"},{name:"priority",keyPath:"priority"},{name:"status",keyPath:"status"},{name:"timestamp",keyPath:"timestamp"}]}}})}catch(n){throw console.error("Failed to create database for SyncManager:",n),new Error(`Failed to create sync storage: ${n.message}`)}return window.addEventListener("online",this.handleOnline.bind(this)),window.addEventListener("offline",this.handleOffline.bind(this)),void 0!==document.hidden&&document.addEventListener("visibilitychange",()=>{!document.hidden&&navigator.onLine&&this.config.autoSync&&this.state.enabled&&this.debouncedSync()}),this.state.initialized=!0,EventManager.emit("sync:initialized"),this}catch(s){throw console.error("SyncManager initialization failed:",s),window.ErrorManager&&ErrorManager.handle(s,{context:"SyncManager.init",type:"sync:error"}),s}},async enable(){return this.state.initialized||await this.init(),this.state.enabled=!0,this.config.enabled=!0,this.config.autoSync&&navigator.onLine&&(this.startAutoSync(),this.debouncedSync()),EventManager.emit("sync:enabled"),this},disable(){return this.state.enabled=!1,this.config.enabled=!1,this.stopAutoSync(),this.state.debounceTimer&&(clearTimeout(this.state.debounceTimer),this.state.debounceTimer=null),EventManager.emit("sync:disabled"),this},async addPendingOperation(e){this.state.initialized||await this.init();const t=await this._storePendingOperation(e);return this.config.enabled&&this.state.enabled?(this.config.autoSync&&navigator.onLine&&this.debouncedSync(),t):(EventManager.emit("sync:operation:stored",{operation:t,message:"Stored but sync is disabled"}),t)},async _storePendingOperation(e){const{storeName:t,data:a,method:n,priority:s="medium"}=e;if(!t||!a||!n)throw new Error("Missing required fields for pending operation");const r={storeName:t,operation:n,data:a,priority:this.config.priorityMapping[s]||1,timestamp:Date.now(),attempts:0,status:"pending",nextRetry:Date.now()},i=await this.storageManager.add(this.config.pendingOperationsStore,r);return EventManager.emit("sync:operation:added",{operation:r,id:i}),{...r,id:i}},debouncedSync(){this.config.enabled&&this.state.enabled&&(clearTimeout(this.state.debounceTimer),this.state.debounceTimer=setTimeout(()=>{this.syncAll()},this.config.debounceInterval))},async syncAll(){return this.config.enabled&&this.state.enabled?this.state.syncing?this.state.syncPromise:navigator.onLine?(this.state.syncing=!0,EventManager.emit("sync:started"),this.state.syncPromise=new Promise(async(e,t)=>{try{const t=await this.storageManager.getAll(this.config.pendingOperationsStore,{index:"priority",direction:"asc"});if(0===t.length){this.state.syncing=!1;const t={successful:0,failed:0,total:0,timestamp:Date.now()};return this.state.lastSyncTime=Date.now(),EventManager.emit("sync:completed",t),"function"==typeof this.config.onSyncComplete&&this.config.onSyncComplete(t),void e(t)}let a=0,n=0;this.state.operationsProcessed=0,this.state.syncQueue=[...t],this.state.failedOperations=[];const s=Array(this.config.concurrentRequests).fill(null).map(()=>this.processOperationsWorker());await Promise.all(s),a=this.state.operationsProcessed,n=this.state.failedOperations.length,this.state.lastSyncTime=Date.now();const r={successful:a,failed:n,total:t.length,timestamp:Date.now()};EventManager.emit("sync:completed",r),"function"==typeof this.config.onSyncComplete&&this.config.onSyncComplete(r),e(r)}catch(a){EventManager.emit("sync:error",{error:a}),"function"==typeof this.config.onSyncError&&this.config.onSyncError(a),window.ErrorManager&&ErrorManager.handle(a,{context:"SyncManager.syncAll",type:"sync:error"}),t(a)}finally{this.state.syncing=!1}}),this.state.syncPromise):Promise.resolve({successful:0,failed:0,total:0,offline:!0}):Promise.resolve({successful:0,failed:0,total:0,disabled:!0,message:"Sync is disabled"})},async processOperationsWorker(){for(;this.state.syncQueue.length>0;){const t=this.state.syncQueue.shift();if(t.nextRetry&&t.nextRetry>Date.now())this.state.syncQueue.push(t),await new Promise(e=>setTimeout(e,100));else try{await this.processOperation(t),this.state.operationsProcessed++}catch(e){this.state.failedOperations.push({operation:t,error:{message:e.message,status:e.status||0,timestamp:Date.now()}})}}},async processOperation(e){var t;try{const a=this.getEndpoint(e.storeName);if(!a)throw new Error(`No endpoint configured for store: ${e.storeName}`);let n;switch(e.operation){case"add":default:n="post";break;case"update":n="put";break;case"delete":n="delete"}this.state.activeRequests++;const s=null==(t=window.Now)?void 0:t.getManager("api"),r=window.http,i={...this.config.defaultHeaders};if(this.config.tokens.enabled){const e=("sessionStorage"===this.config.tokens.storage?sessionStorage:localStorage).getItem(this.config.tokens.tokenKey);e&&(i[this.config.tokens.headerName]=`${this.config.tokens.prefix}${e}`)}let o;if(s)o=await s[n](a,e.data);else if(r)o=await r[n](a,e.data,{headers:i});else{if(!window.simpleFetch||"function"!=typeof window.simpleFetch[n])throw new Error("No HTTP client available");o="delete"===n?await window.simpleFetch.delete(a,{headers:i}):await window.simpleFetch[n](a,e.data,{headers:i})}return await this.storageManager.delete(this.config.pendingOperationsStore,e.id),this.state.activeRequests--,EventManager.emit("sync:operation:success",{operation:e,response:o}),o}catch(a){return this.state.activeRequests--,this.handleSyncError(e,a)}},async handleSyncError(e,t){if(e.attempts+=1,e.lastError={message:t.message||"Unknown error",status:t.status||0,timestamp:Date.now()},e.attempts<this.config.maxRetries){let t=this.config.minRetryDelay;"exponential"===this.config.retryStrategy?t=Math.min(Math.pow(2,e.attempts)*this.config.minRetryDelay,this.config.maxRetryDelay):"linear"===this.config.retryStrategy&&(t=Math.min(e.attempts*this.config.minRetryDelay,this.config.maxRetryDelay)),e.nextRetry=Date.now()+t,e.status="pending",await this.storageManager.update(this.config.pendingOperationsStore,e),EventManager.emit("sync:operation:retry",{operation:e,error:e.lastError,nextRetry:new Date(e.nextRetry)})}else e.status="failed",await this.storageManager.update(this.config.pendingOperationsStore,e),EventManager.emit("sync:operation:failed",{operation:e,error:e.lastError});throw t},handleOnline(){this.state.online=!0,EventManager.emit("sync:online"),this.config.autoSync&&this.config.enabled&&this.state.enabled&&(this.debouncedSync(),this.startAutoSync())},handleOffline(){this.state.online=!1,EventManager.emit("sync:offline"),this.state.syncTimerId&&(clearInterval(this.state.syncTimerId),this.state.syncTimerId=null)},startAutoSync(){this.state.syncTimerId&&clearInterval(this.state.syncTimerId),this.state.syncTimerId=setInterval(()=>{navigator.onLine&&!this.state.syncing&&this.config.enabled&&this.state.enabled&&this.syncAll()},this.config.syncInterval)},stopAutoSync(){this.state.syncTimerId&&(clearInterval(this.state.syncTimerId),this.state.syncTimerId=null)},getEndpoint(e){return this.config.endpoints[e]?this.config.endpoints[e]:`api/${e}`},async getFailedOperations(){return this.storageManager.query(this.config.pendingOperationsStore,{index:"status",value:"failed"})},async getPendingCount(){return this.storageManager.count(this.config.pendingOperationsStore)},async getPendingOperations(){return this.storageManager.getAll(this.config.pendingOperationsStore)},async resetFailedOperations(){const e=await this.getFailedOperations();for(const t of e)t.attempts=0,t.status="pending",t.nextRetry=Date.now(),delete t.lastError,await this.storageManager.update(this.config.pendingOperationsStore,t);return navigator.onLine&&e.length>0&&this.config.enabled&&this.state.enabled&&this.debouncedSync(),e.length},async clearPendingOperations(){return await this.storageManager.clear(this.config.pendingOperationsStore),EventManager.emit("sync:cleared"),!0},async deletePendingOperation(e){return await this.storageManager.delete(this.config.pendingOperationsStore,e),EventManager.emit("sync:operation:deleted",{id:e}),!0},async updateOperation(e){return await this.storageManager.update(this.config.pendingOperationsStore,e),EventManager.emit("sync:operation:updated",{operation:e}),!0},getSyncStatus(){return{enabled:this.config.enabled&&this.state.enabled,online:this.state.online,syncing:this.state.syncing,lastSyncTime:this.state.lastSyncTime,activeRequests:this.state.activeRequests,autoSyncEnabled:this.config.autoSync&&null!==this.state.syncTimerId}},destroy(){this.state.syncTimerId&&(clearInterval(this.state.syncTimerId),this.state.syncTimerId=null),this.state.debounceTimer&&(clearTimeout(this.state.debounceTimer),this.state.debounceTimer=null),window.removeEventListener("online",this.handleOnline),window.removeEventListener("offline",this.handleOffline),this.state={initialized:!1,enabled:!1,online:navigator.onLine,syncing:!1,pendingSync:new Map,lastSyncTime:null,syncTimerId:null,syncPromise:null,debounceTimer:null,activeRequests:0,operationsProcessed:0,syncQueue:[],failedOperations:[]}}};(null==(m=window.Now)?void 0:m.registerManager)&&Now.registerManager("sync",ne),window.SyncManager=ne;let se=class TokenService{constructor(e={}){this.options={storageMethod:"cookie",cookieName:"auth_token",refreshCookieName:"refresh_token",localStorageKey:"auth",cookieOptions:{path:"/",secure:"https:"===location.protocol,sameSite:"Lax"},...e}}parseToken(e){try{if(!e||"string"!=typeof e||!e.includes("."))return null;const t=e.split(".");if(3!==t.length)return null;const a=t[1],n=this._base64UrlDecode(a);return JSON.parse(n)}catch(t){return console.error("Error parsing token:",t),null}}isTokenExpired(e){const t=this.parseToken(e);if(!t||!t.exp)return!0;return Math.floor(Date.now()/1e3)>=t.exp}getTokenExpiry(e){const t=this.parseToken(e);return(null==t?void 0:t.exp)||null}getUserId(e){const t=this.parseToken(e);return(null==t?void 0:t.sub)||(null==t?void 0:t.id)||null}getUserRoles(e){const t=this.parseToken(e);return(null==t?void 0:t.roles)||[]}_base64UrlDecode(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4;)t+="=";return decodeURIComponent(Array.prototype.map.call(atob(t),e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join(""))}getToken(){if("localStorage"===this.options.storageMethod)try{const e=localStorage.getItem(this.options.localStorageKey);if(e){return JSON.parse(e).token||null}}catch(e){console.error("Error retrieving token from localStorage:",e)}return null}store(e,t={}){try{if("localStorage"===this.options.storageMethod){const a={token:e,timestamp:Date.now(),...t};return localStorage.setItem(this.options.localStorageKey,JSON.stringify(a)),!0}if("cookie"===this.options.storageMethod){const a={...this.options.cookieOptions||{},...(null==t?void 0:t.cookieOptions)||{}};return this.setCookie(this.options.cookieName,e,a),!0}}catch(a){console.error("Error storing token:",a)}return!1}setCookie(e,t,a={}){if(!e||"string"!=typeof e)return;let n=`${e}=${null==t?"":t}`;a.path&&(n+=`; Path=${a.path}`),a.secure&&(n+="; Secure"),a.sameSite&&(n+=`; SameSite=${a.sameSite}`),"number"==typeof a.maxAge&&(n+=`; Max-Age=${a.maxAge}`),a.expires instanceof Date&&(n+=`; Expires=${a.expires.toUTCString()}`),document.cookie=n}getCookie(e){const t=document.cookie.split(";");for(let a of t){const[t,n]=a.trim().split("=");if(t===e)return n}return null}remove(){try{if("localStorage"===this.options.storageMethod)return localStorage.removeItem(this.options.localStorageKey),!0;if("cookie"===this.options.storageMethod){const e={...this.options.cookieOptions||{},maxAge:0};return this.setCookie(this.options.cookieName,"",e),!0}}catch(e){console.error("Error removing token:",e)}return!1}clear(){try{localStorage.removeItem(this.options.localStorageKey),localStorage.removeItem("auth_user"),localStorage.removeItem("access_token"),localStorage.removeItem("refresh_token");const e={...this.options.cookieOptions||{},maxAge:0};return this.options.cookieName&&this.setCookie(this.options.cookieName,"",e),this.options.refreshCookieName&&this.setCookie(this.options.refreshCookieName,"",e),!0}catch(e){console.error("Error clearing authentication data:",e)}return!1}getUser(){try{if("localStorage"===this.options.storageMethod){const e=localStorage.getItem(this.options.localStorageKey);if(e){return JSON.parse(e).user||null}}}catch(e){console.error("Error retrieving user data:",e)}return null}isAuthenticated(){const e=this.getToken();return!!e&&(!this.isTokenExpired(e)||(this.remove(),!1))}get(){return this.getToken()}};"undefined"!=typeof module&&module.exports&&(module.exports=se),window.TokenService=se,window.tokenService=new se;const re={config:{enabled:!1,type:"jwt-httponly",autoInit:!0,endpoints:{login:"api/v1/auth/login",logout:"api/v1/auth/logout",verify:"api/v1/auth/verify",refresh:"api/v1/auth/refresh",me:"api/v1/auth/me",social:"api/v1/auth/social/{provider}",callback:"api/v1/auth/callback"},security:{csrf:!0,csrfIncludeSafeMethods:!0,rateLimiting:!0,maxLoginAttempts:5,lockoutTime:18e5,autoRefresh:!0,refreshBeforeExpiry:3e5,clearAllCachesOnLogout:!0},redirects:{afterLogin:"/",afterLogout:"/login",unauthorized:"/login",forbidden:"/403"},token:{headerName:"Authorization",cookieName:"auth_token",refreshCookieName:"refresh_token",storageKey:"auth_user",cookieOptions:{path:"/",secure:"undefined"!=typeof window&&"https:"===window.location.protocol,sameSite:"Strict"},cookieMaxAge:null}},state:{initialized:!1,authenticated:!1,user:null,loading:!1,error:null,loginAttempts:0,lockedUntil:null,refreshTimer:null},tokenService:null,rateLimitData:new Map,ensureTokenService(e=!1){var t;if((null==(t=this.config)?void 0:t.token)||(this.config.token={cookieName:"auth_token",refreshCookieName:"refresh_token"}),!this.tokenService||e){const e={path:"/",secure:"undefined"!=typeof window&&("https:"===window.location.protocol&&!window.location.hostname.includes("localhost")),sameSite:"Lax",...this.config.token.cookieOptions||{}};this.tokenService=new TokenService({storageMethod:"cookie",cookieName:this.config.token.cookieName,refreshCookieName:this.config.token.refreshCookieName,cookieOptions:e,debug:!0})}return this.tokenService},buildTokenCookieOptions(e){const t={path:"/",secure:"undefined"!=typeof window&&("https:"===window.location.protocol&&!window.location.hostname.includes("localhost")),sameSite:"Lax",...this.config.token.cookieOptions||{}},a=this.config.token.cookieMaxAge;let n="number"==typeof a&&a>0?a:null;try{const t=this.ensureTokenService();if(!n&&e&&"function"==typeof(null==t?void 0:t.getTokenExpiry)){const a=t.getTokenExpiry(e);if(a){const e=a-Math.floor(Date.now()/1e3);e>0&&(n=e)}}}catch(s){console.warn("Failed to derive cookie maxAge from token expiry",s)}return n?t.maxAge=Math.max(1,Math.floor(n)):!("maxAge"in t)||null!==t.maxAge&&void 0!==t.maxAge||delete t.maxAge,t},rehydrateAccessToken(){var e;try{const t=this.ensureTokenService(),a=this.config.token.cookieName;let n=null;return(null==t?void 0:t.getCookie)&&(n=t.getCookie(a)),n?"function"==typeof(null==t?void 0:t.isTokenExpired)&&t.isTokenExpired(n)?(null==(e=t.remove)||e.call(t),"function"==typeof(null==ApiService?void 0:ApiService.clearAccessToken)&&ApiService.clearAccessToken(),null):("function"==typeof(null==ApiService?void 0:ApiService.setAccessToken)&&ApiService.setAccessToken(n),n):("function"==typeof(null==ApiService?void 0:ApiService.clearAccessToken)&&ApiService.clearAccessToken(),null)}catch(t){return console.error("AuthManager: Failed to rehydrate access token",t),null}},getAuthStrategy(){var e,t,a,n,s;const r=(null==(t=null==(e=null==ApiService?void 0:ApiService.config)?void 0:e.security)?void 0:t.authStrategy)||(null==(n=null==(a=this.config)?void 0:a.security)?void 0:n.authStrategy)||(null==(s=this.config)?void 0:s.type);return r&&["hybrid","storage","cookie"].includes(r)?r:"hybrid"},resolveTokenFromData:e=>e&&"object"==typeof e?e.data&&"object"==typeof e.data&&e.data.token?e.data.token:e.token?e.token:(console.warn("AuthManager: No token found in response data"),null):null,resolveUserFromData(e){if(!e||"object"!=typeof e)return null;if(e.data&&"object"==typeof e.data){if(e.data.user&&"object"==typeof e.data.user)return e.data.user;if(e.data.id&&e.data.username)return e.data}return e.user&&"object"==typeof e.user?e.user:(console.warn("AuthManager: No user found in response data"),null)},extractTokenFromHeaders(e={}){if(!e||"object"!=typeof e)return null;const t=e.authorization||e.Authorization;if(t){const e=t.split(" ");return 2===e.length&&/^Bearer$/i.test(e[0])?e[1].trim():t.trim()}return e["x-access-token"]||e["X-Access-Token"]||e["access-token"]||e["x-token"]||e["X-Token"]||null},getRefreshToken(){try{const t=this.ensureTokenService(),a=this.config&&this.config.token&&this.config.token.refreshCookieName||t&&t.options&&t.options.refreshCookieName||"refresh_token";if(t&&"function"==typeof t.getCookie){const e=t.getCookie(a);if(e)return e}if(t&&t.options&&"localStorage"===t.options.storageMethod)try{const e=localStorage.getItem(t.options.localStorageKey||"auth");if(e){const t=JSON.parse(e);if(t&&t.refresh_token)return t.refresh_token}}catch(e){}}catch(e){console.warn("getRefreshToken failed:",e&&e.message?e.message:e)}return null},buildRefreshRequestOptions(){var e,t,a;const n={throwOnError:!1,credentials:(null==(t=null==(e=null==ApiService?void 0:ApiService.config)?void 0:e.security)?void 0:t.sendCredentials)?"include":"same-origin"};try{const e=null==(a=this.getCSRFToken)?void 0:a.call(this);e&&(n.headers={...n.headers||{},"X-CSRF-TOKEN":e})}catch(s){console.warn("Failed to attach CSRF token to refresh request",s)}return n},async fetchAccessToken(e={}){var t,a,n,s;const{fallbackUser:r=null,preferRefresh:i=!0,preferVerifyFallback:o=!0}=e,l=[],c=(null==(a=null==(t=null==ApiService?void 0:ApiService.config)?void 0:t.security)?void 0:a.sendCredentials)?"include":"same-origin";i&&(null==(n=this.config.endpoints)?void 0:n.refresh)&&l.push(async()=>{var e;const t=this.getRefreshToken(),a=t?{refresh_token:t}:null,n=await simpleFetch.post(this.config.endpoints.refresh,a,this.buildRefreshRequestOptions());if((null==n?void 0:n.success)&&(null==(e=n.data)?void 0:e.success)){const e=this.resolveTokenFromData(n.data),t=this.extractTokenFromHeaders(n.headers),a=e||t;if(a){return{token:a,user:this.resolveUserFromData(n.data)||r}}}return null}),o&&(null==(s=this.config.endpoints)?void 0:s.verify)&&l.push(async()=>{var e;const t=await simpleFetch.get(this.config.endpoints.verify,{throwOnError:!1,credentials:c});if((null==t?void 0:t.success)&&(null==(e=t.data)?void 0:e.success)){const e=this.resolveTokenFromData(t.data),a=this.extractTokenFromHeaders(t.headers),n=e||a;if(n){return{token:n,user:this.resolveUserFromData(t.data)||r}}}return null});for(const u of l)try{const e=await u();if(null==e?void 0:e.token)return e}catch(d){console.warn("Token fetch attempt failed:",d)}return null},async ensureAccessToken(e,t={}){const{user:a=null}=t;if(!e)throw new Error("No access token provided - authentication required");"function"==typeof(null==ApiService?void 0:ApiService.setAccessToken)&&ApiService.setAccessToken(e);try{const t=this.ensureTokenService();if(t){const n=this.buildTokenCookieOptions(e);t.store(e,{user:a||this.state.user,timestamp:Date.now(),cookieOptions:n})||console.warn("AuthManager: Failed to store token in cookie")}}catch(n){console.error("AuthManager: TokenService failed to store token",n)}return e},isInitialized(){var e;return!0===(null==(e=this.state)?void 0:e.initialized)},async init(e={}){const t=window.Now&&Now.DEFAULT_CONFIG&&Now.DEFAULT_CONFIG.auth?Now.DEFAULT_CONFIG.auth:{},a={...this.config.endpoints||{},...t.endpoints||{},...e.endpoints||{}};if(this.config={...this.config,...t,...e,endpoints:a},!this.config.enabled)return this.state.initialized=!1,this.state.loading=!1,this;this.ensureTokenService(!0),this.rehydrateAccessToken(),window.ApiService&&"object"==typeof ApiService.config&&(ApiService.config.security=ApiService.config.security||{},ApiService.config.security.bearerAuth=!0,ApiService.config.security.authStrategy="hybrid"),window.SecurityManager&&this.setupSecurityIntegration();try{return this.state.loading=!0,this.state.error=null,this.setupHttpInterceptors(),this.setupRateLimiting(),await this.checkAuthStatus(),this.config.security.autoRefresh&&this.setupAutoRefresh(),this.state.initialized=!0,this.emit("auth:initialized",{authenticated:this.state.authenticated,user:this.state.user}),this}catch(n){throw this.state.error=n,this.handleError("Auth initialization failed",n),n}finally{this.state.loading=!1}},setupHttpInterceptors(){window.http&&window.http.addRequestInterceptor&&(http.addRequestInterceptor(async e=>{if(!this.config.security.csrf)return e;const t=(e.method||"GET").toUpperCase();if(!1!==this.config.security.csrfIncludeSafeMethods||!["GET","HEAD","OPTIONS","TRACE"].includes(t)){const t=this.getCSRFToken();if(t){const a="undefined"!=typeof Headers&&e.headers instanceof Headers?Object.fromEntries(e.headers.entries()):e.headers||{};e.headers={...a,"X-CSRF-Token":t}}}return e}),http.addResponseInterceptor(e=>{var t,a,n;const s=(null==(t=e.headers)?void 0:t["X-CSRF-Token"])||(null==(n=null==(a=e.headers)?void 0:a.get)?void 0:n.call(a,"X-CSRF-Token"));return s&&this.updateCSRFToken(s),e},async e=>{const t=e.config;if(401===e.status&&!(null==t?void 0:t._retry)){if(t&&(t._retry=!0),this.config.security.autoRefresh){if(await this.refreshToken()&&t)return http.request(t.url,t)}await this.logout(!1),this.redirectTo(this.config.redirects.unauthorized)}throw 403===e.status&&this.redirectTo(this.config.redirects.forbidden),e}))},setupRateLimiting(){this.config.security.rateLimiting&&setInterval(()=>{const e=Date.now();for(const[t,a]of this.rateLimitData.entries())e>a.resetTime&&this.rateLimitData.delete(t)},6e4)},checkRateLimit(e="global"){if(!this.config.security.rateLimiting)return!0;const t=Date.now(),a=this.rateLimitData.get(e)||{attempts:0,resetTime:t+6e4};if(a.attempts>=this.config.security.maxLoginAttempts){const e=a.resetTime-t;if(e>0)throw new Error(`Too many login attempts. Try again in ${Math.ceil(e/1e3)} seconds.`);a.attempts=0,a.resetTime=t+6e4}return!0},recordLoginAttempt(e="global",t=!1){if(!this.config.security.rateLimiting)return;const a=Date.now(),n=this.rateLimitData.get(e)||{attempts:0,resetTime:a+6e4};t?this.rateLimitData.delete(e):(n.attempts+=1,n.resetTime=a+6e4,this.rateLimitData.set(e,n))},async checkAuthStatus(){var e,t,a,n;try{const r=this.rehydrateAccessToken(),i=window.ApiService&&(null==(t=null==(e=ApiService.config)?void 0:e.security)?void 0:t.sendCredentials)?"include":"same-origin",o=await simpleFetch.get(this.config.endpoints.verify,{throwOnError:!1,credentials:i});if((null==o?void 0:o.success)&&(null==(a=o.data)?void 0:a.success)){const e=this.resolveUserFromData(o.data);if(!e)throw new Error("No user data in verify response");if(this.state.authenticated=!0,this.state.user=e,this.state.user)try{localStorage.setItem(this.config.token.storageKey,JSON.stringify({...this.state.user,timestamp:Date.now()}))}catch(s){console.warn("AuthManager: Failed to persist authenticated user",s)}return{authenticated:!0,user:this.state.user,token:r}}return this.clearAuthData(),{authenticated:!1,user:null,error:(null==(n=null==o?void 0:o.data)?void 0:n.message)||(null==o?void 0:o.statusText)||"Authentication failed"}}catch(r){return console.error("AuthManager: Auth check failed:",r.message),this.clearAuthData(),{authenticated:!1,user:null,error:r.message}}},clearAuthData(){this.state.authenticated=!1,this.state.user=null;try{localStorage.removeItem(this.config.token.storageKey)}catch(e){console.warn("Failed to clear cached user state",e)}try{localStorage.removeItem("auth_token")}catch(e){}"function"==typeof(null==ApiService?void 0:ApiService.clearAccessToken)&&ApiService.clearAccessToken();try{const e=this.ensureTokenService();null==e||e.clear()}catch(e){console.warn("Failed to clear token service state",e)}},async clearAllCaches(){var e,t,a,n;try{if(window.ApiService&&"function"==typeof ApiService.clearCache&&ApiService.clearCache(),window.StorageManager&&("function"==typeof(null==(e=StorageManager.local)?void 0:e.clear)&&StorageManager.local.clear(),"function"==typeof(null==(t=StorageManager.session)?void 0:t.clear)&&StorageManager.session.clear(),"function"==typeof(null==(a=StorageManager.memory)?void 0:a.clear)&&StorageManager.memory.clear(),"function"==typeof StorageManager.clearCache&&StorageManager.clearCache()),window.TemplateManager&&"function"==typeof TemplateManager.clearCache&&TemplateManager.clearCache(),window.ApiComponent&&"function"==typeof ApiComponent.clearCache&&ApiComponent.clearCache(),(null==(n=window.RouterManager)?void 0:n.authGuard)&&"function"==typeof RouterManager.authGuard.clearCache&&RouterManager.authGuard.clearCache(),window.ServiceWorkerManager&&"function"==typeof ServiceWorkerManager.clearCache&&await ServiceWorkerManager.clearCache(),window.caches){const e=await caches.keys();await Promise.all(e.map(e=>caches.delete(e)))}try{sessionStorage.clear()}catch(s){console.warn("Failed to clear sessionStorage:",s)}return!0}catch(r){return console.error("[AuthManager] Error clearing caches:",r),!1}},async handleAuthCheckError(e){return console.warn("Auth check failed:",e.message),this.clearAuthData(),{authenticated:!1,user:null,error:e.message}},setupSecurityIntegration(){document.addEventListener("jwt:refreshed",e=>{var t;null==(t=this.handleJWTRefresh)||t.call(this,e.detail)}),document.addEventListener("security:error",e=>{var t;null==(t=this.handleSecurityError)||t.call(this,e.detail)})},handleSecurityError(e){var t;try{const a=e||{},n=a.message||a.error||"A security error occurred";if(this.handleError("Security error",new Error(n)),401===a.status||"unauthorized"===a.code||"csrf_invalid"===a.code){this.clearAuthData();const e=(null==(t=this.config.redirects)?void 0:t.unauthorized)||"/login";this.redirectTo(e)}}catch(a){console.error("Error handling security event",a)}},async authenticate(e,t={}){var a,n,s;try{if(window.SecurityManager){const e=SecurityManager.checkRateLimit(this.config.endpoints.login);if(!e.allowed)throw new Error(`Too many login attempts. Try again in ${e.retryAfter} seconds.`)}if(!e.email||!e.password)throw new Error("Email and password are required");if(e.email&&!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.email))throw new Error("Invalid email format");if(e.password&&e.password.length<8)throw new Error("Password must be at least 8 characters");this.checkRateLimit(e.email||e.username||"global"),this.state.loading=!0,this.state.error=null;const r=await simpleFetch.post(this.config.endpoints.login,e,{throwOnError:!1,...t.fetchOptions||{}});if(r.success&&(null==(a=r.data)?void 0:a.success)){this.recordLoginAttempt(e.email||e.username||"global",!0);const t=this.extractTokenFromHeaders(r.headers),a=this.resolveTokenFromData(r.data)||t;a&&!r.data.token&&(r.data.token=a);const n=this.resolveUserFromData(r.data);return n&&!r.data.user&&(r.data.user=n),r.data}this.recordLoginAttempt(e.email||e.username||"global",!1);return{success:!1,message:(null==(n=r.data)?void 0:n.message)||r.statusText||"Authentication failed",errors:(null==(s=r.data)?void 0:s.errors)||{},status:r.status}}catch(r){return this.recordLoginAttempt(e.email||e.username||"global",!1),{success:!1,message:r.message||"Authentication failed",error:r}}finally{this.state.loading=!1}},async setAuthenticatedUser(e,t={}){try{const t=this.resolveUserFromData(e),n=this.resolveTokenFromData(e);if(!t)throw new Error("No user data found in authentication response");if(!n)throw new Error("No access token found in authentication response");this.state.authenticated=!0,this.state.user=t,this.state.error=null;const s=await this.ensureAccessToken(n,{user:t}),r={...t,timestamp:Date.now()};try{localStorage.setItem(this.config.token.storageKey,JSON.stringify(r))}catch(a){console.warn("AuthManager: Failed to persist user profile",a)}return this.config.security.autoRefresh&&this.setupAutoRefresh(),this.emit("auth:login",{user:this.state.user,timestamp:Date.now()}),{success:!0,user:this.state.user,authenticated:!0,token:s}}catch(n){return console.error("AuthManager: Failed to set authenticated user:",n.message),this.state.error=n,{success:!1,message:n.message,error:n}}},async login(e,t={}){try{const a=await this.authenticate(e,t);if(!a.success)return a;const n=await this.setAuthenticatedUser(a,{ensureOptions:t.ensureOptions});if(!n.success)return n;if(!t.preventRedirect){const e=t.redirectTo||this.getIntendedUrl()||this.config.redirects.afterLogin;this.redirectTo(e)}return{success:!0,user:this.state.user,authenticated:!0,...a,token:n.token||a.token||null}}catch(a){return this.handleError("Login failed",a),{success:!1,message:a.message||"Login failed",error:a}}},async logout(e=!0,t={}){var a,n,s;try{if(this.state.loading=!0,this.state.refreshTimer&&(clearTimeout(this.state.refreshTimer),this.state.refreshTimer=null),e)try{const e=(null==(n=null==(a=null==ApiService?void 0:ApiService.config)?void 0:a.security)?void 0:n.sendCredentials)?"include":"same-origin";if(window.ApiService&&"function"==typeof ApiService.post)await ApiService.post(this.config.endpoints.logout,null,{credentials:e});else if(window.http&&"function"==typeof http.post)await http.post(this.config.endpoints.logout,null,{credentials:e});else{if(!window.simpleFetch||"function"!=typeof simpleFetch.post)throw new Error("No HTTP client available for logout request");await simpleFetch.post(this.config.endpoints.logout,null,{credentials:e})}}catch(r){console.warn("Logout API failed:",r.message)}this.state.authenticated=!1,this.state.user=null,this.state.error=null;!1!==t.clearAllCaches&&!1!==this.config.security.clearAllCachesOnLogout&&await this.clearAllCaches(),null==(s=this.tokenService)||s.clear();try{localStorage.removeItem(this.config.token.storageKey)}catch(i){console.warn("Failed to clear cached user data",i)}try{localStorage.removeItem("auth_token"),"function"==typeof(null==ApiService?void 0:ApiService.clearAccessToken)&&ApiService.clearAccessToken()}catch(i){console.warn("Failed to clear access token",i)}if(this.emit("auth:logout",{timestamp:Date.now()}),!t.preventRedirect){const e=t.redirectTo||this.config.redirects.afterLogout;this.redirectTo(e)}}catch(r){this.handleError("Logout failed",r)}finally{this.state.loading=!1}},async refreshToken(){var e;try{const a=this.getRefreshToken(),n=a?{refresh_token:a}:null,s=await simpleFetch.post(this.config.endpoints.refresh,n,this.buildRefreshRequestOptions());if(null==(e=null==s?void 0:s.data)?void 0:e.success){const e=this.resolveTokenFromData(s.data),a=this.extractTokenFromHeaders(s.headers),n=await this.ensureAccessToken(e||a,{user:s.data.user||this.state.user,allowFallback:!1,preferVerifyFallback:!1});if(s.data.user&&(this.state.user=s.data.user),this.state.user)try{localStorage.setItem(this.config.token.storageKey,JSON.stringify({...this.state.user,timestamp:Date.now()}))}catch(t){console.warn("Failed to persist refreshed user",t)}return this.setupAutoRefresh(),this.emit("auth:token_refreshed",{user:this.state.user,token:n||e||a||null,timestamp:Date.now()}),!0}return!1}catch(a){return console.warn("Token refresh failed:",a.message||a),!1}},setupAutoRefresh(){this.state.refreshTimer&&clearTimeout(this.state.refreshTimer);const e=this.config.security.refreshBeforeExpiry;this.state.refreshTimer=setTimeout(async()=>{this.state.authenticated&&await this.refreshToken()},e)},hasPermission(e){if(!this.state.authenticated||!this.state.user)return!1;const t=this.state.user.permissions||[];return t.includes(e)||t.includes("*")},hasRole(e){if(!this.state.authenticated||!this.state.user)return!1;const t=this.state.user.roles||[];return t.includes(e)||t.includes("admin")},requireAuth(){return!!this.state.authenticated||(this.saveIntendedUrl(),this.redirectTo(this.config.redirects.unauthorized),!1)},requireGuest(){return!this.state.authenticated||(this.redirectTo(this.config.redirects.afterLogin),!1)},saveIntendedUrl(e=null){if(!["/login","/register","/forgot-password"].includes(window.location.pathname)){const t=(e=>{var t,a;const n=(null==(a=null==(t=window.RouterManager)?void 0:t.config)?void 0:a.base)||"";let s=e||"/";return n&&s.startsWith(n)&&(s=s.slice(n.length)||"/",s.startsWith("/")||(s="/"+s)),s})(window.location.pathname),a={path:t,query:window.location.search,hash:window.location.hash,timestamp:Date.now()};sessionStorage.setItem("auth_intended_route",JSON.stringify(a));const n=e||`${t}${window.location.search}`;sessionStorage.setItem("intended_url",n)}},getIntendedUrl(){const e=sessionStorage.getItem("intended_url");return sessionStorage.removeItem("intended_url"),e},redirectTo(e){var t,a;if("/login"===e||e.includes("/login")){const t=`${window.location.pathname}${window.location.search}`;if(!["/login","/register","/forgot-password"].includes(window.location.pathname)){const a=e.includes("?")?"&":"?";e=`${e}${a}redirect=${encodeURIComponent(t)}`}}(null==(a=null==(t=window.RouterManager)?void 0:t.state)?void 0:a.initialized)?RouterManager.navigate(e):window.location.href=e},updateCSRFToken(e){let t=document.querySelector('meta[name="csrf-token"]');t||(t=document.createElement("meta"),t.name="csrf-token",document.head.appendChild(t)),t.setAttribute("content",e)},getCSRFToken(){try{const e=document.querySelector('meta[name="csrf-token"]');if(e)return e.getAttribute("content");const t=document.cookie.match(/(^|;)\s*XSRF-TOKEN=([^;]+)/);return t?decodeURIComponent(t[2]):null}catch(e){return console.warn("Failed to resolve CSRF token",e),null}},emit(e,t={}){EventManager.emit(e,t);const a=new CustomEvent(e,{detail:t,bubbles:!0,cancelable:!0});document.dispatchEvent(a)},handleError(e,t){this.emit("auth:error",{message:e,error:t.message,timestamp:Date.now()}),window.NotificationManager&&NotificationManager.error(t.message||e)},getUser(){return this.state.user},isAuthenticated(){return this.state.authenticated},isLoading(){return this.state.loading},getError(){return this.state.error},clearError(){this.state.error=null},cleanup(){this.state.refreshTimer&&(clearTimeout(this.state.refreshTimer),this.state.refreshTimer=null),this.rateLimitData.clear(),this.state.initialized=!1},async socialLogin(e,t={}){try{this.state.loading=!0,this.state.error=null,this.emit("auth:social_login_start",{provider:e});const a=this.config.endpoints.social||"api/auth/social/{provider}",n=(t.endpoint||a).replace("{provider}",e);return t.popup?await this.handleSocialPopup(e,n,t):(this.redirectTo(`${n}?redirect=${encodeURIComponent(window.location.href)}`),{success:!0,method:"redirect"})}catch(a){return this.handleError(`Social login (${e}) failed`,a),{success:!1,message:a.message||`Social login (${e}) failed`,error:a}}finally{this.state.loading=!1}},handleSocialPopup:async(e,t,a={})=>new Promise((a,n)=>{const s=window.open(t,`social-login-${e}`,"width=600,height=600,scrollbars=yes,resizable=yes");if(!s)return void n(new Error("Unable to open social login popup"));const r=setInterval(()=>{s.closed&&(cleanup(),n(new Error("Social login popup was closed")))},1e3),cleanup=()=>{clearInterval(r),window.removeEventListener("message",messageHandler),s.closed||s.close()};function messageHandler(e){var t,s;e.origin===window.location.origin&&("social-login-success"===(null==(t=e.data)?void 0:t.type)?(cleanup(),re.setAuthenticatedUser(e.data.userData).then(a).catch(n)):"social-login-error"===(null==(s=e.data)?void 0:s.type)&&(cleanup(),n(new Error(e.data.message||"Social login failed"))))}window.addEventListener("message",messageHandler)}),async handleAuthCallback(e){var t,a;try{if(e.error)throw new Error(e.error_description||e.error);if(e.code||e.token){const n=await simpleFetch.post(this.config.endpoints.callback,e);if(n.success&&(null==(t=n.data)?void 0:t.success))return await this.setAuthenticatedUser(n.data);throw new Error((null==(a=n.data)?void 0:a.message)||"Auth callback failed")}if(e.user)return await this.setAuthenticatedUser(e);throw new Error("Invalid callback data")}catch(n){return this.handleError("Auth callback failed",n),{success:!1,message:n.message,error:n}}},async loginWithToken(e,t={}){var a;try{this.state.loading=!0,this.state.error=null;const t=await simpleFetch.get(this.config.endpoints.me,{headers:{Authorization:`Bearer ${e}`},throwOnError:!1});if(t.success&&(null==(a=t.data)?void 0:a.success)&&t.data.user)return await this.setAuthenticatedUser({user:t.data.user,token:e});throw new Error("Invalid or expired token")}catch(n){return this.handleError("Token login failed",n),{success:!1,message:n.message||"Token login failed",error:n}}finally{this.state.loading=!1}}};(null==(g=window.Now)?void 0:g.registerManager)&&Now.registerManager("auth",re),window.AuthManager=re;let ie=document.querySelector('meta[name="csrf-token"]');ie||(ie=document.createElement("meta"),ie.name="csrf-token",document.head.appendChild(ie));const oe={MODES:{HISTORY:"history",HASH:"hash"},DEFAULT_CONFIG:{enabled:!1,mode:"history",base:"/",autoDetectBase:!0,fallback:"index.html",auth:{enabled:!1,autoGuard:!0,defaultRequireAuth:!1,publicPaths:["/login","/register","/forgot-password"],guestOnlyPaths:["/login","/register"],conventions:{"/auth/*":{public:!0},"/admin/*":{roles:["admin"]},"/api/*":{skipRouter:!0}},redirects:{unauthorized:"/login",forbidden:"/403",afterLogin:"/",afterLogout:"/login"}},notFound:{path:"/404",template:"",title:"Page Not Found",behavior:"render",preserveUrl:!1,preserveQuery:!0,customHandler:null},trailingSlash:{mode:"remove",redirect:!1,ignorePaths:["/"]},showLoadingNotification:!0,initialLoad:{enabled:!0,preserveContent:!1,skipIfContent:!0,contentSelector:"#main",forceRoute:!1}},routes:new Map,params:new Map,globalGuards:{beforeEach:[],afterEach:[]},state:{current:null,previous:null,initialized:!1,loading:!1,error:null,disabled:!1},beforeEach(e){if("function"!=typeof e)throw new Error("Guard must be a function");return this.globalGuards.beforeEach.push(e),()=>{const t=this.globalGuards.beforeEach.indexOf(e);t>-1&&this.globalGuards.beforeEach.splice(t,1)}},afterEach(e){if("function"!=typeof e)throw new Error("Guard must be a function");return this.globalGuards.afterEach.push(e),()=>{const t=this.globalGuards.afterEach.indexOf(e);t>-1&&this.globalGuards.afterEach.splice(t,1)}},async runBeforeEachGuards(e,t){for(const n of this.globalGuards.beforeEach)try{const a=await n(e,t);if(!1===a)return!1;if("string"==typeof a)return a}catch(a){return console.error("[ROUTER] Global beforeEach guard error:",a),!1}return!0},async runAfterEachGuards(e,t){for(const n of this.globalGuards.afterEach)try{await n(e,t)}catch(a){console.error("Global afterEach guard error:",a)}},async init(e={}){var t,a,n,s;try{if(this.state.initialized&&e.force)EventSystemManager.removeComponentHandlers("router");else if(this.state.initialized)return this;if(this.state={current:null,previous:null,initialized:!1,loading:!1,error:null,disabled:!1},this.routes.clear(),this.params.clear(),!1!==e.autoDetectBase)try{const t=window.Now&&(window.Now.basePath||window.Now.config&&window.Now.config.router&&window.Now.config.router.base)||null;if(t)e.base=e.base||t;else{const t=await this.detectBasePath();e.base=e.base||t}}catch(r){const t=await this.detectBasePath();e.base=e.base||t}if(e.base){let t=e.base;t.startsWith("/")||(t="/"+t),t.length>1&&t.endsWith("/")&&(t=t.slice(0,-1)),e.base=t}if(this.config=Now.mergeConfig(this.DEFAULT_CONFIG,e),!this.config.enabled)return this.state.disabled=!0,this;if(!window.TemplateManager)throw new Error("TemplateManager is required but not found");(null==(t=this.config.auth)?void 0:t.enabled)&&await this.initAuthIntegration(),(null==(a=this.config.initialLoad)?void 0:a.preserveContent)&&this.storeInitialContent(),(null==(n=this.config.notFound)?void 0:n.path)&&this.register(this.config.notFound.path,{template:this.config.notFound.template,title:this.config.notFound.title}),e.routes&&Object.entries(e.routes).forEach(([e,t])=>{this.register(e,t)}),(null==(s=this.config.auth)?void 0:s.enabled)&&this.applyAuthConventions();const i=this.getPath();if(this.shouldHandleInitialRoute())await this.navigate(i,{},{replace:!0,isInitialLoad:!0,preserveQuery:!0});else{const e=this.matchRoute(i);if(e){this.state.current={path:i,...e.route,params:e.params||{}},e.route.title&&(document.title=this.translateTitle(e.route.title));const t=Now.getManager("component");t&&await t.initializeExistingElements()}else"/"!==i&&""!==i&&await this.navigate(i,{},{replace:!0,isInitialLoad:!0})}return this.setupEventListeners(),this.state.initialized=!0,EventManager.emit("router:initialized"),this}catch(i){throw this.state.error=ErrorManager.handle("Router initialization failed",{context:"RouterManager.init",type:"router:error",data:{error:i}}),i}},async initAuthIntegration(){const e=Now.getManager("auth");if(!e)return console.warn("RouterManager: Auth enabled but AuthManager not found"),void(this.config.auth.enabled=!1);if(!e.state)return console.warn("RouterManager: AuthManager state not available"),void(this.config.auth.enabled=!1);let t=0;for(;(!e.state||!e.state.initialized)&&t<100;)await new Promise(e=>setTimeout(e,100)),t++;return e.state&&e.state.initialized?void 0:(console.error("RouterManager: AuthManager failed to initialize within timeout"),console.error("Final AuthManager state:",e.state),void(this.config.auth.enabled=!1))},applyAuthConventions(){var e,t,a;if(!(null==(e=this.config.auth)?void 0:e.enabled))return;const n=!1!==this.config.auth.defaultRequireAuth;for(const[s,r]of this.routes){if(r.authProcessed)continue;let e=n,i=!1,o=!1;(null==(t=this.config.auth.publicPaths)?void 0:t.includes(s))&&(e=!1,i=!0),(null==(a=this.config.auth.guestOnlyPaths)?void 0:a.includes(s))&&(o=!0,e=!1),r.requireAuth=void 0!==r.requireAuth?r.requireAuth:e,r.requireGuest=void 0!==r.requireGuest?r.requireGuest:o,r.isPublic=i,r.authProcessed=!0}},matchConvention(e,t){const a=t.replace(/\*/g,"[^/]*").replace(/\*\*/g,".*").replace(/\//g,"\\/");return new RegExp(`^${a}$`).test(e)},async navigate(e,t={},a={}){var n,s;try{if(this.state.loading&&!a.force)return!1;let i=e,o="",l="";if(e.includes("#")){const t=e.split("#");i=t[0],l=t[1]||""}if(i.includes("?")){const e=i.split("?");i=e[0],o=e[1]||""}a.preserveQuery&&!o&&(o=window.location.search.slice(1));const c={};if(o){new URLSearchParams(o).forEach((e,t)=>{c[t]=e})}const d={...c,...t},u=this.handleTrailingSlash(i);if(!a.force&&!a.isInitialLoad&&this.state.current&&this.state.current.path===u){if(l!==window.location.hash.slice(1)){const e=l?"#"+l:"",t=window.location.pathname+window.location.search+e;history.pushState({params:this.state.current.params,hash:l},"",t),window.dispatchEvent(new HashChangeEvent("hashchange"))}return!0}const h=this.matchRoute(u);if(!h)return await this.handleNotFound(u,d);const p={path:u,params:h.params,route:h.route,query:c,hash:l},m=this.state.current?{path:this.state.current.path,params:this.state.current.params,route:this.state.current}:null,g=await this.runBeforeEachGuards(p,m);if(!1===g)return!1;if("string"==typeof g)return this.navigate(g,{},{replace:!0});if((null==(n=this.config.auth)?void 0:n.enabled)&&!1!==(null==(s=this.config.auth)?void 0:s.autoGuard)){const e=await this.checkRouteAuth(i,t);if(!e.allowed)return this.handleAuthRedirect(e,i,t)}if(h.route.beforeEnter&&"function"==typeof h.route.beforeEnter)try{const e=Now.getManager("auth"),t=await h.route.beforeEnter(h.params,this.state.current,e);if(!1===t)return!1;if("string"==typeof t)return this.navigate(t,{},{replace:!0})}catch(r){return console.error("Route guard error:",r),!1}if(this.state.current&&this.state.current.beforeLeave&&"function"==typeof this.state.current.beforeLeave)try{if(!1===await this.state.current.beforeLeave(h.params,this.state.current))return!1}catch(r){return console.error("Route leave guard error:",r),!1}const f=await EventManager.emit("route:before",{path:h.route.path,params:h.params});let y=!0;if(Array.isArray(f)&&(y=!f.includes(!1)),!y)return this.state.current=null,this.hideLoading(),!1;this.params.set(h.route.path,h.params),this.state.previous=this.state.current,this.state.current={...h.route,params:h.params,path:u,query:d,hash:l};const v=Object.keys(d).length>0?new URLSearchParams(d).toString():"";let w=this.resolvePath(i,h.params,v,l);a.replace?window.history.replaceState({params:h.params},"",w):window.history.pushState({params:h.params},"",w),this.showLoading();let b=this.resolveTemplate(h.route.template,h.params),E=await this.loadTemplate(b);if(!E)return await this.handleNotFound(u,t);const S=document.createElement("div");S.innerHTML=E;let C=this.extractText(S,"[data-title]")||this.extractText(S,"title");const M=S.querySelector(Now.config.mainSelector)||S;!C&&h.route.title&&(C=this.translateTitle(h.route.title)),C&&(document.title=C),await this.render(M.innerHTML);const x=!1!==a.scroll;x&&window.scrollTo(0,0);const T=window.location.hash.slice(1);return T&&x&&setTimeout(()=>{const e=document.getElementById(T);e&&window.ScrollManager&&ScrollManager.scrollTo(e,{offset:ScrollManager.config.core.offset,behavior:"smooth"})},100),await this.runAfterEachGuards(p,m),await EventManager.emit("route:changed",{path:h.route.path,params:h.params,route:h.route,previous:this.state.previous,isNotFoundPage:u===this.config.notFound.path}),setTimeout(()=>{this.executePageScripts()},0),!0}catch(r){return this.state.current=null,this.handleError("Navigation failed",r),!1}finally{this.hideLoading()}},executePageScripts(){var e,t;const a=document.querySelector(Now.config.mainSelector);if(!a)return;const n=a.querySelector("[data-script]");if(n&&(null==(e=window.TemplateManager)?void 0:e.processDataScript)){const e={state:{data:(null==(t=this.state.current)?void 0:t.params)||{},route:this.state.current}};TemplateManager.processDataScript(n,e)}},async checkRouteAuth(e,t){var a,n,s,r,i,o,l,c;const d=Now.getManager("auth");if(!d)return console.warn("AuthManager not found during auth check"),{allowed:!0};if(!d.state)return console.warn("AuthManager state not available during auth check"),{allowed:!0};if(!d.state.initialized)return console.warn("AuthManager not initialized during auth check"),{allowed:!0};if("function"!=typeof d.isAuthenticated)return console.warn("AuthManager methods not available"),{allowed:!0};const u=this.handleTrailingSlash(e),h=this.matchRoute(u);if(!h)return{allowed:!0};const p=h.route,m={allowed:!0,reason:null,redirectTo:null};try{const e=d.isAuthenticated();if(p.requireGuest&&e)return m.allowed=!1,m.reason="already_authenticated",m.redirectTo=(null==(n=null==(a=this.config.auth)?void 0:a.redirects)?void 0:n.afterLogin)||"/",m;if(p.requireAuth&&!e)return m.allowed=!1,m.reason="authentication_required",m.redirectTo=(null==(r=null==(s=this.config.auth)?void 0:s.redirects)?void 0:r.unauthenticated)||(null==(o=null==(i=this.config.auth)?void 0:i.redirects)?void 0:o.unauthorized)||"/login","function"==typeof d.saveIntendedUrl&&d.saveIntendedUrl(),m;if(p.roles&&p.roles.length>0&&"function"==typeof d.hasRole){if(!p.roles.some(e=>d.hasRole(e)))return m.allowed=!1,m.reason="insufficient_role",m.redirectTo=(null==(c=null==(l=this.config.auth)?void 0:l.redirects)?void 0:c.forbidden)||"/403",m}return m}catch(g){return console.error("Error in auth check:",g),{allowed:!0}}},async handleAuthRedirect(e,t,a){var n;const{reason:s,redirectTo:r}=e;if("authentication_required"===s)try{if(null==(n=window.RedirectManager)?void 0:n.storeIntendedRoute)await RedirectManager.storeIntendedRoute();else{const e=Now.getManager("auth");(null==e?void 0:e.saveIntendedUrl)&&e.saveIntendedUrl()}}catch(o){console.warn("[RouterManager] Failed to store intended route before auth redirect:",o)}await EventManager.emit("route:guard:rejected",{reason:s,originalPath:t,redirectTo:r,timestamp:Date.now()});const i={authentication_required:"Please login to access this page",already_authenticated:"You are already logged in",insufficient_role:"You do not have permission to access this page",insufficient_permission:"You do not have permission to access this page"}[s]||"Access denied";return NotificationManager.warning(i),!!r&&this.navigate(r,{},{replace:!0})},createRoutePattern(e,t=!0){let a=e.replace(/:[^\s/]+/g,"([^/]+)").replace(/\//g,"\\/");return a=t?`^${a}\\/?$`:`^${a}$`,new RegExp(a)},matchRoute(e){const t="preserve"===this.config.trailingSlash.mode?e:this.handleTrailingSlash(e);for(const[a,n]of this.routes){const e=this.createRoutePattern(a),s=t.match(e);if(s){const e={};return n.paramNames.forEach((t,a)=>{e[t]=s[a+1]}),{route:n,params:e}}}return null},register(e,t){if(!e)throw new Error("Route path is required");const a=this.extractParamNames(e),n=this.createRoutePattern(e);"string"==typeof t&&(t={template:t}),this.routes.set(e,{path:e,pattern:n,paramNames:a,template:t.template||e,title:t.title,...t}),t.children&&"object"==typeof t.children&&Object.entries(t.children).forEach(([t,a])=>{const n=t.startsWith("/")?t:e+(e.endsWith("/")?"":"/")+t;this.register(n,a)})},extractParamNames(e){const t=[];return e.split("/").forEach(e=>{e.startsWith(":")&&t.push(e.substring(1))}),t},handleTrailingSlash(e){var t;if("/"===e)return e;if(null==(t=this.config.trailingSlash.ignorePaths)?void 0:t.includes(e))return e;switch(this.config.trailingSlash.mode){case"add":return e.endsWith("/")?e:`${e}/`;case"remove":return e.endsWith("/")?e.slice(0,-1):e;default:return e}},async detectBasePath(){try{const e=document.querySelector("base[href]");if(e){const a=e.getAttribute("href");if(a)try{let e=new URL(a,window.location.href).pathname||"/";return e.startsWith("/")||(e="/"+e),e.length>1&&e.endsWith("/")&&(e=e.slice(0,-1)),e}catch(t){}}}catch(t){}const e=document.getElementsByTagName("script");for(let a of e){const e=a.getAttribute("src");if(e&&(e.includes("/Now.js")||e.includes("/Now/"))){const t=e.match(/^(.*?)\/Now\//);if(t){let e=t[1]||"/";return e.startsWith("/")||(e="/"+e),e.length>1&&e.endsWith("/")&&(e=e.slice(0,-1)),e}}}return"/"},getPath(e=!1){let t;if("hash"===this.config.mode){const e=window.location.hash.slice(1);if(e)t=e.startsWith("/")?e:"/"+e;else{const e=window.location.pathname||"/",a=this.config.base&&"/"!==this.config.base?this.config.base:"";let n=e;a&&e.startsWith(a)&&(n=e.slice(a.length)||"/"),t="/"!==n&&""!==n?n.startsWith("/")?n:"/"+n:"/"}}else{const e=window.location.pathname||"/",a=this.config.base&&"/"!==this.config.base?this.config.base:"";let n=e;a&&e.startsWith(a)&&(n=e.slice(a.length)||"/"),t=n.startsWith("/")?n:"/"+n}if(e){const e=this.getQuery();e&&(t+=e)}return t},getQuery:()=>window.location.search||"",shouldHandleInitialRoute(){const e=this.config.initialLoad;if(!e.enabled)return!1;if(e.forceRoute)return!0;if("hash"===this.config.mode){const e=window.location.hash,t=window.location.pathname||"/",a=this.config.base&&"/"!==this.config.base?this.config.base:"";let n=t;if(a&&t.startsWith(a)&&(n=t.slice(a.length)||"/"),!e&&"/"!==n&&""!==n){const e=window.location.href.split("#")[0],t=(e.endsWith("/")?e:e+"/")+"#"+(n.startsWith("/")?n:"/"+n),a=window.location.search||"";return window.location.replace(t+a),!1}}const t=this.getPath();if("/"!==t&&""!==t)return!0;if(e.skipIfContent){const t=document.querySelector(e.contentSelector);if(t&&t.children.length>0)return!1}return!0},storeInitialContent(){const e=document.querySelector(this.config.initialLoad.contentSelector);e&&(this.state.initialContent={html:e.innerHTML,path:window.location.pathname})},setupEventListeners(){document.addEventListener("click",e=>this.handleClick(e)),window.addEventListener("popstate",e=>this.handlePopState(e)),"hash"===this.config.mode&&window.addEventListener("hashchange",e=>this.handleHashChange(e)),window.addEventListener("load",()=>{"hash"===this.config.mode&&this.ensureHashModeUrl();const e=this.getPath();e&&"/"!==e&&!this.state.current&&this.navigate(e,{},{replace:!0,isInitialLoad:!0})})},ensureHashModeUrl(){const e=window.location.hash,t=window.location.pathname||"/",a=this.config.base&&"/"!==this.config.base?this.config.base:"";let n=t;if(a&&t.startsWith(a)&&(n=t.slice(a.length)||"/"),!e&&"/"!==n&&""!==n){const e=window.location.origin+(a||"")+"/"+(window.location.search||"")+"#"+(n.startsWith("/")?n:"/"+n);return window.location.replace(e),!1}return!0},handleClick(e){const t=e.target.closest("a");if(!t)return;if(t.hasAttribute("download")||t.hasAttribute("target")||"external"===t.getAttribute("rel"))return;let a=t.getAttribute("data-route");if(a)a.startsWith("../")?a=this.extractRouteFromHref(a):a.startsWith("/")||(a="/"+a);else{const e=t.getAttribute("href");if(!e)return;if(/^(mailto:|tel:|#)/.test(e))return;if(/^https?:\/\//i.test(e))try{const n=new URL(e,window.location.href);if(!(n.origin===window.location.origin))return void t.hasAttribute("target");a=n.pathname+n.search+n.hash;const s=this.config.base&&"/"!==this.config.base?this.config.base:"";s&&a.startsWith(s)&&(a=a.substring(s.length)||"/")}catch(r){a=this.extractRouteFromHref(e)}else a=this.extractRouteFromHref(e)}const n={},s=t.dataset;Object.keys(s).forEach(e=>{if(e.startsWith("param")){const t=e.replace("param","").toLowerCase();n[t]=s[e]}}),e.preventDefault(),this.navigate(a,n)},extractRouteFromHref(e){if(!e)return"/";if(e.startsWith("/"))return e;try{const t=new URL(e,window.location.href);let a=t.pathname;const n=this.config.base||"/";return"/"!==n&&a.startsWith(n)&&(a=a.substring(n.length)||"/"),a+t.search+t.hash}catch(t){if(e.startsWith("./"))return e.substring(1);if(e.startsWith("../")){return"/"+e.split("/").filter(e=>".."!==e&&"."!==e&&""!==e).join("/")}return"/"+e}},handlePopState(e){var t;const a=this.getPath(),n=(null==(t=e.state)?void 0:t.params)||{},s=window.location.search.slice(1),r={};if(s){new URLSearchParams(s).forEach((e,t)=>{r[t]=e})}const i=window.location.hash.slice(1);this.processRoute(a,n,r,i)},async processRoute(e,t={},a={},n=""){const s=this.handleTrailingSlash(e),r=this.matchRoute(s);if(!r)return await this.handleNotFound(s,t);try{this.params.set(r.route.path,t),this.state.previous=this.state.current,this.state.current={...r.route,params:t,path:s,query:a,hash:n},this.showLoading();let e=this.resolveTemplate(r.route.template,t),i=await this.loadTemplate(e);return i?(r.route.title&&(document.title=this.translateTitle(r.route.title)),await this.render(i),await EventManager.emit("route:changed",{path:r.route.path,params:t,route:r.route,previous:this.state.previous}),!0):await this.handleNotFound(s,t)}catch(i){return console.error("Route processing failed:",i),!1}finally{this.hideLoading()}},handleHashChange(e){var t;const a=this.getPath(),n=(null==(t=e.state)?void 0:t.params)||{};this.processRoute(a,n)},resolvePath(e,t,a,n){let s=e;Object.entries(t).forEach(([e,t])=>{const a=new RegExp(`:${e}(?=/|$)`);s=s.replace(a,encodeURIComponent(t))}),s=s.replace(/:[^/]+/g,""),s.startsWith("/")||(s="/"+s),s.length>1&&s.endsWith("/")&&(s=s.slice(0,-1));const r=this.config.base&&"/"!==this.config.base?this.config.base:"";if("hash"===this.config.mode){const e=r||"",t=e&&!e.endsWith("/")?"/":"";s=e+t+"#"+s}else r&&!s.startsWith(r)&&(s=r+s),a&&(s+="?"+a),n&&(s+="#"+n);return s},resolveTemplate:(e,t)=>e?e.replace(/:([\w]+)/g,(e,a)=>{const n=t[a];return null!=n?n:e}):"",applyBaseToTemplate(e){if(!e)return e;const t=String(e).trim();return t.startsWith("<")||/^(https?:)?\/\//i.test(t)?e:(t.startsWith("/"),t)},async loadTemplate(e){try{if(!e)return"";const t=String(e).trim();if(t.startsWith("<"))return e;const a=this.applyBaseToTemplate(t);return await TemplateManager.loadFromServer(a)}catch(t){throw new Error("Failed to load template")}},async render(e){try{const a=document.querySelector(Now.config.mainSelector);if(!a)throw new Error(`Main content area not found: ${Now.config.mainSelector} in ${document.location.href}`);const n=Now.getManager("component"),s=Now.getManager("template");if(s&&s.cleanup(),n){const e=a.querySelectorAll("[data-component]");for(const t of e){n.instances.get(t)&&await n.destroy(t)}}try{const e=Now.getManager("element")||window.ElementManager,t=Now.getManager("form")||window.FormManager;if(e){a.querySelectorAll("[data-element]").forEach(t=>{try{e.destroyByElement&&e.destroyByElement(t)}catch(a){}})}if(t){a.querySelectorAll("form[data-form]").forEach(e=>{try{t.destroyFormByElement&&t.destroyFormByElement(e)}catch(a){}})}}catch(t){console.warn("RouterManager: cleanup before render failed",t)}a.innerHTML="",a.innerHTML=e,n&&await n.initializeExistingElements();try{const e=Now.getManager("element")||window.ElementManager,t=Now.getManager("form")||window.FormManager;e&&"function"==typeof e.scan&&e.scan(a),t&&"function"==typeof t.scan&&t.scan(a)}catch(t){console.warn("RouterManager: post-render scan failed",t)}const r=Now.getManager("i18n");if(r&&r.config.enabled){const e=r.getCurrentLocale();await r.setLocale(e,!0)}await EventManager.emit("content:rendered",{path:this.getPath(),main:a})}catch(a){throw ErrorManager.handle("Failed to render content",{context:"RouterManager.render",data:{content:e}}),a}},showLoading(){this.state.loading=!0,document.body.classList.add("loading")},hideLoading(){this.state.loading=!1,document.body.classList.remove("loading")},extractText(e,t){try{const a=e.querySelector(t);if(!a)return null;const n=a.cloneNode(!0);n.querySelectorAll(".icon, .badge, .hidden").forEach(e=>{e.remove()});const s=n.textContent.trim(),r=null==Now?void 0:Now.getManager("i18n");return(null==r?void 0:r.enabled)&&r.translate(s)||s}catch(a){return this.handleError("Text extraction failed",a),null}},async handleNotFound(e,t={}){this.state.current=null,this.hideLoading(),this.state.error=new Error("Page not found");const a=this.config.notFound;if(a.title&&(document.title=this.translateTitle(a.title)),await EventManager.emit("route:notFound",{path:e,params:t,redirectTo:this.config.notFound.path}),"function"==typeof a.customHandler){const n=await a.customHandler(e,t);if(void 0!==n)return n}switch(a.behavior){case"redirect":if(!a.preserveUrl){const n=window.location.search,s=a.preserveQuery&&n?`${a.path}${n}`:a.path;return await this.navigate(s,{originalPath:e,...t},{replace:!0})}break;case"render":try{const n=await this.loadTemplate(a.template);if(n)return await this.render(n),await EventManager.emit("route:changed",{path:e,params:t,isError:!0}),!0}catch(n){await ErrorManager.handle("Failed to render 404 template page",{context:"RouterManager.handleNotFound",type:"route:changed",data:{path:e,params:t}})}break;case"preserve":return NotificationManager.error("Page not found"),!1}return this.renderDefault404Page(e)},renderDefault404Page(e){const t=document.querySelector(Now.config.mainSelector);if(!t)return!1;const a=`\n        <div class="error-container">\n            <div class="error-card">\n              <h1 class="error-code-number">404</h1>\n              <p class="error-message" data-i18n>The page you're looking for doesn't exist.</p>\n\n              <div class="error-details">\n                <div class="error-code-heading">Path:</div>\n                <pre class="error-code">${this.escapeHtml(e)}</pre>\n              </div>\n\n              <div class="error-actions">\n                <button class="btn btn-primary" onclick="window.location.reload()">\n                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                    <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>\n                    <path d="M3 3v5h5"></path>\n                  </svg>\n                  Reload Page\n                </button>\n                <button class="btn btn-secondary" onclick="window.location.href='/'">\n                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                    <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>\n                    <polyline points="9 22 9 12 15 12 15 22"></polyline>\n                  </svg>\n                  Go to Homepage\n                </button>\n              </div>\n\n              <div class="error-help">\n                If the problem persists, please contact your system administrator or try clearing your browser cache.\n              </div>\n            </div>\n          </div>\n        `;return t.innerHTML=a,!1},escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML},handleError:(e,t)=>(console.error(`[RouterManager] ${e}:`,t),window.ErrorManager?ErrorManager.handle(t,{context:"RouterManager",type:"router:error",data:{message:e}}):t),getParams(){const e=this.getPath();return this.params.get(e)||{}},getParam(e){return this.getParams()[e]||null},hasRoute(e){return this.routes.has(e)},getRoute(e){return this.routes.get(e)||null},getRoutes(){return Array.from(this.routes.entries()).map(([e,t])=>({path:e,...t}))},translateTitle(e){if(!e||"string"!=typeof e)return e;if(/{LNG_[^}]+}/.test(e)){const t=Now.getManager("i18n");if(null==t?void 0:t.interpolate)return t.interpolate(e,{})}return e}};(null==(f=window.Now)?void 0:f.registerManager)&&Now.registerManager("router",oe),window.RouterManager=oe;const le={development:{debug:!0,csrf:{enabled:!0,autoRefresh:!0,refreshInterval:18e5,validateOnSubmit:!0},jwt:{enabled:!0,autoRefresh:!0,refreshBeforeExpiry:3e5},rateLimit:{enabled:!1,globalLimit:1e3,windowMs:9e5},validation:{enabled:!0,sanitizeInput:!0,maxInputLength:1e4},csp:{enabled:!1}},production:{debug:!1,csrf:{enabled:!0,autoRefresh:!0,refreshInterval:9e5,validateOnSubmit:!0,tokenLength:40},jwt:{enabled:!0,autoRefresh:!0,refreshBeforeExpiry:12e4,validateSignature:!0},rateLimit:{enabled:!0,globalLimit:100,windowMs:9e5,perEndpoint:{"api/auth/login":{limit:5,windowMs:9e5},"api/auth/register":{limit:3,windowMs:36e5},"api/password/reset":{limit:2,windowMs:36e5}}},validation:{enabled:!0,sanitizeInput:!0,validateOutput:!0,maxInputLength:5e3},csp:{enabled:!0,directives:{"default-src":["'self'"],"script-src":["'self'"],"style-src":["'self'","'unsafe-inline'"],"img-src":["'self'","data:","https:"],"connect-src":["'self'"],"frame-src":["'none'"],"object-src":["'none'"]}}},testing:{debug:!0,csrf:{enabled:!1},jwt:{enabled:!0,autoRefresh:!1},rateLimit:{enabled:!1},validation:{enabled:!0,sanitizeInput:!1},csp:{enabled:!1}},getConfig(e="production"){return this[e]||this.production},getMergedConfig(e="production",t={}){const a=this.getConfig(e);return this.mergeDeep(a,t)},mergeDeep(e,t){const isObject=e=>e&&"object"==typeof e&&!Array.isArray(e);return isObject(e)&&isObject(t)?(Object.keys(t).forEach(a=>{const n=e[a],s=t[a];Array.isArray(n)&&Array.isArray(s)?e[a]=n.concat(s):isObject(n)&&isObject(s)?e[a]=this.mergeDeep(Object.assign({},n),s):e[a]=s}),e):t}};window.SecurityConfig=le;const ce={config:{csrf:{enabled:!1,tokenName:"_token",headerName:"X-CSRF-Token",cookieName:"XSRF-TOKEN",tokenUrl:"api/auth/csrf-token",metaName:"csrf-token",autoRefresh:!0,refreshInterval:18e5,validateOnSubmit:!0,requireForMethods:["POST","PUT","PATCH","DELETE"],excludePaths:["api/public/*","/auth/verify"],tokenLength:40},jwt:{enabled:!0,cookieName:"auth_token",refreshCookieName:"refresh_token",storageKey:"auth_user",autoRefresh:!0,refreshBeforeExpiry:3e5,refreshEndpoint:"api/auth/refresh",validateSignature:!0,algorithm:"HS256",issuer:window.location.hostname,audience:window.location.hostname},rateLimit:{enabled:!0,storage:"memory",globalLimit:100,windowMs:9e5,perEndpoint:{"api/auth/login":{limit:5,windowMs:9e5},"api/auth/register":{limit:3,windowMs:36e5},"api/password/reset":{limit:3,windowMs:36e5}},skipSuccessfulRequests:!1,skipFailedRequests:!1,keyGenerator:null,onLimitReached:null,headers:!0,message:"Too many requests, please try again later"},sanitization:{enabled:!0,removeScripts:!0,removeEvents:!0,allowedTags:["b","i","u","strong","em"],maxInputLength:1e4},csp:{enabled:!0,directives:{"default-src":["'self'"],"script-src":["'self'","'unsafe-inline'"],"style-src":["'self'","'unsafe-inline'"],"img-src":["'self'","data:","https:"],"font-src":["'self'"],"connect-src":["'self'"],"frame-src":["'none'"],"object-src":["'none'"]},reportUri:"api/csp-report"}},state:{initialized:!1,csrfToken:null,jwtToken:null,rateLimits:new Map,requestCounts:new Map,lastTokenRefresh:null,securityHeaders:new Map,violations:new Set},async init(e={}){try{return this.config={...this.config,...this.mergeDeep(this.config,e)},this.config.csrf.enabled&&await this.initCSRF(),this.config.jwt.enabled&&await this.initJWT(),this.config.rateLimit.enabled&&this.initRateLimit(),this.config.csp.enabled&&this.initCSP(),this.setupHttpInterceptors(),this.state.initialized=!0,this.emit("security:initialized",{csrf:this.config.csrf.enabled,jwt:this.config.jwt.enabled,rateLimit:this.config.rateLimit.enabled}),this}catch(t){throw this.handleError("Security initialization failed",t),t}},async initCSRF(){try{this.state.csrfToken=this.getCSRFToken(),this.state.csrfToken||await this.refreshCSRFToken(),this.config.csrf.autoRefresh&&this.startCSRFRefresh(),this.injectCSRFIntoForms()}catch(e){this.handleError("CSRF initialization failed",e)}},getCSRFToken(){let e=null;if(this.config.csrf.cookieName&&(e=this.getCookie(this.config.csrf.cookieName)),!e&&this.config.csrf.metaName){const t=document.querySelector(`meta[name="${this.config.csrf.metaName}"]`);e=null==t?void 0:t.getAttribute("content")}if(!e){const t=document.querySelector(`input[name="${this.config.csrf.tokenName}"]`);e=null==t?void 0:t.value}return e},async refreshCSRFToken(){var e,t,a;try{if(!this.config.csrf.enabled)return null;const n=window.ApiService||(null==(t=null==(e=window.Now)?void 0:e.getManager)?void 0:t.call(e,"api")),s={"X-Requested-With":"XMLHttpRequest"};let r;if(null==n?void 0:n.get)r=await n.get(this.config.csrf.tokenUrl,{},{headers:s});else{if(!(null==(a=window.simpleFetch)?void 0:a.get))throw new Error("ApiService is not available");r=await simpleFetch.get(this.config.csrf.tokenUrl,{headers:s})}if(!r.success)throw new Error(`Failed to get CSRF token: ${r.status}`);const i=r.data||{};return this.state.csrfToken=i.data.csrf_token||null,this.updateCSRFMeta(this.state.csrfToken),this.updateCSRFInForms(this.state.csrfToken),this.state.lastTokenRefresh=Date.now(),this.emit("csrf:refreshed",{token:this.state.csrfToken}),this.state.csrfToken}catch(n){return this.handleError("CSRF token refresh failed",n),null}},updateCSRFMeta(e){let t=document.querySelector(`meta[name="${this.config.csrf.metaName}"]`);t||(t=document.createElement("meta"),t.name=this.config.csrf.metaName,document.head.appendChild(t)),t.setAttribute("content",e)},injectCSRFIntoForms(){this.state.csrfToken&&document.querySelectorAll("form").forEach(e=>{this.injectCSRFIntoForm(e,this.state.csrfToken)})},injectCSRFIntoForm(e,t=null){if(!this.config.csrf.enabled)return;if(!(t=t||this.state.csrfToken))return;const a=e.getAttribute("action")||"",n=(e.getAttribute("method")||"GET").toUpperCase();if(!this.config.csrf.requireForMethods.includes(n))return;if(this.isPathExcluded(a))return;const s=e.dataset.csrf;if("false"===s||"disabled"===s)return;let r=e.querySelector(`input[name="${this.config.csrf.tokenName}"]`);r||(r=document.createElement("input"),r.type="hidden",r.name=this.config.csrf.tokenName,e.appendChild(r)),r.value=t},updateCSRFInForms(e){document.querySelectorAll(`input[name="${this.config.csrf.tokenName}"]`).forEach(t=>{t.value=e})},startCSRFRefresh(){this.csrfRefreshTimer&&clearInterval(this.csrfRefreshTimer),this.csrfRefreshTimer=setInterval(async()=>{await this.refreshCSRFToken()},this.config.csrf.refreshInterval)},async initJWT(){try{if(this.state.jwtToken=this.getJWTToken(),this.state.jwtToken){this.validateJWTToken(this.state.jwtToken)||await this.clearJWTToken()}this.config.jwt.autoRefresh&&this.state.jwtToken&&this.startJWTRefresh()}catch(e){this.handleError("JWT initialization failed",e)}},getJWTToken(){return localStorage.getItem(this.config.jwt.storageKey)},validateJWTToken(e){if(!e)return!1;try{const t=e.split(".");if(3!==t.length)return!1;const a=JSON.parse(atob(t[1]));return!(a.exp&&Date.now()>=1e3*a.exp)&&((!this.config.jwt.issuer||a.iss===this.config.jwt.issuer)&&(!this.config.jwt.audience||a.aud===this.config.jwt.audience))}catch(t){return!1}},async clearJWTToken(){this.state.jwtToken=null,localStorage.removeItem(this.config.jwt.storageKey),this.jwtRefreshTimer&&clearInterval(this.jwtRefreshTimer),this.emit("jwt:cleared")},startJWTRefresh(){this.jwtRefreshTimer&&clearInterval(this.jwtRefreshTimer);const e=this.state.jwtToken;if(e)try{const t=JSON.parse(atob(e.split(".")[1])).exp,a=1e3*(t-Math.floor(Date.now()/1e3))-this.config.jwt.refreshBeforeExpiry;a>0&&(this.jwtRefreshTimer=setTimeout(async()=>{await this.refreshJWTToken()},a))}catch(t){}},async refreshJWTToken(){var e,t,a;try{const n=this.config.jwt.refreshEndpoint||"api/auth/refresh",s=window.ApiService||(null==(t=null==(e=window.Now)?void 0:e.getManager)?void 0:t.call(e,"api")),r={"X-Requested-With":"XMLHttpRequest"};let i;if(null==s?void 0:s.post)i=await s.post(n,null,{headers:r});else{if(!(null==(a=window.simpleFetch)?void 0:a.post))throw new Error("ApiService is not available");i=await simpleFetch.post(n,null,{headers:r})}if(i.success){const e=i.data||{};e.token&&(this.state.jwtToken=e.token,localStorage.setItem(this.config.jwt.storageKey,e.token),this.startJWTRefresh(),this.emit("jwt:refreshed",{token:e.token}))}}catch(n){this.handleError("JWT refresh failed",n)}},initRateLimit(){this.loadRateLimits(),setInterval(()=>{this.cleanupExpiredLimits()},6e4)},checkRateLimit(e,t=null){if(!this.config.rateLimit.enabled)return{allowed:!0};t=t||this.generateRateLimitKey();const a=Date.now(),n=this.config.rateLimit.perEndpoint[e];if(n){const s=this.checkLimit(e,t,n,a);if(!s.allowed)return s}return this.checkLimit("global",t,{limit:this.config.rateLimit.globalLimit,windowMs:this.config.rateLimit.windowMs},a)},checkRateLimit(e,t=null){if(!this.config.rateLimit.enabled)return{allowed:!0};t=t||this.generateRateLimitKey();const a=Date.now(),n=this.config.rateLimit.perEndpoint[e];if(n){const s=this.checkLimit(e,t,n,a);if(!s.allowed)return s}return this.checkLimit("global",t,{limit:this.config.rateLimit.globalLimit,windowMs:this.config.rateLimit.windowMs},a)},checkLimit(e,t,a,n){const s=`${e}:${t}`,r=this.state.rateLimits.get(s)||{count:0,resetTime:n+a.windowMs};n>r.resetTime&&(r.count=0,r.resetTime=n+a.windowMs);const i=r.count<a.limit,o=Math.max(0,a.limit-r.count-1),l=Math.ceil((r.resetTime-n)/1e3);return i&&(r.count++,this.state.rateLimits.set(s,r),this.saveRateLimits()),{allowed:i,limit:a.limit,remaining:o,resetTime:l,retryAfter:i?0:l}},generateRateLimitKey(){if(this.config.rateLimit.keyGenerator)return this.config.rateLimit.keyGenerator();const e=navigator.userAgent;return`${window.location.hostname}:${btoa(e).slice(0,10)}`},loadRateLimits(){try{const e=this.config.rateLimit.storage;let t=null;switch(e){case"localStorage":t=localStorage.getItem("rate_limits");break;case"sessionStorage":t=sessionStorage.getItem("rate_limits");break;default:return}if(t){const e=JSON.parse(t);this.state.rateLimits=new Map(Object.entries(e))}}catch(e){}},saveRateLimits(){try{const e=this.config.rateLimit.storage;if("memory"===e)return;const t=JSON.stringify(Object.fromEntries(this.state.rateLimits));switch(e){case"localStorage":localStorage.setItem("rate_limits",t);break;case"sessionStorage":sessionStorage.setItem("rate_limits",t)}}catch(e){}},cleanupExpiredLimits(){const e=Date.now();for(const[t,a]of this.state.rateLimits)e>a.resetTime&&this.state.rateLimits.delete(t);this.saveRateLimits()},sanitizeInput(e){if(!this.config.sanitization.enabled)return e;if("string"!=typeof e)return e;let t=e;return this.config.sanitization.removeScripts&&(t=t.replace(/<script[^>]*>.*?<\/script>/gi,"")),t=t.replace(/javascript:/gi,""),this.config.sanitization.removeEvents&&(t=t.replace(/on\w+\s*=/gi,"")),t.length>this.config.sanitization.maxInputLength&&(t=t.substring(0,this.config.sanitization.maxInputLength)),t},initCSP(){document.querySelector('meta[http-equiv="Content-Security-Policy"]')||this.addCSPMeta(),document.addEventListener("securitypolicyviolation",this.handleCSPViolation.bind(this))},addCSPMeta(){const e=document.createElement("meta");e.setAttribute("http-equiv","Content-Security-Policy");const t=[];for(const[a,n]of Object.entries(this.config.csp.directives))t.push(`${a} ${n.join(" ")}`);e.setAttribute("content",t.join("; ")),document.head.appendChild(e)},handleCSPViolation(e){const t={directive:e.violatedDirective,uri:e.blockedURI,source:e.sourceFile,line:e.lineNumber,timestamp:Date.now()};this.state.violations.add(t),this.emit("csp:violation",t),this.config.csp.reportUri&&this.reportCSPViolation(t)},async reportCSPViolation(e){var t,a,n;try{const s=window.ApiService||(null==(a=null==(t=window.Now)?void 0:t.getManager)?void 0:a.call(t,"api")),r={"Content-Type":"application/json"};if(null==s?void 0:s.post)await s.post(this.config.csp.reportUri,e,{headers:r});else{if(!(null==(n=window.simpleFetch)?void 0:n.post))throw new Error("ApiService is not available");await simpleFetch.post(this.config.csp.reportUri,e,{headers:r})}}catch(s){}},setupHttpInterceptors(){window.http&&(window.http.addRequestInterceptor(async e=>{if(this.config.csrf.enabled&&this.shouldAddCSRF(e)&&(e.headers=e.headers||{},e.headers[this.config.csrf.headerName]=this.state.csrfToken),this.config.rateLimit.enabled){if(!this.checkRateLimit(e.url).allowed)throw new Error(this.config.rateLimit.message)}return e.body&&this.config.sanitization.enabled&&(e.body=this.sanitizeRequestData(e.body)),e}),window.http.addResponseInterceptor(e=>{const t=e.headers[this.config.csrf.headerName.toLowerCase()];return t&&t!==this.state.csrfToken&&(this.state.csrfToken=t,this.updateCSRFMeta(t),this.updateCSRFInForms(t)),e},e=>{throw 419===e.status?this.handleCSRFError():429===e.status&&this.handleRateLimitError(e),e}))},shouldAddCSRF(e){if(!e.method)return!1;const t=e.method.toUpperCase();return!!this.config.csrf.requireForMethods.includes(t)&&!this.isPathExcluded(e.url)},sanitizeRequestData(e){if("string"==typeof e)try{const t=JSON.parse(e);return JSON.stringify(this.sanitizeObject(t))}catch{return this.sanitizeInput(e)}if(e instanceof FormData){const t=new FormData;for(const[a,n]of e)t.append(a,this.sanitizeInput(n));return t}return this.sanitizeObject(e)},sanitizeObject(e){if("object"!=typeof e||null===e)return this.sanitizeInput(e);const t={};for(const[a,n]of Object.entries(e))t[a]="object"==typeof n?this.sanitizeObject(n):this.sanitizeInput(n);return t},setupFormInterceptors(){new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{if(1===e.nodeType)if("FORM"===e.tagName)this.enhanceForm(e);else{e.querySelectorAll("form").forEach(e=>this.enhanceForm(e))}})})}).observe(document.body,{childList:!0,subtree:!0}),document.querySelectorAll("form").forEach(e=>{this.enhanceForm(e)})},enhanceForm(e){if(e.dataset.securityEnhanced)return;const t=this.extractFormSecurityConfig(e);!1!==t.csrf.enabled&&this.injectCSRFIntoForm(e),!1!==t.rateLimit&&this.applyFormRateLimit(e,t),e.dataset.securityEnhanced="true"},extractFormSecurityConfig(e){return{csrf:this.getDataBool(e,"csrf",this.config.csrf.enabled),rateLimit:this.getDataBool(e,"rateLimit",this.config.rateLimit.enabled),rateLimitEndpoint:e.dataset.rateLimitEndpoint,rateLimitLimit:parseInt(e.dataset.rateLimitLimit)||null,rateLimitWindow:parseInt(e.dataset.rateLimitWindow)||null}},applyFormRateLimit(e,t){const a=e.onsubmit;e.onsubmit=n=>{const s=t.rateLimitEndpoint||e.action||window.location.pathname,r={limit:t.rateLimitLimit||this.config.rateLimit.globalLimit,windowMs:t.rateLimitWindow||this.config.rateLimit.windowMs},i=this.checkLimit("form",s,r,Date.now());return i.allowed?!a||a.call(e,n):(n.preventDefault(),this.showRateLimitError(e,i),!1)}},async handleCSRFError(){if(this.config.csrf.enabled)try{if(this.state.csrfToken)return this.emit("csrf:retry",{token:this.state.csrfToken}),this.showNotification(Now.translate("Security token present. Attempting a retry..."),"info"),await new Promise(e=>setTimeout(e,800)),await this.refreshCSRFToken(),void this.showNotification(Now.translate("Security token updated. Please try again."),"warning");await this.refreshCSRFToken(),this.showNotification(Now.translate("Security token updated. Please try again."),"warning")}catch(e){this.showNotification(Now.translate("Security error. Please refresh the page."),"error")}},handleRateLimitError(e){var t;const a=(null==(t=e.headers)?void 0:t["retry-after"])||60,n=Now.translate("Too many requests. Please try again in {retryAfter} seconds.",{retryAfter:a});this.showNotification(n,"warning")},showRateLimitError(e,t){const a=Now.translate("Too many attempts. Please try again in {retryAfter} seconds.",{retryAfter:t.retryAfter}),n=e.querySelector(".form-message, .login-message");n?(n.textContent=a,n.classList.add("warning")):this.showNotification(a,"warning")},isPathExcluded(e){return!!e&&this.config.csrf.excludePaths.some(t=>t.endsWith("*")?e.startsWith(t.slice(0,-1)):e===t)},getDataBool(e,t,a=!1){const n=e.dataset[t];return void 0===n?a:"true"===n||"1"===n},getCookie(e){const t=`; ${document.cookie}`.split(`; ${e}=`);return 2===t.length?t.pop().split(";").shift():null},showNotification(e,t="info"){window.NotificationManager&&window.NotificationManager[t](e)},emit(e,t={}){window.EventManager&&window.EventManager.emit(e,t);const a=new CustomEvent(e,{detail:t,bubbles:!0,cancelable:!0});document.dispatchEvent(a)},handleError(e,t){window.ErrorManager&&window.ErrorManager.handle(t,{context:"SecurityManager",message:e}),this.emit("security:error",{message:e,error:t})},mergeDeep(e,t){const isObject=e=>e&&"object"==typeof e&&!Array.isArray(e);return isObject(e)&&isObject(t)?(Object.keys(t).forEach(a=>{const n=e[a],s=t[a];Array.isArray(n)&&Array.isArray(s)?e[a]=n.concat(s):isObject(n)&&isObject(s)?e[a]=this.mergeDeep(Object.assign({},n),s):e[a]=s}),e):t},getCSRFTokenForForm(e){return this.state.csrfToken},refreshTokens(){return Promise.all([this.refreshCSRFToken(),this.refreshJWTToken()])},isRateLimited(e=null){return!this.checkRateLimit(e||window.location.pathname).allowed},getRateLimitStatus(e=null){return this.checkRateLimit(e||window.location.pathname)},addCSRFToRequest(e){return this.config.csrf.enabled&&this.shouldAddCSRF(e)&&this.state.csrfToken&&(e.headers=e.headers||{},e.headers[this.config.csrf.headerName]=this.state.csrfToken),e},destroy(){this.csrfRefreshTimer&&clearInterval(this.csrfRefreshTimer),this.jwtRefreshTimer&&(clearInterval(this.jwtRefreshTimer),clearTimeout(this.jwtRefreshTimer)),this.state.initialized=!1,this.state.rateLimits.clear(),this.state.violations.clear(),this.emit("security:destroyed")}};(null==(y=window.Now)?void 0:y.registerManager)&&Now.registerManager("security",ce),window.SecurityManager=ce;const de={config:{defaultRedirectDelay:1e3,defaultNotificationDuration:5e3,allowEval:!1,autoHandleFormResponses:!0},state:{initialized:!1,actionHandlers:new Map},init(e={}){return this.state.initialized||(this.config={...this.config,...e},this.registerStandardHandlers(),this.state.initialized=!0),this},registerStandardHandlers(){this.registerHandler("notification",e=>{const t=e.level||"success",a=e.message||"",n=e.duration||this.config.defaultNotificationDuration;window.NotificationManager&&NotificationManager[t](a,{duration:n})}),this.registerHandler("alert",e=>{const t=e.message||e.text||"";t&&alert(t)}),this.registerHandler("confirm",async e=>{const t=e.message||e.text||"",a=e.onConfirm||e.callback;await DialogManager.confirm(Now.translate(t))&&a&&("string"==typeof a?this.executeCallback(a):"function"==typeof a&&a())}),this.registerHandler("modal",async(e,t)=>{const a=e.action||"show";"close"!==a&&"hide"!==a?"show"!==a&&"open"!==a||await this.handleModalShow(e,t):window.modal&&"function"==typeof window.modal.hide&&window.modal.hide()}),this.registerHandler("redirect",(e,t)=>{const a=e.url||e.location||e.to,n=void 0!==e.delay?e.delay:this.config.defaultRedirectDelay,s=e.target||"_self",r=e.params||{};if(!a)return;const performRedirect=()=>{var e,n;if("reload"===a)t&&"function"==typeof t.reload?t.reload():window.location.reload();else if("refresh"===a)window.location.reload();else if("back"===a)window.history.back();else if("_self"!==s)window.open(a,s);else if(null==(n=null==(e=window.RouterManager)?void 0:e.state)?void 0:n.initialized)try{RouterManager.navigate(a,r)}catch(i){window.location.href=a}else window.location.href=a};n>0?setTimeout(performRedirect,n):performRedirect()}),this.registerHandler("update",e=>{const t=e.target||e.selector||e.element,a=e.content||e.html||e.value||"",n=e.method||"html";if(!t)return;("string"==typeof t?document.querySelectorAll(t):[t]).forEach(t=>{if(t){switch(n){case"html":t.innerHTML=a;break;case"text":t.textContent=a;break;case"value":"value"in t&&(t.value=a);break;case"append":t.insertAdjacentHTML("beforeend",a);break;case"prepend":t.insertAdjacentHTML("afterbegin",a);break;case"attr":const n=e.attr||e.attribute;n&&t.setAttribute(n,a);break;case"attrs":const s=e.attrs||e.attributes||{};Object.entries(s).forEach(([e,a])=>{"checked"===e||"disabled"===e||"selected"===e?t[e]=!!a:"value"===e?t.value=a:"class"===e||"className"===e?t.className=a:"text"===e||"textContent"===e?t.textContent=a:"html"===e||"innerHTML"===e?t.innerHTML=a:t.setAttribute(e,a)})}if("html"===n||"append"===n||"prepend"===n){t.querySelectorAll("script").forEach(e=>{try{new Function(e.textContent)()}catch(t){console.error("Error executing script:",t)}})}}})}),this.registerHandler("render",async(e,t)=>{const a=e.target||e.selector||e.element,n=e.template||e.templateUrl,s=e.method||"html";if(a&&n)if(window.TemplateManager)try{const r=await window.TemplateManager.loadFromServer(n),i=document.createElement("div");i.innerHTML=r;let o={};e.data?o=e.data:t.data&&(o=t.data);const l={template:r,state:o,reactive:!1,debug:this.config.debug||!1};window.TemplateManager.processTemplate(i,l);("string"==typeof a?document.querySelectorAll(a):[a]).forEach(e=>{if(e)switch(s){case"html":e.innerHTML=i.innerHTML;break;case"append":e.insertAdjacentHTML("beforeend",i.innerHTML);break;case"prepend":e.insertAdjacentHTML("afterbegin",i.innerHTML)}})}catch(r){console.error("ResponseHandler: Error rendering template",r),window.ErrorManager&&window.ErrorManager.handle(r,{context:"ResponseHandler.render",data:{action:e}})}else console.error("ResponseHandler: TemplateManager is not available");else console.warn("ResponseHandler: render action requires target and template")}),this.registerHandler("remove",e=>{const t=e.target||e.selector||e.element,a=!1!==e.animate;if(!t)return;("string"==typeof t?document.querySelectorAll(t):[t]).forEach(e=>{e&&(a&&window.$G?$G(e).fadeOut(()=>e.remove()):e.remove())})}),this.registerHandler("class",e=>{const t=e.target||e.selector||e.element,a=e.class||e.className||"",n=e.method||"add";if(!t||!a)return;("string"==typeof t?document.querySelectorAll(t):[t]).forEach(e=>{if(e)switch(n){case"add":e.classList.add(...a.split(" "));break;case"remove":e.classList.remove(...a.split(" "));break;case"toggle":a.split(" ").forEach(t=>e.classList.toggle(t))}})}),this.registerHandler("attribute",e=>{const t=e.target||e.selector||e.element,a=e.name||e.attribute,n=e.value;if(!t||!a)return;("string"==typeof t?document.querySelectorAll(t):[t]).forEach(e=>{e&&(null==n?e.removeAttribute(a):e.setAttribute(a,n))})}),this.registerHandler("event",e=>{const t=e.event||e.name,a=e.data||{},n=e.target||document;if(!t)return;const s="string"==typeof n?document.querySelector(n):n;if(!s)return;const r=new CustomEvent(t,{detail:a,bubbles:!1!==e.bubbles,cancelable:!1!==e.cancelable});s.dispatchEvent(r)}),this.registerHandler("callback",e=>{const t=e.function||e.callback||e.fn,a=e.args||e.arguments||[];this.executeCallback(t,a)}),this.registerHandler("eval",e=>{if(!this.config.allowEval)return void console.warn("ResponseHandler: eval is disabled for security. Set config.allowEval = true to enable.");const t=e.code||e.script;if(t)try{new Function(t)()}catch(a){console.error("ResponseHandler: eval error",a)}}),this.registerHandler("download",e=>{const t=e.url||e.href,a=e.filename||e.name;if(!t)return;const n=document.createElement("a");n.href=t,a&&(n.download=a),n.target="_blank",document.body.appendChild(n),n.click(),setTimeout(()=>document.body.removeChild(n),100)}),this.registerHandler("clipboard",async e=>{var t,a;const n=e.text||e.content||e.value||"";if(n)try{if(null==(a=null==(t=window.Utils)?void 0:t.dom)?void 0:a.copyToClipboard){if(!(await Utils.dom.copyToClipboard(n)))throw new Error("Failed to copy to clipboard");!1!==e.notify&&window.NotificationManager&&NotificationManager.success(e.message||"Copied to clipboard")}else navigator.clipboard&&navigator.clipboard.writeText?(await navigator.clipboard.writeText(n),!1!==e.notify&&window.NotificationManager&&NotificationManager.success(e.message||"Copied to clipboard")):(console.error("[ResponseHandler] No clipboard method available"),window.NotificationManager&&NotificationManager.error("Clipboard not supported in this browser"))}catch(s){console.error("[ResponseHandler] Failed to copy to clipboard:",s),!1!==e.notify&&window.NotificationManager&&NotificationManager.error(e.errorMessage||"Failed to copy to clipboard")}else console.warn("[ResponseHandler] No text provided for clipboard action")}),this.registerHandler("scroll",e=>{const t=e.target||e.selector||e.element,a=e.behavior||"smooth",n=e.block||"center";if(!t)return;const s="string"==typeof t?document.querySelector(t):t;s&&s.scrollIntoView&&s.scrollIntoView({behavior:a,block:n})}),this.registerHandler("focus",e=>{const t=e.target||e.selector||e.element;if(!t)return;const a="string"==typeof t?document.querySelector(t):t;a&&a.focus&&(a.focus(),e.select&&a.select&&a.select())}),this.registerHandler("formErrors",(e,t)=>{const a=e.errors||{},n=t.form||null,s=!1!==e.notification,r=!1!==e.focusFirst;if(!window.FormError)return void console.warn("ResponseHandler: FormError is not available");const i=[];let o=null;if(Object.entries(a).forEach(([e,t])=>{const a=Array.isArray(t)?t[0]:t;FormError.showFieldError(e,a,n),i.push(a),o||(o=document.getElementById(e)||document.querySelector(`[name="${e}"]`))}),s&&window.NotificationManager&&i.length>0){const t=e.level||"error",a=1===i.length?i[0]:i.map(e=>`• ${e}`).join("\n");NotificationManager[t](a)}r&&o&&o.focus&&(o.focus(),o.select&&o.select())}),this.registerHandler("reload",async(e,t)=>{const a=e.target||e.component;t&&"function"==typeof t.reload?await t.reload():a?this.executeAction({type:"event",event:"component:reload",target:a,data:e.data||{}}):window.location.reload()})},registerHandler(e,t){"function"==typeof t?this.state.actionHandlers.set(e,t):console.error("ResponseHandler: handler must be a function")},async process(e,t={}){if(e){if(t.data||(t.data=e),e.actions)if(Array.isArray(e.actions))for(const a of e.actions)await this.executeAction(a,t);else e.actions.type&&await this.executeAction(e.actions,e);return e}},async executeAction(e,t={}){if(!e||!e.type)return;const a=this.state.actionHandlers.get(e.type);if(a)try{if(void 0!==e.condition){if(!("function"==typeof e.condition?e.condition(t):e.condition))return}await a(e,t)}catch(n){console.error(`ResponseHandler: Error executing action "${e.type}"`,n),window.ErrorManager&&ErrorManager.handle(n,{context:"ResponseHandler.executeAction",data:{action:e,context:t}})}else console.warn(`ResponseHandler: No handler registered for action type "${e.type}"`)},executeCallback(e,t=[]){if(e)try{if("function"==typeof e)e(...t);else if("string"==typeof e){const a=e.split(".");let n=window;for(const e of a)if(n=n[e],!n)break;"function"==typeof n?n(...t):console.warn(`ResponseHandler: Function "${e}" not found`)}}catch(a){console.error("ResponseHandler: Error executing callback",a)}},async handleModalShow(e,t){try{let a={};if(t.modalConfig&&!e.force&&(a={...t.modalConfig}),e.template&&(e.force?(a.template=e.template,a.title=e.title||a.title,a.className=e.className||a.className):a.template||(a.template=e.template,a.title=e.title,a.className=e.className)),e.html)return await this.showModal(e.html,{title:e.title||a.title||"",className:e.className||a.className||"",width:e.width||a.width,maxWidth:e.maxWidth||a.maxWidth,buttons:e.button||e.buttons||a.buttons,onShown:e.onShown||a.onShown,onHide:e.onHide||a.onHide});let n="";if(a.template)n=await this.loadModalTemplate({template:a.template,templateUrl:e.templateUrl},t);else if(e.templateUrl)n=await this.loadTemplateFromUrl(e.templateUrl);else{if(!e.content)throw new Error("No template, templateUrl, HTML, or content provided for modal");n=e.content}const s=this.extractModalData(e,t),r=this.extractModalOptions(e,t);s&&Object.keys(s).length>0&&await this.registerModalState(s,r);const i=await this.renderModalContent(n,s,r);await this.showModal(i,{title:a.title||e.title||"",className:a.className||e.className||e.class||"",width:a.width||e.width,maxWidth:a.maxWidth||e.maxWidth,height:a.height||e.height,maxHeight:a.maxHeight||e.maxHeight,closeButton:!1!==a.closeButton&&!1!==e.closeButton,backdrop:!1!==a.backdrop&&!1!==e.backdrop,keyboard:!1!==a.keyboard&&!1!==e.keyboard,buttons:e.button||e.buttons||a.buttons,data:s,options:r,onShown:e.onShown||a.onShown,onHide:e.onHide||a.onHide}),this.emit("modal:shown",{template:a.template||e.template,data:s,options:r})}catch(a){console.error("ResponseHandler: Error showing modal",a),window.ErrorManager&&ErrorManager.handle(a,{context:"ResponseHandler.handleModalShow",data:{action:e,context:t}}),this.showErrorModal(a.message)}},async loadModalTemplate(e,t){const a=e.template;if(!window.TemplateManager)throw new Error("TemplateManager is not available");return await TemplateManager.loadFromServer(a)},async loadTemplateFromUrl(e){if(!window.TemplateManager)throw new Error("TemplateManager is not available");return await TemplateManager.loadFromServer(e)},extractModalData(e,t){let a=t.data||e.data||{};const getValue=(e,t)=>{const a=t.split(".");let n=e;for(const s of a){if(!n||"object"!=typeof n||!(s in n))return;n=n[s]}return n};if(e.dataKey){let n;t.data&&(n=getValue(t.data,e.dataKey)),void 0===n&&t.instance&&t.instance.state&&(n=getValue(t.instance.state,e.dataKey),void 0===n&&"data"===e.dataKey&&t.instance.state.data&&(n=t.instance.state.data)),void 0!==n&&(a={...a,...n})}else e.dataKey||!t.data||e.data||(a=t.data.data||t.data);return a},extractModalOptions(e,t){let a={};if(t.options)a={...t.options};else if(e.optionsKey&&t){const n=e.optionsKey.split(".");let s=t;for(const e of n){if(!s||"object"!=typeof s||!(e in s)){s=null;break}s=s[e]}null!==s&&(a={...a,...s})}return a},async showModal(e,t={}){if(window.modal&&window.modal instanceof Modal||(window.modal=new Modal({closeButton:!0,animation:!0,backdrop:!0,keyboard:!0,...t})),t.title&&window.modal.setTitle(t.title),t.className&&(window.modal.modal.className=`modal ${t.className}`.trim()),t.data&&Object.keys(t.data).length>0&&await this.registerModalState(t.data,t.options),e instanceof Node||e instanceof DocumentFragment)window.modal.setContent(e);else if(window.TemplateManager&&t.data){const a=await this.renderModalContent(e,t.data,t.options);window.modal.setContent(a)}else window.modal.setContent(e);window.modal.show(),"function"==typeof t.onShown&&setTimeout(()=>t.onShown.call(window.modal),200)},async registerModalState(e,t={}){if(e&&Object.keys(e).length>0&&(window._currentModalData=e),t&&Object.keys(t).length>0&&(window._currentModalOptions=t),!window.StateManager)return;const a={state:{formData:e,options:t,loading:!1,errors:{}},getters:{formData:e=>e.formData,options:e=>e.options,isLoading:e=>e.loading,hasErrors:e=>Object.keys(e.errors).length>0},mutations:{setFormData(e,t){e.formData={...e.formData,...t}},setField(e,{field:t,value:a}){e.formData[t]=a},setLoading(e,t){e.loading=t},setError(e,{field:t,message:a}){e.errors[t]=a},clearErrors(e){e.errors={}}},actions:{async updateField({commit:e},{field:t,value:a}){e("setField",{field:t,value:a})},submitForm:async({state:e,commit:t})=>(t("setLoading",!0),t("clearErrors"),e.formData)}};StateManager.registerModule("modal",a,{force:!0})},async renderModalContent(e,t,a={}){if(!window.TemplateManager)return e;const n=document.createElement("div");n.innerHTML=e;const s={template:e,state:{...t},reactive:!0,debug:this.config.debug||!1};TemplateManager.processTemplate(n,s);const r=document.createDocumentFragment();for(;n.firstChild;)r.appendChild(n.firstChild);return r},showErrorModal(e){const t=`\n      <div class="error-modal">\n        <div class="modal-body icon-warning">\n          <div>\n            <h3>Error</h3>\n            <p>${e}</p>\n          </div>\n        </div>\n        <div class="modal-footer">\n          <button class="btn btn-primary" onclick="window.modal?.hide()">Close</button>\n        </div>\n      </div>\n    `;window.Modal?(window.modal||(window.modal=new Modal({closeButton:!0})),window.modal.setContent(t),window.modal.show()):alert("Error: "+e)},emit(e,t){EventManager.emit(e,t)}};"undefined"!=typeof window&&(window.ResponseHandler=de,(null==(v=window.Now)?void 0:v.registerManager)&&Now.registerManager("response",de),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{de.init()}):de.init()),window.ResponseHandler=de;class HttpClient{constructor(e={}){this.baseURL=e.baseURL||"",this.defaultHeaders={"X-Requested-With":"XMLHttpRequest",...e.headers},this.timeout=e.timeout||3e4,this.responseHandler=e.responseHandler,this.interceptors={request:[],response:[]},this.throwOnError=!1!==e.throwOnError,this.csrfToken=null,this.security=e.security||{csrf:{enabled:!1,required:!0,tokenName:"_token",headerName:"X-CSRF-Token"},rateLimit:{enabled:!1},validation:{enabled:!1}},this.csrfHeaderName=this.security.csrf.headerName||"X-CSRF-Token",this.csrfCookieName=e.csrfCookieName||"XSRF-TOKEN",this.csrfTokenSelector=e.csrfTokenSelector||'meta[name="csrf-token"]',this.setupCsrfToken(),this.setupSecurity()}setupCsrfToken(){const e=document.querySelector(this.csrfTokenSelector);if(e)return void(this.csrfToken=e.getAttribute("content"));const t=document.cookie.split(";");for(const a of t){const[e,t]=a.trim().split("=");if(e===this.csrfCookieName)return void(this.csrfToken=decodeURIComponent(t))}console.warn("CSRF token not found in meta tag or cookie")}setupSecurity(){this.addRequestInterceptor(async e=>{try{return SecurityManager.addCSRFToRequest(e)}catch(t){return console.warn("CSRF interceptor error:",t),e}}),this.addRequestInterceptor(async e=>{try{if(this.security.rateLimit.enabled){const t=SecurityManager.checkRateLimit(e.url);if(!t.allowed)throw new HttpError("Rate limit exceeded",429,{retryAfter:t.retryAfter})}return e}catch(t){return console.warn("Rate limit interceptor error:",t),e}}),this.addRequestInterceptor(async e=>{try{return this.security.validation.enabled&&e.body&&(e.body=SecurityManager.sanitizeRequestData(e.body)),e}catch(t){console.warn("Validation interceptor error:",t)}return e})}addRequestInterceptor(e){return this.interceptors.request.push(e),()=>{const t=this.interceptors.request.indexOf(e);-1!==t&&this.interceptors.request.splice(t,1)}}addResponseInterceptor(e,t){return this.interceptors.response.push({onFulfilled:e,onRejected:t}),()=>{const a=this.interceptors.response.findIndex(a=>a.onFulfilled===e&&a.onRejected===t);-1!==a&&this.interceptors.response.splice(a,1)}}async runRequestInterceptors(e){let t={...e};for(const a of this.interceptors.request)t=await a(t);return t}async runResponseInterceptors(e,t=!1){let a=e;for(const s of this.interceptors.response)try{t&&s.onRejected?a=await s.onRejected(a):!t&&s.onFulfilled?a=await s.onFulfilled(a):t||e.success||!s.onRejected||(a=await s.onRejected(a))}catch(n){a={success:!1,status:500,statusText:"Interceptor Error",data:null,headers:{},error:n};break}return a}async request(e,t={}){const a=new AbortController;let n;this.timeout&&(n=setTimeout(()=>a.abort(),this.timeout));try{const s=/^(https?:)?\/\//.test(e)?e:`${this.baseURL}${e}`;let r={method:t.method||"GET",...t,headers:{...this.defaultHeaders,"Accept-Language":"undefined"!=typeof Now&&Now.getLocale?Now.getLocale():navigator.language||"en",...t.headers},signal:a.signal,credentials:t.credentials||"same-origin"};r=await this.runRequestInterceptors(r),r=this.ensureCsrf(r),r.body=this.processRequestBody(r),r=this.normalizeRequestOptions(r);const i=await fetch(s,r);clearTimeout(n);const o=i.headers.get(this.csrfHeaderName);let l;return o&&(this.csrfToken=o),l=this.responseHandler?await this.responseHandler(i):await this.handleResponse(i),await this.runResponseInterceptors(l)}catch(s){clearTimeout(n);const t={success:!1,status:"AbortError"===s.name?408:s.status||500,statusText:"AbortError"===s.name?"Request timeout":s.message||"Unknown error",data:null,headers:{},error:s,url:e};try{return await this.runResponseInterceptors(t,!0)}catch(r){return t}}}processRequestBody(e){var t;const{body:a,headers:n}=e;return a?a instanceof FormData||a instanceof URLSearchParams||a instanceof Blob||a instanceof ArrayBuffer?(delete n["Content-Type"],a):"object"==typeof a&&(n["Content-Type"]||(n["Content-Type"]="application/json"),null==(t=n["Content-Type"])?void 0:t.includes("application/json"))?JSON.stringify(a):a:null}normalizeRequestOptions(e){var t;const a={...e};return a.body||"application/json"!==(null==(t=a.headers)?void 0:t["Content-Type"])||delete a.headers["Content-Type"],!0===a.cache?a.cache="default":!1===a.cache&&(a.cache="no-store"),a}ensureCsrf(e){const t=(e.method||"GET").toUpperCase();if(!this.csrfToken&&this.security.csrf.required&&["POST","PUT","PATCH","DELETE"].includes(t))throw new HttpError("Missing CSRF token",400);if(this.csrfToken&&(e.headers=e.headers||{},e.headers[this.csrfHeaderName]=this.csrfToken,["POST","PUT","PATCH","DELETE"].includes(t))){const t=e.body;"object"!=typeof t||null===t||t instanceof FormData||t._token?t instanceof FormData&&!t.has(this.security.csrf.tokenName||"_token")&&(t.append(this.security.csrf.tokenName||"_token",this.csrfToken),e.body=t):(t[this.security.csrf.tokenName||"_token"]=this.csrfToken,e.body=t)}return e}async handleResponse(e){const t=e.headers.get(this.csrfHeaderName);t&&(this.csrfToken=t);const a=e.headers.get("content-type"),n=null==a?void 0:a.includes("application/json"),s=null==a?void 0:a.includes("text/"),r=null==a?void 0:a.includes("application/octet-stream");let i;try{i=n?await e.json():r?await e.blob():s?await e.text():e}catch(o){i=await e.text()}return{success:e.ok,status:e.status,statusText:e.statusText,data:i,headers:this.getHeadersObject(e),url:e.url}}getHeadersObject(e){const t={};return e.headers.forEach((e,a)=>{t[a]=e}),t}createHttpError(e){return new HttpError(e.statusText||"HTTP Error",e.status,e)}createErrorResponse(e){const t="AbortError"===e.name,a=t?408:e.status||500,n=t?"Request timeout":e.message||"Unknown error";return new HttpError(n,a,e.response)}async get(e,t={}){const a=await this.request(e,{...t,method:"GET"});if(!1!==t.throwOnError&&this.throwOnError&&!a.success)throw new HttpError(a.statusText||"HTTP Error",a.status,a);return a}async post(e,t,a={}){const n=await this.request(e,{...a,method:"POST",body:t});if(!1!==a.throwOnError&&this.throwOnError&&!n.success)throw new HttpError(n.statusText||"HTTP Error",n.status,n);return n}async put(e,t,a={}){const n=await this.request(e,{...a,method:"PUT",body:t});if(!1!==a.throwOnError&&this.throwOnError&&!n.success)throw new HttpError(n.statusText||"HTTP Error",n.status,n);return n}async delete(e,t={}){const a=await this.request(e,{...t,method:"DELETE"});if(!1!==t.throwOnError&&this.throwOnError&&!a.success)throw new HttpError(a.statusText||"HTTP Error",a.status,a);return a}patch(e,t,a={}){return this.request(e,{...a,method:"PATCH",body:t})}head(e,t={}){return this.request(e,{...t,method:"HEAD"})}options(e,t={}){return this.request(e,{...t,method:"OPTIONS"})}upload(e,t,a={}){const n=new FormData;return Array.isArray(t)?t.forEach((e,t)=>n.append(`file${t}`,e)):n.append("file",t),a.data&&Object.entries(a.data).forEach(([e,t])=>{n.append(e,t)}),this.request(e,{...a,method:"POST",body:n})}async getSafe(e,t={}){return this.request(e,{...t,method:"GET"})}async postSafe(e,t,a={}){return this.request(e,{...a,method:"POST",body:t})}async putSafe(e,t,a={}){return this.request(e,{...a,method:"PUT",body:t})}async deleteSafe(e,t={}){return this.request(e,{...t,method:"DELETE"})}setBaseURL(e){this.baseURL=e}setDefaultHeader(e,t){this.defaultHeaders[e]=t}setDefaultHeaders(e){this.defaultHeaders={...this.defaultHeaders,...e}}setTimeout(e){this.timeout=e}setCsrfToken(e){this.csrfToken=e}}class HttpError extends Error{constructor(e,t,a=null){super(e),this.name="HttpError",this.status=t,this.response=a,this.timestamp=Date.now()}}const ue=new HttpClient({throwOnError:!1,responseHandler:async e=>{const t=e.headers.get("content-type");let a;try{a=(null==t?void 0:t.includes("application/json"))?await e.json():(null==t?void 0:t.includes("text/"))?await e.text():(null==t?void 0:t.includes("application/octet-stream"))?await e.blob():await e.text()}catch(n){a=null}return{success:e.ok,status:e.status,statusText:e.statusText,data:a,headers:Object.fromEntries(e.headers.entries()),url:e.url,timestamp:Date.now(),requestId:e.headers.get("X-Request-ID")}}}),he=new HttpClient({throwOnError:!0,responseHandler:async e=>{const t=e.headers.get("content-type");let a;a=(null==t?void 0:t.includes("application/json"))?await e.json():(null==t?void 0:t.includes("text/"))?await e.text():(null==t?void 0:t.includes("application/octet-stream"))?await e.blob():await e.text();const n={status:e.status,data:a,message:(null==a?void 0:a.message)||e.statusText,meta:null==a?void 0:a.meta,timestamp:Date.now(),headers:Object.fromEntries(e.headers.entries()),requestId:e.headers.get("X-Request-ID")};if(!e.ok)throw new HttpError(n.message||"Server Error",n.status,n);return n}}),pe={config:{baseURL:"",defaultHeaders:{"X-Requested-With":"XMLHttpRequest"},timeout:15e3},async fetch(e,t={}){const a=new AbortController,n=setTimeout(()=>a.abort(),this.config.timeout);try{const i=/^(https?:)?\/\//.test(e)?e:`${this.config.baseURL}${e}`,o={method:"GET",headers:{...this.config.defaultHeaders,"Accept-Language":"undefined"!=typeof Now&&Now.getLocale?Now.getLocale():navigator.language||"en"},credentials:"same-origin",signal:a.signal,...t};t.headers&&(o.headers={...o.headers,...t.headers});const l=function getCsrfToken(e="XSRF-TOKEN",t='meta[name="csrf-token"]'){const a=document.querySelector(t);if(a)return a.getAttribute("content");const n=document.cookie.split(";");for(const s of n){const[t,a]=s.trim().split("=");if(t===e)return decodeURIComponent(a)}return null}(this.config.csrfCookieName||"XSRF-TOKEN",this.config.csrfSelector||'meta[name="csrf-token"]');l&&(o.headers[this.config.csrfHeaderName||"X-CSRF-Token"]=l,["POST","PUT","PATCH","DELETE"].includes((o.method||"GET").toUpperCase())&&(o.body instanceof FormData?o.body.has("_token")||o.body.append("_token",l):o.body&&"object"==typeof o.body&&(o.body._token||(o.body._token=l))));try{const e=localStorage.getItem("auth_token");e&&(o.headers.Authorization=`Bearer ${e}`)}catch(s){}!o.body||"object"!=typeof o.body||o.body instanceof FormData||(o.headers["Content-Type"]=o.headers["Content-Type"]||"application/json",o.headers["Content-Type"].includes("application/json")&&(o.body=JSON.stringify(o.body))),!o.headers||void 0!==o.headers["Content-Type"]&&null!==o.headers["Content-Type"]||delete o.headers["Content-Type"],!o.body&&o.headers&&delete o.headers["Content-Type"],o.body instanceof FormData&&o.headers&&delete o.headers["Content-Type"];const c=await fetch(i,o);clearTimeout(n);const d=c.headers.get("content-type")||"";let u;try{if(d.includes("application/json"))u=await c.json();else if(d.includes("text/"))u=await c.text();else if(d.includes("application/octet-stream")||d.includes("application/pdf"))u=await c.blob();else{const e=await c.text();try{u=JSON.parse(e)}catch{u=e}}}catch(r){u=null}return{success:c.ok,status:c.status,statusText:c.statusText,data:u,headers:Object.fromEntries(c.headers.entries()),url:c.url}}catch(i){return clearTimeout(n),{success:!1,status:"AbortError"===i.name?408:0,statusText:"AbortError"===i.name?"Request Timeout":i.message,data:null,headers:{},url:e,error:i}}},async get(e,t={}){return this.fetch(e,{...t,method:"GET"})},async post(e,t=null,a={}){return this.fetch(e,{...a,method:"POST",body:t})},async put(e,t=null,a={}){return this.fetch(e,{...a,method:"PUT",body:t})},async delete(e,t={}){return this.fetch(e,{...t,method:"DELETE"})},async patch(e,t=null,a={}){return this.fetch(e,{...a,method:"PATCH",body:t})},async json(e,t={}){const a=await this.get(e,t);return a.success?a.data:null},async text(e,t={}){const a=await this.get(e,t);return a.success?a.data:null},async postJson(e,t,a={}){const n=await this.post(e,t,a);return n.success?n.data:null},async upload(e,t,a={},n={}){let s;t instanceof FormData?s=t:(s=new FormData,Array.isArray(t)?t.forEach((e,t)=>{s.append(`file${t}`,e)}):t&&s.append("file",t)),Object.entries(a).forEach(([e,t])=>{s.append(e,t)});const r={...n.headers};return delete r["Content-Type"],this.post(e,s,{...n,headers:r})},setBaseURL(e){return this.config.baseURL=e.endsWith("/")?e.slice(0,-1):e,this},setHeaders(e){return this.config.defaultHeaders={...this.config.defaultHeaders,...e},this},setHeader(e,t){return this.config.defaultHeaders[e]=t,this},setTimeout(e){return this.config.timeout=e,this},removeHeader(e){return delete this.config.defaultHeaders[e],this},resetConfig(){return this.config={baseURL:"",defaultHeaders:{"Content-Type":"application/json","X-Requested-With":"XMLHttpRequest"},timeout:15e3},this}};window.HttpClient=HttpClient,window.http=ue,window.httpThrow=he,window.simpleFetch=pe;const me={cache:new Map,pendingRequests:new Map,abortControllers:new Map,_accessToken:null,config:{baseURL:"",debug:!1,retryCount:3,retryDelay:1e3,deduplicate:!0,security:{csrfProtection:!0,csrfHeaderName:"X-CSRF-Token",csrfCookieName:"XSRF-TOKEN",csrfTokenSelector:'meta[name="csrf-token"]',csrfIncludeSafeMethods:!0,bearerAuth:!1,bearerTokenKey:"auth_token",bearerPrefix:"Bearer ",basicAuth:!1,basicUsername:"",basicPassword:"",oauth:!1,oauthTokenKey:"oauth_token",contentSecurityPolicy:!0,allowedOrigins:[],jwtRefresh:!1,jwtRefreshEndpoint:window.Now&&Now.DEFAULT_CONFIG&&Now.DEFAULT_CONFIG.auth&&Now.DEFAULT_CONFIG.auth.endpoints&&Now.DEFAULT_CONFIG.auth.endpoints.refresh?Now.DEFAULT_CONFIG.auth.endpoints.refresh:"api/auth/refresh",jwtExpireKey:"exp",jwtRefreshBeforeExpirySec:300,authStrategy:"hybrid",sendCredentials:!0},connection:{timeout:3e4,retryOnNetworkError:!0,maxNetworkRetries:3,backoffFactor:1.5,retryStatusCodes:[408,429,500,502,503,504],exponentialBackoff:!0},cache:{enabled:!0,storageType:"memory",maxSize:100,expiry:{default:6e4,get:6e4,post:0,put:0,delete:0},keyGeneratorFn:null,responsePredicate:null},tracking:{enabled:!1,errorTracking:!0,performanceTracking:!1,analyticsCallback:null,excludePaths:[]},logging:{enabled:!1,logLevel:"error",includeRequest:!0,includeResponse:!0,logToConsole:!0,customLogger:null}},async init(e={}){return this.config=this._mergeDeep(this.config,e),this.config.baseURL&&http.setBaseURL(this.config.baseURL),this.config.security.csrfProtection&&this.setupCsrfProtection(),this.config.security.bearerAuth&&this.setupBearerAuth(),this.config.security.basicAuth&&this.setupBasicAuth(),this.config.security.jwtRefresh&&this.setupJwtRefresh(),this.setupInterceptors(),this.config.cache.enabled&&this.setupCache(),this.config.tracking.enabled&&this.setupTracking(),this},setupCsrfProtection(){http.addRequestInterceptor(e=>{const t=(e.method||"GET").toUpperCase();if(!this._shouldAttachCsrf(t))return e;const a=e.headers||{};return e.headers=this._applyCsrfHeader({...a},t),e})},_shouldAttachCsrf(e="GET"){if(!this.config.security.csrfProtection)return!1;const t=(e||"GET").toUpperCase();return!!this.config.security.csrfIncludeSafeMethods||!["GET","HEAD","OPTIONS","TRACE"].includes(t)},_resolveCsrfToken(){var e,t;try{if("undefined"!=typeof window){if(null==(e=window.AuthManager)?void 0:e.getCSRFToken){const e=window.AuthManager.getCSRFToken();if(e)return e}if(null==(t=window.SecurityManager)?void 0:t.getCSRFToken){const e=window.SecurityManager.getCSRFToken();if(e)return e}}if("undefined"==typeof document)return null;const a=this.config.security.csrfTokenSelector||'meta[name="csrf-token"]',n=document.querySelector(a);if(n){const e=n.getAttribute("content");if(e)return e}if("string"==typeof document.cookie){const e=this.config.security.csrfCookieName||"XSRF-TOKEN",t=document.cookie.split(";");for(const a of t){const[t,n]=a.trim().split("=");if(t===e)return decodeURIComponent(n||"")}}const s=document.querySelector('input[name="_token"], input[name="csrf_token"]');return s&&s.value?s.value:null}catch(a){return this.log("warn","Failed to resolve CSRF token",a),null}},_applyCsrfHeader(e={},t="GET"){if(!this._shouldAttachCsrf(t))return e;const a=this.config.security.csrfHeaderName||"X-CSRF-Token";if(e&&e[a])return e;const n=this._resolveCsrfToken();return n?{...e,[a]:n}:e},setupBearerAuth(){const{bearerTokenKey:e,bearerPrefix:t,authStrategy:a}=this.config.security;http.addRequestInterceptor(n=>{let s=null;return s="storage"===a?localStorage.getItem(e):"hybrid"===a?this._accessToken:null,s&&(n.headers=n.headers||{},n.headers.Authorization=`${t}${s}`),n})},setAccessToken(e){this._accessToken=e},clearAccessToken(){this._accessToken=null},setupBasicAuth(){const{basicUsername:e,basicPassword:t}=this.config.security;http.addRequestInterceptor(a=>{const n=btoa(`${e}:${t}`);return a.headers.Authorization=`Basic ${n}`,a})},setupJwtRefresh(){const{jwtRefreshEndpoint:e,jwtExpireKey:t,jwtRefreshBeforeExpirySec:a,bearerTokenKey:n,authStrategy:s,sendCredentials:r}=this.config.security,checkAndRefreshToken=async()=>{try{let i=null;if("storage"===s?i=localStorage.getItem(n):"hybrid"===s&&(i=this._accessToken),!i&&"storage"===s)return;let o=1/0;if(i){const e=i.split(".")[1];if(e){const a=JSON.parse(atob(e)),n=a&&a[t];if(n){const e=new Date(1e3*n);o=(e-new Date)/1e3}}}if(o<=a){const t=await simpleFetch.post(e,null,{credentials:r?"include":"same-origin"});t&&t.data&&t.data.token&&("storage"===s?localStorage.setItem(n,t.data.token):"hybrid"===s&&this.setAccessToken(t.data.token))}}catch(i){this.config.logging.enabled&&this.log("error","JWT refresh error",i)}};setInterval(checkAndRefreshToken,6e4),checkAndRefreshToken()},setupInterceptors(){this.config.tracking.performanceTracking&&(http.addRequestInterceptor(e=>(e.__startTime=performance.now(),e)),http.addResponseInterceptor(e=>{var t,a;const n=e.__startTime;if(n){const s=performance.now()-n;delete e.__startTime,"function"==typeof this.config.tracking.analyticsCallback&&this.config.tracking.analyticsCallback({type:"performance",url:null==(t=e.config)?void 0:t.url,method:null==(a=e.config)?void 0:a.method,duration:s,status:e.status})}return e},e=>{var t,a,n;const s=null==(t=e.config)?void 0:t.__startTime;if(s){const t=performance.now()-s;"function"==typeof this.config.tracking.analyticsCallback&&this.config.tracking.analyticsCallback({type:"error",url:null==(a=e.config)?void 0:a.url,method:null==(n=e.config)?void 0:n.method,duration:t,status:e.status,message:e.message})}throw e})),http.addResponseInterceptor(e=>e,e=>{var t,a;if(this.shouldRetryRequest(e))return this.retryRequest(e);throw this.config.logging.enabled&&this.config.logging.errorTracking&&this.log("error","API request failed",{url:null==(t=e.config)?void 0:t.url,method:null==(a=e.config)?void 0:a.method,status:e.status,message:e.message}),e})},setupCache(){const{storageType:e}=this.config.cache;if("local"===e||"session"===e)try{const t=("local"===e?localStorage:sessionStorage).getItem("api_cache");t&&(this.cache=new Map(JSON.parse(t)),this.clearExpiredCache()),window.addEventListener("beforeunload",()=>{this.persistCache()})}catch(t){this.log("error","Failed to setup cache storage",t)}},setupTracking(){"function"!=typeof this.config.tracking.analyticsCallback&&(this.config.tracking.analyticsCallback=e=>{this.config.logging.enabled&&this.log("info","Analytics event",e)})},persistCache(){try{const{storageType:e,maxSize:t}=this.config.cache;if("local"===e||"session"===e){const a="local"===e?localStorage:sessionStorage;if(this.clearExpiredCache(),this.cache.size>t){const e=Array.from(this.cache.entries()).sort((e,t)=>e[1].timestamp-t[1].timestamp);for(;e.length>t;){const[t]=e.shift();this.cache.delete(t)}}a.setItem("api_cache",JSON.stringify(Array.from(this.cache.entries())))}}catch(e){this.log("error","Failed to persist cache",e)}},clearExpiredCache(){const e=Date.now();for(const[t,a]of this.cache.entries())e>a.expiresAt&&this.cache.delete(t)},createCacheKey(e,t={},a="GET"){if("function"==typeof this.config.cache.keyGeneratorFn)return this.config.cache.keyGeneratorFn(e,t,a);let n="";return t instanceof URLSearchParams?n=t.toString():"string"==typeof t?n=t:t&&"object"==typeof t&&(n=JSON.stringify(t)),`${a}:${e}:${n}`},_normalizeOptionsForHttpClient(e){if(!e||"object"!=typeof e)return e;const t={...e};return e.cache&&"object"==typeof e.cache&&(!1===e.cache.enabled?t.cache="no-store":!0===e.cache.enabled?t.cache="memory"===e.cache.storageType?"default":"force-cache":"no-store"===e.cache.storageType||"no-cache"===e.cache.storageType?t.cache=e.cache.storageType:delete t.cache),t},buildUrlWithParams(e,t={}){const hasParams=e=>!!e&&(Array.isArray(e)?e.some(e=>hasParams(e)):e instanceof URLSearchParams?Array.from(e.keys()).length>0:"string"==typeof e?e.length>0:Object.keys(e).length>0);if(!hasParams(t))return e;const[a,n=""]=String(e).split("#"),[s,r=""]=a.split("?"),i=new URLSearchParams(r),appendValue=(e,t)=>{if(null==t)return;if(Array.isArray(t))return void t.forEach(t=>appendValue(e,t));if(t instanceof Date)return void i.append(e,t.toISOString());const a="undefined"!=typeof Blob&&t instanceof Blob,n="undefined"!=typeof File&&t instanceof File;"object"!=typeof t||a||n?i.append(e,t):i.append(e,JSON.stringify(t))},processParams=e=>{if(e)if(Array.isArray(e))e.forEach(e=>processParams(e));else if(e instanceof URLSearchParams)for(const[t,a]of e.entries())i.append(t,a);else"string"!=typeof e?Object.entries(e).forEach(([e,t])=>{appendValue(e,t)}):new URLSearchParams(e).forEach((e,t)=>{i.append(t,e)})};processParams(t);const o=i.toString(),l=n?`#${n}`:"";return o?`${s}?${o}${l}`:`${s}${l}`},shouldRetryRequest(e){const{retryOnNetworkError:t,retryStatusCodes:a}=this.config.connection;return!(!t||!e.message.includes("network")&&0!==e.status)||!!a.includes(e.status)},async retryRequest(e){const{maxNetworkRetries:t,backoffFactor:a,exponentialBackoff:n}=this.config.connection,s=e.config;if(s.retryCount=s.retryCount||0,s.retryCount>=t)return Promise.reject(e);s.retryCount++;let r=this.config.retryDelay;return n&&(r*=Math.pow(a,s.retryCount-1)),await new Promise(e=>setTimeout(e,r)),http.request(s.url,s)},async get(e,t={},a={}){const n={...this.config,...a},hasParamValues=e=>!!e&&(Array.isArray(e)?e.some(e=>hasParamValues(e)):e instanceof URLSearchParams?Array.from(e.keys()).length>0:"string"==typeof e?e.length>0:Object.keys(e).length>0);let s=t;(null==a?void 0:a.params)&&(s=hasParamValues(t)?[t,a.params]:a.params);const r=this.buildUrlWithParams(e,s),normalizeForCache=e=>{if(!e)return e;if(e instanceof URLSearchParams)return e.toString();if(Array.isArray(e))return e.map(e=>normalizeForCache(e));if(e instanceof Date)return e.toISOString();const t="undefined"!=typeof Blob&&e instanceof Blob,a="undefined"!=typeof File&&e instanceof File;if(t||a)return"[binary]";if("object"==typeof e){const t={};return Object.entries(e).forEach(([e,a])=>{t[e]=normalizeForCache(a)}),t}return e},i=this.createCacheKey(e,normalizeForCache(s),"GET");if(n.cache.enabled&&n.cache.expiry.get>0){const e=this.cache.get(i);if(e&&Date.now()<e.expiresAt)return this.config.logging.enabled&&"debug"===this.config.logging.logLevel&&this.log("debug","Cache hit",{url:r,params:s,cacheKey:i}),{...e.data,fromCache:!0}}if(n.deduplicate&&this.pendingRequests.has(i))return this.pendingRequests.get(i);const o=new AbortController;this.abortControllers.set(i,o);const l=(async()=>{try{this.config.logging.enabled&&"debug"===this.config.logging.logLevel&&this.log("debug","API request",{url:r,params:s,method:"GET"});const e=this._normalizeOptionsForHttpClient({...a}),t=http&&http.normalizeRequestOptions?http.normalizeRequestOptions(e):e,{params:l,signal:c,...d}=t,u={...d,headers:{...d.headers||{}}};let h;if("credentials"in u||(u.credentials=this.config.security.sendCredentials?"include":"same-origin"),u.signal=o.signal,c&&(c.aborted?o.abort(c.reason):c.addEventListener("abort",()=>o.abort(c.reason),{once:!0})),http&&"function"==typeof http.get)h=await http.get(r,u);else{if(!simpleFetch||"function"!=typeof simpleFetch.get)throw new Error("No HTTP client available for GET requests");{const e={...u,headers:this._applyCsrfHeader({...u.headers},"GET")};h=await simpleFetch.get(r,e)}}if(n.cache.enabled&&n.cache.expiry.get>0){("function"!=typeof n.cache.responsePredicate||n.cache.responsePredicate(h))&&this.cache.set(i,{data:h,timestamp:Date.now(),expiresAt:Date.now()+n.cache.expiry.get})}return h}catch(e){throw e}finally{this.pendingRequests.delete(i),this.abortControllers.delete(i)}})();return this.pendingRequests.set(i,l),l},async post(e,t,a={}){return this._sendNonGetRequest("POST",e,t,a)},async put(e,t,a={}){return this._sendNonGetRequest("PUT",e,t,a)},async delete(e,t={}){return this._sendNonGetRequest("DELETE",e,null,t)},async _sendNonGetRequest(e,t,a,n={}){if(this.config.logging.enabled&&"debug"===this.config.logging.logLevel){const n={url:t,method:e};null!=a&&(n.data=a),this.log("debug","API request",n)}const s=this._normalizeOptionsForHttpClient({...n}),r=http&&http.normalizeRequestOptions?http.normalizeRequestOptions(s):s,{params:i,...o}=r,l=this.buildUrlWithParams(t,i);"credentials"in o||(o.credentials=this.config.security.sendCredentials?"include":"same-origin");const c=e.toLowerCase();let d;if(http&&"function"==typeof http[c])d=["post","put","patch"].includes(c)?await http[c](l,a,o):await http[c](l,o);else{if(!simpleFetch||"function"!=typeof simpleFetch[c])throw new Error(`Unsupported HTTP method: ${e}`);{const t={...o,headers:this._applyCsrfHeader({...o&&o.headers||{}},e)},n=[l];["post","put","patch"].includes(c)&&n.push(a),n.push(t),d=await simpleFetch[c](...n)}}return this.invalidateCacheByUrl(t),l!==t&&this.invalidateCacheByUrl(l),d},abort(e,t={}){const a=this.createCacheKey(e,t),n=this.abortControllers.get(a);return!!n&&(n.abort(),this.abortControllers.delete(a),this.pendingRequests.delete(a),!0)},clearCache(){this.cache.clear(),this.persistCache()},invalidateCache(e,t={}){const a=this.createCacheKey(e,t),n=this.cache.delete(a);return this.persistCache(),n},invalidateCacheByUrl(e){let t=0;for(const a of this.cache.keys())a.includes(e)&&(this.cache.delete(a),t++);return this.persistCache(),t},all:async e=>Promise.all(e),poll(e,t={},a=5e3,n,s={}){const r={maxPolls:1/0,condition:null,...s};let i=0,o=null;const execute=async()=>{try{i++;const s=await this.get(e,t,{cache:{enabled:!1}});n(s,null,i);if("function"==typeof r.condition&&r.condition(s)||i>=r.maxPolls)return;o=setTimeout(execute,a)}catch(s){n(null,s,i),i<r.maxPolls&&(o=setTimeout(execute,a))}};return execute(),()=>{o&&(clearTimeout(o),o=null)}},async sequence(e,t){const a=[];for(const s of e)try{const{url:e,params:n,options:r}=s,i=await this.get(e,n,r);if("function"==typeof t){const e=await t(i);a.push(e)}else a.push(i)}catch(n){a.push({error:n})}return a},async paginate(e,t={},a={}){const n={pageParam:"page",limitParam:"pageSize",startPage:1,limit:20,maxPages:1/0,dataPath:"data",totalPath:"meta.total",stopCondition:null,...a},s=[];let r=n.startPage,i=!0,o=null;for(;i&&r<=n.maxPages;){const a={...t,[n.pageParam]:r,[n.limitParam]:n.limit},l=await this.get(e,a),c=this.getValueByPath(l,n.dataPath);let d=[];if(d=Array.isArray(c)?c:c&&"object"==typeof c&&Array.isArray(c.data)?c.data:null!=c?Array.isArray(c)?c:[c]:[],null===o&&(o=this.getValueByPath(l,n.totalPath)),Array.isArray(d)?s.push(...d):null!=d&&s.push(d),"function"==typeof n.stopCondition){if(n.stopCondition(d,l,r))break}i=d.length===n.limit,null!==o&&(i=s.length<o),r++}return{data:s,pages:r-1,total:o||s.length}},getValueByPath(e,t){if(e&&t)return t.split(".").reduce((e,t)=>null==e?void 0:e[t],e)},_mergeDeep(e,t){const isObject=e=>e&&"object"==typeof e&&!Array.isArray(e);if(!t)return e;const a={...e};return isObject(e)&&isObject(t)&&Object.keys(t).forEach(n=>{isObject(t[n])?a[n]=n in e?this._mergeDeep(e[n],t[n]):t[n]:a[n]=t[n]}),a},log(e,t,a={}){if(!this.config.logging.enabled)return;const n={debug:0,info:1,warn:2,error:3};if(n[e]<n[this.config.logging.logLevel])return;const s={timestamp:(new Date).toISOString(),level:e,message:t,...a};if("function"!=typeof this.config.logging.customLogger){if(this.config.logging.logToConsole)switch(e){case"debug":console.debug(`[API] ${t}`,a);break;case"info":console.info(`[API] ${t}`,a);break;case"warn":console.warn(`[API] ${t}`,a);break;case"error":console.error(`[API] ${t}`,a)}}else this.config.logging.customLogger(s)}};(null==(w=window.Now)?void 0:w.registerManager)&&Now.registerManager("api",me),window.ApiService=me;const ge={config:{method:"GET",baseURL:"",autoload:!0,timeout:3e4,cache:!1,cacheTime:6e4,retry:3,onSuccess:null,onError:null,onEmpty:null},state:{instances:new Map,initialized:!1,cache:new Map},create(e,t={}){var a;if(!window.http||"function"!=typeof window.http.get){const e="HttpClient (window.http) is required for ApiComponent";console.error("[ApiComponent]",e);const t=(null==(a=window.Now)?void 0:a.translate)?Now.translate(e):e;return alert(t),null}if("string"==typeof e&&(e=document.querySelector(e)),!e)return console.error("[ApiComponent] Element not found"),null;const n=this.getInstance(e);if(n)return n;const s={id:"api_"+Math.random().toString(36).substring(2,11),element:e,options:{...this.config,...this.extractOptionsFromElement(e),...t},data:null,loading:!1,error:null,timestamp:null,page:1,totalPages:1,pageSize:10,totalItems:0,polling:!1,timer:null,abortController:null};return this.setup(s),this.state.instances.set(s.id,s),e.dataset.apiComponentId=s.id,e.apiInstance=s,s},setup(e){try{e.element.classList.add("api-component");const t=e.element.querySelector("template");if(t)e.templateContent=t.innerHTML;else if(e.options.template){const t=document.getElementById(e.options.template);t&&"TEMPLATE"===t.tagName&&(e.templateContent=t.innerHTML)}this.bindEvents(e),e.options.autoload&&this.loadData(e),e.options.polling&&e.options.pollingInterval&&this.startPolling(e),this.dispatchEvent(e,"init",{instance:e})}catch(t){console.error("[ApiComponent] Setup error:",t),e.error=t.message,this.renderError(e)}},bindEvents(e){if(e.options.refreshEvent){e.options.refreshEvent.split(",").map(e=>e.trim()).forEach(t=>{if(!t)return;const handler=()=>this.refresh(e);e.eventHandlers||(e.eventHandlers=new Map),e.eventHandlers.set(t,handler),window.EventManager?EventManager.on(t,handler):document.addEventListener(t,handler)})}e.refresh=()=>{this.refresh(e)},e.loadMore=()=>{this.loadMore(e)}},async loadData(e,t=!1){var a,n;try{if(e.abortController&&e.abortController.abort(),e.abortController=new AbortController,e.loading=!0,e.error=null,this.renderLoading(e),!e.options.endpoint)throw new Error("API endpoint is required");const s=this.createCacheKey(e);if(e.options.cache&&!t){const t=this.state.cache.get(s);if(t&&Date.now()<t.expires)return e.data=t.data,e.loading=!1,this.renderContent(e),void this.dispatchEvent(e,"loaded",{data:e.data,fromCache:!0})}let r=e.options.endpoint;!e.options.baseURL||r.startsWith("http://")||r.startsWith("https://")||(r=e.options.baseURL+r);const i={...e.options.params};if(e.options.urlParams){const t=this.collectUrlParams(e);if(e.options.urlParamsRequired){const s=(null==(a=e.options.urlParamsFields)?void 0:a.split(",").map(e=>e.trim()))||[],r=s.filter(e=>!t[e]);if(r.length>0||s.length>0&&0===Object.keys(t).length){const t=(null==(n=window.Now)?void 0:n.translate)?Now.translate("Missing required URL parameters"):"Missing required URL parameters";return e.error=t,e.loading=!1,this.renderError(e),void this.dispatchEvent(e,"error",{error:t,missingParams:r})}}Object.assign(i,t)}!1!==e.options.pagination&&(e.options.pageParam&&(i[e.options.pageParam]=e.page),e.options.limitParam&&(i[e.options.limitParam]=e.options.pageSize||e.pageSize||10));const o={throwOnError:!1,headers:e.options.headers||{}};if(!window.http||"function"!=typeof window.http.request)throw new Error("HttpClient (window.http) is required but not available");let l;switch(e.options.method.toUpperCase()){case"POST":l=await window.http.post(r,e.options.data||i,o);break;case"PUT":l=await window.http.put(r,e.options.data||i,o);break;case"DELETE":l=await window.http.delete(r,o);break;default:if(Object.keys(i).length>0){const e=new URLSearchParams(i).toString();r=`${r}${r.includes("?")?"&":"?"}${e}`}l=await window.http.get(r,o)}if(!l.success)throw new Error(`HTTP error! status: ${l.status}`);this.updateDataFromResponse(e,l,t),e.options.cache&&e.data&&this.state.cache.set(s,{data:e.data,expires:Date.now()+(e.options.cacheTime||this.config.cacheTime)}),e.error=null,this.dispatchEvent(e,"loaded",{data:e.data,response:l}),this.renderContent(e),"function"==typeof e.options.onSuccess&&e.options.onSuccess.call(e,e.data,l)}catch(s){e.error=s.message,console.error("[ApiComponent] Load error:",s),this.dispatchEvent(e,"error",{error:e.error,message:s.message}),this.renderError(e),"function"==typeof e.options.onError&&e.options.onError.call(e,s)}finally{e.loading=!1,e.abortController=null}},createCacheKey(e){const{endpoint:t,method:a,params:n,data:s}=e.options;return`${a}:${t}:${n?JSON.stringify(n):""}:${s?JSON.stringify(s):""}`},collectUrlParams(e){const t=new URLSearchParams(window.location.search),a=window.location.hash,n=a.indexOf("?");if(-1!==n){const e=new URLSearchParams(a.substring(n));for(const[a,n]of e.entries())t.set(a,n)}const s=e.options.urlParamsFields;if(s){const e=s.split(",").map(e=>e.trim()),a={};return e.forEach(e=>{t.has(e)&&(a[e]=t.get(e))}),a}return Object.fromEntries(t.entries())},updateDataFromResponse(e,t,a=!1){const n=e.options.dataPath||"data";let s;const r=t.data;if(s="data"===n?(null==r?void 0:r.data)??r:this.getValueByPath(r,n),!s)return e.data=[],this.dispatchEvent(e,"empty"),void("function"==typeof e.options.onEmpty&&e.options.onEmpty.call(e));if(a&&Array.isArray(s)&&Array.isArray(e.data)?e.data=[...e.data,...s]:e.data=s,!1!==e.options.pagination){const a=e.options.metaPath||"meta",n=this.getValueByPath(t,a)||{};e.totalItems=n.total||0,e.totalPages=n.last_page||Math.ceil(e.totalItems/e.pageSize)||1}e.timestamp=Date.now()},getValueByPath:(e,t)=>t.split(".").reduce((e,t)=>null==e?void 0:e[t],e),renderLoading(e){const t=e.element;t.classList.remove("api-error","api-empty","api-content"),t.classList.add("api-loading")},renderError(e){const t=e.element;t.classList.remove("api-loading","api-empty","api-content"),t.classList.add("api-error"),console.error("[ApiComponent] Error:",e.error)},renderContent(e){const t=e.element;if(t.classList.remove("api-loading","api-error","api-empty"),!e.data||Array.isArray(e.data)&&0===e.data.length)return void t.classList.add("api-empty");t.classList.add("api-content");const a={...e,data:e.data,state:{data:e.data},...this.options};window.TemplateManager&&"function"==typeof TemplateManager.processTemplate&&TemplateManager.processTemplate(t,a),this.dispatchEvent(e,"content-rendered",{data:e.data})},applySimpleTemplate(e,t){return e.replace(/\{([^}]+)\}/g,(e,a)=>this.getValueByPath(t,a.trim())??"")},refresh(e){"string"==typeof e?e=this.state.instances.get(e):e instanceof HTMLElement&&(e=this.getInstance(e)),e&&(e.page=1,this.loadData(e))},loadMore(e){"string"==typeof e?e=this.state.instances.get(e):e instanceof HTMLElement&&(e=this.getInstance(e)),e&&(e.loading||e.page>=e.totalPages||(e.page++,this.loadData(e,!0)))},startPolling(e){if("string"==typeof e?e=this.state.instances.get(e):e instanceof HTMLElement&&(e=this.getInstance(e)),!e)return;if(e.polling)return;e.polling=!0;const t=parseInt(e.options.pollingInterval)||3e4;e.timer=setInterval(()=>{e.loading||this.loadData(e)},t),this.dispatchEvent(e,"polling:start")},stopPolling(e){"string"==typeof e?e=this.state.instances.get(e):e instanceof HTMLElement&&(e=this.getInstance(e)),e&&e.polling&&(e.timer&&(clearInterval(e.timer),e.timer=null),e.polling=!1,this.dispatchEvent(e,"polling:stop"))},async submit(e,t){if("string"==typeof e?e=this.state.instances.get(e):e instanceof HTMLElement&&(e=this.getInstance(e)),e)return e.options.method="POST",t&&(e.options.data=t),this.loadData(e)},formatDate(e,t){if(!e)return"";try{const a=new Date(e);return isNaN(a.getTime())?e:t.replace("Y",a.getFullYear()).replace("m",String(a.getMonth()+1).padStart(2,"0")).replace("d",String(a.getDate()).padStart(2,"0")).replace("H",String(a.getHours()).padStart(2,"0")).replace("i",String(a.getMinutes()).padStart(2,"0")).replace("s",String(a.getSeconds()).padStart(2,"0"))}catch(a){return e}},formatNumber(e,t){if(null==e)return"";const a=parseFloat(e);return isNaN(a)?e:a.toLocaleString(void 0,{minimumFractionDigits:parseInt(t),maximumFractionDigits:parseInt(t)})},formatCurrency(e,t,a){if(null==e)return"";const n=parseFloat(e);return isNaN(n)?e:t+" "+this.formatNumber(n,a)},clearCache(){this.state.cache.clear()},dispatchEvent(e,t,a={}){if(!e.element)return;const n=new CustomEvent(`api:${t}`,{bubbles:!0,cancelable:!0,detail:{instance:e,element:e.element,...a}});document.contains(e.element)?e.element.dispatchEvent(n):document.dispatchEvent(n),EventManager.emit(`api:${t}`,{instance:e,...a})},extractOptionsFromElement(e){const t={},a=e.dataset;if(a.props)try{const e=JSON.parse(a.props);Object.assign(t,e)}catch(n){console.warn("[ApiComponent] Invalid JSON in data-props:",n)}if(!t.endpoint&&a.endpoint&&(t.endpoint=a.endpoint),!t.method&&a.method&&(t.method=a.method.toUpperCase()),!t.baseURL&&a.baseUrl&&(t.baseURL=a.baseUrl),void 0===t.autoload&&void 0!==a.autoload&&(t.autoload="false"!==a.autoload),void 0===t.cache&&void 0!==a.cache&&(t.cache="true"===a.cache),!t.cacheTime&&a.cacheTime&&(t.cacheTime=parseInt(a.cacheTime)),!t.timeout&&a.timeout&&(t.timeout=parseInt(a.timeout)),!t.retry&&a.retry&&(t.retry=parseInt(a.retry)),!t.template&&a.template&&(t.template=a.template),!t.refreshEvent&&a.refreshEvent&&(t.refreshEvent=a.refreshEvent),!t.pagination&&a.pagination&&(t.pagination="false"!==a.pagination),!t.pageParam&&a.pageParam&&(t.pageParam=a.pageParam),!t.limitParam&&a.limitParam&&(t.limitParam=a.limitParam),!t.pageSize&&a.pageSize&&(t.pageSize=parseInt(a.pageSize)),!t.params&&a.params)try{t.params=JSON.parse(a.params)}catch(n){console.warn("[ApiComponent] Invalid JSON in data-params")}if(!t.data&&a.data)try{t.data=JSON.parse(a.data)}catch(n){console.warn("[ApiComponent] Invalid JSON in data-data")}if(!t.headers&&a.headers)try{t.headers=JSON.parse(a.headers)}catch(n){console.warn("[ApiComponent] Invalid JSON in data-headers")}return!t.dataPath&&a.dataPath&&(t.dataPath=a.dataPath),!t.metaPath&&a.metaPath&&(t.metaPath=a.metaPath),void 0===t.urlParams&&void 0!==a.urlParams&&(t.urlParams="true"===a.urlParams),!t.urlParamsFields&&a.urlParamsFields&&(t.urlParamsFields=a.urlParamsFields),void 0===t.urlParamsRequired&&void 0!==a.urlParamsRequired&&(t.urlParamsRequired="true"===a.urlParamsRequired),t},getInstance(e){if("string"==typeof e&&(e=document.querySelector(e)),!e)return null;if(e.apiInstance)return e.apiInstance;const t=e.dataset.apiComponentId;if(t&&this.state.instances.has(t))return this.state.instances.get(t);for(const a of this.state.instances.values())if(a.element===e)return a;return null},destroy(e){return"string"==typeof e?e=this.state.instances.get(e):e instanceof HTMLElement&&(e=this.getInstance(e)),!!e&&(e.polling&&clearInterval(e.timer),e.abortController&&e.abortController.abort(),e.eventHandlers&&e.eventHandlers.forEach((e,t)=>{window.EventManager?EventManager.off(t,e):document.removeEventListener(t,e)}),e.data=null,e.loading=!1,e.error=null,e.element&&(delete e.element.apiInstance,delete e.element.dataset.apiComponentId,e.element.classList.remove("api-component")),this.dispatchEvent(e,"destroy"),e.id&&this.state.instances.delete(e.id),!0)},async init(e={}){return this.config={...this.config,...e},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>this.initElements()):this.initElements(),this.state.initialized=!0,this},initElements(){document.querySelectorAll('[data-component="api"]').forEach(e=>{this.create(e)})}};if(window.ComponentManager){const e={template:null,validElement:e=>e.classList.contains("api-component")||"api"===e.dataset.component||e.dataset.endpoint,setupElement(e,t){const a=ge.extractOptionsFromElement(e),n=ge.create(e,a);return e._apiComponent=n,e},beforeDestroy(){this.element&&this.element._apiComponent&&(ge.destroy(this.element._apiComponent),delete this.element._apiComponent)}};ComponentManager.define("api",e)}(null==(b=window.Now)?void 0:b.registerManager)&&Now.registerManager("api",ge),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>ge.init()):ge.init(),window.ApiComponent=ge;const fe={state:{elements:new Map,instances:new Map,elementIndex:new WeakMap,containerMap:new WeakMap,initialized:!1,privateStates:new WeakMap},init(e={}){return this.state.initialized||(this.config=Object.assign({},this.config,e),window.ElementFactory&&ElementFactory._privateState&&(this.state.privateStates=ElementFactory._privateState),this.state.initialized=!0),this},registerElement(e,t){if(!e||"string"!=typeof e)throw new Error("Element type must be a string");if(!t)throw new Error("Element implementation must be an object");return t.manager=this,"function"==typeof t.init&&t.init(this),this.state.elements.set(e,t),this},unRegisterElement(e){return this.state.elements.delete(e),this},create(e,t={}){if(!this.state.initialized)throw ErrorManager.handle("ElementManager must be initialized first",{context:"ElementManager.create"});try{const a=this.state.elements.get(e);let n;if(t.elementType=e,a)n=a.create(t);else{if(!window.ElementFactory)throw new Error(`No implementation found for element type: ${e}`);n=ElementFactory.create(t)}return n&&n.element&&n.element.id&&this.state.instances.set(n.element.id,n),n.wasCreated=!0,n}catch(a){return ErrorManager.handle(a,{context:"ElementManager.create",data:{type:e,config:t}}),null}},enhance(e,t={}){try{if(!(e&&e instanceof HTMLElement))throw new Error("Invalid element");try{const t=this.state.elementIndex.get(e);if(t)return t}catch(a){}if(e.id){const t=this.getInstance(e.id);if(t){const a=t.element,s=a===e,r=a&&a.isConnected;if(s&&r)return t;try{this.destroy(e.id)}catch(n){console.warn("Failed to destroy stale element instance for id",e.id,n)}}}const s=e.tagName.toLowerCase();let r=e.getAttribute("data-element")||e.getAttribute("type")||e.type||s;"select"!==s||this.state.elements.has(r)||(r="select"),t.elementType=r;const i=this.state.elements.get(r);if(!i){if(window.ElementFactory){const n=ElementFactory.enhance(e,t);if(n){n.wasCreated=!1;try{this.state.elementIndex.set(e,n)}catch(a){}e.id&&this.state.instances.set(e.id,n)}return n}return ErrorManager.handle(`No implementation found for ${r}`,{context:"ElementManager.enhance",data:{element:e,config:t}}),null}const o=i.enhance(e,t);if(o){try{this.state.elementIndex.set(e,o)}catch(a){}e.id&&this.state.instances.set(e.id,o)}return o.wasCreated=!1,o}catch(s){return ErrorManager.handle(s,{context:"ElementManager.enhance",data:{element:e,config:t}}),null}},getInstance(e){return this.state.instances.get(e)},getInstanceByElement(e){if(!e)return null;const t=this.state.elementIndex.get(e);return t||((null==e?void 0:e.id)?this.state.instances.get(e.id):null)},removeInstance(e){const t=this.state.instances.get(e);if(!t)return!1;window.ElementFactory&&ElementFactory._privateState&&ElementFactory._privateState.delete(t.element);try{this.state.elementIndex.delete(t.element)}catch(a){}return this.state.instances.delete(e)},hasElement(e){return this.state.elements.has(e)},shouldEnhance(e){if(!e)return!1;if(e.dataset&&e.dataset.element)return!0;const t=e.getAttribute("type")||e.type||e.tagName.toLowerCase();return!!this.state.elements.has(t)},scan(e=document){if(!e||!e.querySelectorAll)return[];const t=Array.from(e.querySelectorAll("[data-element], input, select, textarea")),a=[];if(t.forEach(e=>{if(!this.state.elementIndex.has(e)){const t=this.enhance(e);t&&t.element&&t.element.id&&a.push(t.element.id)}}),a.length>0&&e!==document)try{const t=this.state.containerMap.get(e)||[];this.state.containerMap.set(e,[...t,...a])}catch(n){}return t},destroyContainer(e){if(!e)return!1;try{const t=this.state.containerMap.get(e);if(t&&Array.isArray(t))return t.forEach(e=>{try{this.destroy(e)}catch(t){}}),this.state.containerMap.delete(e),!0}catch(t){}return!1},destroyByElement(e){var t;if(!e)return!1;const a=this.getInstanceByElement(e);if(!a)return!1;const n=null==(t=a.element)?void 0:t.id;if(n)return this.destroy(n);for(const[s,r]of this.state.instances.entries())if(r===a)return this.destroy(s);return!1},destroy(e){const t=this.state.instances.get(e);if(!t)return!1;try{const{element:s}=t;if("function"==typeof t.destroy)try{t.destroy()}catch(a){console.warn("Instance destroy threw an error, continuing manager cleanup",a)}try{EventSystemManager.removeElementHandlers(s)}catch(a){console.warn("Failed to remove element handlers during destroy",a)}window.ElementFactory&&ElementFactory._privateState&&ElementFactory._privateState.delete(t.element),["comment","label","container","wrapper"].forEach(e=>{s[e]&&(!1===t.wasCreated?delete s[e]:s[e].parentNode&&s[e].parentNode.removeChild(s[e]))}),!0===t.wasCreated&&s.parentNode&&s.parentNode.removeChild(s);try{this.state.elementIndex.delete(t.element)}catch(n){}return this.state.instances.delete(e),!0}catch(s){return ErrorManager.handle(s,{context:"ElementManager.destroy",data:{id:e}}),!1}},cleanup(){Array.from(this.state.instances.keys()).forEach(e=>{this.destroy(e)}),this.state.elements.clear(),this.state.instances.clear()}};(null==(E=window.Now)?void 0:E.registerManager)&&Now.registerManager("element",fe),window.ElementManager=fe;const ye={config:{minLength:2,delay:300,limit:10,listClass:"autocomplete-list",activeClass:"active",loadingClass:"loading"},create(e,t={}){if(!e)return null;const a={element:e,options:{...this.config,...t},state:{loading:!1,value:e.value}},n=e.getAttribute("list");if(n)return a.datalist=document.getElementById(n),a;const s=document.createElement("ul");return s.className=a.options.listClass,s.style.display="none",e.parentNode.appendChild(s),a.list=s,a.handlers=this.bindEvents(a),a},bindEvents(e){const{element:t,list:a,options:n}=e,s={};return s.input=Utils.function.debounce(async t=>{const a=t.target.value;if(a.length<n.minLength)this.hideSuggestions(e);else{if(e.datalist){const t=this.filterDatalist(e,a);return void this.showSuggestions(e,t)}n.url&&await this.fetchSuggestions(e,a)}},n.delay),s.keydown=t=>{if("none"===a.style.display)return;const s=a.querySelectorAll("li"),r=a.querySelector(`.${n.activeClass}`);let i;switch(t.key){case"ArrowDown":t.preventDefault(),i=r&&r.nextElementSibling||s[0];break;case"ArrowUp":t.preventDefault(),i=r&&r.previousElementSibling||s[s.length-1];break;case"Enter":return t.preventDefault(),void(r&&this.selectItem(e,r));case"Escape":return void this.hideSuggestions(e)}i&&(null==r||r.classList.remove(n.activeClass),i.classList.add(n.activeClass),i.scrollIntoView({block:"nearest"}))},s.blur=()=>{setTimeout(()=>{this.hideSuggestions(e)},200)},EventSystemManager.addHandler(t,"input",s.input),EventSystemManager.addHandler(t,"keydown",s.keydown),EventSystemManager.addHandler(t,"blur",s.blur),s},async fetchSuggestions(e,t){const{element:a,options:n}=e;if(!e.state.loading){e.state.loading=!0,a.classList.add(n.loadingClass);try{const a=await simpleFetch.get(n.url,{params:{q:t,limit:n.limit}});this.showSuggestions(e,a.data)}catch(s){console.error("Autocomplete fetch error:",s),this.hideSuggestions(e)}finally{e.state.loading=!1,a.classList.remove(n.loadingClass)}}},filterDatalist:(e,t)=>Array.from(e.datalist.options).filter(e=>e.value.toLowerCase().includes(t.toLowerCase())).slice(0,e.options.limit).map(e=>({value:e.value,label:e.label||e.value})),showSuggestions(e,t){const{list:a,options:n}=e;a.innerHTML="",Array.isArray(t)&&0!==t.length?(t.forEach(t=>{const s=document.createElement("li");s.dataset.value="object"==typeof t?t.value:t,s.textContent="object"==typeof t?t.label||t.value:t,s.addEventListener("click",()=>{this.selectItem(e,s)}),s.addEventListener("mouseenter",()=>{var e;null==(e=a.querySelector(`.${n.activeClass}`))||e.classList.remove(n.activeClass),s.classList.add(n.activeClass)}),a.appendChild(s)}),a.style.display="block"):this.hideSuggestions(e)},hideSuggestions(e){e.list&&(e.list.style.display="none",e.list.innerHTML="")},selectItem(e,t){const{element:a}=e;a.value=t.dataset.value,this.hideSuggestions(e),a.focus(),a.dispatchEvent(new Event("change",{bubbles:!0}))},destroy(e){if(!e)return;const{element:t,handlers:a,list:n}=e;a&&Object.entries(a).forEach(([e,t])=>{EventSystemManager.removeHandler(t)}),n&&n.parentNode&&n.parentNode.removeChild(n)}};ElementManager.plugins=ElementManager.plugins||{},ElementManager.plugins.autocomplete=ye;let ve=(__publicField(S=class{static configure(e={}){this.config={...this.config,...e}}static getFormConfig(e){const t=FormManager.getInstanceByElement(e);return t?{...this.config,...t.config}:this.config}static showSuccess(e,t=null,a={}){let n=this.config,s=null;if(t instanceof HTMLElement?(n=this.getFormConfig(t),s=n.successContainer?document.getElementById(n.successContainer):t.querySelector("[data-success-container], .form-message, .success-message, .login-message")):"string"==typeof t&&(s=document.getElementById(t)),s||(s=document.getElementById(n.defaultSuccessContainer)),!s)return;const r=s.id||Utils.generateUUID();s.id=r,this.state.originalGeneralMessages.get(r)||this.state.originalGeneralMessages.set(r,{html:s.innerHTML||"",className:s.className||""}),s.textContent=Now.translate(e),s.classList.add("success"),n.autoClearErrors&&n.autoClearErrorsDelay>0&&setTimeout(()=>{this.clearGeneralError(r)},n.autoClearErrorsDelay),EventManager.emit("form:generalSuccess",{message:e,containerId:r,config:n})}static showGeneralError(e,t=null,a={}){let n=this.config,s=null;if(t instanceof HTMLElement?(n=this.getFormConfig(t),s=n.errorContainer?document.getElementById(n.errorContainer):t.querySelector("[data-error-container], .form-message, .error-message, .login-message")):"string"==typeof t&&(s=document.getElementById(t)),s||(s=document.getElementById(n.defaultErrorContainer)),!s)return;const r=s.id||Utils.generateUUID();s.id=r,this.state.originalGeneralMessages.get(r)||this.state.originalGeneralMessages.set(r,{html:s.innerHTML||"",className:s.className||""});const i=n.errorMessageClass||"error";s.classList.add(i),s.textContent=Now.translate(e),n.autoClearErrors&&n.autoClearErrorsDelay>0&&setTimeout(()=>{this.clearGeneralError(r)},n.autoClearErrorsDelay),EventManager.emit("form:generalError",{message:e,containerId:r,config:n})}static showFieldError(e,t,a=null,n={}){var s,r;const i=document.getElementById(e)||document.querySelector(`[name="${e}"]`);if(!i)return;let o=this.config;a instanceof HTMLElement&&(o=this.getFormConfig(a));const l=Array.isArray(t)?t:[t];if(0===l.length)return;const c=i.dataset.result||`result_${e}`;if(!this.state.errors.has(e)){const t=document.getElementById(c);if(t&&!this.state.originalMessages.has(e)){const a=t.hasAttribute("data-i18n"),n=null==(s=t.dataset)?void 0:s.i18n;let r=null;a&&(r=n&&""!==n.trim()?n:t.textContent),this.state.originalMessages.set(e,{text:t.textContent,i18nKey:r,hasI18nAttr:a})}}this.state.errors.set(e,{element:i,messages:l});const d=o.errorClass||"invalid";i.classList.add(d),null==(r=i.container)||r.classList.add(d),i.wrapper&&i.wrapper!==i.container&&i.wrapper.classList.add(d);try{let e=null;i.parentElement&&i.parentElement.classList&&i.parentElement.classList.contains("form-control")?e=i.parentElement:i.closest&&(e=i.closest(".form-control")),e&&e!==i.container&&e!==i.wrapper&&e.classList.add(d)}catch(h){}const u=document.getElementById(c);u&&(u.textContent=Now.translate(l[0]),u.classList.add(o.errorMessageClass||"error"),i.setAttribute("aria-errormessage",u.id)),i.setAttribute("aria-invalid","true"),EventManager.emit("form:error",{field:e,messages:l,element:i,config:o})}static clearFieldError(e){var t,a,n;const s="string"==typeof e?document.getElementById(e)||document.querySelector(`[name="${e}"]`):e;if(!s)return;const r=s.id||s.name,i=this.config.errorClass;s.classList.remove(i),null==(t=s.container)||t.classList.remove(i),s.wrapper&&s.wrapper!==s.container&&(null==(a=s.wrapper.classList)||a.remove(i));try{let e=null;s.parentElement&&s.parentElement.classList&&s.parentElement.classList.contains("form-control")?e=s.parentElement:s.closest&&(e=s.closest(".form-control")),e&&e!==s.container&&e!==s.wrapper&&e.classList.remove(i)}catch(c){}const o=(null==(n=s.dataset)?void 0:n.result)||`result_${r}`,l=document.getElementById(o);if(l&&(l.classList.remove(this.config.errorMessageClass),this.state.errors.has(r)&&this.state.originalMessages.has(r))){const e=this.state.originalMessages.get(r);e.hasI18nAttr&&e.i18nKey?(e.i18nKey!==e.text?l.dataset.i18n=e.i18nKey:l.dataset.i18n="",l.textContent=Now.translate(e.i18nKey)):e.hasI18nAttr?(l.dataset.i18n="",l.textContent=e.text||""):(delete l.dataset.i18n,l.textContent=e.text||""),this.state.originalMessages.delete(r)}s.removeAttribute("aria-invalid"),s.removeAttribute("aria-errormessage"),this.state.errors.has(r)&&this.state.errors.delete(r),this.state.lastFocusedElement===s&&(this.state.lastFocusedElement=null),EventManager.emit("form:clearError",{field:r,element:s})}static clearGeneralError(e=null){let t=null,a=this.config;if("string"==typeof e?t=document.getElementById(e):e instanceof HTMLElement?"FORM"===e.tagName?(a=this.getFormConfig(e),a.errorContainer&&(t=document.getElementById(a.errorContainer))):t=document.getElementById(e.id):t=document.getElementById(a.defaultErrorContainer),!t){const e=document.querySelectorAll("[data-error-container], .form-message, .error-message, .login-message");e.length>0&&(t=e[0])}if(!t)return!1;const n=t.id||Utils.generateUUID();t.id=n;const s=this.state.originalGeneralMessages.get(n);return s?(t.innerHTML=s.html||"",t.className=s.className||""):this.state.originalGeneralMessages.set(n,{html:t.innerHTML||"",className:t.className||""}),t.classList.remove("show","visible","active"),EventManager.emit("form:clearGeneralError",{containerId:n,config:a}),!0}static clearSuccess(e=null){let t=null,a=this.config;if("string"==typeof e?t=document.getElementById(e):e instanceof HTMLElement?"FORM"===e.tagName?(a=this.getFormConfig(e),a.successContainer&&(t=document.getElementById(a.successContainer))):t=document.getElementById(e.id):t=document.getElementById(a.defaultSuccessContainer),!t){const e=document.querySelectorAll("[data-success-container], .form-message, .success-message, .login-message");e.length>0&&(t=e[0])}if(!t)return!1;const n=t.id||Utils.generateUUID();t.id=n;const s=this.state.originalGeneralMessages.get(n);return s?(t.innerHTML=s.html||"",t.className=s.className||""):this.state.originalGeneralMessages.set(n,{html:t.innerHTML||"",className:t.className||""}),t.classList.remove("show","visible","active"),EventManager.emit("form:clearSuccess",{containerId:n,config:a}),!0}static clearAll(e=null){if(this.state.errors.forEach((e,t)=>{this.clearFieldError(t)}),this.state.lastFocusedElement=null,e instanceof HTMLElement)this.clearGeneralError(e),this.clearSuccess(e);else{this.clearGeneralError(),this.clearSuccess();document.querySelectorAll("[data-error-container], [data-success-container], .form-message, .error-message, .success-message, .login-message").forEach(e=>{e.classList.remove("show","visible","active")})}EventManager.emit("form:clearAllErrors",{form:e})}static clearFormMessages(e){let t=e;if("string"==typeof e&&(t=document.getElementById(e)||document.querySelector(`[data-form="${e}"]`)),!t||"FORM"!==t.tagName)return console.warn("FormError.clearFormMessages: Invalid form element"),!1;return t.querySelectorAll("[name], [id]").forEach(e=>{const t=e.name||e.id;t&&this.state.errors.has(t)&&this.clearFieldError(t)}),this.clearGeneralError(t),this.clearSuccess(t),!0}static showErrors(e,t={}){this.clearAll(),Object.entries(e).forEach(([e,a],n)=>{this.showFieldError(e,a,{focus:0===n,scroll:0===n,...t})}),EventManager.emit("form:errors",{errors:e})}static scrollToElement(e){const t=e.getBoundingClientRect(),a=window.innerHeight||document.documentElement.clientHeight,n=.3*t.height;t.top+n>=0&&t.top<a||t.bottom>0&&t.bottom-n<=a||e.scrollIntoView({behavior:"smooth",block:"nearest"})}static hasErrors(){return this.state.errors.size>0}static getErrors(){return Array.from(this.state.errors.entries()).map(([e,t])=>({field:e,...t}))}static getErrorsCount(){return this.state.errors.size}static reset(){this.clearAll(),this.state={errors:new Map,lastFocusedElement:null,originalMessages:new Map,originalGeneralMessages:new Map}}},"config",{errorClass:"invalid",errorMessageClass:"error",autoFocus:!0,autoScroll:!0,scrollOffset:100,debug:!1,showErrorsInline:!0,showErrorsInNotification:!1,autoClearErrors:!0,autoClearErrorsDelay:5e3,defaultErrorContainer:"form-message",defaultSuccessContainer:"form-message"}),__publicField(S,"state",{errors:new Map,lastFocusedElement:null,originalMessages:new Map,originalGeneralMessages:new Map}),S);window.FormError=ve;const we={config:{ajaxSubmit:!0,autoValidate:!0,resetAfterSubmit:!1,autoEnhance:!0,autoInitialize:!0,autoGenerateFormId:!0,submitButtonSelector:'[type="submit"]',resetButtonSelector:'[type="reset"]',fieldSelector:"input, select, textarea, [data-element]",preventDoubleSubmit:!0,doubleSubmitTimeout:2e3,showLoadingOnSubmit:!0,autoClearErrors:!0,autoClearErrorsDelay:5e3,validateOnInput:!0,validateOnBlur:!0,validateOnlyDirty:!0,validatorRegistry:new Map,formatterRegistry:new Map,loadingClass:"submitting",validClass:"valid",invalidClass:"invalid",dirtyClass:"modified",successMessage:"Form submitted successfully",errorMessage:"There was an error submitting the form",actionAttribute:"data-action",methodAttribute:"data-method",redirectAttribute:"data-redirect",showErrorsInline:!0,showErrorsInNotification:!0,uploadProgressTemplate:'\n      <div class="upload-progress" style="display:none">\n        <div class="progress">\n          <div class="progress-bar" role="progressbar" style="width:0%"></div>\n        </div>\n        <div class="progress-text"></div>\n      </div>\n    '},observerConfig:{observerDelay:40,observeRoot:null,autoStartObserver:!0},state:{forms:new Map,elementIndex:new WeakMap,initialized:!1,activeSubmit:null,validators:new Map},async init(e={}){return this.state.initialized||(this.config={...this.config,...e},e.observerConfig&&(this.observerConfig={...this.observerConfig,...e.observerConfig}),window.SecurityManager&&window.SecurityManager.state.initialized&&this.setupSecurityIntegration(),this.observerConfig.autoStartObserver&&this.setupFormObserver(),this.config.autoInitialize&&document.querySelectorAll("form[data-form]").forEach(e=>{this.shouldEnhance(e)&&this.initForm(e)}),this.registerStandardValidators(),this.state.initialized=!0),this},registerStandardValidators(){this.registerValidator("required",(e,t)=>"checkbox"===t.type||"radio"===t.type?t.checked:null!=e&&""!==e.toString().trim(),"Please fill in"),this.registerValidator("email",e=>!e||/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),"Please enter a valid email address"),this.registerValidator("url",e=>!e||/^(https?|ftp):\/\/[^\s\/$.?#].[^\s]*$/.test(e),"Please enter a valid URL"),this.registerValidator("number",e=>!e||/^-?\d*\.?\d+$/.test(e),"Please enter a valid number"),this.registerValidator("integer",e=>!e||/^-?\d+$/.test(e),"Please enter a whole number"),this.registerValidator("min",(e,t,a)=>!e||parseFloat(e)>=parseFloat(a),"Value must be at least {min}"),this.registerValidator("max",(e,t,a)=>!e||parseFloat(e)<=parseFloat(a),"Value must be no more than {max}"),this.registerValidator("minlength",(e,t,a)=>!e||e.length>=parseInt(a),"Please enter at least {minlength} characters"),this.registerValidator("maxlength",(e,t,a)=>{const n=parseInt(a);return!e||isNaN(n)||n<=0||e.length<=n},"Please enter no more than {maxlength} characters"),this.registerValidator("pattern",(e,t,a)=>!e||new RegExp(a).test(e),"Please match the requested format"),this.registerValidator("match",(e,t,a)=>{const n=document.getElementById(a)||document.getElementsByName(a)[0]||t.form.querySelector(`[name="${a}"]`);return!e||!n||e===n.value},"Fields do not match")},registerValidator(e,t,a){this.state.validators.set(e,{validate:t,message:a})},registerFormatter(e,t){this.config.formatterRegistry.set(e,t)},async initForm(e){var t;if(!e)return null;if(!e.dataset||!e.dataset.form)return null;const a=e.dataset.form;try{const t=this.state.elementIndex.get(e);if(t)return t;const s=this.state.forms.get(a);if(s)if(s.element&&!s.element.isConnected)try{this.destroyForm(s)}catch(n){}else{if(s.element===e)return s;if(s.element&&s.element.isConnected)try{this.destroyForm(s)}catch(n){}}}catch(n){}try{const s={id:a,element:e,elements:new Map,state:{modified:!1,valid:!0,submitting:!1,data:{},originalData:{},errors:{},submitCount:0,lastSubmitTime:0},resetTimeout:null};this.state.forms.set(a,s);try{this.state.elementIndex.set(e,s)}catch(n){}const r=this.extractFormConfig(e);s.config={...this.config,...r},"true"===e.dataset.autoFillIntendedUrl&&this.autoFillIntendedUrl(e);try{this.restorePersistedValues&&this.restorePersistedValues(s)}catch(n){}e.querySelector('input[type="file"]')&&(e.enctype="multipart/form-data");try{this.populateSelectsFromModalOptions(s)}catch(n){console.warn("FormManager: Failed to populate select options from modal:",n)}try{await this.loadFormOptionsIfNeeded(s)}catch(n){console.warn("FormManager: Failed to load form options:",n)}await this.loadFormDataIfNeeded(s),this.initFormElements(s),(null==(t=window.CascadingSelectManager)?void 0:t.initInContainer)&&CascadingSelectManager.initInContainer(e);try{this.restoreRememberedCredentials&&this.restoreRememberedCredentials(s)}catch(n){}try{this.populateFromUrlParams(s)}catch(n){console.warn("FormManager: Failed to populate from URL params:",n)}return this.setupFormEvents(s),s.state.originalData=this.getFormData(s,!0),EventManager.emit("form:init",{formId:a,instance:s}),s}catch(s){return ErrorManager.handle(s,{context:"FormManager.initForm",type:"error:form",data:{formId:a}}),null}},async loadFormDataIfNeeded(e){var t,a,n,s,r,i,o;const{element:l}=e,c=l.dataset.loadApi;if(c)try{let r,i=c,o={};if("true"===l.dataset.loadQueryParams){const e=new URLSearchParams(window.location.search),t=Object.fromEntries(e);Object.keys(t).length>0&&(o=t)}if(null==(t=window.ApiService)?void 0:t.get)r=await window.ApiService.get(i,o);else{if(!(null==(a=window.simpleFetch)?void 0:a.get))return void console.warn("FormManager: ApiService or simpleFetch not available");{const e=new URLSearchParams(o).toString(),t=e?`${i}?${e}`:i;r=await window.simpleFetch.get(t)}}if(403===r.status)return console.warn("FormManager: Access forbidden (403) for form data API"),(null==(n=window.RouterManager)?void 0:n.navigate)?void window.RouterManager.navigate("/403"):(null==(s=window.LocationManager)?void 0:s.redirect)?void window.LocationManager.redirect("/403"):void(window.location.href="/403");if(401===r.status){console.warn("FormManager: Unauthorized (401) for form data API");const e=new Error(r.statusText||"Unauthorized");return e.status=401,e.response=r,void(await AuthErrorHandler.handleError(e,{currentPath:window.location.pathname}))}const u=r.data.data||r.data;if(e.state.formOptions=u.options||null,u&&u.actions&&Array.isArray(u.actions))try{return await ResponseHandler.process(u,{formId:e.id,form:l,instance:e,source:"form-load-api"}),r}catch(d){console.error("FormManager: Error processing load-api response actions",d)}if(e.state.formOptions&&(SelectElementFactory.populateFromOptionsInContainer(l,e.state.formOptions),MultiSelectElementFactory.populateFromOptionsInContainer(l,e.state.formOptions),TagsElementFactory.populateFromOptionsInContainer(l,e.state.formOptions)),e.state.formOptions&&u){l.querySelectorAll('input[type="text"][data-element="tags"][data-attr]').forEach(t=>{var a;const n=t.getAttribute("data-attr"),s=null==n?void 0:n.match(/value:([\w-]+)/);if(s&&s[1]){const n=s[1],r=u[n];if(null!=r&&Array.isArray(r)){const n=t.getAttribute("data-options-key"),s=e.state.formOptions[n],i=null==(a=window.ElementManager)?void 0:a.getInstanceByElement(t);if(i&&"function"==typeof i.setValue&&s&&Array.isArray(s)){const e=r.map(e=>{const t=s.find(t=>("object"==typeof t?t.value:t)==e);return t?"object"==typeof t?{key:t.value,value:t.text}:{key:t,value:t}:{key:e,value:e}});i.setValue(e)}}}})}return r.data&&this.setFormData(e,u),e.state.formOptions&&TextElementFactory.populateFromOptionsInContainer(l,e.state.formOptions),r}catch(d){if(403===d.status||403===(null==(r=d.response)?void 0:r.status))return console.warn("FormManager: Access forbidden (403) for form data API"),(null==(i=window.RouterManager)?void 0:i.navigate)?void window.RouterManager.navigate("/403"):(null==(o=window.LocationManager)?void 0:o.redirect)?void window.LocationManager.redirect("/403"):void(window.location.href="/403");if(401===response.status){console.warn("FormManager: Unauthorized (401) for form data API");const e=new Error(response.statusText||"Unauthorized");return e.status=401,e.response=response,void(await AuthErrorHandler.handleError(e,{currentPath:window.location.pathname}))}throw console.error("FormManager: Error loading form data:",d),d}},async loadFormOptionsIfNeeded(e){var t,a,n,s,r;const{element:i}=e,o=i.dataset.loadOptionsApi;if(o)try{if(window.SecurityManager){const e=5e3,n=Date.now();for(;!(null==(t=window.SecurityManager.state)?void 0:t.csrfToken)&&Date.now()-n<e;){if(!1!==(null==(a=window.SecurityManager.state)?void 0:a.initialized)){if("function"==typeof window.SecurityManager.refreshCSRFToken)try{await window.SecurityManager.refreshCSRFToken()}catch(l){console.warn("FormManager: Failed to refresh CSRF token",l)}break}await new Promise(e=>setTimeout(e,50))}}let c;if(null==(n=window.ApiService)?void 0:n.get)c=await window.ApiService.get(o);else{if(!(null==(s=window.simpleFetch)?void 0:s.get))return;c=await window.simpleFetch.get(o)}const d=c.data||c,u=(null==(r=null==d?void 0:d.data)?void 0:r.options)||null;return u?(e.state.formOptions=u,this.setFormOptions(i,e.state.formOptions),c):void console.warn("FormManager: Invalid options format. Expected {data: {data: {...}, options: {...}}}")}catch(c){throw console.error("FormManager: Error loading form options:",c),c}},populateSelectsFromModalOptions(e){const{element:t}=e,a=window._currentModalOptions||t.dataset.modalOptions,n=window._currentModalData||{};if(!a)return;const s="string"==typeof a?JSON.parse(a):a;if(s&&"object"==typeof s&&(this.setFormOptions(t,s),n&&"object"==typeof n)){t.querySelectorAll("select[data-options-key][data-attr]").forEach(e=>{const t=e.getAttribute("data-attr"),a=null==t?void 0:t.match(/value:([\w-]+)/);if(a&&a[1]){const t=a[1];let s=n[t];if(null!=s)if(e.multiple){const t=(Array.isArray(s)?s:[s]).map(e=>String(e));Array.from(e.options).forEach(e=>{e.selected=t.includes(e.value)})}else e.value=s}});t.querySelectorAll('input[type="text"][data-options-key][data-attr]').forEach(e=>{var a;const r=e.getAttribute("data-attr"),i=null==r?void 0:r.match(/value:([\w-]+)/);if(i&&i[1]){const r=i[1],o=n[r];if(null!=o){if("tags"===e.getAttribute("data-element")){if(Array.isArray(o)){const t=e.getAttribute("data-options-key"),n=s[t],r=null==(a=window.ElementManager)?void 0:a.getInstanceByElement(e);if(r&&"function"==typeof r.setValue&&n&&Array.isArray(n)){const e=o.map(e=>{const t=n.find(t=>("object"==typeof t?t.value:t)==e);return t?"object"==typeof t?{key:t.value,value:t.text}:{key:t,value:t}:{key:e,value:e}});r.setValue(e)}}}else{const a=e.getAttribute("data-options-key"),n=s[a];if(n&&Array.isArray(n)){const a=n.find(e=>("object"==typeof e?e.value:e)==o);if(a){e.value="object"==typeof a?a.text:a;const n=t.querySelector(`input[type="hidden"][name="${e.name}"]`);n&&(n.value=o)}}}}}})}},setFormOptions(e,t){SelectElementFactory.populateFromOptionsInContainer(e,t),MultiSelectElementFactory.populateFromOptionsInContainer(e,t),TextElementFactory.populateFromOptionsInContainer(e,t)},populateFromUrlParams(e){const{element:t}=e;if("true"!==t.dataset.loadUrlParams)return;const a=new URLSearchParams(window.location.search),n=window.location.hash,s=n.indexOf("?");if(-1!==s){const e=new URLSearchParams(n.substring(s));for(const[t,n]of e.entries())a.set(t,n)}const r=Object.fromEntries(a.entries());if(0===Object.keys(r).length){if("true"===t.dataset.urlParamsRequired){const e=Now.translate("Invalid or missing URL parameters");window.NotificationManager&&NotificationManager.error(e);const a=t.querySelector('[type="submit"]');a&&(a.disabled=!0)}return}this.setFormData(e,r),console.debug("FormManager: Populated form from URL params:",Object.keys(r));const i=t.dataset.urlParamsRequiredFields;if(i){const a=i.split(",").map(e=>e.trim()).filter(e=>!r[e]);if(a.length>0&&(this.emitEvent("form:urlParamsMissing",{formId:e.id,missingParams:a}),"true"===t.dataset.urlParamsRequired)){const e=Now.translate("Invalid or missing URL parameters");window.NotificationManager&&NotificationManager.error(e);const a=t.querySelector('[type="submit"]');a&&(a.disabled=!0)}}},setupSecurityIntegration(){document.addEventListener("security:error",e=>{this.handleSecurityError(e.detail)}),document.addEventListener("csrf:refreshed",e=>{this.updateFormsWithNewCSRF(e.detail.token)})},handleSecurityError(e){var t,a,n,s;try{const i=e||{},o=i.message||i.error||"A security error occurred",l=(null==(t=window.Now)?void 0:t.getManager)?Now.getManager("auth"):window.AuthManager;if(l&&"function"==typeof l.handleError)try{l.handleError("Security error",new Error(o),{detail:i})}catch(r){console.warn("FormManager: AuthManager.handleError threw an error",r)}else if(window.ErrorManager&&"function"==typeof ErrorManager.handle)try{ErrorManager.handle(new Error(o),{context:"FormManager.handleSecurityError",data:i})}catch(r){console.warn("FormManager: ErrorManager.handle threw an error",r)}else window.NotificationManager?NotificationManager.error(o):console.warn("FormManager security error:",o,i);if(401===i.status||"unauthorized"===i.code||"csrf_invalid"===i.code){try{localStorage.removeItem("auth_token")}catch(r){}try{localStorage.removeItem((null==(a=this.config.token)?void 0:a.storageKey)||"auth_user")}catch(r){}l&&"function"==typeof l.redirectTo&&l.redirectTo((null==(s=null==(n=l.config)?void 0:n.redirects)?void 0:s.unauthorized)||"/login")}}catch(i){try{console.error("Error in FormManager.handleSecurityError",i)}catch(o){}}},handleRateLimitError(e,t){const a=Now.translate("Too many requests. Please try again in {retryAfter} seconds.",{retryAfter:t.retryAfter});FormError.showGeneralError(a,e.element),this.emitEvent("form:rateLimit",{formId:e.id,rateLimitResult:t})},updateFormsWithNewCSRF(e){this.state.forms.forEach(t=>{const a=t.element.querySelector('input[name="_token"]');a&&(a.value=e)})},extractFormConfig(e){const t={},a=e.dataset;return void 0!==a.csrf&&(t.csrf="true"===a.csrf),void 0!==a.rateLimit&&(t.rateLimit="true"===a.rateLimit),void 0!==a.validation&&(t.validation="true"===a.validation),a.rateLimitEndpoint&&(t.rateLimitEndpoint=a.rateLimitEndpoint),a.rateLimitLimit&&(t.rateLimitLimit=parseInt(a.rateLimitLimit)),a.rateLimitWindow&&(t.rateLimitWindow=1e3*parseInt(a.rateLimitWindow)),a.csrfToken&&(t.csrfToken=a.csrfToken),a.csrfHeader&&(t.csrfHeader=a.csrfHeader),void 0!==a.validateOnSubmit&&(t.validateOnSubmit="true"===a.validateOnSubmit),void 0!==a.sanitizeInput&&(t.sanitizeInput="true"===a.sanitizeInput),["ajaxSubmit","autoValidate","resetAfterSubmit","preventDoubleSubmit","showLoadingOnSubmit","showErrorsInline","showErrorsInNotification"].forEach(e=>{void 0!==a[e]&&(t[e]="true"===a[e])}),void 0!==a.validate&&(t.autoValidate="true"===a.validate),a.errorContainer&&(t.errorContainer=a.errorContainer),void 0!==a.showErrorsInline&&(t.showErrorsInline="true"===a.showErrorsInline),void 0!==a.showErrorsInNotification&&(t.showErrorsInNotification="true"===a.showErrorsInNotification),a.errorClass&&(t.errorClass=a.errorClass),a.errorMessageClass&&(t.errorMessageClass=a.errorMessageClass),void 0!==a.autoClearErrors&&(t.autoClearErrors="true"===a.autoClearErrors),a.autoClearErrorsDelay&&(t.autoClearErrorsDelay=parseInt(a.autoClearErrorsDelay)),void 0!==a.autoFocusError&&(t.autoFocusError="true"===a.autoFocusError),void 0!==a.autoScrollToError&&(t.autoScrollToError="true"===a.autoScrollToError),a.successContainer&&(t.successContainer=a.successContainer),void 0!==a.showSuccessInline&&(t.showSuccessInline="true"===a.showSuccessInline),void 0!==a.showSuccessInNotification&&(t.showSuccessInNotification="true"===a.showSuccessInNotification),a.successRedirect&&(t.successRedirect=a.successRedirect),a.successMessage&&(t.successMessage=a.successMessage),a.loadingText&&(t.loadingText=a.loadingText),t},initFormElements(e){const{element:t,elements:a}=e;return t.querySelectorAll(this.config.fieldSelector).forEach(t=>{if(!t.name&&!t.id)return void console.warn("FormManager: Field without name or id found:",t);const n=t.name||t.id,s=this.getFieldType(t);if("radio"===s)return a.has(n)||a.set(n,[]),a.get(n).push(t),void(t.checked&&(e.state.data[n]=t.value));if("checkbox"===s&&!n.endsWith("[]"))return a.set(n,t),void(e.state.data[n]=t.checked);if("checkbox"===s&&n.endsWith("[]")){const s=n.slice(0,-2);return a.has(s)||(a.set(s,[]),e.state.data[s]=[]),a.get(s).push(t),void(t.checked&&e.state.data[s].push(t.value))}if(a.set(n,t),"file"===s)e.state.data[n]=null;else if("select-multiple"===s||"select"===t.tagName.toLowerCase()){const s=n.endsWith("[]")?n.slice(0,-2):n;if(s!==n&&a.set(s,t),t.multiple){const a=t.querySelectorAll("option[selected]");a.length>0?e.state.data[s]=Array.from(a).map(e=>e.value):t.selectedOptions.length>0?e.state.data[s]=Array.from(t.selectedOptions).map(e=>e.value):e.state.data[s]=[]}else{const a=t.querySelector("option[selected]");a?e.state.data[s]=a.value:t.value&&t.options.length>0?e.state.data[s]=t.value:e.state.data[s]=""}}else e.state.data[n]=t.value;e.config.autoEnhance&&window.ElementManager&&window.ElementManager.enhance(t)}),a},getFieldType:e=>e.dataset.element?e.dataset.element:"input"===e.tagName.toLowerCase()?e.type||"text":e.tagName.toLowerCase(),setupFormEvents(e){const{element:t}=e;t.addEventListener("submit",async a=>{var n,s;a.preventDefault(),a.stopPropagation(),FormError.clearFormMessages(t),e.state.errors={};const r=t.getAttribute("data-confirm");if(r){if(!(await DialogManager.confirm(Now.translate(r))))return}if(window.SecurityManager&&!1!==e.config.rateLimit){const a=e.config.rateLimitEndpoint||t.action||window.location.pathname,n=SecurityManager.checkRateLimit(a);if(!n.allowed)return this.handleRateLimitError(e,n),!1}if(e.config.preventDoubleSubmit){const t=Date.now();if(e.state.submitting||t-e.state.lastSubmitTime<e.config.doubleSubmitTimeout)return console.warn("FormManager: Double submit prevented"),!1;e.state.lastSubmitTime=t}try{e.state.submitting=!0,e.state.submitCount++,e.config.showLoadingOnSubmit&&t.classList.add(e.config.loadingClass);const a=t.querySelector(e.config.submitButtonSelector);if(a&&(a.disabled=!0,this.state.activeSubmit=a,a.textContent.trim()&&(a._originalText=a.textContent,a.textContent=e.config.loadingText||"Operating")),this.emitEvent("form:submitting",{formId:e.id,form:e}),e.config.autoValidate){if(!(await this.validateForm(e)))return this.handleInvalidSubmit(e),!1}const r=this.getFormData(e);if(!1!==e.config.csrf&&r.jsonData&&!r.jsonData._token){const e="localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname||window.location.hostname.includes("dev")||window.location.hostname.includes("local");e||console.warn("CSRF token is missing from form data");const t=(null==(n=document.querySelector('meta[name="csrf-token"]'))?void 0:n.getAttribute("content"))||(null==(s=document.cookie.split(";").find(e=>e.trim().startsWith("XSRF-TOKEN=")))?void 0:s.split("=")[1]);t?(r.jsonData._token=t,r.formData&&r.formData.append("_token",t)):e||console.warn("No CSRF token found in meta tag or cookies")}if(!r.jsonData||0===Object.keys(r.jsonData).length)throw new Error("No form data to submit");let o;e.config.ajaxSubmit?o=await this.submitAjax(e,r):(t.submit(),o={success:!0});if(o&&!0===o.success){this.handleSuccessfulSubmit(e,o);try{this.savePersistedValues&&this.savePersistedValues(e)}catch(i){}}else this.handleFailedSubmit(e,o);return o}catch(o){return this.handleSubmitError(e,o),!1}finally{const a=t.querySelector(e.config.submitButtonSelector);a&&(a.disabled=!1,a._originalText&&(a.textContent=a._originalText,delete a._originalText)),t.classList.remove(e.config.loadingClass),clearTimeout(e.resetTimeout),e.resetTimeout=setTimeout(()=>{e.state.submitting=!1,this.state.activeSubmit=null},100)}}),t.addEventListener("reset",t=>{this.resetForm(e)}),t.addEventListener("change",async a=>{const n=a.target,s=n.name;if(s){switch(n.type){case"checkbox":if(s.endsWith("[]")){const a=s.slice(0,-2);e.state.data[a]=this.getCheckboxGroupValues(t,s)}else e.state.data[s]=n.checked;break;case"radio":n.checked&&(e.state.data[s]=n.value);break;case"file":e.state.data[s]=n.files.length>0||null;break;default:e.state.data[s]=n.value}e.state.modified=!0,n.classList.add(e.config.dirtyClass),this.emitEvent("form:field:change",{formId:e.id,field:n,name:s,value:e.state.data[s]}),n.dataset.cascadeSource&&await this.handleCascade(e,n)}}),e.config.validateOnInput&&t.addEventListener("input",Utils.function.debounce(t=>{const a=t.target;a.name&&this.validateField(e,a)},300)),e.config.validateOnBlur&&t.addEventListener("blur",t=>{const a=t.target;a.name&&this.validateField(e,a)},!0)},async validateField(e,t,a=!1){const n=t.name;if(!n)return!0;if(!a&&e.config.validateOnlyDirty&&!t.classList.contains(e.config.dirtyClass))return!0;FormError.clearFieldError(n),delete e.state.errors[n];let s=null;try{const e=window.ElementManager;if(e&&"function"==typeof e.getInstanceByElement&&(s=e.getInstanceByElement(t)||null),!s&&t.id&&e&&"function"==typeof e.getInstance&&(s=e.getInstance(t.id)||null,s&&s.element&&s.element!==t&&!s.element.isConnected)){try{e.destroy(t.id)}catch(i){}s=null}}catch(i){s=null}if(s&&"function"==typeof s.validate)try{return s.validate(t.value,!0),s.isValid()}catch(o){return FormError.showFieldError(n,o.message||"Validation error",e.element),e.state.errors[n]=o.message||"Validation error",!1}const r=this.getFieldValue(t);if(t.required&&(null==r||""===r)){const a=Now.translate(t.dataset.errorRequired||"Please fill in");return FormError.showFieldError(n,a,e.element),e.state.errors[n]=a,!1}if(null===r||""===r||void 0===r)return!0;if(t.pattern){if(!new RegExp(t.pattern).test(r)){const a=Now.translate(t.dataset.errorPattern||"Please enter a valid format");return FormError.showFieldError(n,a,e.element),e.state.errors[n]=a,!1}}if("number"===t.type||"range"===t.type){const a=parseFloat(r);if(!isNaN(a)){if(void 0!==t.min&&""!==t.min&&a<parseFloat(t.min)){const a=Now.translate(t.dataset.errorMin||"Value must be at least {min}",{min:t.min});return FormError.showFieldError(n,a,e.element),e.state.errors[n]=a,!1}if(void 0!==t.max&&""!==t.max&&a>parseFloat(t.max)){const a=Now.translate(t.dataset.errorMax||"Value must be no more than {max}",{max:t.max});return FormError.showFieldError(n,a,e.element),e.state.errors[n]=a,!1}}}if("string"==typeof r){if(t.minLength&&r.length<parseInt(t.minLength)){const a=Now.translate(t.dataset.errorMinlength||"Please enter at least {minlength} characters",{minlength:t.minLength});return FormError.showFieldError(n,a,e.element),e.state.errors[n]=a,!1}if(t.maxLength&&t.maxLength>0&&r.length>parseInt(t.maxLength)){const a=Now.translate(t.dataset.errorMaxlength||"Please enter no more than {maxlength} characters",{maxlength:t.maxLength});return FormError.showFieldError(n,a,e.element),e.state.errors[n]=a,!1}}for(const[l,c]of this.state.validators)if(void 0!==t.dataset[`validate${l.charAt(0).toUpperCase()+l.slice(1)}`]){const a=t.dataset[`validate${l.charAt(0).toUpperCase()+l.slice(1)}`]||"";if(!c.validate(r,t,a)){let s=t.dataset[`error${l.charAt(0).toUpperCase()+l.slice(1)}`]||c.message;if(a&&""!==a.trim())if("maxlength"===l||"minlength"===l){const e=parseInt(a);!isNaN(e)&&e>0&&(s=s.replace("{0}",a))}else s=s.replace("{0}",a);return FormError.showFieldError(n,s,e.element),e.state.errors[n]=s,!1}}if(t.dataset.validateFn&&window[t.dataset.validateFn]){const a=window[t.dataset.validateFn];try{const s=await a(r,t,e);if(!0!==s){const t="string"==typeof s?s:"Validation failed";return FormError.showFieldError(n,t,e.element),e.state.errors[n]=t,!1}}catch(o){return FormError.showFieldError(n,o.message||"Validation error",e.element),e.state.errors[n]=o.message||"Validation error",!1}}return t.classList.add(e.config.validClass),t.classList.remove(e.config.invalidClass),!0},async validateForm(e){FormError.clearAll(),e.state.errors={};let t=!0;const a=[],n=[];for(const[s,r]of e.elements)Array.isArray(r)?r.length>0&&n.push(this.validateField(e,r[0],!0).then(e=>{e||(t=!1,a.push(r[0]))})):n.push(this.validateField(e,r,!0).then(e=>{e||(t=!1,a.push(r))}));return await Promise.all(n),e.state.valid=t,!t&&a.length>0&&(a[0].focus(),a[0].scrollIntoView({behavior:"smooth",block:"center"})),this.emitEvent("form:validate",{formId:e.id,isValid:t,errors:e.state.errors,invalidFields:a}),t},getFieldValue(e){switch(e.type){case"checkbox":return e.name.endsWith("[]")?this.getCheckboxGroupValues(e.form,e.name):e.checked;case"radio":const t=e.form.querySelector(`input[name="${e.name}"]:checked`);return t?t.value:null;case"select-multiple":return Array.from(e.selectedOptions).map(e=>e.value);case"file":return e.files.length>0?e.files:null;default:return e.value}},getCheckboxGroupValues(e,t){const a=e.querySelectorAll(`input[name="${t}"]:checked`);return Array.from(a).map(e=>e.value)},getFormData(e,t=!1){var a;const{element:n}=e,s=new FormData,r={},i=new Set;try{const e=n.elements;if(e&&e.length)for(const t of Array.from(e)){const e=t.name;if(!e)continue;if(i.has(e))continue;if("radio"===t.type){const t=n.querySelector(`input[name="${e}"]:checked`);t&&(s.append(e,t.value||""),r[e]=t.value||""),i.add(e);continue}if("checkbox"===t.type){if(e.endsWith("[]")){const t=e.slice(0,-2);if(!i.has(t)){const a=n.querySelectorAll(`input[name="${e}"]:checked`),o=Array.from(a).map(e=>e.value||"");o.forEach(t=>s.append(e,t)),r[t]=o,i.add(t)}}else{const a=t.checked?"1":"0";s.append(e,a),r[e]=t.checked,i.add(e)}continue}if("file"===t.type){t.multiple&&t.files.length>0?(Array.from(t.files).forEach(t=>s.append(`${e}[]`,t)),r[e]=Array.from(t.files).map(e=>e.name)):t.files.length>0&&(s.append(e,t.files[0]),r[e]=t.files[0].name),i.add(e);continue}if("select"===t.tagName.toLowerCase()&&t.multiple){const a=Array.from(t.selectedOptions).map(e=>e.value);a.forEach(t=>s.append(`${e}[]`,t)),r[e]=a,i.add(e);continue}if(e.endsWith("[]")){if(!i.has(e)){const t=n.querySelectorAll(`[name="${e}"]`),a=Array.from(t).map(e=>e.value);a.forEach(t=>s.append(e,t));r[e.slice(0,-2)]=a,i.add(e)}continue}const a=t.value||"";s.append(e,a),r[e]=a,i.add(e)}}catch(o){console.warn("FormManager: Error reading form.elements",o)}if(!t&&!1!==e.config.csrf){const e=n.querySelector('input[name="_token"]');let t=e?e.value:null;if(t||(t=null==(a=document.querySelector('meta[name="csrf-token"]'))?void 0:a.getAttribute("content")),!t){const e=document.cookie.split(";");for(const a of e){const[e,n]=a.trim().split("=");if("XSRF-TOKEN"===e){t=decodeURIComponent(n);break}}}t?r._token||(s.append("_token",t),r._token=t):window.simpleFetch&&setTimeout(()=>{var e,t,a,n,s,r,i;const o=(null==(a=null==(t=null==(e=window.SecurityManager)?void 0:e.config)?void 0:t.csrf)?void 0:a.tokenUrl)||(null==(i=null==(r=null==(s=null==(n=window.Now)?void 0:n.config)?void 0:s.security)?void 0:r.csrf)?void 0:i.tokenUrl)||"api/auth/csrf-token";simpleFetch.get(o).then(e=>{if(e.data&&e.data.token){let t=document.querySelector('meta[name="csrf-token"]');t||(t=document.createElement("meta"),t.name="csrf-token",document.head.appendChild(t)),t.setAttribute("content",e.data.token)}}).catch(e=>{console.error("Failed to fetch CSRF token:",e)})},0)}return e.state.data=r,{formData:s,jsonData:r}},getValues(e){let t=null;if(!e)return null;if("string"==typeof e){if(t=this.getInstance(e),!t){const a=document.getElementById(e)||document.querySelector(`form[data-form="${e}"]`);a&&(t=this.getInstanceByElement(a))}}else e instanceof HTMLFormElement?t=this.getInstanceByElement(e):e&&e.element&&(t=e);if(!t)return null;try{const{jsonData:e}=this.getFormData(t);return e}catch(a){return t.state&&t.state.data?t.state.data:null}},setFormData(e,t){if(!e||!t)return;const{element:a,elements:n}=e;for(const[s,r]of Object.entries(t.data||t)){const t=n.get(s);if(!t){const e=a.querySelector(`[name="${s}"], [name="${s}[]"]`);e&&this.setFieldValue(e,r);continue}Array.isArray(t)?t.forEach(e=>{"radio"===e.type?e.checked=e.value===r||e.value===String(r):"checkbox"===e.type&&(Array.isArray(r)?e.checked=r.includes(e.value):e.checked=e.value===r||e.value===String(r))}):this.setFieldValue(t,r),e.state.data[s]=r}a.querySelectorAll("[data-attr]").forEach(s=>{var r,i,o,l;const c=s.getAttribute("data-attr"),d=null==c?void 0:c.match(/value:([\w-]+)/);if(d&&d[1]){const c=d[1],u=(t.data||t)[c];if(null!=u)if("tags"===s.getAttribute("data-element")&&Array.isArray(u)){const t=null==(r=window.ElementManager)?void 0:r.getInstanceByElement(s);if(t&&"function"==typeof t.setValue){const a=s.getAttribute("data-options-key"),n=null==(i=e.state.formOptions)?void 0:i[a];if(n&&Array.isArray(n)){const e=u.map(e=>{const t=n.find(t=>("object"==typeof t?t.value:t)==e);return t?"object"==typeof t?{key:t.value,value:t.text}:{key:t,value:t}:{key:e,value:e}});t.setValue(e)}else{const e=u.map(e=>({key:e,value:e}));t.setValue(e)}}}else if("file"!==s.type||!Array.isArray(u)&&"object"!=typeof u)if("text"===s.type&&s.getAttribute("data-options-key")){const t=s.getAttribute("data-options-key"),n=null==(o=e.state.formOptions)?void 0:o[t];if(n&&Array.isArray(n)){const e=n.find(e=>("object"==typeof e?e.value:e)==u);if(e){s.value="object"==typeof e?e.text:e;const t=s.name.replace("_text",""),n=a.querySelector(`input[type="hidden"][name="${t}"]`);n&&(n.value=u);const r=null==(l=window.ElementManager)?void 0:l.getInstanceByElement(s);r&&(r.selectedValue=u)}else this.setFieldValue(s,u)}else this.setFieldValue(s,u)}else n.get(s.name)||this.setFieldValue(s,u);else this.setFieldValue(s,u)}});a.querySelectorAll('input[type="file"][data-files]').forEach(e=>{const a=e.getAttribute("data-files");if(a)try{return void JSON.parse(a)}catch(n){const s=t.data||t;let r=s[a];void 0===r&&s.data&&(r=s.data[a]),r&&(Array.isArray(r)||"object"==typeof r)&&this.setFieldValue(e,r)}});if(a.querySelectorAll("table[data-table][data-attr]").forEach(e=>{const a=e.getAttribute("data-attr"),n=null==a?void 0:a.match(/data:(\w+)/);if(n&&n[1]){const a=n[1],s=(t.data||t)[a];if(s&&window.TableManager){const t=e.getAttribute("data-table");setTimeout(()=>{(s.columns&&s.data||Array.isArray(s))&&TableManager.setData(t,s)},0)}}}),window.TemplateManager){const e=t.data||t,n={state:e,data:e,computed:{}};TemplateManager.processDataDirectives(a,n)}this.emitEvent("form:data:set",{formId:e.id,data:t})},setFieldValue(e,t,a=!1){if(e){switch(e.type){case"checkbox":e.checked=Boolean(t);break;case"radio":e.checked=e.value===t||e.value===String(t);break;case"select-multiple":if(Array.isArray(t)){const a=t.map(e=>String(e));Array.from(e.options).forEach(e=>{e.selected=a.includes(e.value)})}break;case"file":if(t&&(Array.isArray(t)||"object"==typeof t)){const a=Array.isArray(t)?t:[t];if(e.setAttribute("data-files",JSON.stringify(a)),window.ElementManager&&window.FileElementFactory){const t=ElementManager.getInstanceByElement(e);if(t&&(t.config.existingFiles=a,t.previewContainer)){t.previewContainer.querySelectorAll('.preview-item[data-existing="true"]').forEach(e=>e.remove()),FileElementFactory.showExistingFiles(t,a)}}}break;default:if("SELECT"!==e.tagName||e.multiple?e.value=t??"":e.value=null!=t?String(t):"",window.ElementManager){const a=ElementManager.getInstanceByElement(e);a&&"function"==typeof a.setValue&&a.setValue(t)}}a||e.dispatchEvent(new Event("change",{bubbles:!0}))}},async submitAjax(e,t){var a,n;const{element:s,config:r}=e,i=Array.from(s.elements).some(e=>{var t;return"file"===e.type&&(null==(t=e.files)?void 0:t.length)>0});try{const o=s.getAttribute("data-method")||s.method||r.method||"POST",l=s.getAttribute("data-action")||s.action||r.action||window.location.href;let c;if(i)c=await this.submitWithProgress(e,l,t.formData);else{const a=o.toLowerCase(),n={throwOnError:!1},s=(()=>{if(!1===e.config.csrf)return{"X-Skip-CSRF":"true"}})();s&&(n.headers=s),c=await window.http[a](l,t.jsonData,n)}if(c.success){const e=c.data||{};return{success:!0,message:Now.translate(e.message||r.successMessage),data:e.data||e,status:c.status,code:e.code}}return{success:!1,message:Now.translate((null==(a=c.data)?void 0:a.message)||c.statusText||r.errorMessage),errors:(null==(n=c.data)?void 0:n.errors)||{},status:c.status,data:c.data}}catch(o){return{success:!1,message:Now.translate(o.message||r.errorMessage),error:o}}},submitWithProgress(e,t,a){return new Promise((n,s)=>{var r;const{element:i,config:o}=e,l=new XMLHttpRequest,c=this.createProgressElement(i);c.style.display="block",l.upload.addEventListener("progress",e=>{e.lengthComputable&&this.updateProgress(c,e.loaded,e.total)}),l.addEventListener("load",()=>{if(c.style.display="none",l.status>=200&&l.status<300)try{const e=JSON.parse(l.responseText);n({success:!1!==e.success,message:e.message,data:e.data||e,status:l.status,code:e.code})}catch(e){n({success:!0,message:Now.translate(o.successMessage),rawResponse:l.responseText,status:l.status})}else{let t={ok:!1,success:!1,message:Now.translate(o.errorMessage),statusCode:l.status,statusText:l.statusText};try{const e=JSON.parse(l.responseText);t={...t,...e}}catch(e){}n(t)}}),l.addEventListener("error",()=>{c.style.display="none",n({success:!1,message:"Network error occurred",statusCode:0,statusText:"Network Error"})}),l.addEventListener("abort",()=>{c.style.display="none",n({success:!1,message:"Request was aborted",statusCode:0,statusText:"Aborted"})}),l.open("POST",t),l.setRequestHeader("X-Requested-With","XMLHttpRequest");const d=null==(r=document.querySelector('meta[name="csrf-token"]'))?void 0:r.getAttribute("content");d&&l.setRequestHeader("X-CSRF-Token",d),l.send(a)})},createProgressElement(e){let t=e.querySelector(".upload-progress");if(!t){const a=document.createElement("div");a.innerHTML=this.config.uploadProgressTemplate.trim(),t=a.firstChild,e.appendChild(t)}return t},updateProgress(e,t,a){const n=Math.round(t/a*100),s=e.querySelector(".progress-bar");s&&(s.style.width=n+"%",s.setAttribute("aria-valuenow",n));const r=e.querySelector(".progress-text");if(r){const e=this.formatFileSize(t),s=this.formatFileSize(a);r.textContent=`${n}% (${e} / ${s})`}this.emitEvent("form:upload-progress",{loaded:t,total:a,percent:n})},formatFileSize(e){const t=["B","KB","MB","GB"];let a=e,n=0;for(;a>=1024&&n<t.length-1;)a/=1024,n++;return`${Math.round(10*a)/10} ${t[n]}`},autoFillIntendedUrl(e){const t=new URLSearchParams(window.location.search),a=t.get("redirect")||t.get("return_to")||null;let n=null;try{const e=sessionStorage.getItem("auth_intended_route");if(e){const t=JSON.parse(e);if(t&&t.path){n=(e=>{var t,a;const n=(null==(a=null==(t=window.RouterManager)?void 0:t.config)?void 0:a.base)||"";let s=e||"/";return n&&s.startsWith(n)&&(s=s.slice(n.length)||"/",s.startsWith("/")||(s="/"+s)),s})(t.path)+(t.query||"")+(t.hash||"")}}}catch(i){n=null}let s=null;if(a&&this.isValidRedirectUrl(a))s=a;else if(n){this.isValidRedirectUrl(n)&&(s=n)}let r=e.querySelector('input[name="intended_url"]');if(!r)try{r=document.createElement("input"),r.type="hidden",r.name="intended_url",e.appendChild(r)}catch(i){return}s?(r.value=s,e.dataset.redirectAfterLogin=s):r.value=""},restoreRememberedCredentials(e){try{if(!e||!e.element)return;const a=e.element;if("login"!==(a.dataset&&a.dataset.form?a.dataset.form:null))return;const n=localStorage.getItem("remember_username");if(!n)return;const s=a.querySelector('input[name="username"]')||a.querySelector('input[type="email"]')||a.querySelector('input[type="text"]'),r=a.querySelector('input[name="remember"], input#remember');if(s){s.value=n;try{e.state.data[s.name||"username"]=n}catch(t){}}r&&(r.checked=!0)}catch(t){}},restorePersistedValues(e){try{if(!e||!e.element)return;const t=e.element,a=t.querySelectorAll("[data-persist]");if(!a||0===a.length)return;a.forEach(a=>{try{const s=a.dataset.persist;if(!s||"false"===s)return;const r="cookie"===s?"cookie":"local",i=a.dataset.persistKey||`nowjs_persist:${t.dataset.form||window.location.pathname}:${a.name||a.id}`;if(("password"===a.type||"password"===a.dataset.element)&&"true"!==a.dataset.persistAllowPassword)return;let o=null;if("cookie"===r)o=this._getCookie(i);else{const e=localStorage.getItem(i);if(e)try{const t=JSON.parse(e);if(!t||!t.value)return;if(t.expires&&Date.now()>t.expires)return void localStorage.removeItem(i);o=t.value}catch(n){o=e}}if(null==o)return;if("checkbox"===a.type)a.checked="1"===o||!0===o||"true"===o;else if("radio"===a.type){t.querySelectorAll(`input[name="${a.name}"]`).forEach(e=>{e.checked=e.value===o})}else if("select"===a.tagName.toLowerCase())try{a.value=o}catch(n){}else a.value=o;try{e.state.data[a.name||a.id]="checkbox"===a.type?a.checked:a.value}catch(n){}}catch(n){}})}catch(t){}},savePersistedValues(e){try{if(!e||!e.element)return;const t=e.element,a=t.querySelectorAll("[data-persist]");if(!a||0===a.length)return;a.forEach(e=>{try{const n=e.dataset.persist;if(!n||"false"===n)return;if("submit"!==(e.dataset.persistOn||"submit"))return;const s="cookie"===n?"cookie":"local",r=e.dataset.persistKey||`nowjs_persist:${t.dataset.form||window.location.pathname}:${e.name||e.id}`,i=parseInt(e.dataset.persistTtlDays||e.dataset.persistTtl||"0");if(("password"===e.type||"password"===e.dataset.element)&&"true"!==e.dataset.persistAllowPassword)return;let o=null;if("checkbox"===e.type)o=e.checked?"1":"0";else if("radio"===e.type){if(!e.checked)return;o=e.value}else o=(e.tagName.toLowerCase(),e.value);if("cookie"===s){const e=isNaN(i)?0:i;this._setCookie(r,o,e)}else{const e={value:o};!isNaN(i)&&i>0&&(e.expires=Date.now()+24*i*60*60*1e3);try{localStorage.setItem(r,JSON.stringify(e))}catch(a){localStorage.setItem(r,o)}}}catch(a){}})}catch(t){}},_setCookie(e,t,a){try{if(!e||"string"!=typeof e)return;let n="";if(a&&a>0){const e=new Date;e.setTime(e.getTime()+24*a*60*60*1e3),n="; expires="+e.toUTCString()}document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(null==t?"":t)+n+"; path=/"}catch(n){}},_getCookie(e){try{const t=document.cookie?document.cookie.split(";"):[];for(const a of t){const[t,...n]=a.trim().split("=");if(decodeURIComponent(t)===e)return decodeURIComponent(n.join("="))}return null}catch(t){return null}},performRedirect(e){var t,a;if((null==(a=null==(t=window.RouterManager)?void 0:t.state)?void 0:a.initialized)&&"function"==typeof window.RouterManager.navigate)try{return void RouterManager.navigate(e)}catch(n){console.warn("RouterManager.navigate failed, falling back to window.location.href:",n)}window.location.href=e},async handleSuccessfulSubmit(e,t){var a;const{element:n,config:s}=e;FormError.clearAll(),s.resetAfterSubmit&&this.resetForm(e);const r=t.data.data||t.data;if(r&&r.user&&r.token&&("login"===n.dataset.form||"register"===n.dataset.form)){const e=Now.getManager("auth");if(e&&"function"==typeof e.setAuthenticatedUser)try{const t=await e.setAuthenticatedUser(r,{preventRedirect:!0});t&&t.success||console.warn("Failed to set authenticated user:",(null==t?void 0:t.message)||"Unknown error")}catch(i){console.error("Error setting authenticated user:",i)}else console.warn("AuthManager not available or setAuthenticatedUser method not found");try{const e=n;if("login"===(e.dataset&&e.dataset.form?e.dataset.form:null)){const t=e.querySelector('input[name="remember"], input#remember'),a=e.querySelector('input[name="username"]')||e.querySelector('input[type="email"]')||e.querySelector('input[type="text"]');if(t&&t.checked&&a&&a.value)try{localStorage.setItem("remember_username",a.value)}catch(o){}else try{localStorage.removeItem("remember_username")}catch(o){}}}catch(o){}}if("login"===n.dataset.form&&r&&r.actions){let e=(null==(a=n.querySelector('input[name="intended_url"]'))?void 0:a.value)||n.dataset.redirectAfterLogin||sessionStorage.getItem("intended_url");if(!e)try{const t=sessionStorage.getItem("auth_intended_route");if(t){const a=JSON.parse(t);a&&a.path&&(e=a.path+(a.query||"")+(a.hash||""))}}catch(o){}if(e&&this.isValidRedirectUrl(e)){const t=r.actions.find(e=>"redirect"===e.type);t&&(t.url=e,sessionStorage.removeItem("intended_url"),sessionStorage.removeItem("auth_intended_route"))}}try{await ResponseHandler.process(r,{formId:e.id,form:n,instance:e})}catch(i){console.error("FormManager: Error processing response actions",i)}if(!t.message||r&&r.actions||(!1!==s.showSuccessInline&&FormError.showSuccess(t.message,n),!1!==s.showSuccessInNotification&&window.NotificationManager&&NotificationManager.success(t.message)),!(r&&r.actions&&r.actions.some(e=>"redirect"===e.type))){const a=this.determineRedirectUrl(n,t,s);a&&(this.emitEvent("redirect:start",{formId:e.id,url:a,delay:1e3}),setTimeout(()=>{this.performRedirect(a)},1e3))}this.emitEvent("form:submitted",{formId:e.id,response:t})},determineRedirectUrl(e,t,a){var n,s,r,i,o,l;if("login"===e.dataset.form||"true"===e.dataset.useIntendedUrl){let t=(null==(n=e.querySelector('input[name="intended_url"]'))?void 0:n.value)||e.dataset.redirectAfterLogin||sessionStorage.getItem("intended_url");if(!t)try{const e=sessionStorage.getItem("auth_intended_route");if(e){const a=JSON.parse(e);a&&a.path&&(t=a.path+(a.query||"")+(a.hash||""))}}catch(c){}if(t&&this.isValidRedirectUrl(t))return sessionStorage.removeItem("intended_url"),sessionStorage.removeItem("auth_intended_route"),t}if((null==(s=t.data)?void 0:s.redirectUrl)||(null==(i=null==(r=t.data)?void 0:r.redirect)?void 0:i.url)){return t.data.redirectUrl||t.data.redirect.url}if(null==(l=null==(o=t.data)?void 0:o.user)?void 0:l.role){const a=t.data.user.role,n=e.dataset[`redirect${a.charAt(0).toUpperCase()+a.slice(1)}`];if(n)return n}return e.dataset.successRedirect?e.dataset.successRedirect:e.dataset.redirect?e.dataset.redirect:a.successRedirect?a.successRedirect:a.redirect?a.redirect:null},isValidRedirectUrl(e){if(!e||"string"!=typeof e)return!1;try{if(e.startsWith("/")&&!e.startsWith("//"))return!0;return new URL(e).origin===window.location.origin}catch{return!1}},async handleFailedSubmit(e,t){const{element:a,config:n}=e;try{await ResponseHandler.process(t,{formId:e.id,form:a,instance:e})}catch(s){console.error("FormManager: Error processing response actions",s)}if(t.message&&!t.actions&&(!1!==n.showErrorsInline&&FormError.showGeneralError(t.message,a),!1!==n.showErrorsInNotification&&window.NotificationManager&&NotificationManager.error(t.message)),t.errors&&!t.actions){const s=[];if(Object.entries(t.errors).forEach(([t,n])=>{const r=Array.isArray(n)?n[0]:n;FormError.showFieldError(t,r,a),e.state.errors[t]=r,s.push(r)}),!1!==n.showErrorsInNotification&&window.NotificationManager&&s.length>0){const e=1===s.length?s[0]:s.map(e=>`• ${e}`).join("\n");NotificationManager.error(e)}}this.emitEvent("form:error",{formId:e.id,response:t,errors:t.errors})},handleInvalidSubmit(e){if(window.NotificationManager){const t=Object.values(e.state.errors)[0]||Now.translate("Please correct the errors in the form before submitting");NotificationManager.error(t)}this.emitEvent("form:validation:failed",{formId:e.id,errors:e.state.errors})},handleSubmitError(e,t){window.NotificationManager&&NotificationManager.error(t.message||"An unexpected error occurred"),ErrorManager.handle(t,{context:"FormManager.submitForm",type:"error:form",data:{formId:e.id}}),this.emitEvent("form:error",{formId:e.id,error:t})},resetForm(e){const{element:t,elements:a}=e;t.reset(),FormError.clearAll(),e.state.errors={},e.state.valid=!0,e.state.data={...e.state.originalData},a.forEach((t,a)=>{Array.isArray(t)?t.forEach(t=>{t.classList.remove(e.config.dirtyClass),t.classList.remove(e.config.validClass),t.classList.remove(e.config.invalidClass)}):(t.classList.remove(e.config.dirtyClass),t.classList.remove(e.config.validClass),t.classList.remove(e.config.invalidClass))}),this.emitEvent("form:reset",{formId:e.id})},async handleCascade(e,t){const{element:a}=e,n=a.dataset.cascadeApi;if(n){if(!e.state.cascading)try{e.state.cascading=!0,t.classList.add("loading");const s=Array.from(a.querySelectorAll("[data-cascade-source]")),r=new FormData;s.forEach(e=>{const t=e.name||e.id,a=this.getFieldValue(e);null!=a&&""!==a&&r.append(t,a)});const i=t.dataset.cascadeSource;let o;if(r.append("source",i),window.ApiService&&"function"==typeof window.ApiService.post)o=await window.ApiService.post(n,r);else{if(!window.simpleFetch||"function"!=typeof window.simpleFetch.post)throw new Error("FormManager: No HTTP client available (ApiService or simpleFetch required)");o=await window.simpleFetch.post(n,r)}o&&o.data&&this.processCascadeResponse(e,o.data,t)}catch(s){console.error("FormManager: Error handling cascade:",s)}finally{t.classList.remove("loading"),e.state.cascading=!1}}else console.warn("FormManager: data-cascade-api not found on form")},processCascadeResponse(e,t,a=null){const{element:n}=e;let s=t;t.data&&t.data.data&&t.data.options&&(s=t.data),s.data&&Object.keys(s.data).forEach(e=>{const t=s.data[e];let a=n.querySelector(`[name="${e}"]`);a||(a=n.querySelector(`[data-attr*="${e}"]`)),a?this.setFieldValue(a,t,!0):console.warn(`FormManager: Field "${e}" not found in form`)}),s.options&&Object.keys(s.options).forEach(e=>{const t=s.options[e];n.querySelectorAll(`[data-options-key="${e}"]`).forEach(e=>{var a;if("SELECT"===e.tagName)e.multiple?MultiSelectElementFactory.updateOptions(e,t):SelectElementFactory.updateOptions(e,t);else if("INPUT"===e.tagName&&e.dataset.autocomplete){const s=null==(a=window.ElementManager)?void 0:a.getInstance(e);if(s&&"function"==typeof s.updateOptions)s.updateOptions(t);else try{e.dataset.cachedOptions=JSON.stringify(t)}catch(n){console.warn("FormManager: Failed to cache options for autocomplete",n)}}})})},updateSelectOptions(e,t){const a=e.value,n=e.querySelector('option[value=""]');if(n){const t=n.outerHTML;e.innerHTML=t}else e.innerHTML="";Array.isArray(t)&&t.forEach(t=>{const a=document.createElement("option");"object"==typeof t?(a.value=t.value||t.id||"",a.textContent=t.text||t.label||t.name||a.value):(a.value=t,a.textContent=t),e.appendChild(a)}),a&&(e.value=a)},destroyForm(e){try{if(!e)return;e.elements&&window.ElementManager&&e.elements.forEach((e,t)=>{if(Array.isArray(e))e.forEach(e=>{if(e.id)try{window.ElementManager.destroy(e.id)}catch(t){}});else if(e.id)try{window.ElementManager.destroy(e.id)}catch(a){}});try{this.state.elementIndex.delete(e.element)}catch(t){}try{this.state.forms.delete(e.id)}catch(t){}this.emitEvent("form:destroy",{formId:e.id})}catch(t){console.warn("FormManager.destroyForm error",t)}},shouldEnhance:e=>!!e&&!(!e.dataset||!e.dataset.form&&!e.dataset.element),destroyContainer(e){if(!e)return;e.querySelectorAll("form").forEach(e=>{const t=this.state.elementIndex.get(e);t&&this.destroyForm(t)})},scan(e=document){if(!e||!e.querySelectorAll)return[];const t=Array.from(e.querySelectorAll("form[data-form]"));return t.forEach(e=>{this.state.elementIndex.has(e)||this.initForm(e)}),t},destroyFormByElement(e){if(!e)return;const t=this.state.elementIndex.get(e);if(t)return this.destroyForm(t);const a=e.dataset&&e.dataset.form;a&&this.state.forms.has(a)&&this.destroyForm(this.state.forms.get(a))},startObserver(e){e&&(this.observerConfig.observeRoot=e),this.setupFormObserver()},stopObserver(){this._stopFormObserver&&this._stopFormObserver()},setupFormObserver(){var e;if(this._formObserver)return;this._addedQueue=new Set,this._removedQueue=new Set,this._processTimeout=null;const processQueues=()=>{if(this._removedQueue.size){const e=Array.from(this._removedQueue);this._removedQueue.clear(),e.forEach(e=>{try{const t=this.state.elementIndex.get(e);if(t)t.element.isConnected||this.destroyForm(t);else if(e.dataset&&e.dataset.form){const t=this.state.forms.get(e.dataset.form);t&&!t.element.isConnected&&this.destroyForm(t)}}catch(t){console.warn("FormManager.process removed error",t)}})}if(this._addedQueue.size){const e=Array.from(this._addedQueue);this._addedQueue.clear(),e.forEach(e=>{try{if(!e||1!==e.nodeType)return;if(!e.isConnected)return;if(e.matches&&e.matches("form[data-form]"))this.state.elementIndex.has(e)||this.initForm(e);else if(e.querySelector){e.querySelectorAll("form[data-form]").forEach(e=>{e.isConnected&&!this.state.elementIndex.has(e)&&this.initForm(e)})}}catch(t){console.warn("FormManager.process added error",t)}})}0===this.state.forms.size&&this._stopFormObserver()},t=new MutationObserver(e=>{var t;for(const n of e){if(n.removedNodes&&n.removedNodes.length)for(const e of n.removedNodes)if(e&&1===e.nodeType)if(e.matches&&e.matches("form[data-form]"))this._removedQueue.add(e);else if(e.querySelector){const t=e.querySelector("form[data-form]");t&&this._removedQueue.add(t)}if(n.addedNodes&&n.addedNodes.length)for(const e of n.addedNodes)if(e&&1===e.nodeType)if(e.matches&&e.matches("form[data-form]"))this._addedQueue.add(e);else if(e.querySelector){const t=e.querySelector("form[data-form]");t&&this._addedQueue.add(t)}}if(this._processTimeout)return;const a=(null==(t=this.observerConfig)?void 0:t.observerDelay)||40;this._processTimeout=setTimeout(()=>{this._processTimeout=null,processQueues()},a)}),a=(null==(e=this.observerConfig)?void 0:e.observeRoot)||document.body;t.observe(a,{childList:!0,subtree:!0}),this._formObserver=t},_stopFormObserver(){try{if(!this._formObserver)return;this._formObserver.disconnect(),this._formObserver=null,this._addedQueue&&this._addedQueue.clear(),this._removedQueue&&this._removedQueue.clear(),this._processTimeout&&(clearTimeout(this._processTimeout),this._processTimeout=null)}catch(e){console.warn("FormManager._stopFormObserver error",e)}},getInstance(e){return this.state.forms.get(e)},getInstanceByElement(e){for(const[t,a]of this.state.forms.entries())if(a.element===e)return a;return e.dataset&&e.dataset.form?this.state.forms.get(e.dataset.form):null},emitEvent(e,t){EventManager.emit(e,t)},destroy(e){var t,a,n,s,r;const i=this.state.forms.get(e);i&&(i.element.removeEventListener("submit",null==(t=i.handlers)?void 0:t.submit),i.element.removeEventListener("reset",null==(a=i.handlers)?void 0:a.reset),i.element.removeEventListener("change",null==(n=i.handlers)?void 0:n.change),i.element.removeEventListener("input",null==(s=i.handlers)?void 0:s.input),i.element.removeEventListener("blur",null==(r=i.handlers)?void 0:r.blur,!0),clearTimeout(i.resetTimeout),this.state.forms.delete(e),this.emitEvent("form:destroy",{formId:e}))},reset(){this.state.forms.forEach((e,t)=>{this.resetForm(e)})},cleanup(){for(const[e]of this.state.forms)this.destroy(e);this.state.forms.clear(),this.state.validators.clear(),this.state.initialized=!1}};(null==(C=window.Now)?void 0:C.registerManager)&&Now.registerManager("form",we),window.FormManager=we;let be=(__publicField(M=class{static extractConfig(e,t={},a){const n=e.dataset,s={},parseBool=t=>void 0!==a[t]?a[t]:void 0!==n[t]?"true"===n[t]:t in e?e[t]:void 0,parseString=t=>void 0!==a[t]?a[t]:void 0!==n[t]?n[t]:t in e?e[t]:void 0;return s.required=parseBool("required"),s.disabled=parseBool("disabled"),s.readOnly=parseBool("readOnly"),s.placeholder=parseString("placeholder"),s.value=parseString("value"),s.pattern=parseString("pattern"),s.minLength=this.parseNumeric("minLength",e,a,n),s.maxLength=this.parseNumeric("maxLength",e,a,n),"function"==typeof this.extractCustomConfig&&Object.assign(s,this.extractCustomConfig(e,a,n)),Object.entries(t).forEach(([e,t])=>{e in s||(s[e]=t)}),Object.entries(a).forEach(([e,t])=>{e in s||(s[e]=t)}),Object.entries(n).forEach(([e,t])=>{e in s||(s[e]=t)}),s}static create(e){["button","submit","reset"].includes(e.elementType)&&(e.tagName="button",e.type=e.elementType),e.tagName=e.tagName||"input";const t=document.createElement(e.tagName);"input"===e.tagName&&(t.type=e.type||"text"),e.id=e.id&&"string"==typeof e.id?e.id:`${e.elementType||e.tagName}-${Utils.generateUUID()}`,t.id=e.id,void 0!==e.value&&null!==e.value&&(t.value=e.value,t.setAttribute("value",e.value)),this.createWrapper(t,e);const a=Utils.object.deepClone(Object.assign({},this.config,e));return this.createInstance(t,a)}static enhance(e,t={}){if(!(e&&e instanceof HTMLElement))throw new Error("Invalid element: Must be an HTMLElement");e.id=e.id||`${t.type||e.type}-${Utils.generateUUID()}`;const a=Utils.object.deepClone(this.extractConfig(e,this.config,t));this.parseExistingWrapper(e);const n=this.createInstance(e,a),s="SELECT"===e.tagName&&e.multiple;return e.value&&!s&&(n.state.formatting=!0,e.value=n.initValue(e.value),n.state.formatting=!1),n}static createInstance(e,t={}){this._privateState.has(e)||this._privateState.set(e,{validating:!1,valid:!0,modified:!1,error:null,originalValue:t.defaultValue||("value"in e?e.value:e.getAttribute("value"))||"",originalConfig:Utils.object.deepClone(t),formatting:!1,recursionGuard:{}}),t.required&&e.setAttribute("required",""),t.placeholder&&t.placeholder.trim()&&(e.placeholder=Now.translate(t.placeholder));const a={element:e,config:Utils.object.deepClone(t),wrapper:e.wrapper,label:e.label,container:e.container,comment:e.comment,isValid(){const e=M._privateState.get(this.element);return!e||e.valid},isModified(){const e=M._privateState.get(this.element);return!!e&&e.modified},getError(){const e=M._privateState.get(this.element);return e?e.error:null},focus(){return this.element.focus(),this},blur(){return this.element.blur(),this},reset(){const e=M._privateState.get(this.element);return e&&(e.formatting=!0,Object.assign(this.config,e.originalConfig),this.element.value=this.initValue(e.originalValue),e.valid=!0,e.modified=!1,e.error=null,e.validating=!1,e.formatting=!1,"undefined"!=typeof FormError&&FormError.clearFieldError(this.element.id)),this},cleanup(){return"undefined"!=typeof EventSystemManager&&EventSystemManager.removeElementHandlers(this.element),"undefined"!=typeof FormError&&FormError.clearFieldError(this.element.id),this},initValue(e){const{validatedValue:t}=a.validateValue(e,!0);return t},validate(e,t){const a=M._privateState.get(this.element);if(!a)return e;(a.validating||void 0===e)&&(e="value"in this.element?this.element.value:this.element.getAttribute("value")||""),a.validating=!0,a.modified=!0;try{const{validatedValue:n,error:s}=this.validateValue(e,t);return s?(a.valid=!1,a.error=s,FormError.showFieldError(this.element.id,s)):(a.valid=!0,a.error=null,FormError.clearFieldError(this.element.id)),n}catch(n){return console.error("Validation error:",n),a.valid=!1,e}finally{a.validating=!1}},validateValue(e,t){const a=this.element;let n=null;const s="number"==typeof e?String(e):String(e).trim();if(a.hasAttribute("required")&&""===s)return n=Now.translate("Please fill in"),{validatedValue:e,error:n};if("function"==typeof this.customValidateValue){const a=this.customValidateValue.call(this,e,t);if(a.error)return a;e="number"==typeof a.validatedValue?String(a.validatedValue):a.validatedValue}if(s.length>0){if(t&&"function"==typeof this.config.formatter){const t=this.config.formatter(e);if(t&&"object"==typeof t&&"formatted"in t){if(t.error)return{validatedValue:t.formatted,error:t.error};e=t.formatted}else e=t}null==e&&(e="");const s=a.minLength;if(s>-1&&e.length<s)return n=Now.translate("Must be at least {minLength} characters",{minLength:s}),{validatedValue:e,error:n};const r=a.maxLength;if(r>0&&e.length>r)return n=Now.translate("Must be no more than {maxLength} characters",{maxLength:r}),{validatedValue:e,error:n};const i=a.getAttribute("pattern");if(i&&!new RegExp(i).test(e))return n=Now.translate("Please match the requested format"),{validatedValue:e,error:n};if("function"==typeof this.validateSpecific&&(n=this.validateSpecific.call(this,e),n))return{validatedValue:e,error:n};if("function"==typeof this.customValidate&&(n=this.customValidate(e),n))return{validatedValue:e,error:n}}return{validatedValue:e,error:null}}};Object.defineProperty(a,"state",{get(){const e=this.element;return{get validating(){const t=M._privateState.get(e);return!!t&&t.validating},set validating(t){const a=M._privateState.get(e);a&&(a.validating=t)},get valid(){const t=M._privateState.get(e);return!t||t.valid},set valid(t){const a=M._privateState.get(e);a&&(a.valid=t)},get modified(){const t=M._privateState.get(e);return!!t&&t.modified},set modified(t){const a=M._privateState.get(e);a&&(a.modified=t)},get error(){const t=M._privateState.get(e);return t?t.error:null},set error(t){const a=M._privateState.get(e);a&&(a.error=t)},get formatting(){const t=M._privateState.get(e);return!!t&&t.formatting},set formatting(t){const a=M._privateState.get(e);a&&(a.formatting=t)}}}});let n=[];e.dataset.validate?n=this.parseValidationRules(e.dataset.validate):t.validation&&(n=Array.isArray(t.validation)?t.validation:[t.validation]),a.validationRules=n,a.validateSpecific||(a.validateSpecific=function(e){var a;const n={...window.validators||{},...this.validators||{}};for(const s of this.validationRules||[]){const r="string"==typeof s?s:s.name;if(!["minLength","maxLength","pattern","required"].includes(r)&&(n[r]&&!n[r](e)))return Now.translate((null==(a=t.validationMessages)?void 0:a[r])||"Invalid value")}return null}),"function"==typeof this.setupElement&&this.setupElement(a),this.setupProperties(a),Object.keys(t).forEach(n=>{if(!["classList"].includes(n)&&void 0!==t[n]&&!Utils.object.isObject(t[n])&&(this.extendedProperties.includes(n)&&(a[n]=t[n]),(n in a||this.coreProperties.includes(n))&&n in e&&e[n]!==t[n]&&null!==t[n]&&void 0!==t[n]))try{"defaultValue"===n&&a.validate?e[n]=a.initValue(t[n]):["type"].includes(n)||(e[n]=t[n])}catch(s){console.warn(`Could not set property ${n} on element`,e,s)}}),Object.keys(t).forEach(n=>{n in a||n in e||Object.defineProperty(a,n,{get:()=>t[n],set(e){t[n]=e}})});try{"button"===(e.tagName&&e.tagName.toLowerCase())&&(void 0!==t.text?e.textContent=Now.translate(t.text):void 0!==t.value&&(e.textContent=Now.translate(t.value)))}catch(s){}return this.setupEventListeners(a),a.constructor=this,a}static setupProperties(e){const{element:t}=e,a=(e=>{let t;return e instanceof HTMLInputElement?t=Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,"value"):e instanceof HTMLTextAreaElement?t=Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype,"value"):e instanceof HTMLSelectElement&&(t=Object.getOwnPropertyDescriptor(HTMLSelectElement.prototype,"value")),t||{get:function(){if(this instanceof HTMLSelectElement){const e=this.options[this.selectedIndex];return e?e.value:""}return this.getAttribute("value")||""},set:function(e){if(this instanceof HTMLSelectElement)for(let t=0;t<this.options.length;t++)if(this.options[t].value===e)return void(this.selectedIndex=t);this.setAttribute("value",e)}}})(t);Object.defineProperty(t,"value",{get:()=>a.get.call(t),set(n){const s=M._privateState.get(t);if(s&&!s.formatting){s.formatting=!0;const r=e.validate(n,!0);a.set.call(t,r),s.formatting=!1}else a.set.call(t,n)},enumerable:!0,configurable:!0});const n={...M.propertyHandlers};this.propertyHandlers&&Object.assign(n,this.propertyHandlers),Object.entries(n).forEach(([a,n])=>{Object.defineProperty(e,a,{get:()=>n.get.call(e.constructor,t),set(s){const r=M._privateState.get(t);r&&r.modified&&e[a]===s||n.set.call(e.constructor,e,s)},enumerable:!0})}),this.coreProperties.forEach(a=>{a in n||Object.defineProperty(e,a,{get:()=>a in t?t[a]:t.getAttribute(a)||void 0,set(e){a in t?t[a]=e:t.setAttribute(a,e)},enumerable:!0})}),Object.defineProperty(e,"setAttribute",{value:function(e,t){var a;const s=M._privateState.get(this.element);if(!s||!(null==(a=s.recursionGuard)?void 0:a[e])){s.recursionGuard=s.recursionGuard||{},s.recursionGuard[e]=!0;try{e in n?this[e]=t:this.element.setAttribute(e,t)}finally{s.recursionGuard[e]=!1}}},writable:!0,configurable:!0}),Object.defineProperty(e,"getAttribute",{value:function(e){return e in n?this[e]:this.element.getAttribute(e)},writable:!0,configurable:!0}),Object.defineProperty(e,"ariaLabel",{get(){return this.element.getAttribute("aria-label")},set(e){this.element.setAttribute("aria-label",Now.translate(e))}})}static setupEventListeners(e){const{element:t}=e,a=Utils.function.debounce(()=>e.validate(void 0,!1),300);EventSystemManager.addHandler(t,"input",()=>{e.state.modified=!0,a()}),EventSystemManager.addHandler(t,"change",()=>{const a=e.validate(t.value,!0);"value"in t&&a!==t.value&&(t.value=a)}),EventSystemManager.addHandler(t,"blur",()=>{const a=e.validate(t.value,!0);"value"in t&&a!==t.value&&(t.value=a)})}static parseValidationRules(e){if(!e)return{rules:[]};return{rules:(Array.isArray(e)?e:e.split(",").map(e=>e.trim())).map(e=>{if("string"==typeof e&&e.includes(":")){const[t,a]=e.split(":");return{name:t,param:a}}return{name:e}}),validating:!1}}static parseExistingWrapper(e){let t=e,a=0;for(;t&&a<2;){const n=t.parentElement;if(!n)break;if("LABEL"===n.tagName){e.wrapper=n,e.label=n,e.container=n;break}if(n.classList.contains("form-control")){e.container=n;const t=n.parentElement;if(t){const a=t.querySelector(`label[for="${e.id}"]`);a&&(e.wrapper=t,e.label=a)}break}t=n,a++}e.comment=document.getElementById(`result_${e.id}`)}static createWrapper(e,t){if(!t.wrapper)return;const a=document.createElement(t.wrapper);if("label"===t.wrapper)a.className="form-control",t.icon&&a.classList.add(t.icon),t.label&&(a.textContent=Now.translate(t.label),a.dataset.i18n=t.label),e.id&&(a.htmlFor=e.id),a.appendChild(e),e.label=a,e.container=a;else{const n=document.createElement("label");t.label&&(n.textContent=Now.translate(t.label),n.dataset.i18n=t.label),e.id&&(n.htmlFor=e.id),a.appendChild(n);const s=document.createElement("span");s.className="form-control",t.icon&&s.classList.add(t.icon),s.appendChild(e),a.appendChild(s),e.label=n,e.container=s}if(t.comment&&e.id){const n=`result_${e.id}`;e.setAttribute("aria-describedby",n);const s=document.createElement("div");if(s.className="comment",s.id=n,s.textContent=t.comment,"label"===t.wrapper)if(a.parentNode)a.parentNode.insertBefore(s,a.nextSibling);else{const e=a.appendChild;a.appendChild=function(t){let n=100;const r=window.setInterval(function(){n<=0&&window.clearInterval(r),a.parentNode&&(a.parentNode.insertBefore(s,a.nextSibling),a.appendChild=e,window.clearInterval(r)),n--},500)}}a.appendChild(s),e.comment=s}t.wrapperClass&&a.classList.add(t.wrapperClass),e.wrapper=a}static parseNumeric(e,t,a,n){if(e in t){let s;return a&&void 0!==a[e]?s=parseFloat(a[e]):void 0!==n[e]?s=parseFloat(n[e]):t[e]&&(s=t[e]),isNaN(s)?void 0:s}}},"config",{validationMessages:{min:"Value must be at least {min}",max:"Value must be no more than {max}",step:"Value must be a multiple of {step}",decimal:"Only one decimal separator is allowed",negative:"Negative values are not allowed",match:"Fields do not match",fileSize:"File size exceeds the maximum allowed",fileType:"File type is not supported",date:"Please enter a valid date",time:"Please enter a valid time",datetime:"Please enter a valid date and time",phone:"Please enter a valid phone number",postcode:"Please enter a valid postal code",generic:"Invalid value"}}),__publicField(M,"coreProperties",["id","name","disabled","readOnly","checked","className","classList","style","minLength","maxLength","title","type","inputMode","pattern","defaultValue"]),__publicField(M,"extendedProperties",["validation","formatter"]),__publicField(M,"_privateState",new WeakMap),__publicField(M,"propertyHandlers",{value:{get:e=>e.value,set(e,t){e.element.value=t}},required:{get:e=>e.hasAttribute("required"),set(e,t){const{element:a}=e;t?(a.setAttribute("required",""),a.setAttribute("aria-required","true")):(a.removeAttribute("required"),a.setAttribute("aria-required","false"))}},placeholder:{get:e=>"placeholder"in e?e.placeholder:e.getAttribute("placeholder")||"",set(e,t){const{element:a}=e;"string"==typeof t&&t.trim()?(a.dataset.i18n=t,"placeholder"in a?a.placeholder=Now.translate(t):a.setAttribute("placeholder",Now.translate(t))):(delete a.dataset.i18n,"placeholder"in a?a.placeholder="":a.removeAttribute("placeholder"))}}}),M);window.ElementFactory=be;let Ee=(__publicField(x=class{constructor(){if(x.instance)return x.instance;this.panel=null,this.contentContainer=null,this.isVisible=!1,this.currentTarget=null,this.closeCallback=null,this._createPanel(),this._setupEventListeners(),x.instance=this}_createPanel(){this.panel=document.createElement("div"),this.panel.className="dropdown-panel",this.contentContainer=document.createElement("div"),this.contentContainer.className="dropdown-panel-content",this.panel.appendChild(this.contentContainer),document.body.appendChild(this.panel)}_setupEventListeners(){document.addEventListener("click",e=>{this.isVisible&&(this.panel.contains(e.target)||this.currentTarget&&this.currentTarget.contains(e.target)||this.hide())}),document.addEventListener("keydown",e=>{"Escape"===e.key&&this.isVisible&&this.hide()}),window.addEventListener("scroll",()=>{this.isVisible&&this.currentTarget&&this._updatePosition()},!0),window.addEventListener("resize",()=>{this.isVisible&&this.currentTarget&&this._updatePosition()})}show(e,t,a={}){if(e){if(this.isVisible&&this.hide(),this.currentTarget=e,this.closeCallback=a.onClose||null,this.options={align:a.align||"left",offsetY:void 0!==a.offsetY?a.offsetY:5,offsetX:a.offsetX||0},this.contentContainer.innerHTML="","string"==typeof t)this.contentContainer.innerHTML=t;else{if(!(t instanceof HTMLElement))return void console.error("DropdownPanel: Invalid content type");this.contentContainer.appendChild(t)}this.panel.style.display="block",this.isVisible=!0,this._updatePosition(),this.panel.dispatchEvent(new CustomEvent("dropdown:show",{detail:{target:e}}))}else console.error("DropdownPanel: targetElement is required")}_updatePosition(){if(!this.currentTarget)return;const e=this.currentTarget.getBoundingClientRect(),t=this.panel.getBoundingClientRect(),a=window.innerWidth,n=window.innerHeight;let s=0,r=e.bottom+this.options.offsetY;switch(this.options.align){case"right":s=e.right-t.width+this.options.offsetX;break;case"center":s=e.left+(e.width-t.width)/2+this.options.offsetX;break;default:s=e.left+this.options.offsetX}s+t.width>a&&(s=a-t.width-10),s<10&&(s=10),r+t.height>n&&(r=e.top-t.height-this.options.offsetY,r<10&&(r=10,this.panel.style.maxHeight=n-20+"px")),this.panel.style.left=s+"px",this.panel.style.top=r+"px"}hide(){if(!this.isVisible)return;this.panel.style.display="none",this.isVisible=!1,this.contentContainer.innerHTML="",this.closeCallback&&(this.closeCallback(),this.closeCallback=null);const e=this.currentTarget;this.currentTarget=null,this.panel.dispatchEvent(new CustomEvent("dropdown:hide",{detail:{target:e}}))}isOpen(){return this.isVisible}static getInstance(){return x.instance||new x,x.instance}setContent(e){this.contentContainer.innerHTML="","string"==typeof e?this.contentContainer.innerHTML=e:e instanceof HTMLElement&&this.contentContainer.appendChild(e),this.isVisible&&this._updatePosition()}getContentContainer(){return this.contentContainer}static destroy(){x.instance&&(x.instance.panel&&x.instance.panel.remove(),x.instance=null)}},"instance",null),__publicField(x,"currentOwner",null),x);"undefined"!=typeof window&&("loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{Ee.getInstance()}):Ee.getInstance()),window.DropdownPanel=Ee;let Se=(T=class extends ElementFactory{static extractCustomConfig(e,t,a){var n,s,r,i,o,l,c,d;return{autocomplete:{enabled:void 0!==a.autocomplete?"true"===a.autocomplete:null==(n=t.autocomplete)?void 0:n.enabled,source:a.source||(null==(s=t.autocomplete)?void 0:s.source),minLength:this.parseNumeric("minLength",e,t.autocomplete,a)||(null==(r=t.autocomplete)?void 0:r.minLength),maxResults:this.parseNumeric("maxResults",e,t.autocomplete,a)||(null==(i=t.autocomplete)?void 0:i.maxResults),delay:this.parseNumeric("delay",e,t.autocomplete,a)||(null==(o=t.autocomplete)?void 0:o.delay),level:a.hierarchy||a.level||(null==(l=t.autocomplete)?void 0:l.level),dependent:a.dependent||(null==(c=t.autocomplete)?void 0:c.dependent),callback:a.callback?window[a.callback]:null==(d=t.autocomplete)?void 0:d.callback},formatter:a.formatter?window[a.formatter]:t.formatter,searchApi:a.searchApi||null,searchField:a.searchField||null}}static setupElement(e){const{config:t,element:a}=e,n=t.autocomplete;if(a.dataset.pendingOptions)try{const e=JSON.parse(a.dataset.pendingOptions);n.source=e,delete a.dataset.pendingOptions}catch(l){console.error("Failed to parse pending options:",l)}const s=this.readFromDatalist(a);s&&(n.source=s),n.source&&(n.enabled=!0),a.hasAttribute("data-hierarchy")&&(n.enabled=!0),a.hasAttribute("data-options-key")&&(n.enabled=!0);const r=a.getAttribute("name")||"";if(!!r&&(n.enabled||!!n.source||!!s||a.hasAttribute("data-hierarchy")||a.hasAttribute("data-options-key"))){e.hiddenInput=document.createElement("input"),e.hiddenInput.type="hidden",e.hiddenInput.setAttribute("name",r),a.parentNode.insertBefore(e.hiddenInput,a.nextSibling),a.setAttribute("name",`${r}_text`);try{const t=a.form||a.closest&&a.closest("form");if(t&&window.FormManager&&"function"==typeof FormManager.getInstanceByElement){const a=FormManager.getInstanceByElement(t);if(a)try{a.elements.set(r,e.hiddenInput),a.state.data[r]=e.hiddenInput.value||""}catch(l){}}}catch(l){}}const i=a.value;i&&n.source&&this.setInitialValue(e,i),e.hide=()=>{},e.highlightItem=()=>{},e.populate=()=>{},e.selectItem=()=>{},e.escapeRegExp=e=>e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),n.enabled&&this.setupAutocomplete(e),e.validateSpecific=function(e){var a;const n={...T.validators,...window.validators||{},...this.validators||{}};for(const s of this.validationRules||[]){const r="string"==typeof s?s:s.name;if(["minLength","maxLength","pattern","required"].includes(r))console.warn(`"${r}" should be set as a DOM property`);else if(n[r]&&!n[r](e))return(null==(a=t.validationMessages)?void 0:a[r])||"Invalid value"}return null},t.formatter&&EventSystemManager.addHandler(a,"change",()=>{a.value=t.formatter(a.value)}),a.hasAttribute("data-hierarchy")&&HierarchicalTextFactory.register(e),this.setupEventListeners(e);const o=e.destroy;return e.destroy=function(){var e;try{if((null==(e=this.dropdownPanel)?void 0:e.isOpen())&&this.dropdownPanel.currentTarget===a&&this.dropdownPanel.hide(),this.dropdown&&(this.dropdown=null),this.hiddenInput&&this.hiddenInput.parentNode){const e=this.hiddenInput.getAttribute("name");e&&a.getAttribute("name")===`${e}_text`&&a.setAttribute("name",e);try{const t=a.form||a.closest&&a.closest("form");if(t&&window.FormManager&&"function"==typeof FormManager.getInstanceByElement){const a=FormManager.getInstanceByElement(t);if(a&&a.elements&&a.elements.has(e))try{a.elements.delete(e)}catch(l){}}}catch(l){}this.hiddenInput.parentNode.removeChild(this.hiddenInput),this.hiddenInput=null}try{window.HierarchicalTextFactory&&"function"==typeof HierarchicalTextFactory.unregister&&HierarchicalTextFactory.unregister(this)}catch(l){}}catch(t){console.warn("Error during TextElementFactory.destroy",t)}if("function"==typeof o)try{o.call(this)}catch(l){console.warn("Original destroy threw",l)}return this},e}static readFromDatalist(e){const t=e.getAttribute("list");if(!t)return null;const a=document.getElementById(t);if(!a)return null;const n=Array.from(a.querySelectorAll("option")),s=[];return n.forEach(e=>{const t=e.label||e.textContent,a=e.value||t;s.push({value:a,text:t})}),e.removeAttribute("list"),a.remove(),s.length>0?s:null}static setInitialValue(e,t){const{config:a,element:n,hiddenInput:s}=e,r=a.autocomplete;if(r.source){const a=this.normalizeSource(r.source);if(!a)return;for(const r of a)if(r.value===t||r.text===t)return n.value=r.text,s.value=r.value,void(e.selectedValue=r.value)}s.value=""}static setupAutocomplete(e){const{element:t,config:a,hiddenInput:n}=e,s=a.autocomplete;e.selectedValue=null,e.dropdownPanel=DropdownPanel.getInstance(),e.dropdown=document.createElement("ul"),e.dropdown.className="autocomplete-list",e.list=[],e.listIndex=0,e.populate=a=>{if(document.activeElement!==t&&!e._isActive)return;e.dropdown.innerHTML="",e.list=[];const n=t.value.trim(),r=new RegExp(`(${e.escapeRegExp(n)})`,"gi");let i=0;const o=T.normalizeSource(a);if(o){for(const t of o){if(i>=s.maxResults)break;if(!n||r.test(t.text)){const a=e.createListItem(t.value,t.text,n);e.list.push(a),e.dropdown.appendChild(a),i++}}e.highlightItem(0),e.list.length?e.show():e.hide()}},e.show=()=>{e.dropdownPanel.show(t,e.dropdown,{align:"left",offsetY:2,onClose:()=>{}})},e.hide=()=>{e.dropdownPanel.isOpen()&&e.dropdownPanel.currentTarget===t&&e.dropdownPanel.hide()},e.escapeRegExp=e=>e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),e.createListItem=(t,a,n)=>{const r=document.createElement("li");if(r.dataset.key=t,"function"==typeof s.callback)try{const e=s.callback({key:t,value:a,search:n,level:s.level}),appendStringSafely=e=>{const t=document.createElement("div");/<[a-z][\s\S]*>/i.test(e)?t.innerHTML=e:t.textContent=e,r.appendChild(t)};e instanceof Node?r.appendChild(e):Array.isArray(e)?e.forEach(e=>{e instanceof Node?r.appendChild(e):appendStringSafely(String(e))}):"string"==typeof e?appendStringSafely(e):null!=e&&appendStringSafely(String(e))}catch(i){console.warn("Autocomplete callback error:",i);const e=document.createElement("span");e.textContent=a,r.appendChild(e)}else{const t=document.createElement("span");if(n){const s=new RegExp(e.escapeRegExp(n),"gi"),r=a.split(s),i=a.match(s)||[];r.forEach((e,a)=>{if(e&&t.appendChild(document.createTextNode(e)),a<i.length){const e=document.createElement("em");e.textContent=i[a],t.appendChild(e)}})}else t.textContent=a;r.appendChild(t)}return r.addEventListener("mousedown",()=>e.selectItem(t,a)),r.addEventListener("mousemove",()=>e.highlightItem(e.list.indexOf(r))),r},e.highlightItem=t=>{e.listIndex=Math.max(0,Math.min(e.list.length-1,t)),e.list.forEach((t,a)=>t.classList.toggle("active",a===e.listIndex)),e.scrollToItem()},e.scrollToItem=()=>{const t=e.list[e.listIndex];if(t){const a=e.dropdown.getBoundingClientRect(),n=t.getBoundingClientRect();n.top<a.top?e.dropdown.scrollTop=t.offsetTop:n.bottom>a.bottom&&(e.dropdown.scrollTop=t.offsetTop-a.height+n.height)}},e.selectItem=(s,r)=>{const i=e.list.find(e=>e.dataset.key===s);if(i&&i.dataset.hierarchicalData)T.selectHierarchicalItem(e,s,r);else if(e.manager&&"function"==typeof e.manager.isReverseSearchSelection&&e.manager.isReverseSearchSelection(e)){e.manager.handleReverseSelection(e,s,r),e.hide(),t.dispatchEvent(new Event("change",{bubbles:!0}));try{e.hiddenInput&&e.hiddenInput.dispatchEvent(new Event("change",{bubbles:!0}))}catch(o){}try{a&&"function"==typeof a.onChange&&a.onChange(t,r)}catch(o){console.warn("Error in onChange handler (selectItem):",o)}}else{t.value=r,n.value=s,e.selectedValue=s,e.hide(),t.dispatchEvent(new Event("change",{bubbles:!0}));try{e.hiddenInput&&e.hiddenInput.dispatchEvent(new Event("change",{bubbles:!0}))}catch(o){}e.manager&&e.manager.onSelectionChange(e);try{a&&"function"==typeof a.onChange&&a.onChange(t,r)}catch(o){console.warn("Error in onChange handler (selectItem):",o)}}}}static loadFromAjax(e,t,a=""){if(!window.http||"function"!=typeof window.http.get)return console.error("[TextElementFactory] HttpClient (window.http) is required but not available"),void alert("System error: HttpClient not loaded. Please refresh the page.");let n=t;if(a){const e=t.includes("?")?"&":"?";n=`${t}${e}q=${encodeURIComponent(a)}`}window.http.get(n,{throwOnError:!1}).then(t=>{t&&t.success?e.populate(t.data):console.error("[TextElementFactory] Failed to load data:",n,t)}).catch(e=>{console.error("[TextElementFactory] Ajax error:",e)})}static searchHierarchical(e,t){const{config:a,element:n}=e;if(!a.searchApi||!a.searchField)return void console.warn("[TextElementFactory] searchApi or searchField not configured");if(!window.http||"function"!=typeof window.http.post)return void console.error("[TextElementFactory] HttpClient (window.http) is required but not available");const s=new FormData;s.append("query",t),s.append("field",a.searchField),window.http.post(a.searchApi,s,{throwOnError:!1}).then(t=>{var a;if(t&&t.success&&t.data){const n=(null==(a=t.data.data)?void 0:a.results)||t.data.results;n&&n.length>0?(e._hierarchicalData=n,T.populateHierarchical(e,n)):e.hide()}else e.hide()}).catch(t=>{console.error("[TextElementFactory] Hierarchical search error:",t),e.hide()})}static populateHierarchical(e,t){const{element:a,config:n}=e,s=n.autocomplete;(document.activeElement===a||e._isActive)&&(e.dropdown.innerHTML="",e.list=[],t.forEach((t,a)=>{var n,r;if(a>=s.maxResults)return;const i=(null==(r=null==(n=t.data)?void 0:n.province)?void 0:r.value)||a,o=e.createListItem(i,t.text,"");o.dataset.hierarchicalData=JSON.stringify(t),e.list.push(o),e.dropdown.appendChild(o)}),e.highlightItem(0),e.list.length?e.show():e.hide())}static selectHierarchicalItem(e,t,a){const{element:n,config:s,hiddenInput:r}=e,i=e.list.find(e=>e.dataset.key===t);if(i&&i.dataset.hierarchicalData)try{const s=JSON.parse(i.dataset.hierarchicalData).data,o=n.getAttribute("name").replace("_text","");s[o]&&(n.value=s[o].text||a,r.value=s[o].value||t,e.selectedValue=s[o].value||t);const l=n.closest("form");if(l){if(l.querySelectorAll('input[data-search-api][data-autocomplete="true"]').forEach(e=>{if(e===n)return;const t=e.getAttribute("name").replace("_text",""),a=s[t];if(a&&a.value&&a.text){e.value=a.text;const n=(e.getAttribute("name").includes("_text"),t),s=l.querySelector(`input[type="hidden"][name="${n}"]`);s&&(s.value=a.value)}}),s.zipcode){const e=l.querySelector('input[name="zipcode"]');e&&(e.value=s.zipcode.value||s.zipcode.text)}}e.hide(),n.dispatchEvent(new Event("change",{bubbles:!0})),r&&r.dispatchEvent(new Event("change",{bubbles:!0}))}catch(o){console.error("[TextElementFactory] Error parsing hierarchical data:",o)}else console.warn("[TextElementFactory] No hierarchical data found for selection")}static setupEventListeners(e){const{element:t,config:a,hiddenInput:n}=e,s=a.autocomplete;if(super.setupEventListeners(e),e._autocompleteListenersSetup)return;e._autocompleteListenersSetup=!0;const r=Utils.function.debounce(t=>{s.enabled&&(t.length<s.minLength?e.hide():a.searchApi&&a.searchField?T.searchHierarchical(e,t):e.manager?e.manager.search(e,t):"string"==typeof s.source&&(s.source.startsWith("http")||s.source.startsWith("/")||s.source.startsWith("api/"))?T.loadFromAjax(e,s.source,t):e.populate(s.source))},s.delay);EventSystemManager.addHandler(t,"input",i=>{const o=i.target.value.trim();n&&(n.value=o),e.selectedValue=null,r(o);try{!s.enabled&&a&&"function"==typeof a.onChange&&a.onChange(t,o)}catch(l){console.warn("Error in onChange handler (input):",l)}}),EventSystemManager.addHandler(t,"focus",()=>{if(e._isActive=!0,s.enabled)if(e.manager&&"function"==typeof e.manager.search)e.manager.search(e,t.value.trim());else if(s.source)if("string"==typeof s.source&&window[s.source])e.populate(window[s.source]);else if("string"==typeof s.source&&(s.source.startsWith("http")||s.source.startsWith("/")||s.source.startsWith("api/"))){const a=t.value.trim();a.length>=s.minLength&&this.loadFromAjax(e,s.source,a)}else e.populate(s.source)}),EventSystemManager.addHandler(t,"keydown",a=>{var n;if((null==(n=e.dropdownPanel)?void 0:n.isOpen())&&e.dropdownPanel.currentTarget===t)switch(a.key){case"ArrowDown":e.highlightItem(e.listIndex+1),a.preventDefault(),a.stopPropagation();break;case"ArrowUp":e.highlightItem(e.listIndex-1),a.preventDefault(),a.stopPropagation();break;case"Enter":const t=e.list[e.listIndex];if(t){const a=t.textContent||t.innerText,n=t.dataset.key;e.selectItem(n,a)}a.preventDefault(),a.stopPropagation();break;case"Escape":"function"==typeof e.hide&&e.hide(),a.preventDefault(),a.stopPropagation()}}),EventSystemManager.addHandler(t,"blur",t=>{e._isActive=!1,setTimeout(()=>{var t;const a=null==(t=e.dropdownPanel)?void 0:t.panel;e._isActive||a&&a.contains(document.activeElement)||"function"==typeof e.hide&&e.hide()},200)})}static updateOptions(e,t){const a=null==ElementManager?void 0:ElementManager.getInstanceByElement(e);if(!a||!a.config)return void(e.dataset.pendingOptions=JSON.stringify(t));const n=a.config.autocomplete;n.source=t,n.enabled||(n.enabled=!0,this.setupAutocomplete(a))}static populateFromOptions(e,t,a){if(!e||!t||!a)return;let n=t[a];if(!n)return;if(!Array.isArray(n))return void console.warn('[TextElementFactory] Options must be an Array. Expected format: [{value: "1", text: "Option 1"}, ...]');if(n.some(e=>"object"!=typeof e||!("value"in e)||!("text"in e)))return void console.warn("[TextElementFactory] Invalid option format. Each item must have {value: string, text: string}");const s=e.value;if(this.updateOptions(e,n),s){const t=n.find(e=>e.value==s||e.text==s||String(e.value)===String(s)||String(e.text)===String(s));if(t){e.value=t.text;const a=null==ElementManager?void 0:ElementManager.getInstanceByElement(e);(null==a?void 0:a.hiddenInput)&&(a.hiddenInput.value=t.value,a.selectedValue=t.value)}else e.value=s}}static populateFromOptionsInContainer(e,t){if(!e||!t)return;e.querySelectorAll("input[data-options-key]").forEach(e=>{const a=e.dataset.optionsKey;this.populateFromOptions(e,t,a)})}static applyInitialValuesInContainer(e){if(!e)return;e.querySelectorAll("input[data-options-key], select[data-options-key]").forEach(e=>{const t=null==ElementManager?void 0:ElementManager.getInstanceByElement(e);if(t&&t.config&&t.config.autocomplete&&t.config.autocomplete.source){const a=e.value;a&&this.setInitialValue(t,a)}})}static normalizeSource(e){if(!e)return null;if("string"==typeof e){if(/^(https?:\/\/|\/|api\/)/i.test(e))return null;try{if("undefined"!=typeof window&&window[e])e=window[e];else try{e=JSON.parse(e)}catch(t){}}catch(t){}}if(Array.isArray(e))return e.map(e=>{if(Array.isArray(e)&&e.length>=2)return{value:String(e[0]),text:String(e[1])};if(e&&"object"==typeof e){const t=void 0!==e.value?e.value:e.id??e.key??e.name??"",a=e.text??e.label??e.name??t;return{value:String(t),text:String(a)}}const t=String(e);return{value:t,text:t}});if(e instanceof Map){const t=[];for(const[a,n]of e.entries()){const e=String(a),s=String(n&&"object"==typeof n?n.text||n.label||n.name||a:n);t.push({value:e,text:s})}return t}return"object"==typeof e&&null!==e?void 0!==e.success&&Array.isArray(e.data)?T.normalizeSource(e.data):Object.entries(e).map(([e,t])=>({value:String(e),text:String(t&&"object"==typeof t?t.text||t.label||t.name||e:t)})):(console.warn("[TextElementFactory] Invalid source format. Expected Array, Map, or Object."),null)}},__publicField(T,"config",{type:"text",autocomplete:{enabled:!1,source:null,minLength:2,maxResults:10,delay:300,level:null,dependent:null,callback:null},validationMessages:{email:"Please enter a valid email address",url:"Please enter a valid URL",number:"Please enter a valid number",integer:"Please enter a whole number",alpha:"Only letters are allowed",alphanumeric:"Only letters and numbers are allowed",usernameOrEmail:"Please enter a valid username or email"},formatter:null}),__publicField(T,"validators",{email:e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),url:e=>/^(https?|ftp):\/\/[^\s\/$.?#].[^\s]*$|^www\.[^\s\/$.?#].[^\s]*$|^[^\s\/$.?#].[^\s]*\.[a-z]{2,}(\/[^\s]*)?$/.test(e),number:e=>/^-?\d*\.?\d+$/.test(e),integer:e=>/^-?\d+$/.test(e),alpha:e=>/^[a-zA-Z]+$/.test(e),alphanumeric:e=>/^[a-zA-Z0-9]+$/.test(e),usernameOrEmail:e=>/^[a-zA-Z0-9_]+$/.test(e)||/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}),T);window.TextElementFactory=Se;class HierarchicalTextFactory extends ElementFactory{static getGroup(e){const t=e.element.closest("form")||document.body;return this.groups.has(t)||this.groups.set(t,{instances:[],dataCache:null}),this.groups.get(t)}static register(e){e.manager=this;const t=this.getGroup(e);t.instances.push(e);const a=e.config.autocomplete.source;a&&!this.dataCache?this.loadData(a):this.dataCache&&(t.dataCache=this.dataCache)}static loadData(e){if("string"==typeof e&&window[e])return this.dataCache=window[e],void this.syncDataToGroups();"string"==typeof e&&(e.startsWith("http")||e.startsWith("/")||e.endsWith(".json")||e.includes("/"))&&(window.http&&"function"==typeof window.http.get?window.http.get(e,{throwOnError:!1}).then(t=>{t&&t.success||t&&!t.success&&t.data?(this.dataCache=t.data,this.syncDataToGroups()):console.error("[HierarchicalTextFactory] Failed to load hierarchical data:",e,t)}).catch(e=>{console.error("[HierarchicalTextFactory] Error loading hierarchical data:",e)}):fetch(e).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.json()}).then(e=>{this.dataCache=e,this.syncDataToGroups()}).catch(e=>{console.error("[HierarchicalTextFactory] Error loading hierarchical data:",e)}))}static syncDataToGroups(){this.groups.forEach(e=>{e.dataCache=this.dataCache})}static getInstancesInGroup(e){return this.getGroup(e).instances}static getLevelInGroup(e){return this.getInstancesInGroup(e).findIndex(t=>t===e)}static getInstanceByLevelInGroup(e,t){return this.getInstancesInGroup(e)[t]}static onSelectionChange(e){const t=this.getInstancesInGroup(e),a=t.findIndex(t=>t===e);if(-1!==a)for(let n=a+1;n<t.length;n++)t[n].element.value="",t[n].selectedValue=null,t[n].hiddenInput&&(t[n].hiddenInput.value="")}static search(e,t){var a;const n=this.getInstancesInGroup(e),s=n.findIndex(t=>t===e),r=n.length;if(this.dataCache)if(0===s)e.populate(this.dataCache);else{let i=this.dataCache,o=!0;for(let e=0;e<s;e++){const t=null==(a=n[e])?void 0:a.selectedValue;if(!(t&&i&&i[t])){o=!1;break}i=i[t]}o&&i?e.populate(i):t&&t.length>=1?this.reverseSearch(e,t,s,r):e.populate({})}}static reverseSearch(e,t,a,n){if(!t||!this.dataCache)return;const s=new RegExp(e.escapeRegExp(t),"gi"),r=[],traverse=(e,t=[],n=0)=>{if(n===a)for(let a in e){const n=e[a];"object"!=typeof n||null===n?s.test(n)&&r.push({path:[...t],key:a,value:n,isLeaf:!0}):s.test(a)&&r.push({path:[...t],key:a,value:a,isLeaf:!1,children:n})}else if(n<a&&"object"==typeof e&&null!==e)for(let a in e)traverse(e[a],[...t,a],n+1)};traverse(this.dataCache);const i={};r.forEach(e=>{const t=e.path.slice().reverse().join(", "),a=e.isLeaf?e.value:e.key;let n;n=e.isLeaf?e.key:[...e.path,e.key].join("||"),i[n]=t?`${a} (${t})`:a}),e._pendingReverseData=r,e._pendingReverseLevel=a,e._pendingReverseTotalLevels=n,e.populate(i)}static handleReverseSelection(e,t,a){const n=this.getInstancesInGroup(e),s=e._pendingReverseData;if(e._pendingReverseLevel,!s||!Array.isArray(s))return;let r=null;for(const i of s){let e;if(e=i.isLeaf?i.key:[...i.path,i.key].join("||"),e===t){r=i;break}}if(!r)return;r.path.forEach((e,t)=>{n[t]&&(n[t].element.value=e,n[t].selectedValue=e,n[t].hiddenInput&&(n[t].hiddenInput.value=e))}),r.isLeaf?(e.element.value=r.value,e.selectedValue=r.key,e.hiddenInput&&(e.hiddenInput.value=r.key)):(e.element.value=r.key,e.selectedValue=r.key,e.hiddenInput&&(e.hiddenInput.value=r.key));for(let i=n.findIndex(t=>t===e)+1;i<n.length;i++)n[i]&&(n[i].element.value="",n[i].selectedValue=null,n[i].hiddenInput&&(n[i].hiddenInput.value=""));e._pendingReverseData=null,e._pendingReverseLevel=null,e._pendingReverseTotalLevels=null}static isReverseSearchSelection(e){return null!=e._pendingReverseData}}__publicField(HierarchicalTextFactory,"groups",new Map),__publicField(HierarchicalTextFactory,"dataCache",null);class EmailElementFactory extends Se{}__publicField(EmailElementFactory,"config",{...Se.config,type:"text",inputMode:"email",validation:["email"],formatter:e=>e.toLowerCase()});class UrlElementFactory extends Se{}__publicField(UrlElementFactory,"config",{...Se.config,type:"text",inputMode:"url",validation:["url"]});class UsernameElementFactory extends Se{}__publicField(UsernameElementFactory,"config",{...Se.config,type:"text",inputMode:"text",validation:["usernameOrEmail"],formatter:e=>e.toLowerCase()}),ElementManager.registerElement("text",Se),ElementManager.registerElement("email",EmailElementFactory),ElementManager.registerElement("url",UrlElementFactory),ElementManager.registerElement("username",UsernameElementFactory);class MaskElementFactory extends ElementFactory{static setupElement(e){const{element:t}=e;return this.setupMask(e),e.mask?(e.mask.inputMode&&(t.inputMode=e.mask.inputMode),!t.placeholder&&e.mask.placeholder&&(t.placeholder=e.mask.placeholder),e):e}static setupEventListeners(e){const{element:t,config:a}=e,n={input:n=>{const s=t.selectionStart,r=t.value;if(e.mask&&a.maskOnChange){const a=this._privateState.get(t),n=a&&void 0!==a.preserveCursorPos,i=(null==a?void 0:a.previousValue)||"";null==a||a.previousCursor;const o=this.formatValue(r,e.mask,i,s);if(o.formatted!==r&&(t.value=o.formatted),a?(a.previousValue=o.formatted,a.previousCursor=s,this._privateState.set(t,a)):this._privateState.set(t,{previousValue:o.formatted,previousCursor:s}),n){const e=a.preserveCursorPos;delete a.preserveCursorPos,this._privateState.set(t,a),t.setSelectionRange(e,e)}else if(o.formatted!==r&&void 0!==o.newCursorPos&&(setTimeout(()=>{t.setSelectionRange(o.newCursorPos,o.newCursorPos)},0),e.mask.groupSizes&&e.mask.separators)){let a=0;for(let n=0;n<e.mask.groupSizes.length-1;n++)if(a+=e.mask.groupSizes[n],s===a){if(t.value.substring(0,s).replace(/[^0-9a-zA-Z]/g,"").length===e.mask.groupSizes.slice(0,n+1).reduce((e,t)=>e+t,0)){setTimeout(()=>{t.setSelectionRange(s+1,s+1)},0);break}}}const l=this._privateState.get(t);l&&(l.modified=!0),e.validate(o.formatted,!1)}},change:a=>{const n=e.validate(t.value,!0);n!==t.value&&(t.value=n)},focus:n=>{e.mask&&setTimeout(()=>{if(t.value){if(e.mask.placeholder){const e=a.placeholderChar,n=t.value.indexOf(e);if(n>-1)return void t.setSelectionRange(n,n)}e.mask.groupSizes&&e.mask.groupSizes.length&&t.setSelectionRange(0,e.mask.groupSizes[0])}else t.setSelectionRange(0,0)},10),FormError.clearFieldError(t.id)},blur:n=>{if(e.mask&&a.maskOnBlur){const a=this.formatValue(t.value,e.mask);a.formatted!==t.value&&(t.value=a.formatted),e.validate(a.formatted,!0)}},keydown:a=>{if(!e.mask)return;if("Backspace"===a.key){const n=t.selectionStart,s=t.selectionEnd,r=t.value,{separators:i}=e.mask;if(n!==s)return;if(0===n)return;const o=r[n-1];if(i&&i.some(e=>e===o)&&n>=2){a.preventDefault();const e=n-2,s=r.substring(0,e)+r.substring(n);t.value=s;const i=this._privateState.get(t)||{};return i.preserveCursorPos=e,this._privateState.set(t,i),void t.dispatchEvent(new Event("input",{bubbles:!0}))}{a.preventDefault();const e=n-1,s=r.substring(0,e)+r.substring(n);t.value=s;const i=this._privateState.get(t)||{};return i.preserveCursorPos=e,this._privateState.set(t,i),void t.dispatchEvent(new Event("input",{bubbles:!0}))}}if("Delete"===a.key){const n=t.selectionStart,s=t.selectionEnd,r=t.value,{separators:i}=e.mask;if(n!==s)return;if(n>=r.length)return;const o=r[n];if(i&&i.some(e=>e===o)&&n+1<r.length){a.preventDefault();const e=r.substring(0,n)+r.substring(n+2);t.value=e;const s=this._privateState.get(t)||{};return s.preserveCursorPos=n,this._privateState.set(t,s),void t.dispatchEvent(new Event("input",{bubbles:!0}))}{a.preventDefault();const e=r.substring(0,n)+r.substring(n+1);t.value=e;const s=this._privateState.get(t)||{};return s.preserveCursorPos=n,this._privateState.set(t,s),void t.dispatchEvent(new Event("input",{bubbles:!0}))}}if(1!==a.key.length||a.ctrlKey||a.altKey||a.metaKey||["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Tab","Escape","Enter"].includes(a.key))return;const n=t.selectionStart,s=t.value,{mask:r,separators:i}=e.mask;let o=0;for(let e=0;e<n&&0<r.length;e++){i&&i.some(t=>s[e]===t)||o++}let l=0,c=0;for(;l<r.length&&c<o;){const e=r[l];this.config.inputPatterns[e]&&c++,l++}for(;l<r.length;){const e=r[l],t=this.config.inputPatterns[e];if(t)return void(t.test(a.key)||a.preventDefault());l++}}};EventSystemManager.addHandler(t,"input",n.input),EventSystemManager.addHandler(t,"change",n.change),EventSystemManager.addHandler(t,"focus",n.focus),EventSystemManager.addHandler(t,"blur",n.blur),EventSystemManager.addHandler(t,"keydown",n.keydown)}static setupMask(e){const{element:t,config:a}=e;let n=null;if(a.mask&&"object"==typeof a.mask?n={...a.mask}:a.format&&this.config.masks[a.format]?n={...this.config.masks[a.format]}:a.pattern&&(n={mask:a.pattern,placeholder:a.placeholder||a.pattern.replace(/[9A*#X]/g,this.config.placeholderChar),inputMode:a.inputMode||"text"}),!n||!n.mask)return;const s=this.calculateMaskStructure(n.mask);n.separators=s.separators,n.groups=s.groups,n.groupSizes=s.groupSizes,n.allowPartial=n.allowPartial??this.config.allowPartial,n.format=a.format,a.placeholder&&(n.placeholder=a.placeholder),e.mask=n,a.formatter=e=>{const{formatted:a,newCursorPos:s}=this.formatValue(e,n);return t.setSelectionRange(s,s),a},e.validateSpecific=function(e){if(n.validator){if(!new RegExp(n.validator).test(e))return Now.translate("Invalid value")}return null}}static calculateMaskStructure(e){const t=Object.keys(this.config.inputPatterns);let a=[],n="",s=[];for(let i=0;i<e.length;i++){const r=e[i];t.includes(r)?n+=r:(a.push(n),n="",i<e.length&&s.push(r))}n&&a.push(n);const r=a.map(e=>e.length);return{separators:s,groups:a,groupSizes:r}}static formatValue(e,t,a="",n=0){const{mask:s,allowPartial:r,separators:i,groupSizes:o}=t;if(!e||""===e.trim())return{formatted:"",newCursorPos:0};let l="",c=0;for(let g=0;g<e.length;g++){const t=e[g];i&&i.some(e=>e===t)||(l+=t,g<n&&c++)}let d="",u=0,h=0,p=0,m=s[u];for(;m&&h<l.length;){const e=l[h],t=this.config.inputPatterns[m];if(t){if(!e||!t.test(e)){h++;continue}d+=e,h++,h===c&&(p=d.length)}else d+=m,h===c&&p<d.length&&(p=d.length);u++,m=s[u]}return(0===p||c>=l.length)&&(p=d.length),{formatted:d,newCursorPos:p}}}__publicField(MaskElementFactory,"config",{maskOnInit:!0,maskOnChange:!0,maskOnBlur:!0,unmaskOnSubmit:!1,placeholderChar:"_",allowPartial:!1,masks:{tel:{mask:"99-9999-9999",placeholder:"__-____-____",inputMode:"tel",validator:"^[0-9]{2}\\-[0-9]{4}\\-[0-9]{3,4}$"},date:{mask:"99/99/9999",format:"xx/xx/xxxx",placeholder:"__/__/____",inputMode:"numeric"},time:{mask:"99:99",format:"xx:xx",placeholder:"__:__",inputMode:"numeric"},datetime:{mask:"99/99/9999 99:99",format:"xx/xx/xxxx xx:xx",placeholder:"__/__/____ __:__",inputMode:"numeric"},creditcard:{mask:"9999-9999-9999-9999",format:"xxxx-xxxx-xxxx-xxxx",placeholder:"____-____-____-____",inputMode:"numeric"},ip:{mask:"999.999.999.999",format:"xxx.xxx.xxx.xxx",placeholder:"___.___.___.___",inputMode:"numeric",allowPartial:!0,validator:"^[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}$"},idcard:{mask:"9-9999-99999-99-9",format:"x-xxxx-xxxxx-xx-x",placeholder:"_-____-_____-__-_",inputMode:"numeric"},zipcode:{mask:"99999",format:"xxxxx",placeholder:"_____",inputMode:"numeric",allowPartial:!0},currency:{mask:"#,###.##",inputMode:"decimal",allowPartial:!0}},inputPatterns:{9:/[0-9]/,a:/[a-zA-Z]/,A:/[a-zA-Z]/,"*":/[a-zA-Z0-9]/,"#":/[0-9.,\-]/,X:/./}});class TelElementFactory extends MaskElementFactory{}__publicField(TelElementFactory,"config",{...MaskElementFactory.config,type:"text",format:"tel",inputMode:"tel"}),ElementManager.registerElement("mask",MaskElementFactory),ElementManager.registerElement("tel",TelElementFactory);const Ce=class _NumberElementFactory extends ElementFactory{static extractCustomConfig(e,t,a){const n={...this.config,...t};return{min:this.parseNumeric("min",e,t,a),max:this.parseNumeric("max",e,t,a),step:this.parseNumeric("step",e,t,a),precision:void 0!==a.precision?parseInt(a.precision):n.precision,decimalSeparator:a.decimalSeparator||n.decimalSeparator||".",groupingSeparator:a.groupingSeparator||n.groupingSeparator||",",useGrouping:void 0!==a.useGrouping?"true"===a.useGrouping:n.useGrouping,allowNegative:void 0!==a.allowNegative?"true"===a.allowNegative:n.allowNegative,roundValues:void 0!==a.roundValues?"true"===a.roundValues:n.roundValues,padToPrecision:void 0!==a.padToPrecision?"true"===a.padToPrecision:n.padToPrecision}}static setupElement(e){const{element:t,config:a}=e,n=t.getAttribute("type");return"number"!==n&&"currency"!==n||(t.type="text",t.setAttribute("inputmode",a.inputMode||"decimal")),e.initValue=e=>_NumberElementFactory.formatNumber(e,a),e.parseNumber=function(e){return _NumberElementFactory.parseNumber(e,a)},e.formatNumber=function(e){return _NumberElementFactory.formatNumber(e,a)},e.setValue=e=>{if(null==e||""===e)return void(t.value="");const n=_NumberElementFactory.formatNumber(e,a);t.value=n},e.validateValue=(e,n)=>{const{formatted:s,error:r}=this.formatValue(e,t,a);return{validatedValue:s,error:r}},a.formatter=e=>this.formatValue(e,t,a),e}static setupEventListeners(e){const{element:t,config:a}=e,n=Utils.function.debounce(()=>e.validate(void 0,!1),300),s={input:()=>{e.state.modified=!0,n()},change:()=>{this.applyFormatting(e)},blur:()=>{this.applyFormatting(e)},focus:()=>{FormError.clearFieldError(t.id);const n=ElementFactory._privateState.get(t);if(n){n.formatting=!0;const s=e.parseNumber(t.value);isNaN(s)||(t.value=s.toString().replace(".",a.decimalSeparator)),n.formatting=!1}},keydown:t=>{if(!this.handleSpecialKeys(t,e))return this.isAllowedKey(t,a)?void 0:(t.preventDefault(),!1)},paste:t=>{if(!this.handlePaste(t,e))return t.preventDefault(),!1}};return Object.entries(s).forEach(([e,a])=>{EventSystemManager.addHandler(t,e,a)}),s}static applyFormatting(e){const{element:t,config:a}=e,n=t.value;if(""===n)return;const s=e.parseNumber(n);if(isNaN(s))return;const r=this.formatNumber(s,a);t.value=r}static handleSpecialKeys(e,t){const{element:a,config:n}=t;if(["Tab","Enter","Escape","ArrowLeft","ArrowRight","Home","End","Delete","Backspace"].includes(e.key))return!0;if(e.ctrlKey&&["a","c","v","x","z"].includes(e.key.toLowerCase()))return!0;if("ArrowUp"===e.key||"ArrowDown"===e.key){e.preventDefault();const s=t.parseNumber(a.value)||0,r=parseFloat(n.step)||1;let i;i="ArrowUp"===e.key?Utils.number.round(s+r,n.precision):Utils.number.round(s-r,n.precision),null!==n.min&&i<n.min&&(i=n.min),null!==n.max&&i>n.max&&(i=n.max);const o=ElementFactory._privateState.get(a);return o&&(o.formatting=!0,a.value=String(i).replace(".",n.decimalSeparator),o.formatting=!1),!0}return!1}static isAllowedKey(e,t){const a=e.key;return!!/^\d$/.test(a)||(a===t.decimalSeparator&&-1===e.target.value.indexOf(t.decimalSeparator)&&0!==t.precision||!("-"!==a||!t.allowNegative||0!==e.target.selectionStart||-1!==e.target.value.indexOf("-")))}static handlePaste(e,t){const{element:a,config:n}=t,s=(e.clipboardData||window.clipboardData).getData("text"),r=a.value,i=a.selectionStart,o=a.selectionEnd,l=r.substring(0,i)+s+r.substring(o),c=(l.match(new RegExp(`\\${n.decimalSeparator}`,"g"))||[]).length;if(c>1||0===n.precision&&c>0)return!1;if(n.allowNegative){const e=(l.match(/-/g)||[]).length;if(e>1||1===e&&0!==l.indexOf("-"))return!1}else if(l.includes("-"))return!1;return!!(n.allowNegative?new RegExp(`^-?\\d*\\${n.decimalSeparator}?\\d*$`):new RegExp(`^\\d*\\${n.decimalSeparator}?\\d*$`)).test(l)}static formatNumber(e,t){if(""===e||null==e)return"";let a="number"==typeof e?e:this.parseNumber(e,t);if(isNaN(a))return"string"==typeof e?e:"";const n=a<0;a=Math.abs(a),!0===t.roundValues&&t.precision>=0&&(a=Utils.number.round(a,t.precision));let s=!0===t.roundValues&&t.precision>=0?a.toFixed(t.precision):a.toString(),[r,i=""]=s.split(".");!0!==t.roundValues&&t.precision>0&&i?i=i.substring(0,t.precision):0===t.precision&&(i=""),t.padToPrecision&&t.precision>0&&(i=(i||"").padEnd(t.precision,"0"));let o=r;if(t.useGrouping){const e=t.groupingSeparator||",";let a="";for(let t=0;t<o.length;t++)t>0&&(o.length-t)%3==0&&(a+=e),a+=o[t];o=a}let l=o;if((i||t.padToPrecision)&&t.precision>0){l+=(t.decimalSeparator||".")+i}return t.showSymbol&&t.symbol&&(l="before"===t.symbolPosition?`${t.symbol}${l}`:`${l}${t.symbol}`),n&&(l=t.negativeWithParentheses?`(${l})`:`-${l}`),l}static formatValue(e,t,a){let n=null;if(""===e||null==e)return t.hasAttribute("required")&&(n=Now.translate("Please fill in")),{formatted:"",error:n};let s=this.parseNumber(e,a);if(isNaN(s))return{formatted:e,error:Now.translate("Please enter a valid number")};!a.allowNegative&&s<0&&(n=Now.translate("Unable to have negative values"),s=Math.abs(s));const r=parseFloat(t.min),i=parseFloat(t.max);null!==r&&s<r&&(n=Now.translate("Value must be at least {min}",{min:r}),s=r),null!==i&&s>i&&(n=Now.translate("Value must be no more than {max}",{max:i}),s=i);return{formatted:this.formatNumber(s,a),error:n}}static parseNumber(e,t){if("number"==typeof e)return isNaN(e)?NaN:e;if(""===e||null==e)return NaN;let a=String(e);return a=a.replace(t.decimalSeparator,".").replace(/[^0-9\.\-\(\)]+/g,""),a.startsWith("(")&&a.endsWith(")")&&(a="-"+a.substring(1,a.length-1)),Number(a)}};__publicField(Ce,"config",{type:"text",inputMode:"decimal",step:1,min:null,max:null,precision:0,padToPrecision:!1,useGrouping:!1,groupingSeparator:",",decimalSeparator:".",allowNegative:!1,roundValues:!1,showSymbol:!1,symbol:"",symbolPosition:"before",negativeWithParentheses:!1,validationMessages:{required:"Please fill in this field",min:"Value must be at least {min}",max:"Value must be no more than {max}",step:"Value must be a multiple of {step}",number:"Please enter a valid number",decimal:"Only one decimal separator is allowed",negative:"Negative sign must be at the start"}}),__publicField(Ce,"propertyHandlers",{min:{get(e){const t=e.getAttribute("min");return null!==t?parseFloat(t):null},set(e,t){null==t?e.element.removeAttribute("min"):e.element.setAttribute("min",t)}},max:{get(e){const t=e.getAttribute("max");return null!==t?parseFloat(t):null},set(e,t){null==t?e.element.removeAttribute("max"):e.element.setAttribute("max",t)}},step:{get(e){const t=e.getAttribute("step");return null!==t?parseFloat(t):1},set(e,t){e.element.setAttribute("step",t)}},precision:{get(e){const t=e.getAttribute("precision");return null!==t?parseFloat(t):0},set(e,t){this.precision!==t&&(e.element.setAttribute("precision",t),e.applyFormatting(e))}}});let Me=Ce;class CurrencyElementFactory extends Me{}__publicField(CurrencyElementFactory,"config",{...Me.config,precision:2,padToPrecision:!0,roundValues:!0,showSymbol:!1,symbol:"",symbolPosition:"before",allowNegative:!0,useGrouping:!0,groupingSeparator:",",decimalSeparator:".",negativeWithParentheses:!1,inputMode:"decimal"}),ElementManager.registerElement("number",Me),ElementManager.registerElement("currency",CurrencyElementFactory);let xe=(A=class extends ElementFactory{static setupElement(e){const{element:t,config:a}=e;if(a.multiple&&(t.multiple=!0),a.size>1&&(t.size=a.size),t.hasAttribute("aria-label")||t.hasAttribute("aria-labelledby")||(a.ariaLabelledBy?t.setAttribute("aria-labelledby",a.ariaLabelledBy):a.label&&(t.setAttribute("aria-label",Now.translate(a.label)),t.dataset.ariaI18n=a.label)),a.placeholder&&(!a.multiple||a.allowPlaceholderSelection)){const e=document.createElement("option");e.value="",e.textContent=Now.translate(a.placeholder),e.dataset.i18n=a.placeholder,a.allowPlaceholderSelection||(e.disabled=!0),e.selected=!0,t.appendChild(e)}a.options&&this.updateOptions(t,a.options,a.useOptGroups),a.url&&this.loadOptions(e,a.url,a.params),a.typeToFilter&&this.setupTypeToFilter(e),e.updateOptions=function(e){A.updateOptions(t,e,a.useOptGroups)},e.loadOptions=function(t,a){return A.loadOptions(e,t,a)},e.clearOptions=function(){A.clearOptions(t,a.placeholder)},e.selectByValue=function(e){t.value=e,t.dispatchEvent(new Event("change",{bubbles:!0}))},e.selectByIndex=function(e){e>=0&&e<t.options.length&&(t.selectedIndex=e,t.dispatchEvent(new Event("change",{bubbles:!0})))};try{this.setupChangeHandler(e)}catch(n){}return e.validateSpecific=function(e){var t;return!this.element.required||e&&""!==e?null:Now.translate((null==(t=this.config.validationMessages)?void 0:t.required)||"This field is required")},e.updateOptionAt=function(e,a){if(e>=0&&e<t.options.length){const n=t.options[e];a.text&&(n.textContent=a.text),void 0!==a.disabled&&(n.disabled=a.disabled),void 0!==a.selected&&(n.selected=a.selected),a.value&&(n.value=a.value)}},e}static setupTypeToFilter(e){const{element:t,config:a}=e;let n,s="",r=null;a.showSearchStatus&&(r=document.createElement("div"),r.className="select-search-status",r.style.display="none",r.setAttribute("aria-live","polite"),r.setAttribute("role","status"),t.parentNode&&t.parentNode.insertBefore(r,t.nextSibling),e.searchStatusElement=r);const handleSearch=e=>{if(1===e.key.length||"Backspace"===e.key){"Backspace"===e.key?s=s.slice(0,-1):s+=e.key.toLowerCase(),clearTimeout(n);const i=Array.from(t.options).filter(e=>!e.disabled&&"OPTGROUP"!==e.parentElement.tagName||!e.parentElement.disabled);if(0===i.length)return;const o=a.searchMethod||"prefix",l=i.find(e=>{const t=e.text.toLowerCase();if("prefix"===o)return t.startsWith(s);if("contains"===o)return t.includes(s);if("fuzzy"===o){let e=0;for(let a=0;a<t.length&&e<s.length;a++)t[a]===s[e]&&e++;return e===s.length}return t.startsWith(s)});l&&(t.value=l.value,(t.size>1||t.multiple)&&(Array.from(t.options).indexOf(l),l.scrollIntoView&&l.scrollIntoView({block:"nearest"})),t.dispatchEvent(new Event("change",{bubbles:!0})),a.showSearchStatus&&r&&(r.textContent=`${Now.translate("Searching")}: ${s}`,r.style.display="block")),n=setTimeout(()=>{s="",a.showSearchStatus&&r&&(r.style.display="none")},a.searchResetDelay)}};EventSystemManager.addHandler(t,"keydown",handleSearch),e._typeToFilterHandler=handleSearch}static async loadOptions(e,t,a={}){var n,s;const{element:r,config:i}=e;try{if(r.disabled=!0,e.wrapper&&e.wrapper.classList.add("loading"),r.parentNode&&i.loadingMessage){const t=document.createElement("option");t.disabled=!0,t.selected=!0,t.textContent=Now.translate(i.loadingMessage||"Loading...");const a=r.innerHTML;r.innerHTML="",r.appendChild(t),e._originalOptions=a}const o={params:a,headers:{Accept:"application/json"}},l=window.ApiService||(null==(s=null==(n=window.Now)?void 0:n.getManager)?void 0:s.call(n,"api"));let c;if(null==l?void 0:l.get)c=await l.get(t,a,{headers:o.headers});else if("undefined"!=typeof simpleFetch&&simpleFetch.get){const e=new URLSearchParams(a).toString(),n=e?`${t}?${e}`:t;c=await simpleFetch.get(n,{headers:o.headers})}else{if("undefined"==typeof http||!http.get)throw new Error("ApiService is not available");c=await http.get(t,o)}c.data&&this.updateOptions(r,c.data,i.useOptGroups);const d=r.dataset.value;return d&&(r.value=d,r.dispatchEvent(new Event("change",{bubbles:!0}))),c.data}catch(o){return"undefined"!=typeof ErrorManager?ErrorManager.handle(o,{context:"SelectElementFactory.loadOptions",type:"error:select",data:{elementId:r.id,url:t,params:a},notify:!0}):window.NotificationManager&&NotificationManager.error("Failed to load options"),e._originalOptions&&(r.innerHTML=e._originalOptions,delete e._originalOptions),null}finally{r.disabled=!1,e.wrapper&&e.wrapper.classList.remove("loading")}}static updateOptions(e,t,a=!1){const n=e.value,s=e.querySelector('option[value=""][disabled]'),r=e.multiple,i=s?e.querySelector('option[value=""][disabled]').outerHTML:"";if(e.innerHTML=i,!t||Array.isArray(t)&&0===t.length||"object"==typeof t&&0===Object.keys(t).length){const t=document.createElement("option");return t.disabled=!0,t.textContent=Now.translate("No options available"),void(i||e.appendChild(t))}const o=(e=>{if(Array.isArray(e))return e;if(e instanceof Map){const t=[];for(const[a,n]of e.entries())"object"==typeof n?t.push({value:a,text:n.text||n.label||n}):t.push({value:a,text:n});return t}if("object"==typeof e&&null!==e){const t=Object.entries(e||{}),a=t.find(([e])=>""===e),n=[],s=[];t.forEach(([e,t])=>{""!==e&&(/^\d+$/.test(e)?s.push([e,t]):n.push([e,t]))}),s.sort((e,t)=>parseInt(e[0],10)-parseInt(t[0],10));const r=[];return a&&r.push({value:"",text:a[1]}),n.forEach(([e,t])=>r.push({value:e,text:t})),s.forEach(([e,t])=>r.push({value:e,text:t})),r}return[]})(t);if(0===o.length){const t=document.createElement("option");return t.disabled=!0,t.textContent=Now.translate("No options available"),void(i||e.appendChild(t))}if(a&&this.hasOptGroups(o)?this.createOptGroups(e,o):o.forEach(t=>this.createOption(e,t)),n&&!r){Array.from(e.options).some(e=>e.value==n||String(e.value)===String(n))&&(e.value=n)}else if(r&&Array.isArray(n)){(Array.isArray(n)?n:[n]).forEach(t=>{const a=Array.from(e.options).find(e=>e.value==t||String(e.value)===String(t));a&&(a.selected=!0)})}e.dispatchEvent(new CustomEvent("optionschanged",{bubbles:!0,detail:{options:t}}))}static clearOptions(e,t=!0){if(t){const t=e.querySelector('option[value=""][disabled]');e.innerHTML=t?t.outerHTML:""}else e.innerHTML="";e.dispatchEvent(new CustomEvent("optionschanged",{bubbles:!0,detail:{options:[]}}))}static hasOptGroups(e){return e.some(e=>"object"==typeof e&&e.options)}static createOptGroups(e,t){let a;t.length>50&&(a=document.createDocumentFragment()),t.forEach(t=>{if("object"==typeof t&&t.options){const n=document.createElement("optgroup");n.label=Now.translate(t.label),t.disabled&&(n.disabled=!0),Array.isArray(t.options)&&t.options.forEach(e=>{this.createOption(n,e)}),a?a.appendChild(n):e.appendChild(n)}else a?this.createOption(a,t):this.createOption(e,t)}),a&&e.appendChild(a)}static createOption(e,t){const a=document.createElement("option");"object"==typeof t?(a.value=void 0!==t.value?t.value:"",a.textContent=Now.translate(t.text||t.label||t.value||""),(t.text||t.label)&&(a.dataset.i18n=t.text||t.label),t.disabled&&(a.disabled=!0),t.selected&&(a.selected=!0),t.data&&Object.entries(t.data).forEach(([e,t])=>{a.dataset[e]=t}),t.className&&(a.className=t.className)):(a.value=t,a.textContent=Now.translate(t),a.dataset.i18n=t),e.appendChild(a)}static setupEventListeners(e){const{element:t,config:a}=e,n=super.setupEventListeners(e),updateTranslations=()=>{Array.from(t.options).forEach(e=>{e.dataset.i18n&&(e.textContent=Now.translate(e.dataset.i18n))}),t.dataset.ariaI18n&&t.setAttribute("aria-label",Now.translate(t.dataset.ariaI18n))};return window.EventManager&&EventManager.on("locale:changed",updateTranslations),e._localeChangeHandler=updateTranslations,n}static setupChangeHandler(e){const{element:t,config:a}=e;try{EventSystemManager.addHandler(t,"change",e=>{try{if(a&&"function"==typeof a.onChange){const e=t.multiple?Array.from(t.selectedOptions).map(e=>e.value):t.value;a.onChange(t,e)}}catch(n){console.warn("SelectElementFactory onChange handler error",n)}})}catch(n){}}static customValidateValue(e,t){const a=this.element;if(a.multiple){const t=Array.from(a.selectedOptions);if(a.required&&0===t.length)return{validatedValue:e,error:Now.translate(this.config.validationMessages.required)}}else if(a.required&&(!e||""===e))return{validatedValue:e,error:Now.translate(this.config.validationMessages.required)};return{validatedValue:e,error:null}}static create(e){return e.tagName="select",super.create(e)}static cleanup(e){var t;if(!e)return;const{element:a}=e;e._typeToFilterHandler&&EventSystemManager.removeHandler(a,"keydown",e._typeToFilterHandler),e._localeChangeHandler&&window.EventManager&&EventManager.off("locale:changed",e._localeChangeHandler),e.searchStatusElement&&e.searchStatusElement.parentNode&&e.searchStatusElement.parentNode.removeChild(e.searchStatusElement),null==(t=super.cleanup)||t.call(this,e)}static populateFromOptions(e,t,a){if(!e||!t||!a)return;let n=t[a];if(!n)return;if(!Array.isArray(n))return void console.warn('Please update your API to return options in format: [{value: "1", text: "Option 1"}, ...]');if(n.some(e=>"object"!=typeof e||!("value"in e)||!("text"in e)))return;const s=e.value;if(this.updateOptions(e,n,"true"===e.dataset.useOptGroups),s){Array.from(e.options).some(e=>e.value==s||String(e.value)===String(s))&&(e.value=s)}}static populateFromOptionsInContainer(e,t){if(!e||!t)return;e.querySelectorAll("select[data-options-key]:not([multiple])").forEach(e=>{const a=e.dataset.optionsKey;this.populateFromOptions(e,t,a)})}},__publicField(A,"config",{...ElementFactory.config,multiple:!1,size:1,typeToFilter:!0,searchMethod:"prefix",searchResetDelay:1e3,showSearchStatus:!1,useOptGroups:!1,allowPlaceholderSelection:!1,optimizeRendering:!0,ariaLabelledBy:null,emptyMessage:"No options available",customTemplate:null,validationMessages:{required:"Please select an option"}}),__publicField(A,"propertyHandlers",{value:{get:e=>e.multiple?Array.from(e.selectedOptions).map(e=>e.value):e.value,set(e,t){var a,n;const{element:s}=e;null==t||""===t?s.selectedIndex=s.querySelector('option[value=""]')?0:-1:s.multiple&&Array.isArray(t)?Array.from(s.options).forEach(e=>{e.selected=t.includes(e.value)}):s.value=String(t),null==(n=(a=e.constructor).syncCustomDropdown)||n.call(a,e)}},options:{get:e=>Array.from(e.options).map(e=>({value:e.value,text:e.textContent,selected:e.selected,disabled:e.disabled})),set(e,t){this.updateOptions(e.element,t,e.config.useOptGroups)}},selectedOption:{get(e){if(e.multiple)return Array.from(e.selectedOptions).map(e=>({value:e.value,text:e.textContent,index:e.index}));const t=e.options[e.selectedIndex];return t?{value:t.value,text:t.textContent,index:e.selectedIndex}:null},set(e,t){if(!t)return;const{element:a}=e;if(Array.isArray(t)&&a.multiple)Array.from(a.options).forEach(e=>e.selected=!1),t.forEach(e=>{const t="object"==typeof e?e.value:e,n=Array.from(a.options).find(e=>e.value===t);n&&(n.selected=!0)});else{const e="object"==typeof t?t.value:t;a.value=e}a.dispatchEvent(new Event("change",{bubbles:!0}))}}}),A);ElementManager.registerElement("select",xe),window.SelectElementFactory=xe;const Te={config:{loadingClass:"loading",ajaxDelay:300,defaultOption:!0,defaultOptionText:"Please select...",autoLoad:!0,autoDisable:!0,placeholders:{},debug:!1},state:{instances:new Map,requests:new Map,initialized:!1},init(e={}){return this.state.initialized||(this.config={...this.config,...e},document.querySelectorAll("[data-cascade]").forEach(e=>{this.create(e)}),this.state.initialized=!0),this},initInContainer(e){if(!e)return;const t=new Map;e.querySelectorAll("select[data-cascade-group]").forEach(e=>{const a=e.dataset.cascadeGroup;t.has(a)||t.set(a,[]),t.get(a).push(e)}),t.forEach((e,t)=>{e.sort((e,t)=>parseInt(e.dataset.cascadeOrder||"0")-parseInt(t.dataset.cascadeOrder||"0"));const a=e.find(e=>e.dataset.cascadeUrl||e.dataset.cascadeAction);if(a){const t=this.extractDataOptions(a);this.create(e,t)}});const a=e.querySelectorAll("select[data-cascade-parent]");if(a.length>0){const t=new Set,n=new Set;a.forEach(e=>{const a=e.dataset.cascadeParent;t.add(e.name||e.id),n.add(a)});[...n].filter(e=>!t.has(e)).forEach(t=>{const a=[],n=e.querySelector(`select[name="${t}"], select#${t}`);if(!n)return;a.push(n);let s=t,r=0;for(;r++<10;){const t=e.querySelector(`select[data-cascade-parent="${s}"]`);if(!t)break;a.push(t),s=t.name||t.id}const i=a.find(e=>e.dataset.cascadeUrl||e.dataset.cascadeAction);if(i&&a.length>1){const e=this.extractDataOptions(i);this.create(a,e)}})}},create(e,t={}){let a=[];if(Array.isArray(e))a=e.map(e=>"string"==typeof e?document.getElementById(e):e).filter(e=>e);else if("string"==typeof e)if(e.includes(","))a=e.split(",").map(e=>document.getElementById(e.trim())).filter(e=>e);else if(e.startsWith("#")){const t=document.getElementById(e.substring(1));t&&a.push(t)}else a=Array.from(document.querySelectorAll(e));else e instanceof HTMLElement&&a.push(e);if(0===a.length)return this.config.debug&&console.warn("CascadingSelectManager: No select elements found"),null;const n=this.extractDataOptions(a[0]),s={...this.config,...n,...t};if(!s.action&&!s.url)return this.config.debug&&console.warn("CascadingSelectManager: No action URL specified"),null;const r=s.groupId||`cascade_${Date.now()}_${Math.floor(1e3*Math.random())}`,i={id:r,elements:a,config:s,state:{loading:!1,initialized:!1,values:{}}};this.state.instances.set(r,i),a.forEach((e,t)=>{0===t&&this.storeOriginalOptions(e),e.dataset.cascadeGroup=r,e.dataset.cascadeIndex=t,e.cascadeInstance=i,t>0&&s.autoLoad&&(this.clearOptions(e,s),s.autoDisable&&(e.disabled=!0)),this.setupSelectEvents(e,i)}),i.state.initialized=!0;const o=a[0];return s.autoLoad&&o.value&&this.loadOptions(o),i},extractDataOptions(e){const t={},a=e.dataset;return a.cascadeAction?t.action=a.cascadeAction:a.cascadeUrl&&(t.url=a.cascadeUrl),a.cascadeParam&&(t.paramName=a.cascadeParam),a.cascadeMethod&&(t.method=a.cascadeMethod.toUpperCase()),void 0!==a.cascadeDefault&&(t.defaultOption="true"===a.cascadeDefault),a.cascadeDefaultText&&(t.defaultOptionText=a.cascadeDefaultText),void 0!==a.cascadeAutoLoad&&(t.autoLoad="true"===a.cascadeAutoLoad),void 0!==a.cascadeDisable&&(t.autoDisable="true"===a.cascadeDisable),a.cascadeCallback&&"function"==typeof window[a.cascadeCallback]&&(t.onchange=window[a.cascadeCallback]),t},storeOriginalOptions(e){e._originalOptions=Array.from(e.options).map(e=>({value:e.value,text:e.textContent,selected:e.selected,disabled:e.disabled}))},setupSelectEvents(e,t){e._changeHandler&&e.removeEventListener("change",e._changeHandler);const changeHandler=a=>{const n=parseInt(e.dataset.cascadeIndex);t.state.values[n]=e.value,n<t.elements.length-1&&this.loadOptions(e),"function"==typeof t.config.onchange&&t.config.onchange.call(e,t),this.emitEvent("cascade:change",{instance:t,element:e,index:n,value:e.value})};e._changeHandler=changeHandler,e.addEventListener("change",changeHandler)},clearOptions(e,t){for(;e.options.length>(t.defaultOption?1:0);)e.remove(t.defaultOption?1:0);if(t.defaultOption)if(0===e.options.length){const a=document.createElement("option");a.value="",a.textContent=t.defaultOptionText,a.disabled=!0,a.selected=!0,e.appendChild(a)}else e.options[0].textContent=t.placeholders[e.id]||e.dataset.placeholder||t.defaultOptionText;e.value=""},async loadOptions(e){const t=parseInt(e.dataset.cascadeIndex),a=e.cascadeInstance,{config:n}=a,s=t+1;if(s>=a.elements.length)return;const r=a.elements[s];if(r){for(let e=s;e<a.elements.length;e++){const t=a.elements[e];this.clearOptions(t,n),n.autoDisable&&(t.disabled=!0),a.state.values[e]="",this.emitEvent("cascade:clear",{instance:a,element:t,index:e})}if(e.value){if(a.state.loading=!0,r.classList.add(n.loadingClass),this.state.requests.has(r)){const e=this.state.requests.get(r);e.abort&&e.abort()}try{const e=new FormData;for(let n=0;n<=t;n++){const t=a.elements[n].name||a.elements[n].id||`select${n}`;e.append(t,a.elements[n].value)}const i=r.name||r.id||`select${s}`;e.append("target",i),n.params&&Object.entries(n.params).forEach(([t,a])=>{e.append(t,a)});const o=n.action||n.url,l=n.method||"POST",c={method:l,headers:{"X-Requested-With":"XMLHttpRequest"}};if("GET"===l){const t=new URLSearchParams;for(const[a,r]of e.entries())t.append(a,r);const n=`${o}${o.includes("?")?"&":"?"}${t.toString()}`,s=await fetch(n,{method:"GET",headers:c.headers});this.state.requests.set(r,s),await this.processResponse(s,r,a)}else{c.body=e;const t=new AbortController;c.signal=t.signal,this.state.requests.set(r,t);const n=await fetch(o,c);await this.processResponse(n,r,a)}}catch(i){"AbortError"!==i.name&&(console.error("Error loading options:",i),this.emitEvent("cascade:error",{instance:a,element:r,error:i}))}finally{a.state.loading=!1,r.classList.remove(n.loadingClass),this.state.requests.delete(r)}}}},async processResponse(e,t,a){if(!e.ok)throw new Error(`HTTP error ${e.status}`);let n;const s=e.headers.get("Content-Type");if(s&&s.includes("application/json"))n=await e.json();else try{const t=await e.text();n=JSON.parse(t)}catch(i){throw new Error("Invalid response format, expected JSON")}let r=[];if(Array.isArray(n))r=n;else if("object"==typeof n){const e=t.id||t.name;if(r=n[e]?n[e]:n.options?n.options:n,"object"==typeof n&&!Array.isArray(n))for(const[s,r]of Object.entries(n)){if(!r||"object"!=typeof r)continue;const e=a.elements.find(e=>e.id===s||e.name===s);e&&e!==t&&this.updateSelectOptions(e,r,a)}}return this.updateSelectOptions(t,r,a),a.config.autoDisable&&(t.disabled=!1),this.emitEvent("cascade:loaded",{instance:a,element:t,options:r}),r},updateSelectOptions(e,t,a){const{config:n}=a;this.clearOptions(e,n);let s=[];Array.isArray(t)?s=t.map(e=>"object"==typeof e?{value:void 0!==e.value?e.value:e.id,text:void 0!==e.text?e.text:e.name,selected:e.selected||!1,disabled:e.disabled||!1}:{value:e,text:e,selected:!1,disabled:!1}):"object"==typeof t&&(s=Object.entries(t).map(([e,t])=>({value:e,text:t,selected:!1,disabled:!1}))),s.forEach(t=>{const a=document.createElement("option");a.value=t.value,a.textContent=t.text,a.selected=t.selected,a.disabled=t.disabled,e.appendChild(a)});const r=parseInt(e.dataset.cascadeIndex);if(a.state.values[r]){const t=a.state.values[r];if(Array.from(e.options).some(e=>e.value===t)){e.value=t;const a=new Event("change",{bubbles:!0});e.dispatchEvent(a)}}if(n.defaultSelection&&n.defaultSelection[r]){const t=n.defaultSelection[r];if(Array.from(e.options).some(e=>e.value===t)){e.value=t;const a=new Event("change",{bubbles:!0});e.dispatchEvent(a)}}},emitEvent(e,t){EventManager.emit(e,t)},getInstance(e){return this.state.instances.get(e)||null},getInstanceForElement:e=>("string"==typeof e&&(e=document.getElementById(e)),e&&e.cascadeInstance||null),reset(e){"string"==typeof e&&(e=this.getInstance(e)),e&&(e.elements.forEach((t,a)=>{0===a&&t._originalOptions?(t.innerHTML="",t._originalOptions.forEach(e=>{const a=document.createElement("option");a.value=e.value,a.textContent=e.text,a.selected=e.selected,a.disabled=e.disabled,t.appendChild(a)})):(this.clearOptions(t,e.config),e.config.autoDisable&&(t.disabled=!0)),e.state.values[a]=""}),this.emitEvent("cascade:reset",{instance:e}))},destroy(e){"string"==typeof e&&(e=this.getInstance(e)),e&&(e.elements.forEach(e=>{if(e._changeHandler&&e.removeEventListener("change",e._changeHandler),this.state.requests.has(e)){const t=this.state.requests.get(e);t.abort&&t.abort(),this.state.requests.delete(e)}delete e.cascadeInstance,delete e.dataset.cascadeGroup,delete e.dataset.cascadeIndex}),this.state.instances.delete(e.id),this.emitEvent("cascade:destroy",{instanceId:e.id}))}};(null==(k=window.Now)?void 0:k.registerManager)&&Now.registerManager("cascadingSelect",Te),window.CascadingSelectManager=Te;class TextareaElementFactory extends ElementFactory{static create(e){const t=Object.assign({},e,{tagName:"textarea",type:"textarea"});return super.create(t)}static extractCustomConfig(e,t,a){return{autoResize:void 0!==a.autoResize?"true"===a.autoResize:t.autoResize,minRows:this.parseNumeric("minRows",e,t,a)||t.minRows,maxRows:this.parseNumeric("maxRows",e,t,a)||t.maxRows,charCount:void 0!==a.charCount?"true"===a.charCount:t.charCount,wordCount:void 0!==a.wordCount?"true"===a.wordCount:t.wordCount,enableTabIndent:void 0!==a.enableTabIndent?"true"===a.enableTabIndent:t.enableTabIndent,tabToSpaces:this.parseNumeric("tabToSpaces",e,t,a)||t.tabToSpaces,enterBehavior:a.enterBehavior||t.enterBehavior}}static setupElement(e){const{element:t,config:a}=e;a.minRows=Math.max(1,"number"==typeof a.minRows?a.minRows:this.config.minRows),a.maxRows=Math.max(a.minRows,"number"==typeof a.maxRows?a.maxRows:this.config.maxRows),a.debounceDelay=Math.max(0,"number"==typeof a.debounceDelay?a.debounceDelay:this.config.debounceDelay),a.tabToSpaces=Math.max(0,"number"==typeof a.tabToSpaces?a.tabToSpaces:this.config.tabToSpaces),["newline","prevent","callback"].includes(a.enterBehavior)||(a.enterBehavior=this.config.enterBehavior),"callback"===a.enterBehavior&&"function"!=typeof a.enterCallback&&(console.warn('enterCallback must be a function when enterBehavior is "callback". Falling back to "newline".'),a.enterBehavior="newline"),t.setAttribute("aria-multiline","true"),e.countWords=function(e){return e.trim()?e.trim().split(/\s+/).length:0},e.validateSpecific=function(e){if(this.config.minWords){if(this.countWords(e)<this.config.minWords)return Now.translate("Must be at least {min} words",{min:this.config.minWords})}if(this.config.maxWords){if(this.countWords(e)>this.config.maxWords)return Now.translate("Must be no more than {max} words",{max:this.config.maxWords})}return null},a.autoResize&&this.setupAutoResize(e),(a.charCount||a.wordCount)&&this.setupCounter(e);const n=e.cleanup;e.cleanup=function(){return this.debounceTimer&&clearTimeout(this.debounceTimer),n.call(this)}}static setupAutoResize(e){const{element:t,config:a}=e;t._originalResize=t.style.resize||"both",t._originalOverflow=t.style.overflowY||"auto",t.style.resize="none",t.style.overflowY="hidden",setTimeout(()=>this.adjustHeight(t,a),0)}static adjustHeight(e,t){const a=window.pageYOffset||document.documentElement.scrollTop;e.style.height="auto";const n=window.getComputedStyle(e),s=parseFloat(n.lineHeight)||1.2*parseFloat(n.fontSize)||16,r=(parseFloat(n.paddingTop)||0)+(parseFloat(n.paddingBottom)||0),i=t.minRows*s+r,o=t.maxRows?t.maxRows*s+r:1/0,l=Math.min(Math.max(e.scrollHeight,i),o);e.style.height=`${l}px`,window.scrollTo(0,a),e.style.overflowY=e.scrollHeight>l?"auto":"hidden"}static setupCounter(e){var t;const{element:a,config:n,wrapper:s}=e,r=document.createElement("div");if(r.className="textarea-counter",r.style.textAlign="right",r.style.fontSize="smaller",r.style.color="var(--color-text-muted, #666)",r.setAttribute("aria-live","polite"),n.charCount){const e=document.createElement("span");e.className=n.charCountClass,r.appendChild(e),a.charCounter=e}if(n.wordCount){n.charCount&&r.appendChild(document.createTextNode(" | "));const e=document.createElement("span");e.className=n.wordCountClass,r.appendChild(e),a.wordCounter=e}if(s)s.appendChild(r);else{const n=document.createElement("div");n.appendChild(a.cloneNode(!0)),null==(t=a.parentNode)||t.replaceChild(n,a),e.element=n.querySelector("textarea"),n.appendChild(r),e.wrapper=n}this.updateCounters(e)}static updateCounters(e){const{element:t,config:a}=e,n=t.value;if(t.charCounter){const e=n.length,s=t.maxLength>0?t.maxLength:Now.translate("unlimited");t.charCounter.textContent=Now.translate(a.charCountFormat,{used:e,max:s})}if(t.wordCounter){const s=e.countWords(n),r=a.maxWords>0?a.maxWords:Now.translate("unlimited");t.wordCounter.textContent=Now.translate(a.wordCountFormat,{used:s,max:r})}}static setupEventListeners(e){const{element:t,config:a}=e;const n=Utils.function.debounce(n=>{a.autoResize&&this.adjustHeight(t,a),(a.charCount||a.wordCount)&&this.updateCounters(e)},a.debounceDelay),handlers_input=t=>{e.state.modified=!0,e.debounceTimer=undefined,n(t)},handlers_keydown=e=>{if("Enter"===e.key)if(e.shiftKey){const a=t.selectionStart,n=t.selectionEnd;t.value=t.value.substring(0,a)+"\n"+t.value.substring(n),t.selectionStart=t.selectionEnd=a+1,e.preventDefault()}else e.ctrlKey||e.altKey||("prevent"===a.enterBehavior?e.preventDefault():"callback"===a.enterBehavior&&a.enterCallback&&(e.preventDefault(),a.enterCallback(e,t.value)));if(a.enableTabIndent&&"Tab"===e.key&&!e.shiftKey&&!e.ctrlKey&&!e.altKey){e.preventDefault();const n=t.selectionStart,s=t.selectionEnd,r=a.tabToSpaces>0?" ".repeat(a.tabToSpaces):"\t";t.value=t.value.substring(0,n)+r+t.value.substring(s),t.selectionStart=t.selectionEnd=n+r.length}};EventSystemManager.addHandler(t,"input",handlers_input),EventSystemManager.addHandler(t,"keydown",handlers_keydown)}static cleanup(e){if(e){try{const{element:a}=e;e.debounceTimer&&(clearTimeout(e.debounceTimer),e.debounceTimer=null),void 0!==a._originalResize&&(a.style.resize=a._originalResize,delete a._originalResize),void 0!==a._originalOverflow&&(a.style.overflowY=a._originalOverflow,delete a._originalOverflow);try{a.charCounter&&a.charCounter.parentNode&&a.charCounter.parentNode.removeChild(a.charCounter)}catch(t){}try{a.wordCounter&&a.wordCounter.parentNode&&a.wordCounter.parentNode.removeChild(a.wordCounter)}catch(t){}}catch(a){console.warn("TextareaElementFactory.cleanup error",a)}"function"==typeof super.cleanup&&super.cleanup(e)}}}__publicField(TextareaElementFactory,"config",{autoResize:!0,minRows:2,maxRows:10,charCount:!1,charCountClass:"char-count",charCountFormat:"{used}/{max} characters",wordCount:!1,wordCountClass:"word-count",wordCountFormat:"{used}/{max} words",enableTabIndent:!1,tabToSpaces:4,debounceDelay:300,enterBehavior:"newline",enterCallback:null}),__publicField(TextareaElementFactory,"propertyHandlers",{rows:{get:e=>e.rows||null,set(e,t){"number"==typeof t&&t>0&&(e.element.rows=t)}},cols:{get:e=>e.cols||null,set(e,t){"number"==typeof t&&t>0&&(e.element.cols=t)}}}),ElementManager.registerElement("textarea",TextareaElementFactory);let Ae=(L=class extends ElementFactory{static extractCustomConfig(e,t,a){return{multiple:!0===e.multiple||!0===t.preview,preview:"true"===a.preview||!0===t.preview,previewContainer:a.previewContainer||t.previewContainer||this.config.previewContainer,downloadEnabled:"true"===a.allowDownload||!0===t.downloadEnabled,fileReference:a.fileReference||t.fileReference||"id",maxFileSize:parseInt(a.maxFileSize)||t.maxFileSize||this.config.maxFileSize,dragDrop:"true"===a.dragDrop||!0===t.dragDrop||!1,actionUrl:a.actionUrl||t.actionUrl,sortable:"true"===a.sortable||!0===t.sortable||!1,allowRemoveExisting:"true"===a.allowRemoveExisting||!0===t.allowRemoveExisting||!1,placeholder:a.placeholder||e.placeholder||t.placeholder||this.config.placeholder,existingFiles:this.parseExistingFiles(e)||t.existingFiles||[]}}static setupElement(e){var t;const{element:a,config:n}=e,s=ElementFactory._privateState.get(a);s.files||(s.files=new Map),n.multiple&&(a.multiple=!0),n.accept&&(a.accept=n.accept);let r,i=null;return n.dragDrop?i=this.initDragDrop(e):(i=null==(t=a.parentElement)?void 0:t.parentElement,this.initPlaceholder(e)),e.dropZone=i,n.preview&&(n.previewContainer&&(r=document.querySelector(n.previewContainer)),!r&&i&&(r=document.createElement("div"),r.className="file-preview",i.appendChild(r)),e.previewContainer=r,r&&(r.innerHTML="")),n.sortable&&e.previewContainer&&this.initSortable(e.previewContainer,n),n.existingFiles&&n.existingFiles.length>0&&this.showExistingFiles(e,n.existingFiles),e.clearFiles=function(){return L.clearFiles(this)},e.upload=function(e){return L.upload(this,e)},e.validateFiles=function(){return L.validateFormField(this)},e}static setupEventListeners(e){const{element:t,config:a}=e,n=super.setupEventListeners(e),changeHandler=a=>{const n=Array.from(t.files);this.processFiles(e,n)};let s={};return e.dropZone&&a.dragDrop&&(s={dragEnter:t=>{t.preventDefault(),e.dropZone.classList.add("drag-over")},dragLeave:t=>{t.preventDefault(),e.dropZone.classList.remove("drag-over")},dragOver:e=>{e.preventDefault()},drop:a=>{a.preventDefault(),e.dropZone.classList.remove("drag-over"),this.handleFileDrop(a.originalEvent,t)}},EventSystemManager.addHandler(e.dropZone,"dragenter",s.dragEnter),EventSystemManager.addHandler(e.dropZone,"dragleave",s.dragLeave),EventSystemManager.addHandler(e.dropZone,"dragover",s.dragOver),EventSystemManager.addHandler(e.dropZone,"drop",s.drop)),EventSystemManager.addHandler(t,"change",changeHandler),{...n,change:changeHandler,...s}}static initDragDrop(e){const{element:t,config:a}=e;let n=t.parentElement;n&&n.classList.contains("form-control")?n.classList.add("file-drop-zone"):(n=document.createElement("div"),n.className="file-drop-zone",t.parentNode.insertBefore(n,t),n.appendChild(t));const s=document.createElement("div");s.className="file-drop-content";const r=document.createElement("div");return r.className="file-drop-message",r.textContent=Now.translate(a.placeholder||"Drag files here or click to browse"),s.appendChild(r),n.appendChild(s),n}static initPlaceholder(e){var t;const{element:a,config:n}=e;let s=null==(t=a.parentElement)?void 0:t.querySelector(".placeholder");return s||(s=document.createElement("div"),s.className="file-display placeholder",a.parentElement.appendChild(s)),s.textContent=Now.translate(n.placeholder||"Choose file"),e.placeholderElement=s,this.updatePlaceholderVisibility(e),s}static updatePlaceholderVisibility(e){var t;const{element:a,placeholderElement:n,config:s}=e;if(!n)return;const r=ElementFactory._privateState.get(a),i=Array.from((null==(t=r.files)?void 0:t.values())||[]);0===i.length?(n.textContent=Now.translate(s.placeholder||"Choose file"),n.classList.add("placeholder")):1===i.length?(n.textContent=i[0].name,n.classList.remove("placeholder")):(n.textContent=Now.translate("{count} files selected",{count:i.length}),n.classList.remove("placeholder"))}static parseExistingFiles(e,t=null){try{const n=e.dataset.files;if(!n)return null;try{const e=JSON.parse(n);return Array.isArray(e)?e:[e]}catch(a){if(t){const e=this.resolveFieldData(t,n);if(e)return Array.isArray(e)?e:[e]}return{fieldRef:n}}}catch(n){return console.warn("Invalid files data attribute:",n),null}}static resolveFieldData(e,t){if(!e||!t)return null;const a=[e];e.data&&(a.unshift(e.data),e.data.data&&a.unshift(e.data.data));for(const n of a)if(n&&"object"==typeof n&&t in n)return n[t];return null}static setExistingFilesFromContext(e,t){const{element:a,config:n}=e;if(a.dataset.files&&n.existingFiles&&n.existingFiles.fieldRef){const a=this.resolveFieldData(t,n.existingFiles.fieldRef);if(a){const t=Array.isArray(a)?a:[a];n.existingFiles=t,this.showExistingFiles(e,t)}else n.existingFiles=[]}}static handleFileDrop(e,t){const a=Array.from(e.dataTransfer.files),n=new DataTransfer;a.forEach(e=>n.items.add(e)),t.files=n.files,t.dispatchEvent(new Event("change"))}static async processFiles(e,t){const{element:a,config:n}=e,s=ElementFactory._privateState.get(a);n.multiple||s.files.clear();const r=new Map(s.files||new Map),i=[];FormError.clearFieldError(a.id);for(const l of t)try{await this.validateFile(l,n),r.set(l.name,l)}catch(o){i.push(`${l.name}: ${o.message||o}`)}0===i.length?(s.files=r,this.showPreviews(e),this.updatePlaceholderVisibility(e),"function"==typeof n.onChange&&n.onChange(Array.from(r.values()),a),EventManager.emit("file:change",{elementId:a.id,files:r})):(FormError.showFieldError(a.id,i.join("<br>")),a.value="",s.files=new Map,this.showPreviews(e),this.updatePlaceholderVisibility(e))}static async validateFile(e,t){if(e.size>t.maxFileSize){const e=Now.translate("File size cannot exceed {maxsize}",{maxsize:this.formatFileSize(t.maxFileSize)});throw new Error(e)}if(t.accept){const a=t.accept.split(",").map(e=>e.trim());if(!this.isValidFileType(e,a))throw new Error(Now.translate("File type not allowed"))}else if(t.allowedMimeTypes&&t.allowedMimeTypes.length>0){if(!this.isValidFileType(e,t.allowedMimeTypes))throw new Error(Now.translate("File type not allowed"))}return!0}static isValidFileType(e,t){return t.some(t=>{if(t.startsWith("."))return e.name.toLowerCase().endsWith(t.toLowerCase());if(t.includes("/*")){const a=t.split("/")[0];return e.type.startsWith(a+"/")}return e.type===t})}static showPreviews(e){const{previewContainer:t,element:a}=e,n=ElementFactory._privateState.get(a);if(!t)return;const s=[...t.querySelectorAll('.preview-item[data-existing="true"]')];t.innerHTML="",s.forEach(e=>{t.appendChild(e)}),n.files&&n.files instanceof Map?n.files.forEach(a=>{const n=document.createElement("div");n.className="preview-item",n.dataset.fileName=a.name;const s=document.createElement("span");if(s.className="image-preview",a.type.startsWith("image/")){const e=new FileReader;e.onload=e=>{s.style.backgroundImage=`url(${e.target.result})`},e.readAsDataURL(a)}else s.classList.add(this.getFileIcon(a.name.toLowerCase()));n.appendChild(s);const r=document.createElement("div");r.className="file-info",r.textContent=`${a.name} (${this.formatFileSize(a.size)})`,n.appendChild(r);const i=document.createElement("button");i.type="button",i.className="icon-delete",i.title=Now.translate("Delete file"),i.onclick=()=>this.removeFile(e,a),n.appendChild(i),t.appendChild(n)}):console.warn("privateState.files is not a valid Map:",n.files)}static showExistingFiles(e,t){const{previewContainer:a,config:n}=e;a&&t.forEach(e=>{var t;const s=document.createElement("div");s.className="preview-item",s.dataset.existing="true";const r=n.fileReference||"id",i=e[r];if(i&&(s.dataset[this.camelCase(r)]=i),n.sortable){const e=document.createElement("span");e.className="drag-handle",e.title=Now.translate("Drag to reorder"),s.appendChild(e)}let o;const l=null==(t=e.url)?void 0:t.toLowerCase().match(/([^\/]{1,})\.([a-z]{3,})$/i);if(!l)return;if(["jpg","jpeg","png","gif","webp"].includes(l[2])?(o=document.createElement("div"),o.style.backgroundImage=`url(${e.url})`,o.onclick=()=>{this.getImageModal().show([e.url])}):(o=document.createElement("a"),o.className=this.getFileIcon(l[2]),o.href=e.url,o.download=l[0]),o.classList.add("image-preview"),s.appendChild(o),n.allowRemoveExisting&&n.actionUrl){const t=document.createElement("button");t.type="button",t.className="icon-delete",t.title=Now.translate("Delete file"),t.onclick=t=>{t.stopPropagation(),this.deleteFile(e,s,n)},s.appendChild(t)}const c=document.createElement("div");c.className="file-info";const d=e.name||l[0];e.size?c.textContent=`${d} (${this.formatFileSize(e.size)})`:c.textContent=d,s.appendChild(c),a.appendChild(s)})}static removeFile(e,t){const{element:a,config:n}=e,s=ElementFactory._privateState.get(a);s.files.delete(t.name),this.showPreviews(e),this.updatePlaceholderVisibility(e),0===s.files.size&&(a.value=""),n.onChange&&n.onChange(a,Array.from(s.files.values()))}static clearFiles(e){const{element:t,previewContainer:a}=e,n=ElementFactory._privateState.get(t);if(t.value="",n.files.clear(),a){0===a.querySelectorAll('.preview-item[data-existing="true"]').length?a.innerHTML="":Array.from(a.querySelectorAll('.preview-item:not([data-existing="true"])')).forEach(e=>e.remove())}this.updatePlaceholderVisibility(e)}static initSortable(e,t){"undefined"!=typeof Sortable?new Sortable(e,{animation:150,handle:".drag-handle",draggable:".preview-item",ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",onStart:t=>{e.classList.add("sorting")},onEnd:async a=>{var n,s;if(e.classList.remove("sorting"),!t.actionUrl)return;const r=t.fileReference||"id",i=Array.from(e.querySelectorAll('.preview-item[data-existing="true"]')),o=i.map(e=>{const t=e.dataset[this.camelCase(r)];return{[r]:t,position:i.indexOf(e)}}).filter(e=>e[r]);if(0!==o.length)try{const e={action:"sort",order:o},a=window.ApiService||(null==(s=null==(n=window.Now)?void 0:n.getManager)?void 0:s.call(n,"api"));let r;r=(null==a?void 0:a.post)?await a.post(t.actionUrl,e):await simpleFetch.post(t.actionUrl,e),200===r.status&&window.NotificationManager&&NotificationManager.success("Saved successfully")}catch(l){ErrorManager.handle(l,{context:"FileElementFactory.initSortable",type:"error:file",data:{container:e,config:t},notify:!0}),this.revertOrder(e,a.oldIndex,a.newIndex)}}}):console.warn("Sortable.js is required for drag & drop sorting")}static revertOrder(e,t,a){const n=Array.from(e.querySelectorAll('.preview-item[data-existing="true"]')),s=n[a];if(t<a)e.insertBefore(s,n[t]);else{const a=n[t+1];e.insertBefore(s,a)}}static async deleteFile(e,t,a){var n,s,r;try{if(!(await DialogManager.confirm(Now.translate("Are you sure you want to delete this item?"),Now.translate("Confirm Delete"))))return;const i=e[a.fileReference];if(!i)throw new Error(`Missing reference value: ${a.fileReference}`);const o={action:"delete",[a.fileReference]:i},l=window.ApiService||(null==(s=null==(n=window.Now)?void 0:n.getManager)?void 0:s.call(n,"api"));let c;c=(null==l?void 0:l.post)?await l.post(a.actionUrl,o):await simpleFetch.post(a.actionUrl,o);if(!1!==c.success&&c.status>=200&&c.status<300){t.remove(),"function"==typeof a.onRemoveExisting&&a.onRemoveExisting(e);const n=(null==(r=c.data)?void 0:r.data)||c.data||c;n.actions&&Array.isArray(n.actions)?await ResponseHandler.process(n):window.NotificationManager&&NotificationManager.success(c.message||"Item deleted successfully")}else window.NotificationManager&&NotificationManager.error(c.message||"Failed to delete item")}catch(i){ErrorManager.handle(i,{context:"FileElementFactory.deleteFile",type:"error:file",data:{file:e,preview:t,config:a},notify:!0})}}static validateFormField(e){const{element:t}=e,a=ElementFactory._privateState.get(t);if(t.required&&(!a.files||0===a.files.size)){const e=Now.translate("File is required");return FormError.showFieldError(t.id,e),!1}return!0}static async upload(e,t={}){const{element:a,config:n}=e,s=ElementFactory._privateState.get(a);if(0===s.files.size&&0===a.files.length)return{success:!1,message:Now.translate("No files selected")};try{const e=new FormData;s.files.size>0?Array.from(s.files.values()).forEach((t,a)=>{e.append(`file${a}`,t)}):Array.from(a.files).forEach((t,a)=>{e.append(`file${a}`,t)}),t.data&&Object.entries(t.data).forEach(([t,a])=>{e.append(t,a)});const r=t.url||n.actionUrl;if(!r)throw new Error("Upload URL not specified");const i=this.createProgressElement(a);i.style.display="block";const o=new XMLHttpRequest;return o.upload.addEventListener("progress",e=>{if(e.lengthComputable){const t=Math.round(e.loaded/e.total*100);this.updateProgressBar(i,t)}}),new Promise((t,a)=>{o.onload=()=>{if(i.style.display="none",o.status>=200&&o.status<300)try{const e=JSON.parse(o.responseText);t(e)}catch(e){t({success:!0,message:"Upload completed"})}else a(new Error("Upload failed"))},o.onerror=()=>{i.style.display="none",a(new Error("Network error"))},o.open("POST",r),o.send(e)})}catch(r){return ErrorManager.handle(r,{context:"FileElementFactory.upload",type:"error:file",data:{instance:e,options:t},notify:!0}),{success:!1,message:r.message||"Upload failed"}}}static createProgressElement(e){let t=e.parentElement.querySelector(".upload-progress");return t||(t=document.createElement("div"),t.className="upload-progress",t.innerHTML='\n        <div class="progress">\n          <div class="progress-bar" style="width:0%"></div>\n        </div>\n        <div class="progress-text">0%</div>\n      ',e.parentElement.appendChild(t)),t}static updateProgressBar(e,t){const a=e.querySelector(".progress-bar"),n=e.querySelector(".progress-text");a&&(a.style.width=t+"%"),n&&(n.textContent=t+"%")}static camelCase(e){return e.replace(/-([a-z])/g,e=>e[1].toUpperCase())}static getFileIcon(e){return{pdf:"icon-pdf",doc:"icon-word",docx:"icon-word",xls:"icon-excel",xlsx:"icon-excel",zip:"icon-zip",rar:"icon-zip"}[e.split(".").pop()]||"icon-file"}static formatFileSize(e){if(0===e)return"0 Bytes";const t=parseInt(Math.log(e)/Math.log(1024));return`${Math.round(e/Math.pow(1024,t),2)} ${["Bytes","KB","MB","GB"][t]}`}static getImageModal(){return this._imageModal||(this._imageModal=new MediaViewer({thumbnails:{enabled:!0}})),this._imageModal}static cleanup(e){const{element:t,dropZone:a}=e;return EventSystemManager.removeElementHandlers(t),a&&EventSystemManager.removeElementHandlers(a),super.cleanup(e)}},__publicField(L,"config",{...ElementFactory.config,debug:!1,maxFileSize:10485760,allowedMimeTypes:["image/*","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","text/plain","application/zip","application/x-zip-compressed"],previewContainer:null,placeholder:null,onChange:null,onError:null}),L);ElementManager.registerElement("file",Ae),window.FileElementFactory=Ae;const ke=class _SearchElementFactory extends TextElementFactory{static setupElement(e){super.setupElement(e);const{element:t,config:a}=e;return t.type="search",t.inputMode="search",this.setupClearButton(e),"function"==typeof a.onSearch?this.setupResultsContainer(e):window.Autocomplete&&a.useAutocomplete&&(e.autocomplete=Autocomplete.create(t,{minLength:a.minLength,delay:a.searchDelay,limit:a.maxResults})),a.formIntegration&&this.registerWithFormManager(e),e.createSuggestionList=function(t){return _SearchElementFactory.showResults(e,t)},e}static cleanup(e){if(e){try{const{element:a}=e;a.clearButton&&a.clearButton.parentNode&&(a.clearButton.parentNode.removeChild(a.clearButton),a.clearButton=null),a.resultsContainer&&a.resultsContainer.parentNode&&(a.resultsContainer.parentNode.removeChild(a.resultsContainer),a.resultsContainer=null);try{const e=Now.getManager&&Now.getManager("form");(a.closest?a.closest("form[data-form]"):null)&&e&&"function"==typeof e.unregisterValidator&&e.unregisterValidator(a.id)}catch(t){}}catch(a){console.warn("SearchElementFactory.cleanup error",a)}"function"==typeof super.cleanup&&super.cleanup(e)}}static registerWithFormManager(e){const t=Now.getManager("form");if(!t)return;const a=e.element.closest("form[data-form]");if(!a)return;const n=a.dataset.form;t.getInstance(n)&&t.registerValidator(e.element.id,t=>e.validate(t,!0))}static async handleSearch(e,t){const{element:a,config:n}=e;if(a.clearButton&&(a.clearButton.style.display=t?"block":"none"),!t||t.length<n.minLength)return a.resultsContainer&&(a.resultsContainer.style.display="none",a.setAttribute("aria-expanded","false")),void(n.onChange&&n.onChange(a,""));try{if(this.setLoadingState(e,!0),n.onSearch){const a=await n.onSearch(t);this.showResults(e,a,t)}n.onChange&&n.onChange(a,t),EventManager.emit("search:performed",{elementId:a.id,query:t})}catch(s){ErrorManager.handle(s,{context:"SearchElementFactory.handleSearch",type:"error:search"}),"undefined"!=typeof FormError&&FormError.showFieldError(a.id,s.message||"Search error occurred")}finally{this.setLoadingState(e,!1)}}static setupClearButton(e){const{element:t,config:a}=e;try{const e=document.createElement("button");e.type="button",e.className=a.clearClass||"search-clear",e.setAttribute("aria-label",Now.translate("Clear")),e.style.display="none";const n=t.wrapper||t.parentNode||document.body;n&&n.appendChild(e),e.addEventListener("click",e=>{e.preventDefault(),t.value="",t.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("change",{bubbles:!0})),t.focus(),"function"==typeof a.onChange&&a.onChange(t,"")}),t.clearButton=e}catch(n){console.warn("SearchElementFactory: failed to create clear button",n)}}static setupResultsContainer(e){const{element:t,config:a}=e;try{const e=document.createElement("div");e.className=a.resultsClass||"search-results",e.style.display="none",e.setAttribute("role","listbox"),e.setAttribute("aria-hidden","true");const n=t.wrapper||t.parentNode||document.body;n&&n.appendChild(e),t.resultsContainer=e,t.setAttribute("aria-haspopup","listbox"),t.setAttribute("aria-expanded","false")}catch(n){console.warn("SearchElementFactory: failed to create results container",n)}}static showResults(e,t=[],a=""){const{element:n,config:s}=e,r=n.resultsContainer;if(!r)return;if(r.innerHTML="",!t||0===t.length)return r.style.display="none",n.setAttribute("aria-expanded","false"),void r.setAttribute("aria-hidden","true");const i=document.createElement("ul");i.className="search-results-list";const o=a?String(a).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"):"",l=o?new RegExp(`(${o})`,"ig"):null;t.slice(0,s.maxResults||10).forEach(t=>{const a=document.createElement("li");a.className="search-result-item",a.setAttribute("role","option");let o="object"==typeof t&&(t.text||t.label||t.value)||String(t);s.highlightMatches&&l&&(o=o.replace(l,"<em>$1</em>")),a.innerHTML=`<span class="result-text">${o}</span>`,a.addEventListener("click",()=>{n.value="object"==typeof t?t.value||t.text||t.label||"":t,e.hiddenInput&&(e.hiddenInput.value="object"==typeof t?t.key||t.value||"":n.value),n.dispatchEvent(new Event("change",{bubbles:!0})),r.style.display="none",n.setAttribute("aria-expanded","false")}),i.appendChild(a)}),r.appendChild(i),r.style.display="block",r.setAttribute("aria-hidden","false"),n.setAttribute("aria-expanded","true")}static setLoadingState(e,t){const{element:a,config:n}=e,s=a.wrapper||a.parentNode;s&&(t?s.classList.add(n.loadingClass||"search-loading"):s.classList.remove(n.loadingClass||"search-loading"))}};__publicField(ke,"config",{...TextElementFactory.config,type:"search",inputMode:"search",searchDelay:300,minLength:2,maxLength:100,placeholder:"Search",wrapperClass:"search",inputClass:"search-input",clearClass:"search-clear",loadingClass:"search-loading",resultsClass:"search-results",activeClass:"active",maxResults:10,highlightMatches:!0,formIntegration:!0,keyboard:{selectKeys:["Enter"," "],closeKeys:["Escape"],navigateUpKeys:["ArrowUp"],navigateDownKeys:["ArrowDown"]}});let Le=ke;function _pad(e){return e<10?"0"+e:String(e)}function _toLocalDateTime(e){return function _toDateISO(e){return e.getFullYear()+"-"+_pad(e.getMonth()+1)+"-"+_pad(e.getDate())}(e)+"T"+function _toTimeHM(e){return _pad(e.getHours())+":"+_pad(e.getMinutes())}(e)}function _getCurrentLocale(){var e,t,a;const n=(null==(t=null==(e=window.Now)?void 0:e.getManager)?void 0:t.call(e,"i18n"))||window.I18nManager;if(null==n?void 0:n.getCurrentLocale)return n.getCurrentLocale();if(null==(a=window.LanguageManager)?void 0:a.getCurrentLanguage)return window.LanguageManager.getCurrentLanguage();return(navigator.language||navigator.userLanguage||"en").split("-")[0]}function _getDayNames(e=null){var t,a;const n=e||_getCurrentLocale();if(null==(a=null==(t=window.Utils)?void 0:t.date)?void 0:a.getDayNamesNarrow)return Utils.date.getDayNamesNarrow(n);return"th"===n.split("-")[0]?["อ","จ","อ","พ","พ","ศ","ส"]:["S","M","T","W","T","F","S"]}function _getMonthNamesShort(e=null){var t,a;const n=e||_getCurrentLocale();if(null==(a=null==(t=window.Utils)?void 0:t.date)?void 0:a.getMonthNamesShort)return Utils.date.getMonthNamesShort(n);return"th"===n.split("-")[0]?["ม.ค.","ก.พ.","มี.ค.","เม.ย.","พ.ค.","มิ.ย.","ก.ค.","ส.ค.","ก.ย.","ต.ค.","พ.ย.","ธ.ค."]:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]}ElementManager.registerElement("search",Le);class EmbeddedDateTime{constructor(e){if(this._original=e,!this._original)throw new Error("EmbeddedDateTime: Original element is required");this.type=(this._original.getAttribute("type")||"date").toLowerCase(),this.name=this._original.getAttribute("name")||"",this.id=this._original.id||"gdatetime-"+Math.random().toString(36).slice(2,8),this.locale=_getCurrentLocale(),this.outputFormat=this._original.getAttribute("data-format")||"YYYY-MM-DD",this.displayFormat=this._original.getAttribute("data-display-format")||"D MMM YYYY",this.outputLocale=this.locale.startsWith("th")?"th-CE":"en",this.displayLocale=this.locale,this.selectedDate=null,this.selectedTime=null,this.currentMonth=(new Date).getMonth(),this.currentYear=(new Date).getFullYear(),this.currentView="day",this.isOpen=!1,this.min=this._original.getAttribute("min")||null,this.max=this._original.getAttribute("max")||null,this.required=this._original.hasAttribute("required"),this.disabled=this._original.hasAttribute("disabled"),this.readonly=this._original.hasAttribute("readonly"),this._initializeElements(),this._setupEventListeners(),this._replaceOriginalElement();const t=this._original.value||this._original.getAttribute("value");t&&this.setValue(t)}_initializeElements(){const e=this._original.closest(".form-control");this.wrapper=e||document.createElement("div"),this.wrapper.classList.add("custom-datepicker"),this.wrapper.id=this.id+"_wrapper",this.displayButton=document.createElement("button"),this.displayButton.type="button",this.displayButton.className="dropdown-button",this.wrapper.appendChild(this.displayButton);const t=document.createElement("span");t.className="dropdown-display",t.textContent=Now.translate(this._original.placeholder||"Choose a date"),this.displayButton.appendChild(t);const a=document.createElement("span");a.className="dropdown-arrow",this.displayButton.appendChild(a),this.hiddenInput=null,this.dropdown=document.createElement("div"),this.dropdown.className="datepicker-dropdown",this.dropdownPanel=DropdownPanel.getInstance(),this._createCalendarStructure()}_createCalendarStructure(){this.calendarHeader=document.createElement("div"),this.calendarHeader.className="calendar-header",this.prevButton=document.createElement("button"),this.prevButton.type="button",this.prevButton.className="calendar-nav prev",this.prevButton.innerHTML="‹",this.calendarHeader.appendChild(this.prevButton);const e=document.createElement("div");e.className="month-year-container",this.monthDisplay=document.createElement("button"),this.monthDisplay.type="button",this.monthDisplay.className="month-display",e.appendChild(this.monthDisplay),this.yearDisplay=document.createElement("button"),this.yearDisplay.type="button",this.yearDisplay.className="year-display",e.appendChild(this.yearDisplay),this.calendarHeader.appendChild(e),this.nextButton=document.createElement("button"),this.nextButton.type="button",this.nextButton.className="calendar-nav next",this.nextButton.innerHTML="›",this.calendarHeader.appendChild(this.nextButton),this.dropdown.appendChild(this.calendarHeader),this.daysHeader=document.createElement("div"),this.daysHeader.className="days-header",_getDayNames(this.locale).forEach(e=>{const t=document.createElement("div");t.className="day-name",t.textContent=e,this.daysHeader.appendChild(t)}),this.dropdown.appendChild(this.daysHeader),this.calendarGrid=document.createElement("div"),this.calendarGrid.className="calendar-grid",this.dropdown.appendChild(this.calendarGrid),"datetime-local"===this.type&&this._createTimePicker()}_createTimePicker(){const e=document.createElement("div");e.className="time-picker-section";const t=document.createElement("div");t.className="time-inputs";const a=document.createElement("div");a.className="time-group";const n=document.createElement("input");n.type="number",n.className="time-input hours",n.min="0",n.max="23",n.value="00",n.placeholder="HH",this.hoursInput=n,a.appendChild(n),t.appendChild(a);const s=document.createElement("span");s.className="time-separator",s.textContent=":",t.appendChild(s);const r=document.createElement("div");r.className="time-group";const i=document.createElement("input");i.type="number",i.className="time-input minutes",i.min="0",i.max="59",i.value="00",i.placeholder="MM",this.minutesInput=i,r.appendChild(i),t.appendChild(r);if("true"===this._original.getAttribute("data-show-seconds")){const e=document.createElement("span");e.className="time-separator",e.textContent=":",t.appendChild(e);const a=document.createElement("div");a.className="time-group";const n=document.createElement("input");n.type="number",n.className="time-input seconds",n.min="0",n.max="59",n.value="00",n.placeholder="SS",this.secondsInput=n,a.appendChild(n),t.appendChild(a)}e.appendChild(t),this.dropdown.appendChild(e),this._setupTimeInputEvents()}_setupTimeInputEvents(){const validateAndFormat=(e,t)=>{let a=parseInt(e.value)||0;a<0&&(a=0),a>t&&(a=t),e.value=_pad(a)};this.hoursInput&&(this.hoursInput.addEventListener("input",e=>{e.target.value.length>=2&&(validateAndFormat(e.target,23),this.minutesInput&&this.minutesInput.focus())}),this.hoursInput.addEventListener("blur",e=>{validateAndFormat(e.target,23)})),this.minutesInput&&(this.minutesInput.addEventListener("input",e=>{e.target.value.length>=2&&(validateAndFormat(e.target,59),this.secondsInput&&this.secondsInput.focus())}),this.minutesInput.addEventListener("blur",e=>{validateAndFormat(e.target,59)})),this.secondsInput&&(this.secondsInput.addEventListener("input",e=>{e.target.value.length>=2&&validateAndFormat(e.target,59)}),this.secondsInput.addEventListener("blur",e=>{validateAndFormat(e.target,59)}))}_setupEventListeners(){var e;this.displayButton.addEventListener("click",e=>{e.preventDefault(),this.disabled||this.readonly||this.toggle()}),this.monthDisplay.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.currentView="month",this._renderCurrentView()}),this.yearDisplay.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.currentView="year",this._renderCurrentView()}),this.prevButton.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this._navigatePrevious()}),this.nextButton.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this._navigateNext()}),this.wrapper.addEventListener("keydown",e=>{if(!this.disabled&&!this.readonly)switch(e.key){case"Enter":case" ":e.preventDefault(),this.toggle();break;case"Escape":e.preventDefault(),this.close()}}),this.wrapper.addEventListener("copy",e=>{this.hiddenInput.value&&(e.preventDefault(),e.clipboardData.setData("text/plain",this.hiddenInput.value))}),this.wrapper.addEventListener("paste",e=>{if(this.disabled||this.readonly)return;e.preventDefault();const t=e.clipboardData.getData("text/plain").trim();t&&this.setValue(t)}),this._localeChangeHandler=()=>{this._updateLocale()},(null==(e=window.EventManager)?void 0:e.on)&&EventManager.on("locale:changed",this._localeChangeHandler)}_updateLocale(){const e=_getCurrentLocale();if(e!==this.locale){if(this.locale=e,this.outputLocale=this.locale.startsWith("th")?"th-CE":"en",this.displayLocale=this.locale,this.daysHeader.innerHTML="",_getDayNames(this.locale).forEach(e=>{const t=document.createElement("div");t.className="day-name",t.textContent=e,this.daysHeader.appendChild(t)}),this.selectedDate){const e=Utils.date.format(this.selectedDate,this.displayFormat,this.displayLocale);if("datetime-local"===this.type&&this.hoursInput&&this.minutesInput){const t=parseInt(this.hoursInput.value)||0,a=parseInt(this.minutesInput.value)||0;this.displayButton.firstChild.textContent=e+" "+_pad(t)+":"+_pad(a)}else this.displayButton.firstChild.textContent=e}this.isOpen&&this._renderCurrentView()}}_navigatePrevious(){switch(this.currentView){case"day":this.previousMonth();break;case"month":this.currentYear--,this._renderCurrentView();break;case"year":this.currentYear-=12,this._renderCurrentView()}}_navigateNext(){switch(this.currentView){case"day":this.nextMonth();break;case"month":this.currentYear++,this._renderCurrentView();break;case"year":this.currentYear+=12,this._renderCurrentView()}}_renderCurrentView(){switch(this.currentView){case"year":this._renderYearPicker();break;case"month":this._renderMonthPicker();break;default:this._renderCalendar()}}_renderYearPicker(){const e=this.currentYear-this.currentYear%12,t=e+11,a="th"===this.displayLocale,n=a?e+543:e,s=a?t+543:t;this.yearDisplay.textContent=`${n} - ${s}`,this.yearDisplay.style.flex="1",this.yearDisplay.style.display=null,this.monthDisplay.textContent="",this.monthDisplay.style.display="none",this.daysHeader.style.display="none",this.calendarGrid.innerHTML="",this.calendarGrid.className="calendar-grid year-grid";for(let r=0;r<12;r++){const t=e+r,n=document.createElement("button");n.type="button",n.className="calendar-year";const s=a?t+543:t;n.textContent=s,t===(new Date).getFullYear()&&n.classList.add("today"),t===this.currentYear&&n.classList.add("selected"),n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.currentYear=t,this.currentView="month",this._renderCurrentView()}),this.calendarGrid.appendChild(n)}}_renderMonthPicker(){const e="th"===this.displayLocale?this.currentYear+543:this.currentYear;this.yearDisplay.textContent=e,this.yearDisplay.style.flex="1",this.monthDisplay.textContent="",this.monthDisplay.style.display="none",this.daysHeader.style.display="none",this.calendarGrid.innerHTML="",this.calendarGrid.className="calendar-grid month-grid";for(let t=0;t<12;t++){const e=document.createElement("button");e.type="button",e.className="calendar-month",e.textContent=_getMonthNamesShort(this.locale)[t];const a=new Date;t===a.getMonth()&&this.currentYear===a.getFullYear()&&e.classList.add("today"),t===this.currentMonth&&e.classList.add("selected"),e.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.currentMonth=t,this.currentView="day",this._renderCurrentView()}),this.calendarGrid.appendChild(e)}}_renderCalendar(){const e="th"===this.displayLocale?this.currentYear+543:this.currentYear;this.monthDisplay.textContent=function _getMonthNames(e=null){var t,a;const n=e||_getCurrentLocale();return(null==(a=null==(t=window.Utils)?void 0:t.date)?void 0:a.getMonthNames)?Utils.date.getMonthNames(n):"th"===n.split("-")[0]?["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"]:["January","February","March","April","May","June","July","August","September","October","November","December"]}(this.locale)[this.currentMonth],this.monthDisplay.style.display="",this.yearDisplay.textContent=e,this.monthDisplay.style.flex="",this.yearDisplay.style.flex="",this.daysHeader.style.display="grid",this.calendarGrid.className="calendar-grid",this.calendarGrid.innerHTML="";const t=new Date(this.currentYear,this.currentMonth,1);new Date(this.currentYear,this.currentMonth+1,0);const a=new Date(t);a.setDate(a.getDate()-t.getDay());for(let n=0;n<42;n++){const e=new Date(a);e.setDate(a.getDate()+n);const t=document.createElement("button");t.type="button",t.className="calendar-day",t.textContent=e.getDate(),e.getMonth()!==this.currentMonth&&t.classList.add("other-month"),this._isSameDate(e,new Date)&&t.classList.add("today"),this.selectedDate&&this._isSameDate(e,this.selectedDate)&&t.classList.add("selected"),this._isDateDisabled(e)?(t.disabled=!0,t.classList.add("disabled")):t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.selectDate(e)}),this.calendarGrid.appendChild(t)}}_isSameDate(e,t){return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()}_isDateDisabled(e){if(this.min){if(e<new Date(this.min))return!0}if(this.max){if(e>new Date(this.max))return!0}return!1}open(){this.disabled||this.readonly||this.isOpen||(this.isOpen=!0,"time"===this.type?(this.calendarHeader.style.display="none",this.daysHeader.style.display="none",this.calendarGrid.style.display="none"):(this.calendarHeader.style.display="",this.daysHeader.style.display="",this.calendarGrid.style.display="",this.currentView="day",this._renderCurrentView()),this.dropdownPanel.show(this.wrapper,this.dropdown,{align:"left",offsetY:5,onClose:()=>{this.isOpen=!1,this.wrapper.dispatchEvent(new CustomEvent("gdatetime:close",{detail:{type:this.type,value:this.selectedDate}}))}}),"time"===this.type&&this.hoursInput&&setTimeout(()=>{this.hoursInput.focus(),this.hoursInput.select()},50),this.wrapper.dispatchEvent(new CustomEvent("gdatetime:open",{detail:{type:this.type,value:this.selectedDate}})))}close(){this.isOpen&&this.dropdownPanel.hide()}toggle(){this.isOpen?this.close():this.open()}selectDate(e){let t,a;if(this.selectedDate=new Date(e),"datetime-local"===this.type){const e=this.hoursInput?parseInt(this.hoursInput.value)||0:this.selectedDate.getHours(),n=this.minutesInput?parseInt(this.minutesInput.value)||0:this.selectedDate.getMinutes(),s=this.secondsInput&&parseInt(this.secondsInput.value)||0;this.selectedDate.setHours(e,n,s,0),t=_toLocalDateTime(this.selectedDate),this.secondsInput&&(t+=":"+_pad(s)),a=Utils.date.format(this.selectedDate,this.displayFormat,this.displayLocale)+" "+_pad(e)+":"+_pad(n),this.secondsInput&&(a+=":"+_pad(s))}else if("time"===this.type){const e=this.hoursInput&&parseInt(this.hoursInput.value)||0,n=this.minutesInput&&parseInt(this.minutesInput.value)||0,s=this.secondsInput&&parseInt(this.secondsInput.value)||0;t=_pad(e)+":"+_pad(n),this.secondsInput&&(t+=":"+_pad(s)),a=t}else t=Utils.date.format(this.selectedDate,this.outputFormat,this.outputLocale),a=Utils.date.format(this.selectedDate,this.displayFormat,this.displayLocale);this.hiddenInput.value=t,this.hiddenInput.setAttribute("value",t),this.displayButton.firstChild.textContent=a,"datetime-local"!==this.type&&this.close(),setTimeout(()=>{this.wrapper.focus()},0);const n=new Event("change",{bubbles:!0});this.hiddenInput.dispatchEvent(n),this.wrapper.dispatchEvent(new CustomEvent("gdatetime:change",{detail:{type:this.type,value:this.hiddenInput.value,date:this.selectedDate}}))}previousMonth(){this.currentMonth--,this.currentMonth<0&&(this.currentMonth=11,this.currentYear--),this._renderCurrentView()}nextMonth(){this.currentMonth++,this.currentMonth>11&&(this.currentMonth=0,this.currentYear++),this._renderCurrentView()}setValue(e){if(!e||""===e){this.selectedDate=null,this.selectedTime=null,this.hiddenInput.value="",this.hiddenInput.setAttribute("value","");const e="time"===this.type?"Choose time":"datetime-local"===this.type?"Choose date and time":"Choose a date";return this.displayButton.firstChild.textContent=Now.translate(this._original.placeholder||e),this.hoursInput&&(this.hoursInput.value="00"),this.minutesInput&&(this.minutesInput.value="00"),void(this.secondsInput&&(this.secondsInput.value="00"))}if("time"===this.type){const t=e.split(":");if(t.length>=2){const a=parseInt(t[0])||0,n=parseInt(t[1])||0,s=t[2]&&parseInt(t[2])||0;return this.hoursInput&&(this.hoursInput.value=_pad(a)),this.minutesInput&&(this.minutesInput.value=_pad(n)),this.secondsInput&&(this.secondsInput.value=_pad(s)),this.hiddenInput.value=e,this.hiddenInput.setAttribute("value",e),void(this.displayButton.firstChild.textContent=e)}}const t=new Date(e);if(isNaN(t.getTime()))console.warn("Invalid date value:",e);else if(this.selectedDate=t,this.currentMonth=t.getMonth(),this.currentYear=t.getFullYear(),"datetime-local"===this.type){const e=t.getHours(),a=t.getMinutes(),n=t.getSeconds();this.hoursInput&&(this.hoursInput.value=_pad(e)),this.minutesInput&&(this.minutesInput.value=_pad(a)),this.secondsInput&&(this.secondsInput.value=_pad(n));let s=_toLocalDateTime(t);this.secondsInput&&(s+=":"+_pad(n)),this.hiddenInput.value=s,this.hiddenInput.setAttribute("value",s);const r=Utils.date.format(t,this.displayFormat,this.displayLocale)+" "+_pad(e)+":"+_pad(a);this.displayButton.firstChild.textContent=r+(this.secondsInput?":"+_pad(n):"")}else{const e=Utils.date.format(this.selectedDate,this.outputFormat,this.outputLocale);this.hiddenInput.value=e,this.hiddenInput.setAttribute("value",e);const t=Utils.date.format(this.selectedDate,this.displayFormat,this.displayLocale);this.displayButton.firstChild.textContent=t}}getValue(){return this.hiddenInput.value||null}getDate(){return this.selectedDate}destroy(){var e;this.isOpen&&this.close(),this._localeChangeHandler&&(null==(e=window.EventManager)?void 0:e.off)&&EventManager.off("locale:changed",this._localeChangeHandler),this.wrapper&&this.wrapper.parentNode&&this.wrapper.parentNode.removeChild(this.wrapper)}getElement(){return this.wrapper}_replaceOriginalElement(){this._original.parentNode&&(this._original.type="hidden",this._original.style.display="none",this.hiddenInput=this._original,this._original.parentNode!==this.wrapper&&this._original.parentNode.insertBefore(this.wrapper,this._original))}}class DateElementFactory extends ElementFactory{static createInstance(e,t={}){return super.createInstance(e,t)}static setupElement(e){const{element:t}=e;try{const a=new EmbeddedDateTime(t);e.wrapper=a.getElement(),e.gdatetime=a,e.getValue=()=>a.getValue(),e.setValue=e=>a.setValue(e),e.getDate=()=>a.getDate(),e.open=()=>a.open(),e.close=()=>a.close(),e.toggle=()=>a.toggle(),t.wrapper=e.wrapper,a.hiddenInput&&a.hiddenInput.addEventListener("change",e=>{if(e.target===t)return;const n=new Event("change",{bubbles:!0});t.dispatchEvent(n),EventManager.emit("element:change",{elementId:t.id,value:a.getValue(),type:"date"})});const n=e.cleanup;return e.cleanup=function(){return this.gdatetime&&(this.gdatetime.destroy(),this.gdatetime=null),n&&n.call(this),this},e}catch(a){return console.error("DateElementFactory: Failed to setup element:",a),e}}}__publicField(DateElementFactory,"config",{...ElementFactory.config,type:"date"}),ElementManager.registerElement("date",DateElementFactory),ElementManager.registerElement("datetime-local",DateElementFactory),window.DateElementFactory=DateElementFactory;const Ie=["#FF0000","#00FF00","#0000FF","#FFFF00","#FF00FF","#00FFFF","#FFA500","#800080","#008000","#800000","#000080","#808000","#008080","#808080","#A52A2A","#FA8072","#4682B4","#D2691E","#2E8B57","#FFD700","#DA70D6","#C71585","#40E0D0","#F0E68C","#ADD8E6","#90EE90","#FF69B4","#B0C4DE","#EEE8AA","#98FB98","#F5F5DC","#FFE4E1","#F08080","#E0FFFF","#D8BFD8","#F4A460","#BC8F8F","#CD5C5C","#6B8E23","#556B2F","#8FBC8F","#483D8B","#B8860B","#A9A9A9","#3CB371","#BA55D3","#9370DB","#66CDAA","#7B68EE","#708090","#FFFFFF","#000000"];class EmbeddedColorPicker{constructor(e){if(this._original=e,!this._original)throw new Error("ColorPicker: Original element is required");this.name=this._original.getAttribute("name")||"",this.id=this._original.id||"colorpicker-"+Math.random().toString(36).slice(2,8),this.selectedColor="",this.isOpen=!1,this.disabled=this._original.hasAttribute("disabled"),this.readonly=this._original.hasAttribute("readonly");const t=this._original.getAttribute("value"),a=this._original.value;this._initializeElements(),this._setupEventListeners(),this._replaceOriginalElement(),t&&""!==t?this.setColor(t):a&&""!==a&&this._original.hasAttribute("value")?this.setColor(a):(this.selectedColor="",window.setTimeout(()=>{this.hiddenInput.value="",this.hiddenInput.removeAttribute("value")},0))}_initializeElements(){const e=this._original.closest(".form-control");this.wrapper=e||document.createElement("div"),this.wrapper.classList.add("custom-colorpicker"),this.wrapper.id=this.id+"_wrapper",this.displayButton=document.createElement("button"),this.displayButton.type="button",this.displayButton.className="dropdown-button",this.displayButton.innerHTML=`\n      <span class="dropdown-display">${Now.translate(this._original.placeholder||"Choose a color")}</span>\n      <span class="dropdown-arrow"></span>\n    `,this.wrapper.appendChild(this.displayButton),this.colorText=this.displayButton.querySelector(".dropdown-display"),this.hiddenInput=null,this.dropdown=document.createElement("div"),this.dropdown.className="colorpicker-dropdown",this.dropdownPanel=DropdownPanel.getInstance(),this._createColorPalette()}_createColorPalette(){const e=document.createElement("div");e.className="color-input-section";const t=document.createElement("input");t.type="text",t.className="hex-input",t.placeholder="#000000",t.maxLength=7,this.hexInput=t;const a=document.createElement("button");a.type="button",a.className="clear-color-btn",a.textContent=Now.translate("Clear"),e.appendChild(t),e.appendChild(a),this.dropdown.appendChild(e),this._createPaletteSection("Basic Colors",Ie,"basic-colors"),t.addEventListener("input",e=>{let t=e.target.value;!t.startsWith("#")&&t.length>0&&(t="#"+t,e.target.value=t),this._isValidColor(t)&&this._previewColor(t)}),t.addEventListener("keydown",e=>{if("Enter"===e.key){e.preventDefault();const t=e.target.value;this._isValidColor(t)&&this.selectColor(t)}}),t.addEventListener("focus",e=>{e.target.select()}),t.addEventListener("paste",e=>{e.stopPropagation(),setTimeout(()=>{let t=e.target.value.trim();t&&!t.startsWith("#")&&/^[A-Fa-f0-9]{3,6}$/.test(t)&&(t="#"+t,e.target.value=t),this._isValidColor(t)&&this._previewColor(t)},0)}),a.addEventListener("click",e=>{e.preventDefault(),this.selectColor("")})}_createPaletteSection(e,t,a){const n=document.createElement("div");n.className=`palette-section ${a}`;const s=document.createElement("div");s.className="color-palette",t.forEach((e,t)=>{const a=document.createElement("button");a.type="button",a.className="color-swatch",a.style.backgroundColor=e,a.title=e,a.setAttribute("data-color",e),a.setAttribute("aria-label",`Select color ${e}`),a.addEventListener("click",t=>{t.preventDefault(),this.selectColor(e)}),a.addEventListener("keydown",t=>{"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),this.selectColor(e))}),s.appendChild(a)}),n.appendChild(s),this.dropdown.appendChild(n)}_setupEventListeners(){this.displayButton.addEventListener("click",e=>{e.preventDefault(),this.disabled||this.readonly||this.toggle()}),this.wrapper.addEventListener("keydown",e=>{if(!this.disabled&&!this.readonly)switch(e.key){case"Enter":case" ":e.preventDefault(),this.toggle();break;case"Escape":e.preventDefault(),this.close()}});const setupCopyPaste=e=>{e.addEventListener("copy",e=>{this.hiddenInput.value&&(e.preventDefault(),e.stopPropagation(),e.clipboardData.setData("text/plain",this.hiddenInput.value))}),e.addEventListener("paste",e=>{if(this.disabled||this.readonly)return;e.preventDefault(),e.stopPropagation();let t=e.clipboardData.getData("text/plain").trim();t&&!t.startsWith("#")&&/^[A-Fa-f0-9]{3,6}$/.test(t)&&(t="#"+t),t&&this._isValidColor(t)&&(this.setColor(t),this.isOpen&&this.close())})};setupCopyPaste(this.wrapper),setupCopyPaste(this.displayButton),setupCopyPaste(this.dropdown)}_isValidColor(e){if(!e)return!0;return/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(e)}_previewColor(e){e&&(this.wrapper.style.backgroundColor=e,this.wrapper.style.color=this._getContrastColor(e),this.colorText.textContent=e.toUpperCase())}_getContrastColor(e){return(.299*parseInt(e.slice(1,3),16)+.587*parseInt(e.slice(3,5),16)+.114*parseInt(e.slice(5,7),16))/255>.5?"#000000":"#FFFFFF"}open(){this.disabled||this.readonly||this.isOpen||(this.isOpen=!0,this.wrapper.classList.add("open"),this.selectedColor?this.hexInput.value=this.selectedColor:this.hexInput.value="",this.dropdownPanel.show(this.wrapper,this.dropdown,{align:"left",offsetY:5,onClose:()=>{this.isOpen=!1,this.wrapper.classList.remove("open"),this.wrapper.dispatchEvent(new CustomEvent("colorpicker:close",{detail:{color:this.selectedColor}}))}}),this.hexInput&&setTimeout(()=>{this.hexInput.focus(),this.hexInput.select()},50),this.wrapper.dispatchEvent(new CustomEvent("colorpicker:open",{detail:{color:this.selectedColor}})))}close(){this.isOpen&&this.dropdownPanel.hide()}toggle(){this.isOpen?this.close():this.open()}selectColor(e){this.selectedColor=e,this.hiddenInput.value=e,this.hiddenInput.setAttribute("value",e),e?(this.wrapper.style.backgroundColor=e,this.wrapper.style.color=this._getContrastColor(e),this.colorText.textContent=e.toUpperCase(),this.colorText.style.color=this._getContrastColor(e)):(this.wrapper.style.backgroundColor="",this.wrapper.style.color="",this.colorText.textContent=Now.translate(this._original.placeholder||"Choose a color"),this.colorText.style.color=""),this.dropdown.querySelectorAll(".color-swatch").forEach(t=>{t.classList.remove("selected"),t.getAttribute("data-color")===e&&t.classList.add("selected")}),this.close(),setTimeout(()=>{this.wrapper.focus()},0);const t=new Event("change",{bubbles:!0});this.hiddenInput.dispatchEvent(t),this.wrapper.dispatchEvent(new CustomEvent("colorpicker:change",{detail:{color:e,rgb:e?this._hexToRgb(e):null}}))}_hexToRgb(e){if(!e)return null;const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}setColor(e){this._isValidColor(e)&&this.selectColor(e)}getColor(){return this.hiddenInput.value||null}setDisabled(e){this.disabled=e,this.wrapper.classList.toggle("disabled",e),this.displayButton.disabled=e,e&&this.close()}setReadonly(e){this.readonly=e,this.wrapper.classList.toggle("readonly",e),e&&this.close()}destroy(){this.wrapper&&this.wrapper.parentNode&&this.wrapper.parentNode.removeChild(this.wrapper)}getElement(){return this.wrapper}_replaceOriginalElement(){this._original.parentNode&&(this._original.type="hidden",this._original.style.display="none",this.hiddenInput=this._original,this._original.parentNode!==this.wrapper&&this._original.parentNode.insertBefore(this.wrapper,this._original))}}window.EmbeddedColorPicker=EmbeddedColorPicker;class ColorElementFactory extends ElementFactory{static createInstance(e,t={}){return super.createInstance(e,t)}static setupElement(e){const{element:t}=e;try{const a=new EmbeddedColorPicker(t);e.wrapper=a.getElement(),e.colorPicker=a,e.getColor=()=>a.getColor(),e.setColor=e=>a.setColor(e),e.setValue=e=>a.setColor(e),e.getValue=()=>a.getColor(),e.open=()=>a.open(),e.close=()=>a.close(),e.toggle=()=>a.toggle(),e.setDisabled=e=>a.setDisabled(e),e.setReadonly=e=>a.setReadonly(e),t.wrapper=e.wrapper,a.hiddenInput&&a.hiddenInput.addEventListener("change",e=>{if(e.target===t)return;const n=new Event("change",{bubbles:!0});t.dispatchEvent(n),EventManager.emit("element:change",{elementId:t.id,value:a.getColor(),type:"color"})}),a.wrapper.addEventListener("colorpicker:change",e=>{t.dispatchEvent(new CustomEvent("colorpicker:change",{detail:e.detail}))}),a.wrapper.addEventListener("colorpicker:open",e=>{t.dispatchEvent(new CustomEvent("colorpicker:open",{detail:e.detail}))}),a.wrapper.addEventListener("colorpicker:close",e=>{t.dispatchEvent(new CustomEvent("colorpicker:close",{detail:e.detail}))});const n=e.cleanup;return e.cleanup=function(){return this.colorPicker&&(this.colorPicker.destroy(),this.colorPicker=null),n&&n.call(this),this},e}catch(a){return console.error("ColorElementFactory: Failed to setup element:",a),e}}}__publicField(ColorElementFactory,"config",{...ElementFactory.config,type:"color"}),ElementManager.registerElement("color",ColorElementFactory),window.ColorElementFactory=ColorElementFactory;let De=(I=class extends ElementFactory{static extractCustomConfig(e,t,a){var n,s,r,i,o;return{separator:a.separator||t.separator,maxTags:a.maxTags?parseInt(a.maxTags):t.maxTags,duplicates:"true"===a.duplicates||t.duplicates,autocomplete:{enabled:void 0!==a.autocomplete?"true"===a.autocomplete:null==(n=t.autocomplete)?void 0:n.enabled,source:a.source||(null==(s=t.autocomplete)?void 0:s.source),minLength:this.parseNumeric("minLength",e,t.autocomplete,a)||(null==(r=t.autocomplete)?void 0:r.minLength),maxResults:this.parseNumeric("maxResults",e,t.autocomplete,a)||(null==(i=t.autocomplete)?void 0:i.maxResults),delay:this.parseNumeric("delay",e,t.autocomplete,a)||(null==(o=t.autocomplete)?void 0:o.delay)}}}static setupElement(e){const{element:t,config:a}=e,n=t.getAttribute("name")||"";e.originalName=n;const s=t.parentNode;e.originalInput=t,t.setAttribute("name",`${n}_text`),t.className="tags-input",e.input=t;const r=document.createElement("div");r.className="tags-input-wrapper";const i=document.createElement("ul");i.className="tags-container";const o=document.createElement("li");o.className="tags-input-li",o.appendChild(t),i.appendChild(o),r.appendChild(i);const l=document.createElement("div");l.className="tags-hidden-inputs",l.style.display="none",r.appendChild(l),s.appendChild(r),e.wrapper=r,e.tagsContainer=i,e.inputLi=o,e.hiddenInputsContainer=l,e.tags=[],e.tagElements=new Map,e._localeChangeHandler=()=>{try{const t=window.Now&&Now.getManager?Now.getManager("i18n"):null;e.tagElements.forEach((a,n)=>{const s=e.tags.find(e=>e.key===n);if(!s)return;let r=s.value;try{if((r===n||!r)&&e&&e.config&&e.config.autocomplete&&e.config.autocomplete.source){const t=TextElementFactory.normalizeSource(e.config.autocomplete.source);if(t&&Array.isArray(t)){const e=t.find(e=>String(e.value)===String(n));e&&(r=e.text)}}}catch(o){r=s.value}try{t&&"function"==typeof t.interpolate&&(r=t.interpolate(r,{}))}catch(o){}const i=a.querySelector(".tag-text");i&&(i.textContent=r)})}catch(t){}};try{EventManager.on&&EventManager.on("locale:changed",e._localeChangeHandler)}catch(u){}const c=a.autocomplete;((null==c?void 0:c.enabled)||(null==c?void 0:c.source))&&(c.enabled=!0,this.setupAutocomplete(e)),this.setupEventHandlers(e);const d=t.value;if(d){let t=[];try{const e=JSON.parse(d);t=Array.isArray(e)?e:[d]}catch(u){t=d.split(a.separator).map(e=>e.trim()).filter(e=>e)}t.forEach(t=>{"object"==typeof t&&t.key&&t.value?this.addTag(e,t.key,t.value):this.addTag(e,t,t)})}return e.addTag=(t,a)=>this.addTag(e,t,a),e.removeTag=t=>this.removeTag(e,t),e.clear=()=>this.clearTags(e),e.getTags=()=>this.getTags(e),e.setTags=t=>this.setTags(e,t),e.updateOptions=t=>this.updateOptions(e,t),e.setValue=t=>{this.propertyHandlers&&this.propertyHandlers.value&&this.propertyHandlers.value.set&&this.propertyHandlers.value.set.call(this,e,t)},e}static setupAutocomplete(e){const{input:t,config:a}=e,n=a.autocomplete;e.dropdownPanel=DropdownPanel.getInstance(),e.dropdown=document.createElement("ul"),e.dropdown.className="autocomplete-list",e.list=[],e.listIndex=0;const s=this.readFromDatalist(e.originalInput);s&&(n.source=s),e.populate=a=>{if(document.activeElement!==t&&!e._isActive)return;e.dropdown.innerHTML="",e.list=[];const s=t.value.trim(),r=new RegExp(`(${this.escapeRegExp(s)})`,"gi");let i=0;const o=TextElementFactory.normalizeSource(a);if(o){for(const t of o){if(i>=n.maxResults)break;if(!s||r.test(t.text)){const a=this.createListItem(e,t.value,t.text,s);e.list.push(a),e.dropdown.appendChild(a),i++}}e.highlightItem(0),e.list.length?e.show():e.hide()}},e.show=()=>{e.dropdownPanel.show(t,e.dropdown,{align:"left",offsetY:2,onClose:()=>{}})},e.hide=()=>{e.dropdownPanel.isOpen()&&e.dropdownPanel.currentTarget===t&&e.dropdownPanel.hide()},e.highlightItem=t=>{e.listIndex=Math.max(0,Math.min(e.list.length-1,t)),e.list.forEach((t,a)=>t.classList.toggle("active",a===e.listIndex)),e.scrollToItem()},e.scrollToItem=()=>{const t=e.list[e.listIndex];if(t){const a=e.dropdown.getBoundingClientRect(),n=t.getBoundingClientRect();n.top<a.top?e.dropdown.scrollTop=t.offsetTop:n.bottom>a.bottom&&(e.dropdown.scrollTop=t.offsetTop-a.height+n.height)}},e.selectItem=(a,s)=>{this.addTag(e,a,s),t.value="",e.populate(n.source)}}static createListItem(e,t,a,n){const{config:s}=e;s.autocomplete;const r=document.createElement("li");r.dataset.key=t;const i=document.createElement("span");let o=a;try{if(window.Now&&Now.getManager){const e=Now.getManager("i18n");e&&"function"==typeof e.interpolate&&(o=e.interpolate(a,{}))}}catch(l){o=a}if(n){const e=new RegExp(this.escapeRegExp(n),"gi"),t=o.split(e),a=o.match(e)||[];t.forEach((e,t)=>{if(e&&i.appendChild(document.createTextNode(e)),t<a.length){const e=document.createElement("em");e.textContent=a[t],i.appendChild(e)}})}else i.textContent=o;return r.appendChild(i),r.addEventListener("mousedown",()=>e.selectItem(t,a)),r.addEventListener("mousemove",()=>e.highlightItem(e.list.indexOf(r))),r}static readFromDatalist(e){const t=e.getAttribute("list");if(!t)return null;const a=document.getElementById(t);if(!a)return null;const n=Array.from(a.querySelectorAll("option")),s=[];return n.forEach(e=>{const t=e.label||e.textContent,a=e.value||t;s.push({value:a,text:t})}),e.removeAttribute("list"),a.remove(),s.length>0?s:null}static escapeRegExp(e){return e.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")}static setupEventHandlers(e){var t;const{input:a,tagsContainer:n,config:s}=e,r=s.autocomplete;if(e._eventHandlersSetup)return;e._eventHandlersSetup=!0,EventSystemManager.addHandler(n,"click",e=>{e.target&&e.target.closest&&e.target.closest("button.tag-remove")||a.focus()}),a.addEventListener("keydown",t=>{var n,s,r;if("Enter"===t.key){t.preventDefault();const s=e.config.autocomplete;if((null==s?void 0:s.enabled)&&(null==(n=e.dropdownPanel)?void 0:n.isOpen())&&e.dropdownPanel.currentTarget===a){const t=e.list[e.listIndex];if(t){const a=t.textContent||t.innerText,n=t.dataset.key;e.selectItem(n,a)}}else{const t=a.value.trim();t&&(this.addTag(e,t,t),a.value="",(null==s?void 0:s.enabled)&&(null==s?void 0:s.source)&&e.populate(s.source))}}else if("Backspace"===t.key&&""===a.value){if(t.preventDefault(),e.tags.length>0&&!a.readOnly&&!a.disabled){const t=e.tags[e.tags.length-1];this.removeTag(e,t.key)}}else(null==(s=e.config.autocomplete)?void 0:s.enabled)&&(null==(r=e.dropdownPanel)?void 0:r.isOpen())&&e.dropdownPanel.currentTarget===a&&("ArrowDown"===t.key?(e.highlightItem(e.listIndex+1),t.preventDefault()):"ArrowUp"===t.key?(e.highlightItem(e.listIndex-1),t.preventDefault()):"Escape"===t.key&&(e.hide(),t.preventDefault()))});const i=Utils.function.debounce(t=>{const a=e.config.autocomplete;(null==a?void 0:a.enabled)&&(null==a?void 0:a.source)&&(t.length<(a.minLength||2)?e.hide():e.populate(a.source))},(null==r?void 0:r.delay)||300);a.addEventListener("input",t=>{const a=t.target.value.trim(),n=e.config.autocomplete;(null==n?void 0:n.enabled)&&i(a)});return EventSystemManager.addHandler(a,"focus",()=>{e._isActive=!0;const t=e.config.autocomplete;if((null==t?void 0:t.enabled)&&(null==t?void 0:t.source)&&"function"==typeof e.populate){const n=a.value;a.value="";try{e.populate(t.source)}finally{a.value=n}}},{capture:!0}),EventSystemManager.addHandler(a,"blur",()=>{e._isActive=!1,setTimeout(()=>{var t;const a=null==(t=e.dropdownPanel)?void 0:t.panel;e._isActive||a&&a.contains(document.activeElement)||e.hide()},200)},{capture:!0}),EventSystemManager.addHandler(a,"paste",t=>{setTimeout(()=>{const t=a.value;if(t.includes(s.separator)){t.split(s.separator).map(e=>e.trim()).filter(e=>e).forEach(t=>this.addTag(e,t,t)),a.value=""}},0)}),(null==(t=super.setupEventListeners)?void 0:t.call(this,e))||{}}static addTag(e,t,a){const{config:n,tags:s,tagElements:r,tagsContainer:i,inputLi:o,hiddenInputsContainer:l,originalName:c}=e;if(n.maxTags&&s.length>=n.maxTags)return NotificationManager.warning(n.validationMessages.maxTags),!1;if(!n.duplicates&&s.some(e=>e.key===t))return NotificationManager.warning(n.validationMessages.duplicate),!1;if(e.input.readOnly||e.input.disabled)return!1;const d=document.createElement("li");d.className="tag-item",d.dataset.key=t;const u=document.createElement("span");u.className="tag-text";let h=a;try{if((a===t||!a)&&e&&e.config&&e.config.autocomplete&&e.config.autocomplete.source){const a=TextElementFactory.normalizeSource(e.config.autocomplete.source);if(a&&Array.isArray(a)){const e=a.find(e=>String(e.value)===String(t));e&&(h=e.text)}}}catch(g){h=a}try{if(window.Now&&Now.getManager){const e=Now.getManager("i18n");e&&"function"==typeof e.interpolate&&(h=e.interpolate(h,{}))}}catch(g){}u.textContent=h,d.appendChild(u);const p=document.createElement("button");p.type="button",p.className="tag-remove",p.innerHTML="×",p.setAttribute("aria-label",`Remove ${a}`),d.appendChild(p);const m=document.createElement("input");return m.type="hidden",m.name=`${c}[]`,m.value=t,m.dataset.tagKey=t,l.appendChild(m),i.insertBefore(d,o),s.push({key:t,value:a}),r.set(t,d),EventSystemManager.addHandler(p,"click",a=>{a.stopPropagation(),this.removeTag(e,t)}),e.input.dispatchEvent(new Event("change",{bubbles:!0})),!0}static removeTag(e,t){const{tags:a,tagElements:n,hiddenInputsContainer:s,input:r}=e;if(r.readOnly||r.disabled)return!1;const i=a.findIndex(e=>e.key===t);if(-1===i)return!1;const o=n.get(t);o&&o.parentNode&&o.parentNode.removeChild(o);const l=s.querySelector(`[data-tag-key="${t}"]`);return l&&l.remove(),a.splice(i,1),n.delete(t),r.dispatchEvent(new Event("change",{bubbles:!0})),!0}static clearTags(e){const{tags:t}=e;t.map(e=>e.key).forEach(t=>this.removeTag(e,t))}static getTags(e){return e.tags.map(e=>({...e}))}static setTags(e,t){this.clearTags(e),Array.isArray(t)&&t.forEach(t=>{"string"==typeof t?this.addTag(e,t,t):t.key&&t.value&&this.addTag(e,t.key,t.value)})}static updateOptions(e,t){const{config:a}=e;a.autocomplete&&(a.autocomplete.source=t,a.autocomplete.enabled=!0,e.dropdownPanel||this.setupAutocomplete(e))}static populateFromOptions(e,t,a){if(!e||!t||!a)return;const n=t[a];if(!n||!Array.isArray(n))return;let s=null==ElementManager?void 0:ElementManager.getInstanceByElement(e);!s&&window.ElementManager&&(s=ElementManager.enhance(e)),s?this.updateOptions(s,n):console.warn("[TagsElementFactory] Element not enhanced yet")}static populateFromOptionsInContainer(e,t){if(!e||!t)return;e.querySelectorAll('input[data-options-key][data-element="tags"]').forEach(e=>{const a=e.dataset.optionsKey;this.populateFromOptions(e,t,a)})}static cleanup(e){var t,a;if(e){(null==(t=e.dropdownPanel)?void 0:t.isOpen())&&e.dropdownPanel.currentTarget===e.input&&e.dropdownPanel.hide(),e.wrapper&&e.wrapper.parentNode&&e.wrapper.parentNode.removeChild(e.wrapper),e.originalInput&&(e.originalInput.style.display="",e.originalInput.removeAttribute("aria-hidden"));try{e._localeChangeHandler&&EventManager.off&&EventManager.off("locale:changed",e._localeChangeHandler)}catch(n){}null==(a=super.cleanup)||a.call(this,e)}}},__publicField(I,"config",{...ElementFactory.config,type:"text",placeholder:"Add tags...",separator:",",maxTags:null,duplicates:!1,autocomplete:{enabled:!1,source:null,minLength:2,maxResults:10,delay:300},validationMessages:{maxTags:"Maximum number of tags reached",duplicate:"This tag already exists"}}),__publicField(I,"propertyHandlers",{value:{get(e){const t=e.closest(".tags-input-wrapper");if(!t)return[];const a=t.querySelector(".tags-hidden-inputs");return a?Array.from(a.querySelectorAll('input[type="hidden"]')).map(e=>e.value):[]},set(e,t){if(Array.isArray(t))this.clearTags(e),t.forEach(t=>{"object"==typeof t&&t.key&&t.value?this.addTag(e,t.key,t.value):this.addTag(e,t,t)});else if("string"==typeof t){try{const a=JSON.parse(t);if(Array.isArray(a))return this.clearTags(e),void a.forEach(t=>{"object"==typeof t&&t.key&&t.value?this.addTag(e,t.key,t.value):this.addTag(e,t,t)})}catch(a){}const n=t.split(e.config.separator).map(e=>e.trim()).filter(e=>e);this.clearTags(e),n.forEach(t=>this.addTag(e,t,t))}}}}),I);ElementManager.registerElement("tags",De),window.TagsElementFactory=De;let Ne=(D=class extends ElementFactory{static setupElement(e){const{element:t,config:a}=e;if("SELECT"!==t.tagName||!t.multiple)return console.error("MultiSelectElementFactory: Element must be a <select multiple>"),e;Array.from(t.options).forEach(e=>{e.dataset.i18n||(e.dataset.i18n=e.textContent)});const n=t.dataset.placeholder||t.getAttribute("placeholder")||a.placeholder||"";t.style.display="none",t.style.height="100px",t.style.width="100px",t.setAttribute("aria-hidden","true");const s=document.createElement("button");s.type="button",s.className="dropdown-button",t.required&&(s.dataset.required="true"),t.disabled&&s.classList.add("disabled"),s.setAttribute("role","button"),s.setAttribute("aria-haspopup","listbox"),s.setAttribute("aria-expanded","false"),t.parentNode.insertBefore(s,t.nextSibling);const r=document.createElement("span");r.className="dropdown-display",r.textContent=n,n&&r.classList.add("placeholder"),s.appendChild(r);const i=document.createElement("span");i.className="dropdown-arrow",s.appendChild(i),e.element=t,e.trigger=s,e.selectedDisplay=r,e.placeholder=n,e.dropdownPanel=DropdownPanel.getInstance(),e.dropdown=document.createElement("ul"),e.dropdown.className="autocomplete-list",e.dropdown.setAttribute("tabindex","0"),e.highlightedIndex=-1,this.setupDropdownKeyboardNavigation(e),this.setupEventHandlers(e),e._localeChangeHandler=()=>{try{this.retranslate(e)}catch(t){}};try{EventManager.on&&EventManager.on("locale:changed",e._localeChangeHandler)}catch(o){}return this.retranslate(e),this.updateDisplay(e),e.updateOptions=a=>{this.updateOptions(t,a),this.updateDisplay(e)},e.setValue=e=>{this.setSelectedValues(t,e)},e.getValue=()=>this.getSelectedValues(t),e.clear=()=>{this.clearSelection(e)},e}static setupDropdownKeyboardNavigation(e){if(e._dropdownKeyboardSetup)return;e._dropdownKeyboardSetup=!0;const{dropdown:t,element:a}=e,handleDropdownKeydown=n=>{const s=Array.from(t.querySelectorAll("li[data-index]"));if(0!==s.length)switch(n.key){case"ArrowDown":n.preventDefault(),e.highlightedIndex=Math.min(e.highlightedIndex+1,s.length-1),this.updateHighlight(e,s);break;case"ArrowUp":n.preventDefault(),e.highlightedIndex=Math.max(e.highlightedIndex-1,0),this.updateHighlight(e,s);break;case" ":case"Spacebar":if(n.preventDefault(),e.highlightedIndex>=0&&e.highlightedIndex<s.length){const t=s[e.highlightedIndex],n=t.dataset.value,r=t.querySelector("span");this.getSelectedValues(a).includes(n)?(this.removeValue(a,n),t.setAttribute("aria-selected","false"),r.className="icon-uncheck"):(this.addValue(a,n,t.querySelector("span:last-child").textContent),t.setAttribute("aria-selected","true"),r.className="icon-check"),this.updateDisplay(e),this.triggerChange(e)}break;case"Tab":case"Escape":n.preventDefault();const t=e.dropdownPanel;t&&t.isOpen()&&t.currentTarget===e.trigger&&(t.hide(),e.trigger.setAttribute("aria-expanded","false"),e.highlightedIndex=-1,e.trigger.focus())}},handleDropdownBlur=a=>{setTimeout(()=>{const a=e.dropdownPanel;if(!a)return;const n=document.activeElement,s=t.contains(n)||n===t,r=n===e.trigger;s||r||!a.isOpen()||a.currentTarget!==e.trigger||(a.hide(),e.trigger.setAttribute("aria-expanded","false"),e.highlightedIndex=-1)},100)};t.addEventListener("keydown",handleDropdownKeydown),t.addEventListener("blur",handleDropdownBlur),e._dropdownCleanup=()=>{t.removeEventListener("keydown",handleDropdownKeydown),t.removeEventListener("blur",handleDropdownBlur)}}static setupEventHandlers(e){var t;const{trigger:a}=e,handleTriggerClick=t=>{if(t.preventDefault(),t.stopPropagation(),a.classList.contains("disabled"))return;const n=e.dropdownPanel;n&&(n.isOpen()&&n.currentTarget===a?(n.hide(),a.setAttribute("aria-expanded","false"),e.highlightedIndex=-1):(this.createOptionsList(e),n.show(a,e.dropdown,{align:"left",offsetY:5,onClose:()=>{a.setAttribute("aria-expanded","false"),e.highlightedIndex=-1}}),a.setAttribute("aria-expanded","true"),e.highlightedIndex=-1,setTimeout(()=>{e.dropdown.focus()},50)))};a.addEventListener("click",handleTriggerClick);const handleTriggerKeydown=e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),handleTriggerClick(e))};a.addEventListener("keydown",handleTriggerKeydown);const handleTriggerBlur=t=>{setTimeout(()=>{const t=e.dropdownPanel;if(!t)return;const n=document.activeElement;e.dropdown.contains(n)||n===e.dropdown||n===a||!t.isOpen()||t.currentTarget!==a||(t.hide(),a.setAttribute("aria-expanded","false"),e.highlightedIndex=-1)},100)};return a.addEventListener("blur",handleTriggerBlur),e._cleanup=()=>{a.removeEventListener("click",handleTriggerClick),a.removeEventListener("keydown",handleTriggerKeydown),a.removeEventListener("blur",handleTriggerBlur)},(null==(t=super.setupEventListeners)?void 0:t.call(this,e))||{}}static createOptionsList(e){const{element:t,dropdown:a,config:n}=e;a.innerHTML="";const s=Array.from(t.options).filter(e=>""!==e.value&&!e.disabled);if(0===s.length){const e=document.createElement("li");return e.className="multi-select-empty",e.textContent=Now.translate(n.emptyMessage),void a.appendChild(e)}const r=this.getSelectedValues(t);s.forEach((n,s)=>{const i=document.createElement("li");i.dataset.value=n.value,i.dataset.index=s,i.setAttribute("role","option"),i.setAttribute("tabindex","-1");const o=document.createElement("span");i.appendChild(o);r.includes(n.value)?(o.className="icon-check",i.setAttribute("aria-selected","true")):o.className="icon-uncheck";const l=document.createElement("span");l.textContent=n.textContent,n.dataset.i18n&&l.setAttribute("data-i18n",n.dataset.i18n),i.appendChild(l);i.addEventListener("click",a=>{a.stopPropagation();this.getSelectedValues(t).includes(n.value)?(this.removeValue(t,n.value),i.setAttribute("aria-selected","false"),o.className="icon-uncheck"):(this.addValue(t,n.value,n.textContent),i.setAttribute("aria-selected","true"),o.className="icon-check"),this.updateDisplay(e),this.triggerChange(e)}),a.appendChild(i)}),a.setAttribute("tabindex","0")}static updateHighlight(e,t){if(t.forEach(e=>e.classList.remove("active")),e.highlightedIndex>=0&&e.highlightedIndex<t.length){const a=t[e.highlightedIndex];a.classList.add("active"),a.scrollIntoView({block:"nearest",behavior:"smooth"})}}static getSelectedValues(e){return e&&"SELECT"===e.tagName?Array.from(e.selectedOptions).map(e=>e.value):[]}static addValue(e,t,a){if(!e||"SELECT"!==e.tagName)return;const n=Array.from(e.options).find(e=>e.value==t||String(e.value)===String(t));n&&(n.selected=!0)}static removeValue(e,t){if(!e||"SELECT"!==e.tagName)return;const a=Array.from(e.options).find(e=>e.value==t||String(e.value)===String(t));a&&(a.selected=!1)}static setSelectedValues(e,t){if(Array.isArray(t)||(t=[]),!e||"SELECT"!==e.tagName)return;const a=t.map(e=>String(e));Array.from(e.options).forEach(e=>e.selected=!1),Array.from(e.options).forEach(e=>{a.includes(e.value)&&(e.selected=!0)});const n=ElementManager.getInstanceByElement(e);n&&this.updateDisplay(n)}static updateDisplay(e){const{element:t,selectedDisplay:a,placeholder:n,config:s}=e;if(!t||"SELECT"!==t.tagName)return;const r=Array.from(t.selectedOptions),i=r.length;if(0===i){let e=n||"";try{e=Now.translate?Now.translate(n||""):n||""}catch(l){e=n||""}return a.textContent=e,void a.classList.add("placeholder")}a.classList.remove("placeholder");const o=s.maxDisplayItems||2;if(i<=o){const e=r.map(e=>e.textContent);a.textContent=e.join(", ")}else{const e=r.slice(0,o).map(e=>e.textContent),t=i-o;a.textContent=`${e.join(", ")} +${t} ${Now.translate("items")}`}}static triggerChange(e){const{element:t}=e;if(t&&"SELECT"===t.tagName&&t.dispatchEvent(new Event("change",{bubbles:!0})),e.config&&"function"==typeof e.config.onChange){const a=this.getSelectedValues(t);e.config.onChange(t,a)}}static retranslate(e){if(!e||!e.element||"SELECT"!==e.element.tagName)return;Array.from(e.element.options).forEach(e=>{const t=e.dataset&&e.dataset.i18n?e.dataset.i18n:e.textContent;void 0!==t&&(e.textContent=(e=>{try{return Now.translate?Now.translate(e||""):e||""}catch(t){return e||""}})(t))}),this.updateDisplay(e)}static clearSelection(e){const{element:t}=e;t&&"SELECT"===t.tagName&&Array.from(t.options).forEach(e=>e.selected=!1),this.updateDisplay(e),this.triggerChange(e)}static updateOptions(e,t){if(!e||"SELECT"!==e.tagName)return;const a=Array.from(e.selectedOptions).map(e=>e.value),n=e.querySelector('option[value=""][disabled]');e.innerHTML="",n&&e.appendChild(n),Array.isArray(t)&&t.forEach(t=>{const a=document.createElement("option");a.value=t.value||"",a.textContent=Now.translate(t.text||t.label||t.value||""),(t.text||t.label)&&(a.dataset.i18n=t.text||t.label),t.disabled&&(a.disabled=!0),t.data&&Object.entries(t.data).forEach(([e,t])=>{a.dataset[e]=t}),e.appendChild(a)});const s=a.map(e=>String(e));Array.from(e.options).forEach(e=>{s.includes(e.value)&&(e.selected=!0)})}static customValidateValue(e){const t=this.element;if(t.required||"true"===t.dataset.required){const a=t.selectedOptions;if(!a||0===a.length)return{validatedValue:e,error:Now.translate(this.config.validationMessages.required)}}return{validatedValue:e,error:null}}static cleanup(e){var t,a;if(!e)return;e._cleanup&&e._cleanup(),e._dropdownCleanup&&e._dropdownCleanup(),e._localeChangeHandler&&window.EventManager&&(EventManager.off("locale:changed",e._localeChangeHandler),delete e._localeChangeHandler);const n=null==(t=window.DropdownPanel)?void 0:t.getInstance();n&&n.currentTarget===e.trigger&&n.hide(),e.trigger&&e.trigger.parentNode&&e.trigger.parentNode.removeChild(e.trigger),e.element&&"SELECT"===e.element.tagName&&(e.element.style.display="",e.element.removeAttribute("aria-hidden")),null==(a=super.cleanup)||a.call(this,e)}static create(e){return console.warn("MultiSelectElementFactory.create() is not supported. Use existing <select multiple> element."),null}static populateFromOptions(e,t,a){if(!e||!t||!a)return;let n=t[a];if(!n)return;if(!Array.isArray(n))return void console.warn('Please update your API to return options in format: [{value: "1", text: "Option 1"}, ...]');if(n.some(e=>"object"!=typeof e||!("value"in e)||!("text"in e)))return;const s=Array.from(e.selectedOptions).map(e=>e.value);this.updateOptions(e,n,"true"===e.dataset.useOptGroups),s.length>0&&this.setSelectedValues(e,s)}static populateFromOptionsInContainer(e,t){if(!e||!t)return;e.querySelectorAll("select[data-options-key][multiple]").forEach(e=>{const a=e.dataset.optionsKey;this.populateFromOptions(e,t,a)})}},__publicField(D,"config",{...ElementFactory.config,maxDisplayItems:2,emptyMessage:"No options available",validationMessages:{required:"Please select at least one option"}}),__publicField(D,"propertyHandlers",{value:{get:e=>e&&"SELECT"===e.tagName?Array.from(e.selectedOptions).map(e=>e.value):[],set(e,t){if(!Array.isArray(t))if("string"==typeof t&&t.startsWith("["))try{t=JSON.parse(t)}catch(a){t=t?[t]:[]}else t=t?[t]:[];this.setSelectedValues(e.element,t)}},selectedOptions:{get:e=>e&&"SELECT"===e.tagName?Array.from(e.selectedOptions).map(e=>({value:e.value,text:e.textContent,data:e.dataset})):[]}}),D);ElementManager.registerElement("select-multiple",Ne),window.MultiSelectElementFactory=Ne;class EmbeddedRangeSlider{constructor(e){if(this._original=e,!this._original)throw new Error("RangeSlider: Original element is required");this.name=this._original.getAttribute("name")||"",this.id=this._original.id||"rangeslider-"+Math.random().toString(36).slice(2,8),this._original.closest(".form-control").classList.add("form-control-range"),this.min=parseFloat(this._original.getAttribute("min"))||0,this.max=parseFloat(this._original.getAttribute("max"))||100,this.step=parseFloat(this._original.getAttribute("step"))||this._calculateStep(),this.isDualRange=this._original.hasAttribute("range")||this._original.hasAttribute("data-range"),this.showLabels=this._original.hasAttribute("data-show-labels"),this.showTooltips=this._original.hasAttribute("data-show-tooltips"),this.prefix=this._original.getAttribute("data-prefix")||"",this.suffix=this._original.getAttribute("data-suffix")||"",this.disabled=this._original.hasAttribute("disabled"),this.readonly=this._original.hasAttribute("readonly"),this.isDragging=!1,this.activeHandle=null,this._parseInitialValues(),this._initializeElements(),this._setupEventListeners(),this._replaceOriginalElement(),this._updateDisplay()}_calculateStep(){const e=this.max-this.min;return e<1?.01:e<100?1:Math.floor(e/100*1e3)/1e3}_parseInitialValues(){const e=this._original.value||this._original.getAttribute("value")||"";if(this.isDualRange){if(e.includes(",")){const t=e.split(",").map(e=>parseFloat(e.trim()));this.values=[Math.max(this.min,Math.min(this.max,t[0]||this.min)),Math.max(this.min,Math.min(this.max,t[1]||this.max))]}else this.values=[this.min,this.max];this.values[0]>this.values[1]&&([this.values[0],this.values[1]]=[this.values[1],this.values[0]])}else this.values=Math.max(this.min,Math.min(this.max,parseFloat(e)||this.min))}_initializeElements(){this.wrapper=document.createElement("div"),this.wrapper.className="custom-range-slider",this.wrapper.id=this.id+"_wrapper",this.showLabels&&(this.labelsContainer=document.createElement("div"),this.labelsContainer.className="range-labels",this.minLabel=document.createElement("span"),this.minLabel.className="range-label min",this.minLabel.textContent=this._formatValue(this.min),this.maxLabel=document.createElement("span"),this.maxLabel.className="range-label max",this.maxLabel.textContent=this._formatValue(this.max),this.labelsContainer.appendChild(this.minLabel),this.labelsContainer.appendChild(this.maxLabel),this.wrapper.appendChild(this.labelsContainer)),this.sliderContainer=document.createElement("div"),this.sliderContainer.className="slider-container",this.wrapper.appendChild(this.sliderContainer),this.track=document.createElement("div"),this.track.className="slider-track",this.sliderContainer.appendChild(this.track),this.range=document.createElement("div"),this.range.className="slider-range",this.track.appendChild(this.range),this.leftHandle=document.createElement("div"),this.leftHandle.className="slider-handle left",this.leftHandle.tabIndex=0,this.leftHandle.setAttribute("role","slider"),this.leftHandle.setAttribute("aria-valuemin",this.min),this.leftHandle.setAttribute("aria-valuemax",this.max),this.sliderContainer.appendChild(this.leftHandle),this.isDualRange&&(this.rightHandle=document.createElement("div"),this.rightHandle.className="slider-handle right",this.rightHandle.tabIndex=0,this.rightHandle.setAttribute("role","slider"),this.rightHandle.setAttribute("aria-valuemin",this.min),this.rightHandle.setAttribute("aria-valuemax",this.max),this.sliderContainer.appendChild(this.rightHandle)),this.showTooltips&&(this.leftTooltip=document.createElement("div"),this.leftTooltip.className="slider-tooltip left",this.leftHandle.appendChild(this.leftTooltip),this.isDualRange&&(this.rightTooltip=document.createElement("div"),this.rightTooltip.className="slider-tooltip right",this.rightHandle.appendChild(this.rightTooltip))),this.valueDisplay=document.createElement("div"),this.valueDisplay.className="range-value-display",this.wrapper.appendChild(this.valueDisplay),this.hiddenInput=document.createElement("input"),this.hiddenInput.type="hidden",this.hiddenInput.name=this.name,this.hiddenInput.id=this.id+"_hidden",this.wrapper.appendChild(this.hiddenInput)}_setupEventListeners(){this._setupMouseEvents(),this._setupKeyboardEvents(),this._setupTouchEvents(),this._setupResizeObserver()}_setupMouseEvents(){this.track.addEventListener("mousedown",e=>{if(this.disabled||this.readonly)return;const t=this.track.getBoundingClientRect(),a=(e.clientX-t.left)/t.width,n=this.min+a*(this.max-this.min);if(this.isDualRange){Math.abs(n-this.values[0])<=Math.abs(n-this.values[1])?(this.values[0]=this._snapToStep(n),this.activeHandle=this.leftHandle):(this.values[1]=this._snapToStep(n),this.activeHandle=this.rightHandle),this._ensureValidRange()}else this.values=this._snapToStep(n),this.activeHandle=this.leftHandle;this._updateDisplay(),this._dispatchChangeEvent(),this._startDrag(e)}),this.leftHandle.addEventListener("mousedown",e=>{this.disabled||this.readonly||(e.preventDefault(),this.activeHandle=this.leftHandle,this._startDrag(e))}),this.rightHandle&&this.rightHandle.addEventListener("mousedown",e=>{this.disabled||this.readonly||(e.preventDefault(),this.activeHandle=this.rightHandle,this._startDrag(e))})}_setupKeyboardEvents(){const handleKeydown=(e,t=!1)=>{if(this.disabled||this.readonly)return;let a=!1;switch(this.isDualRange?t?this.values[1]:this.values[0]:this.values,e.key){case"ArrowLeft":case"ArrowDown":e.preventDefault(),this._adjustValue(t,-this.step),a=!0;break;case"ArrowRight":case"ArrowUp":e.preventDefault(),this._adjustValue(t,this.step),a=!0;break;case"PageDown":e.preventDefault(),this._adjustValue(t,10*-this.step),a=!0;break;case"PageUp":e.preventDefault(),this._adjustValue(t,10*this.step),a=!0;break;case"Home":e.preventDefault(),this.isDualRange?t?this.values[1]=this.values[0]:this.values[0]=this.min:this.values=this.min,this._updateDisplay(),this._dispatchChangeEvent(),a=!0;break;case"End":e.preventDefault(),this.isDualRange?t?this.values[1]=this.max:this.values[0]=this.values[1]:this.values=this.max,this._updateDisplay(),this._dispatchChangeEvent(),a=!0}a&&e.stopPropagation()};this.leftHandle.addEventListener("keydown",e=>handleKeydown(e,!1)),this.rightHandle&&this.rightHandle.addEventListener("keydown",e=>handleKeydown(e,!0))}_setupTouchEvents(){this.leftHandle.addEventListener("touchstart",e=>{this.disabled||this.readonly||(e.preventDefault(),this.activeHandle=this.leftHandle,this._startDrag(e.touches[0]))}),this.rightHandle&&this.rightHandle.addEventListener("touchstart",e=>{this.disabled||this.readonly||(e.preventDefault(),this.activeHandle=this.rightHandle,this._startDrag(e.touches[0]))})}_setupResizeObserver(){window.ResizeObserver&&(this.resizeObserver=new ResizeObserver(()=>{this._updateDisplay()}),this.resizeObserver.observe(this.sliderContainer))}_startDrag(e){this.isDragging=!0,this.wrapper.classList.add("dragging");const handleMouseMove=e=>{if(!this.isDragging)return;const t=e.clientX||e.touches&&e.touches[0].clientX;if(!t)return;const a=this.track.getBoundingClientRect(),n=Math.max(0,Math.min(1,(t-a.left)/a.width)),s=this.min+n*(this.max-this.min);this.isDualRange?(this.activeHandle===this.leftHandle?this.values[0]=this._snapToStep(s):this.values[1]=this._snapToStep(s),this._ensureValidRange()):this.values=this._snapToStep(s),this._updateDisplay(),this._dispatchInputEvent()},handleMouseUp=()=>{this.isDragging&&(this.isDragging=!1,this.wrapper.classList.remove("dragging"),this.activeHandle=null,this._dispatchChangeEvent()),document.removeEventListener("mousemove",handleMouseMove),document.removeEventListener("mouseup",handleMouseUp),document.removeEventListener("touchmove",handleMouseMove),document.removeEventListener("touchend",handleMouseUp)};document.addEventListener("mousemove",handleMouseMove),document.addEventListener("mouseup",handleMouseUp),document.addEventListener("touchmove",handleMouseMove),document.addEventListener("touchend",handleMouseUp)}_adjustValue(e,t){this.isDualRange?(e?this.values[1]=this._snapToStep(this.values[1]+t):this.values[0]=this._snapToStep(this.values[0]+t),this._ensureValidRange()):this.values=this._snapToStep(this.values+t),this._updateDisplay(),this._dispatchChangeEvent()}_snapToStep(e){const t=Math.round((e-this.min)/this.step)*this.step+this.min;return Math.max(this.min,Math.min(this.max,t))}_ensureValidRange(){this.isDualRange&&this.values[0]>this.values[1]&&([this.values[0],this.values[1]]=[this.values[1],this.values[0]])}_updateDisplay(){const e=this.max-this.min;if(this.isDualRange){const t=(this.values[0]-this.min)/e*100,a=(this.values[1]-this.min)/e*100;this.leftHandle.style.left=`${t}%`,this.rightHandle.style.left=`${a}%`,this.range.style.left=`${t}%`,this.range.style.width=a-t+"%",this.leftHandle.setAttribute("aria-valuenow",this.values[0]),this.rightHandle.setAttribute("aria-valuenow",this.values[1]),this.showTooltips&&(this.leftTooltip.textContent=this._formatValue(this.values[0]),this.rightTooltip.textContent=this._formatValue(this.values[1])),this.valueDisplay.textContent=`${this._formatValue(this.values[0])} - ${this._formatValue(this.values[1])}`,this.hiddenInput.value=`${this.values[0]},${this.values[1]}`}else{const t=(this.values-this.min)/e*100;this.leftHandle.style.left=`${t}%`,this.range.style.width=`${t}%`,this.leftHandle.setAttribute("aria-valuenow",this.values),this.showTooltips&&(this.leftTooltip.textContent=this._formatValue(this.values)),this.valueDisplay.textContent=this._formatValue(this.values),this.hiddenInput.value=this.values.toString()}}_formatValue(e){const t=this.step<1?2:0,a=Utils.number.format(e,t);return`${this.prefix}${a}${this.suffix}`}_dispatchInputEvent(){const e=new Event("input",{bubbles:!0});this.hiddenInput.dispatchEvent(e),this.wrapper.dispatchEvent(new CustomEvent("rangeslider:input",{detail:{values:this.isDualRange?[...this.values]:this.values,min:this.min,max:this.max}}))}_dispatchChangeEvent(){const e=new Event("change",{bubbles:!0});this.hiddenInput.dispatchEvent(e),this.wrapper.dispatchEvent(new CustomEvent("rangeslider:change",{detail:{values:this.isDualRange?[...this.values]:this.values,min:this.min,max:this.max}}))}getValue(){return this.isDualRange?[...this.values]:this.values}setValue(e){this.isDualRange?Array.isArray(e)&&e.length>=2&&(this.values=[this._snapToStep(e[0]),this._snapToStep(e[1])],this._ensureValidRange()):this.values=this._snapToStep(e),this._updateDisplay()}setMin(e){this.min=e,this.leftHandle.setAttribute("aria-valuemin",e),this.rightHandle&&this.rightHandle.setAttribute("aria-valuemin",e),this.showLabels&&(this.minLabel.textContent=this._formatValue(e)),this._updateDisplay()}setMax(e){this.max=e,this.leftHandle.setAttribute("aria-valuemax",e),this.rightHandle&&this.rightHandle.setAttribute("aria-valuemax",e),this.showLabels&&(this.maxLabel.textContent=this._formatValue(e)),this._updateDisplay()}setStep(e){this.step=e,this._updateDisplay()}setDisabled(e){this.disabled=e,this.wrapper.classList.toggle("disabled",e),this.leftHandle.tabIndex=e?-1:0,this.rightHandle&&(this.rightHandle.tabIndex=e?-1:0)}setReadonly(e){this.readonly=e,this.wrapper.classList.toggle("readonly",e)}destroy(){this.resizeObserver&&this.resizeObserver.disconnect(),this.wrapper&&this.wrapper.parentNode&&this.wrapper.parentNode.removeChild(this.wrapper)}getElement(){return this.wrapper}_replaceOriginalElement(){this._original.parentNode&&(this._original.parentNode.insertBefore(this.wrapper,this._original),this._original.parentNode.removeChild(this._original))}}window.GRange||(window.GRange=EmbeddedRangeSlider);class RangeElementFactory extends ElementFactory{static createInstance(e,t={}){return super.createInstance(e,t)}static setupElement(e){const{element:t}=e;try{const a=new EmbeddedRangeSlider(t);e.wrapper=a.getElement(),e.rangeSlider=a,e.getValue=()=>a.getValue(),e.setValue=e=>a.setValue(e),e.setMin=e=>a.setMin(e),e.setMax=e=>a.setMax(e),e.setStep=e=>a.setStep(e),e.setDisabled=e=>a.setDisabled(e),e.setReadonly=e=>a.setReadonly(e),t.wrapper=e.wrapper,a.hiddenInput&&(a.hiddenInput.addEventListener("change",()=>{const e=new Event("change",{bubbles:!0});t.dispatchEvent(e),EventManager.emit("element:change",{elementId:t.id,values:a.getValue(),type:"range"})}),a.hiddenInput.addEventListener("input",()=>{const e=new Event("input",{bubbles:!0});t.dispatchEvent(e)})),a.wrapper.addEventListener("rangeslider:change",e=>{t.dispatchEvent(new CustomEvent("rangeslider:change",{detail:e.detail}))}),a.wrapper.addEventListener("rangeslider:input",e=>{t.dispatchEvent(new CustomEvent("rangeslider:input",{detail:e.detail}))});const n=e.cleanup;return e.cleanup=function(){return this.rangeSlider&&(this.rangeSlider.destroy(),this.rangeSlider=null),n&&n.call(this),this},e}catch(a){return console.error("RangeElementFactory: Failed to setup element:",a),e}}}__publicField(RangeElementFactory,"config",{...ElementFactory.config,type:"range"}),"undefined"!=typeof ElementManager?ElementManager.registerElement("range",RangeElementFactory):console.warn("RangeElementFactory: ElementManager not found");const _e=class _PasswordElementFactory extends TextElementFactory{static locateStrengthContainer(e){if(!e)return null;try{const t=e.nextElementSibling;if(t&&t.classList&&t.classList.contains("password-strength"))return t}catch(t){}try{if(e.wrapper){const t=e.wrapper.querySelector(".password-strength");if(t)return t}}catch(t){}try{if(e.container&&e.container.parentNode){const t=e.container.parentNode.querySelector(".password-strength");if(t)return t}}catch(t){}try{const t="result_"+(e.id||""),a=t?document.getElementById(t):null;if(a){const e=a.nextElementSibling;if(e&&e.classList&&e.classList.contains("password-strength"))return e}}catch(t){}try{const t=e.form||(e.closest?e.closest("form"):null);if(t){const e=t.querySelector(".password-strength");if(e)return e}}catch(t){}return null}static setupElement(e){var t;super.setupElement(e);const{element:a,config:n}=e;a.setAttribute("autocomplete","new-password"),a.dataset.customPasswordField="true",n.showPasswordToggle&&this.setupPasswordToggle(e),e.checkMatch=function(e){return!!e&&a.value===e.value},e.passesCriterion=function(e,t){var a;if(!t)return!1;switch(e){case"minLength":return t.length>=((null==(a=n.passwordCriteria.minLength)?void 0:a.value)||n.minLength||8);case"uppercase":return/[A-Z]/.test(t);case"lowercase":return/[a-z]/.test(t);case"numbers":return/[0-9]/.test(t);case"special":return/[^A-Za-z0-9]/.test(t);default:return!0}},e.validateSpecific=function(e){const t=TextElementFactory.prototype.validateSpecific?TextElementFactory.prototype.validateSpecific.call(this,e):null;if(t)return t;if(!e&&!a.required)return null;for(const a of this.validationRules||[]){if("password"===("string"==typeof a?a:a.name)){const t=this.getFailedCriteria(e);if(t.length>0)return Now.translate("Password must include: {criteria}",{criteria:t.join(", ")})}}return null},e.getFailedCriteria=function(t){if(!t||a.dataset.targetPassword)return[];const s=[];return Object.entries(n.passwordCriteria).forEach(([a,n])=>{if(!n.enabled||"match"===a)return;e.passesCriterion(a,t)||s.push(n.label.replace("{value}",n.value))}),s},e.updateCriteriaList=function(){if(!e.criteriaListElement)return;const t=a.value,n=this.getFailedCriteria(t),s=e.criteriaListElement.querySelectorAll("li");if(!t)return e.criteriaListElement.classList.remove("validating"),void s.forEach(e=>{e.className="icon-invalid",e.setAttribute("aria-label",Now.translate("Criteria not checked"))});s.forEach(e=>{const t=e.textContent,a=n.includes(t);e.className=a?"icon-invalid":"icon-valid",e.setAttribute("aria-label",Now.translate(a?"Criteria not met":"Criteria met"))})},e.updateMatchStatus=function(){var e,t,n,s;const r=a.dataset.targetPassword,i=r?document.getElementById(r):null,o=!!r,l=o?i:a,c=o?a:null;if(!l)return;const d=l.value,u=d.length>0,h=(null==c?void 0:c.value)||"",p=d===h&&u;if(l.classList.toggle("valid",p&&u),l.classList.toggle("invalid",!p&&u),null==(e=l.container)||e.classList.toggle("valid",p&&u),null==(t=l.container)||t.classList.toggle("invalid",!p&&u),c){const e=h.length>0;c.classList.toggle("valid",p&&e),c.classList.toggle("invalid",!p&&e),null==(n=c.container)||n.classList.toggle("valid",p&&e),null==(s=c.container)||s.classList.toggle("invalid",!p&&e)}};try{const i=a.form||(a.closest?a.closest("form"):null),o=i&&("register"===(null==(t=i.dataset)?void 0:t.form)||i.getAttribute&&"register"===i.getAttribute("data-form"));if(("bar"===a.dataset.passwordStrength||"true"===a.dataset.passwordStrength||Boolean(a.dataset.passwordStrength)||o)&&!a.dataset.targetPassword){let t=_PasswordElementFactory.locateStrengthContainer(a);if(t){e.strengthBarElement=t.querySelector(".password-strength-bar")||null;try{a.dataset.passwordStrength="true"}catch(s){}}else{const t=document.createElement("div");t.className="password-strength";const n=document.createElement("div");n.className="password-strength-bar",n.setAttribute("role","progressbar"),n.setAttribute("aria-valuemin","0"),n.setAttribute("aria-valuemax","100"),n.style.width="0%",t.appendChild(n);let i=!1;try{const e="result_"+(a.id||"");if(e){const n=a.form||(a.closest?a.closest("form"):null),s=n?n.querySelector("#"+e):document.getElementById(e);s&&s.parentNode&&(s.parentNode.insertBefore(t,s.nextSibling),i=!0)}}catch(s){}if(!i)try{a.comment&&a.comment.parentNode&&(a.comment.parentNode.insertBefore(t,a.comment.nextSibling),i=!0)}catch(s){}if(!i)try{a.wrapper&&(a.wrapper.appendChild(t),i=!0)}catch(s){}if(!i)try{if(a.container&&a.container.parentNode){a.container.parentNode.insertBefore(t,a.container.nextSibling),i=!0}}catch(s){}if(!i)try{if(a.parentNode&&a.parentNode.parentNode){const e=a.parentNode;e.parentNode.insertBefore(t,e.nextSibling),i=!0}}catch(s){}if(!i)try{a.insertAdjacentElement&&(a.insertAdjacentElement("afterend",t),i=!0)}catch(s){}if(!i)try{const e=a.form||(a.closest?a.closest("form"):null);e?e.appendChild(t):document.body.appendChild(t)}catch(s){try{document.body.appendChild(t)}catch(r){}}e.strengthBarElement=n;try{a.dataset.passwordStrength="true"}catch(s){}}e.updateStrengthBar=function(){if(!e.strengthBarElement)return;const t=a.value||"",s=Object.entries(n.passwordCriteria).filter(([e,t])=>t.enabled&&"match"!==e),r=s.length||1;let i=0;s.forEach(([a])=>{e.passesCriterion(a,t)&&(i+=1)});const o=Math.round(i/r*100);e.strengthBarElement.style.width=o+"%",e.strengthBarElement.classList.remove("weak","medium","strong"),o<40?e.strengthBarElement.classList.add("weak"):o<80?e.strengthBarElement.classList.add("medium"):e.strengthBarElement.classList.add("strong"),e.strengthBarElement.setAttribute("aria-valuenow",String(o))},e.updateStrengthBar()}}catch(s){}return n.passwordCriteriaList&&!a.dataset.targetPassword&&this.setupCriteriaList(e),e}static setupPasswordToggle(e){const{element:t}=e,a=document.createElement("button");if(a.type="button",a.className="password-toggle icon-published0",a.setAttribute("aria-label",Now.translate("Show password")),a.setAttribute("tabindex","-1"),a.setAttribute("aria-description",Now.translate("Press Alt + S to toggle password visibility")),t.container)t.container.classList.add("has-password-toggle"),t.container.appendChild(a);else if(t.wrapper){const e=document.createElement("div");e.className="form-control has-password-toggle",t.parentNode.insertBefore(e,t),e.appendChild(t),e.appendChild(a),t.container=e}const togglePasswordVisibility=()=>{"password"===t.type?(t.type="text",a.setAttribute("aria-label",Now.translate("Hide password")),a.className="password-toggle icon-published1"):(t.type="password",a.setAttribute("aria-label",Now.translate("Show password")),a.className="password-toggle icon-published0"),t.focus()};EventSystemManager.addHandler(a,"click",togglePasswordVisibility),EventSystemManager.addHandler(t,"keydown",e=>{e.altKey&&"s"===e.key&&(e.preventDefault(),togglePasswordVisibility())}),EventSystemManager.addHandler(t,"focus",()=>{a.classList.remove("hidden")}),e.toggleButton=a}static setupCriteriaList(e){const{element:t,config:a}=e,n=document.createElement("ul");if(n.className=a.criteriaListClass,n.setAttribute("aria-live","polite"),Object.entries(a.passwordCriteria).forEach(([e,t])=>{if(!t.enabled||"match"===e)return;const a=document.createElement("li");a.dataset.criteria=e,a.className="icon-invalid",a.setAttribute("aria-label",Now.translate("Criteria not met")),a.textContent=Now.translate(t.label.replace("{value}",t.value)),n.appendChild(a)}),t.comment)t.comment.parentNode.insertBefore(n,t.comment.nextSibling);else if(t.wrapper)t.wrapper.appendChild(n);else if(t.container){t.container.parentNode.insertBefore(n,t.container.nextSibling)}e.criteriaListElement=n,e.updateCriteriaList=function(){if(!e.criteriaListElement)return;const a=t.value,n=this.getFailedCriteria(a),s=e.criteriaListElement.querySelectorAll("li");if(!a)return e.criteriaListElement.classList.remove("validating"),void s.forEach(e=>{e.className="icon-invalid",e.setAttribute("aria-label",Now.translate("Criteria not checked"))});s.forEach(e=>{const t=e.textContent,a=n.includes(t);e.className=a?"icon-invalid":"icon-valid",e.setAttribute("aria-label",Now.translate(a?"Criteria not met":"Criteria met"))})},e.updateCriteriaList()}static setupEventListeners(e){super.setupEventListeners(e);const{element:t,config:a}=e,ensureStrengthBar=()=>{var n;try{const r=t.form||(t.closest?t.closest("form"):null),i=r&&("register"===(null==(n=r.dataset)?void 0:n.form)||r.getAttribute&&"register"===r.getAttribute("data-form")),o="bar"===t.dataset.passwordStrength||"true"===t.dataset.passwordStrength||Boolean(t.dataset.passwordStrength);if(!i&&!o)return;if(t.dataset.targetPassword)return;if(e.strengthBarElement)return;let l=_PasswordElementFactory.locateStrengthContainer(t),c=l,d=l?l.querySelector(".password-strength-bar"):null;l||(c=document.createElement("div"),c.className="password-strength",d=document.createElement("div"),d.className="password-strength-bar",d.setAttribute("role","progressbar"),d.setAttribute("aria-valuemin","0"),d.setAttribute("aria-valuemax","100"),d.style.width="0%",c.appendChild(d));let u=!1;try{const e="result_"+(t.id||"");if(e){const a=t.form||(t.closest?t.closest("form"):null),n=a?a.querySelector("#"+e):document.getElementById(e);n&&n.parentNode&&(n.parentNode.insertBefore(c,n.nextSibling),u=!0)}}catch(s){}if(!u)try{if(t.parentNode&&t.parentNode.parentNode){const e=t.parentNode;e.parentNode.insertBefore(c,e.nextSibling),u=!0}}catch(s){}if(!u)try{t.insertAdjacentElement&&(t.insertAdjacentElement("afterend",c),u=!0)}catch(s){}if(!u)try{const e=t.form||(t.closest?t.closest("form"):null);e?e.appendChild(c):document.body.appendChild(c),u=!0}catch(s){}e.strengthBarElement=d;try{t.dataset.passwordStrength="true"}catch(s){}e.updateStrengthBar=function(){if(!e.strengthBarElement)return;const n=t.value.trim()||"";if(""===n)return e.strengthBarElement.style.width="0%",e.strengthBarElement.classList.remove("weak","medium","strong"),void e.strengthBarElement.setAttribute("aria-valuenow","0");const s=Object.entries(a.passwordCriteria).filter(([e,t])=>t.enabled&&"match"!==e).length||1,r=e.getFailedCriteria(n).length,i=Math.max(0,s-r),o=Math.round(i/s*100);e.strengthBarElement.style.width=o+"%",e.strengthBarElement.classList.remove("weak","medium","strong"),o<40?e.strengthBarElement.classList.add("weak"):o<80?e.strengthBarElement.classList.add("medium"):e.strengthBarElement.classList.add("strong"),e.strengthBarElement.setAttribute("aria-valuenow",String(o))}}catch(r){}};EventSystemManager.addHandler(t,"input",()=>{!t.dataset.targetPassword&&a.passwordCriteriaList&&e.updateCriteriaList(),ensureStrengthBar(),e.updateStrengthBar&&e.updateStrengthBar(),e.updateMatchStatus()});try{ensureStrengthBar()}catch(s){}if(e.updateStrengthBar)try{e.updateStrengthBar()}catch(s){}try{"undefined"!=typeof requestAnimationFrame?requestAnimationFrame(()=>{try{ensureStrengthBar(),e.updateStrengthBar&&e.updateStrengthBar()}catch(s){}}):setTimeout(()=>{try{ensureStrengthBar(),e.updateStrengthBar&&e.updateStrengthBar()}catch(s){}},0)}catch(s){}try{const a=t.form||(t.closest?t.closest("form"):null);a&&(e._formResetHandler=function(){try{e.strengthBarElement&&(e.strengthBarElement.style.width="0%",e.strengthBarElement.classList.remove("weak","medium","strong"),e.strengthBarElement.setAttribute("aria-valuenow","0")),e.criteriaListElement&&e.criteriaListElement.querySelectorAll("li").forEach(e=>{e.className="icon-invalid",e.setAttribute("aria-label",Now.translate("Criteria not checked"))});try{delete t.dataset.passwordStrength}catch(a){}}catch(a){}},EventSystemManager.addHandler(a,"reset",e._formResetHandler))}catch(r){}const n=e.destroy;e.destroy=function(){try{if(e.strengthBarElement&&e.strengthBarElement.parentNode){const t=e.strengthBarElement.closest(".password-strength");t&&t.parentNode&&t.parentNode.removeChild(t)}if(e.criteriaListElement&&e.criteriaListElement.parentNode&&e.criteriaListElement.parentNode.removeChild(e.criteriaListElement),e._formResetHandler){const a=t.form||(t.closest?t.closest("form"):null);try{EventSystemManager.removeHandler(a,"reset",e._formResetHandler)}catch(s){}e._formResetHandler=null}try{delete t.dataset.passwordStrength}catch(s){}}catch(s){}if("function"==typeof n)try{n.call(e)}catch(s){}}}};__publicField(_e,"config",{...TextElementFactory.config,type:"password",showPasswordToggle:!0,minLength:8,maxLength:50,passwordCriteriaList:!1,criteriaListClass:"password-criteria-list",passwordCriteria:{minLength:{enabled:!0,value:8,label:"At least {value} characters"},uppercase:{enabled:!0,label:"At least one uppercase letter"},lowercase:{enabled:!0,label:"At least one lowercase letter"},numbers:{enabled:!1,label:"At least one number"},special:{enabled:!1,label:"At least one special character"},match:{enabled:!1,label:"Passwords match"}}});let Fe=_e;ElementManager.registerElement("password",Fe);const Oe={config:{defaultView:"month",locale:"auto",timezone:"Asia/Bangkok",firstDayOfWeek:0,showWeekNumbers:!1,showToday:!0,allowViewChange:!0,eventHeight:20,timelineHeight:60,workingHours:{start:8,end:18},weekends:[0,6],minDate:null,maxDate:null,events:[],dateFormats:{day:"D MMMM YYYY",week:"D - ",month:"MMMM YYYY",cell:"YYYY-MM-DD"},callbacks:{onDateClick:null,onEventClick:null,onViewChange:null,onDateChange:null}},state:{calendars:new Map,currentDate:new Date,currentView:"month",initialized:!1},init(e={}){var t;return this.state.initialized||(this.config={...this.config,...e},this.state.currentDate=new Date,this.state.currentView=this.config.defaultView,document.querySelectorAll("[data-calendar]").forEach(e=>{this.create(e)}),(null==(t=window.EventManager)?void 0:t.on)&&EventManager.on("locale:changed",()=>{this.state.calendars.forEach(e=>{this.render(e)})}),this.state.initialized=!0),this},create(e,t={}){if("string"==typeof e&&(e=document.getElementById(e)),!e)return null;if(e.calendarInstance)return e.calendarInstance;const a=this.extractDataOptions(e),n={...this.config,...a,...t},s={element:e,config:n,currentDate:new Date,currentView:n.defaultView,events:[...n.events],isRendering:!1};return e.calendarInstance=s,this.state.calendars.set(e,s),this.setupCalendar(s),this.render(s),s},extractDataOptions(e){const t={},a=e.dataset;if(a.calendar&&(t.defaultView=a.calendar),a.calendarLocale&&(t.locale=a.calendarLocale),a.calendarFirstDay&&(t.firstDayOfWeek=parseInt(a.calendarFirstDay)),a.calendarEvents)try{t.events=JSON.parse(a.calendarEvents)}catch(n){console.warn("Invalid events JSON:",a.calendarEvents)}return t},setupCalendar(e){const{element:t,config:a}=e;t.className=`calendar-container ${t.className}`.trim(),t.innerHTML="";const n=document.createElement("div");n.className="calendar-header",t.appendChild(n),this.createNavigation(e,n),a.allowViewChange&&this.createViewSwitcher(e,n);const s=document.createElement("div");s.className="calendar-content",t.appendChild(s),e.headerElement=n,e.contentElement=s},createNavigation(e,t){const a=document.createElement("div");a.className="calendar-nav";const n=document.createElement("button");n.className="nav-btn prev",n.innerHTML="‹",n.title="Previous",n.addEventListener("click",()=>this.navigate(e,-1));const s=document.createElement("div");s.className="current-period",e.currentPeriodElement=s;const r=document.createElement("button");r.className="nav-btn next",r.innerHTML="›",r.title="Next",r.addEventListener("click",()=>this.navigate(e,1));const i=document.createElement("button");i.className="nav-btn today",i.textContent="Today",i.addEventListener("click",()=>this.goToToday(e)),a.appendChild(n),a.appendChild(s),a.appendChild(r),e.config.showToday&&a.appendChild(i),t.appendChild(a)},createViewSwitcher(e,t){const a=document.createElement("div");a.className="view-switcher";[{key:"day",label:"Day",icon:"📅"},{key:"week",label:"Week",icon:"📊"},{key:"month",label:"Month",icon:"🗓️"},{key:"timeline",label:"Timeline",icon:"📈"}].forEach(t=>{const n=document.createElement("button");n.className=`view-btn ${t.key}`,n.innerHTML=`${t.icon} ${t.label}`,n.addEventListener("click",()=>this.changeView(e,t.key)),a.appendChild(n)}),t.appendChild(a),e.viewSwitcherElement=a},render(e){if(!e.isRendering){e.isRendering=!0;try{switch(this.updateCurrentPeriod(e),this.updateViewSwitcher(e),e.currentView){case"day":this.renderDayView(e);break;case"week":this.renderWeekView(e);break;case"month":this.renderMonthView(e);break;case"timeline":this.renderTimelineView(e)}this.renderEvents(e)}finally{e.isRendering=!1}}},renderMonthView(e){const{contentElement:t,currentDate:a,config:n}=e;t.innerHTML="",t.className="calendar-content month-view";const s=document.createElement("table");s.className="month-table";const r=document.createElement("thead"),i=document.createElement("tr"),o=this.getDayNames(n);for(let h=0;h<7;h++){const e=(n.firstDayOfWeek+h)%7,t=document.createElement("th");t.textContent=o[e],t.className=n.weekends.includes(e)?"weekend":"",i.appendChild(t)}r.appendChild(i),s.appendChild(r);const l=document.createElement("tbody"),c=new Date(a.getFullYear(),a.getMonth(),1);new Date(a.getFullYear(),a.getMonth()+1,0);const d=new Date(c),u=(c.getDay()-n.firstDayOfWeek+7)%7;d.setDate(d.getDate()-u);for(let h=0;h<6;h++){const t=document.createElement("tr");for(let s=0;s<7;s++){const r=new Date(d);r.setDate(d.getDate()+7*h+s);const i=document.createElement("td");i.className=this.getCellClasses(r,a,n),i.setAttribute("data-date",this.formatDate(r,"YYYY-MM-DD"));const o=document.createElement("div");o.className="day-number",o.textContent=r.getDate();const l=document.createElement("div");l.className="day-events",i.appendChild(o),i.appendChild(l),i.addEventListener("click",t=>{this.handleDateClick(e,r,t)}),t.appendChild(i)}l.appendChild(t)}s.appendChild(l),t.appendChild(s)},renderWeekView(e){const{contentElement:t,currentDate:a,config:n}=e;t.innerHTML="",t.className="calendar-content week-view";const s=this.getWeekStart(a,n.firstDayOfWeek),r=document.createElement("div");r.className="week-header";for(let o=0;o<7;o++){const t=new Date(s);t.setDate(s.getDate()+o);const i=document.createElement("div");i.className=`day-column ${this.getCellClasses(t,a,n)}`,i.setAttribute("data-date",this.formatDate(t,"YYYY-MM-DD"));const l=document.createElement("div");l.className="day-name",l.textContent=this.getDayNames(n)[t.getDay()];const c=document.createElement("div");c.className="day-number",c.textContent=t.getDate(),i.appendChild(l),i.appendChild(c),i.addEventListener("click",a=>{this.handleDateClick(e,t,a)}),r.appendChild(i)}t.appendChild(r);const i=document.createElement("div");i.className="time-grid";for(let o=0;o<24;o++){const e=document.createElement("div");e.className="time-slot",e.setAttribute("data-hour",o);const t=document.createElement("div");t.className="time-label",t.textContent=`${o.toString().padStart(2,"0")}:00`;const a=document.createElement("div");a.className="day-slots";for(let n=0;n<7;n++){const e=document.createElement("div");e.className="day-slot",a.appendChild(e)}e.appendChild(t),e.appendChild(a),i.appendChild(e)}t.appendChild(i)},renderDayView(e){const{contentElement:t,currentDate:a,config:n}=e;t.innerHTML="",t.className="calendar-content day-view";const s=document.createElement("div");s.className="day-header";const r=document.createElement("h2");r.textContent=this.formatDate(a,"EEEE, MMMM d, yyyy",n.locale),s.appendChild(r),t.appendChild(s);const i=document.createElement("div");i.className="day-time-grid";for(let o=0;o<24;o++){const e=document.createElement("div");e.className="hour-slot",e.setAttribute("data-hour",o);const t=document.createElement("div");t.className="time-label",t.textContent=`${o.toString().padStart(2,"0")}:00`;const a=document.createElement("div");a.className="event-area",e.appendChild(t),e.appendChild(a),i.appendChild(e)}t.appendChild(i)},renderTimelineView(e){const{contentElement:t,currentDate:a,config:n}=e;t.innerHTML="",t.className="calendar-content timeline-view";const s=document.createElement("div");s.className="timeline-container";const r=new Date(a);r.setDate(a.getDate()-15);const i=new Date(a);i.setDate(a.getDate()+15);const o=document.createElement("div");o.className="timeline-bar";const l=Math.ceil((i-r)/864e5);for(let c=0;c<l;c++){const t=new Date(r);t.setDate(r.getDate()+c);const s=document.createElement("div");s.className=`timeline-day ${this.getCellClasses(t,a,n)}`,s.setAttribute("data-date",this.formatDate(t,"YYYY-MM-DD")),s.style.width=100/l+"%";const i=document.createElement("div");i.className="day-label",i.innerHTML=`\n        <div class="day-number">${t.getDate()}</div>\n        <div class="day-name">${this.getDayNames(n)[t.getDay()].substr(0,3)}</div>\n      `;const d=document.createElement("div");d.className="event-track",s.appendChild(i),s.appendChild(d),s.addEventListener("click",a=>{this.handleDateClick(e,t,a)}),o.appendChild(s)}s.appendChild(o),t.appendChild(s),setTimeout(()=>{const e=o.querySelector(".current-day");e&&e.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})},100)},renderEvents(e){const{events:t,currentView:a,contentElement:n}=e;t.forEach(t=>{this.renderEvent(e,t)})},renderEvent(e,t){const{currentView:a,contentElement:n}=e,s=new Date(t.date),r=this.formatDate(s,"YYYY-MM-DD");let i;switch(a){case"month":if(i=n.querySelector(`[data-date="${r}"] .day-events`),i){const e=this.createEventElement(t,"month");i.appendChild(e)}break;case"week":case"day":const e=s.getHours();if(i=n.querySelector(`[data-hour="${e}"] .event-area`),i){const e=this.createEventElement(t,a);i.appendChild(e)}break;case"timeline":if(i=n.querySelector(`[data-date="${r}"] .event-track`),i){const e=this.createEventElement(t,"timeline");i.appendChild(e)}}},createEventElement(e,t){const a=document.createElement("div");a.className=`calendar-event ${e.type||""} ${t}-event`,e.color&&(a.style.backgroundColor=e.color,a.style.borderColor=e.color);const n=document.createElement("div");if(n.className="event-title",n.textContent=e.title,"timeline"!==t){const t=document.createElement("div");t.className="event-time",e.time&&(t.textContent=e.time),a.appendChild(t)}return a.appendChild(n),a.addEventListener("click",t=>{t.stopPropagation(),this.handleEventClick(e,t)}),a},navigate(e,t){const{currentView:a,currentDate:n}=e;switch(a){case"day":n.setDate(n.getDate()+t);break;case"week":n.setDate(n.getDate()+7*t);break;case"month":n.setMonth(n.getMonth()+t);break;case"timeline":n.setDate(n.getDate()+15*t)}this.render(e),this.emitEvent("calendar:dateChange",{instance:e,date:new Date(n)})},goToToday(e){e.currentDate=new Date,this.render(e),this.emitEvent("calendar:dateChange",{instance:e,date:new Date(e.currentDate)})},changeView(e,t){e.currentView=t,this.render(e),this.emitEvent("calendar:viewChange",{instance:e,view:t})},getCellClasses(e,t,a){const n=[],s=new Date;return this.isSameDay(e,s)&&n.push("today"),this.isSameDay(e,t)&&n.push("current-day"),e.getMonth()!==t.getMonth()&&n.push("other-month"),a.weekends.includes(e.getDay())&&n.push("weekend"),n.join(" ")},getDayNames(e){var t,a;const n=this.getLocale(e);if(null==(a=null==(t=window.Utils)?void 0:t.date)?void 0:a.getDayNames)return Utils.date.getDayNames(n);const s=[],r=new Date(2024,0,7);for(let i=0;i<7;i++)s.push(r.toLocaleDateString(n,{weekday:"short"})),r.setDate(r.getDate()+1);return s},getWeekStart(e,t){const a=new Date(e),n=(a.getDay()-t+7)%7;return a.setDate(a.getDate()-n),a},isSameDay:(e,t)=>e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate(),getLocale(e){var t,a;if(e.locale&&"auto"!==e.locale)return e.locale;const n=(null==(a=null==(t=window.Now)?void 0:t.getManager)?void 0:a.call(t,"i18n"))||window.I18nManager;if(null==n?void 0:n.getCurrentLocale)return n.getCurrentLocale();return(navigator.language||navigator.userLanguage||"en").split("-")[0]},formatDate(e,t="YYYY-MM-DD",a=null){var n,s;if(null==(s=null==(n=window.Utils)?void 0:n.date)?void 0:s.format)return Utils.date.format(e,t,a);if("YYYY-MM-DD"===t){return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`}return e.toLocaleDateString(a||"en",{year:"numeric",month:"long",day:"numeric"})},updateCurrentPeriod(e){const{currentDate:t,currentView:a,config:n}=e,s=this.getLocale(n),r=n.dateFormats||this.config.dateFormats;let i="";switch(a){case"day":i=this.formatDate(t,r.day||"D MMMM YYYY",s);break;case"week":const e=this.getWeekStart(t,n.firstDayOfWeek),a=new Date(e);a.setDate(e.getDate()+6),i=`${e.getDate()} - ${a.getDate()} ${this.formatDate(a,"MMMM YYYY",s)}`;break;case"month":i=this.formatDate(t,r.month||"MMMM YYYY",s);break;case"timeline":i=`Timeline - ${this.formatDate(t,r.month||"MMMM YYYY",s)}`}e.currentPeriodElement&&(e.currentPeriodElement.textContent=i)},updateViewSwitcher(e){if(!e.viewSwitcherElement)return;e.viewSwitcherElement.querySelectorAll(".view-btn").forEach(t=>{t.classList.toggle("active",t.classList.contains(e.currentView))})},handleDateClick(e,t,a){e.config.callbacks.onDateClick&&e.config.callbacks.onDateClick.call(e.element,t,a),this.emitEvent("calendar:dateClick",{instance:e,date:t,event:a})},handleEventClick(e,t){this.config.callbacks.onEventClick&&this.config.callbacks.onEventClick.call(null,e,t),this.emitEvent("calendar:eventClick",{event:e,domEvent:t})},addEvent(e,t){const a="string"==typeof e?this.getInstance(e):e;a&&(a.events.push(t),this.render(a))},removeEvent(e,t){const a="string"==typeof e?this.getInstance(e):e;a&&(a.events=a.events.filter(e=>e.id!==t),this.render(a))},getInstance(e){return"string"==typeof e&&(e=document.getElementById(e)),e?this.state.calendars.get(e):null},emitEvent(e,t){EventManager.emit(e,t)},destroy(e){if("string"==typeof e&&(e=this.getInstance(e)),!e)return;const{element:t}=e;t.innerHTML="",t.className=t.className.replace("calendar-container","").trim(),delete t.calendarInstance,this.state.calendars.delete(t)}};(null==(N=window.Now)?void 0:N.registerManager)&&Now.registerManager("calendar",Oe),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{Oe.init()}):Oe.init(),window.Calendar||(window.Calendar=Oe);const Re={config:{defaultAnimation:"fade",defaultDuration:300,defaultFilterAttr:"data-category",debounceDelay:150,debug:!0},state:{activeFilters:new Map,activeSorts:new Map,debounceTimers:new Map,initialized:!1},init(){this.state.initialized||(this.bindFilterControls(),this.bindSortControls(),window.EventManager&&EventManager.on("template:render",e=>{setTimeout(()=>{this.refreshFilters()},100)}),this.state.initialized=!0)},refreshFilters(){this.state.activeFilters.forEach((e,t)=>{const a=document.querySelector(t);if(a){const n=document.querySelector(`[data-filter-scope="${t}"]`);if(n){const t=this.getFilterOptions(n);this.performFilter(a,e.value,t)}}})},bindFilterControls(){document.addEventListener("click",e=>{const t=e.target.closest("[data-filter-value]");t&&(e.preventDefault(),this.handleFilterClick(t))})},bindSortControls(){document.addEventListener("click",e=>{const t=e.target.closest("[data-sort-by]");t&&(e.preventDefault(),this.handleSortClick(t))})},handleFilterClick(e){const t=e.dataset.filterValue;if(!t)return;const a=e.closest("[data-filter-scope]");if(!a)return;const n=this.getFilterOptions(a),s=a.dataset.filterScope;document.querySelector(s)&&(this.updateActiveButton(a,e),this.filter(t,s,n))},handleSortClick(e){const t=e.dataset.sortBy,a=e.dataset.sortOrder||"asc",n=e.dataset.sortType||"string";if(!t)return;const s=e.closest("[data-sort-scope]");if(!s)return;const r=s.dataset.sortScope,i=this.state.activeSorts.get(r),o=(null==i?void 0:i.by)===t&&"asc"===(null==i?void 0:i.order)?"desc":a;this.updateActiveButton(s,e),this.sort({scope:r,by:t,order:o,type:n})},getFilterOptions(e){return{attr:e.dataset.filterAttr||this.config.defaultFilterAttr,animation:e.dataset.filterAnimation||this.config.defaultAnimation,duration:parseInt(e.dataset.filterDuration)||this.config.defaultDuration}},updateActiveButton(e,t){e.querySelectorAll("[data-filter-value], [data-sort-by]").forEach(e=>e.classList.remove("active")),t.classList.add("active")},filter(e,t,a){const n=document.querySelector(t);n&&(this.state.activeFilters.set(t,{value:e,attr:a.attr}),this.debounce(`filter-${t}`,()=>{this.performFilter(n,e,a)},this.config.debounceDelay))},async performFilter(e,t,a){const n=Array.from(e.querySelectorAll(`[${a.attr}]`)).filter(e=>!e.matches("template, script, style"));if(0===n.length)return;const s="*"===t||"all"===t;for(const r of n){const e=r.getAttribute(a.attr),n=s||e===t,i="none"===r.style.display||r.classList.contains("hidden");n&&i?await this.animateItem(r,"show",a.animation,a.duration):n||i||this.animateItem(r,"hide",a.animation,a.duration)}},sort(e){const t=document.querySelector(e.scope);t&&(this.state.activeSorts.set(e.scope,{by:e.by,order:e.order,type:e.type}),this.debounce(`sort-${e.scope}`,()=>{this.performSort(t,e)},this.config.debounceDelay))},performSort(e,t){const a=Array.from(e.querySelectorAll(`[data-${t.by}]`)).filter(e=>!e.matches("template, script, style"));if(0===a.length)return;a.sort((e,a)=>{const n=this.getSortValue(e,t.by,t.type),s=this.getSortValue(a,t.by,t.type);return this.compare(n,s,t.type,t.order)});const n=a[0].parentElement;a.forEach(e=>n.appendChild(e))},getSortValue(e,t,a){let n=e.dataset[t];if(n||(n=e.getAttribute(`data-${t}`)),!n){const a=e.querySelector(`[data-${t}]`);a&&(n=a.textContent.trim())}switch(a){case"number":return parseFloat(n)||0;case"date":return new Date(n).getTime()||0;default:return String(n||"").toLowerCase()}},compare(e,t,a,n){let s=0;switch(a){case"number":case"date":s=e-t;break;default:s=e.localeCompare(t)}return"desc"===n?-s:s},async animateItem(e,t,a,n){const s="show"===t;if("none"!==a&&0!==n)switch(a){case"fade":s?(e.style.display="",e.style.opacity="0",e.style.transition=`opacity ${n}ms`,await this.nextFrame(),e.style.opacity="1",await this.wait(n),e.style.transition="",e.style.opacity=""):(e.style.transition=`opacity ${n}ms`,e.style.opacity="0",await this.wait(n),e.style.display="none",e.style.transition="");break;case"slide":s?(e.style.display="",e.style.maxHeight="0",e.style.overflow="hidden",e.style.transition=`max-height ${n}ms`,await this.nextFrame(),e.style.maxHeight=e.scrollHeight+"px",await this.wait(n),e.style.maxHeight="",e.style.overflow="",e.style.transition=""):(e.style.maxHeight=e.scrollHeight+"px",e.style.overflow="hidden",e.style.transition=`max-height ${n}ms`,await this.nextFrame(),e.style.maxHeight="0",await this.wait(n),e.style.display="none",e.style.maxHeight="",e.style.overflow="",e.style.transition="");break;case"scale":s?(e.style.display="",e.style.transform="scale(0)",e.style.opacity="0",e.style.transition=`transform ${n}ms, opacity ${n}ms`,await this.nextFrame(),e.style.transform="scale(1)",e.style.opacity="1",await this.wait(n),e.style.transform="",e.style.opacity="",e.style.transition=""):(e.style.transition=`transform ${n}ms, opacity ${n}ms`,e.style.transform="scale(0)",e.style.opacity="0",await this.wait(n),e.style.display="none",e.style.transform="",e.style.opacity="",e.style.transition="");break;default:e.style.display=s?"":"none"}else e.style.display=s?"":"none"},debounce(e,t,a){this.state.debounceTimers.has(e)&&clearTimeout(this.state.debounceTimers.get(e));const n=setTimeout(()=>{t(),this.state.debounceTimers.delete(e)},a);this.state.debounceTimers.set(e,n)},nextFrame:()=>new Promise(e=>requestAnimationFrame(e)),wait:e=>new Promise(t=>setTimeout(t,e)),getFilteredItems(e){const t=document.querySelector(e);if(!t)return[];const a=this.state.activeFilters.get(e),n=(null==a?void 0:a.attr)||this.config.defaultFilterAttr;return Array.from(t.querySelectorAll(`[${n}]`)).filter(e=>!e.matches("template, script, style")&&"none"!==e.style.display)},clearFilters(e){const t=document.querySelector(e);if(!t)return;const a=this.state.activeFilters.get(e),n=(null==a?void 0:a.attr)||this.config.defaultFilterAttr;Array.from(t.querySelectorAll(`[${n}]`)).forEach(e=>{e.style.display=""}),this.state.activeFilters.delete(e)},clearSorts(e){this.state.activeSorts.delete(e)},getActiveFilter(e){return this.state.activeFilters.get(e)},getActiveSort(e){return this.state.activeSorts.get(e)},destroy(){this.state.debounceTimers.forEach(e=>clearTimeout(e)),this.state.debounceTimers.clear(),this.state.activeFilters.clear(),this.state.activeSorts.clear(),this.state.initialized=!1}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>Re.init()):Re.init(),window.FilterManager=Re;const Pe={config:{breakpoint:768,animationDuration:100,touchThreshold:100,accessibility:{enabled:!0,announceChanges:!0,smoothFocus:!0,focusableSelectors:'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])',focusFirstItemOnOpen:!0,returnFocusOnClose:!0,horizontalNavigation:{arrowKeysOpenSubmenu:!0,arrowKeysNavigateSiblings:!0}},performance:{useRequestAnimationFrame:!0,touchOptimization:!0},observerOptions:{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","style"]},hover:{openDelay:100,closeDelay:300}},state:{initialized:!1,menus:new Map,handlers:new Map,observer:null,announcer:null},async init(e={}){try{return this.state.initialized||(this.config=Now.mergeConfig(this.config,e),this.state={initialized:!1,menus:new Map,handlers:new Map,observer:null,announcer:null},this.initializeExistingMenus(),this.setupMutationObserver(),this.setupToggleListeners(),this.setupApiDataListener(),this.setupI18nListeners(),EventManager.on("route:changed",()=>{try{this.updateActiveMenu(),this.setupAutoExpand(),this.state.menus.forEach(e=>{this.closeAllSubmenus(e),e.isMobile&&this.isMenuOpen(e)&&this.closeMenu(e)})}catch(e){ErrorManager.handle("Route change handler failed",{context:"MenuManager.routeHandler",data:{error:e}})}}),this.state.initialized=!0),this}catch(t){throw ErrorManager.handle("MenuManager initialization failed",{context:"MenuManager.init",data:{error:t}})}},setupI18nListeners(){EventManager.on("locale:changed",()=>{this.updateAllMenuTranslations()})},updateAllMenuTranslations(){this.state.menus.forEach(e=>{if(e.elements.toggleButtons){const t=this.isMenuOpen(e);e.elements.toggleButtons.forEach(e=>{const a=t?"Close menu":"Open menu";e.setAttribute("aria-label",I18nManager.translate(a))})}e.elements.submenus&&e.elements.submenus.forEach(e=>{e.content&&e.content.setAttribute("aria-label",I18nManager.translate("Submenu"))}),e.elements.container&&e.elements.container.setAttribute("aria-label",I18nManager.translate("Main navigation")),e.element&&I18nManager.updateElements(e.element)})},setupApiDataListener(){document.addEventListener("api:loaded",e=>{var t,a;const n=e.target===document?null==(t=e.detail)?void 0:t.element:e.target,s=null==(a=e.detail)?void 0:a.data;if(!n||!s)return;const r={data:s};requestAnimationFrame(()=>{n.querySelectorAll('[data-component="menu"][data-source]').forEach(e=>{const t=e.dataset.source;if(!t)return;const a=this.getValueByPath(r,t);a&&Array.isArray(a)&&(e.dataset.menuId&&(this.destroyMenu(e.dataset.menuId),delete e.dataset.menuId),this.renderFromData(e,a))})})})},getValueByPath(e,t){if(t&&e)return t.split(".").reduce((e,t)=>null==e?void 0:e[t],e)},isMenuOpen:e=>e.element.classList.contains("sidemenu")?document.body.classList.contains("sidemenu-close"):document.body.classList.contains("topmenu-open"),isSubmenuOpen:e=>"true"===e.getAttribute("aria-expanded"),initializeExistingMenus(){document.querySelectorAll('[data-component="menu"]').forEach(e=>{this.createMenu(e)}),this.updateActiveMenu(),this.setupAutoExpand()},setupMutationObserver(){this.observer=new MutationObserver(e=>{let t=!1;e.forEach(e=>{e.removedNodes.forEach(e=>{var t;if(1===e.nodeType){const a=null==(t=e.dataset)?void 0:t.menuId;if(a&&this.state.menus.has(a)&&setTimeout(()=>{e.isConnected||this.destroyMenu(a)},0),e.querySelectorAll&&this.state.menus.size>0){e.querySelectorAll("[data-menu-id]").forEach(e=>{var t;const a=null==(t=e.dataset)?void 0:t.menuId;a&&this.state.menus.has(a)&&setTimeout(()=>{e.isConnected||this.destroyMenu(a)},0)})}}}),e.addedNodes.forEach(e=>{var a,n;1===e.nodeType&&(t||((null==(a=e.matches)?void 0:a.call(e,'[data-component="menu"]'))||(null==(n=e.querySelector)?void 0:n.call(e,'[data-component="menu"]')))&&(t=!0))})}),t&&this.initializeExistingMenus()}),this.observer.observe(document.body,this.config.observerOptions)},setupToggleListeners(){document.addEventListener("click",e=>{const t=e.target.closest(".menu-toggle");if(!t)return;e.stopPropagation();let a=null;t.classList.contains("topmenu-toggle")?a="topmenu":t.classList.contains("sidemenu-toggle")&&(a="sidemenu"),a&&this.state.menus.forEach(e=>{if("topmenu"===a&&e.element.classList.contains("topmenu")||"sidemenu"===a&&e.element.classList.contains("sidemenu")){if(!document.body.classList.contains("mobile-menu")&&e.element.classList.contains("sidemenu")&&document.body.classList.contains("sidemenu-sub-expanded"))return;this.toggleMenu(e)}})})},updateActiveMenu(e){var t,a,n,s;const r=null==(a=null==(t=window.RouterManager)?void 0:t.state)?void 0:a.current;let i=e||(null==r?void 0:r.menuPath)||window.location.pathname;const o=window.location.hash,l=(null==(s=null==(n=window.RouterManager)?void 0:n.config)?void 0:s.base)||"";l&&"/"!==l&&i.startsWith(l)&&(i=i.slice(l.length)||"/");const c=document.querySelectorAll(".sidemenu .active, .topmenu .active");let d=!1;const u={cleanUrl:e=>{let t=e.split("?")[0].split("#")[0];return t=t.replace(/\/+$/,""),t},comparePaths:(e,t)=>u.cleanUrl(e)===u.cleanUrl(t),setActiveState:(e,t=!0)=>{var a;const n=e.classList.contains("active");if(t){n||(d=!0),e.classList.add("active"),e.setAttribute("aria-current","page");let t=e.parentElement;for(;t&&t!==document.body;){if("UL"===t.tagName){t.setAttribute("aria-hidden","false");const e=t.closest(".sidemenu");e&&t!==e.querySelector(":scope > ul")&&document.body.classList.add("sidemenu-sub-expanded");const n=t.closest(".topmenu");n&&t!==n.querySelector(":scope > ul")&&document.body.classList.add("topmenu-sub-expanded");const s=t.toggle||(null==(a=t.parentElement)?void 0:a.querySelector(':scope > button[aria-haspopup="true"]'));s&&s.setAttribute("aria-expanded","true")}t=t.parentElement}}else n&&(d=!0),e.classList.remove("active"),e.removeAttribute("aria-current");return t}};c.forEach(e=>{u.setActiveState(e,!1)});const h=[];if(document.querySelectorAll(".sidemenu a[href], .topmenu a[href]").forEach(e=>{const t=e.getAttribute("href");if(t){if(o&&t.includes("#")){if(t.split("#")[1]===o.substring(1))return void(u.setActiveState(e)&&h.push(e))}u.comparePaths(t,i)&&u.setActiveState(e)&&h.push(e)}}),0===h.length){let e=null,t=0;document.querySelectorAll(".sidemenu a[href], .topmenu a[href]").forEach(a=>{const n=a.getAttribute("href");if(!n)return;const s=u.cleanUrl(n);u.cleanUrl(i).startsWith(s)&&s.length>t&&(e=a,t=s.length)}),e&&(u.setActiveState(e),h.push(e))}return d&&Now.emit("menu:activeChanged",{path:i,hash:o,activeLinks:h,previousActive:Array.from(c)}),h},setupAutoExpand(){window.innerWidth>=this.config.breakpoint&&document.querySelectorAll('.sidemenu [aria-haspopup="true"], .topmenu [aria-haspopup="true"]').forEach(e=>{const t=e.closest("li");if(!t)return;const a=t.querySelector(":scope > ul");a&&(e.addEventListener("mouseenter",()=>{e.hasAttribute("aria-expanded")&&"false"!==e.getAttribute("aria-expanded")||(e.setAttribute("aria-expanded","true"),this.checkAndAdjustPosition(a))}),e.addEventListener("mouseleave",()=>{setTimeout(()=>{t.querySelector(".active")||e.setAttribute("aria-expanded","false")},this.config.animationDuration)}))})},async createMenu(e){try{if(e.dataset.menuId)return null;if(e.dataset.source&&!e.querySelector("ul"))return null;if(!e.querySelector("ul"))return null;const t=Utils.generateUUID();e.dataset.menuId=t;const a=this.initializeMenuInstance(e,t);return this.setupMenuElements(a),a.elements.container&&(this.setupAriaForNestedMenu(a,a.elements.container),this.setupMenuHandlers(a),this.setupAccessibility(a),this.checkResponsiveState(a,!0)),this.state.menus.set(t,a),a}catch(t){return this.handleError("Menu creation failed",t,"error:menu"),null}},handleClick(e){const t=e.target.closest(".menu-item");t&&("A"===t.tagName&&t.hasAttribute("href")||(e.preventDefault(),e.stopPropagation(),this.toggleMenu(menu)))},initializeMenuInstance:(e,t)=>({id:t,element:e,isMobile:!1,position:e.classList.contains("menu-left")?"left":"right",isSidebar:e.classList.contains("sidemenu"),touchData:null,elements:{},handlers:{}}),setupMenuElements(e){const t=e.element.querySelector("ul"),a=e.element.parentNode;if(!t)return e.elements.container=null,void(e.elements.submenus=[]);e.elements.container=t,e.elements.submenus=[],t.setAttribute("role","menubar");let n=null;if(e.element.classList.contains("topmenu")?n=e.element.classList.contains("responsive-menu")?"topmenu":null:e.element.classList.contains("sidemenu")&&(n="sidemenu"),n){t.setAttribute("aria-label",I18nManager.translate("Main navigation"));if(document.querySelector(`.${n}`)){let a=document.querySelectorAll(`.${n}-toggle`);if(0===a.length&&"topmenu"===n){const s=document.createElement("button");s.type="button",s.className=`menu-toggle ${n}-toggle runtime`,s.innerHTML='\n          <span class="toggle-icon">\n            <span class="toggle-bar"></span>\n            <span class="toggle-bar"></span>\n            <span class="toggle-bar"></span>\n          </span>',t.parentElement.parentElement.insertBefore(s,e.element),a=[s]}if(a.length>0){e.elements.toggleButtons=Array.from(a);const t=this.isMenuOpen(e);a.forEach(a=>{a.setAttribute("aria-haspopup","true"),a.setAttribute("aria-controls",e.element.id||`menu-${e.id}`),a.setAttribute("role","menuitem"),a.setAttribute("aria-expanded",t?"true":"false"),a.setAttribute("aria-label",I18nManager.translate(t?"Close menu":"Open menu"))}),e.elements.toggle=a[0]}}const s=document.createElement("div");s.className="menu-backdrop",a.insertBefore(s,e.element),e.elements.backdrop=s}e.element.id||(e.element.id=`menu-${e.id}`)},setupAriaForNestedMenu(e,t){t.querySelectorAll(":scope > li").forEach(t=>{t.setAttribute("role","none");const a=t.querySelector(":scope > ul");if(a){const n=a.id||`submenu-${Utils.generateUUID()}`;a.id=n,a.setAttribute("role","menu"),a.setAttribute("aria-label",I18nManager.translate("Submenu")),a.setAttribute("aria-orientation","vertical"),a.setAttribute("aria-hidden","true");const s=t.querySelector("button");s&&(s.setAttribute("role","menuitem"),s.setAttribute("aria-haspopup","true"),s.setAttribute("aria-expanded","false"),s.setAttribute("aria-controls",n),s.content=a,e.elements.submenus.push(s),a.toggle=s),this.setupAriaForNestedMenu(e,a)}else{const e=t.querySelector("a");e&&e.setAttribute("role","menuitem")}})},checkAndAdjustPosition(e){const t=e.getBoundingClientRect(),a=window.innerWidth,n=window.innerHeight;if(t.right>a?(e.style.left="auto",e.style.right="100%"):(e.style.left="",e.style.right=""),t.bottom>n){const a=t.bottom-n;e.style.top=-a+"px"}else e.style.top=""},setupMenuHandlers(e){try{e.handlers.toggle=t=>{t.stopPropagation(),e.element.classList.contains("sidemenu")&&document.body.classList.contains("sidemenu-sub-expanded")||this.toggleMenu(e)},e.elements&&(e.elements.backdrop&&e.elements.backdrop.addEventListener("click",e.handlers.toggle),e.elements.submenus.forEach(t=>{t.addEventListener("click",a=>{const n=a.target.closest("button");n&&"true"===n.getAttribute("aria-haspopup")&&(a.preventDefault(),a.stopPropagation(),"vertical"===e.elements.container.getAttribute("aria-orientation")&&this.toggleSubmenu(e,t,!1))})}));const t={start:t=>{e.touchData={startX:t.touches[0].clientX,startY:t.touches[0].clientY,startTime:Date.now(),isScrolling:null}},move:t=>{if(!e.touchData||!this.isMenuOpen(e))return;const a=e.touchData,n=t.touches[0],s=n.clientX-a.startX,r=n.clientY-a.startY;null===a.isScrolling&&(a.isScrolling=Math.abs(r)>Math.abs(s)),a.isScrolling||("right"===e.position&&s>0||"left"===e.position&&s<0)&&requestAnimationFrame(()=>{e.elements.container.style.transform=`translateX(${s}px)`})},end:t=>{if(!e.touchData)return;const a=e.touchData,n=t.changedTouches[0].clientX-a.startX,s=Date.now()-a.startTime,r=Math.abs(n)/s;e.element.style.transform="",!a.isScrolling&&(Math.abs(n)>this.config.touchThreshold||r>.3)&&this.closeMenu(e),e.touchData=null},cancel:()=>{e.touchData&&(e.elements.element.style.transform="",e.touchData=null)}};e.element.addEventListener("touchstart",t.start,{passive:!0}),e.element.addEventListener("touchmove",t.move,{passive:!0}),e.element.addEventListener("touchend",t.end,{passive:!0}),e.element.addEventListener("touchcancel",t.cancel,{passive:!0}),e.handlers.touch=t,e.handlers.keydown=t=>this.handleKeyboardNavigation(e,t),document.addEventListener("keydown",e.handlers.keydown),!e.isMobile&&e.element.classList.contains("topmenu")&&this.setupHoverHandlers(e),e.handlers.resize=()=>this.checkResponsiveState(e),window.addEventListener("resize",e.handlers.resize),e.element.classList.contains("topmenu")&&(e.handlers.focusout=t=>{requestAnimationFrame(()=>{var a;const n=document.activeElement,s=null==n?void 0:n.closest(".topmenu > ul > li"),r=null==(a=t.target)?void 0:a.closest(".topmenu > ul > li");s&&s===r||this.closeAllSubmenus(e)})},e.element.addEventListener("focusout",e.handlers.focusout))}catch(t){ErrorManager.handle("Failed to setup menu handlers",{context:"MenuManager.setupMenuHandlers",data:{menuId:e.id,error:t}})}},toggleMenu(e){this.isMenuOpen(e)?this.closeMenu(e):this.openMenu(e)},async openMenu(e){var t,a;if(this.isMenuOpen(e))return;if(e.element.querySelectorAll(this.config.accessibility.focusableSelectors).forEach(e=>{e.removeAttribute("tabindex")}),e.element.classList.contains("sidemenu")?document.body.classList.add("sidemenu-close"):document.body.classList.add("topmenu-open"),(null==(t=e.elements)?void 0:t.toggle)&&(e.elements.toggle.setAttribute("aria-expanded","true"),e.elements.toggle.setAttribute("aria-label",I18nManager.translate("Close menu"))),this.config.accessibility.announceChanges){const t=(null==(a=e.element.querySelector(":scope > ul"))?void 0:a.querySelectorAll(':scope > li > [role="menuitem"]').length)||0;this.announce("{Open menu}, There are {count} items in total",{count:t})}e.touchData&&(e.touchData=null,e.element.style.transform=""),EventManager.emit("menu:opened",{menu:e})},async closeMenu(e){var t,a,n,s;if(!this.isMenuOpen(e))return;const r=document.body.classList.contains("mobile-menu");if(e.elements&&!r)for(const i of e.elements.submenus)await this.closeSubmenu(e,i);if(e.element&&!r){e.element.querySelectorAll(this.config.accessibility.focusableSelectors).forEach(e=>{e.setAttribute("tabindex","-1")})}(null==(t=e.elements)?void 0:t.toggle)&&e.elements.toggle.focus(),await new Promise(e=>requestAnimationFrame(e)),(null==(a=e.element)?void 0:a.classList.contains("sidemenu"))?document.body.classList.remove("sidemenu-close"):(null==(n=e.element)?void 0:n.classList.contains("topmenu"))&&document.body.classList.remove("topmenu-open"),(null==(s=e.elements)?void 0:s.toggle)&&(e.elements.toggle.setAttribute("aria-expanded","false"),e.elements.toggle.setAttribute("aria-label",I18nManager.translate("Open menu"))),e.touchData&&(e.element.style.transform="",e.touchData=null),this.config.accessibility.announceChanges&&this.announce("Close menu"),Now.emit("menu:closed",{menu:e})},toggleSubmenu(e,t){this.isSubmenuOpen(t)?this.closeSubmenu(e,t):this.openSubmenu(e,t)},async openSubmenu(e,t,a={}){if(!t.content)return;const n=t.parentElement.parentElement;if(e.elements.submenus.forEach(a=>{a!==t&&a.parentElement.parentElement===n&&this.closeSubmenu(e,a)}),t.setAttribute("aria-expanded","true"),t.content.setAttribute("aria-hidden","false"),e.element.classList.contains("sidemenu")){!document.body.classList.contains("mobile-menu")&&document.body.classList.contains("sidemenu-close")&&(document.body.classList.remove("sidemenu-close"),t.dataset.tempExpanded="true"),document.body.classList.add("sidemenu-sub-expanded")}else e.element.classList.contains("topmenu")&&document.body.classList.add("topmenu-sub-expanded");if(t.content.querySelectorAll(this.config.accessibility.focusableSelectors).forEach(e=>{e.removeAttribute("tabindex")}),e.isMobile||requestAnimationFrame(()=>{this.checkAndAdjustPosition(t.content)}),a.useKeyboard){const e=t.content.querySelector('[role="menuitem"]');e&&(await new Promise(e=>setTimeout(e,50)),e.focus())}if(this.config.accessibility.announceChanges){const e=t.content.querySelectorAll(':scope > li > [role="menuitem"]').length;this.announce("{Open submenu}, There are {count} items in total",{count:e})}Now.emit("submenu:opened",{menu:e,button:t,submenu:t.content,previousFocus:document.activeElement})},async closeSubmenu(e,t){if(!t.content)return;const a=document.activeElement,n=t.content.querySelectorAll('[aria-expanded="true"]');for(const s of n)await this.closeSubmenu(e,s);if(t.content.querySelectorAll(this.config.accessibility.focusableSelectors).forEach(e=>{e.setAttribute("tabindex","-1")}),a&&t.content.contains(a)&&(t.focus(),await new Promise(e=>requestAnimationFrame(e))),t.setAttribute("aria-expanded","false"),t.content.setAttribute("aria-hidden","true"),"true"===t.dataset.tempExpanded){e.elements.submenus.some(e=>this.isSubmenuOpen(e))||document.body.classList.add("sidemenu-close"),delete t.dataset.tempExpanded}e.elements.submenus.some(e=>this.isSubmenuOpen(e))||(e.element.classList.contains("sidemenu")?document.body.classList.remove("sidemenu-sub-expanded"):e.element.classList.contains("topmenu")&&document.body.classList.remove("topmenu-sub-expanded")),e.isMobile||(t.content.style.left="",t.content.style.right="",t.content.style.top=""),this.config.accessibility.announceChanges&&this.announce("Close submenu"),Now.emit("submenu:closed",{menu:e,button:t,submenu:t.content,currentFocus:a})},closeAllSubmenus(e){var t;null==(t=e.elements)||t.submenus.forEach(t=>{"true"===t.getAttribute("aria-expanded")&&this.closeSubmenu(e,t)})},hasMenu(e){return this.state.menus.has(e)},getMenu(e){return this.state.menus.get(e)||null},setupTouchHandlers(e){let t;const a={start:a=>{void 0===t&&(t=a.changedTouches[0].identifier,e.touchData={startX:a.touches[0].clientX,startY:a.touches[0].clientY,startTime:Date.now(),isScrolling:null})},move:a=>{if(!e.touchData)return;const n=Array.from(a.changedTouches).find(e=>e.identifier===t);if(!n)return;const s=n.clientX-e.touchData.startX,r=n.clientY-e.touchData.startY;null===e.touchData.isScrolling&&(e.touchData.isScrolling=Math.abs(r)>Math.abs(s)),e.touchData.isScrolling||(this.config.performance.useRequestAnimationFrame?requestAnimationFrame(()=>{this.handleTouchMove(e,s)}):this.handleTouchMove(e,s))},end:a=>{const n=Array.from(a.changedTouches).find(e=>e.identifier===t);if(!n||!e.touchData)return;const s=n.clientX-e.touchData.startX,r=Date.now()-e.touchData.startTime,i=Math.abs(s)/r;this.handleTouchEnd(e,s,i),t=void 0,e.touchData=null},cancel:()=>{e.touchData&&(e.element.style.transform="",t=void 0,e.touchData=null)}};Object.entries(a).forEach(([t,a])=>{e.element.addEventListener(`touch${t}`,a,{passive:!0}),e.handlers[`touch${t}`]=a})},setupAccessibility(e){const t=document.createElement("div");t.setAttribute("aria-live","polite"),t.setAttribute("aria-atomic","true"),t.className="sr-only",e.element.appendChild(t),e.liveRegion=t,e.element.setAttribute("role","navigation"),e.element.setAttribute("aria-label",I18nManager.translate("Main navigation"));const a=document.createElement("div");a.className="sr-only",a.textContent=I18nManager.translate("Keyboard navigation instructions"),e.element.insertBefore(a,e.element.firstChild)},setupHoverHandlers(e){e.hoverTimeouts=new Map,e.elements.submenus.forEach(t=>{const mouseEnterHandler=()=>{var a;const n=t.closest("li");!e.isMobile&&e.element.classList.contains("topmenu")&&!this.isSubmenuOpen(t)&&n&&((null==(a=e.hoverTimeouts)?void 0:a.has(t))&&clearTimeout(e.hoverTimeouts.get(t)),e.hoverTimeouts.set(t,setTimeout(()=>{this.closeOtherSubmenus(e,t),this.openSubmenu(e,t)},this.config.hover.openDelay)))},mouseLeaveHandler=a=>{var n,s;t.isConnected&&((null==(n=e.hoverTimeouts)?void 0:n.has(t))&&clearTimeout(e.hoverTimeouts.get(t)),null==(s=e.hoverTimeouts)||s.set(t,setTimeout(()=>{t.isConnected&&!e.isMobile&&e.element.classList.contains("topmenu")&&this.closeSubmenu(e,t)},this.config.hover.closeDelay)))},a=t.closest("li");a.addEventListener("mouseenter",mouseEnterHandler),a.addEventListener("mouseleave",mouseLeaveHandler),t.hoverHandlers={enter:mouseEnterHandler,leave:mouseLeaveHandler}})},checkResponsiveState(e,t=!1){const a=e.isMobile,n=window.innerWidth<this.config.breakpoint;e.elements.container.setAttribute("aria-orientation",n||e.isSidebar?"vertical":"horizontal"),e.elements.submenus.forEach(e=>{e.content&&this.checkAndAdjustPosition(e.content)});let s=t;n!==a&&(s=!0,e.isMobile=n,n||!this.isMenuOpen(e)||e.isSidebar||this.closeMenu(e),n?document.body.classList.add("mobile-menu"):document.body.classList.remove("mobile-menu")),s&&e.element.classList.contains("topmenu")&&(n?t||this.removeHoverHandlers(e):this.setupHoverHandlers(e))},isHoveringSubmenu(e,t){var a;const n=e.closest("li"),s=t.relatedTarget;if(!s)return!1;if(n.contains(s))return!0;const r=n.closest("ul");if(r&&r.contains(s))return!0;let i=null==r?void 0:r.parentElement;for(;i;){if(i.contains(s))return!0;i=null==(a=i.closest("li"))?void 0:a.parentElement}return!1},findTopLevelMenuItem(e){let t=e.closest("li");for(;t;){const e=t.parentElement;if(!e||!e.closest("li"))return t.querySelector(':scope > [role="menuitem"]');t=e.closest("li")}return null},getTopLevelMenuItems:e=>e.elements.container.querySelectorAll(":scope > li > a, :scope > li:not(.menu-close) > button"),handleKeyboardNavigation(e,t){var a,n,s,r,i;if(!e.element.contains(t.target))return;const o=document.activeElement,l=o.closest("ul")===e.elements.container,c=o.closest('[aria-haspopup="true"]'),d="horizontal"===e.elements.container.getAttribute("aria-orientation");switch(t.key){case"Escape":if(t.preventDefault(),l)this.isMenuOpen(e)&&(this.closeAllSubmenus(e),this.closeMenu(e),(null==(a=e.elements)?void 0:a.toggle)&&e.elements.toggle.focus());else{const t=o.closest("ul").parentElement.querySelector('[aria-haspopup="true"]');t&&(this.closeSubmenu(e,t),t.focus())}break;case"Tab":if(!l){const a=this.findTopLevelMenuItem(o),s=this.getTopLevelMenuItems(e),r=Array.from(s).indexOf(a);let i;if(i=t.shiftKey?s[r-1]:s[r+1],!i)return this.closeMenu(e),void((null==(n=e.elements)?void 0:n.toggle)&&e.elements.toggle.focus());t.preventDefault(),i.focus(),i.hasAttribute("aria-haspopup")&&this.openSubmenu(e,i,{useKeyboard:!0})}break;case"Enter":case" ":o.hasAttribute("aria-haspopup")&&(t.preventDefault(),this.openSubmenu(e,o,{useKeyboard:!0}));break;case"Escape":t.preventDefault(),c?(this.closeSubmenu(e,c),c.focus()):this.isMenuOpen(e)&&(this.closeMenu(e),null==(s=e.elements.toggle)||s.focus());break;case"ArrowDown":if(t.preventDefault(),o.hasAttribute("aria-haspopup")&&"false"===o.getAttribute("aria-expanded"))this.openSubmenu(e,o,{useKeyboard:!0});else{const e=Array.from(o.closest("ul").querySelectorAll(':scope > li > [role="menuitem"]')),t=this.getNextFocusableItem(e,o);t&&t.focus()}break;case"ArrowUp":t.preventDefault();const u=Array.from(o.closest("ul").querySelectorAll(':scope > li > [role="menuitem"]')),h=this.getPreviousFocusableItem(u,o);h&&h.focus();break;case"ArrowRight":if(d&&l){t.preventDefault();const a=this.getTopLevelMenuItems(e),n=this.getNextFocusableItem(a,o);n&&(n.focus(),n.hasAttribute("aria-haspopup")&&this.openSubmenu(e,n,{useKeyboard:!0}))}else o.hasAttribute("aria-haspopup")&&(t.preventDefault(),this.openSubmenu(e,o,{useKeyboard:!0}));break;case"ArrowLeft":if(d&&l){t.preventDefault();const a=this.getTopLevelMenuItems(e),n=this.getPreviousFocusableItem(a,o);n&&(n.focus(),n.hasAttribute("aria-haspopup")&&this.openSubmenu(e,n))}else{t.preventDefault();const a=null==(i=null==(r=o.closest("ul"))?void 0:r.parentElement)?void 0:i.querySelector('[aria-haspopup="true"]');a&&(this.closeSubmenu(e,a),a.focus())}break;case"Home":t.preventDefault();const p=this.getFirstFocusableItem(e);p&&p.focus();break;case"End":t.preventDefault();const m=this.getLastFocusableItem(e);m&&m.focus()}},getFirstFocusableItem:e=>e.elements.container.querySelector('[role="menuitem"]:not([disabled])'),getLastFocusableItem(e){const t=e.elements.container.querySelectorAll('[role="menuitem"]:not([disabled])');return t[t.length-1]},findSubmenuByToggle:(e,t)=>e.elements.submenus.find(e=>e.toggle===t),getNextFocusableItem:(e,t)=>e[Array.from(e).indexOf(t)+1]||e[0],getPreviousFocusableItem:(e,t)=>e[Array.from(e).indexOf(t)-1]||e[e.length-1],announce(e,t={}){var a;this.announcer||(this.announcer=document.createElement("div"),this.announcer.setAttribute("aria-live","polite"),this.announcer.setAttribute("role","status"),this.announcer.setAttribute("aria-atomic","true"),this.announcer.className="sr-only",document.body.appendChild(this.announcer)),this.announcer.setAttribute("lang",(null==(a=window.I18nManager)?void 0:a.getCurrentLocale())||"en"),this.announcer.textContent=I18nManager.translate(e,t)},handleError(e,t,a,n=!0){if(t.isRecoveryError)ErrorManager.handle(t,{context:`MenuManager.${a}`,type:"error:menu",notify:!0});else if(ErrorManager.handle(e,{context:`MenuManager.${a}`,type:"error:menu",data:{canRecover:n},notify:!0}),n)try{this.recoverFromError()}catch(s){s.isRecoveryError=!0,ErrorManager.handle(s,{context:`MenuManager.recovery.${a}`,type:"error:menu",notify:!0}),this.forceCleanup()}},recoverFromError(){this.state.menus.forEach(e=>{this.isMenuOpen(e)&&this.closeMenu(e),this.closeAllSubmenus(e),this.resetMenuState(e)}),this.checkResponsiveState()},forceCleanup(){try{this.state.menus.forEach(e=>{var t;e.touchData=null,e.element.style.transform="",(null==(t=e.elements)?void 0:t.toggle)&&e.elements.toggle.setAttribute("aria-expanded","false")}),menu.element&&menu.element.classList.contains("sidemenu")?document.body.classList.remove("sidemenu-close"):document.body.classList.remove("topmenu-open")}catch(e){ErrorManager.handle(e,{context:"MenuManager.forceCleanup"})}},resetMenuState(e){e.touchData=null,e.element.style.transform="",e.element&&e.element.classList.contains("sidemenu")?document.body.classList.remove("sidemenu-close"):document.body.classList.remove("topmenu-open")},destroyMenu(e){const t=this.state.menus.get(e);t&&(this.cleanup(t),t.element&&delete t.element.dataset.menuId,this.state.menus.delete(e))},cleanup(e){var t,a,n,s;e&&(e.handlers&&(e.handlers.toggle&&(null==(t=e.elements.toggle)||t.removeEventListener("click",e.handlers.toggle)),e.handlers.close&&(null==(a=e.elements.close)||a.removeEventListener("click",e.handlers.close)),e.handlers.backdrop&&(null==(n=e.elements.backdrop)||n.removeEventListener("click",e.handlers.backdrop)),e.handlers.keydown&&document.removeEventListener("keydown",e.handlers.keydown),e.handlers.resize&&window.removeEventListener("resize",e.handlers.resize),e.handlers.focusout&&e.element.removeEventListener("focusout",e.handlers.focusout),e.handlers.touch&&(e.element.removeEventListener("touchstart",e.handlers.touch.start),e.element.removeEventListener("touchmove",e.handlers.touch.move),e.element.removeEventListener("touchend",e.handlers.touch.end),e.element.removeEventListener("touchcancel",e.handlers.touch.cancel))),this.removeHoverHandlers(e),e.hoverTimeouts&&(e.hoverTimeouts.forEach(e=>clearTimeout(e)),e.hoverTimeouts.clear()),e.elements&&(e.elements.backdrop&&e.elements.backdrop.remove(),e.elements.close&&e.elements.close.remove(),(null==(s=e.elements.toggle)?void 0:s.classList.contains("runtime"))&&e.elements.toggle.remove()),e.touchData=null,e.element.style.transform="",e.element&&e.element.classList.contains("sidemenu")?document.body.classList.remove("sidemenu-close"):document.body.classList.remove("topmenu-open"),e.element=null,e.elements=null,e.handlers=null,e.hoverTimeouts=null,e.touchData=null)},removeHoverHandlers(e){var t;(null==(t=null==e?void 0:e.elements)?void 0:t.submenus)&&(e.elements.submenus.forEach(e=>{if(null==e?void 0:e.hoverHandlers){const t=e.closest("li");t&&(t.removeEventListener("mouseenter",e.hoverHandlers.enter),t.removeEventListener("mouseleave",e.hoverHandlers.leave)),delete e.hoverHandlers}}),e.hoverTimeouts&&(e.hoverTimeouts.forEach(clearTimeout),e.hoverTimeouts.clear(),delete e.hoverTimeouts))},destroy(){var e;this.state.menus.forEach(e=>{this.destroyMenu(e.id)}),this.state.menus.clear(),this.observer&&(this.observer.disconnect(),this.observer=null),this.announcer&&(this.announcer.remove(),this.announcer=null),menu.elements&&(menu.elements.backdrop&&menu.elements.backdrop.remove(),menu.elements.close&&menu.elements.close.remove(),(null==(e=menu.elements.toggle)?void 0:e.classList.contains("runtime"))&&menu.elements.toggle.remove()),this.state.initialized=!1,Now.emit("menumanager:destroyed")},handleTouchMove(e,t){this.config.performance.touchOptimization?e.element.style.transform=`translate3d(${t}px, 0, 0)`:e.element.style.transform=`translateX(${t}px)`},findMenuByElement(e){for(const t of this.state.menus.values())if(t.element===e)return t;return null},closeOtherSubmenus(e,t){const a=t.closest("li"),n=null==a?void 0:a.closest("ul");n&&e.elements.submenus.forEach(a=>{const s=a.closest("li");a!==t&&s&&s.closest("ul")===n&&this.closeSubmenu(e,a)})},isSubmenuReady:e=>e&&e.isConnected&&e.content&&e.content.isConnected,renderFromData(e,t,a={}){if("string"==typeof e&&(e=document.querySelector(e)),!e)return ErrorManager.handle("MenuManager.renderFromData: Container not found",{context:"MenuManager.renderFromData",data:{container:e,options:a}}),null;if(!Array.isArray(t))return ErrorManager.handle("MenuManager.renderFromData: Data must be an array",{context:"MenuManager.renderFromData",data:{data:t}}),e;const n=e.dataset.menuId;n&&this.state.menus.has(n)&&this.destroyMenu(n);const s=document.createElement("ul");return t.forEach((e,t)=>{const n=this.createMenuItem(e,0,a);s.appendChild(n)}),e.innerHTML="",e.appendChild(s),e.hasAttribute("data-component")||e.setAttribute("data-component","menu"),this.createMenu(e),this.updateActiveMenu(),Now.emit("menu:rendered",{container:e,itemCount:t.length}),e},createMenuItem(e,t=0,a={}){const n=document.createElement("li");n.setAttribute("role","none");if(e.children&&Array.isArray(e.children)&&e.children.length>0){const s=document.createElement("button");if(s.type="button",s.setAttribute("role","menuitem"),s.setAttribute("aria-haspopup","true"),s.setAttribute("aria-expanded","false"),e.icon){const t=document.createElement("i");t.className=e.icon,s.appendChild(t)}const r=e.title||"",i=document.createElement("span");i.textContent=I18nManager.translate(r),i.setAttribute("data-i18n",r),s.appendChild(i),n.appendChild(s);const o=`submenu-${Utils.generateUUID()}`,l=document.createElement("ul");l.id=o,l.setAttribute("role","menu"),l.setAttribute("aria-label",I18nManager.translate("Submenu")),l.setAttribute("aria-hidden","true"),s.setAttribute("aria-controls",o),t<1&&e.children.forEach(e=>{const n=this.createMenuItem(e,t+1,a);l.appendChild(n)}),n.appendChild(l)}else{const t=document.createElement("a");if(t.href=e.url||"#",t.setAttribute("role","menuitem"),e.icon){const a=document.createElement("i");a.className=e.icon,t.appendChild(a)}const a=e.title||"",s=document.createElement("span");if(s.textContent=I18nManager.translate(a),s.setAttribute("data-i18n",a),t.appendChild(s),e.badge){const a=document.createElement("span");a.className=e.badgeClass||"badge",a.textContent=e.badge,a.setAttribute("data-i18n",e.badge||""),t.appendChild(a)}n.appendChild(t)}return e.id&&(n.id=e.id),e.class&&(n.className=e.class),e.data&&Object.entries(e.data).forEach(([e,t])=>{n.dataset[e]=t}),n},setData(e,t,a={}){return this.renderFromData(e,t,a)}};(null==(_=window.Now)?void 0:_.registerManager)&&Now.registerManager("menu",Pe),window.MenuManager=Pe;let He=class Sortable2{constructor(e,t={}){this.element=e;const a=e.dataset.sortableApi||e.dataset.apiEndpoint,n=e.dataset.sortableMethod||e.dataset.apiMethod||"PUT",s=e.dataset.sortableIdAttr||"data-id",r=e.dataset.sortableStageAttr||"data-category",i=e.dataset.sortableUpdateField||"category",o=e.dataset.sortableExtraData;this.options={draggable:'[draggable="true"]',handle:null,animation:150,ghostClass:"sortable-ghost",dragClass:"sortable-drag",dataIdAttr:"data-id",forceFallback:!1,fallbackTolerance:0,scroll:!0,scrollSensitivity:30,scrollSpeed:10,rtl:"rtl"===document.dir,disabled:!1,group:null,apiEndpoint:a,apiMethod:n,apiIdAttr:s,apiStageAttr:r,apiUpdateField:i,apiExtraData:o?JSON.parse(o):null,...t},this.state={dragging:null,ghost:null,placeholder:null,initialIndex:-1,scrollInterval:null,dragStartEvent:null,sourceContainer:null},this.options.group&&(Sortable2.groups||(Sortable2.groups={}),Sortable2.groups[this.options.group]||(Sortable2.groups[this.options.group]=[]),Sortable2.groups[this.options.group].push(this)),this.init()}init(){this.options.disabled||(this.handlers={dragStart:this.handleDragStart.bind(this),dragOver:this.handleDragOver.bind(this),dragEnd:this.handleDragEnd.bind(this),keyDown:this.handleKeyDown.bind(this)},this.addEventListeners())}addEventListeners(){this.element.addEventListener("mousedown",this.handlers.dragStart),this.element.addEventListener("touchstart",this.handlers.dragStart,{passive:!1}),this.element.addEventListener("keydown",this.handlers.keyDown),this.options.scroll&&window.addEventListener("scroll",this.handleScroll.bind(this),{passive:!0})}handleDragStart(e){try{if(this.options.disabled||void 0!==e.button&&0!==e.button)return;if(e.target.closest("a, button, input, select, textarea, [data-no-drag]"))return;const t=this.getDragElement(e);if(!t)return;e.preventDefault(),this.state.dragging=t,this.state.initialIndex=this.getIndex(t),this.state.dragStartEvent=e,this.state.sourceContainer=this.element,this.createGhost(t,e),this.createPlaceholder(t),t.classList.add(this.options.dragClass),t.style.opacity="0",document.addEventListener("mousemove",this.handlers.dragOver),document.addEventListener("touchmove",this.handlers.dragOver),document.addEventListener("mouseup",this.handlers.dragEnd),document.addEventListener("touchend",this.handlers.dragEnd),"function"==typeof this.options.onStart&&this.options.onStart({item:t,startIndex:this.state.initialIndex,event:e}),this.dispatchEvent("start",{item:t,startIndex:this.state.initialIndex})}catch(t){ErrorManager.handle(t,{context:"Sortable.dragStart",type:"error:sortable"}),this.handleDragEnd()}}handleDragOver(e){this.state.dragging&&(e.preventDefault(),requestAnimationFrame(()=>{try{const t=e.touches?e.touches[0]:e;this.moveGhost(t.pageX,t.pageY),this.options.scroll&&this.handleScrolling(t);const a=this.findTargetContainer(t.pageX,t.pageY);if(a&&a.element&&a.element!==this.state.dragging&&a.element!==this.state.placeholder){const e=a.container,n=a.element,s=n.getBoundingClientRect(),r=window.pageYOffset||document.documentElement.scrollTop;t.pageY>s.top+r+s.height/2?e.insertBefore(this.state.placeholder,n.nextSibling):e.insertBefore(this.state.placeholder,n)}else if(a&&a.container&&!a.element){const e=a.container;0!==e.children.length&&e.contains(this.state.placeholder)||e.appendChild(this.state.placeholder)}}catch(t){ErrorManager.handle(t,{context:"Sortable.dragOver",type:"error:sortable"}),this.handleDragEnd()}}))}handleDragEnd(){if(this.state.dragging)try{const e=this.state.dragging,t=this.state.initialIndex,a=this.state.sourceContainer;if(this.state.placeholder&&this.state.placeholder.parentNode){const n=this.state.placeholder.parentNode;n.insertBefore(e,this.state.placeholder),e.style.opacity="";const s=this.getIndex(e);this.state.placeholder.remove(),this.state.placeholder=null,"function"==typeof this.options.onEnd&&this.options.onEnd({item:e,newIndex:s,oldIndex:t,to:n,from:a,event:this.state.dragStartEvent}),this.dispatchEvent("end",{item:e,newIndex:s,oldIndex:t,to:n,from:a}),!this.options.apiEndpoint||s===t&&n===a||this.autoSavePosition(e,n)}else e.style.opacity="";e.classList.remove(this.options.dragClass),this.state.ghost&&(this.state.ghost.remove(),this.state.ghost=null),this.state.scrollInterval&&clearInterval(this.state.scrollInterval),document.removeEventListener("mousemove",this.handlers.dragOver),document.removeEventListener("touchmove",this.handlers.dragOver),document.removeEventListener("mouseup",this.handlers.dragEnd),document.removeEventListener("touchend",this.handlers.dragEnd),this.state={dragging:null,ghost:null,placeholder:null,initialIndex:-1,scrollInterval:null,dragStartEvent:null,sourceContainer:null}}catch(e){ErrorManager.handle(e,{context:"Sortable.dragEnd",type:"error:sortable"})}}handleKeyDown(e){if(this.options.disabled)return;const t=e.target;if(t.matches(this.options.draggable))switch(e.key){case"ArrowUp":e.preventDefault(),this.moveElement(t,-1);break;case"ArrowDown":e.preventDefault(),this.moveElement(t,1);break;case"Space":e.preventDefault(),this.toggleSelection(t)}}handleScrolling(e){const t=this.options.scrollSensitivity,a=this.options.scrollSpeed,n=window.pageYOffset;let s=!1,r=0;e.pageY-n<t?(r=-1,s=!0):window.innerHeight+n-e.pageY<t&&(r=1,s=!0),s&&!this.state.scrollInterval?this.state.scrollInterval=setInterval(()=>{window.scrollBy(0,a*r)},16):!s&&this.state.scrollInterval&&(clearInterval(this.state.scrollInterval),this.state.scrollInterval=null)}handleScroll(e){if(!this.state.dragging)return;const t=e.touches?e.touches[0]:e,a=this.options.scrollSensitivity,n=this.options.scrollSpeed,s=window.pageYOffset||document.documentElement.scrollTop,r=window.innerHeight;let i=!1,o=0;const l=t.pageY-s,c=r-(t.pageY-s);l<a?(o=-1,i=!0):c<a&&(o=1,i=!0),i&&!this.state.scrollInterval?this.state.scrollInterval=setInterval(()=>{window.scrollBy({top:n*o,behavior:"smooth"}),this.state.ghost&&this.moveGhost(t.pageX,t.pageY+n*o)},16):!i&&this.state.scrollInterval&&(clearInterval(this.state.scrollInterval),this.state.scrollInterval=null)}getDragElement(e){const t=e.target;if(this.options.handle){const e=t.closest(this.options.handle);return e?e.closest(this.options.draggable):null}return t.closest(this.options.draggable)}createGhost(e,t){const a=t.pageX||(t.touches&&t.touches[0]?t.touches[0].pageX:0),n=t.pageY||(t.touches&&t.touches[0]?t.touches[0].pageY:0);if("TR"===e.tagName){const e=document.createElement("div");e.className=this.options.ghostClass||"sortable-ghost",e.textContent="⋮⋮",e.style.display="inline-flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.width="28px",e.style.height="28px",e.style.background="rgba(0,0,0,0.65)",e.style.color="#fff",e.style.borderRadius="6px",e.style.fontSize="18px",e.style.boxShadow="0 4px 8px rgba(0,0,0,0.25)",e.style.cursor="grabbing";const t=14;return this.state.mouseOffset={x:t,y:t},this.state.lockedX=a-t,Object.assign(e.style,{position:"absolute",top:n-this.state.mouseOffset.y+"px",left:this.state.lockedX+"px",zIndex:"9999",pointerEvents:"none",transition:"none",transform:"none"}),document.body.appendChild(e),void(this.state.ghost=e)}const s=e.getBoundingClientRect(),r=window.pageXOffset||document.documentElement.scrollLeft,i=window.pageYOffset||document.documentElement.scrollTop,o=a-(s.left+r),l=n-(s.top+i),c=e.cloneNode(!0);c.classList.add(this.options.ghostClass||"sortable-ghost"),Object.assign(c.style,{position:"absolute",width:s.width+"px",height:s.height+"px",left:a-o+"px",top:n-l+"px",pointerEvents:"none",opacity:"0.8",zIndex:"9999",transition:"none",transform:"none"}),document.body.appendChild(c),this.state.mouseOffset={x:o,y:l},this.state.lockedX=void 0,this.state.ghost=c}createPlaceholder(e){const t=e.getBoundingClientRect();if("TR"===e.tagName){const t=document.createElement("tr");t.className="sortable-placeholder",t.style.pointerEvents="none";const a=document.createElement("td");return a.colSpan=e.children.length||1,a.style.padding="0",a.style.border="none",a.style.height="0",a.style.borderTop="2px dashed rgba(0,0,0,0.35)",t.appendChild(a),e.parentNode.insertBefore(t,e.nextSibling),void(this.state.placeholder=t)}const a=document.createElement("div");a.className="sortable-placeholder",a.style.height=t.height+"px",a.style.width=t.width+"px",e.parentNode.insertBefore(a,e.nextSibling),this.state.placeholder=a}moveGhost(e,t){const a=this.state.ghost,n=this.state.mouseOffset;a&&n&&requestAnimationFrame(()=>{if(!a||a!==this.state.ghost)return;const s=this.state.lockedX;let r=void 0!==s?s:e-n.x,i=t-n.y;this.options.rtl&&(r=window.innerWidth-r-a.offsetWidth),Object.assign(a.style,{top:i+"px",left:r+"px"})})}findElementUnderPoint(e,t){const a=Array.from(this.element.querySelectorAll(this.options.draggable));for(const n of a){if(n===this.state.dragging)continue;const a=n.getBoundingClientRect(),s=window.pageYOffset||document.documentElement.scrollTop,r=window.pageXOffset||document.documentElement.scrollLeft;if(e>=a.left+r&&e<=a.right+r&&t>=a.top+s&&t<=a.bottom+s)return n}return null}findTargetContainer(e,t){if(!this.options.group){const a=this.findElementUnderPoint(e,t);return a?{container:this.element,element:a}:null}const a=Sortable2.groups[this.options.group]||[];for(const n of a){const a=n.element,s=a.getBoundingClientRect(),r=window.pageYOffset||document.documentElement.scrollTop,i=window.pageXOffset||document.documentElement.scrollLeft;if(e>=s.left+i&&e<=s.right+i&&t>=s.top+r&&t<=s.bottom+r){const s=Array.from(a.querySelectorAll(n.options.draggable));for(const n of s){if(n===this.state.dragging)continue;const s=n.getBoundingClientRect();if(e>=s.left+i&&e<=s.right+i&&t>=s.top+r&&t<=s.bottom+r)return{container:a,element:n}}return{container:a,element:null}}}return null}getIndex(e){return Array.from(this.element.querySelectorAll(this.options.draggable)).indexOf(e)}swapElements(e,t){const a=e.getBoundingClientRect(),n=t.getBoundingClientRect();e.style.transition="none",t.style.transition="none",e.style.transform=`translate(${n.left-a.left}px, ${n.top-a.top}px)`,t.style.transform=`translate(${a.left-n.left}px, ${a.top-n.top}px)`,requestAnimationFrame(()=>{e.style.transform="",t.style.transform="",e.style.transition="",t.style.transition="";const a=t.nextSibling,n=t.parentNode;e.parentNode.insertBefore(t,e),n.insertBefore(e,a)})}moveElement(e,t){const a=Array.from(this.element.querySelectorAll(this.options.draggable)),n=a.indexOf(e),s=n+t;if(s>=0&&s<a.length){const t=a[s];this.swapElements(e,t),e.focus(),this.dispatchEvent("change",{item:e,newIndex:s,oldIndex:n})}}toggleSelection(e){e.classList.toggle("selected"),this.dispatchEvent("select",{item:e,selected:e.classList.contains("selected")})}dispatchEvent(e,t){this.element.dispatchEvent(new CustomEvent("sortable:"+e,{bubbles:!0,cancelable:!0,detail:t}))}async autoSavePosition(e,t){var a;try{const n=e.getAttribute(this.options.apiIdAttr);if(!n)return void console.warn("Sortable: No ID found on dragged item",this.options.apiIdAttr);const s=t.getAttribute(this.options.apiStageAttr);if(!s)return void console.warn("Sortable: No value found on target container",this.options.apiStageAttr);const r={id:n,[this.options.apiUpdateField]:s,update_stage_only:!0,...this.options.apiExtraData||{}},i=await window.http.post(this.options.apiEndpoint,r),o=(null==(a=null==i?void 0:i.data)?void 0:a.data)??(null==i?void 0:i.data)??i;if(401===(null==i?void 0:i.status)){if(console.warn("Sortable: Unauthorized (401)"),window.AuthErrorHandler){const e=new Error(i.statusText||"Unauthorized");e.status=401,e.response=i,await AuthErrorHandler.handleError(e,{currentPath:window.location.pathname})}return}if(403===(null==i?void 0:i.status))return window.NotificationManager&&NotificationManager.error((null==o?void 0:o.message)||"Access forbidden"),void this.dispatchEvent("api-error",{item:e,error:{message:(null==o?void 0:o.message)||"Access forbidden",status:403}});if(window.ResponseHandler&&o&&await ResponseHandler.process(o,{data:o,reload:null}),!1===(null==o?void 0:o.success))throw new Error((null==o?void 0:o.message)||"API request failed");this.dispatchEvent("api-success",{item:e,response:o,payload:r})}catch(n){console.error("Sortable: Auto-save failed",n),window.NotificationManager&&NotificationManager.error(n.message||"Status update failed"),this.dispatchEvent("api-error",{item:e,error:n}),window.ErrorManager&&ErrorManager.handle(n,{context:"Sortable.autoSavePosition",type:"error:api"})}}enable(){this.options.disabled=!1}disable(){this.options.disabled=!0,this.state.dragging&&this.handleDragEnd()}destroy(){if(this.element.removeEventListener("mousedown",this.handlers.dragStart),this.element.removeEventListener("touchstart",this.handlers.dragStart),this.element.removeEventListener("keydown",this.handlers.keyDown),this.options.scroll&&window.removeEventListener("scroll",this.handleScroll),this.options.group&&Sortable2.groups[this.options.group]){const e=Sortable2.groups[this.options.group].indexOf(this);e>-1&&Sortable2.groups[this.options.group].splice(e,1)}this.state={dragging:null,ghost:null,placeholder:null,initialIndex:-1,scrollInterval:null,dragStartEvent:null,sourceContainer:null},this.element=null,this.options=null,this.handlers=null}};He.groups={},He.state={instances:new Map,initialized:!1,observer:null},He.init=function(e={}){this.state.initialized||(this.initElements(),this.setupGlobalObserver(),this.state.initialized=!0)},He.setupGlobalObserver=function(){this.state.observer||(this.state.observer=new MutationObserver(e=>{let t=!1;e.forEach(e=>{e.addedNodes.forEach(e=>{if(1===e.nodeType)if(e.matches&&e.matches('[data-component="sortable"]'))t=!0;else if(e.querySelectorAll){e.querySelectorAll('[data-component="sortable"]').length>0&&(t=!0)}})}),t&&setTimeout(()=>{this.initElements()},50)}),this.state.observer.observe(document.body,{childList:!0,subtree:!0}))},He.initElements=function(){document.querySelectorAll('[data-component="sortable"]').forEach(e=>{this.state.instances.has(e)||this.create(e)})},He.create=function(e,t={}){if(!e)return console.error("[Sortable] Element is required"),null;if(this.state.instances.has(e))return this.state.instances.get(e);const a={...t,...{group:e.dataset.group,animation:parseInt(e.dataset.animation)||150,draggable:e.dataset.draggable||'[draggable="true"]',handle:e.dataset.handle,ghostClass:e.dataset.ghostClass||"sortable-ghost",chosenClass:e.dataset.chosenClass||"sortable-chosen",dragClass:e.dataset.dragClass||"sortable-drag",disabled:"true"===e.dataset.disabled,apiUrl:e.dataset.apiUrl,apiMethod:e.dataset.apiMethod||"POST",apiIdAttr:e.dataset.sortableIdAttr||"data-id",apiStageAttr:e.dataset.sortableStageAttr||"data-category",apiUpdateField:e.dataset.sortableUpdateField||"category"}},n=new He(e,a);return this.state.instances.set(e,n),e._sortableInstance=n,n},He.getInstance=function(e){return this.state.instances.get(e)||null},He.destroyAll=function(){this.state.instances.forEach((e,t)=>{e.destroy()}),this.state.instances.clear(),this.state.initialized=!1},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{He.init()}):He.init(),window.Sortable=He;const qe={config:{defaultTab:null,keyboard:!0,animation:!0,animationDuration:300,buttonSelector:".tab-button",panelSelector:".tab-pane",hash:!0,hashPrefix:"",destroyOnHidden:!1,lazy:!1,ariaLabel:"Tabs",onInit:null,onTabChange:null,beforeTabChange:null,onDestroy:null,orientation:"horizontal",debug:!1},state:{instances:new Map,initialized:!1,observer:null},init(e={}){this.state.initialized?this.config.debug&&console.warn("TabsComponent already initialized"):(Object.assign(this.config,e),this.initElements(),this.setupObserver(),this.state.initialized=!0)},initElements(){document.querySelectorAll('[data-component="tabs"]').forEach(e=>{this.state.instances.has(e)||this.create(e)})},create(e,t={}){if(!e)return console.error("TabsComponent.create: element is required"),null;if(this.state.instances.has(e))return this.config.debug&&console.warn("Tabs already initialized on element:",e),this.state.instances.get(e);const a=this.extractOptionsFromElement(e),n={...this.config,...a,...t},s=n.buttonSelector,r=n.panelSelector,i=e.querySelectorAll(s),o=e.querySelectorAll(r);if(0===i.length)return console.error(`TabsComponent: No tab buttons found (${s})`),null;if(0===o.length)return console.error(`TabsComponent: No tab panels found (${r})`),null;const l={element:e,config:n,buttons:Array.from(i),panels:Array.from(o),activeTab:null,tabIds:[],destroyed:!1};return this.setup(l),this.state.instances.set(e,l),"function"==typeof l.config.onInit&&l.config.onInit.call(l),l},setup(e){if(e.tabIds=e.buttons.map(e=>e.dataset.tab).filter(Boolean),0===e.tabIds.length)return void console.error("TabsComponent: No valid tab IDs found (data-tab attribute)");this.setupAccessibility(e),this.setupEventHandlers(e),e.config.hash&&this.setupHashNavigation(e);let t=this.getInitialTab(e);this.switchTab(e,t,!0),e.switchTab=t=>this.switchTab(e,t),e.getActiveTab=()=>e.activeTab,e.destroy=()=>this.destroy(e),e.refresh=()=>this.refresh(e)},setupAccessibility(e){const{element:t,buttons:a,panels:n,config:s}=e;let r=t.querySelector('[role="tablist"]');r||(r=a[0].parentElement,r.setAttribute("role","tablist")),r.setAttribute("aria-orientation",s.orientation),s.ariaLabel&&r.setAttribute("aria-label",s.ariaLabel),a.forEach((e,t)=>{const a=e.dataset.tab,s=n.find(e=>e.dataset.tab===a);if(!s)return void console.warn(`TabsComponent: No panel found for tab "${a}"`);const r=e.id||`tab-${a}-${Date.now()}-${t}`,i=s.id||`panel-${a}-${Date.now()}-${t}`;e.id=r,s.id=i,e.setAttribute("role","tab"),e.setAttribute("aria-controls",i),e.setAttribute("aria-selected","false"),e.setAttribute("tabindex","-1"),s.setAttribute("role","tabpanel"),s.setAttribute("aria-labelledby",r),s.setAttribute("tabindex","0"),s.hidden=!0})},setupEventHandlers(e){const{buttons:t,config:a}=e;t.forEach(t=>{t.addEventListener("click",a=>{a.preventDefault();const n=t.dataset.tab;this.switchTab(e,n)}),a.keyboard&&t.addEventListener("keydown",a=>{this.handleKeydown(e,a,t)})})},handleKeydown(e,t,a){const{buttons:n,config:s}=e,r=n.indexOf(a);let i=r;switch(s.orientation,t.key){case"ArrowLeft":case"ArrowUp":t.preventDefault(),i=r>0?r-1:n.length-1;break;case"ArrowRight":case"ArrowDown":t.preventDefault(),i=r<n.length-1?r+1:0;break;case"Home":t.preventDefault(),i=0;break;case"End":t.preventDefault(),i=n.length-1;break;default:return}const o=n[i],l=o.dataset.tab;this.switchTab(e,l),o.focus()},switchTab(e,t,a=!1){if(e.destroyed)return console.warn("TabsComponent: Cannot switch tab on destroyed instance"),!1;if(!e.tabIds.includes(t))return console.error(`TabsComponent: Tab "${t}" not found`),!1;if(!a&&e.activeTab===t)return!1;if(!a&&"function"==typeof e.config.beforeTabChange){if(!1===e.config.beforeTabChange.call(e,t,e.activeTab))return!1}const n=e.activeTab;e.buttons.forEach(e=>{e.classList.remove("active"),e.setAttribute("aria-selected","false"),e.setAttribute("tabindex","-1")}),e.panels.forEach(e=>{e.classList.remove("active"),e.hidden=!0});const s=e.buttons.find(e=>e.dataset.tab===t),r=e.panels.find(e=>e.dataset.tab===t);return!(!s||!r)&&(s.classList.add("active"),s.setAttribute("aria-selected","true"),s.setAttribute("tabindex","0"),r.classList.add("active"),r.hidden=!1,e.activeTab=t,!a&&e.config.hash&&this.updateHash(e,t),this.dispatchEvent(e,"tabchange",{tabId:t,previousTab:n,button:s,panel:r}),a||"function"!=typeof e.config.onTabChange||e.config.onTabChange.call(e,t,n),!0)},refresh(e){if(e.destroyed)return;const t=e.config.buttonSelector,a=e.config.panelSelector;e.buttons=Array.from(e.element.querySelectorAll(t)),e.panels=Array.from(e.element.querySelectorAll(a)),e.tabIds=e.buttons.map(e=>e.dataset.tab).filter(Boolean),this.setupAccessibility(e),this.setupEventHandlers(e)},destroy(e){e.destroyed||(e._hashHandler&&(window.removeEventListener("popstate",e._hashHandler),window.removeEventListener("hashchange",e._hashHandler),delete e._hashHandler),e.buttons.forEach(e=>{e.removeAttribute("role"),e.removeAttribute("aria-controls"),e.removeAttribute("aria-selected"),e.removeAttribute("tabindex")}),e.panels.forEach(e=>{e.removeAttribute("role"),e.removeAttribute("aria-labelledby"),e.removeAttribute("tabindex"),e.hidden=!1}),"function"==typeof e.config.onDestroy&&e.config.onDestroy.call(e),this.state.instances.delete(e.element),e.destroyed=!0)},setupObserver(){this.state.observer||(this.state.observer=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{1===e.nodeType&&(e.matches&&e.matches('[data-component="tabs"]')&&this.create(e),e.querySelectorAll&&e.querySelectorAll('[data-component="tabs"]').forEach(e=>{this.create(e)}))}),e.removedNodes.forEach(e=>{if(1===e.nodeType){const t=this.state.instances.get(e);t&&t.config.destroyOnHidden&&setTimeout(()=>{e.isConnected||this.destroy(t)},0)}})})}),this.state.observer.observe(document.body,{childList:!0,subtree:!0}))},extractOptionsFromElement(e){const t={};return e.dataset.defaultTab&&(t.defaultTab=e.dataset.defaultTab),e.dataset.orientation&&(t.orientation=e.dataset.orientation),e.dataset.ariaLabel&&(t.ariaLabel=e.dataset.ariaLabel),void 0!==e.dataset.keyboard&&(t.keyboard="false"!==e.dataset.keyboard),void 0!==e.dataset.animation&&(t.animation="false"!==e.dataset.animation),void 0!==e.dataset.hash&&(t.hash="true"===e.dataset.hash),void 0!==e.dataset.lazy&&(t.lazy="true"===e.dataset.lazy),void 0!==e.dataset.debug&&(t.debug="true"===e.dataset.debug),e.dataset.hashPrefix&&(t.hashPrefix=e.dataset.hashPrefix),e.dataset.buttonSelector&&(t.buttonSelector=e.dataset.buttonSelector),e.dataset.panelSelector&&(t.panelSelector=e.dataset.panelSelector),e.dataset.animationDuration&&(t.animationDuration=parseInt(e.dataset.animationDuration,10)),t},getInstance(e){return this.state.instances.get(e)||null},dispatchEvent(e,t,a={}){const n=new CustomEvent(`tabs:${t}`,{detail:{instance:e,...a},bubbles:!0,cancelable:!0});e.element.dispatchEvent(n)},getInitialTab(e){const{config:t,tabIds:a}=e;let n=t.defaultTab||a[0];if(t.hash){const t=this.getTabFromHash(e);t&&a.includes(t)&&(n=t)}return a.includes(n)||(t.debug&&console.warn(`TabsComponent: Tab "${n}" not found, using first tab`),n=a[0]),n},getTabFromHash(e){const t=window.location.hash.slice(1);if(!t)return null;const a=e.config.hashPrefix||"";return a&&t.startsWith(a)?t.slice(a.length):a?null:t},updateHash(e,t){const a=`#${e.config.hashPrefix||""}${t}`;window.location.hash!==a&&history.pushState({tabId:t,component:"tabs"},"",a)},setupHashNavigation(e){if(e._hashHandler=()=>{const t=this.getTabFromHash(e);t&&e.tabIds.includes(t)&&e.activeTab!==t&&this.switchTab(e,t)},window.addEventListener("popstate",e._hashHandler),window.addEventListener("hashchange",e._hashHandler),e.config.hash&&!window.location.hash){const t=this.getInitialTab(e);if(t){const a=e.config.hashPrefix||"";history.replaceState({tabId:t,component:"tabs"},"",`#${a}${t}`)}}}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{qe.init()}):qe.init(),window.TabsComponent=qe;const Be={config:{debug:!1,defaultDuration:300,defaultEasing:"ease",animations:{fade:{in:{from:{opacity:0},to:{opacity:1}},out:{from:{opacity:1},to:{opacity:0}}},"fade-up":{in:{from:{transform:"translateY(20px)",opacity:0},to:{transform:"translateY(0)",opacity:1}},out:{from:{transform:"translateY(0)",opacity:1},to:{transform:"translateY(-20px)",opacity:0}}},"fade-down":{in:{from:{transform:"translateY(-20px)",opacity:0},to:{transform:"translateY(0)",opacity:1}},out:{from:{transform:"translateY(0)",opacity:1},to:{transform:"translateY(20px)",opacity:0}}},"fade-left":{in:{from:{transform:"translateX(20px)",opacity:0},to:{transform:"translateX(0)",opacity:1}},out:{from:{transform:"translateX(0)",opacity:1},to:{transform:"translateX(20px)",opacity:0}}},"fade-right":{in:{from:{transform:"translateX(-20px)",opacity:0},to:{transform:"translateX(0)",opacity:1}},out:{from:{transform:"translateX(0)",opacity:1},to:{transform:"translateX(-20px)",opacity:0}}},slideUp:{in:{from:{transform:"translateY(20px)",opacity:0},to:{transform:"translateY(0)",opacity:1}},out:{from:{transform:"translateY(0)",opacity:1},to:{transform:"translateY(-20px)",opacity:0}}},slideDown:{in:{from:{transform:"translateY(-20px)",opacity:0},to:{transform:"translateY(0)",opacity:1}},out:{from:{transform:"translateY(0)",opacity:1},to:{transform:"translateY(20px)",opacity:0}}},slideLeft:{in:{from:{transform:"translateX(-20px)",opacity:0},to:{transform:"translateX(0)",opacity:1}},out:{from:{transform:"translateX(0)",opacity:1},to:{transform:"translateX(-20px)",opacity:0}}},slideRight:{in:{from:{transform:"translateX(20px)",opacity:0},to:{transform:"translateX(0)",opacity:1}},out:{from:{transform:"translateX(0)",opacity:1},to:{transform:"translateX(20px)",opacity:0}}},scale:{in:{from:{transform:"scale(0.95)",opacity:0},to:{transform:"scale(1)",opacity:1}},out:{from:{transform:"scale(1)",opacity:1},to:{transform:"scale(0.95)",opacity:0}}},scaleUp:{in:{from:{transform:"scale(0.5)",opacity:0},to:{transform:"scale(1)",opacity:1}},out:{from:{transform:"scale(1)",opacity:1},to:{transform:"scale(1.5)",opacity:0}}},rotate:{in:{from:{transform:"rotate(-180deg)",opacity:0},to:{transform:"rotate(0)",opacity:1}},out:{from:{transform:"rotate(0)",opacity:1},to:{transform:"rotate(180deg)",opacity:0}}},bounce:{in:{from:{transform:"scale(0.3)",opacity:0},steps:[{transform:"scale(1.05)",opacity:.8,offset:.5},{transform:"scale(0.95)",opacity:.9,offset:.7},{transform:"scale(1.02)",opacity:1,offset:.85}],to:{transform:"scale(1)",opacity:1}},out:{from:{transform:"scale(1)",opacity:1},steps:[{transform:"scale(1.05)",opacity:.9,offset:.2},{transform:"scale(0.95)",opacity:.7,offset:.5}],to:{transform:"scale(0.3)",opacity:0}}},shake:{in:{from:{transform:"translateX(-10px)"},steps:[{transform:"translateX(10px)",offset:.2},{transform:"translateX(-10px)",offset:.4},{transform:"translateX(10px)",offset:.6},{transform:"translateX(-5px)",offset:.8}],to:{transform:"translateX(0)"}},out:{from:{transform:"translateX(0)"},steps:[{transform:"translateX(-10px)",offset:.2},{transform:"translateX(10px)",offset:.4},{transform:"translateX(-10px)",offset:.6},{transform:"translateX(5px)",offset:.8}],to:{transform:"translateX(0)",opacity:0}}},pulse:{in:{from:{transform:"scale(1)",opacity:1},steps:[{transform:"scale(1.05)",opacity:1,offset:.5}],to:{transform:"scale(1)",opacity:1}},out:{from:{transform:"scale(1)",opacity:1},steps:[{transform:"scale(1.1)",opacity:.8,offset:.5}],to:{transform:"scale(1)",opacity:0}}},flip:{in:{from:{transform:"perspective(400px) rotateY(90deg)",opacity:0},to:{transform:"perspective(400px) rotateY(0)",opacity:1}},out:{from:{transform:"perspective(400px) rotateY(0)",opacity:1},to:{transform:"perspective(400px) rotateY(90deg)",opacity:0}}},flipX:{in:{from:{transform:"perspective(400px) rotateX(90deg)",opacity:0},to:{transform:"perspective(400px) rotateX(0)",opacity:1}},out:{from:{transform:"perspective(400px) rotateX(0)",opacity:1},to:{transform:"perspective(400px) rotateX(90deg)",opacity:0}}},zoomIn:{in:{from:{transform:"scale(0)",opacity:0},to:{transform:"scale(1)",opacity:1}},out:{from:{transform:"scale(1)",opacity:1},to:{transform:"scale(0)",opacity:0}}},swing:{in:{from:{transform:"rotate(-10deg)"},steps:[{transform:"rotate(10deg)",offset:.25},{transform:"rotate(-5deg)",offset:.5},{transform:"rotate(5deg)",offset:.75}],to:{transform:"rotate(0)"}},out:{from:{transform:"rotate(0)",opacity:1},steps:[{transform:"rotate(10deg)",opacity:.8,offset:.25},{transform:"rotate(-10deg)",opacity:.6,offset:.5}],to:{transform:"rotate(0)",opacity:0}}}},easings:{linear:"linear",ease:"ease",easeIn:"ease-in",easeOut:"ease-out",easeInOut:"ease-in-out",easeInQuad:"cubic-bezier(0.55, 0.085, 0.68, 0.53)",easeOutQuad:"cubic-bezier(0.25, 0.46, 0.45, 0.94)",easeInOutQuad:"cubic-bezier(0.455, 0.03, 0.515, 0.955)",easeInCubic:"cubic-bezier(0.55, 0.055, 0.675, 0.19)",easeOutCubic:"cubic-bezier(0.215, 0.61, 0.355, 1)",easeInOutCubic:"cubic-bezier(0.645, 0.045, 0.355, 1)",easeInQuart:"cubic-bezier(0.895, 0.03, 0.685, 0.22)",easeOutQuart:"cubic-bezier(0.165, 0.84, 0.44, 1)",easeInOutQuart:"cubic-bezier(0.77, 0, 0.175, 1)",easeInBack:"cubic-bezier(0.6, -0.28, 0.735, 0.045)",easeOutBack:"cubic-bezier(0.175, 0.885, 0.32, 1.275)",easeInOutBack:"cubic-bezier(0.68, -0.55, 0.265, 1.55)",easeInElastic:"cubic-bezier(0.5, -0.5, 0.75, 1.5)",easeOutElastic:"cubic-bezier(0.25, -0.5, 0.5, 1.5)",easeInBounce:"cubic-bezier(0.6, 0.04, 0.98, 0.335)",easeOutBounce:"cubic-bezier(0.175, 0.885, 0.32, 1.275)",spring:"cubic-bezier(0.175, 0.885, 0.32, 1.275)"},performance:{useRAF:!0,batchSize:100,debounceInterval:100}},state:{running:new Map,queue:new Map,cache:new Map,paused:new Map},async init(e={}){return this.config={...this.config,...e},window.PerformanceObserver&&this.setupPerformanceObserver(),this},animate(e,t,a={}){return new Promise((n,s)=>{try{if(!e)throw new Error("Element is required");const r=this.getAnimationConfig(t,a),i=this.getCacheKey(t,a);let o=this.state.cache.get(i);o||(o=this.createKeyframes(r),this.state.cache.set(i,o));const l=Utils.generateUUID(),c=this.createTiming(a),d=e.animate(o,c),cleanup=()=>{this.state.running.delete(l),this.state.paused.delete(l),e.style.animation=""};this.state.running.set(l,{id:l,element:e,animation:d,cleanup:cleanup,options:a}),d.onfinish=()=>{cleanup(),"function"==typeof a.onComplete&&a.onComplete(e),n(e)},d.oncancel=()=>{cleanup(),s(new Error("Animation cancelled"))},d.onerror=e=>{cleanup(),s(e)}}catch(r){s(r)}})},chain(e,t){return t.reduce((t,a)=>t.then(()=>{const t="string"==typeof a?a:a.name,n="object"==typeof a&&a.options||{};return this.animate(e,t,n)}),Promise.resolve())},parallel(e,t,a={}){const n=t.map(t=>{const n="string"==typeof t?t:t.name,s="object"==typeof t?{...a,...t.options}:a;return this.animate(e,n,s)});return Promise.all(n)},stagger(e,t,a={}){const n=a.stagger||50,s=Array.from(e).map((e,s)=>{const r={...a,delay:(a.delay||0)+s*n};return this.animate(e,t,r)});return Promise.all(s)},queue(e,t,a={}){return new Promise((n,s)=>{this.state.queue.has(e)||this.state.queue.set(e,[]);const r=this.state.queue.get(e);r.push({animation:t,options:a,resolve:n,reject:s}),1===r.length&&this.processQueue(e)})},async processQueue(e){const t=this.state.queue.get(e);if(!t||0===t.length)return void this.state.queue.delete(e);const{animation:a,options:n,resolve:s,reject:r}=t[0];try{await this.animate(e,a,n),s(e)}catch(i){r(i)}t.shift(),this.processQueue(e)},clearQueue(e=null){if(e){const t=this.state.queue.get(e);t&&(t.forEach(e=>e.reject(new Error("Queue cleared"))),this.state.queue.delete(e))}else{for(const[e,t]of this.state.queue)t.forEach(e=>e.reject(new Error("Queue cleared")));this.state.queue.clear()}},pause(e=null){for(const[t,a]of this.state.running)e&&a.element!==e||"running"===a.animation.playState&&(a.animation.pause(),this.state.paused.set(t,a))},resume(e=null){for(const[t,a]of this.state.paused)e&&a.element!==e||"paused"===a.animation.playState&&(a.animation.play(),this.state.paused.delete(t))},reverse(e=null){for(const[t,a]of this.state.running)e&&a.element!==e||a.animation.reverse()},getAnimationConfig(e,t){if("string"==typeof e){const a=this.config.animations[e];if(!a)throw new Error(`Animation "${e}" not found`);return a[t.direction||"in"]}return e},getCacheKey:(e,t)=>`${"string"==typeof e?e:JSON.stringify(e)}_${t.direction||"in"}`,createKeyframes(e){const t=[];return e.from&&t.push({...e.from,offset:0}),e.steps&&Array.isArray(e.steps)&&e.steps.forEach(e=>{t.push(e)}),e.to&&t.push({...e.to,offset:1}),t},createTiming(e){let t=e.easing||this.config.defaultEasing;return this.config.easings[t]&&(t=this.config.easings[t]),{duration:e.duration||this.config.defaultDuration,easing:t,delay:e.delay||0,iterations:e.iterations||1,direction:e.animationDirection||"normal",fill:e.fill||"both"}},setupPerformanceObserver(){try{if("undefined"==typeof PerformanceObserver)return;if(!(PerformanceObserver.supportedEntryTypes||[]).includes("animation"))return void(this.config.debug&&console.log("Animation performance observer not supported in this browser"));new PerformanceObserver(e=>{for(const t of e.getEntries())EventManager.emit("animation:performance",{animation:t.name,duration:t.duration,startTime:t.startTime})}).observe({entryTypes:["animation"]})}catch(e){this.config.debug&&console.warn("Animation performance observer error:",e.message)}},stop(e=null){for(const[t,a]of this.state.running)e&&a.element!==e||(a.animation.cancel(),a.cleanup(),this.state.running.delete(t))},finish(e=null){for(const[t,a]of this.state.running)e&&a.element!==e||a.animation.finish()},isAnimating(e){for(const[t,a]of this.state.running)if(a.element===e&&"running"===a.animation.playState)return!0;return!1},getRunningCount(e=null){if(!e)return this.state.running.size;let t=0;for(const[a,n]of this.state.running)n.element===e&&t++;return t},registerAnimation(e,t){if(!e||!t)throw new Error("Animation name and config are required");this.config.animations[e]=t},registerEasing(e,t){if(!e||!t)throw new Error("Easing name and value are required");this.config.easings[e]=t},clearCache(){this.state.cache.clear()},destroy(){this.stop(),this.clearQueue(),this.clearCache(),this.state.paused.clear(),this.stopAutoInit()},_autoInit:{initialized:!1,enterObserver:null,leaveObserver:null,mutationObserver:null,animateHandlers:new WeakMap},autoInit(e=document){this._autoInit.initialized&&e===document||(this._initEnterAnimations(e),this._initLeaveAnimations(e),this._initAnimateTriggers(e),e!==document||this._autoInit.mutationObserver||this._setupMutationObserver(),e===document&&(this._autoInit.initialized=!0))},_initEnterAnimations(e){this._autoInit.enterObserver||(this._autoInit.enterObserver=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const t=e.target,a=t.dataset.enter,n=parseInt(t.dataset.enterDuration)||this.config.defaultDuration;this.animate(t,a,{direction:"in",duration:n,onComplete:()=>{EventManager.emit("animation:enter:complete",{element:t,animation:a})}}),t.dataset.enterRepeat||this._autoInit.enterObserver.unobserve(t)}})},{threshold:.1,rootMargin:"0px"}));e.querySelectorAll("[data-enter]:not([data-anim-initialized])").forEach(e=>{e._animBinding||(e.dataset.animInitialized="true",this._autoInit.enterObserver.observe(e))})},_initLeaveAnimations(e){this._autoInit.leaveObserver||(this._autoInit.leaveObserver=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting)e.target._wasVisible=!0;else{const t=e.target;if(t._wasVisible){const e=t.dataset.leave,a=parseInt(t.dataset.leaveDuration)||this.config.defaultDuration;this.animate(t,e,{direction:"out",duration:a,onComplete:()=>{EventManager.emit("animation:leave:complete",{element:t,animation:e})}})}}})},{threshold:.1}));e.querySelectorAll("[data-leave]:not([data-anim-initialized])").forEach(e=>{e._animBinding||(e.dataset.animInitialized="true",this._autoInit.leaveObserver.observe(e))})},_initAnimateTriggers(e){e.querySelectorAll("[data-animate]:not([data-anim-trigger-initialized])").forEach(e=>{e.dataset.animTriggerInitialized="true";const handler=()=>{const t=e.dataset.animate,a=e.dataset.animation||"fade",n=parseInt(e.dataset.animationDuration)||this.config.defaultDuration,s=e.dataset.animationDirection||"in",r=document.getElementById(t);r&&this.animate(r,a,{direction:s,duration:n})};e.addEventListener("click",handler),this._autoInit.animateHandlers.set(e,handler)})},_setupMutationObserver(){this._autoInit.mutationObserver=new MutationObserver(e=>{let t=!1;e.forEach(e=>{e.addedNodes.forEach(e=>{var a,n,s;if(1===e.nodeType&&(((null==(a=e.dataset)?void 0:a.enter)||(null==(n=e.dataset)?void 0:n.leave)||(null==(s=e.dataset)?void 0:s.animate))&&(t=!0),e.querySelectorAll)){e.querySelectorAll("[data-enter], [data-leave], [data-animate]").length>0&&(t=!0)}})}),t&&(clearTimeout(this._autoInit.reinitTimeout),this._autoInit.reinitTimeout=setTimeout(()=>{this.autoInit(document)},50))}),this._autoInit.mutationObserver.observe(document.body,{childList:!0,subtree:!0})},stopAutoInit(){this._autoInit.enterObserver&&(this._autoInit.enterObserver.disconnect(),this._autoInit.enterObserver=null),this._autoInit.leaveObserver&&(this._autoInit.leaveObserver.disconnect(),this._autoInit.leaveObserver=null),this._autoInit.mutationObserver&&(this._autoInit.mutationObserver.disconnect(),this._autoInit.mutationObserver=null),this._autoInit.initialized=!1}};(null==(F=window.Now)?void 0:F.registerManager)&&Now.registerManager("animation",Be),document.addEventListener("DOMContentLoaded",()=>{(void 0!==document.body.dataset.animationAuto||void 0!==document.documentElement.dataset.animationAuto)&&Be.autoInit()}),window.AnimationManager=Be,Object.assign(TemplateManager,{processDataAnimation(e,t){e&&t&&(e._animBinding||(e._animBinding={animations:new Map,originalState:this.deepClone(t.state),originalContext:{...t},originalDisplay:e.style.display}),this.processAnimationShow(e,t),this.processAnimationEnter(e,t),this.processAnimationLeave(e,t),this.processAnimationTransition(e,t))},processAnimationShow(e,t){const a=e.dataset.show;if(a)try{const updateShow=()=>{let n=ExpressionEvaluator.evaluate(a,{...t.state,...t.computed},t);void 0===n&&e._animBinding.originalState&&(n=ExpressionEvaluator.evaluate(a,e._animBinding.originalState,t));const s=e.dataset.showAnimation||"fade",r=parseInt(e.dataset.showDuration)||300;Be.stop(e),n?("none"===e.style.display&&(e.style.display=e._animBinding.originalDisplay||""),Be.animate(e,s,{direction:"in",duration:r})):Be.animate(e,s,{direction:"out",duration:r,onComplete:()=>{e.style.display="none"}}).catch(()=>{})};let n=ExpressionEvaluator.evaluate(a,{...t.state,...t.computed},t);void 0===n&&e._animBinding.originalState&&(n=ExpressionEvaluator.evaluate(a,e._animBinding.originalState,t)),n||(e.style.display="none"),this.setupReactiveUpdate(e,t,"Show",updateShow)}catch(n){console.error("Error processing animation show:",n)}},processAnimationEnter(e,t){const a=e.dataset.enter;if(a)try{const t=new IntersectionObserver(n=>{n.forEach(n=>{n.isIntersecting&&(Be.animate(e,a,{duration:parseInt(e.dataset.enterDuration)||300,onComplete:()=>{EventManager.emit("animation:enter:complete",{element:e,animation:a})}}),e.dataset.enterRepeat||t.unobserve(e))})},{threshold:parseFloat(e.dataset.enterThreshold)||.1});t.observe(e),e._animBinding.observers=e._animBinding.observers||new Set,e._animBinding.observers.add(t)}catch(n){console.error("Error processing animation enter:",n)}},processAnimationLeave(e,t){const a=e.dataset.leave;if(a)try{const t=new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting||Be.animate(e,a,{duration:parseInt(e.dataset.leaveDuration)||300,onComplete:()=>{EventManager.emit("animation:leave:complete",{element:e,animation:a})}})})},{threshold:parseFloat(e.dataset.leaveThreshold)||.1});t.observe(e),e._animBinding.observers=e._animBinding.observers||new Set,e._animBinding.observers.add(t)}catch(n){console.error("Error processing animation leave:",n)}},processAnimationTransition(e,t){const a=e.dataset.transition;if(a)try{const updateTransition=()=>{let n=ExpressionEvaluator.evaluate(a,{...t.state,...t.computed},t);void 0===n&&e._animBinding.originalState&&(n=ExpressionEvaluator.evaluate(a,e._animBinding.originalState,t));const s=e._animBinding.prevValue;if(n===s)return;const r=e.dataset.transitionAnimation||"fade",i=parseInt(e.dataset.transitionDuration)||300;Be.animate(e,r,{duration:i,onComplete:()=>{e._animBinding.prevValue=n,EventManager.emit("animation:transition:complete",{element:e,animation:r,prevValue:s,newValue:n})}})};updateTransition(),this.setupReactiveUpdate(e,t,"Transition",updateTransition)}catch(n){console.error("Error processing animation transition:",n)}},cleanupAnimationBinding(e){var t;e._animBinding&&(Be.stop(e),null==(t=e._animBinding.observers)||t.forEach(e=>{e.disconnect()}),delete e._animBinding)}});let ze=class MediaViewer2{constructor(e={}){this.options={showThumbnails:!1,showControls:!0,autoplay:!1,interval:5e3,loop:!0,enableZoom:!0,maxZoom:3,zoomStep:.5,renderers:{image:this.renderImage.bind(this),video:this.renderVideo.bind(this),youtube:this.renderYouTube.bind(this),iframe:this.renderIframe.bind(this),text:this.renderText.bind(this),html:this.renderHtml.bind(this)},onShow:null,onHide:null,onChange:null,...e},this.state={visible:!1,currentIndex:0,items:[],zoom:1,pan:{x:0,y:0},isDragging:!1,startPos:{x:0,y:0},isPlaying:!1,playTimer:null},this.setupDOM(),this.bindEvents()}setupDOM(){this.container=document.createElement("div"),this.container.className="media-viewer",this.container.setAttribute("role","dialog"),this.container.setAttribute("aria-modal","true"),this.container.setAttribute("aria-hidden","true"),this.container.innerHTML=`\n      <div class="media-counter"></div>\n\n      <div class="media-viewer-header">\n        <div class="media-viewer-controls">\n          ${this.options.showControls?'\n            <button class="zoom-out icon-zoom-out" aria-label="Zoom out"></button>\n            <button class="zoom-reset icon-zoom-reset" aria-label="Reset zoom"></button>\n            <button class="zoom-in icon-zoom-in" aria-label="Zoom in"></button>\n          ':""}\n          <button class="close-button" aria-label="Close"></button>\n        </div>\n      </div>\n\n      <div class="media-viewer-content">\n        <button class="nav-button icon-prev prev" aria-label="Previous"></button>\n        <div class="media-stage"></div>\n        <button class="nav-button icon-next next" aria-label="Next"></button>\n        <div class="media-caption"></div>\n      </div>\n\n      ${this.options.showThumbnails?'\n        <div class="media-viewer-thumbnails">\n          <div class="thumbnail-track"></div>\n        </div>\n      ':""}\n    `,this.stage=this.container.querySelector(".media-stage"),this.thumbnailTrack=this.container.querySelector(".thumbnail-track"),this.captionEl=this.container.querySelector(".media-caption"),this.counterEl=this.container.querySelector(".media-counter"),document.body.appendChild(this.container)}bindEvents(){this.container.querySelector(".close-button").onclick=()=>this.hide(),this.container.querySelector(".nav-button.prev").onclick=()=>this.prev(),this.container.querySelector(".nav-button.next").onclick=()=>this.next(),this.options.showControls&&(this.container.querySelector(".zoom-in").onclick=()=>this.zoomIn(),this.container.querySelector(".zoom-out").onclick=()=>this.zoomOut(),this.container.querySelector(".zoom-reset").onclick=()=>this.resetZoom()),document.addEventListener("keydown",e=>{if(this.state.visible)switch(e.key){case"Escape":this.hide();break;case"ArrowLeft":this.prev();break;case"ArrowRight":this.next();break;case"+":this.zoomIn();break;case"-":this.zoomOut();break;case"0":this.resetZoom()}});let e=0,t=0;this.stage.addEventListener("touchstart",a=>{e=a.touches[0].clientX,t=a.touches[0].clientY}),this.stage.addEventListener("touchmove",a=>{if(!this.state.visible)return;const n=e-a.touches[0].clientX,s=t-a.touches[0].clientY;Math.abs(n)>Math.abs(s)&&(a.preventDefault(),n>50&&this.next(),n<-50&&this.prev())}),this.stage.addEventListener("wheel",e=>{this.options.enableZoom&&(e.preventDefault(),e.deltaY<0&&this.zoomIn(),e.deltaY>0&&this.zoomOut())}),this.stage.addEventListener("mousedown",this.startDrag.bind(this)),document.addEventListener("mousemove",this.doDrag.bind(this)),document.addEventListener("mouseup",this.stopDrag.bind(this))}show(e,t=0){this.state.items=e.map(e=>this.normalizeItem(e)),this.state.currentIndex=t,this.state.visible=!0,this.container.classList.add("visible"),this.container.setAttribute("aria-hidden","false"),document.body.style.overflow="hidden",this.loadCurrentItem(),this.options.showThumbnails&&this.renderThumbnails(),this.options.autoplay&&this.play(),this.options.onShow&&this.options.onShow(this.getCurrentItem())}hide(){this.stop(),this.resetZoom(),this.state.visible=!1,this.container.classList.remove("visible"),this.container.setAttribute("aria-hidden","true"),document.body.style.overflow="",this.options.onHide&&this.options.onHide()}loadCurrentItem(){const e=this.getCurrentItem();if(!e)return;this.stage.classList.add("loading"),this.stage.innerHTML="",this.resetZoom(),this.updateCounter(),this.updateCaption(e);const t=this.options.renderers[e.type];t&&t(e),this.options.showThumbnails&&this.updateThumbnails(),this.options.onChange&&this.options.onChange(e,this.state.currentIndex)}renderImage(e){const t=document.createElement("img");t.className="media-item",t.src=e.url,t.alt=e.caption||"",t.onload=()=>{this.stage.classList.remove("loading"),this.resetZoom(),t.classList.add("loaded")},t.onerror=()=>{this.stage.classList.remove("loading")},this.stage.appendChild(t)}renderVideo(e){const t=document.createElement("video");t.className="media-item",t.src=e.url,t.controls=!0,e.poster&&(t.poster=e.poster),t.oncanplay=()=>{this.stage.classList.remove("loading")},t.onerror=()=>{this.stage.classList.remove("loading")},this.stage.appendChild(t)}renderYouTube(e){const t=document.createElement("iframe");t.className="media-item iframe",t.src=`https://www.youtube.com/embed/${this.sanitizeVideoId(e.videoId)}?rel=0&showinfo=0`,t.allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture",t.allowFullscreen=!0,t.onload=()=>{this.stage.classList.remove("loading")},this.stage.appendChild(t)}sanitizeVideoId(e){if("string"!=typeof e)return"";return/^[a-zA-Z0-9_-]{11}$/.test(e)?e:""}renderIframe(e){const t=document.createElement("iframe");t.className="media-item iframe",t.src=e.url,t.allowFullscreen=!0,t.onload=()=>{this.stage.classList.remove("loading")},this.stage.appendChild(t)}renderText(e){this.stage.classList.remove("loading");const t=document.createElement("div");if(t.className="media-item media-text",t.textContent=e.content||e.text||"",e.title){const a=document.createElement("h2");a.className="media-text-title",a.textContent=e.title,t.insertBefore(a,t.firstChild)}this.stage.appendChild(t)}renderHtml(e){this.stage.classList.remove("loading");const t=document.createElement("div");t.className="media-item media-html",window.SecurityManager&&SecurityManager.sanitize?t.innerHTML=SecurityManager.sanitize(e.content||e.html||""):t.innerHTML=e.content||e.html||"",this.stage.appendChild(t)}renderError(e){this.stage.classList.remove("loading"),this.stage.innerHTML="";const t=document.createElement("div");t.className="media-error",t.innerHTML=`\n      <div class="media-error-icon">⚠️</div>\n      <div class="media-error-message">${e||"Failed to load media"}</div>\n    `,this.stage.appendChild(t)}renderThumbnails(){this.thumbnailTrack.innerHTML="",this.state.items.forEach((e,t)=>{const a=document.createElement("div");if(a.className="thumbnail",t===this.state.currentIndex&&a.classList.add("active"),"image"===e.type){const t=document.createElement("img");t.src=e.thumbnail||e.url,t.alt=e.caption||"",a.appendChild(t)}else{const t=document.createElement("span");t.className=`icon-${e.type}`,a.appendChild(t)}a.onclick=()=>{this.goTo(t)},this.thumbnailTrack.appendChild(a)})}updateThumbnails(){if(!this.thumbnailTrack)return;const e=this.thumbnailTrack.children;for(let t=0;t<e.length;t++)e[t].classList.toggle("active",t===this.state.currentIndex)}updateCounter(){if(!this.counterEl)return;const e=this.state.currentIndex+1,t=this.state.items.length;this.counterEl.textContent=`${e} / ${t}`}updateCaption(e){this.captionEl&&(e&&e.caption?(this.captionEl.textContent=e.caption,this.captionEl.style.display=""):(this.captionEl.textContent="",this.captionEl.style.display="none"))}play(){this.state.isPlaying||(this.state.isPlaying=!0,this.state.playTimer=setInterval(()=>{this.next()},this.options.interval))}stop(){this.state.isPlaying&&(this.state.isPlaying=!1,clearInterval(this.state.playTimer))}next(){this.state.currentIndex<this.state.items.length-1?this.goTo(this.state.currentIndex+1):this.options.loop&&this.goTo(0)}prev(){this.state.currentIndex>0?this.goTo(this.state.currentIndex-1):this.options.loop&&this.goTo(this.state.items.length-1)}goTo(e){e!==this.state.currentIndex&&(this.state.currentIndex=e,this.loadCurrentItem())}getCurrentItem(){return this.state.items[this.state.currentIndex]}normalizeItem(e){if("string"==typeof e)return{type:"image",url:e};if(e.url&&e.url.includes("youtube.com")){const t=this.getYouTubeId(e.url);return{type:"youtube",videoId:t,thumbnail:`https://img.youtube.com/vi/${t}/mqdefault.jpg`,...e}}return{type:"image",...e}}getYouTubeId(e){const t=e.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/);return t&&11===t[2].length?t[2]:null}startDrag(e){this.options.enableZoom&&1!==this.state.zoom&&(this.state.isDragging=!0,this.state.startPos={x:e.clientX-this.state.pan.x,y:e.clientY-this.state.pan.y},this.stage.style.cursor="grabbing")}doDrag(e){if(!this.state.isDragging)return;e.preventDefault();const t=this.stage.querySelector(".media-item");if(!t)return;const a=t.getBoundingClientRect(),n=this.stage.getBoundingClientRect(),s=(a.width*this.state.zoom-n.width)/2,r=(a.height*this.state.zoom-n.height)/2;this.state.pan={x:Math.min(s,Math.max(-s,e.clientX-this.state.startPos.x)),y:Math.min(r,Math.max(-r,e.clientY-this.state.startPos.y))},this.updateTransform()}stopDrag(){this.state.isDragging&&(this.state.isDragging=!1,this.stage.style.cursor="grab")}zoomIn(){if(!this.options.enableZoom)return;const e=Math.min(this.state.zoom+this.options.zoomStep,this.options.maxZoom);this.setZoom(e)}zoomOut(){if(!this.options.enableZoom)return;const e=Math.max(this.state.zoom-this.options.zoomStep,1);this.setZoom(e)}resetZoom(){this.setZoom(1),this.state.pan={x:0,y:0},this.updateTransform()}setZoom(e){this.state.zoom=e,this.updateTransform();const t=this.stage.querySelector(".media-item");t&&(t.style.cursor=e>1?"grab":"default")}updateTransform(){const e=this.stage.querySelector(".media-item");if(!e)return;const t=`\n      translate(${this.state.pan.x}px, ${this.state.pan.y}px)\n      scale(${this.state.zoom})\n    `;e.style.transform=t}setOptions(e){this.options={...this.options,...e},this.container&&(this.container.classList.toggle("show-thumbnails",this.options.showThumbnails),this.container.classList.toggle("show-controls",this.options.showControls))}destroy(){this.stop(),this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container),this.state={visible:!1,currentIndex:0,items:[],zoom:1,pan:{x:0,y:0},isDragging:!1,startPos:{x:0,y:0},isPlaying:!1,playTimer:null}}static init(){document.querySelectorAll("[data-media-viewer]").forEach(e=>{MediaViewer2.initFromElement(e)})}static initFromElement(e){const t=MediaViewer2.parseOptionsFromElement(e),a=new MediaViewer2(t);e._mediaViewer=a;const n=e.dataset.api;if(n)MediaViewer2.loadFromApi(e,a,n);else{const t=MediaViewer2.collectMediaItems(e);e._mediaItems=t,MediaViewer2.bindItemEvents(e,a,t)}return a}static async loadFromApi(e,t,a){try{const n=e.dataset.apiMethod||"GET",s={"Content-Type":"application/json"};if(window.AuthManager&&AuthManager.getToken){const e=AuthManager.getToken();e&&(s.Authorization=`Bearer ${e}`)}const r=await fetch(a,{method:n,headers:s});if(!r.ok)throw new Error(`API request failed: ${r.status}`);const i=await r.json();let o=[];Array.isArray(i)?o=i:i.items?o=i.items:i.data?o=i.data:i.media&&(o=i.media),o=o.map(e=>"string"==typeof e?{type:"image",url:e}:{type:e.type||"image",url:e.url||e.src||e.path,thumbnail:e.thumbnail||e.thumb,caption:e.caption||e.title||e.description,...e}),e._mediaItems=o,MediaViewer2.bindItemEvents(e,t,o),e.dispatchEvent(new CustomEvent("mediaviewer:loaded",{detail:{items:o,viewer:t}}))}catch(n){console.error("MediaViewer API load error:",n),e._mediaItems=[],e._apiError=n.message,e.dispatchEvent(new CustomEvent("mediaviewer:error",{detail:{error:n.message,viewer:t}}))}}static bindItemEvents(e,t,a){const n=e.querySelectorAll("img, a[data-media-item], [data-media-item]");n.forEach((n,s)=>{n.style.cursor="pointer",n.addEventListener("click",n=>{n.preventDefault(),e._apiError?(t.renderError(e._apiError),t.container.classList.add("visible")):t.show(a,s)})}),0===n.length&&a.length>0&&(e.style.cursor="pointer",e.addEventListener("click",()=>{t.show(a,0)}))}static parseOptionsFromElement(e){const t={};return void 0!==e.dataset.showThumbnails&&(t.showThumbnails="true"===e.dataset.showThumbnails),void 0!==e.dataset.showControls&&(t.showControls="true"===e.dataset.showControls),void 0!==e.dataset.autoplay&&(t.autoplay="true"===e.dataset.autoplay),void 0!==e.dataset.loop&&(t.loop="true"===e.dataset.loop),void 0!==e.dataset.enableZoom&&(t.enableZoom="true"===e.dataset.enableZoom),e.dataset.interval&&(t.interval=parseInt(e.dataset.interval,10)),e.dataset.maxZoom&&(t.maxZoom=parseFloat(e.dataset.maxZoom)),e.dataset.zoomStep&&(t.zoomStep=parseFloat(e.dataset.zoomStep)),t}static collectMediaItems(e){const t=[];return e.querySelectorAll("img").forEach(e=>{const a=e.dataset.src||e.src;t.push({type:e.dataset.type||"image",url:a,caption:e.dataset.caption||e.alt||"",thumbnail:e.src})}),e.querySelectorAll("a[data-media-item]").forEach(e=>{var a;const n=e.href,s=e.dataset.type||"image";n.includes("youtube.com")||n.includes("youtu.be")?t.push({type:"youtube",url:n,caption:e.dataset.caption||e.textContent||""}):t.push({type:s,url:n,caption:e.dataset.caption||e.textContent||"",thumbnail:e.dataset.thumbnail||(null==(a=e.querySelector("img"))?void 0:a.src)})}),e.querySelectorAll("[data-media-item]:not(a):not(img)").forEach(e=>{const a=e.dataset.src||e.dataset.url;a&&t.push({type:e.dataset.type||"image",url:a,caption:e.dataset.caption||"",thumbnail:e.dataset.thumbnail})}),t}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>ze.init()):ze.init(),window.MediaViewer=ze;const $e={config:{className:"edit-in-place",activeClass:"editing",selectOnEdit:!0,callbacks:{}},state:{instances:new Map,activeEditor:null,initialized:!1},init(e={}){return this.state.initialized||(this.config={...this.config,...e},document.querySelectorAll('[data-component="editinplace"]').forEach(e=>{this.create(e)}),this.state.initialized=!0),this},create(e,t={}){if("string"==typeof e&&(e=document.getElementById(e)),!e||e.editInPlace)return null==e?void 0:e.editInPlace;const a=e.dataset.editAjaxUrl||t.ajaxUrl||null,n=e.dataset.callback||t.callback||null,s=(e.dataset.field||e.id||"").replace(/[^a-zA-Z0-9_-]/g,"");a&&!s&&console.warn("EditInPlace: field is required when using AJAX save");const r={element:e,config:{...this.config,ajaxUrl:a,callback:n,ajaxSave:"false"!==e.dataset.editAjaxSave&&("true"===e.dataset.editAjaxSave||!!a),field:s,...t},originalValue:e.textContent.trim(),editor:null,isEditing:!1};return e.editInPlace=r,this.state.instances.set(e,r),this.setupElement(r),r},setupElement(e){const{element:t,config:a}=e;t.classList.add(a.className),t.style.cursor="pointer",t.tabIndex=0,e.handlers={click:t=>{t.stopPropagation(),this.startEdit(e)},keydown:t=>{e.isEditing||"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),this.startEdit(e))}},t.addEventListener("click",e.handlers.click),t.addEventListener("keydown",e.handlers.keydown),t.setAttribute("role","button")},startEdit(e){if(e.isEditing)return;this.state.activeEditor&&this.state.activeEditor!==e&&this.endEdit(this.state.activeEditor,!1);const{element:t,config:a}=e;e.originalValue=t.textContent.trim(),e.validation={required:t.hasAttribute("data-required"),pattern:t.getAttribute("data-pattern")||null};const n=document.createElement("input");n.type="text",n.value=e.originalValue,n.className=`${a.className}-editor`;const s=t.getAttribute("data-placeholder"),r=t.getAttribute("data-minlength"),i=t.getAttribute("data-maxlength");s&&(n.placeholder=s),r&&(n.minLength=parseInt(r)),i&&(n.maxLength=parseInt(i));const o=window.getComputedStyle(t);if(n.style.fontSize=o.fontSize,n.style.fontFamily=o.fontFamily,!t.parentNode)return void console.error("EditInPlace: Element has no parent node");t.style.display="none",t.parentNode.insertBefore(n,t),e.isEditing=!0,e.editor=n,this.state.activeEditor=e,n.focus(),a.selectOnEdit&&n.select();const handleBlur=()=>{e.isEditing&&this.finishEdit(e)},handleKeydown=t=>{"Escape"===t.key?(t.preventDefault(),this.endEdit(e,!1)):"Enter"===t.key&&(t.preventDefault(),n.blur())};e.editorHandlers={blur:handleBlur,keydown:handleKeydown},n.addEventListener("blur",handleBlur),n.addEventListener("keydown",handleKeydown),this.emitEvent("edit:start",{instance:e,element:t,editor:n})},async finishEdit(e){var t,a,n,s,r;if(!e.isEditing)return;const{element:i,config:o,editor:l,originalValue:c}=e,d=l.value.trim();if(d===c)return void this.endEdit(e,{restore:!1,emitCancel:!1});const u=this.validateValue(d,e.validation);if(u)return window.NotificationManager?NotificationManager.error(u):alert(u),void this.endEdit(e,{restore:!0,emitCancel:!0});let h=!0,p=d,m=!1;if(o.callback)try{const t="function"==typeof o.callback?o.callback:window[o.callback];if("function"==typeof t){const a=t(d,e);if(!1===a)return void this.endEdit(e,{restore:!0,emitCancel:!0});"string"==typeof a&&(p=a)}}catch(g){console.error("EditInPlace: Callback error:",g)}if(o.ajaxSave&&o.ajaxUrl)try{const e=new FormData;let i;if(e.append("value",d),e.append("field",o.field),null==(t=window.http)?void 0:t.post)i=await http.post(o.ajaxUrl,e);else if(null==(a=window.simpleFetch)?void 0:a.post)i=await simpleFetch.post(o.ajaxUrl,e);else{const t=await fetch(o.ajaxUrl,{method:"POST",body:e,headers:{"X-Requested-With":"XMLHttpRequest"}});i=await t.json()}if(!1===i.success||i.error)throw new Error(i.message||"Save failed");m=!0;let l=(null==(n=i.data)?void 0:n.value)||(null==(r=null==(s=i.data)?void 0:s.data)?void 0:r.value);void 0!==l&&(p=l)}catch(g){console.error("EditInPlace save error:",g);const e=429===g.status?"Too many requests. Please wait a moment.":403===g.status?"Access denied. Please refresh the page.":"Failed to save changes.";window.NotificationManager&&NotificationManager.error(e),h=!1,p=c}i.textContent=p,this.endEdit(e,{restore:!1,emitCancel:!1}),h&&d!==c&&this.emitEvent("edit:save",{instance:e,element:i,value:p,previousValue:c,savedViaAjax:m})},endEdit(e,t={}){if(!e.isEditing)return;const{restore:a=!1,emitCancel:n=!1}=t;e.isEditing=!1;const{element:s,editor:r}=e;if(s.style.display="",r&&e.editorHandlers&&(r.removeEventListener("blur",e.editorHandlers.blur),r.removeEventListener("keydown",e.editorHandlers.keydown),delete e.editorHandlers),r&&r.parentNode)try{r.parentNode.removeChild(r)}catch(i){}e.editor=null,this.state.activeEditor===e&&(this.state.activeEditor=null),a&&(s.textContent=e.originalValue),n&&this.emitEvent("edit:cancel",{instance:e,element:s}),s.focus()},validateValue(e,t){if(!t)return null;if(t.required&&!e)return"This field is required";if(t.pattern&&e)try{if(!new RegExp(`^${t.pattern}$`).test(e))return"Invalid format"}catch(a){console.error("EditInPlace: Invalid pattern regex:",a)}return null},cancelEdit(e){this.endEdit(e,{restore:!0,emitCancel:!0})},emitEvent(e,t){EventManager.emit(e,t)},getInstance:e=>("string"==typeof e&&(e=document.getElementById(e)),(null==e?void 0:e.editInPlace)||null),destroy(e){if("string"==typeof e&&(e=this.getInstance(e)),!e)return;const{element:t}=e;e.isEditing&&this.endEdit(e,!1),e.handlers&&(t.removeEventListener("click",e.handlers.click),t.removeEventListener("keydown",e.handlers.keydown),delete e.handlers),t.classList.remove(this.config.className),t.style.cursor="",t.removeAttribute("tabIndex"),t.removeAttribute("role"),delete t.editInPlace,this.state.instances.delete(t)}};(null==(O=window.Now)?void 0:O.registerManager)&&Now.registerManager("editInPlace",$e),window.EditInPlaceManager=$e,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>$e.init()):$e.init();const je={config:{enabled:!1,defaultTheme:"light",storageKey:"app_theme",systemPreference:!1,api:{enabled:!1,configUrl:null,headers:{},timeout:5e3,cacheResponse:!0},transition:{enabled:!0,duration:300,hideOnSwitch:!0,loadingClass:"theme-loading",readyClass:"theme-ready",transitionClass:"theme-transitioning"}},security:{allowedPropertyPattern:/^--[\w-]+$/,dangerousPatterns:[/url\s*\([^)]*\)/gi,/expression\s*\([^)]*\)/gi,/@import/gi,/javascript\s*:/gi,/data\s*:/gi,/<script/gi,/<\/script/gi,/on\w+\s*=/gi,/behavior\s*:/gi,/-moz-binding/gi],maxValueLength:500,url:{enabled:!0,allowedExtensions:[".jpg",".jpeg",".png",".gif",".webp",".avif",".ico"],blockPathTraversal:!0,stripQueryString:!0,allowedOrigins:[window.location.origin]}},state:{current:null,initialized:!1,ready:!1,transitioning:!1,toggles:new Set,systemPreference:null,apiCache:{},appliedVariables:{}},emit(e,t){var a;(null==(a=window.EventManager)?void 0:a.emit)&&EventManager.emit(e,t)},async init(e={}){var t;if(this.config={...this.config,...e},null==(t=this.config.api)?void 0:t.configUrl){this.isSafeApiUrl(this.config.api.configUrl)||(console.warn(`ThemeManager: configUrl "${this.config.api.configUrl}" rejected (only HTTPS same-origin allowed by default)`),this.config.api.enabled=!1)}return this.config.enabled?(document.body.classList.add(this.config.transition.loadingClass),this.config.systemPreference&&this.setupSystemPreference(),await this.loadInitialTheme(),this.state.initialized=!0,this.markReady(),this.emit("theme:initialized",{theme:this.state.current}),this):(this.state.disabled=!0,this)},enhance(e){return!e||this.state.toggles.has(e)||(e.addEventListener("click",()=>this.toggle()),this.updateElementState(e),this.state.toggles.add(e),e._themeToggle=!0),e},updateElementState(e){e&&this.state.current&&e.setAttribute("data-theme-state",this.state.current)},updateAllToggles(){this.state.toggles.forEach(e=>{this.updateElementState(e)})},setupSystemPreference(){this.cleanupSystemPreferenceListener();const e=window.matchMedia("(prefers-color-scheme: dark)"),handleChange=e=>{this.getStoredTheme()||this.setTheme(e.matches?"dark":"light")};e.addEventListener("change",handleChange),this.state.systemPreference={mediaQuery:e,handleChange:handleChange},handleChange(e)},cleanupSystemPreferenceListener(){const e=this.state.systemPreference;(null==e?void 0:e.mediaQuery)&&e.handleChange&&e.mediaQuery.removeEventListener("change",e.handleChange),this.state.systemPreference=null},toggle(){const e="dark"===this.state.current?"light":"dark";this.setTheme(e)},async setTheme(e,t={}){const a=!1!==t.transition&&this.config.transition.enabled&&this.config.transition.hideOnSwitch&&this.state.ready;a&&await this.startTransition(),document.documentElement.setAttribute("data-theme",e),this.state.current=e,this.config.storageKey&&this.setStoredTheme(e),this.updateAllToggles(),a&&await this.endTransition(),this.emit("theme:changed",{theme:e})},getCurrentTheme(){return this.state.current},markReady(){if(this.state.ready)return;const addReadyClass=()=>{document.body?(this.state.ready=!0,document.body.classList.add(this.config.transition.readyClass),document.body.classList.remove(this.config.transition.transitionClass),document.body.classList.remove(this.config.transition.loadingClass),this.emit("theme:ready")):requestAnimationFrame(addReadyClass)};addReadyClass()},async startTransition(){this.config.transition.enabled&&(this.state.transitioning=!0,document.body.classList.add(this.config.transition.transitionClass),document.body.classList.remove(this.config.transition.readyClass),document.body.classList.remove(this.config.transition.loadingClass),await this.wait(this.config.transition.duration))},async endTransition(){this.config.transition.enabled&&(document.body.classList.remove(this.config.transition.transitionClass),document.body.classList.add(this.config.transition.readyClass),document.body.classList.remove(this.config.transition.loadingClass),this.state.transitioning=!1,await this.wait(this.config.transition.duration))},wait:e=>new Promise(t=>setTimeout(t,e)),async loadInitialTheme(){if(this.config.api.enabled&&this.config.api.configUrl)try{await this.loadFromAPI()}catch(a){console.warn("ThemeManager: Failed to load from API",a)}let e=this.config.defaultTheme;const t=this.getStoredTheme();if(t)e=t;else if(this.config.systemPreference){e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}await this.setTheme(e)},isValidProperty(e){return"string"==typeof e&&this.security.allowedPropertyPattern.test(e)},isUrlValue(e){if("string"!=typeof e)return!1;const t=e.split("?")[0];return/^(https?:\/\/|\/|\.\/)?[\w\-\.\/]+$/.test(t)},sanitizeUrl(e){var t;if("string"!=typeof e)return null;const a=this.security.url;let n=e.trim();if(/^[a-z]+:/i.test(n))try{const s=new URL(n);if(!(null==(t=a.allowedOrigins)?void 0:t.some(e=>s.origin===e)))return console.warn(`ThemeManager: Rejected URL "${e}" - origin "${s.origin}" not in allowedOrigins`),null;n=s.pathname}catch(r){return console.warn(`ThemeManager: Rejected URL "${e}" - invalid URL format`),null}if(/^(\/|\.\/)/i.test(n)||(n=`./${n}`),a.stripQueryString&&(n=n.split("?")[0].split("#")[0]),a.blockPathTraversal&&n.includes(".."))return console.warn(`ThemeManager: Rejected URL "${e}" - path traversal not allowed`),null;const s=n.substring(n.lastIndexOf(".")).toLowerCase();return a.allowedExtensions.includes(s)?`url('${n}')`:(console.warn(`ThemeManager: Rejected URL "${e}" - extension "${s}" not allowed. Allowed: ${a.allowedExtensions.join(", ")}`),null)},sanitizeValue(e){if(null==e)return"";"string"!=typeof e&&(e=String(e));let t=e.trim();if(this.security.url.enabled&&this.isUrlValue(t)){const e=this.sanitizeUrl(t);return e||""}for(const a of this.security.dangerousPatterns)t=t.replace(a,"");return t.length>this.security.maxValueLength&&(t=t.substring(0,this.security.maxValueLength)),t.trim()},validateApiResponse(e){if(!e||"object"!=typeof e)throw new Error("ThemeManager: Invalid API response format - expected object");if(void 0!==e.variables&&("object"!=typeof e.variables||Array.isArray(e.variables)))throw new Error("ThemeManager: Invalid variables format - expected object");return!0},applyVariables(e){if(!e||"object"!=typeof e)return console.warn("ThemeManager: applyVariables requires an object"),{};const t=Object.entries(e);t.length>200&&console.warn(`ThemeManager: Too many variables (${t.length}). Applying first 200 only.`);const a=t.slice(0,200),n={},s=document.documentElement;let r=0;for(const[i,o]of a){if(!this.isValidProperty(i)){r++,console.warn(`ThemeManager: Rejected invalid property "${i}" - only CSS custom properties (--*) are allowed`);continue}const e=this.sanitizeValue(o);e?(s.style.setProperty(i,e),n[i]=e):console.warn(`ThemeManager: Skipped empty/unsafe value for "${i}"`)}return this.state.appliedVariables={...this.state.appliedVariables,...n},r>0&&console.warn(`ThemeManager: Rejected ${r} invalid properties`),this.emit("theme:variables-applied",{variables:n}),n},clearVariables(){const e=document.documentElement;for(const t of Object.keys(this.state.appliedVariables))e.style.removeProperty(t);this.state.appliedVariables={},this.emit("theme:variables-cleared")},getAppliedVariables(){return{...this.state.appliedVariables}},async loadFromAPI(e){var t;const a=e||this.config.api.configUrl;if(!a)throw new Error("ThemeManager: No API config URL specified");if(!this.isSafeApiUrl(a))throw new Error("ThemeManager: Unsafe API config URL");if(this.config.api.cacheResponse&&this.state.apiCache[a]){const e=this.state.apiCache[a];return await this.applyApiConfig(e),this.emit("theme:api-loaded",{config:e,fromCache:!0}),e}try{const e=window.http||window.HttpClient;let n=await e.get(a,{timeout:this.config.api.timeout,headers:this.config.api.headers});if(!1===n.success)throw new Error(n.error||"API request failed");return n=(null==(t=n.data)?void 0:t.data)||n.data||n,this.validateApiResponse(n),this.config.api.cacheResponse&&(this.state.apiCache[a]=n),await this.applyApiConfig(n),this.emit("theme:api-loaded",{config:n}),n}catch(n){throw this.emit("theme:api-error",{error:n.message,url:a}),n}},applyApiConfig(e){e.variables&&this.applyVariables(e.variables)},isSafeApiUrl(e){try{const t=new URL(e,window.location.origin),a="https:"===t.protocol||"http:"===t.protocol,n=t.origin===window.location.origin,s="http:"===window.location.protocol&&t.origin===window.location.origin;return!!a&&(!("https:"!==t.protocol||!n)||!!s)}catch(t){return!1}},async refreshFromAPI(){return this.state.apiCache={},this.loadFromAPI()},destroy(){this.cleanupSystemPreferenceListener(),this.state.toggles.forEach(e=>{if(e._themeToggle){const t=e.parentNode;if(t){const a=e.cloneNode(!0);delete a._themeToggle,t.replaceChild(a,e)}}}),this.state.toggles.clear(),this.clearVariables(),document.body.classList.remove(this.config.transition.readyClass),document.body.classList.remove(this.config.transition.transitionClass),document.body.classList.remove(this.config.transition.loadingClass),this.state.apiCache={},this.state.current=null,this.state.initialized=!1,this.state.ready=!1,this.state.transitioning=!1,this.state.appliedVariables={},this.emit("theme:destroyed")},reset(){this.cleanupSystemPreferenceListener(),this.clearVariables(),this.state.apiCache={},this.state.current=null,this.state.initialized=!1,this.state.ready=!1,document.body.classList.remove(this.config.transition.readyClass),document.body.classList.remove(this.config.transition.loadingClass),this.emit("theme:reset")},getStoredTheme:function(){if(!this.config.storageKey)return null;try{return localStorage.getItem(this.config.storageKey)}catch(e){return console.warn("ThemeManager: Unable to read from localStorage",e),null}},setStoredTheme:function(e){if(this.config.storageKey)try{localStorage.setItem(this.config.storageKey,e)}catch(t){console.warn("ThemeManager: Unable to write to localStorage",t)}}};(null==(R=window.Now)?void 0:R.registerManager)&&Now.registerManager("theme",je),window.ComponentManager&&ComponentManager.define("theme",{template:null,mounted(){je.enhance(this.element)},destroyed(){var e;(null==(e=this.element)?void 0:e._themeToggle)&&je.state.toggles.delete(this.element)}}),"loading"===document.readyState&&document.addEventListener("DOMContentLoaded",()=>{document.querySelectorAll('[data-component="theme"]').forEach(e=>{e._themeToggle||je.enhance(e)})}),window.ThemeManager=je}();
//# sourceMappingURL=now.core.min.js.map
